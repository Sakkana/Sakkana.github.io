<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>魚のブログ</title>
  
  
  <link href="https://sakkana.github.io/atom.xml" rel="self"/>
  
  <link href="https://sakkana.github.io/"/>
  <updated>2022-04-20T11:13:46.868Z</updated>
  <id>https://sakkana.github.io/</id>
  
  <author>
    <name>Ludovico</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>C++11标准与陌生用法</title>
    <link href="https://sakkana.github.io/2022/04/20/C++11%E6%A0%87%E5%87%86%E4%B8%8E%E9%99%8C%E7%94%9F%E7%94%A8%E6%B3%95/"/>
    <id>https://sakkana.github.io/2022/04/20/C++11%E6%A0%87%E5%87%86%E4%B8%8E%E9%99%8C%E7%94%9F%E7%94%A8%E6%B3%95/</id>
    <published>2022-04-20T07:48:01.000Z</published>
    <updated>2022-04-20T11:13:46.868Z</updated>
    
    <content type="html"><![CDATA[<h1 id="C-11标准-与-陌生用法"><a href="#C-11标准-与-陌生用法" class="headerlink" title="C++11标准 与 陌生用法"></a>C++11标准 与 陌生用法</h1><p>最近开始读《C++ Primer》了，记录一些以前C++98中没有遇到过的但是比较优秀的用法以及陌生的知识点。</p><p>由于这本书真的太厚了，里面些许知识点是自己已经掌握的，有些新特性与陌生用法是值得自己学习的。然而也不可能每次遇到问题书都在身边，于是将自己觉得有价值的部分记录下来。</p><p>因此本文并不是全篇关注C++11，而是新标准与陌生知识相融合的一篇学习记录。</p><h3 id="顶层const-amp-底层const"><a href="#顶层const-amp-底层const" class="headerlink" title="顶层const &amp; 底层const"></a>顶层const &amp; 底层const</h3><p>在这本书里看到了一个新概念：底层const与底层const</p><p><code>顶层const</code> ： 任意对象是常量，指针本身是个常量。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token operator">*</span><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span> <span class="token comment">// 指针本身是常量，不可以再指向别人，长相厮守</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">1e5</span><span class="token punctuation">;</span> <span class="token comment">// 变量N是个const，只读</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>底层const</code>：指针所指的对象是个const</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">const int *p2 = &amp;a;// 不能通过指针修改其指向的对象const int &amp;ref = &amp;a;// 声明引用的const的都是底层const<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>我们还可以见到这种杂合子</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">const int *const p3 = &amp;a;// 第一个是底层const，我们无法通过指针修改这个对象// 第二个是顶层const，长相厮守<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>执行拷贝操作的时候，底层const会做一些坏事。</p><p>拷入和拷出的时候两个数据对象必须具有相同的底层const资格。</p><ul><li>case 1</li></ul><p>这是错误的。</p><p>因为p1拥有底层const，我们无法通过指针修改a的值。</p><p>而p2却没有底层const，意味着我们可以通过p2修改p2指向的值，即p1指向的值，即a的值。</p><p>这与我们的初衷相违背（p1不被允许修改a的值）。</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">const int *const p1 = &amp;a;int *p2 = p1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a32de98309f14546810b3d1718b841e0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>同理，这样也是不允许的。因为p有可能改变a的值。</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">const int a = 9;int *const p = &amp;a;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/7bf0cf88ca3343bead078d81ad333516.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 2</p><p>这样子是合法的，因为p1和p2都拥有相同的底层const，即p1和p2指向的对象都不能被修改。</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">const int *const p1 = &amp;a;const int *p2 = p1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>case 3</p><p>这样也是合法的，编译器可以将 <code>int*</code> 转成 <code>const int*</code></p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int i = 1;const int *p = &amp;i;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>case 4</p><p>这样子是非法的，因为ref有修改i的可能性。</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">const int i = 99;int &amp;ref = i;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/cb58dd30605549eca3326f0bf5fc2df6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 5</p><p>这样自然就合法了，因为ref也是只读的。</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">const int i = 99;const int &amp;ref = i;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>上面这等价于：</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">const int i = 99, &amp;ref = i;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>总而言之，在拷贝的时候，只要关注新定义的变量有没有可能修改<code>拥有底层const的变量</code>就可以了。</p><h3 id="constexpr"><a href="#constexpr" class="headerlink" title="constexpr"></a>constexpr</h3><p>这是个c++11新增的类型，中文名叫 <code>常量表达式</code>。</p><p>constexpr 变量的特点：</p><ul><li>值不会改变（这点和const一样）</li><li>编译过程就能得到计算结果</li></ul><p>什么是常量表达式？</p><p><img src="https://img-blog.csdnimg.cn/403266030fdc44f1899e1740138f0d08.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>等功力深厚了再来写。</p><h3 id="using（取别名）"><a href="#using（取别名）" class="headerlink" title="using（取别名）"></a>using（取别名）</h3><p>这里介绍的using是普通场合的using，起作用等价于<code>typedef</code>。</p><h3 id="auto"><a href="#auto" class="headerlink" title="auto"></a>auto</h3><p>让编译器自己推断变量的类型。</p><p>case 1</p><p>碰到引用，会顺藤摸瓜推断出<strong>最原始的值的类型</strong>。</p><p>相当于 <code>int b = a</code>。</p><p><img src="https://img-blog.csdnimg.cn/ee2f2ac15d1e46e7a34bfacc5954176c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_10,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 2 </p><p><strong>忽略顶层const</strong>（任意对象是常量，指针本身是常量）</p><p>如这里的变量a是个常量，但是会被auto忽略掉。</p><p>auto出来的b是个普通变量，可以任意读写。</p><p>相当于 <code>int b = 1</code>。</p><p><img src="https://img-blog.csdnimg.cn/2621e443582443e485aa1918878e2b6d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_14,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 3</p><p><strong>同时碰到引用和顶层const</strong>，依然遵循上面的规则。</p><p>ri是个引用，引用了int类型的i，然而i是个const，但是顶层const会被忽略，因此b是个可读可写的int。</p><p>相当于 <code>int b = i</code>。</p><p><img src="https://img-blog.csdnimg.cn/1c84b425fd884e91b469a7880cf69fb6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 4</p><p><strong>保留底层const</strong> （指针指向的内容是const）</p><p>变量a是个常量， &amp;a取地址，因此ptr是个指针类型的变量。</p><p>由于auto保留底层const，因此ptr无法修改其指向的值。</p><p>相当于 <code>const int *ptr = &amp;a</code>。</p><p><img src="https://img-blog.csdnimg.cn/4beb3b69da5c4948a586931767b06301.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 5</p><p>如果想要auto推断出来的值是个const，可以显式地告诉编译器。</p><p><img src="https://img-blog.csdnimg.cn/c568370dbaaa408587de99b3f1d5f98c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 6</p><p>声明一个auto的引用时，顶层const会被保留。是否为引用对于auto有重要影响。</p><p>由于我们想声明一个变量d作为c的引用，意味着我们可能使用d来修改c的值，然而c是个常量，具有顶层const属性，因此d也必须是一个常量。</p><p>因此，我们无法修改d的值，会报错。</p><p><img src="https://img-blog.csdnimg.cn/a77057214a16400a8d8ec3653214b4c0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_18,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 7</p><p>一句auto中的变量需要是同一类型。</p><ul><li>1 </li></ul><p><img src="https://img-blog.csdnimg.cn/73d983fa116545eca7bdd600bcc4d4fe.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ul><li>2</li></ul><p><img src="https://img-blog.csdnimg.cn/8e98128b413942e6a7b800b65a91d43f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_12,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ul><li>3</li><li><img src="https://img-blog.csdnimg.cn/c3b7fbbe114c44e19be2f076b56a98e2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></li></ul><p><img src="https://img-blog.csdnimg.cn/375f98ace8564f2a97239262f1c7b2dc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>总结</p><ul><li>auto 最关注的是变量的类型，我们只希望获得类型，因此会忽略顶层const， 引用等等。他不希望我们沾染const，引用这种外壳。</li><li>但是有些原则是不能触碰的，如果我们auto出来的变量可以修改只读的变量，这是大忌。因此auto不会忽略底层const。</li><li>如果我们真的希望auto出来的变量确实是个const或者引用，那么我们就明确地告诉编译器。和普通变量命名规则一样，大家要么都是const要么都可读可写，一根绳上的蚂蚱。</li></ul><p>上面三条记牢，在用auto的时候就会少犯一些错你。</p><h3 id="decltype"><a href="#decltype" class="headerlink" title="decltype"></a>decltype</h3><p>这个也是c++11除了auto之外引入的第二个新的类型说明符。</p><p>他会根据括号内的操作数推断类型并返回。</p><p>在此过程中，编译器推断表达式的类型但是不会计算它的值。</p><p><img src="https://img-blog.csdnimg.cn/c5840dba69aa404f89b264286f2dedb2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_15,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>然,decltype处理<code>顶层const</code>和<code>引用</code>和auto有些许不同。</p><p>case 1</p><p>如果要推断一个变量，这个变量是啥就是啥，因为我们希望得到的结果和里面的变量一模一样。</p><p>顶层const和引用它都会考虑进去。看起来比auto更加聪明也更危险。</p><p>这个例子中，i拥有顶层const属性，因此decltype返回的也是个 const int，因而 a 不可以被修改。</p><p><img src="https://img-blog.csdnimg.cn/96942ae413b34e59850d3d3ef0df50da.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>这里的 j 是个引用类型，与 i 绑定，因此修改 j 就是在修改 i。</p><p>我们使用 decltype(j)，它会返回和 j 一样的数据类型，即int &amp;。 </p><p>因此这条语句相当于 <code>int &amp;rj = j</code>。</p><p>从而我们又将 rj 与 j 绑定。</p><p>从这里开始， i, j, rj 都是同一根绳子上的蚂蚱，牵一发而动全身。 </p><p><img src="https://img-blog.csdnimg.cn/59874bcbcb084e33a548598106214fbc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>编译器怕我们太笨了也会告诉我们，这个 rj 是个引用变量，因此需要马上初始化。</p><p>如果不绑定一个变量他就会报错。</p><p><img src="https://img-blog.csdnimg.cn/3f5d1dcbb35f41cd86b8db96cac54f82.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_14,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 2</p><p>如果decltypr使用的表达式不是一个变量，那么它会返回<code>表达式结果相对应的类型</code>。</p><p>然而引用的代价太大了，有时候我们单纯只是像获得类型，就行auto那样。</p><p>下面这个表达式 j + 0 会返回一个 int 类型的值，因此decltyp返回的就是一个普通的 int。</p><p><img src="https://img-blog.csdnimg.cn/32502b5e0141448d8303035ade7492f7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_18,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 3</p><p>奇怪的是，对地址的解引用操作也会返回引用类型。</p><p>如下面的 decltype(*ptr) 就会返回 int &amp;，因此我们修改 ref 就是在修改 a。</p><p><img src="https://img-blog.csdnimg.cn/3f8415e89e334a4d9c4e007ed398c510.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 3</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">decltype</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> 和 <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> 是不一样的<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>不加括号就和上面的规则一样。</p><p>相当于 <code>int b = a;</code>。</p><p><img src="https://img-blog.csdnimg.cn/b3c73c8bff834a538ca89a7954a17c2c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>如果加上了一层括号，编译器会返回引用类型。</p><p>相当于 <code>int &amp;b = a;</code></p><p><img src="https://img-blog.csdnimg.cn/0d4f0dd931c246908c3b00af227791e2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><blockquote><p>哎，写到这里已经感受到C++的恶心了。</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;C-11标准-与-陌生用法&quot;&gt;&lt;a href=&quot;#C-11标准-与-陌生用法&quot; class=&quot;headerlink&quot; title=&quot;C++11标准 与 陌生用法&quot;&gt;&lt;/a&gt;C++11标准 与 陌生用法&lt;/h1&gt;&lt;p&gt;最近开始读《C++ Primer》了，记录一些以</summary>
      
    
    
    
    <category term="C/C++" scheme="https://sakkana.github.io/categories/C-C/"/>
    
    
    <category term="C/C++" scheme="https://sakkana.github.io/tags/C-C/"/>
    
  </entry>
  
  <entry>
    <title>MySql - 视图</title>
    <link href="https://sakkana.github.io/2022/04/16/Mysql%20%E8%A7%86%E5%9B%BE/"/>
    <id>https://sakkana.github.io/2022/04/16/Mysql%20%E8%A7%86%E5%9B%BE/</id>
    <published>2022-04-16T13:47:01.000Z</published>
    <updated>2022-04-19T09:52:33.735Z</updated>
    
    <content type="html"><![CDATA[<h1 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h1><h3 id="1-什么是视图"><a href="#1-什么是视图" class="headerlink" title="1. 什么是视图"></a>1. 什么是视图</h3><p>《数据库系统概念》中是这么描述视图的。</p><p>让用户看到数据库中关系的<code>完整集合</code>并非总是合适的。</p><p>处于安全性的考虑，我们可能需要向用户仅隐藏一个关系中的特定数据，</p><p>因此，我们可能希望创建一个<code>虚拟</code>的个性化集合。</p><p>该虚拟关系并<code>不预先</code>计算和存储，而是在<code>使用</code>虚拟关系的时候才能通过<code>执行查询</code>计算出来。</p><h3 id="2-语法"><a href="#2-语法" class="headerlink" title="2. 语法"></a>2. 语法</h3><h5 id="2-1-创建视图"><a href="#2-1-创建视图" class="headerlink" title="2.1 创建视图"></a>2.1 创建视图</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token operator">OR</span> <span class="token keyword">REPLACE</span><span class="token punctuation">]</span> <span class="token keyword">VIEW</span> 视图名称 <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>语句 <span class="token punctuation">[</span><span class="token keyword">WITH</span> <span class="token punctuation">[</span><span class="token keyword">CASCADED</span> <span class="token operator">|</span> <span class="token keyword">LOCAL</span><span class="token punctuation">]</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/70f029de3a9f475dbff19639c9f6332d.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>执行语句，可以看到多了这么一个东西</p><p><img src="https://img-blog.csdnimg.cn/f815cb289ff04f7090f7f2f62ffc9ce1.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="2-2-查询视图"><a href="#2-2-查询视图" class="headerlink" title="2.2 查询视图"></a>2.2 查询视图</h5><ul><li>查看视图创建</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> 视图名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a873aa2e20d54f3d848f03f78ef2193d.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/805791851416430a99fb8168262980ff.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>显然，<code>Create View</code>和我们创建时候的语句有些与不同，那是因为系统把缺省值也写进去了</p><ul><li>查看视图数据（表怎么查询，视图就怎么查询）</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 视图名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/1ffe2e7d0c5a4ddca7baca53a6c3e0b4.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/3c431fc314ae4de4a0d1d92941495033.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="2-3-修改视图"><a href="#2-3-修改视图" class="headerlink" title="2.3 修改视图"></a>2.3 修改视图</h5><p>方法一（其实和创建一个新视图是一回事）</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> 视图名称 <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>语句 <span class="token punctuation">[</span><span class="token keyword">WITH</span> <span class="token punctuation">[</span><span class="token keyword">CASCADED</span> <span class="token operator">|</span> <span class="token keyword">LOCAL</span><span class="token punctuation">]</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>方法二</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">VIEW</span> 视图名称<span class="token punctuation">[</span><span class="token punctuation">(</span>列名列表<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>语句 <span class="token punctuation">[</span><span class="token keyword">WITH</span> <span class="token punctuation">[</span><span class="token keyword">CASCADED</span> <span class="token operator">|</span> <span class="token keyword">LOCAL</span><span class="token punctuation">]</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="2-4-删除视图"><a href="#2-4-删除视图" class="headerlink" title="2.4 删除视图"></a>2.4 删除视图</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> 视图名称 <span class="token punctuation">[</span><span class="token punctuation">,</span>视图名称<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-检查选项"><a href="#3-检查选项" class="headerlink" title="3. 检查选项"></a>3. 检查选项</h3><p>我们可以对视图进行增删查改操作，这些操作会同步到物理存储的表当中。</p><p>由于我们在创建视图时设置了一些条件，如果没有设置检查选项，对视图插入不符合条件的记录也能成功插入到物理表当中。</p><p><img src="https://img-blog.csdnimg.cn/95694b85032e4b04bf4b575b3ca68fe8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>此时没有设置检查选项，能够插入不符合条件的数据。</p><p><img src="https://img-blog.csdnimg.cn/6f8afcf813b04424bae6bc9035252338.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>若我们加入检查选项，则这条记录的插入就会失败</p><p><img src="https://img-blog.csdnimg.cn/f9f2ec1142cb4bafac805982610d9f75.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="CASCADED-级联"><a href="#CASCADED-级联" class="headerlink" title="CASCADED (级联)"></a>CASCADED (级联)</h5><p>physical table -&gt; view A -&gt; view B</p><p>如果在 viewB 上增加检查选项 CASCADED 并执行插入时，MySQL会同时去检查view B和 view A中的条件。</p><p><img src="/2022/04/16/Mysql%20%E8%A7%86%E5%9B%BE/Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220419165514030.png" alt="image-20220419165514030"></p><p>刚开始我们创建一个视图 info_view ，不指定检查选项，发现 99 &gt; 5，仍然可以插入成功。</p><p>基于 info_view 我们再创建一个视图 info_view2。</p><p>当我们插入 id = 101 和 id = 4 时失败了，这是因为他们都不满足我们的检查条件。</p><p>一层一层往上检查，类似于诛九族。</p><p><img src="https://img-blog.csdnimg.cn/8ed58ba2556f424e856ef1cb7c18fbf9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>如果下面再创建一个视图 info_view3, 这个视图基于 info_view2。</p><p>该视图没有设置检查选项。</p><p>然而，前两个都插入成功，第三个插入失败了。</p><p>前两个插入成功的原因是他们符合 info_view1 和 info_view2 的检查选项（5 &lt; x &lt;= 100），而第三条不符合。</p><p><img src="https://img-blog.csdnimg.cn/486c6b7eddcb4b9bbd6d4c552ea12d1f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/6be68acfd5bb4cd2aa9b11ec3e8c19fc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/c501f3ed09284a6bad656e497a19b92e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>总而言之，如果使用 CASCADED 检查选项，其作用为：</p><ul><li>若当球视图<code>有检查选项</code>，则插入数据要满足<code>当前视图 + 当前视图所依赖的所有视图</code> 的检查选项。</li><li>若当前视图<code>没有检查选项</code>，则插入数据要满足<code>当前视图所依赖的有检查选项的视图 + 该有检查选项的视图所依赖的视图</code>的检查选项。</li></ul><p>自己及祖先只要有检查条件就就直接递归到根。</p><h5 id="local"><a href="#local" class="headerlink" title="local"></a>local</h5><p>第一层虽然 4 &lt; 5，但由于没设置检查选项，可以插入。</p><p><img src="https://img-blog.csdnimg.cn/bfd5f8686bf9490492200062d8e805c6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>第二层设置了检查选项，因此 101 肯定无法插入。</p><p><img src="https://img-blog.csdnimg.cn/6c9cc39f2e21439e81a47ab1977c8191.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>但是 4 却可以插入，因为MySQL也递归去检查，但是当前视图所依赖的视图没有检查选项，因此不再检查。</p><p><img src="https://img-blog.csdnimg.cn/e3584ca7cd5a4213b64bb856e4114f82.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>第三层，这个 1000 虽然不满足当前条件，但是却没有添加检查选项，因此递归网上检查，发现不复合第二层的条件，因此插入失败。</p><p><img src="https://img-blog.csdnimg.cn/69642d88fae24f6baff1215b10a6e3ac.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>如果我们给第一层也添加一个检查条件，会发现MySQL真的会递归检查。</p><p>19 同时不符合条件，插入失败。</p><p><img src="https://img-blog.csdnimg.cn/6aa1282ee5544522af08e9745cc02dc0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>21却可以。</p><p><img src="https://img-blog.csdnimg.cn/512be49c27dd4055be624ec41d14bfb4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>总结：</p><ul><li>若当球视图<code>有检查选项</code>，则插入数据要满足<code>当前视图 + 当前视图所依赖的有检查选项的视图</code> 的检查选项。</li><li>若当前视图<code>没有检查选项</code>，则插入数据要满足<code>当前视图所依赖的有检查选项的视图</code>的检查选项。</li></ul><p>简而言之，CASCADED 从自己开始往上找，只要碰到一个检查选项，从这一层开始及上面的所有选项都检查一遍，相当于只要发现一个上面全部连坐。LOCAL则是只有有检查选项才会检查。，相当于检查选项是local的，不会波及无辜。</p><h3 id="4-更新-amp-作用"><a href="#4-更新-amp-作用" class="headerlink" title="4. 更新 &amp; 作用"></a>4. 更新 &amp; 作用</h3><h5 id="视图的更新条件"><a href="#视图的更新条件" class="headerlink" title="视图的更新条件"></a>视图的更新条件</h5><p><img src="https://img-blog.csdnimg.cn/2e40a7a8e47442f6ba5778b6f94f8c90.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/7bd4258cfd1141dcabe969eedb183b7f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/e2e7c38e72ec4a1fb9e85667d9723fa3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/02b30d7f7a5d4daf8207a405cc4ca970.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;视图&quot;&gt;&lt;a href=&quot;#视图&quot; class=&quot;headerlink&quot; title=&quot;视图&quot;&gt;&lt;/a&gt;视图&lt;/h1&gt;&lt;h3 id=&quot;1-什么是视图&quot;&gt;&lt;a href=&quot;#1-什么是视图&quot; class=&quot;headerlink&quot; title=&quot;1. 什么是视图&quot;&gt;&lt;</summary>
      
    
    
    
    <category term="数据库" scheme="https://sakkana.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="数据库" scheme="https://sakkana.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>Linux多线程</title>
    <link href="https://sakkana.github.io/2022/04/12/Linux%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    <id>https://sakkana.github.io/2022/04/12/Linux%E5%A4%9A%E7%BA%BF%E7%A8%8B/</id>
    <published>2022-04-12T03:57:01.000Z</published>
    <updated>2022-04-12T04:37:08.277Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Linux-多线程"><a href="#Linux-多线程" class="headerlink" title="Linux 多线程"></a>Linux 多线程</h1><h2 id="1-什么是线程"><a href="#1-什么是线程" class="headerlink" title="1. 什么是线程"></a>1. 什么是线程</h2><h3 id="1-1-线程概述"><a href="#1-1-线程概述" class="headerlink" title="1.1 线程概述"></a>1.1 线程概述</h3><p><img src="https://img-blog.csdnimg.cn/63d34bdae18642b498d13c1932dcf8cd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这里的 “多个任务”，可以是相同的也可以是不同的。</p><p><code>并发</code>，宏观上多个任务同时执行，微观上CPU在不同的程序之间来回快速切换。</p><p><code>并行</code>，他们真的在同时执行。（多核处理器）</p><p><code>进程</code>是CPU分配资源的最小单位</p><p><code>线程</code>是操作系统调度执行的最小单位</p><p>进程重量级，线程轻量级，内核把线程当作进程来看待。</p><p>利用 <code>ps aux</code> 可以查看当前运行的进程</p><p>ps a 显示现行终端机下的所有程序，包括其他用户的程序。</p><p>ps u 　 以用户为主的格式来显示程序状况。</p><p>ps x 　 显示所有程序，不以终端机来区分。</p><p><img src="https://img-blog.csdnimg.cn/bdf48b89966744978044ce821a9fd437.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>可以看到，火狐的new-window进程的 <code>PID</code> = 105266</p><p>执行 <code>ps -Lf 105266</code> , 可以看到同一个进程 105266 下有许多的线程 (<code>LWP</code>, 即轻量级进程)</p><p>他们的进程号 PID 是相同的，但是线程号 LWP 天各一方</p><p>可见，许多应用程序使是用多线程去实现的</p><p><img src="https://img-blog.csdnimg.cn/eb3a709fcdb34b7cb848cbad50ba0faa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="1-2-线程-amp-进程-の-difference"><a href="#1-2-线程-amp-进程-の-difference" class="headerlink" title="1.2 线程 &amp; 进程 の difference"></a>1.2 线程 &amp; 进程 の difference</h3><p><img src="https://img-blog.csdnimg.cn/8850622c21224232afc38711be33129c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>Linux 刚开始在开发的时候没有线程的概念，只有进程，后来通过第三方库加进去。</p><p><code>fork()</code>可以创建一个子进程，他会复制（代价非常高，要复制内存页表，文件描述符表等）父进程的虚拟地址空间。进程间通信困难，因为父子进程并没有共享内存。子进程的虚拟地址空间也会被映射到物理内存上。</p><h5 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h5><p><img src="https://img-blog.csdnimg.cn/02d1c96532fc442f87ec5e706647fb45.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="子进程完全复制父进程的地址空间"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h5><p>栈和.text会被分配给每一个线程</p><p><img src="https://img-blog.csdnimg.cn/83a47c07a3bb49b79807388df3f7bd79.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_11,color_FFFFFF,t_70,g_se,x_16" alt="线程间共享地址空间，只有少数几个区域私有"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="1-3-线程间的资源共享"><a href="#1-3-线程间的资源共享" class="headerlink" title="1.3 线程间的资源共享"></a>1.3 线程间的资源共享</h3><p><img src="https://img-blog.csdnimg.cn/77b0d89b970a4233aa89b6c61f483940.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="1-4-NPTL"><a href="#1-4-NPTL" class="headerlink" title="1.4 NPTL"></a>1.4 NPTL</h3><p>NPTL = Native POSIX Thread Library</p><p><img src="https://img-blog.csdnimg.cn/07a6f679204b42729f5034cdf7a0666c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/4f528923b05243aab1bd4d862725fdb6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h2 id="2-创建线程"><a href="#2-创建线程" class="headerlink" title="2. 创建线程"></a>2. 创建线程</h2><h2 id="3-终止线程"><a href="#3-终止线程" class="headerlink" title="3. 终止线程"></a>3. 终止线程</h2><h2 id="4-连接已终止的线程"><a href="#4-连接已终止的线程" class="headerlink" title="4. 连接已终止的线程"></a>4. 连接已终止的线程</h2><h2 id="5-线程的分离"><a href="#5-线程的分离" class="headerlink" title="5. 线程的分离"></a>5. 线程的分离</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Linux-多线程&quot;&gt;&lt;a href=&quot;#Linux-多线程&quot; class=&quot;headerlink&quot; title=&quot;Linux 多线程&quot;&gt;&lt;/a&gt;Linux 多线程&lt;/h1&gt;&lt;h2 id=&quot;1-什么是线程&quot;&gt;&lt;a href=&quot;#1-什么是线程&quot; class=&quot;he</summary>
      
    
    
    
    <category term="系统编程" scheme="https://sakkana.github.io/categories/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/"/>
    
    
    <category term="C/C++" scheme="https://sakkana.github.io/tags/C-C/"/>
    
  </entry>
  
  <entry>
    <title>Linux多进程</title>
    <link href="https://sakkana.github.io/2022/04/12/Linux%E5%A4%9A%E8%BF%9B%E7%A8%8B/"/>
    <id>https://sakkana.github.io/2022/04/12/Linux%E5%A4%9A%E8%BF%9B%E7%A8%8B/</id>
    <published>2022-04-12T03:57:01.000Z</published>
    <updated>2022-04-20T07:21:05.733Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Linux-多进程"><a href="#Linux-多进程" class="headerlink" title="Linux 多进程"></a>Linux 多进程</h1><h2 id="1-什么是进程"><a href="#1-什么是进程" class="headerlink" title="1. 什么是进程"></a>1. 什么是进程</h2><h3 id="1-1-程序-amp-进程"><a href="#1-1-程序-amp-进程" class="headerlink" title="1.1 程序 &amp; 进程"></a>1.1 程序 &amp; 进程</h3><p><img src="https://img-blog.csdnimg.cn/cab475b899a042b29a222a7dc593d2e6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>元信息：文件大小，创建、修改信息等</p><p><img src="https://img-blog.csdnimg.cn/2345357c403f4891a9e1f9c1b2087ba4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>程序只占用磁盘资源，是死的；进程占用内存资源、CPU资源，是活的。</p><h3 id="1-2-单道-amp-多道程序设计"><a href="#1-2-单道-amp-多道程序设计" class="headerlink" title="1.2 单道 &amp; 多道程序设计"></a>1.2 单道 &amp; 多道程序设计</h3><p><img src="https://img-blog.csdnimg.cn/a74e803c5857482c8f30d096fb8b90ca.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>早期计算机，一个计算机只能运行一个程序，如果要运行别的程序，当前程序必须停止，效率低下。</p><p>在单任务CPU中， 多道程序就是在管理程序的控制下穿插执行，而不是同时执行。目的：<code>提高CPU利用率</code>。</p><h3 id="1-3-时间片"><a href="#1-3-时间片" class="headerlink" title="1.3 时间片"></a>1.3 时间片</h3><p>把时间切成一片一片。</p><p><img src="https://img-blog.csdnimg.cn/94398aec116b414d9dd4e0ff0312dc80.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>进程调度的程序</code>来切换进程，保存（放到PCB中，见1.5）原先进程的状态，再加载另一个进程的状态。</p><p>时间片太短，会导致切换在整个程序运行中占了很大的百分比；如果时间片太长，会导致人能感觉出来，宏观上无法同时执行。</p><h3 id="1-4-并行-amp-并发"><a href="#1-4-并行-amp-并发" class="headerlink" title="1.4 并行 &amp; 并发"></a>1.4 并行 &amp; 并发</h3><p><img src="https://img-blog.csdnimg.cn/bb63ccf831404b799e82b00bf7806d36.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/9d1d033ebafa44fd91dd74ba66af656d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>并发问题：双11时，许多人会同时访问服务器，如何保证服务器在同一时刻大量的同时访问不崩溃掉？</p><h3 id="1-5-进程控制块-PCB"><a href="#1-5-进程控制块-PCB" class="headerlink" title="1.5 进程控制块 (PCB)"></a>1.5 进程控制块 (PCB)</h3><p><img src="https://img-blog.csdnimg.cn/adc8c12b631440539718c23ddabf29c1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="> </p><p><img src="https://img-blog.csdnimg.cn/057f6230b2784e04a294db6f0d65ae1d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>（当前工作目录）虚拟地址空间中有个环境变量</p><p>利用 <code>ulimit -a</code> 可以查看使用资源上线(可修改，但一般不这么做)</p><p><img src="https://img-blog.csdnimg.cn/0b311c88192d4fd689dc5f19ff8aa268.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h2 id="2-进程状态转换"><a href="#2-进程状态转换" class="headerlink" title="2. 进程状态转换"></a>2. 进程状态转换</h2><h3 id="2-1-进程的状态"><a href="#2-1-进程的状态" class="headerlink" title="2.1 进程的状态"></a>2.1 进程的状态</h3><p><img src="https://img-blog.csdnimg.cn/f1fad07422ec4f1ea751bd17e1d2a7d2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>就绪态时，OS已经为进程分配了内存资源，但是没有CPU资源。</p><p>简而言之，万事俱备，等待调度，只剩被CPU执行。</p><p>阻塞态无法直接变成运行态，而是需要先进入就绪态。</p><p><img src="https://img-blog.csdnimg.cn/819c0259067b4ae780dcbabd29defce2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="2-2-进程相关命令"><a href="#2-2-进程相关命令" class="headerlink" title="2.2 进程相关命令"></a>2.2 进程相关命令</h3><h5 id="2-2-1-ps-aux-amp-ps-ajx"><a href="#2-2-1-ps-aux-amp-ps-ajx" class="headerlink" title="2.2.1 ps aux &amp; ps ajx"></a>2.2.1 <code>ps aux</code> &amp; <code>ps ajx</code></h5><p>查看进程快照snapshot（静态数据）</p><p><img src="https://img-blog.csdnimg.cn/fe7918f133e748bfa382b9d0085ae671.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="ps aux"></p><p><img src="https://img-blog.csdnimg.cn/0fee9a9becdb490b95d07601f18d276f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>tty</code> 可以查看当前在哪个终端。</p><p><img src="https://img-blog.csdnimg.cn/dd59a723d08b4f94a1ac53344b35311b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/7a21481cf4374ccda3ac9e0d5debf37c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="ps ajx"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>PPID</code>：parent process ID -&gt; 父进程ID</p><p><code>PGID</code>：process group ID -&gt; 进程组ID</p><blockquote><p>一个进程组里面可以有很多个进程</p></blockquote><p><code>SID</code>：session ID -&gt; 会话ID</p><h5 id="2-2-top"><a href="#2-2-top" class="headerlink" title="2.2 top"></a>2.2 <code>top</code></h5><p>实时更新</p><p><img src="https://img-blog.csdnimg.cn/20ebbd3aa48b4ee7b781d9c7930de092.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/57e21e24a89346e59697b32c80a9cd74.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="top"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="2-3-kill"><a href="#2-3-kill" class="headerlink" title="2.3 kill"></a>2.3 <code>kill</code></h5><p><img src="https://img-blog.csdnimg.cn/49d19bb98fa647118fed8b3abb94ec8d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="kill"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>kill -9 self‘s PID</code> 可以杀死自己， 光 <code>kill self's PID</code>杀不死自己。</p><p><img src="https://img-blog.csdnimg.cn/71fa8ccf1a924710bb71957729c35a40.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>-9 是 <code>9号信号</code>，是个<code>宏</code>值</p><p><code>kill -SIGKILL self's PID</code>也有同样的效果</p><p><img src="https://img-blog.csdnimg.cn/d19abc8d90184d979956348a0e986472.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>使用 <code>./filename &amp;</code> 可以使得程序在后台运行，同时可以输入一些指令。</p><p>如果在前台运行，当前的shell是阻塞的，不能输入任何内容，等待程序结束。</p><h3 id="3-进程号"><a href="#3-进程号" class="headerlink" title="3. 进程号"></a>3. 进程号</h3><p><img src="https://img-blog.csdnimg.cn/411cb725b0d746b4b147f575c6847caf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>init进程</code>是操作系统内核最初始，最大的进程，任何进程都是由 init 进程派生出来的。</p><p>我们执行的程序的父进程是当前的 <code>shell</code>。</p><p><code>getpgid(pid_t pid)</code>,如果参数传NULL, 就是获取当前进程的PGID, 如果传一个进程的PID, 就是获取这个指定的进程号的PGID。</p><h2 id="3-进程创建"><a href="#3-进程创建" class="headerlink" title="3. 进程创建"></a>3. 进程创建</h2><p><img src="https://img-blog.csdnimg.cn/c463c49b14bb491994a537faa7732164.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       fork <span class="token operator">-</span> create a child processSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token class-name">pid_t</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// pid_t 是个 int</span>DESCRIPTION       <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  【creates  a  new  process】 by 【duplicating the calling process】<span class="token punctuation">.</span>  The new process is referred to as the child process<span class="token punctuation">.</span>       The calling process is referred to as the parent process<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child process, return value=%d, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                pid<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent process, return value=%d, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                pid<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//sleep(1);</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="我们无法揣测子进程和父进程谁先执行"><a href="#我们无法揣测子进程和父进程谁先执行" class="headerlink" title="我们无法揣测子进程和父进程谁先执行"></a>我们无法揣测子进程和父进程谁先执行</h5><p>所有的代码在父子进程的地址空间中都有，只不过在子进程中，</p><p>调用fork()之前的代码不会被执行。</p><p>这一段非常明显，因为我们发现 父进程pid=153207，子进程pid=153208</p><p>父进程首先运行，打印到684之后中断发生，</p><p>子进程开始运行，打印一行消息，</p><p>之后再次切换到父进程打印685，</p><p>之后又切换到子进程，打印1，2</p><p>如此循环往复，不断切换…</p><p>具体谁执行却决于操作系统调度哪个进程</p><p><img src="https://img-blog.csdnimg.cn/5e4adb73849e4761b885ad838f7bc23c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h2 id="3-父子进程"><a href="#3-父子进程" class="headerlink" title="3. 父子进程"></a>3. 父子进程</h2><h3 id="3-1-父子进程の虚拟地址空间情况"><a href="#3-1-父子进程の虚拟地址空间情况" class="headerlink" title="3.1 父子进程の虚拟地址空间情况"></a>3.1 父子进程の虚拟地址空间情况</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">The child process and the parent process run in 【separate memory spaces】<span class="token punctuation">.</span>  At the time of <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> both memory spaces have the 【same content】<span class="token punctuation">.</span>  Memory writes<span class="token punctuation">,</span> file <span class="token function">mappings</span> <span class="token punctuation">(</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> and <span class="token function">unmappings</span> <span class="token punctuation">(</span><span class="token function">munmap</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> performed by one of the processes <span class="token keyword">do</span> not affect the other<span class="token punctuation">.</span>       The child process is an exact duplicate of the parent process except <span class="token keyword">for</span> the following points<span class="token operator">:</span><span class="token operator">*</span>  The child has its 【own unique process ID】<span class="token punctuation">,</span> and this PID does not match the ID of any existing  process  <span class="token function">group</span> <span class="token punctuation">(</span><span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> or session<span class="token punctuation">.</span>       <span class="token operator">*</span>  The child's parent process ID is the same as the parent's process ID<span class="token punctuation">.</span>       <span class="token operator">*</span>  The child does 【not inherit】 its parent's 【memory locks】 <span class="token punctuation">(</span><span class="token function">mlock</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mlockall</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token operator">*</span>  Process  resource  <span class="token function">utilizations</span>  <span class="token punctuation">(</span><span class="token function">getrusage</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  and  CPU time <span class="token function">counters</span> <span class="token punctuation">(</span><span class="token function">times</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> are reset to zero in the child<span class="token punctuation">.</span>       <span class="token operator">*</span>  The child's set of pending signals is initially <span class="token function">empty</span> <span class="token punctuation">(</span><span class="token function">sigpending</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token operator">*</span>  The child does not inherit semaphore adjustments from its <span class="token function">parent</span> <span class="token punctuation">(</span><span class="token function">semop</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token operator">*</span>  The child does not inherit process<span class="token operator">-</span>associated record locks from its <span class="token function">parent</span> <span class="token punctuation">(</span><span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  <span class="token punctuation">(</span>On the other hand<span class="token punctuation">,</span> it does inherit <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> open file description locks and <span class="token function">flock</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> locks from its parent<span class="token punctuation">.</span><span class="token punctuation">)</span>       <span class="token operator">*</span>  The child does not inherit timers from its <span class="token function">parent</span> <span class="token punctuation">(</span><span class="token function">setitimer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">timer_create</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token operator">*</span>  The  child  does  not  inherit  outstanding  asynchronous  I<span class="token operator">/</span>O  operations  from  its  <span class="token function">parent</span> <span class="token punctuation">(</span><span class="token function">aio_read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">aio_write</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nor does it inherit any asynchronous I<span class="token operator">/</span>O contexts from its <span class="token function">parent</span> <span class="token punctuation">(</span>see <span class="token function">io_setup</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>父进程和子进程的虚拟地址空间完全一样，包括用户区和内核区。（除了两者的pid不同，以及fork的返回值不同（父进程中返回值=子进程pid，子进程中返回值=0））。</p><p>因此修改同名变量并不会影响对方，因为两者分明就在不同的内存中，只不过数据都是赋值过来的罢了。</p><p><img src="https://img-blog.csdnimg.cn/6f7426aed23a4363ba679f838649f7cc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> global_a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 测试全局变量（子进程复制）</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> local_a <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span><span class="token comment">// 测试局部变量（子进程复制）</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> after_fork_a <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span><span class="token comment">// 测试fork之后各自产生的局部变量</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Before: global_a=%d, local_a=%d, after_fork_a=%d\n"</span><span class="token punctuation">,</span>\            global_a<span class="token punctuation">,</span> local_a<span class="token punctuation">,</span> after_fork_a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child process, return value=%d, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                pid<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token operator">++</span> global_a<span class="token punctuation">,</span> <span class="token operator">++</span> local_a<span class="token punctuation">,</span> <span class="token operator">++</span> after_fork_a<span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"global_a=%d, local_a=%d, after_fork_a=%d\n"</span><span class="token punctuation">,</span>                global_a<span class="token punctuation">,</span> local_a<span class="token punctuation">,</span> after_fork_a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>         <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent process, return value=%d, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                pid<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token operator">--</span> global_a<span class="token punctuation">,</span> <span class="token operator">--</span> local_a<span class="token punctuation">,</span> <span class="token operator">--</span> after_fork_a<span class="token punctuation">;</span>                     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"global_a=%d, local_a=%d, after_fork_a=%d\n"</span><span class="token punctuation">,</span>                global_a<span class="token punctuation">,</span> local_a<span class="token punctuation">,</span> after_fork_a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/bca2c668179149b38209c1109653af15.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="写时复制"><a href="#写时复制" class="headerlink" title="写时复制"></a>写时复制</h5><p>实际上，Linux的fork()使用的是写时拷贝（copy-on-write）技术。</p><p>写时拷贝是一种可以<code>推迟</code>甚至<code>避免</code>拷贝数据的技术。</p><p>内核此时并不复制整个进程的地址空间，而是让父子进程<code>共享</code>同一个地址空间。</p><p>只有在需要写如的时候才会复制地址空间，从而使各个进程拥有各自的不同的地址空间。</p><p>换而言之，资源的复制是在需要写入的时候才会进行，</p><p>在此之前通过<code>只读（read-only）</code>方式共享数据。</p><p>因为如果你没有写操作，拷贝会拉跨性能，</p><p>更别说你fork完了就直接exec。</p><p>fork()之后父子进程<code>共享文件</code>，</p><p>fork()产生的子进程与父进程有<code>相同的文件描述符</code>，指向相同的文件，</p><p>引用计数增加，共享文件偏移指针。</p><p><strong>读的时候共享，一旦有写操作就马上复制，互不干扰</strong></p><p><img src="https://img-blog.csdnimg.cn/798b2e69b46d43f2a151f0c5c8bbe125.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="3-2-父子进程の关系-と-GDB多进程调试"><a href="#3-2-父子进程の关系-と-GDB多进程调试" class="headerlink" title="3.2 父子进程の关系 と GDB多进程调试"></a>3.2 父子进程の关系 と GDB多进程调试</h3><h5 id="父子进程关系"><a href="#父子进程关系" class="headerlink" title="父子进程关系"></a>父子进程关系</h5><p>区别：1.fork()函数的返回值不同</p><p>​                    父进程：&gt; 0 返回子进程的PID</p><p>​                    子进程：= 0 </p><p>​            2.PCB（Process Control Block）中的一些数据</p><p>​                    当前进程的ID -&gt; PID</p><p>​                    当前进程的父进程ID -&gt; PPID</p><p>​                    信号集</p><p>共同点：</p><ol><li><p>某些状态下，子进程刚被创建出来，还没有执行任何写数据的操作时，</p><p>​    用户区数据相同</p><p>​    文件描述符表相同</p></li></ol><ol start="2"><li><strong>父子进程<code>读时共享</code>变量，写时候<code>拷贝</code>变量（因此不能用变量进行进程间通信)</strong></li></ol><h5 id="gdb调试"><a href="#gdb调试" class="headerlink" title="gdb调试"></a>gdb调试</h5><p><img src="https://img-blog.csdnimg.cn/a0b18e6e02034cad949fb02bf9aa591e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"></p><p><code>set follow-fork-mode [parent | child]</code>：切换默认调试的进程</p><p><code>set detach-on-fork [on | off]</code>：off会使得其他进程阻塞在fork这一句，不自动运行下去</p><p><code>detach inferiors id</code>：使得编号为id的进程脱离调试，直接运行下去，这里还可以换成remove/kill等命令</p><h2 id="4-exec-函数族"><a href="#4-exec-函数族" class="headerlink" title="4. exec 函数族"></a>4. exec 函数族</h2><p><code>函数族</code>：一系列功能相近的函数，类似C++中的函数重载</p><p><img src="https://img-blog.csdnimg.cn/3af4935f260546fd942a5a21fc6a99e5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>由于直接调用exec会覆盖当前进程的数据，而主进程往往也要做一些事情，因此我们先fork出来一个子进程，在子进程中执行exec。</p><p>exec执行成功后不返回，因为本身进程中的内容被替换了（除了PID等表面信息），执行exec的进程中的代码全都变了，变成了新程序的代码，因此返回没有任何意义。所以只有调用失败时才会返回，告知调用失败，原来的代码不会被替换，从exec的调用点接着往下执行。</p><p><img src="https://img-blog.csdnimg.cn/3f7e70af891049e8b7708fe712c254d3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/0cf2bd28947d4a4baaf0a37b2d42f91c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p> 只有 <code>execve</code> 才是UINX/LINUX的系统函数，其余6个都是在这个基础上的封装，其中 <code>execl</code>和<code>execlp</code>比较常用。</p><h5 id="execl"><a href="#execl" class="headerlink" title="execl"></a>execl</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">execl</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//(可变参数，一个或多个)</span>                      <span class="token comment">/* (char  *) NULL */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>参数：</p><ul><li>文件路径（文件路径及建议使用绝对路径）</li><li>传入参数列表<ul><li><code>argv[0]</code>时程序的名称，后面都是参数列表，最后以NULL结束（哨兵，是程序知道解析完成）</li></ul></li></ul><p>返回值：</p><ul><li>只有在调用失败时才会返回 <code>-1</code>，并设置 <code>errorno</code></li><li>调用成功没有返回值</li></ul><h5 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Parent process, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">execl</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This might not be printed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这句话是不应该被输出的</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i = %d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中，可执行程序hello的源代码为</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">1</span> #include <span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>                                                                                                                 <span class="token number">2</span><span class="token number">3</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">4</span> <span class="token punctuation">{</span><span class="token number">5</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">6</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token number">7</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行成功，可以看到execl后面的那句<code>printf("This might not be printed.\n");</code>和后面的循环并没有被执行，可见新的可执行程序将原来的子进程代码替换掉了。</p><p>然而，这里的Hello似乎没有和其他的输出在同一个块中，这是因为<code>孤儿进程</code>的缘故。</p><p><img src="https://img-blog.csdnimg.cn/74df804c2ffd4478b46bb997a8d28c22.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>只要在原来的代码父进程中加一句<code>sleep</code>，就可以解决这个问题。</p><p><img src="https://img-blog.csdnimg.cn/cded13399730469fadcdb8667b1af8b7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>此外，我们也可以执行系统的可执行程序</p><h5 id="测试代码（执行-ps-aux）"><a href="#测试代码（执行-ps-aux）" class="headerlink" title="测试代码（执行 ps aux）"></a>测试代码（执行 <code>ps aux</code>）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Parent process, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">execl</span><span class="token punctuation">(</span><span class="token string">"/bin/ps"</span><span class="token punctuation">,</span> <span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 第一个参数写./ps也可以</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This might not be printed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i = %d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/23b8d48b726c4693a0f1190679a30903.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="execl执行SHELL命令"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="execlp"><a href="#execlp" class="headerlink" title="execlp"></a>execlp</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                       <span class="token comment">/* (char  *) NULL */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>参数：</p><ul><li>文件名（会到环境变量中查找指定的可执行文件，如果找到了就执行，找不到就执行不成功）</li><li>参数列表</li></ul><p>如果直接在<code>execl</code>中直接写文件名，他会找不到该文件</p><p><img src="https://img-blog.csdnimg.cn/9a71ca7dc94a4e5e8460bca3fd355667.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>但是<code>execlp</code>却能做到不写绝对路径（或者该可执行文件不在当前目录下），直接写文件名</p><h5 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Parent process, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This might not be printed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i = %d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/524a843223cb482c868cb3eaa37afe77.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>这是因为ps的信息已经在环境变量中了，程序会自己去环境变量中寻找这个可执行文件。</p><p>输入 <code>env</code> 可以查看环境变量。</p><p><img src="https://img-blog.csdnimg.cn/ccda21d478324e36b3bf4f4e68fd474c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="execv"><a href="#execv" class="headerlink" title="execv"></a>execv</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">execv</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参数：</p><ul><li>字符串数组，把需要的参数都写到数组里传进去</li></ul><h5 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Parent process, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// 参数列表</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">execv</span><span class="token punctuation">(</span><span class="token string">"/bin/ps"</span><span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This might not be printed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i = %d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-进程退出-と-孤儿进程-と-僵尸进程"><a href="#5-进程退出-と-孤儿进程-と-僵尸进程" class="headerlink" title="5. 进程退出 と 孤儿进程 と 僵尸进程"></a>5. 进程退出 と 孤儿进程 と 僵尸进程</h2><p><img src="https://img-blog.csdnimg.cn/063388892c8a4c61b6af605b05b6827b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>子进程退出后，父进程可以获得子进程的退出状态，因为什么原因退出。</p><p>子进程的<code>用户区数据</code>会自动释放，父进程有义务回收<code>内核区的数据（PCB）</code>。</p><h5 id="exit-标准C库函数"><a href="#exit-标准C库函数" class="headerlink" title="exit (标准C库函数)"></a>exit (标准C库函数)</h5><p>标准C库的<code>exit()</code>会做更多的事情（相比<code>_exit()</code>）,包括刷新缓冲区（将缓冲区中的数据写入相应的文件）等，最后调用底层的<code>_exit()</code>。</p><h5 id="测试代码-3"><a href="#测试代码-3" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/fc424710c34b4f6a98ec12f20ab6ad7f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><code>\n</code>会刷新缓冲区，因此在打印了Hello之后缓冲区就空了，之后再打印world，这个实际上也先被写入了缓冲区，调用exit()退出时，系统也先刷新缓冲区，world被写在了屏幕上。</p><h5 id="exit-Linux系统函数"><a href="#exit-Linux系统函数" class="headerlink" title="_exit (Linux系统函数)"></a>_exit (Linux系统函数)</h5><h5 id="测试代码-4"><a href="#测试代码-4" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2022/04/12/Linux%E5%A4%9A%E8%BF%9B%E7%A8%8B/Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220414000215298.png" alt="image-20220414000215298"></p><p>神奇的是，world并没有被输出，这是因为前面<code>\n</code>刷新了缓冲区，这句printf执行完之后缓冲区被刷新了，之后的world被写入了缓冲区，但是_exit()系统函数并不会刷新缓冲区，因此只输出了Hello。</p><h5 id="孤儿进程"><a href="#孤儿进程" class="headerlink" title="孤儿进程"></a>孤儿进程</h5><p><img src="https://img-blog.csdnimg.cn/8d98f06394c9456c8bffd3d943e660a0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="测试代码-5"><a href="#测试代码-5" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 子进程睡1s，父进程早就运行完死了</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child process, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent process, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> j<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/4efd6c5bdfd74739a1ddaf9f98744be2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>可见，父进程运行结束后，shell马上给出了提示符，但是子进程运行完没有给。</p><p>这是因为，当我们./app开始运行，shell会自动切换到后台运行，有输出了再切换到前台输出。我们的shell是这个pid=157394的父进程，他知道这个进程结束了，因此shell切换回了前台，显示提示符。但是他不知道我们运行的这个进程还有个子进程。</p><p>由于子进程和父进程共享文件描述符，因此子进程也会输出到终端。</p><p>最终子进程被1号进程init领养，回收。</p><p>孤儿进程没有任何危害。</p><h5 id="僵尸进程"><a href="#僵尸进程" class="headerlink" title="僵尸进程"></a>僵尸进程</h5><p><img src="https://img-blog.csdnimg.cn/66d2bac3e1674ad99af6963af12f0bc7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>孤儿进程是父亲先死亡，孩子变成了孤儿，被init释放。</p><p>僵尸进程是孩子死亡，但是父亲没有去回收子进程的资源。为什么会这样呢？</p><h5 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child process, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent process, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/513822d9f54c4d7c91e169ef93b15734.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>子进程结束后，父进程仍被困在死循环里没有去回收子进程，因此子进程变成了一个僵尸进程。</p><p>且无法用 kill -9 杀死。</p><p>如果产生了大量的僵尸进程，会导致大量的进程号被占用。</p><p><img src="https://img-blog.csdnimg.cn/2e0ad670ff574d20b6c8be2e2a7f86bb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="6-wait-函数-と-waitpid-函数"><a href="#6-wait-函数-と-waitpid-函数" class="headerlink" title="6. wait 函数 と waitpid 函数"></a>6. wait 函数 と waitpid 函数</h2><h5 id="进程回收"><a href="#进程回收" class="headerlink" title="进程回收"></a>进程回收</h5><p>父进程通过调用<code>wait</code> 或 <code>waitpid</code> 得到子进程的退出状态，并彻底清除这个进程。</p><p><code>wait</code>是阻塞地等待，如果子进程一直没结束，父进程就一直阻塞，直到子进程结束。</p><p>子进程死亡后父进程中的wait不阻塞，往下执行。</p><p>waitpid 可以设置为不阻塞，还可以指定等待哪个子进程结束。</p><p>应该在循环中多次调用 wait，清理多个子进程。</p><h4 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h4><p>执行成功返回被回收的子进程PID，没有子进程了或失败返回 -1。</p><h5 id="示例代码（僵尸进程的产生）"><a href="#示例代码（僵尸进程的产生）" class="headerlink" title="示例代码（僵尸进程的产生）"></a>示例代码（僵尸进程的产生）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"son pid=%s died\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，执行程序之后，，5个子进程打印了各自的进程号之后直接死亡，父进程继续执行。</p><p><img src="https://img-blog.csdnimg.cn/d51dab915f5b4815bb0cfaa5ec37b82e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>由于父进程一直在死循环中执行，没有去回收子进程，导致已经死亡却没有被回收的子进程成为了5个僵尸进程，使用 <code>ps aux</code> 可以看到他们的状态是Z。</p><p><img src="https://img-blog.csdnimg.cn/fcbbce837e2245d89616d627fdd520c2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>当我们用 <code>kill -9</code> 去杀死僵尸进程，惊奇地发现他们无法被杀死。</p><p><img src="https://img-blog.csdnimg.cn/6f084087cafa4a3aa217f4d5bc0dd44e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_13,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>kill 之后这个进程仍然存在。我们只能通过 <code>ctrl + c</code> 来中止当前的父进程。</p><p><img src="https://img-blog.csdnimg.cn/39e7cc4cb603443bad33bd7c2af020f2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="示例代码（父进程通过wait释放子进程资源）"><a href="#示例代码（父进程通过wait释放子进程资源）" class="headerlink" title="示例代码（父进程通过wait释放子进程资源）"></a>示例代码（父进程通过wait释放子进程资源）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 父进程会在这里阻塞</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child pid=%d died!\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，父进程就打印了一行就再也没有出现过了，因为wait是阻塞等待，父进程阻塞在wait那里等待子进程的死亡。</p><p><img src="https://img-blog.csdnimg.cn/ce1b1bad64a8402d80e7183361baf971.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>此时父进程和他的5个子进程都是正常运行的进程。</p><p><img src="https://img-blog.csdnimg.cn/625bd096b0914dabba05638fa833ae86.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>接下来，我们将5个子进程挨个杀掉。</p><p><img src="https://img-blog.csdnimg.cn/8acb6db782fd4d62a1d90a420db909ea.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>可以看到输出变化了，这是因为父进程通过wait阻塞等待，终于等到一个子进程死亡，他马上为子进程办理后事，轻装上阵，因此打印出了 I’m parent…</p><p>然而这里好像有点bug，wait若执行成功会返回子进程的PID给ret并打印，然而这里打印的都是父进程的PID，啥时候我再研究一下。</p><p><img src="https://img-blog.csdnimg.cn/6aa68294b5c844c7b94152375803d043.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_13,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="查看子进程退出状态"><a href="#查看子进程退出状态" class="headerlink" title="查看子进程退出状态"></a>查看子进程退出状态</h5><h5 id="示例代码（子进程自然死亡）"><a href="#示例代码（子进程自然死亡）" class="headerlink" title="示例代码（子进程自然死亡）"></a>示例代码（子进程自然死亡）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d died\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> st<span class="token punctuation">;</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child died peacefully, status:%d\n"</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 正常中止</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child was killed by signal %d\n"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 被信号中止</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>父进程执行了一句话之后就阻塞，等待子进程的退出。</p><p>5个子进程都正常退出，父进程接收到的退出状态也因此是0.</p><p><img src="https://img-blog.csdnimg.cn/9d8fe6d7f59b4a5eaf5e1a927c9e7f36.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="示例代码（利用9号信号杀死子进程）"><a href="#示例代码（利用9号信号杀死子进程）" class="headerlink" title="示例代码（利用9号信号杀死子进程）"></a>示例代码（利用9号信号杀死子进程）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d died\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> st<span class="token punctuation">;</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child died peacefully, status:%d\n"</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 正常中止</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child was killed by signal %d\n"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 被信号中止</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>刚开始和前面一样，父进程执行一句之后就阻塞。</p><p><img src="https://img-blog.csdnimg.cn/1d9b125f965e477b809d81dd8721ee7a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>现在，我们利用9号信号杀死子进程，动作利索点5个全干掉。</p><p><img src="https://img-blog.csdnimg.cn/55092bf5f4d147bbb88f51c6f1af1bff.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>可以看到，子进程的退出状态为9。</p><p><img src="https://img-blog.csdnimg.cn/828073056b7c4231804145ca3676b4d2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_15,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="关于wait的函数参数-int-wstatus"><a href="#关于wait的函数参数-int-wstatus" class="headerlink" title="关于wait的函数参数 int *wstatus"></a>关于wait的函数参数 <code>int *wstatus</code></h5><p>这是个传出参数，因此要传入指针，获取子进程的退出状态。</p><p><img src="https://img-blog.csdnimg.cn/d14117afeaa047829f655c2419304461.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h4 id="waitpid"><a href="#waitpid" class="headerlink" title="waitpid"></a>waitpid</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">pid_t</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>wstatus<span class="token punctuation">,</span> <span class="token keyword">int</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参数：</p><ul><li>指定的PID<ul><li>PID &gt; 0：指定谁就回收谁</li><li>PID = 0：回收在该进程组中的所有子进程</li><li>PID = -1：回收所以子进程（包括其他组），相当于wait（最常用）</li><li>PID &lt; -1：回收某个进程组的子进程，GID = ABS(PID)</li></ul></li><li>子进程退出状态</li><li>设置阻塞/非阻塞<ul><li>0：阻塞等待</li><li>WNOHANG：非阻塞，没有子进程退出就立马返回，不等待</li></ul></li></ul><p>返回值：</p><ul><li>&gt; 0：返回子进程PID</li><li>= 0：当options = WNOHANG，表示还有子进程活着</li><li>= -1：没有子进程了，或执行错误</li></ul><h5 id="示例代码（阻塞状态）"><a href="#示例代码（阻塞状态）" class="headerlink" title="示例代码（阻塞状态）"></a>示例代码（阻塞状态）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d died\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> st<span class="token punctuation">;</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token comment">//if(ret == 0) continue;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child died peacefully, status:%d\n"</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 正常中止</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child was killed by signal %d\n"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 被信号中止</span>                    <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>子进程一直在跑，父进程一直在阻塞等待，只输出了一句话。</p><p><img src="https://img-blog.csdnimg.cn/e42b7295de2745bca69de46776b03067.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="示例代码（非阻塞）"><a href="#示例代码（非阻塞）" class="headerlink" title="示例代码（非阻塞）"></a>示例代码（非阻塞）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d died\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> st<span class="token punctuation">;</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">// 没有子进程死亡，父进程继续跑</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child died peacefully, status:%d\n"</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 正常中止</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child was killed by signal %d\n"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 被信号中止</span>                    <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，在非阻塞状态下，父进程和子进程同时在运行。</p><p><img src="https://img-blog.csdnimg.cn/36759eb639bb40a9b8d30fc81ec4b8cc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_16,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>我们也可以利用信号去杀掉子进程。</p><p><img src="https://img-blog.csdnimg.cn/c7a5b59cb3df4bf5a12fd11845d50a3b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/c05a042367fd4eb98bd59eca870ea5e0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="7-进程间通信"><a href="#7-进程间通信" class="headerlink" title="7. 进程间通信"></a>7. 进程间通信</h2><p><code>IPC (Inter-Process Communication)</code></p><p><img src="https://img-blog.csdnimg.cn/d9c4ccf811784e2faf5ae9b06b949f2b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><code>进程间关系</code>：</p><ul><li>父与子</li><li>两个互不相干</li></ul><p>通信：互相<code>发送</code>数据，<code>接受</code>数据</p><p>按道理来说，两个互不相干的进程不能互相访问对方的资源。</p><p><strong>进程间<code>独立</code>，但<code>不孤立</code>。</strong></p><p>对于父子进程，读时共享，写时复制，实际上两个进程间的数据是没有关系的，只是某些部分一样罢了。</p><p>像我们使用通讯软件（如QQ，微信），两个人的进程运行在不同的主机上，两个人发送消息，实质上就是进程间通信。</p><p>再比如迅雷下载视频，可以边下载边播放，至少有两个进程（后面会讲到线程）。</p><p>我们下载了多少才能看多少，因此<code>下载进程</code>需要告诉<code>播放进程</code>现在可以看多少，互相告知现在的状态。</p><p>同步：协同合作，很安全，挨个有序进行。</p><p>异步：不安全，不等待，大家一起来，很散漫。</p><p>GDB希望完全控制另一个进程，并且可以共享其数据（如被调试进程有输出）。</p><h5 id="通信方式"><a href="#通信方式" class="headerlink" title="通信方式"></a>通信方式</h5><p><img src="https://img-blog.csdnimg.cn/e59b6ea57e96487da92ba5df74efdd4a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>加一个：消息队列，共享内存，信号量，<code>内存映射</code></p><h2 id="8-通信方式一：匿名管道"><a href="#8-通信方式一：匿名管道" class="headerlink" title="8. 通信方式一：匿名管道"></a>8. 通信方式一：匿名管道</h2><p>管道默认为匿名管道。</p><p>匿名管道是Unix最古老的进程间通信形式</p><p><img src="https://img-blog.csdnimg.cn/ae7b14ada5f14fe1a1a4f8a217433bf8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>|</code> 是管道符，其左右两边是两个进程，数据通过管道共享。</p><p>ls 原本会输出到 <code>stdout（默认是终端）</code>，</p><p>然而用了管道之后，ls将数据写到<code>管道写入端</code>（重定向stdout）。</p><p>wc原本会从<code>stdin（默认是终端）</code>读取数据，</p><p>然而用了管道之后，wc从<code>管道读取端</code>读取数据（重定向stdin）。</p><h4 id="8-1-管道的特点-（包括匿名和有名）"><a href="#8-1-管道的特点-（包括匿名和有名）" class="headerlink" title="8.1 管道的特点 （包括匿名和有名）"></a>8.1 管道的特点 （包括匿名和有名）</h4><p><img src="https://img-blog.csdnimg.cn/b91924fda7ca4dfb97531381e4f73f2f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>匿名管道用在有关系的进程间：父子进程</p><p>有名管道用在没有关系的进程间</p><p>消息：在网络通信中有许多协议，规定好了，发送一次数据会有个协议头，协议头大小固定，后面放传输的数据。另一个进程拿到消息后，可以按照格式解析内容。</p><p>但是管道没有消息的概念，里面都是字节流。可以从管道里想读多少读多少。</p><p><img src="https://img-blog.csdnimg.cn/ceaf516a11e44f9f9bf375f159b902ec.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="`抽象`"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>单工：遥控器发送数据给电视机，但是电视机不能发送消息给遥控器。</p><p>双工：打电话双方都可以互相发送消息。</p><p>半双工：同一时间数据只能向一方流动（对讲机，一个人说的时候另一个人只能听）。同一时间，只能一个进程给另一个进程发送数据。因此，管道中数据的流动是单向的，但是可以双向传输。</p><h4 id="8-2-为什么管道只能用于有关系的进程呢？"><a href="#8-2-为什么管道只能用于有关系的进程呢？" class="headerlink" title="8.2 为什么管道只能用于有关系的进程呢？"></a>8.2 为什么管道只能用于<code>有关系的进程</code>呢？</h4><p>本质上是因为父子进程<code>共享文件描述符</code>。</p><p><img src="https://img-blog.csdnimg.cn/7741df407f6d4af9ac43dc41cb09639f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="管道的数据结构"><a href="#管道的数据结构" class="headerlink" title="管道的数据结构"></a>管道的数据结构</h5><p><img src="https://img-blog.csdnimg.cn/706dc2a0eb7f4506b5dbfbcb86110ce9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>逻辑手段将线性队列设计成了环形队列，充分利用资源，避免浪费。</p><p>数据只能读取一次，并且之后会被覆盖。</p><h4 id="8-3-匿名管道的使用"><a href="#8-3-匿名管道的使用" class="headerlink" title="8.3 匿名管道的使用"></a>8.3 匿名管道的使用</h4><p><img src="https://img-blog.csdnimg.cn/c28b7716206d42aa81729dbf4d7c4adf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       pipe <span class="token operator">-</span> create pipeSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token comment">/* On Alpha, IA-64, MIPS, SuperH, and SPARC/SPARC64; see NOTES */</span>       <span class="token keyword">struct</span> <span class="token class-name">fd_pair</span> <span class="token punctuation">{</span>           <span class="token keyword">long</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span><span class="token punctuation">;</span>       <span class="token keyword">struct</span> <span class="token class-name">fd_pair</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">/* On all other architectures */</span>       <span class="token keyword">int</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> creates a pipe<span class="token punctuation">,</span> a unidirectional data channel that can be used <span class="token keyword">for</span> 【interprocess communication】<span class="token punctuation">.</span>         The array pipefd is used to 【<span class="token keyword">return</span> two file descriptors】 referring to the ends of the pipe<span class="token punctuation">.</span>         pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> refers to the 【read end】 of the pipe<span class="token punctuation">.</span>         pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> refers to the 【write end】 of the pipe<span class="token punctuation">.</span>          <span class="token function">Data</span> <span class="token punctuation">(</span>written to the write end of the pipe<span class="token punctuation">)</span> is buffered by the <span class="token function">kernel</span> <span class="token punctuation">(</span>until it is read from the read end of the pipe<span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token comment">// 这里是在说，写到管道的【写入端】的数据会被加载到缓冲区（管道实质上就是一个缓冲），直到它被一个进程从【读取端】读取。</span>    ETURN VALUE       On success<span class="token punctuation">,</span> 【zero】 is returned<span class="token punctuation">.</span>         On error<span class="token punctuation">,</span> 【<span class="token operator">-</span><span class="token number">1</span>】 is returned<span class="token punctuation">,</span> errno is set appropriately<span class="token punctuation">,</span> and pipefd is left unchanged<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="8-4-pipe"><a href="#8-4-pipe" class="headerlink" title="8.4 pipe()"></a>8.4 pipe()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参数：</p><ul><li>pipefd 是一个传出参数，我们把这个数组传进去，他会把管道两端的文件描述符传出来<ul><li>pipefd[0] -&gt; 读端</li><li>pipefd[1] -&gt; 写端</li></ul></li></ul><p>返回值：</p><ul><li>成功：返回0</li><li>失败： 返回 -1， 并设置 errorno</li></ul><p>这里又一次体现了Linux的设计哲学 — 万物皆文件。</p><h5 id="示例代码-3"><a href="#示例代码-3" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token comment">// 子进程给父进程发送数据</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 父进程从管道的【读取端】读取数据</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 爸爸从 pipefd[0] 读取数据</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: \n%s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 父亲回收子进程</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"wait"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 子进程从管道的【写入端】写数据</span>        <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, papa.\n"</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a862a2cac79847549b7e57aa3490a968.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="示例代码（read阻塞）"><a href="#示例代码（read阻塞）" class="headerlink" title="示例代码（read阻塞）"></a>示例代码（read阻塞）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token comment">// 子进程给父进程发送数据</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 父进程从管道的【读取端】读取数据</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 爸爸从 pipefd[0] 读取数据</span>        <span class="token comment">// read是阻塞的，只有等到有数据可读，read才会去读，不然一直呆在那儿</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: \n%s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 父亲回收子进程</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"wait"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 子进程先睡10秒钟</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 子进程从管道的【写入端】写数据</span>        <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, papa.\n"</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a8edc8ca3c224c4db13da3d899c326fc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>管道默认是阻塞的：</p><ul><li>如果管道中没有数据，read阻塞</li><li>如果管道中数据慢了，write阻塞</li></ul><h5 id="示例代码（不断收发数据）"><a href="#示例代码（不断收发数据）" class="headerlink" title="示例代码（不断收发数据）"></a>示例代码（不断收发数据）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token comment">// 子进程给父进程发送数据</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 父进程不断读取数据</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 爸爸从 pipefd[0] 读取数据</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 子进程不断发送数据</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, papa."</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>            <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/bdc56ce6d8874a03960b3023495af475.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="示例代码（父子互相收发消息）"><a href="#示例代码（父子互相收发消息）" class="headerlink" title="示例代码（父子互相收发消息）"></a>示例代码（父子互相收发消息）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 父进程不断读取数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 父进程不断发送数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, child."</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 子进程不断发送数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, papa."</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 子进程不断读取数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child receive: %s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/09f6fd6b7a02442cb7a504eae8fa3574.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>可以看到父子进程在互相发送，接收消息，你一条我一条，由于多线程的程序，管道没有关闭，某个线程可能会读到自己写入的数据，因此会出现child向child问好，parent向parent问好。</p><p>如果把sleep注释到，这个错误会尤为明显。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 父进程不断读取数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 父进程不断发送数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, I'm papa."</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token comment">//sleep(1);</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 子进程不断发送数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, I'm child."</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token comment">//sleep(1);</span>            <span class="token comment">// 子进程不断读取数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child receive: %s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/d5f596d547b84745a6a1175f8068d7b9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>可以看到我们显示的是papa..</p><p>有两个句号</p><p>或者我们再清晰一点</p><p>我们把消息后面改成parent，child，不加英文中的句号</p><p>可以看到变成了childt</p><p><img src="https://img-blog.csdnimg.cn/3cd7f1d6b76b406b91b7eee1499fb11c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>这个t是哪里来的呢？答案是我们没有刷新缓冲区，上一次写入的数据被覆盖，但是由于child比较短，后面还残留了老消息。</p><p>读完之后加一句这个就行了人，清除数据。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">bzero</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/db698d53067d4f18ade900f7830c8635.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="示例代码-关闭一端"><a href="#示例代码-关闭一端" class="headerlink" title="示例代码(关闭一端)"></a>示例代码(关闭一端)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 父进程关闭写端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 父进程专心读数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %sn"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 子进程关闭读端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 子进程专心写数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, I'm child\n"</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="8-5-匿名管道通信案例"><a href="#8-5-匿名管道通信案例" class="headerlink" title="8.5 匿名管道通信案例"></a>8.5 匿名管道通信案例</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ps aux | grep # 过滤出来和root有关的进程<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ls | wc -l  # 统计文件个数<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="示例代码（通过重定向文件描述符将ps-aux进程数据写入管道）"><a href="#示例代码（通过重定向文件描述符将ps-aux进程数据写入管道）" class="headerlink" title="示例代码（通过重定向文件描述符将ps aux进程数据写入管道）"></a>示例代码（通过重定向文件描述符将ps aux进程数据写入管道）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token comment">/*    实现 ps aux | grpe    子进程： ps aux，子进程结束后，将数据发送给父进程    父进程：获取数据，打印    pipe(), execlp()    但是子进程默认把数据默认把数据发送到子进程对应的终端，即 std_fileno    因此需要dup2复制文件描述符，将数据重定向到管道的写端*/</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 创建一个匿名管道</span>    <span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 关闭写端</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从管道中读取数据</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 回收子进程资源</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 关闭读端</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 文件描述符重定向 stdout_fileno -&gt; fd[1]，使得ps aux写入管道的写端</span>        <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 执行 ps aux</span>        <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execlp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/1cf0e31c4f3149eea003046cf8a4681e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>可见，我们实现了 ps aux 的功能。</p><p><img src="https://img-blog.csdnimg.cn/07e59462871b405da8a73de004d413cd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>之所以我们写的管道比系统多一个进程，是因为我们的程序正在运行（./app + ps aux），因此比直接执行ps aux多一个进程。</p><h5 id="示例代码（通过重定向文件描述符将ps-aux数据写到普通文件中）"><a href="#示例代码（通过重定向文件描述符将ps-aux数据写到普通文件中）" class="headerlink" title="示例代码（通过重定向文件描述符将ps aux数据写到普通文件中）"></a>示例代码（通过重定向文件描述符将ps aux数据写到普通文件中）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token comment">/*    实现 ps aux | grpe    子进程： ps aux，子进程结束后，将数据发送给父进程    父进程：获取数据，打印    pipe(), execlp()    但是子进程默认把数据默认把数据发送到子进程对应的终端，即 std_fileno    因此需要dup2复制文件描述符，将数据重定向到管道的写端*/</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 创建一个匿名管道</span>    <span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 关闭写端</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从管道中读取数据</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 回收子进程资源</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 关闭读端</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 文件描述符重定向 stdout_fileno -&gt; file</span>        <span class="token keyword">int</span> file <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"psaux.txt"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dup2</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"if you saw this it might succeed.\n"</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 执行 ps aux</span>        <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execlp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/5c41caa5f1504461afa2bb569d1cce49.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/92d60b432eda463da79f1363c6fb4e56.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h4 id="8-6-查看管道的缓冲大小"><a href="#8-6-查看管道的缓冲大小" class="headerlink" title="8.6 查看管道的缓冲大小"></a>8.6 查看管道的缓冲大小</h4><p>使用 <code>ulimit -a</code> 可以查看一些系统参数</p><p>其中 <code>pipe size</code> = 8 * 512byte = 4K</p><p>有八个块，每个块512字节</p><p>使用<code>-p</code>可以修改管道的大小</p><p><img src="https://img-blog.csdnimg.cn/9911da304b0e4731900921af96b741cf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_13,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="查看管道大小的函数"><a href="#查看管道大小的函数" class="headerlink" title="查看管道大小的函数"></a>查看管道大小的函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       fpathconf <span class="token operator">-</span> get configuration values <span class="token keyword">for</span> filesSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">long</span> <span class="token function">fpathconf</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">fpathconf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gets a value <span class="token keyword">for</span> the configuration option name <span class="token keyword">for</span> the open file descriptor fd<span class="token punctuation">.</span>    _PC_PIPE_BUF       The  maximum  number of bytes that can be written atomically to a pipe of FIFO<span class="token punctuation">.</span>  For <span class="token function">fpathconf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fd should refer to a pipe or FIFO<span class="token punctuation">.</span>  For <span class="token function">fpathconf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path should refer to a FIFO or a directory<span class="token punctuation">;</span> in the latter <span class="token keyword">case</span><span class="token punctuation">,</span> the returned value corresponds to FIFOs created in that directory<span class="token punctuation">.</span>  The corresponding macro is _POSIX_PIPE_BUF<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获取管道大小</span>    <span class="token keyword">long</span> size <span class="token operator">=</span> <span class="token function">fpathconf</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> _PC_PIPE_BUF<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"the size of pipe buffer: %ld\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，我们的管道缓冲区大小为 4096byte，即4K。</p><p><img src="https://img-blog.csdnimg.cn/9942724823064924ace25dcd1717321e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h4 id="8-7-管道读写特点-と-管道设置为非阻塞"><a href="#8-7-管道读写特点-と-管道设置为非阻塞" class="headerlink" title="8.7 管道读写特点 と 管道设置为非阻塞"></a>8.7 管道读写特点 と 管道设置为非阻塞</h4><h5 id="管道读写特点"><a href="#管道读写特点" class="headerlink" title="管道读写特点"></a>管道读写特点</h5><ol><li><p>所有指向<code>管道写端</code>的文件描述符都<code>关闭</code>（管道写端引用计数=0），若管道中数据若已被读完，</p><p>有进程从<code>管道读端</code>读数据时，某个进程read会<code>返回0</code>，就像读到文件末尾一样。</p></li><li><p>所有指向<code>管道写端</code>的文件描述符没有关闭（管道写端引用计数&gt;0）,而持有管道写端的进程没有往管道中写数据，若管道中数据若已被读完，某个进程read后会<code>阻塞</code>，直到管道中有数据可以读了才读取数据并返回。</p></li><li><p>所有指向<code>管道读端</code>的文件描述符都<code>关闭</code>（管道读端引用计数=0），若有进程向管道中写数据，</p><p>那么该进程会受到一个<code>信号SIGPIPE</code>，通常导致进程<code>异常终止</code>。</p></li></ol><p>4.所有指向<code>管道读端</code>的文件描述符没有关闭（管道读端引用计数&gt;0）,而持有管道读端的进程没有从管道中读数据，而持有<code>管道写端</code>的进程往管道中写数据，那么在管道写满后再次write会<code>阻塞</code>，直到数据被读出。</p><p>总结：</p><ul><li>read<ul><li>管道中有数据，read返回实际读到的字节数。</li><li>管道中无数据<ul><li>写端被全部关闭，read返回0（相当于读到文件末尾）.</li><li>写端没有全部关闭，但是没人写数据，read<code>阻塞等待</code></li></ul></li></ul></li><li>write<ul><li>读端全部关闭，进程收到信号<code>SIGPIPE</code>，异常终止</li><li>读端没有全部关闭<ul><li>管道已满，write<code>阻塞</code></li><li>管道没满，write写入数据，返回实际写入字节数</li></ul></li></ul></li></ul><h5 id="设置管道非阻塞"><a href="#设置管道非阻塞" class="headerlink" title="设置管道非阻塞"></a>设置管道非阻塞</h5><p>原本<code>子进程</code>写完数据后父进程马上打印，然后<code>子进程</code>sleep五秒后继续写。</p><p>这样的话<code>父进程</code>也要阻塞5秒才能读到下一跳数据并打印。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 父进程关闭写端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 父进程专心读数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 子进程关闭读端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 子进程专心写数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, I'm child\n"</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/bc7f5a6ab8994e04986ae647965c9407.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>但是我们可以利用<code>fcntl</code>函数设置</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> File status flags       Each  open file description has certain associated 【status flags】<span class="token punctuation">,</span> 【initialized by <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>】 and possibly 【modified by <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>】<span class="token punctuation">.</span>  Duplicated file <span class="token function">descriptors</span> <span class="token punctuation">(</span>made with <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>F_DUPFD<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> etc<span class="token punctuation">.</span><span class="token punctuation">)</span> refer to the same open file description<span class="token punctuation">,</span> and thus share the same file status flags<span class="token punctuation">.</span>       The file status flags and their semantics are described in <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token function">F_GETFL</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>              <span class="token function">Return</span> <span class="token punctuation">(</span>as the function result<span class="token punctuation">)</span> the file access mode and the file status flags<span class="token punctuation">;</span> arg is ignored<span class="token punctuation">.</span>       <span class="token function">F_SETFL</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>              Set  the file status flags to the value specified by arg<span class="token punctuation">.</span>  File access <span class="token function">mode</span> <span class="token punctuation">(</span>O_RDONLY<span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span> and file creation <span class="token function">flags</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> O_CREAT<span class="token punctuation">,</span> O_EXCL<span class="token punctuation">,</span> O_NOCTTY<span class="token punctuation">,</span> O_TRUNC<span class="token punctuation">)</span> in arg are ignored<span class="token punctuation">.</span>  On Linux<span class="token punctuation">,</span> this command can change only the O_APPEND<span class="token punctuation">,</span> O_ASYNC<span class="token punctuation">,</span> O_DIRECT<span class="token punctuation">,</span> O_NOATIME<span class="token punctuation">,</span> and 【O_NONBLOCK flags】<span class="token punctuation">.</span>  It is not possible to change the O_DSYNC and O_SYNC flags<span class="token punctuation">;</span> see BUGS<span class="token punctuation">,</span> below<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="设置flag"><a href="#设置flag" class="headerlink" title="设置flag"></a>设置flag</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>flags <span class="token operator">|=</span> O_NONBLOCK<span class="token punctuation">;</span><span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="示例代码-4"><a href="#示例代码-4" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 父进程关闭写端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>        flags <span class="token operator">|=</span> O_NONBLOCK<span class="token punctuation">;</span>        <span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 父进程专心读数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"len = %d\n"</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 子进程关闭读端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 子进程专心写数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, I'm child"</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在父进程中设置为非阻塞后就可以看到打印如一泓海水杯中泄。</p><p><img src="https://img-blog.csdnimg.cn/90c6ad09efcb48a58dbb9bb3e34b0c24.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>可以看到，在阻塞等待时，父进程读到了17个字节，因此打印17</p><p>然后非阻塞等待时，绝大多时间都没读到数据，因此打印-1</p><ul><li>读到数据</li></ul><p><img src="https://img-blog.csdnimg.cn/31c0a7ab78de464dba5412ccc6b19333.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ul><li>没读到数据</li><li><img src="https://img-blog.csdnimg.cn/615d0d7881884133bc0d95f1549f1bbd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></li></ul><p>让父进程睡一会儿可以看出来区别</p><p><img src="https://img-blog.csdnimg.cn/f826ec18c1a14c3696be50972a55913c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_16,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="9-通信方式二：有名管道"><a href="#9-通信方式二：有名管道" class="headerlink" title="9. 通信方式二：有名管道"></a>9. 通信方式二：有名管道</h2><p><img src="https://img-blog.csdnimg.cn/dd0cbb48df5e4d83b0f9050b63eff524.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/3440915b43034384b23c15127246bcab.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>FIFO有文件实体，但是里面没有内容，内容存放在内核中的缓冲区。</p><p>匿名管道没有实体，没有名字，只能用于有关系的进程间通信。</p><p><img src="https://img-blog.csdnimg.cn/2fdccd68910f4d0da347cdaf05338b7c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h4 id="9-1-创建fifo"><a href="#9-1-创建fifo" class="headerlink" title="9.1 创建fifo"></a>9.1 创建fifo</h4><h5 id="方式一：-shell命令"><a href="#方式一：-shell命令" class="headerlink" title="方式一： shell命令"></a>方式一： shell命令</h5><p><img src="https://img-blog.csdnimg.cn/322109072c6d4417a15d3499ff6fb7d9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>在终端输入 <code>mkfifo 文件名</code></p><p><img src="https://img-blog.csdnimg.cn/80fa4d69337d4a2a9e4caaef614277d1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>当我们想往里面写点东西，会发现阻塞了。</p><p><img src="https://img-blog.csdnimg.cn/7be3b259863a4df192666a4578f32cbd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">这个文件里是空的，因为都保存在内核中的缓冲区中。</p><p>进程一旦结束，数据全部清空。</p><h5 id="方式二：-函数"><a href="#方式二：-函数" class="headerlink" title="方式二： 函数"></a>方式二： 函数</h5><p><img src="https://img-blog.csdnimg.cn/ad04db3e653d414c8e45dc63c980fe01.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">DESCRIPTION       <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  makes  a FIFO special file with name pathname<span class="token punctuation">.</span>  mode specifies the FIFO's permissions<span class="token punctuation">.</span>  It is modified by the process's umask in the usual way<span class="token operator">:</span> the permissions of the created file <span class="token function">are</span> <span class="token punctuation">(</span>【mode <span class="token operator">&amp;</span> <span class="token operator">~</span>umask】<span class="token punctuation">)</span><span class="token punctuation">.</span>       A FIFO special file is similar to a pipe<span class="token punctuation">,</span> except that it is created in a different way<span class="token punctuation">.</span>  Instead of being an anonymous communications channel<span class="token punctuation">,</span> a FIFO special file is entered into the filesystem by calling <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       Once  you have created a FIFO special file in this way<span class="token punctuation">,</span> any process can open it <span class="token keyword">for</span> reading or writing<span class="token punctuation">,</span> in the same way as an ordinary file<span class="token punctuation">.</span>  However<span class="token punctuation">,</span> it has to be open at both ends simultaneously before you can proceed to <span class="token keyword">do</span> any input or output  operationson it<span class="token punctuation">.</span>  Opening a FIFO <span class="token keyword">for</span> reading normally blocks until some other process opens the same FIFO <span class="token keyword">for</span> writing<span class="token punctuation">,</span> and vice versa<span class="token punctuation">.</span>  See <span class="token function">fifo</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">for</span> nonblocking handling of FIFO special files<span class="token punctuation">.</span>           RETURN VALUE       On  success  <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  and  <span class="token function">mkfifoat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token number">0.</span>  In the <span class="token keyword">case</span> of an error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is <span class="token function">returned</span> <span class="token punctuation">(</span>in which <span class="token keyword">case</span><span class="token punctuation">,</span> errno is set appropriately<span class="token punctuation">)</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数：</p><ul><li>pathname：文件路径</li><li>mode：文件权限，和open中的一样，会和掩码做按位与</li></ul><h5 id="示例代码-5"><a href="#示例代码-5" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span><span class="token comment">// access</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 先判断管道文件是否存在，若不存在，创建</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道不存在，正在为您创建...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道已存在\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="9-2-通信案例"><a href="#9-2-通信案例" class="headerlink" title="9.2 通信案例"></a>9.2 通信案例</h4><h5 id="写端代码"><a href="#写端代码" class="headerlink" title="写端代码"></a>写端代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 先判断管道文件是否存在，若不存在，创建</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道不存在，正在为您创建...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 2. 创建管道</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3.打开管道, 以 write-only 的权限打开</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 4.写数据</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"hello, %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write data: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="读端代码"><a href="#读端代码" class="headerlink" title="读端代码"></a>读端代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1.直接打开管道</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>       <span class="token punctuation">{</span>           <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>       <span class="token comment">// 2.读数据</span>       <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>       <span class="token punctuation">{</span>           <span class="token comment">// read返回读到的字节数</span>           <span class="token comment">// read失败返回 -1</span>           <span class="token comment">// 写端关闭，管道中数据读完，返回0</span>           <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写端断开连接\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"receive buf: %d\n"</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>只运行write 或者 read，他们都会阻塞，因为另一端没有打开。</p><p>两端都打开，进程间开始通信。</p><p><img src="https://img-blog.csdnimg.cn/49b8002fe9734282bdb298d4b324c3aa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><code>提前结束写端</code>，读端会读取到0个字节，我们的 if 判断了读到 0byte 就 exit。</p><p><img src="https://img-blog.csdnimg.cn/2a888cc3963c4ded84fcc855cbaf02b1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>而<code>提前结束读端</code>，会导致读端进程收到一个异常信号<code>SIGPIPE</code>,直接终止进程，否则有可能导致管道破裂。</p><p><img src="https://img-blog.csdnimg.cn/5d9f244162504da7b211d9e659a9f776.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h4 id="9-3-有名管道注意事项"><a href="#9-3-有名管道注意事项" class="headerlink" title="9.3 有名管道注意事项"></a>9.3 有名管道注意事项</h4><ol><li>只有一个进程通过 <code>read-only</code> 打开管道会<code>阻塞</code>，直到另一个进程以 write-only或read&amp;rwite 打开管道</li><li>只有一个进程通过 <code>write-only</code> 打开管道会<code>阻塞</code>，直到灵魂一个进程以 <code>read-only</code> 打开管道</li></ol><h4 id="9-4-简易版聊天功能"><a href="#9-4-简易版聊天功能" class="headerlink" title="9.4 简易版聊天功能"></a>9.4 简易版聊天功能</h4><p>阻塞行为，只能发一条收一条。</p><h5 id="A"><a href="#A" class="headerlink" title="A"></a>A</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1.创建管道</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2.以 write-only 的权限打开管道pipeAtoB</span>    <span class="token keyword">int</span> fdw <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB is opened, right: write-only,pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.以 read-only 的权限打开管道pipeBtoA</span>    <span class="token keyword">int</span> fdr <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA is opened, right: read-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.开始通信</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 写数据</span>        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fdw<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 读数据</span>        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fdr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">// 读取失败/对面关闭管道/数据读完/读取失败</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 关闭文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdw<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="B"><a href="#B" class="headerlink" title="B"></a>B</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1.创建管道</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2.以 read-only 的权限打开管道pipeAtoB</span>    <span class="token keyword">int</span> fdr <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB is opened, right: read-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.以 write-only 的权限打开管道pipeBtoA</span>    <span class="token keyword">int</span> fdw <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA is opened, right: write-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.开始通信</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 读数据</span>        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fdr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">// 读取失败/对面关闭管道/数据读完/读取失败</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 写数据</span>        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fdw<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 关闭文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdw<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/00861d7306bd486b93971bf43f2897b2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>非阻塞行为，利用父子进程实现并发。</p><h5 id="A-1"><a href="#A-1" class="headerlink" title="A"></a>A</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1.创建管道</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2.以 write-only 的权限打开管道pipeAtoB</span>    <span class="token keyword">int</span> fdw <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB is opened, right: write-only,pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.以 read-only 的权限打开管道pipeBtoA</span>    <span class="token keyword">int</span> fdr <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA is opened, right: read-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.开始通信</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 写数据</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fdw<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 读数据</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fdr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">// 读取失败/对面关闭管道/数据读完/读取失败</span>            <span class="token punctuation">{</span>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"对方来信：%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 关闭文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdw<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="B-1"><a href="#B-1" class="headerlink" title="B"></a>B</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1.创建管道</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2.以 read-only 的权限打开管道pipeAtoB</span>    <span class="token keyword">int</span> fdr <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB is opened, right: read-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.以 write-only 的权限打开管道pipeBtoA</span>    <span class="token keyword">int</span> fdw <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA is opened, right: write-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.开始通信</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>             <span class="token comment">// 读数据</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fdr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">// 读取失败/对面关闭管道/数据读完/读取失败</span>            <span class="token punctuation">{</span>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"对方来信：%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 写数据</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fdw<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">// 5. 关闭文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdw<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/0aca5f32506d4e8d99759a8aee8e04af.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>大体可以运行，但是在键入文字的时候，若删除一些会有BUG，如删除不全和多删除一些文字等。</p><h2 id="10-通信方式三：内存映射"><a href="#10-通信方式三：内存映射" class="headerlink" title="10. 通信方式三：内存映射"></a>10. 通信方式三：内存映射</h2><p><img src="https://img-blog.csdnimg.cn/644f97952a264097958cfb831c67d28a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>效率较高，直接操作内存。</p><p>会将磁盘上的文件内容映射到<code>动态库加载的区域</code>。</p><p>内存里保存着磁盘上文件里的数据，可以设置映射哪一部分。</p><p>一旦修改了内存中的数据，修改内容会自动同步到文件中。</p><p>两个进程访问同一块内存，这块内存指向磁盘中的一片空间，这两个进程都可以访问这个文件中的数据。</p><p>可以实现父子进程间的通信，也可以实现无关系的进程间的通信。</p><h4 id="10-1-内存映射相关system-call"><a href="#10-1-内存映射相关system-call" class="headerlink" title="10.1 内存映射相关system call"></a>10.1 内存映射相关system call</h4><p><img src="https://img-blog.csdnimg.cn/42e85c5c0519448c9fad416c26f7a2f9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="10-2-mmap"><a href="#10-2-mmap" class="headerlink" title="10.2 mmap"></a>10.2 mmap</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>mmap</code>将统一个文件或设备的数据映射到当前正在运行的进程中。</p><p>参数：</p><ul><li><code>addr</code>指定新映射的<code>起始地址</code>，指定<code>NULL</code>则由内核来分配起始地址。</li><li><code>length</code>指定新映射的数据的长度（must &gt; 0）。建议使用文件的长度，但是最少会分配页的整数倍。<ul><li>获取文件长度： stat，lseek</li></ul></li><li><code>prot</code>：申请的内存映射区的操作权限（不能和打开的文件的权限冲突）。</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">PROT_EXEC  Pages may be executed<span class="token punctuation">.</span>    PROT_READ  Pages may be read<span class="token punctuation">.</span>    PROT_WRITE Pages may be written<span class="token punctuation">.</span>    PROT_NONE  Pages may not be accessed<span class="token punctuation">.</span>一般使用读权限 PROT_READ 或读写权限 PROT_READ <span class="token operator">|</span> PROT_WRITE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>flags</code>：一个进程更新该映射内存后，何时被其他进程（同样访问这块映射）可见。</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">MAP_SHARED    映射区的数据会自动和磁盘文件同步。进程间通信时必须设置这个选项。MAP_PRIVATE不同步，内存映射区的数据改变了，不会影响磁盘文件，会重新创建一个新的文件，修改新的文件。和fork写时复制很像。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>fd</code>：要映射的文件的文件描述符，通过open的得到，文件大小必须大于0。open指定的权限不能和prot参数冲突。prot的权限 &lt;= open的权限<ul><li>prot: PROT_READ        open: read-only / read&amp;write</li><li>prot: PROT_READ | PROT_WRITE        open: read&amp;write</li></ul></li><li><code>offset</code>：偏移量，必须是4K的整数倍。0表示不偏移，即从文件的开头。</li></ul><p>返回值：</p><ul><li>新内存的起始地址<ul><li>调用成功，返回指向映射区域的指针</li><li>调用失败，返回一个宏<code>MAP_FAILED</code>，即<code>(VOID *)-1</code></li></ul></li></ul><h4 id="munmap"><a href="#munmap" class="headerlink" title="munmap"></a>munmap</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>释放内存映射</p><p>参数：</p><ul><li><code>addr</code>：要释放的内存首地址</li><li><code>length</code>：要释放的内存大小，要和<code>mmap</code>中的<code>length</code>参数保持一致</li></ul><h5 id="如何使用内存映射进行进程间通信？"><a href="#如何使用内存映射进行进程间通信？" class="headerlink" title="如何使用内存映射进行进程间通信？"></a>如何使用内存映射进行进程间通信？</h5><ul><li>有关系的进程<ul><li>准备一个大小不为0的内存映射区</li><li>唯一的最大父进程通过磁盘文件创建内存映射区</li><li>有了内存映射区后，fork子进程</li><li>父子进程共享内存映射区</li></ul></li><li>没有关系的进程<ul><li>准备一个大小不为0的磁盘文件</li><li>进程1通过磁盘文件创建内存映射区，得到一个指针</li><li>进程2通过磁盘文件创建内存映射区，得到一个指针</li><li>使用内存映射区通信</li></ul></li></ul><p>内存映射区是默认<code>非阻塞</code>的！</p><p>记得做映射的磁盘文件一定不能为空!!!</p><h5 id="示例代码-6"><a href="#示例代码-6" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 打开一个磁盘文件</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"share.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 获取文件大小</span>    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// fd, offset, where</span>    <span class="token comment">// 3. 创建内存映射区</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 4. 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 读取内存</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 操作内存</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">,</span> <span class="token string">"hello, papa!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 关闭内存映射区</span>    <span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是我在一个字符数组中写数据，把这个字符数组传给strcpy，好像又出现问题了，不知道为什么</p><h4 id="10-4-内存映射的注意事项"><a href="#10-4-内存映射的注意事项" class="headerlink" title="10.4 内存映射的注意事项"></a>10.4 内存映射的注意事项</h4><p><img src="https://img-blog.csdnimg.cn/9e38468c9f10413c9f8ef8ee3db5c025.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ol><li><p>如果对映射到的这块内存做 ptr ++ 操作，可以是可以，但是释放的时候要传入内存的长度，可能导致问题。要么保存最原始的地址，释放这块内存。</p></li><li><p>如果文件只是 read-only，我们在内存映射的时候确实 read + write，访问会被拒绝。因此，PROT权限 &lt;= open权限</p></li></ol><p><img src="https://img-blog.csdnimg.cn/54839c3878294d1c93966e7aa8f6581a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ol start="3"><li><p>偏移量必须是<code>4K</code>的整数倍?<img src="https://img-blog.csdnimg.cn/896f46e3e02d4be9bcbb2023d53f950d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p></li><li><p>我们映射的内存大小为0，也会失败。</p><p><img src="https://img-blog.csdnimg.cn/878c8dcec8b64fc5b4d3f8957c4b9310.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p></li><li><p>可以通过O_CREAT来新建一个文件，但是大小不能为0</p><p>这样子直接创建大小其实是0</p><p><img src="https://img-blog.csdnimg.cn/902725a9e4f84f5e835ad18ef3adcccc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p></li></ol><p><img src="https://img-blog.csdnimg.cn/b8ee0b0c600c47fc8b4471e525ab8979.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>我们可以用<code>lseek</code>或者<code>truncate</code>函数来拓展文件长度。</p><p><img src="https://img-blog.csdnimg.cn/6f1b392675ab4e0982c15d2ffb2a55db.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_15,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/90e9d42d616747e9837cc5cf670bbab4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>但是这样还是失败了，我们需要执行一次写操作才能真正拓展长度。</p><p><img src="https://img-blog.csdnimg.cn/e76ee680ff1e4e13976f5c3c75cdfe49.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/98542b65f4e640648400ffbc4ec32718.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>999 = 998 + 1</p><ol start="6"><li><p>我们映射完就关闭文件描述符，并不会产生任何影响。</p><p>因为这块内存映射区仍然存在，munmap后才会消失。</p></li></ol><p><img src="https://img-blog.csdnimg.cn/352dedfe16aa4cf4bb679c124a2799df.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ol start="7"><li>void *ptr = mmap(NULL, 4k整数倍….)，如果越界访问ptr, 会操作野内存，造成段错误。</li></ol><h5 id="10-5-内存映射实现文件拷贝"><a href="#10-5-内存映射实现文件拷贝" class="headerlink" title="10.5 内存映射实现文件拷贝"></a>10.5 内存映射实现文件拷贝</h5><h5 id="示例代码-7"><a href="#示例代码-7" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 打开源文件</span>    <span class="token keyword">int</span> fdSrc <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"src.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdSrc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open_src"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 获取源文件大小</span>    <span class="token keyword">int</span> srcSize <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fdSrc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>srcSize <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"lseek"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 创建新文件</span>    <span class="token keyword">int</span> fdDest <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"dest.txt"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdDest <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open_dest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3. 扩展新文件</span>    <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token string">"dest.txt"</span><span class="token punctuation">,</span> srcSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>fdDest<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 分别做内存映射</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptrSrc <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> srcSize <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fdSrc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ptrSrc <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap_src"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptrDest <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> srcSize <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fdDest<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ptrDest <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap_dest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">// 5. 内存拷贝</span>    <span class="token comment">/*    这个不是内存拷贝，这个是文件IO里学的文件拷贝    char buf[1024] = {0};    int len = 0;    while(len = (read(fdSrc, buf, sizeof(buf))) &gt; 0)        write(fdDest, buf, len);    */</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>ptrDest<span class="token punctuation">,</span> ptrSrc<span class="token punctuation">,</span> srcSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 6. 释放资源</span>    <span class="token function">munmap</span><span class="token punctuation">(</span>ptrSrc<span class="token punctuation">,</span> srcSize <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">munmap</span><span class="token punctuation">(</span>ptrDest<span class="token punctuation">,</span> srcSize <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdDest<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 由于依赖关系也要注意先后释放顺序，虽然我没听懂</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>虽然内存映射可以用来做文件拷贝，但一般不这么干。</p><p>假如文件有1个G，内存根本就放不下啊。</p><p><img src="https://img-blog.csdnimg.cn/254ec5483efd450782fa0e20ee09c1cf.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/2b2bb991c07643f481a0aab82c08d0f2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/9779c2c3262d438881652ce29636f76f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="10-6-匿名映射"><a href="#10-6-匿名映射" class="headerlink" title="10.6 匿名映射"></a>10.6 匿名映射</h5><p>只能用于有关系的父子间通信。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">MAP_ANONYMOUSThe  mapping is not backed by any file<span class="token punctuation">;</span> its contents are initialized to zero<span class="token punctuation">.</span>  The 【fd argument is ignored】<span class="token punctuation">;</span> however<span class="token punctuation">,</span> some implementations require fd to be 【<span class="token operator">-</span><span class="token number">1</span>】 <span class="token keyword">if</span> <span class="token function">MAP_ANONYMOUS</span> <span class="token punctuation">(</span>or MAP_ANON<span class="token punctuation">)</span> is specified<span class="token punctuation">,</span> and portable applications should ensure this<span class="token punctuation">.</span>  The 【offset】 argument should be 【zero】<span class="token punctuation">.</span>  The use of MAP_ANONYMOUS in 【conjunction with MAP_SHARED】 is supported on Linux only since kernel <span class="token number">2.4</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="示例代码-8"><a href="#示例代码-8" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建匿名内存映射区</span>    <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> PROT_WRITE <span class="token operator">|</span> PROT_READ<span class="token punctuation">,</span> MAP_SHARED <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// fd:-1, offset:0</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 父子间碱性通信</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">,</span> <span class="token string">"hello, son!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 内存映射是非阻塞的，因此子进程要在父进程结束后执行</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"son received: %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"munmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a8dcf10c4c7c4fc5b22641b80ff84163.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>呃，父进程给子进程发消息的话，直接共享变量不就好了么？</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建匿名内存映射区</span>    <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> PROT_WRITE <span class="token operator">|</span> PROT_READ<span class="token punctuation">,</span> MAP_SHARED <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// fd:-1, offset:0</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 父子间间通信</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">,</span> <span class="token string">"hello, son!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 内存映射是非阻塞的，因此子进程要在父进程结束后执行</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"son received: %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"munmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/d5386600f52046c29a89539530c6fd6c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="9-信号"><a href="#9-信号" class="headerlink" title="9. 信号"></a>9. 信号</h2><h4 id="9-0-信号概述"><a href="#9-0-信号概述" class="headerlink" title="9.0 信号概述"></a>9.0 信号概述</h4><p>Linux操作系统刚诞生的时候就有信号这个机制了。</p><p>主要作用：通知进程发生了某些事情。</p><p>中断</p><ul><li><p>硬件中断</p></li><li><p>软件中断</p></li></ul><p>在家里打游戏的时候，外卖来了会给你打个电话，这就是个信号。</p><p>于是你暂停游戏，去拿外卖。</p><p>同步：一个患者一个一个进去看医生（隐私可以得到保障）</p><p>异步：好几个人同时进去找医生（杜博士windows课里面讲的游戏循环SEEKMESSAGE也是实现了异步，并不是傻傻地等着消息过来，而是不管有没有消息都立即返回，去做一些别的事情，使得游戏效果相较于GETMESSAGE看起来不卡）</p><p>发往进程的内核由内核产生。</p><p>前台进程：占用终端，我们无法再输入命令。我们的 ctrl + c 就是发送了一个中断信号。</p><p>后台进程：再后台运行，再命令行中仍然可以输入命令，执行命令。</p><p>发送信号的几种方式：</p><ul><li>前台键盘事件，如 CTRL + C</li><li>硬件异常，如执行异常指令（除以0， 访问非法内存）</li><li>系统状态变化（定时器到期，CPU执行超限，子进程结束发送SIGCHILD）</li><li>用户执行系统调用</li></ul><p>信号虽然使用简单，但是内部实现非常负责，得去看Linux源代码。</p><p><img src="https://img-blog.csdnimg.cn/9480e135fd9b4af68740cae85dedcfff.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/9e98f0b325ac4f98bb7331e94d2ec5c6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/3391d17f47ab4bd1b5c40dcc34e231e5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="信号一览"><a href="#信号一览" class="headerlink" title="信号一览"></a>信号一览</h5><p>执行 <code>kill -l</code> 可以查看所有的信号。</p><p>共62个信号。</p><p>1-31是常规信号，每个操作系统都有的，MAC操作系统也有；</p><p>32.33没有这俩信号。</p><p>34-64是预定义号的信号，目前没有使用，将来可能使用（用不到）。</p><p><img src="https://img-blog.csdnimg.cn/102998f2e0aa4f0686103e45d008857d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/107ee6a6e6a9490fa0b5d820a8cc783f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/62d840a8bb0741f69a6af53e59ac76b7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="/2022/04/12/Linux%E5%A4%9A%E8%BF%9B%E7%A8%8B/Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220419214722081.png" alt="image-20220419214722081"></p><p><img src="https://img-blog.csdnimg.cn/80107cebde70426bb328f8a8c21a9c37.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>不同的架构信号的定义还不一样。</p><p><img src="https://img-blog.csdnimg.cn/1e7e381c239c4110ad155732bd3c0482.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="信号默认行为"><a href="#信号默认行为" class="headerlink" title="信号默认行为"></a>信号默认行为</h5><p><img src="https://img-blog.csdnimg.cn/5c151174aba44802a4236617f550d6d6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><code>父进程</code>接收到<code>SIGCHILD</code>（子进程结束，暂停等），父进程<code>默认忽略</code>IGN。</p><p>Core文件是为了去<code>调试程序</code>。</p><p>The signals <code>SIGKILL</code> and <code>SIGSTOP</code> cannot be caught, blocked, or ignored.</p><h5 id="进程状态"><a href="#进程状态" class="headerlink" title="进程状态"></a>进程状态</h5><ul><li>产生</li><li>未决：信号没有到达进程，还没有处理</li><li>递达：送达进程</li></ul><h4 id="9-1-kill-とraise-と-abort函数"><a href="#9-1-kill-とraise-と-abort函数" class="headerlink" title="9.1. kill とraise と abort函数"></a>9.1. kill とraise と abort函数</h4><h5 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">kill</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>作用：send any signal to any process group or process</p><p>​            给任何进程，任何进程组发送任何信号</p><p>参数：</p><ul><li>pid <ul><li>pid &gt; 0：把信号发送给进程号为pid的进程</li><li>pid = 0：把信号发送给该 calling process 的进程组中的所有进程</li><li>pid = -1：把信号发给所有该进程有权限发送信号的进程，process 1 ( init ) 除外</li><li>pid &lt; -1：发送给进程组 gid = -pid 的所有进程</li></ul></li><li>sig：0表示不发送任何信号。可以是数值也可以是宏值。</li></ul><p>杀死父亲： <code>kill (getppid(), 9);</code></p><p>杀死自己： <code>kill (geipid(), 9);</code></p><h5 id="raise"><a href="#raise" class="headerlink" title="raise"></a>raise</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">raise</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>作用：给自己发送一个信号</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">The <span class="token function">raise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function sends a signal to the 【calling process or thread】<span class="token punctuation">.</span>      In a 【single<span class="token operator">-</span>threaded program】 it is equivalent to<span class="token function">kill</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>In a 【multithreaded program】 it is equivalent to<span class="token function">pthread_kill</span><span class="token punctuation">(</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>If the signal causes a handler to be called<span class="token punctuation">,</span> <span class="token function">raise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> will <span class="token keyword">return</span> only after the signal handler has returned<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="abort"><a href="#abort" class="headerlink" title="abort"></a>abort</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">void</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>作用：发送<code>SIGABORT</code>给当前进程，杀死自己。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">The <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function first unblocks the SIGABRT signal<span class="token punctuation">,</span> and then raises that signal <span class="token keyword">for</span> the calling <span class="token function">process</span> <span class="token punctuation">(</span>as though <span class="token function">raise</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> was called<span class="token punctuation">)</span><span class="token punctuation">.</span>  This results in the abnormal termination of the process unless the SIGABRT signal is caught and the signal handler does not <span class="token keyword">return</span> <span class="token punctuation">(</span>see <span class="token function">longjmp</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>If the SIGABRT signal is ignored<span class="token punctuation">,</span> or caught by a handler that returns<span class="token punctuation">,</span> the <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function will still terminate the process<span class="token punctuation">.</span>  It does this by restoring the <span class="token keyword">default</span> disposition <span class="token keyword">for</span> SIGABRT and then raising the signal <span class="token keyword">for</span> a second time<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>相当于 <code>kill (getpid(), SIGABRT)</code>。 </p><h5 id="示例代码-9"><a href="#示例代码-9" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">```#### <span class="token number">9.2</span> alarm 函数系统状态变化时，如`alarm定时器到期`会因此`SIGALARM`信号。该函数`不阻塞`。```c<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c">DESCRIPTION<span class="token function">alarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> arranges <span class="token keyword">for</span> a SIGALRM signal to be delivered to the calling process in seconds seconds<span class="token punctuation">.</span>If seconds is zero<span class="token punctuation">,</span> any pending alarm is canceled<span class="token punctuation">.</span>In any event any 【previously】 set <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is 【canceled】<span class="token punctuation">.</span>        # 前面设置的alarm都会失效    RETURN VALUE       <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  returns  the  number of seconds remaining until any previously scheduled alarm was due to be delivered<span class="token punctuation">,</span>    or 【zero】 <span class="token keyword">if</span> there was no previously scheduled alarm<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：set an alarm clock for delivery of a signal</p><p>​            设置定时器（闹钟，定时炸弹）。调用后开始倒计时，当倒计时为0时，函数给当前进程发送一个信号SIGALARM。</p><p>参数：</p><ul><li>seconds：倒计时的时长，单位：秒。<ul><li>seconds = 0：定时器无效，不进行倒计时。或者取消一个定时器，通过<code>alarm(0)</code>。</li></ul></li></ul><p>返回值：</p><ul><li>前面有定时器，返回之前的定时器剩余的倒计时时间</li><li>前面没有定时器，返回 0</li></ul><p><code>SIGALARM</code>：默认终止当前进程，每个进程都<code>有且只有</code>唯一的一个定时器。</p><p>alarm(10)；</p><p>after 1 second</p><p>alarm(5);    上面那个10秒的定时器会失效</p><h5 id="示例代码-10"><a href="#示例代码-10" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> seconds <span class="token operator">=</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"seconds = %d\n"</span><span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 2</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    seconds <span class="token operator">=</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不阻塞</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"seconds = %d\n"</span><span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>刚开始打印0，因为是第一次设置时钟。</p><p>第二次马上打印3，由于我们第一次设置了5s，睡了2s，因此第二次设置闹钟返回5-2=3。这是阻塞的。</p><p>这个死循环也不会一直循环，因为倒计时结束后SIGALRM就结束了这个进程。</p><p><img src="https://img-blog.csdnimg.cn/1bd63075398043ac8aa236c2fa5124d1.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="1秒中之内电脑能执行多少次"><a href="#1秒中之内电脑能执行多少次" class="headerlink" title="1秒中之内电脑能执行多少次"></a>1秒中之内电脑能执行多少次</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> cnt <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们终端也有缓冲区，往终端输出也需要时间，因此看起来打印了不止1s。因为涉及IO操作。</p><p><img src="https://img-blog.csdnimg.cn/89b1c244d75f409e9fe4c741046a40db.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>我们可以把它的输出重定向到一个文件里面。</p><p>可见，计算了 <code>10^8</code> 次左右。</p><p><img src="https://img-blog.csdnimg.cn/a71f03c8071a4072ae8a8b79312d73cd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/2e8753ea5ad74807b5bf3ce4faac6905.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_16,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>程序实际运行时间 = 内核时间（系统调用） + 用户时间（CPU代码执行时间） + 消耗的时间（如IO）</p><p>内核时间，用户时间操作很快，因为都是在内存当前做事情。</p><p>IO会打开文件，写东西，关闭文件，和硬件打交道，非常浪费时间。</p><p>这里还涉及内核态和用户区态切换。</p><p><code>alarm</code>是系统调用，执行的时候切换到内核态，后面的代码执行又切换到用户态。</p><p>定时器和进程的状态（就绪，运行，挂起，暂停，僵尸，终止）无关——自然定时法。无论进程处于什么状态，定时器都会计时。</p><h4 id="9-3-setimier-定时器函数"><a href="#9-3-setimier-定时器函数" class="headerlink" title="9.3 setimier 定时器函数"></a>9.3 setimier 定时器函数</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>      <span class="token keyword">int</span> <span class="token function">setitimer</span><span class="token punctuation">(</span><span class="token keyword">int</span> which<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> <span class="token operator">*</span>new_value<span class="token punctuation">,</span>                      <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> <span class="token operator">*</span>old_value<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>作用：设置定时器，可以替代alarm。</p><p>​            单位：微秒us。</p><p>​            可以实现周期性定时。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">ITIMER_REAL    This timer counts down in <span class="token function">real</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> wall clock<span class="token punctuation">)</span> time<span class="token punctuation">.</span>  At each expiration<span class="token punctuation">,</span> a 【SIGALRM】 signal is generated<span class="token punctuation">.</span>ITIMER_VIRTUAL This timer counts down against the 【user<span class="token operator">-</span>mode CPU time】 consumed by the process<span class="token punctuation">.</span>  <span class="token punctuation">(</span>The measurement includes CPU time consumed by all threads in the process<span class="token punctuation">.</span><span class="token punctuation">)</span>  At each expiration<span class="token punctuation">,</span> a 【SIGVTALRM】 signal is generated<span class="token punctuation">.</span>ITIMER_PROF    This timer counts down against the <span class="token function">total</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> both 【user and system<span class="token punctuation">)</span> CPU time】 consumed by the process<span class="token punctuation">.</span>  <span class="token punctuation">(</span>The measurement includes CPU time consumed by all threads in the process<span class="token punctuation">.</span><span class="token punctuation">)</span>  At each expiration<span class="token punctuation">,</span> a 【SIGPROF】 signal is  generated<span class="token punctuation">.</span>    In  conjunction  with  ITIMER_VIRTUAL<span class="token punctuation">,</span>  this timer can be used to profile user and system CPU time consumed by the process<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 定时器的结构体</span><span class="token keyword">struct</span> <span class="token class-name">itimerval</span> <span class="token punctuation">{</span><span class="token keyword">struct</span> <span class="token class-name">timeval</span> it_interval<span class="token punctuation">;</span> <span class="token comment">// 每个阶段的时间，间隔时间</span><span class="token keyword">struct</span> <span class="token class-name">timeval</span> it_value<span class="token punctuation">;</span>    <span class="token comment">// 延迟多久时间执行定时器</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// from now on, wait 10s expire the clock, the interval is 2s</span><span class="token comment">// it_interval -&gt; 2s (反复执行)</span><span class="token comment">// it_value -&gt; 10s (delay)</span><span class="token comment">// 时间的结构体</span><span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">{</span><span class="token class-name">time_t</span>      tv_sec<span class="token punctuation">;</span>         <span class="token comment">// 秒数</span><span class="token class-name">suseconds_t</span> tv_usec<span class="token punctuation">;</span>        <span class="token comment">// 微秒</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数：</p><ul><li><p>which：定时器以什么时间计时</p><ul><li>ITIMER_REAF：真实世界的时间，发送SIGALRM（常用）</li><li>ITIMER_VIRTUAL：用户时间，发送SIGVTALRM</li><li>ITIMER_PROF：用户态 + 内核态消耗的时间，发送SIGPROOF</li></ul></li><li><p>new_value：设置这个定时器的属性</p></li><li><p>old_value：记录上一次定时的参数，用不到就传入NULL</p></li></ul><p>RETURN VALUE<br>       * On success, 【zero】 is returned.  </p><ul><li>On error, 【-1】 is returned, and errno is set appropriately.</li></ul><h5 id="示例代码-11"><a href="#示例代码-11" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">/*    struct itimerval new_value = {        {2, 0}, // 间隔的时间（周期）        {3, 0}  // 延迟的时间（过多久第一次执行）    };    */</span>   <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token comment">// 周期为2s</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>          <span class="token comment">// 延迟3s后执行</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setitimer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start timing...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 阻塞一下，不然还没计时3s钟就碰到return了</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，程序一跑起来 <code>start timing...</code> 就被打印了，说明 <code>setitimer</code> 和 <code>alarm</code> 一样也是非阻塞的。</p><p>然后过了3s程序就收到 <code>SIGALRM</code> 信号被终止了。</p><p>那说好的周期性定时效果呢》</p><p>因为我们没有捕捉信号，因此第一次发送 <code>SIGALRM</code> 的时候进程就被杀死了。</p><p><img src="https://img-blog.csdnimg.cn/0e5a14e6266b4fdcb7aa029bceca990a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>old_value 是个<code>传出参数</code>，系统会自动帮你设置它的值为上一次时钟的参数。</p><h5 id="示例代码-12"><a href="#示例代码-12" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">/*    struct itimerval new_value = {        {2, 0}, // 间隔的时间（周期）        {3, 0}  // 延迟的时间（过多久第一次执行）    };    */</span>   <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>        <span class="token comment">// 周期为2s</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>          <span class="token comment">// 延迟3s后执行</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> old_value<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"init : %ld, %ld\n"</span><span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec<span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>old_value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"after 1 : %ld, %ld\n"</span><span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec<span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setitimer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start timing...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>old_value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"after 2 : %ld, %ld\n"</span><span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec<span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/fdff376012ed4c64bd1238b95f5d5057.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h4 id="9-4-signal-と-sigaction-信号捕捉函数"><a href="#9-4-signal-と-sigaction-信号捕捉函数" class="headerlink" title="9.4 signal と sigaction 信号捕捉函数"></a>9.4 signal と sigaction 信号捕捉函数</h4><p>时钟结束后会发送一个 <code>SIGALRM</code> 信号，默认把当前进程终止，并没有周期性地执行。</p><p>因此我们要捕捉信号，不让他默认终止进程，而是我们程序员自己来做一些处理。</p><h5 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">sighandler_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">sighandler_t</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">,</span> <span class="token class-name">sighandler_t</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>signal handler</code> 是信号处理器，既然我们要执行某些事情，不要进程被默认杀掉，就需要把代码写到函数当中，执行这个函数去完成某些事情，因此这是个函数指针，是个函数的地址。</p><h4 id="9-5-信号集-と-相关函数"><a href="#9-5-信号集-と-相关函数" class="headerlink" title="9.5 信号集 と 相关函数"></a>9.5 信号集 と 相关函数</h4><h4 id="9-6-sigprocmask-函数"><a href="#9-6-sigprocmask-函数" class="headerlink" title="9.6 sigprocmask 函数"></a>9.6 sigprocmask 函数</h4><h4 id="9-7-sigaction-信号捕捉函数"><a href="#9-7-sigaction-信号捕捉函数" class="headerlink" title="9.7 sigaction 信号捕捉函数"></a>9.7 sigaction 信号捕捉函数</h4><h4 id="9-8-SIGCHILD-信号"><a href="#9-8-SIGCHILD-信号" class="headerlink" title="9.8 SIGCHILD 信号"></a>9.8 SIGCHILD 信号</h4><h2 id="17-共享内存"><a href="#17-共享内存" class="headerlink" title="17. 共享内存"></a>17. 共享内存</h2><h2 id="18-守护进程"><a href="#18-守护进程" class="headerlink" title="18. 守护进程"></a>18. 守护进程</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Linux-多进程&quot;&gt;&lt;a href=&quot;#Linux-多进程&quot; class=&quot;headerlink&quot; title=&quot;Linux 多进程&quot;&gt;&lt;/a&gt;Linux 多进程&lt;/h1&gt;&lt;h2 id=&quot;1-什么是进程&quot;&gt;&lt;a href=&quot;#1-什么是进程&quot; class=&quot;he</summary>
      
    
    
    
    <category term="系统编程" scheme="https://sakkana.github.io/categories/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/"/>
    
    
    <category term="C/C++" scheme="https://sakkana.github.io/tags/C-C/"/>
    
  </entry>
  
  <entry>
    <title>Linux文件IO</title>
    <link href="https://sakkana.github.io/2022/04/09/Linux%E6%96%87%E4%BB%B6IO/"/>
    <id>https://sakkana.github.io/2022/04/09/Linux%E6%96%87%E4%BB%B6IO/</id>
    <published>2022-04-09T15:02:01.000Z</published>
    <updated>2022-04-13T16:48:46.172Z</updated>
    
    <content type="html"><![CDATA[<h1 id="文件IO"><a href="#文件IO" class="headerlink" title="文件IO"></a>文件IO</h1><h3 id="输入输出是相对的"><a href="#输入输出是相对的" class="headerlink" title="输入输出是相对的"></a>输入输出是相对的</h3><p>对于文件, input为内存-&gt;文件</p><p>​                output为文件-&gt;内存</p><p>对于内存，input为文件-&gt;内存</p><p>​                    output为内存-&gt;文件</p><p>我们站在<code>内存的角度</code>看，因为我们系的程序会被加载到内存中，因此output是从内存到文件，input是从内存到文件</p><p>这一章节会频繁查看Linux的man手册</p><p>1   Executable programs or shell commands （标准命令）</p><p>2   System calls (functions provided by the kernel)    （系统调用）</p><p>3   Library calls (functions within program libraries)（库函数）</p><p>man 1 mkdir 是shell命令 mkdir</p><p>man 2 mkdir 是Linux系统调用 mkdir</p><p>man 3 printf 是库函数 printf</p><h2 id="1-Linux系统IO-amp-标准C库IO"><a href="#1-Linux系统IO-amp-标准C库IO" class="headerlink" title="1. Linux系统IO &amp; 标准C库IO"></a>1. Linux系统IO &amp; 标准C库IO</h2><p><img src="https://img-blog.csdnimg.cn/eb9e955eccd44b7eb4a3457db10c4d9c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="IO函数"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>Java跨平台：为不同的操作系统做一个<code>JVM</code></p><p>标准C库函数跨平台（操作系统）：C库是第三方库跑在不同的操作系统上底层会调用不同操作系统的API。</p><p><code>标准C库的IO函数</code>更高级，更高效（带有缓冲区）。</p><p><code>Linux的IO函数</code>更底层，有特定使用场景，如网络通信（要求通信效率，如果数据还在缓冲区中，对方收不到急死了，直接用Linux系统I/O函数，实时发送）。</p><h5 id="FILE-是一个结构体"><a href="#FILE-是一个结构体" class="headerlink" title="FILE* 是一个结构体"></a>FILE* 是一个结构体</h5><ul><li><p>文件描述符（整型值），指向打开的文件。（Windows操作系统中称为文件句柄）</p></li><li><p>文件读写指针，维护了两个指针，用于操作数据，读数据或写数据。</p></li><li><p>I/O缓冲区，所有的标准C库函数都带有I/O缓冲区</p><p>调用 <code>fopen</code> 之后，该函数会返回一个<code>FILE*类型</code>的<code>文件指针</code>，通过它我们可以操控这个指针指向的磁盘上的文件，<code>fwrite</code>，<code>fread</code>等IO函数都要求传入这个文件指针。</p></li></ul><p><img src="https://img-blog.csdnimg.cn/34f892ad27ca487f939ce7a943756b40.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="fwrite"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>每次调用 <code>fwrite</code>，并不是一下子把数据写到磁盘，而是先写到缓冲区（实质上是<code>内存</code>），一旦缓冲区满了，就调用Linux系统调用，统一写道磁盘中。以此来提高程序执行效率。</p><p>无缓冲区，写一次数据存一次到磁盘，用系统调用直接跟硬件打交道，效率低。</p><p>有缓冲区，统一写到缓冲区中，等满了之后统一打包，调用一次系统调用写道磁盘，效率高。</p><p>因此，有无缓冲区的本质区别是，数据写到<code>内存</code>还是写到<code>磁盘</code>。</p><h5 id="缓冲区什么时候往磁盘写数据？"><a href="#缓冲区什么时候往磁盘写数据？" class="headerlink" title="缓冲区什么时候往磁盘写数据？"></a>缓冲区什么时候往磁盘写数据？</h5><ul><li><p>1.强制刷新缓冲区 <code>fflush</code></p></li><li><p>2.缓冲区已满</p></li><li><p>3.正常关闭文件</p><ul><li><code>fclose</code></li><li><code>return</code> (main 函数)</li><li><code>exit</code> (main 函数)</li></ul></li></ul><p>缓冲区默认 <code>8192byte</code> ≈ <code>9KB</code>，可以人为调节但是不建议，因为这是理想大小。</p><h5 id="标准C库IO-amp-Linux系统IO的关系"><a href="#标准C库IO-amp-Linux系统IO的关系" class="headerlink" title="标准C库IO &amp; Linux系统IO的关系"></a>标准C库IO &amp; Linux系统IO的关系</h5><p><img src="https://img-blog.csdnimg.cn/e693a93b51fa425d82fe3bf34757d407.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="关系"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>缓冲区使命：减少程序与磁盘交换次数</p><h2 id="2-虚拟地址空间"><a href="#2-虚拟地址空间" class="headerlink" title="2. 虚拟地址空间"></a>2. 虚拟地址空间</h2><p><img src="https://img-blog.csdnimg.cn/a3832d28aec144819f687c8c14676ab9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="32位机器的虚拟地址空间"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>虚拟地址空间是对进程的内存的一种抽象，实际不存在。</p><p>直接分配物理内存存在的问题：物理内存不够或断掉……</p><p>在可执行程序运行期间，就会创建这么一个虚拟地址空间，进程结束就不复存在。</p><p>进程是资源分配的最小单位。</p><p><code>程序</code>是磁盘上的代码。</p><p><code>进程</code>是运行中的程序，会被加载到内存中。</p><p>理解应用程序运行时的一些机制，不深究虚拟地址空间的实现方法。</p><p>虚拟地址空间大小由CPU决定， 32位机器有 2<sup>32</sup>byte ≈ 4GB 这么大， 64位机器有 2<sup>48</sup> 这么大。</p><p>虚拟地址空间中的数据会被CPU当中的<code>MMU（内存管理单元）</code>映射到物理内存中。</p><p>即： 虚拟地址 —&gt; MMU —&gt; 物理地址</p><p>虚拟内存占用了4G，但实际上在物理内存中占了不到4G.</p><h5 id="0G-3G-是用户区，普通用户可以操作其中某些空间。"><a href="#0G-3G-是用户区，普通用户可以操作其中某些空间。" class="headerlink" title="0G~ 3G 是用户区，普通用户可以操作其中某些空间。"></a>0G~ 3G 是用户区，普通用户可以操作其中某些空间。</h5><ul><li>受保护的地址 : NULL, nullptr</li><li>.txt : 代码段</li><li>.data：已初始化的 global variable</li><li>.bss：未初始化的global variable</li><li>堆空间(大)：malloc，低地址往高地址生长</li><li>共享库：前几节课学习的动态库</li><li>栈空间(小)：local variable 高地址往低地址生长</li><li>命令行参数：int argc, char *argv[]</li><li>环境变量：每个Linux用户都有环境变量<ul><li><img src="https://img-blog.csdnimg.cn/1526d205cd6b47c4924584b26dc20eed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="Linux下执行env命令查看用户环境变量"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></li></ul></li></ul><h5 id="3G-4G-是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read-write函数）"><a href="#3G-4G-是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read-write函数）" class="headerlink" title="3G ~4G 是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read, write函数）"></a>3G ~4G 是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read, write函数）</h5><ul><li>内存管理</li><li>进程管理</li><li>设备驱动管理</li><li>VFS虚拟文件系统</li></ul><h2 id="3-文件描述符"><a href="#3-文件描述符" class="headerlink" title="3. 文件描述符"></a>3. 文件描述符</h2><p><img src="https://img-blog.csdnimg.cn/9cfeca140f424a2c9d433423c6830a34.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="懒得写了"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="进程-VS-程序"><a href="#进程-VS-程序" class="headerlink" title="进程 VS 程序"></a>进程 VS 程序</h5><p><img src="https://img-blog.csdnimg.cn/3b7da6b7f6854c24ada790d0ef16cd75.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这里的 test.c源代码文件 和 app可执行文件 都是存储在磁盘上的文件，不占用内存空间。</p><p>当 ./app 之后，程序被加载到内存当中，操作系统创建一个进程，为这个程序的运行分配资源。</p><h5 id="那么，为什么程序当中调用-fopen-以后，调用-fread-和-fwrite-就可以找到磁盘上的文件？"><a href="#那么，为什么程序当中调用-fopen-以后，调用-fread-和-fwrite-就可以找到磁盘上的文件？" class="headerlink" title="那么，为什么程序当中调用 fopen 以后，调用 fread 和 fwrite 就可以找到磁盘上的文件？"></a>那么，为什么程序当中调用 <code>fopen</code> 以后，调用 <code>fread</code> 和 <code>fwrite</code> 就可以找到磁盘上的文件？</h5><p>因为调用fopen以后会返回一个<code>FILE*文件指针</code>，里面封装了一个<code>文件描述符</code>，文件描述符存储在内核区中。</p><p>内核就是一个程序，光有内核还不行，还不能称为OS。OS需要在后台管理所有的资源，并且还有一系列工具，如gcc，gdb等。这一切杂揉起来才成了OS。</p><p>内核区中的<code>PCB(进程控制块)</code>管理文件描述符。PCB是一个结构体，保存管理进程所需要的数据。</p><p>PCB 中有一个<code>数组</code>（因为一个进程可以打开多个文件），里面有一个 <code>文件描述符表</code>，里面存了很多文件描述符，每个描述符定位一个文件。</p><p>其大小默认为<code>1024</code>，最多能同时打开1024个文件。</p><p>文件描述符表中<code>0, 1, 2 (STDIN_FILENO, STDOUT_FILENO, STDERR_FILENO)</code> 默认被占用，默认被打开。他们都对应了同一个设备文件（由此可见，不同的文件描述符可以对应同一个文件），指向<code>当前使用的终端（/dev/tty)</code>。</p><p>一个文件可以被打开多次，但是文件描述符是不一样的，可以打开读，可以打开写。</p><p>当某个文件描述符被占用，内核会找到<code>最小的未被占用的</code>文件描述符，如0,1,2被占用，内核会分配4.</p><p>fclose（C库函数），close（Linux系统IO）可以释放文件描述符，可以被重用了，如0,1,2,3,4,5被占用，释放3之后，下一次分配就会分配3。</p><p><code>一切皆文件</code>，在Linux中所有的硬件设备都会被虚拟成一个文件，通过这个文件管理这些设备。 </p><h5 id="如何得到一个文件描述符？"><a href="#如何得到一个文件描述符？" class="headerlink" title="如何得到一个文件描述符？"></a>如何得到一个文件描述符？</h5><p><code>open</code>：Linux系统API，可以得到一个文件描述符，从而操作该文件描述符指向的文件。下次用 <code>read</code> 或 <code>write</code> 时，就不是传递标准C库的API—— FILE* 了，而是Linux的系统API——文件描述符。</p><h2 id="4-Linux系统IO函数"><a href="#4-Linux系统IO函数" class="headerlink" title="4. Linux系统IO函数"></a>4. Linux系统IO函数</h2><p><img src="https://img-blog.csdnimg.cn/684da67d1cda47e38e26be8e6cc7e062.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="4-1-open"><a href="#4-1-open" class="headerlink" title="4.1 open"></a>4.1 open</h3><h4 id="I-open-打开旧文件"><a href="#I-open-打开旧文件" class="headerlink" title="(I) open 打开旧文件"></a>(I) open 打开旧文件</h4><p>关于open函数的介绍</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       open, openat, creat - open and possibly create a fileSYNOPSIS       #include &lt;sys/types.h&gt;放宏       #include &lt;sys/stat.h&gt;放宏       #include &lt;fcntl.h&gt;这里放函数的声明// 打开一个已存在的文件       int open(const char *pathname, int flags);       // 创建一个新的文件int open(const char *pathname, int flags, mode_t mode);CRIPTION       The  open()  system call opens the file specified by pathname.  If the specified file does not       exist, it may optionally (if O_CREAT is specified in flags) be created by open().       The return value of open() is a file descriptor, a small, nonnegative integer that is used  in       subsequent  system  calls  (read(2),  write(2), lseek(2), fcntl(2), etc.) to refer to the open       file.  The file descriptor returned by a successful call will be the lowest-numbered file  de‐       scriptor not currently open for the process.       By  default,  the  new  file  descriptor  is set to remain open across an execve(2) (i.e., the       FD_CLOEXEC file descriptor flag described in fcntl(2) is initially  disabled);  the  O_CLOEXEC       flag,  described below, can be used to change this default.  The file offset is set to the be‐       ginning of the file (see lseek(2)).       A call to open() creates a new open file description, an entry in  the  system-wide  table  of       open  files.  The open file description records the file offset and the file status flags (see       below).  A file descriptor is a reference to an open file description; this reference is unaf‐       fected if pathname is subsequently removed or modified to refer to a different file.  For fur‐       ther details on open file descriptions, see NOTES.       In  addition,  zero  or  more file creation flags and file status flags can be bitwise-or'd in       flags.  The file creation flags are O_CLOEXEC, O_CREAT, O_DIRECTORY, O_EXCL,  O_NOCTTY,  O_NO‐       FOLLOW,  O_TMPFILE,  and O_TRUNC.  The file status flags are all of the remaining flags listed       below.  The distinction between these two groups of flags is that the file creation flags  af‐       fect the semantics of the open operation itself, while the file status flags affect the seman‐       tics of subsequent I/O operations.  The file status flags can be retrieved and (in some cases)       modified; see fcntl(2) for details.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="不带mode的open函数"><a href="#不带mode的open函数" class="headerlink" title="不带mode的open函数"></a>不带mode的open函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// flag是一些宏，代表文件操作权限，必选且互斥 （只读，只写，可读可写...）</span><span class="token comment">/*参数：pathname:文件路径flags:文件操作权限 &amp; 其他设置 The argument flags [ must ] include [ one of ] the following access  modes: O_RDONLY,  O_WRONLY,  or O_RDWR. These request opening the file read-only, write-only, or read/writie, respectively.返回值:open(),  openat(),  and creat() return the [ new file descriptor ], or [ -1 if an error occurred ] (in which case, [ errno ] is set appropriately).*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="perror详细介绍"><a href="#perror详细介绍" class="headerlink" title="perror详细介绍"></a>perror详细介绍</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*errno 属于Linux系统函数库里的一个全局变量，记录的是最近错误号NAME       perror - print a system error messageSYNOPSIS       #include &lt;stdio.h&gt;       void perror(const char *s);The perror() function produces a message on standard error describing the last error encountered during a call to a system or library function.    First (if s is not NULL and *s is not a null byte ('\0')), the argument string s is printed, followed by a colon and a blank.  Then an error message corresponding to the current value of errno and a new-line.    To be of most use, the argument string should include the name of the function that incurred the error.    The global error list sys_errlist[], which can be indexed by errno, can be used to obtain the error message without the newline.  The largest message number provided in the  table  is  sys_nerr-1.    Be careful when directly accessing this list, because new error values may not have been added to sys_errlist[].  The use of sys_errlist[] is nowadays deprecated; use strerror(3) instead.    When  a  system call fails, it usually returns -1 and sets the variable errno to a value describing what went wrong.  (These values can be found in &lt;errno.h&gt;.)  Many library functions do likewise.    The function perror() serves to translate this error code into human-readable form.  Note that errno is undefined after a successful system call or library function call: this call may well change this  variable, even though it succeeds, for example because it internally used some other library function that failed.  Thus, if a failing call is not immediately followed by a call to perror(), the value of errno should be saved.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="close-函数介绍"><a href="#close-函数介绍" class="headerlink" title="close 函数介绍"></a>close 函数介绍</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       close - close a file descriptorSYNOPSIS       #include &lt;unistd.h&gt;       int close(int fd);DESCRIPTION       close()  closes  a  file  descriptor,  so that it no longer       refers to any file and may be  reused.   Any  record  locks       (see fcntl(2)) held on the file it was associated with, and       owned by the process, are removed (regardless of  the  file       descriptor that was used to obtain the lock).       If fd is the last file descriptor referring to the underly‐       ing open file description (see open(2)), the resources  as‐       sociated  with  the open file description are freed; if the       file descriptor was the last reference to a file which  has       been removed using unlink(2), the file is deleted.RETURN VALUE       close() returns zero on success.  On error, -1 is returned,       and errno is set appropriately.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span><span class="token comment">// 包含宏</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span><span class="token comment">// 包含宏</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span><span class="token comment">// 包含 open 函数</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span><span class="token comment">// 包含 perror 函数</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span><span class="token comment">// 包含 close 函数</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open failed: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// output: open failed: : No such file or directory</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>由于我们当前目录下没有 <code>a.txt</code> 这个文件，因此使用 <code>open</code> 打开必然会出错，perror会捕捉最近的出错标记 errno, 并将错误打印出来。</p></blockquote><h4 id="II-open-创建新文件"><a href="#II-open-创建新文件" class="headerlink" title="(II) open 创建新文件"></a>(II) open 创建新文件</h4><p>一些可选项的man</p><h5 id="O-APPEND"><a href="#O-APPEND" class="headerlink" title="O_APPEND"></a>O_APPEND</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*O_APPEND    The file is opened in append mode.  Before each write(2), the file offset is positioned at the end of the file, as if with lseek(2).  The modification of the file  offset  and the write operation are performed as a single atomic step.    O_APPEND  may  lead  to corrupted files on NFS filesystems if more than one process appends data to a file at once.  This is because NFS does  not  support  appending  to  a file,  so the client kernel has to simulate it, which can't be done without a race condition.  */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="O-CREAT"><a href="#O-CREAT" class="headerlink" title="O_CREAT"></a>O_CREAT</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">O_CREAT    If pathname does not exist<span class="token punctuation">,</span> create it as a regular file<span class="token punctuation">.</span>    The <span class="token function">owner</span> <span class="token punctuation">(</span>user ID<span class="token punctuation">)</span> of the new file is set to the effective user ID of the process<span class="token punctuation">.</span>    The group <span class="token function">ownership</span> <span class="token punctuation">(</span>group ID<span class="token punctuation">)</span> of the new file is set either to the effective group  ID of the <span class="token function">process</span> <span class="token punctuation">(</span>System V semantics<span class="token punctuation">)</span> or to the group ID of the parent <span class="token function">directory</span> <span class="token punctuation">(</span>BSD semantics<span class="token punctuation">)</span><span class="token punctuation">.</span>      On Linux<span class="token punctuation">,</span> the behavior depends on whether the set<span class="token operator">-</span>group<span class="token operator">-</span>ID mode bit  is  set on  the parent directory<span class="token operator">:</span> <span class="token keyword">if</span> that bit is set<span class="token punctuation">,</span> then BSD semantics apply<span class="token punctuation">;</span> otherwise<span class="token punctuation">,</span> System V semantics apply<span class="token punctuation">.</span>  For some filesystems<span class="token punctuation">,</span> the behavior also  depends  on  the  bsd<span class="token operator">-</span>groups and sysvgroups mount options described in <span class="token function">mount</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>        The mode argument specifies the file mode bits be applied when a new file is  created<span class="token punctuation">.</span>   This  argument must  be  supplied when O_CREAT or O_TMPFILE is specified in flags<span class="token punctuation">;</span> <span class="token keyword">if</span> neither O_CREAT nor O_TMPFILE is specified<span class="token punctuation">,</span> then mode is ignored<span class="token punctuation">.</span>  The effective mode is modified by the process's umask  in  the  usual way<span class="token operator">:</span>  in the absence of a <span class="token keyword">default</span> ACL<span class="token punctuation">,</span> the mode of the created file <span class="token function">is</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token operator">~</span>umask<span class="token punctuation">)</span><span class="token punctuation">.</span>  Note that this mode applies only to future accesses of the newly created file<span class="token punctuation">;</span> the <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> call that  creates  a  read<span class="token operator">-</span>only file may well <span class="token keyword">return</span> a read<span class="token operator">/</span>write file descriptor<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="带mode的open函数"><a href="#带mode的open函数" class="headerlink" title="带mode的open函数"></a>带mode的open函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建一个新的文件</span><span class="token comment">/*mode是一个八进制数，表示用户创建出的新的文件的操作权限如0775，0代表八进制7 -&gt; 111 ---&gt; rwx777 -&lt; 111111111 -&gt;rwxrwxrwx5 -&gt; 101 -&gt; r-x -&gt; 没有写的权限umask用于抹去某些权限, umask可以自己设计(只在当前终端有用)root用户 umask = 0022普通用户 umask = 0002假如一个普通用户的权限是 mode = 0777umask = 0002~umask = 0777 - 0002 = 0775mode &amp; ~umask = 0777 &amp; 0775 = 111111111 &amp; 111111101 = 111111101The  mode  argument specifies the file mode bits be applied when a new file is created.This argument must be supplied when 【 O_CREAT or O_TMPFILE 】 is specified in flags; if neither  O_CREAT  nor O_TMPFILE is specified, then mode is ignored.  The effective mode is modified by the process's 【 umask(掩码) 】 in the usual way: in the absence of a default ACL, the mode of the created file is 【 (mode &amp; ~umask) 】(最终得到的权限). Note that this mode applies only to 【 future accesses 】 of the newly created file; the open() call that creates a read-only file may well return a read/write file descriptor.-rw-rw-r--可以分割成四个部分-文件类型rw-当前用户对文件的权限权限rw-当前用户所在的组对文件的权限r--其他组对文件的权限*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/3b914ee95ede4ac9850fba2e076d7aa5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// close</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>  <span class="token comment">// perror</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"create.txt"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"OPEN ERROR:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>  <span class="token comment">// 终端无任何异常</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Linux会为这个程序创建一个新的文件 create.txt（颜色是绿色的，因为我们给他的权限是0777, &amp;上~umask后得到0775， 即 <code>-rwxrwxr-x</code> ）</p></blockquote><h5 id="为什么用-按位或-？"><a href="#为什么用-按位或-？" class="headerlink" title="为什么用 按位或 ？"></a>为什么用 <code>按位或</code> ？</h5><pre class="line-numbers language-none"><code class="language-none">O_RDWR | O_CREAT<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们可以看到 <code>flag</code> 是个 int 类型， 即32位</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这32位每一位都是个标记位，按位或了之后可以把不同的权限组合到一起</p><h3 id="4-2-read-amp-write"><a href="#4-2-read-amp-write" class="headerlink" title="4.2 read &amp; write"></a>4.2 read &amp; write</h3><h5 id="关于write的man"><a href="#关于write的man" class="headerlink" title="关于write的man"></a>关于write的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       read - read from a file descriptorSYNOPSIS       #include &lt;unistd.h&gt;       ssize_t read(int fd, void *buf, size_t count);DESCRIPTION       read() attempts to read up to count bytes from file descriptor fd into the buffer starting at buf.       On  files  that support seeking, the read operation commences at the file offset, and the file offset is incremented by the number of bytes read.  If the file offset is at or past the end of file,       no bytes are read, and read() returns zero.       If count is zero, read() may detect the errors described below.  In the absence of any errors, or if read() does not check for errors, a read() with a count of 0 returns zero and has no other  ef‐       fects.       According to POSIX.1, if count is greater than SSIZE_MAX, the result is implementation-defined; see NOTES for the upper limit on Linux.RETURN VALUE       On  success,  【 the  number of bytes read 】 is returned (【 zero 】 indicates end of file), and the file position is advanced by this number.  It is not an error if this number is smaller than the number of bytes requested; this may happen for example because fewer bytes are actually available right now (maybe because we were close to end-of-file, or because we are reading from a pipe, or from a terminal), or because read() was interrupted by a signal.  See also NOTES.       On error, 【 -1 】 is returned, and errno is set appropriately.  In this case, it is left unspecified whether the file position (if any) changes.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="关于write的man-1"><a href="#关于write的man-1" class="headerlink" title="关于write的man"></a>关于write的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       write - write to a file descriptorSYNOPSIS       #include &lt;unistd.h&gt;       ssize_t write(int fd, const void *buf, size_t count);// fd 通过open得到DESCRIPTION       write() writes up to count bytes from the buffer starting at buf to the file referred to by the file descriptor fd.       The  number  of  bytes  written  may be less than count if, for example, there is insufficient space on the underlying physical medium, or the RLIMIT_FSIZE resource limit is encountered (see setrlimit(2)), or the call was interrupted by a signal handler after having written less than count bytes.  (See also pipe(7).)       For a seekable file (i.e., one to which lseek(2) may be applied, for example, a regular file) writing takes place at the file offset, and the file offset is incremented by the number of bytes  actually  written.   If  the file was open(2)ed with O_APPEND, the file offset is first set to the end of the file before writing.  The adjustment of the file offset and the write operation are performed as an atomic step.       POSIX requires that a read(2) that can be proved to occur after a write() has returned will return the new data.  Note that not all filesystems are POSIX conforming.       According to POSIX.1, if count is greater than SSIZE_MAX, the result is implementation-defined; see NOTES for the upper limit on Linux.RETURN VALUE       On success, 【 the number of bytes written 】 is returned.  On error, 【 -1 】 is returned, and errno is set to indicate the cause of the error.       Note that a successful write() may transfer fewer than count bytes.  Such partial writes can occur for various reasons; for example, because there was insufficient space  on  the  disk  device  to write all of the requested bytes, or because a blocked write() to a socket, pipe, or similar was interrupted by a signal handler after it had transferred some, but before it had transferred all of the requested bytes.  In the event of a partial write, the caller can make another write() call to transfer the remaining bytes.  The subsequent call will either transfer further bytes or may  result in an error (e.g., if the disk is now full).       If  count is zero and fd refers to a regular file, then write() may return a failure status if one of the errors below is detected.  If no errors are detected, or error detection is not performed, 0 will be returned without causing any other effect.  If count is zero and fd refers to a file other than a regular file, the results are not specified.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-（文件拷贝）"><a href="#测试代码-（文件拷贝）" class="headerlink" title="测试代码 （文件拷贝）"></a>测试代码 （文件拷贝）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token number">1</span>#include <span class="token operator">&lt;</span>unistd<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token number">2</span> #include <span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token number">3</span> #include <span class="token operator">&lt;</span>sys<span class="token operator">/</span>types<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token number">4</span> #include <span class="token operator">&lt;</span>sys<span class="token operator">/</span>stat<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token number">5</span> #include <span class="token operator">&lt;</span>fcntl<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token number">9</span> <span class="token punctuation">{</span><span class="token number">10</span><span class="token number">11</span>     <span class="token comment">// 1. open ---&gt; 打开源文件</span><span class="token number">12</span>     <span class="token keyword">int</span> srcfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"english.txt"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">13</span><span class="token number">14</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>srcfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">15</span>     <span class="token punctuation">{</span><span class="token number">16</span>         <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">17</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token number">18</span>     <span class="token punctuation">}</span><span class="token number">19</span><span class="token number">20</span><span class="token number">21</span>     <span class="token comment">// 2. 创建一个新的目标文件</span><span class="token number">22</span>     <span class="token keyword">int</span> destfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"newEnglish.txt"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">23</span><span class="token number">24</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>destfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">25</span>     <span class="token punctuation">{</span><span class="token number">26</span>         <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">27</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token number">28</span>     <span class="token punctuation">}</span><span class="token number">29</span><span class="token number">30</span><span class="token number">31</span>     <span class="token comment">// 3. 频繁的读写操作</span><span class="token number">32</span>     <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token number">33</span><span class="token number">34</span>     <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token number">35</span>     <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>srcfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token number">36</span>         <span class="token function">write</span><span class="token punctuation">(</span>destfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">37</span><span class="token number">38</span><span class="token number">39</span>     <span class="token comment">// 4. 关闭文件</span><span class="token number">40</span>     <span class="token function">close</span><span class="token punctuation">(</span>srcfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">41</span>     <span class="token function">close</span><span class="token punctuation">(</span>destfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">42</span><span class="token number">43</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token number">44</span><span class="token number">45</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-3-lseek"><a href="#4-3-lseek" class="headerlink" title="4.3 lseek"></a>4.3 lseek</h3><h5 id="关于C库-fseek-和Linux系统下-lseek-的man"><a href="#关于C库-fseek-和Linux系统下-lseek-的man" class="headerlink" title="关于C库 fseek 和Linux系统下 lseek 的man"></a>关于C库 <code>fseek</code> 和Linux系统下 <code>lseek</code> 的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*// fseekNAME       fgetpos, fseek, fsetpos, ftell, rewind - reposition a streamSYNOPSIS       #include &lt;stdio.h&gt;       int fseek(FILE *stream, long offset, int whence);       long ftell(FILE *stream);       void rewind(FILE *stream);       int fgetpos(FILE *stream, fpos_t *pos);       int fsetpos(FILE *stream, const fpos_t *pos);DESCRIPTION       The  fseek() function sets the file position indicator for the stream pointed to by stream.  The new position, measured in bytes, is obtained by 【 adding offset bytes to the position specified by whence 】.  If whence is set to SEEK_SET, SEEK_CUR, or SEEK_END,  the  offset is relative to the start of the file, the current position indicator, or end-of-file, respectively.       A successful call to the fseek() function clears the end-of-file indicator for the stream and undoes any  effects  of  the ungetc(3) function on the same stream.       The ftell() function obtains the current value of the file position indicator for the stream pointed to by stream.       The  rewind()  function sets the file position indicator for the stream pointed to by stream to the beginning of the file. It is equivalent to:              (void) fseek(stream, 0L, SEEK_SET)               except that the error indicator for the stream is also cleared (see clearerr(3)).       The fgetpos() and fsetpos() functions are alternate interfaces equivalent to ftell()  and  fseek()  (with  whence  set  to SEEK_SET),  setting  and  storing the current value of the file offset into or from the object referenced by pos.  On some non-UNIX systems, an fpos_t object may be a complex object and these routines may be the only way to portably reposition a text stream.RETURN VALUE       The  rewind()  function returns no value.  Upon successful completion, fgetpos(), fseek(), fsetpos() return 0, and ftell() returns the current offset.  Otherwise, -1 is returned and errno is set to indicate the error.       */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*// lseekNAME       lseek - reposition read/write file offsetSYNOPSIS       #include &lt;sys/types.h&gt;       #include &lt;unistd.h&gt;       off_t lseek(int fd, off_t offset, int whence);              参数：       fd: 文件描述符，通过open()得到       offset: 偏移量       whence:        SEEK_SET: 设置文件指针的偏移量       SEEK_CUR: 设置偏移量， 当前位置 + offset       SEEK_END: 设置偏移量， 文件大小 + offset       DESCRIPTION       lseek()  【 repositions  the  file offset of the open file description 】 associated with the file descriptor fd to the argument offset according to the directive whence as follows:       SEEK_SET              The file offset is set to 【 （begin） + offset bytes 】.       SEEK_CUR              The file offset is set to its 【 current location 】 plus 【 offset bytes 】.       SEEK_END              The file offset is set to 【 the size of the file 】 plus 【 offset bytes 】.       lseek() allows the file offset to be set beyond the end of the file (but this does not change the size of the  file).   If data  is  later  written  at this point, subsequent reads of the data in the gap (a "hole") return null bytes ('\0') until data is actually written into the gap.       */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5><ul><li><ol><li><p>移动文件指针到【头文件】位置，不然要关闭文件再打开，重新运行了</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol></li><li><ol start="2"><li><p>获取当前文件的位置</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_CUR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol></li><li><ol start="3"><li><p>获取文件大小</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol></li><li><ol start="4"><li><p>拓展文件长度</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果当前文件10b, 扩展后为110b</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h5 id="测试代码-获取当前指针位置"><a href="#测试代码-获取当前指针位置" class="headerlink" title="测试代码 (获取当前指针位置)"></a>测试代码 (获取当前指针位置)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 扩展文件长度</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_CUR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"lseek : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> res2 <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_CUR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                                           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件指针刚开始在 %d byte 处， 目前在 %d byte 处\n"</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> res2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// output: 文件指针刚开始在 0 byte 处， 目前在 32 byte 处</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-拓展文件长度"><a href="#测试代码-拓展文件长度" class="headerlink" title="测试代码 (拓展文件长度)"></a>测试代码 (拓展文件长度)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span><span class="token comment">// 宏</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span><span class="token comment">// 宏</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span><span class="token comment">// open</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span><span class="token comment">// lseek</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span><span class="token comment">// perror / close</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 扩展文件长度</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"lseek : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 写入空串</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>假如原先的 <code>a.txt</code> 里面有6个byte, 这么一扩展，文件变成了6 + 1 + 100个byte</p></blockquote></li></ul><h5 id="为什么要扩展文件大小？"><a href="#为什么要扩展文件大小？" class="headerlink" title="为什么要扩展文件大小？"></a>为什么要扩展文件大小？</h5><p>例如，在下载文件时，这个文件有5G大，慢慢下载的过程中发现空间不够了就出大问题了。因而，在下载之前就先占用5G的空间，下载的过程中慢慢往里面写数据，可以保证磁盘空间一定够用。</p><h3 id="4-4-stat-amp-lstat"><a href="#4-4-stat-amp-lstat" class="headerlink" title="4.4 stat &amp; lstat"></a>4.4 stat &amp; lstat</h3><h5 id="stat的man"><a href="#stat的man" class="headerlink" title="stat的man"></a>stat的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/*NAME       stat, fstat, lstat, fstatat - get file statusSYNOPSIS       #include &lt;sys/types.h&gt;       #include &lt;sys/stat.h&gt;       #include &lt;unistd.h&gt;       int stat(const char *pathname, struct stat *statbuf);       参数：       pathname 文件路径       statbuf 是一个传出参数，用于保存或得到的文件信息       RETURN VALUE           On success, zero is returned.             On error, -1 is returned, and errno is set appropriately.DESCRIPTION       These functions 【 return information about a file 】, in the buffer pointed to by statbuf.  No permissions are required  on  the  file  itself,  but in  the  case  of  stat(),  fstatat(),  and lstat()—execute  (search)  permission  is  required on all of the directories in pathname that lead to the file.       stat() and fstatat() retrieve information about the file pointed to by pathname;  the  differences for fstatat() are described below.       */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="lstat的man"><a href="#lstat的man" class="headerlink" title="lstat的man"></a>lstat的man</h5><p>lstat 单纯用来获取 <code>软链接类型</code> 文件本身的信息</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*int lstat(const char *pathname, struct stat *statbuf);lstat()  is  identical  to stat(), except that if pathname is a 【 symbolic link 】, then it returns information about 【 the link itself, not the file that it refers to 】.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="struct-stat-这个传出参数里是什么？"><a href="#struct-stat-这个传出参数里是什么？" class="headerlink" title="struct stat 这个传出参数里是什么？"></a><code>struct stat</code> 这个传出参数里是什么？</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// The stat structure</span>       <span class="token comment">// All of these system calls return a stat structure, which contains the following fields:</span>           <span class="token keyword">struct</span> <span class="token class-name">stat</span> <span class="token punctuation">{</span>               <span class="token class-name">dev_t</span>     st_dev<span class="token punctuation">;</span>         <span class="token comment">/* ID of device containing file */</span>               <span class="token class-name">ino_t</span>     st_ino<span class="token punctuation">;</span>         <span class="token comment">/* Inode number */</span>               <span class="token class-name">mode_t</span>    st_mode<span class="token punctuation">;</span>        <span class="token comment">/* File type and mode */</span>               <span class="token class-name">nlink_t</span>   st_nlink<span class="token punctuation">;</span>       <span class="token comment">/* Number of hard links */</span>               <span class="token class-name">uid_t</span>     st_uid<span class="token punctuation">;</span>         <span class="token comment">/* User ID of owner */</span>               <span class="token class-name">gid_t</span>     st_gid<span class="token punctuation">;</span>         <span class="token comment">/* Group ID of owner */</span>               <span class="token class-name">dev_t</span>     st_rdev<span class="token punctuation">;</span>        <span class="token comment">/* Device ID (if special file) */</span>               <span class="token class-name">off_t</span>     st_size<span class="token punctuation">;</span>        <span class="token comment">/* Total size, in bytes */</span>               <span class="token class-name">blksize_t</span> st_blksize<span class="token punctuation">;</span>     <span class="token comment">/* Block size for filesystem I/O */</span>               <span class="token class-name">blkcnt_t</span>  st_blocks<span class="token punctuation">;</span>      <span class="token comment">/* Number of 512B blocks allocated */</span>               <span class="token comment">/* Since Linux 2.6, the kernel supports nanosecond                  precision for the following timestamp fields.                  For the details before Linux 2.6, see NOTES. */</span>               <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_atim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last access */</span>               <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_mtim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last modification */</span>               <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_ctim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last status change */</span>           <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">st_atime</span> <span class="token expression">st_atim<span class="token punctuation">.</span>tv_sec      </span><span class="token comment">/* Backward compatibility */</span></span>           <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">st_mtime</span> <span class="token expression">st_mtim<span class="token punctuation">.</span>tv_sec</span></span>           <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">st_ctime</span> <span class="token expression">st_ctim<span class="token punctuation">.</span>tv_sec</span></span>           <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="shell-中的-stat命令"><a href="#shell-中的-stat命令" class="headerlink" title="shell 中的 stat命令"></a>shell 中的 <code>stat命令</code></h5><p>在shell中使用 <code>stat filename</code> 可以查看一个文件的信息。</p><p>内容为 HELLO, WORLD!</p><p><img src="https://img-blog.csdnimg.cn/50605a172fa245479555011d1cb0c183.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/fc4732e0a51f4d54b69f6c868539080d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>判断一个文件对于三种用户是否可读可写可执行 —&gt; st_mode &amp; 对应的宏值</p><p>判断是什么类型 —&gt; (st_mode &amp; S_IMFT) == 对应的宏   （其中， S_IMFT == 0170000）</p><p>普通文件 <code>0664</code>，最高权限 <code>0777</code>(但是会被 <code>umask</code> 抹去一些权限)</p><h5 id="stat-测试代码-获取文件大小"><a href="#stat-测试代码-获取文件大小" class="headerlink" title="stat 测试代码 (获取文件大小)"></a>stat 测试代码 (获取文件大小)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">struct</span> <span class="token class-name">stat</span> statbuf<span class="token punctuation">;</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"stat : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size : %ld\n"</span><span class="token punctuation">,</span> statbuf<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-判断一个文件对于usr的权限"><a href="#测试代码-判断一个文件对于usr的权限" class="headerlink" title="测试代码 (判断一个文件对于usr的权限)"></a>测试代码 (判断一个文件对于usr的权限)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">struct</span> <span class="token class-name">stat</span> statbuf<span class="token punctuation">;</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"stat : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"该文件对于当前用户是否可写可读可执行？: %o\n"</span><span class="token punctuation">,</span> statbuf<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IRWXU<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/92af7771d9d6469190dc816df40a68fa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="关于软链接的man"><a href="#关于软链接的man" class="headerlink" title="关于软链接的man"></a>关于软链接的man</h5><p><img src="https://img-blog.csdnimg.cn/9c01c663280747bca86bd5c9aeeaab66.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>使用 <code>ln -s filename1 filename2</code> 可以创建一个软链接， filename2 -&gt; filename1</p><p>两个文件打开是同样的内容。</p><p>因此如果用 stat 来获取软链接的信息，则会获取其主人的信息；</p><p>若用 lstat 则会获取软链接的信息。</p><p><img src="https://img-blog.csdnimg.cn/c71afa0eb57143f7968a590f315f72e7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/f215916ec47949888754a1dfef966236.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/987061f877f44b60a123a5b24b394c3b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="lstat-测试代码"><a href="#lstat-测试代码" class="headerlink" title="lstat 测试代码"></a>lstat 测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">struct</span> <span class="token class-name">stat</span> statbuf<span class="token punctuation">;</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">lstat</span><span class="token punctuation">(</span><span class="token string">"b.txt"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 只是函数名从普通的 stat 变成了获取软链接文件信息的 lstat</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"stat : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size : %ld\n"</span><span class="token punctuation">,</span> statbuf<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-5-模拟实现-ls-l-命令"><a href="#4-5-模拟实现-ls-l-命令" class="headerlink" title="4.5 模拟实现 ls -l 命令"></a>4.5 模拟实现 <code>ls -l</code> 命令</h3><h5 id="关于-getpwuid-函数"><a href="#关于-getpwuid-函数" class="headerlink" title="关于 getpwuid() 函数"></a>关于 <code>getpwuid()</code> 函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       getpwuidSYNOPSIS       #include &lt;sys/types.h&gt;       #include &lt;pwd.h&gt;       struct passwd *getpwuid(uid_t uid);   Feature Test Macro Requirements for glibc (see feature_test_macros(7)):DESCRIPTION       The  getpwuid() function returns a pointer to a structure containing the broken-out fields of       【 the record in the password database 】 that matches the user ID uid.       The passwd structure is defined in &lt;pwd.h&gt; as follows:           struct passwd {               char   *pw_name;       /* username */</span>               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_passwd<span class="token punctuation">;</span>     <span class="token comment">/* user password */</span>               <span class="token class-name">uid_t</span>   pw_uid<span class="token punctuation">;</span>        <span class="token comment">/* user ID */</span>               <span class="token class-name">gid_t</span>   pw_gid<span class="token punctuation">;</span>        <span class="token comment">/* group ID */</span>               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_gecos<span class="token punctuation">;</span>      <span class="token comment">/* user information */</span>               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_dir<span class="token punctuation">;</span>        <span class="token comment">/* home directory */</span>               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_shell<span class="token punctuation">;</span>      <span class="token comment">/* shell program */</span>           <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="关于-getgrgid-函数"><a href="#关于-getgrgid-函数" class="headerlink" title="关于 getgrgid() 函数"></a>关于 <code>getgrgid() </code>函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       getgrgidSYNOPSIS       #include &lt;sys/types.h&gt;       #include &lt;grp.h&gt;       struct group *getgrgid(gid_t gid);DESCRIPTION       The  getgrgid() function returns a pointer to a structure containing the broken-out fields of       【 the record in the group database 】 that matches the group ID gid.       The group structure is defined in &lt;grp.h&gt; as follows:           struct group {               char   *gr_name;        /* group name */</span>               <span class="token keyword">char</span>   <span class="token operator">*</span>gr_passwd<span class="token punctuation">;</span>      <span class="token comment">/* group password */</span>               <span class="token class-name">gid_t</span>   gr_gid<span class="token punctuation">;</span>         <span class="token comment">/* group ID */</span>               <span class="token keyword">char</span>  <span class="token operator">*</span><span class="token operator">*</span>gr_mem<span class="token punctuation">;</span>         <span class="token comment">/* NULL-terminated array of pointers                                          to names of group members */</span>           <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-6-文件属性操作函数"><a href="#4-6-文件属性操作函数" class="headerlink" title="4.6 文件属性操作函数"></a>4.6 文件属性操作函数</h3><p><img src="https://img-blog.csdnimg.cn/c85e57c0c22f4063a7e93c9097127b97.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="access"><a href="#access" class="headerlink" title="access"></a>access</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       access, faccessat - check user's permissions for a fileSYNOPSIS       #include &lt;unistd.h&gt;       int access(const char *pathname, int mode);DESCRIPTION       access() 【 checks whether the calling process can access the file pathname 】.  If pathname is a symbolic link, it is dereferenced.       The  mode specifies 【 the accessibility check(s) to be performed 】, and is either the value F_OK, or a mask consisting of the bitwise OR of one or more of R_OK, W_OK, and X_OK.  【 F_OK 】 tests for the existence of the file. 【 R_OK 】, 【 W_OK 】, and 【 X_OK 】 test whether the file exists and grants read, write, and execute permissions, respectively.       The check is done using the calling process's real UID and GID, rather than the effective IDs as is done when actually attempting an operation (e.g., open(2)) on the file.  Similarly, for the root user, the check uses the set of permitted capabilities rather than the set of effective capabilities; and for non-root users, the check uses an empty set of capabilities.       This  allows  set-user-ID  programs  and capability-endowed programs to easily determine the invoking user's authority.  In other words, access() does not answer the "can I read/write/execute this file?" question.  It answers a slightly different question: "(assuming I'm a setuid binary) can the user who invoked me read/write/execute this file?", which gives set-user-ID programs the  possibility to prevent malicious users from causing them to read files which users shouldn't be able to read.       If the calling process is privileged (i.e., its real UID is zero), then an X_OK check is successful for a regular file if execute permission is enabled for any of the file owner, group, or other.       RETURN VALUE       On success (all requested permissions granted, or mode is F_OK and the file exists), 【 zero 】 is returned.  On error (at least one bit in mode asked for a permission that is denied, or  mode  is  F_OK and the file does not exist, or some other error occurred), 【 -1 】 is returned, and errno is set appropriately.       */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"access"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"file exists!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//（第三人称单数）</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a>chmod</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       chmod, fchmod, fchmodat - change permissions of a fileSYNOPSIS       #include &lt;sys/stat.h&gt;       int chmod(const char *pathname, mode_t mode);       DESCRIPTION       The  chmod() and fchmod() system calls 【change a files mode bits】.  (The file mode consists of the file permission bits plus the set-user-ID, set-group-ID, and sticky bits.)  These system calls differ only in how the file is specified:       * chmod() changes the mode of the file specified whose pathname is given in pathname, which is dereferenced if it is a symbolic link.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-3"><a href="#测试代码-3" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token number">0775</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"chmod"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"change mode successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/cbf926df87d24d35987825480fb47ff6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="chown"><a href="#chown" class="headerlink" title="chown"></a>chown</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       chown, fchown, lchown, fchownat - change ownership of a fileSYNOPSIS       #include &lt;unistd.h&gt;       int chown(const char *pathname, uid_t owner, gid_t group);DESCRIPTION       These  system calls 【change the owner and group】 of a file.  The chown(), fchown(), and lchown() system calls differ only in how the file is specified:       * chown() changes the ownership of the file specified by pathname, which is dereferenced if it is a symbolic link.       Only a privileged process (Linux: one with the CAP_CHOWN capability) may change the owner of a file.  The owner of a  file       may  change  the  group  of  the  file  to  any  group of which that owner is a member.  A privileged process (Linux: with       CAP_CHOWN) may change the group arbitrarily.       If the owner or group is specified as -1, then that ID is not changed.       When the owner or group of an executable file is changed by an unprivileged user, the S_ISUID and S_ISGID  mode  bits  are cleared.  POSIX does not specify whether this also should happen when root does the chown(); the Linux behavior depends on the kernel version, and since Linux 2.2.13, root is treated like other users.  In  case  of  a  non-group-executable  file (i.e.,  one  for  which  the  S_IXGRP bit is not set) the S_ISGID bit indicates mandatory locking, and is not cleared by a chown().       When the owner or group of an executable file is changed (by any user), all capability sets for the file are cleared.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过  <code>vim /etc/passwd</code> 可以查看该机器上的所有用户， <code>vim /etc/group</code> 可以查看所有的组。</p><p>通过 <code>useradd userName</code> 可以创建一个名为 userName 的新用户，可以用 <code>id userName</code> 查看该用户的uid,gid和group。</p><p><img src="https://img-blog.csdnimg.cn/2a258fe3cc904603b11160136e184799.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/2128a7806a3844e788ea4b4b314b6b31.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="测试代码-4"><a href="#测试代码-4" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">chown</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">1002</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 更改文件 a.txt 的uid &amp; gid</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"chown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"change uid and group successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/56666fd41a984da78b6abc3db806e087.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="truncate"><a href="#truncate" class="headerlink" title="truncate"></a>truncate</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       truncate<span class="token punctuation">,</span> ftruncate <span class="token operator">-</span> truncate a file to a specified lengthSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token class-name">off_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">int</span> <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>   Feature Test Macro Requirements <span class="token keyword">for</span> <span class="token function">glibc</span> <span class="token punctuation">(</span>see <span class="token function">feature_test_macros</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span>       <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>           _XOPEN_SOURCE <span class="token operator">&gt;=</span> <span class="token number">500</span>               <span class="token operator">||</span> <span class="token comment">/* Since glibc 2.12: */</span> _POSIX_C_SOURCE <span class="token operator">&gt;=</span> <span class="token number">200809L</span>               <span class="token operator">||</span> <span class="token comment">/* Glibc versions &lt;= 2.19: */</span> _BSD_SOURCE       <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>           _XOPEN_SOURCE <span class="token operator">&gt;=</span> <span class="token number">500</span>               <span class="token operator">||</span> <span class="token comment">/* Since glibc 2.3.5: */</span> _POSIX_C_SOURCE <span class="token operator">&gt;=</span> <span class="token number">200112L</span>               <span class="token operator">||</span> <span class="token comment">/* Glibc versions &lt;= 2.19: */</span> _BSD_SOURCEDESCRIPTION       The  <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  and  <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  functions cause the regular file named by path or referenced by fd to 【be truncated to a size of precisely length bytes】<span class="token punctuation">.</span>       If the file previously was larger than this size<span class="token punctuation">,</span> the extra data is lost<span class="token punctuation">.</span>                <span class="token comment">// 大变小 ---&gt; 截断</span>                  If the file previously was shorter<span class="token punctuation">,</span> it is  extended<span class="token punctuation">,</span> and the extended part reads as null <span class="token function">bytes</span> <span class="token punctuation">(</span><span class="token char">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>               <span class="token comment">// 小变大 ---&gt; '\0'填充</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-5"><a href="#测试代码-5" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span><span class="token comment">// perror</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span><span class="token comment">// atoi()</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">truncate</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"truncate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"truncate the file %s to %s bytes successfully!\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/00f304b3d35e4eb182a3f1a47efe8471.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="4-7-目录操作函数"><a href="#4-7-目录操作函数" class="headerlink" title="4.7 目录操作函数"></a>4.7 目录操作函数</h3><p><img src="https://img-blog.csdnimg.cn/7f04549c167645a78739282ec94bc75c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       mkdir<span class="token punctuation">,</span> mkdirat <span class="token operator">-</span> create a directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>       DESCRIPTION       <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> attempts to 【create a directory】 named pathname<span class="token punctuation">.</span>       The  argument  mode  specifies the mode <span class="token keyword">for</span> the new directory<span class="token punctuation">.</span>  It is modified by the process's umask in the usual way<span class="token operator">:</span> in the absence of a <span class="token keyword">default</span> ACL<span class="token punctuation">,</span> the mode of the created directory <span class="token function">is</span> <span class="token punctuation">(</span>【mode <span class="token operator">&amp;</span> <span class="token operator">~</span>umask <span class="token operator">&amp;</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">.</span>          Whether  other  mode bits are honored <span class="token keyword">for</span> the created directory depends on the operating system<span class="token punctuation">.</span>       The newly created directory will be owned by the effective user ID of the process<span class="token punctuation">.</span>  If the directory  containing  the file has the set<span class="token operator">-</span>group<span class="token operator">-</span>ID bit set<span class="token punctuation">,</span> or <span class="token keyword">if</span> the filesystem is mounted with BSD group <span class="token function">semantics</span> <span class="token punctuation">(</span>mount <span class="token operator">-</span>o grpid<span class="token punctuation">)</span><span class="token punctuation">,</span> the new directory will inherit the group ownership from  its  parent<span class="token punctuation">;</span> otherwise it will be owned by the effective group ID of the process<span class="token punctuation">.</span>       If the parent directory has the set<span class="token operator">-</span>group<span class="token operator">-</span>ID bit set<span class="token punctuation">,</span> then so will the newly created directory<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-6"><a href="#测试代码-6" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">mkdir</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// argv[1]是文件名，0664是文件的权限</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkdir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"make a directory '%s' successfully!\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/0ab1c3a42d9246d5bd2e77eac4c93dcb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="rename"><a href="#rename" class="headerlink" title="rename"></a>rename</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       rename<span class="token punctuation">,</span> renameat<span class="token punctuation">,</span> renameat2 <span class="token operator">-</span> change the name or location of a fileSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>oldpath<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>newpath<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  renames  a  file<span class="token punctuation">,</span> moving it between directories <span class="token keyword">if</span> required<span class="token punctuation">.</span>  Any other  【hard links】 to the file  are 【unaffected】<span class="token punctuation">.</span>  【Open file descriptors <span class="token keyword">for</span> oldpath】 are also 【unaffected】<span class="token punctuation">.</span>       Various restrictions determine whether or not the rename operation succeeds<span class="token operator">:</span> see ERRORS below<span class="token punctuation">.</span>       If newpath already exists<span class="token punctuation">,</span> it will be atomically replaced<span class="token punctuation">,</span> so that there is no point at which another  process  attempting to  access newpath will find it missing<span class="token punctuation">.</span>  However<span class="token punctuation">,</span> there will probably be a window in which both oldpath and newpath refer to the file being renamed<span class="token punctuation">.</span>       If oldpath and newpath are existing hard links referring to the same file<span class="token punctuation">,</span> then <span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span> does nothing<span class="token punctuation">,</span> and returns a  success status<span class="token punctuation">.</span>       If newpath exists but the operation fails <span class="token keyword">for</span> some reason<span class="token punctuation">,</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span> guarantees to leave an instance of newpath in place<span class="token punctuation">.</span>       oldpath can specify a directory<span class="token punctuation">.</span>  In this <span class="token keyword">case</span><span class="token punctuation">,</span> newpath must either not exist<span class="token punctuation">,</span> or it must specify an empty directory<span class="token punctuation">.</span>       If  oldpath  refers  to a symbolic link<span class="token punctuation">,</span> the link is renamed<span class="token punctuation">;</span> <span class="token keyword">if</span> newpath refers to a symbolic link<span class="token punctuation">,</span> the link will be overwritten<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-7"><a href="#测试代码-7" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">"987"</span><span class="token punctuation">,</span> <span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"rename"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/9224a038315a424086f9188ed2608221.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="rmdir"><a href="#rmdir" class="headerlink" title="rmdir"></a>rmdir</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       rmdir <span class="token operator">-</span> delete a directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> deletes a directory<span class="token punctuation">,</span> which 【must be empty】<span class="token punctuation">.</span>RETURN VALUE       On success<span class="token punctuation">,</span> zero is returned<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-8"><a href="#测试代码-8" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.hz&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"rmdir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/37687eff84034a51aa78cd6a00b9f5e5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="getcwd"><a href="#getcwd" class="headerlink" title="getcwd"></a>getcwd</h5><p>获取当前工作目录。</p><ul><li><p>buf：传出参数，指向一个数组，存工作路径</p></li><li><p>size：数组大小</p></li><li><p>return value：指针，指向一块内存，存的是工作路径，内容和buf一样</p></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       getcwd<span class="token punctuation">,</span> getwd<span class="token punctuation">,</span> get_current_dir_name <span class="token operator">-</span> get current working directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getwd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">get_current_dir_name</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       These  functions  <span class="token keyword">return</span> a null<span class="token operator">-</span>terminated string containing 【an absolute pathname】 that is the current working directory of the calling process<span class="token punctuation">.</span>  The pathname is returned as the function 【result】 and via the argument 【buf】<span class="token punctuation">,</span> <span class="token keyword">if</span> present<span class="token punctuation">.</span>       The <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function copies an absolute pathname of the current working directory to the array pointed to by  buf<span class="token punctuation">,</span>  which is of length size<span class="token punctuation">.</span>       If the length of the absolute pathname of the current working directory<span class="token punctuation">,</span> including the terminating null byte<span class="token punctuation">,</span> exceeds size bytes<span class="token punctuation">,</span> <span class="token constant">NULL</span> is returned<span class="token punctuation">,</span> and errno is set to ERANGE<span class="token punctuation">;</span> an application should check <span class="token keyword">for</span> this error<span class="token punctuation">,</span>  and  allocate  a  larger buffer <span class="token keyword">if</span> necessary<span class="token punctuation">.</span>       As  an extension to the POSIX<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">2001</span> standard<span class="token punctuation">,</span> glibc's <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> allocates the buffer dynamically using <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">if</span> buf is <span class="token constant">NULL</span><span class="token punctuation">.</span>  In this <span class="token keyword">case</span><span class="token punctuation">,</span> the allocated buffer has the length size unless size is zero<span class="token punctuation">,</span> when buf is allocated as big as  necessary<span class="token punctuation">.</span>  The caller should <span class="token function">free</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> the returned buffer<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-9"><a href="#测试代码-9" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>ret <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"getcwd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current working directory is : \n%s\n or \n%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/2c2e5de7e03a4a4d884b51d687373521.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="chdir"><a href="#chdir" class="headerlink" title="chdir"></a>chdir</h5><p>修改进程的工作目录，在哪个目录启动进程，该进程就默认工作在该目录下。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       chdir<span class="token punctuation">,</span> fchdir <span class="token operator">-</span> change working directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">int</span> <span class="token function">fchdir</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 【changes the current working directory】 of 【the calling process】 to the directory specified in path<span class="token punctuation">.</span>       <span class="token function">fchdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is identical to <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> the only difference is that the directory is given as an open file descriptor<span class="token punctuation">.</span>RETURN VALUE       On success<span class="token punctuation">,</span> zero is returned<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-10"><a href="#测试代码-10" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 获取该进程默认工作路径</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>path <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>path <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"getcwd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current working directory is : \n%s\n or \n%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 更改工作目录</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">"/home/Sakana/Mydoc/serverlearn/IO/文件操作函数/ajacentDir/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"chdir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">// 获取新工作目录</span>    <span class="token keyword">char</span> newbuf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>newPath <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>newbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>newbuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n*** change woring dir successfully! ***\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current working directory is : \n%s\n or \n%s\n"</span><span class="token punctuation">,</span> newbuf<span class="token punctuation">,</span> newPath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 在新工作目录里写点东西</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"testFile.txt"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> pbuf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                                                                         <span class="token function">sprintf</span><span class="token punctuation">(</span>pbuf<span class="token punctuation">,</span> <span class="token string">"Hello, world! I'm form %s \n Here is %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> newPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> pbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pbuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/4ab1c16fa3b8469a947de470ddb74d12.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/3e736f67598743509ee62f230f0a9499.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/ca2f9844797f488dabc82e4dea0c0835.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="4-8-目录遍历函数"><a href="#4-8-目录遍历函数" class="headerlink" title="4.8 目录遍历函数"></a>4.8 目录遍历函数</h3><p><img src="https://img-blog.csdnimg.cn/49c68acc32d34de8a79a88b12615b490.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="opendir"><a href="#opendir" class="headerlink" title="opendir"></a>opendir</h5><ul><li>name：需要打开的目录名称</li><li>return value: <ul><li>正确：<code>DIR*</code>  类型的结构体，可以理解为目录流</li><li>错误：NULL</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       opendir<span class="token punctuation">,</span> fdopendir <span class="token operator">-</span> open a directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>       DIR <span class="token operator">*</span><span class="token function">opendir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>       DIR <span class="token operator">*</span><span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       The  <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  function 【opens a directory stream】 corresponding to the directory name<span class="token punctuation">,</span> and 【returns a pointer】 to the directory stream<span class="token punctuation">.</span>  The stream is positioned at the first entry in the directory<span class="token punctuation">.</span>       The <span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function is like <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> but returns a directory stream <span class="token keyword">for</span> the directory referred to by the 【open file descriptor fd】<span class="token punctuation">.</span>  After a successful call to <span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fd is used internally by the implementation<span class="token punctuation">,</span> and should not otherwise be used by the application<span class="token punctuation">.</span>RETURN VALUE       The <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> and <span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> functions <span class="token keyword">return</span> a pointer to the directory stream<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token constant">NULL</span> is returned<span class="token punctuation">,</span>  and  errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="DIR-结构体"><a href="#DIR-结构体" class="headerlink" title="DIR 结构体"></a>DIR 结构体</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">__dirstream</span><span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token operator">*</span>__fd<span class="token punctuation">;</span> <span class="token comment">/* `struct hurd_fd' pointer for descriptor.   */</span>    <span class="token keyword">char</span> <span class="token operator">*</span>__data<span class="token punctuation">;</span> <span class="token comment">/* Directory block.   */</span>    <span class="token keyword">int</span> __entry_data<span class="token punctuation">;</span> <span class="token comment">/* Entry number `__data' corresponds to.   */</span>    <span class="token keyword">char</span> <span class="token operator">*</span>__ptr<span class="token punctuation">;</span> <span class="token comment">/* Current pointer into the block.   */</span>    <span class="token keyword">int</span> __entry_ptr<span class="token punctuation">;</span> <span class="token comment">/* Entry number `__ptr' corresponds to.   */</span>    <span class="token class-name">size_t</span> __allocation<span class="token punctuation">;</span> <span class="token comment">/* Space allocated for the block.   */</span>    <span class="token class-name">size_t</span> __size<span class="token punctuation">;</span> <span class="token comment">/* Total valid data in the block.   */</span>    <span class="token function">__libc_lock_define</span> <span class="token punctuation">(</span><span class="token punctuation">,</span> __lock<span class="token punctuation">)</span> <span class="token comment">/* Mutex lock for this structure.   */</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">__dirstream</span> DIR<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="readdir"><a href="#readdir" class="headerlink" title="readdir"></a>readdir</h5><p>读取目录中的数据，调用一次，就指向流中的下一个实体</p><ul><li>dirp:  <code>opendir函数</code> 返回的 <code>DIR*</code> 类型的结构体</li><li>return value: <ul><li>正确：<ul><li>未到末尾：<code>struct dirent</code>类型的结构体，存储读到的文件信息</li><li>末尾：NULL</li></ul></li><li>错误：NULL</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       readdir <span class="token operator">-</span> read a directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>       <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span><span class="token function">readdir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       The  <span class="token function">readdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  function  returns a pointer to a dirent structure representing the next directory entry in the directory stream pointed to by dirp<span class="token punctuation">.</span>  It returns <span class="token constant">NULL</span> on reaching the end of the directory stream or <span class="token keyword">if</span> an error occurred<span class="token punctuation">.</span>       In the glibc implementation<span class="token punctuation">,</span> the dirent structure is defined as follows<span class="token operator">:</span>           <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token punctuation">{</span>               <span class="token class-name">ino_t</span>          d_ino<span class="token punctuation">;</span>       <span class="token comment">/* Inode number */</span>               <span class="token class-name">off_t</span>          d_off<span class="token punctuation">;</span>       <span class="token comment">/* Not an offset; see below */</span>               <span class="token keyword">unsigned</span> <span class="token keyword">short</span> d_reclen<span class="token punctuation">;</span>    <span class="token comment">/* Length of this record */</span>               <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  d_type<span class="token punctuation">;</span>      <span class="token comment">/* Type of file; not supported                                              by all filesystem types */</span>               <span class="token keyword">char</span>           d_name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Null-terminated filename */</span>           <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/1e6528686aa04ffb8ad7d40e58475dbd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="closedir"><a href="#closedir" class="headerlink" title="closedir"></a>closedir</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       closedir <span class="token operator">-</span> close a directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">closedir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       The <span class="token function">closedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function closes the directory stream associated with dirp<span class="token punctuation">.</span>  A successful call to <span class="token function">closedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> also closes the underlying file descriptor associated with dirp<span class="token punctuation">.</span>  The directory stream descriptor dirp is not available after this call<span class="token punctuation">.</span>RETURN VALUE       The <span class="token function">closedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function returns <span class="token number">0</span> on success<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-计算某个目录下文件的个数"><a href="#测试代码-计算某个目录下文件的个数" class="headerlink" title="测试代码 (计算某个目录下文件的个数)"></a>测试代码 (计算某个目录下文件的个数)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s pathname\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The total num of files is: %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 打开目录</span>    DIR <span class="token operator">*</span>dir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>dir <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"opendir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2.记录普通文件个数</span>    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ptr <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 判断是否为. 或 ..</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token comment">// 如果是目录，需要递归计算</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_type <span class="token operator">==</span> DT_DIR<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">char</span> newpath<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token function">sprintf</span><span class="token punctuation">(</span>newpath<span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>            cnt <span class="token operator">+=</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span>newpath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 如果是普通文件，计算</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_type <span class="token operator">==</span> DT_REG<span class="token punctuation">)</span> <span class="token operator">++</span> cnt<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3.关闭文件</span>    <span class="token function">closedir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> cnt<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-9-dup-amp-dup2-system-call"><a href="#4-9-dup-amp-dup2-system-call" class="headerlink" title="4.9 dup &amp; dup2 system call"></a>4.9 dup &amp; dup2 system call</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       dup<span class="token punctuation">,</span> dup2<span class="token punctuation">,</span> dup3 <span class="token operator">-</span> duplicate a file descriptorSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">int</span> <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span>             <span class="token comment">/* See feature_test_macros(7) */</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span>              <span class="token comment">/* Obtain O_* constant definitions */</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">dup3</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       The  <span class="token function">dup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  system call 【creates a copy of the file descriptor oldfd】<span class="token punctuation">,</span> using the 【lowest<span class="token operator">-</span>numbered】 unused file de‐       scriptor <span class="token keyword">for</span> the new descriptor<span class="token punctuation">.</span>       After a successful <span class="token keyword">return</span><span class="token punctuation">,</span> the old and new file descriptors may be used interchangeably<span class="token punctuation">.</span>  They  refer  to  the same open file description and thus share file offset and file status flags<span class="token punctuation">;</span> <span class="token keyword">for</span> example<span class="token punctuation">,</span> <span class="token keyword">if</span> the  file offset is modified by using <span class="token function">lseek</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> on one of the file descriptors<span class="token punctuation">,</span> the offset is also changed  <span class="token keyword">for</span>  the other<span class="token punctuation">.</span>       The  two file descriptors <span class="token keyword">do</span> not share file descriptor <span class="token function">flags</span> <span class="token punctuation">(</span>the close<span class="token operator">-</span>on<span class="token operator">-</span>exec flag<span class="token punctuation">)</span><span class="token punctuation">.</span>  The close<span class="token operator">-</span>on<span class="token operator">-</span>exec <span class="token function">flag</span> <span class="token punctuation">(</span>FD_CLOEXEC<span class="token punctuation">;</span> see <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> the duplicate descriptor is off<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="dup"><a href="#dup" class="headerlink" title="dup"></a>dup</h5><p>复制文件描述符</p><p>从空闲的文件描述符中找一个新的作为新的文件描述符</p><p>和旧的一起指向同一个文件</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="测试代码-11"><a href="#测试代码-11" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 创建一个文件描述符</span>    <span class="token keyword">int</span> oldFd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>oldFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 拷贝文件描述符 oldFd -&gt; newFd</span>    <span class="token keyword">int</span> newFd <span class="token operator">=</span> <span class="token function">dup</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"oldFd: %d, newFd: %d\n"</span><span class="token punctuation">,</span> oldFd<span class="token punctuation">,</span> newFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 关闭旧的文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 新的仍然可以操作这个文件</span>    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, World!\n"</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>newFd<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>newFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/e9f6ca0932a64e6eb25fb1aaf35b5d73.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==">可以发现两个不同的文件描述符 3，4 指向的是同一个文件。</p><h5 id="dup2"><a href="#dup2" class="headerlink" title="dup2"></a>dup2</h5><p>重定向文件描述符</p><p>oldfd 指向 a.txt, newfd 指向 b.txt</p><p>调用dup2之后，相当于(close, newfd, b.txt), newfd指向a.txt</p><p>oldfd == newfd，相当于什么都没做</p><p>对于返回值没必要close, newfd 和 return value相同，如果成功。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="测试代码-12"><a href="#测试代码-12" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                                                                           <span class="token punctuation">{</span>    <span class="token keyword">int</span> oldFd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>oldFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> newFd <span class="token operator">=</span> <span class="token function">dup2</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"oldFd: %d, newFd: %d\n"</span><span class="token punctuation">,</span> oldFd<span class="token punctuation">,</span> newFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, World!\n"</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-10-fcntl"><a href="#4-10-fcntl" class="headerlink" title="4.10 fcntl"></a>4.10 fcntl</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       fcntl <span class="token operator">-</span> manipulate file descriptorSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  performs  one of the operations described below on the open file descriptor fd<span class="token punctuation">.</span>  The operation is determined by cmd<span class="token punctuation">.</span>       <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> can take an optional third argument<span class="token punctuation">.</span>  Whether or not this argument is required is determined  by  cmd<span class="token punctuation">.</span> The  required  argument type is indicated in parentheses after each cmd <span class="token function">name</span> <span class="token punctuation">(</span>in most cases<span class="token punctuation">,</span> the required type is <span class="token keyword">int</span><span class="token punctuation">,</span> and we identify the argument using the name arg<span class="token punctuation">)</span><span class="token punctuation">,</span> or <span class="token keyword">void</span> is specified <span class="token keyword">if</span>  the  argument  is  not  required<span class="token punctuation">.</span>       Certain  of  the  operations  below are supported only since a particular Linux kernel version<span class="token punctuation">.</span>  The preferred method of checking whether the host kernel supports a particular operation is to invoke <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> with  the  desired  cmd value and then test whether the call failed with EINVAL<span class="token punctuation">,</span> indicating that the kernel does not recognize this value<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>fd：文件描述符</li><li>cmd：命令（宏）<ul><li>F_DUPFD (int)<ul><li><p>复制文件描述符，复制第一个参数fd并通过return value返回新的文件描述符</p></li><li><p>用法：newfd = fcntl (fd, F_DUPFD);</p></li></ul></li><li>F_GETFL (void)<ul><li>获取文件状态 flag （和open函数传递的flag是同一个东西）</li><li>用法：</li></ul></li><li>F_SETFL (int)<ul><li><p>设置文件状态 flag</p></li><li><p>access mode 不可修改 O_RDONLY,  O_WRONLY, O_RDWR ， creation flags 也不可修改</p></li><li><p>可选项：O_APPEND（追加数据）, O_NONBLOCK（设置成非阻塞）</p></li></ul></li></ul></li><li>可变参数</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">Duplicating a file descriptor           <span class="token function">F_DUPFD</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>           Duplicate the file descriptor fd using the lowest<span class="token operator">-</span>numbered available file descriptor greater than or equal to  arg<span class="token punctuation">.</span>       This is different from <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> which uses exactly the file descriptor specified<span class="token punctuation">.</span>       On success<span class="token punctuation">,</span> the new file descriptor is returned<span class="token punctuation">.</span>       As  <span class="token keyword">for</span>  F_DUPFD<span class="token punctuation">,</span>  but  additionally set the close<span class="token operator">-</span>on<span class="token operator">-</span>exec flag <span class="token keyword">for</span> the duplicate file descriptor<span class="token punctuation">.</span>  Specifying this flag permits a program to avoid an additional <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> F_SETFD operation to set the FD_CLOEXEC flag<span class="token punctuation">.</span>  For an  explanation of why this flag is useful<span class="token punctuation">,</span> see the description of O_CLOEXEC in <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>           File status flags           Each  open  file description has certain associated status flags<span class="token punctuation">,</span> initialized by <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> and possibly modified by <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> Duplicated file <span class="token function">descriptors</span> <span class="token punctuation">(</span>made with <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>F_DUPFD<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> etc<span class="token punctuation">.</span><span class="token punctuation">)</span> refer to the same open file description<span class="token punctuation">,</span> and thus share the same file status flags<span class="token punctuation">.</span>       The file status flags and their semantics are described in <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token function">F_GETFL</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>           <span class="token function">Return</span> <span class="token punctuation">(</span>as the function result<span class="token punctuation">)</span> the file access mode and the file status flags<span class="token punctuation">;</span> arg is ignored<span class="token punctuation">.</span>       <span class="token function">F_SETFL</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>           Set  the  file  status flags to the value specified by arg<span class="token punctuation">.</span>  File access <span class="token function">mode</span> <span class="token punctuation">(</span>O_RDONLY<span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span> and file creation <span class="token function">flags</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> O_CREAT<span class="token punctuation">,</span> O_EXCL<span class="token punctuation">,</span> O_NOCTTY<span class="token punctuation">,</span> O_TRUNC<span class="token punctuation">)</span> in arg are ignored<span class="token punctuation">.</span>         On Linux<span class="token punctuation">,</span> this  command  can  change only  the  【O_APPEND<span class="token punctuation">,</span>  O_ASYNC<span class="token punctuation">,</span> O_DIRECT<span class="token punctuation">,</span> O_NOATIME<span class="token punctuation">,</span> and O_NONBLOCK flags】<span class="token punctuation">.</span>         It is not possible to change the O_DSYNC and O_SYNC flags<span class="token punctuation">;</span> see BUGS<span class="token punctuation">,</span> below<span class="token punctuation">.</span>                  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span>           <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="阻塞-amp-非阻塞"><a href="#阻塞-amp-非阻塞" class="headerlink" title="阻塞 &amp; 非阻塞"></a>阻塞 &amp; 非阻塞</h5><p>描述的是函数的行为。</p><p><code>阻塞</code>，在调用结果返回前，当前线程会被挂起，并在得到结果之后返回。 </p><p>​            终端等待我们输入的时候就是阻塞的。</p><p><code>非阻塞</code>，如果不能立刻得到结果，则该调用者不会阻塞当前线程。</p><p>​            在终端，我们输入好命令后进程执行期间是不阻塞的。</p><h5 id="测试代码-13"><a href="#测试代码-13" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 打开文件</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 获取文件状态 flag</span>    <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fcntl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>         <span class="token comment">// 设置文件状态 flag</span>    flag <span class="token operator">|=</span> O_APPEND<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fcntl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 写数据</span>    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, fcntl\n"</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/70a468d4bdde45c48ac474745884e6ca.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="flag |= O_APPEND, 会在文件末尾追加"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/9cd9c3d4d9fc4acd9306b8356e9f652b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="flag 不和 O_APPEND做按位与，直接覆盖重写"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;文件IO&quot;&gt;&lt;a href=&quot;#文件IO&quot; class=&quot;headerlink&quot; title=&quot;文件IO&quot;&gt;&lt;/a&gt;文件IO&lt;/h1&gt;&lt;h3 id=&quot;输入输出是相对的&quot;&gt;&lt;a href=&quot;#输入输出是相对的&quot; class=&quot;headerlink&quot; title=&quot;输</summary>
      
    
    
    
    <category term="系统编程" scheme="https://sakkana.github.io/categories/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/"/>
    
    
    <category term="C/C++" scheme="https://sakkana.github.io/tags/C-C/"/>
    
  </entry>
  
  <entry>
    <title>openGL - Hello Triangle</title>
    <link href="https://sakkana.github.io/2022/04/03/openGL%20-%20Hello%20Triangle/"/>
    <id>https://sakkana.github.io/2022/04/03/openGL%20-%20Hello%20Triangle/</id>
    <published>2022-04-03T12:36:01.000Z</published>
    <updated>2022-04-03T12:41:27.507Z</updated>
    
    <content type="html"><![CDATA[<h3 id="打印一个三角形"><a href="#打印一个三角形" class="headerlink" title="打印一个三角形"></a>打印一个三角形</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;glad/glad.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;GLFW/glfw3.h&gt;</span></span><span class="token keyword">void</span> <span class="token function">framebuffer_size_callback</span><span class="token punctuation">(</span>GLFWwindow<span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">processInput</span><span class="token punctuation">(</span>GLFWwindow<span class="token operator">*</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 顶点着色器源码</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> vertexShaderSource <span class="token operator">=</span> <span class="token string">"#version 330 core\n"</span><span class="token string">"layout (location = 0) in vec3 aPos;\n"</span><span class="token string">"void main()\n"</span><span class="token string">"{\n"</span><span class="token string">"gl_Position = vec4(aPos.x, aPos.y, aPos.z, 1.0);\n"</span><span class="token string">"}\0"</span><span class="token punctuation">;</span><span class="token comment">// 片段着色器源码</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fragmentShaderSource <span class="token operator">=</span> <span class="token string">"#version 330 core\n"</span><span class="token string">"out vec4 FragColor;\n"</span><span class="token string">"void main()\n"</span><span class="token string">"{\n"</span><span class="token string">"FragColor = vec4(1.0f, 0.5f, 0.2f, 1.0f);\n"</span><span class="token string">"}\0"</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">glfwInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_CONTEXT_VERSION_MAJOR<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_CONTEXT_VERSION_MINOR<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_OPENGL_PROFILE<span class="token punctuation">,</span> GLFW_OPENGL_CORE_PROFILE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建窗口对象</span>GLFWwindow<span class="token operator">*</span> window <span class="token operator">=</span> <span class="token function">glfwCreateWindow</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token string">"Hello,openGL"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>window <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to create GLFW window"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span><span class="token function">glfwTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">glfwMakeContextCurrent</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 初始化GLAD(管理OpenGL的函数指针)</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">gladLoadGLLoader</span><span class="token punctuation">(</span><span class="token punctuation">(</span>GLADloadproc<span class="token punctuation">)</span>glfwGetProcAddress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to initialize GLAD"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span>    <span class="token comment">// 告诉openGL渲染窗口的尺寸大小</span><span class="token function">glViewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwSetFramebufferSizeCallback</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> framebuffer_size_callback<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//  ********************* start painting**************************</span>    <span class="token comment">// 顶点数据</span><span class="token keyword">float</span> vertices<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 顶点着色器</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> vertexShader <span class="token operator">=</span> <span class="token function">glCreateShader</span><span class="token punctuation">(</span>GL_VERTEX_SHADER<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glShaderSource</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>vertexShaderSource<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glCompileShader</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 片段着色器</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fragmentShader <span class="token operator">=</span> <span class="token function">glCreateShader</span><span class="token punctuation">(</span>GL_FRAGMENT_SHADER<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glShaderSource</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fragmentShaderSource<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glCompileShader</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 链接程序对象</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> shaderProgram <span class="token operator">=</span> <span class="token function">glCreateProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glAttachShader</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glAttachShader</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glLinkProgram</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 删除着色器</span><span class="token function">glDeleteShader</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glDeleteShader</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 管理内存</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> VBO<span class="token punctuation">;</span><span class="token function">glGenBuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>VBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> VBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> GL_STATIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> VAO<span class="token punctuation">;</span><span class="token function">glGenVertexArrays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>VAO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>VAO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 链接顶点属性</span><span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 解绑，但是没有太搞懂</span><span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//  ********************* end painting ***************************</span>    <span class="token comment">// 渲染循环</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">glfwWindowShouldClose</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">// input</span><span class="token function">processInput</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// redering commands</span><span class="token function">glClearColor</span><span class="token punctuation">(</span><span class="token number">0.2f</span><span class="token punctuation">,</span> <span class="token number">0.3f</span><span class="token punctuation">,</span> <span class="token number">0.3f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// My paints</span><span class="token function">glUseProgram</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>VAO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// [ swap the buffers ] and [ check and call events ]</span><span class="token function">glfwSwapBuffers</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwPollEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">glDeleteVertexArrays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>VAO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glDeleteVertexArrays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>VBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glDeleteProgram</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// 回调函数，会在每次窗口大小被调整的时候被调用</span><span class="token keyword">void</span> <span class="token function">framebuffer_size_callback</span><span class="token punctuation">(</span>GLFWwindow<span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">glViewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// 处理输入事件</span><span class="token keyword">void</span> <span class="token function">processInput</span><span class="token punctuation">(</span>GLFWwindow<span class="token operator">*</span> window<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">glfwGetKey</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> GLFW_KEY_ESCAPE<span class="token punctuation">)</span> <span class="token operator">==</span> GLFW_PRESS<span class="token punctuation">)</span><span class="token function">glfwSetWindowShouldClose</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="检测着色器是否编译成功"><a href="#检测着色器是否编译成功" class="headerlink" title="检测着色器是否编译成功"></a>检测着色器是否编译成功</h5><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span>  success<span class="token punctuation">;</span><span class="token keyword">char</span> infoLog<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">glGetShaderiv</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> GL_COMPILE_STATUS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">glGetShaderInfoLog</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> infoLog<span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ERROR::SHADER::VERTEX::COMPILATION_FAILED\n"</span> <span class="token operator">&lt;&lt;</span> infoLog <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="检测着色器程序是否链接成功"><a href="#检测着色器程序是否链接成功" class="headerlink" title="检测着色器程序是否链接成功"></a>检测着色器程序是否链接成功</h5><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span>  success<span class="token punctuation">;</span><span class="token keyword">char</span> infoLog<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">glGetProgramiv</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">,</span> GL_LINK_STATUS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">glGetProgramInfoLog</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> infoLog<span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ERROR::SHADER::PROGRAM::LINKING_FAILED\n"</span> <span class="token operator">&lt;&lt;</span> infoLog <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;打印一个三角形&quot;&gt;&lt;a href=&quot;#打印一个三角形&quot; class=&quot;headerlink&quot; title=&quot;打印一个三角形&quot;&gt;&lt;/a&gt;打印一个三角形&lt;/h3&gt;&lt;pre class=&quot;line-numbers language-cpp&quot; data-language=</summary>
      
    
    
    
    <category term="图形学" scheme="https://sakkana.github.io/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6/"/>
    
    
    <category term="openGL" scheme="https://sakkana.github.io/tags/openGL/"/>
    
  </entry>
  
  <entry>
    <title>GDB</title>
    <link href="https://sakkana.github.io/2022/03/29/GDB/"/>
    <id>https://sakkana.github.io/2022/03/29/GDB/</id>
    <published>2022-03-29T13:08:01.000Z</published>
    <updated>2022-03-30T12:11:40.291Z</updated>
    
    <content type="html"><![CDATA[<h1 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h1><p><img src="https://img-blog.csdnimg.cn/2cc702f15c6148e2b87dd15223fb38dc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="gdb介绍"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/3ec36ad4d2264fdabdcda7c216f93a64.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="准备工作"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/448b8c24f61641eb8f9b3ed1289076ef.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="命令"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/a37c85543df5489aaeab1728c6234617.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="断点"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/527413ac06994139b4aa5791c6cfd3c0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="调试命令"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>程序停在那里，并没有执行，s继续执行下一步，断点才会执行</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;GDB&quot;&gt;&lt;a href=&quot;#GDB&quot; class=&quot;headerlink&quot; title=&quot;GDB&quot;&gt;&lt;/a&gt;GDB&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://img-blog.csdnimg.cn/2cc702f15c6148e2b87dd15223fb</summary>
      
    
    
    
    <category term="系统编程" scheme="https://sakkana.github.io/categories/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/"/>
    
    
    <category term="C/C++" scheme="https://sakkana.github.io/tags/C-C/"/>
    
  </entry>
  
  <entry>
    <title>Makefile</title>
    <link href="https://sakkana.github.io/2022/03/28/Makefile/"/>
    <id>https://sakkana.github.io/2022/03/28/Makefile/</id>
    <published>2022-03-28T12:44:01.000Z</published>
    <updated>2022-03-28T16:56:09.989Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h1><h3 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1.介绍"></a>1.介绍</h3><p><img src="https://img-blog.csdnimg.cn/bfb19f9684554c6d9074ef5abaadb604.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="介绍"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="2-Makefile文件命名和规则"><a href="#2-Makefile文件命名和规则" class="headerlink" title="2.Makefile文件命名和规则"></a>2.Makefile文件命名和规则</h3><p><img src="https://img-blog.csdnimg.cn/d3538800de0c46779ca2fbde831bf992.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="命名和规则"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="><img src="https://img-blog.csdnimg.cn/3839ec0d23114a4594122ef16da387c9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="Makefile - 1"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="3-工作原理"><a href="#3-工作原理" class="headerlink" title="3.工作原理"></a>3.工作原理</h3><p><img src="https://img-blog.csdnimg.cn/da2336430809471384800d3289a517ba.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="工作原理"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>默认执行第一个规则，如果后面的规则和第一条规则没有任何联系，则不会执行</p><p>下面这么写的好处：更新哪个编译哪个</p><p>按道理来说先有依赖再有目标</p><p>如果依赖的时间比目标晚，说明依赖更新过了，因此要重新生成目标</p><p><img src="https://img-blog.csdnimg.cn/45b9be63ec674c6497482375dd93b745.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="Makefile - 2"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="4-变量"><a href="#4-变量" class="headerlink" title="4.变量"></a>4.变量</h3><p><img src="https://img-blog.csdnimg.cn/33c2665231784d61a0ecaa398592ae40.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="变量"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="5-模式匹配"><a href="#5-模式匹配" class="headerlink" title="5.模式匹配"></a>5.模式匹配</h3><p><img src="https://img-blog.csdnimg.cn/fd03f5b312054d0ea80725ee3a068422.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="模式匹配"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/aebee0339eb44aa2b352a7f8fda2459e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="Makefile - 3"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="6-函数"><a href="#6-函数" class="headerlink" title="6.函数"></a>6.函数</h3><p><img src="https://img-blog.csdnimg.cn/51cfdddf2ed44c09ade1afebcafc2de3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="函数"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/f3818cf1ca504aaca52b02941a855a5a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="函数"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/6038ca2aa5244a0b9c65159ce47fc967.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="Makefile - 4"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>不加.PHONY的话如果外面有clean文件会冲突，因为clean永远是最新的</p><p>make clean命令可以删除所有的.o文件</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Makefile&quot;&gt;&lt;a href=&quot;#Makefile&quot; class=&quot;headerlink&quot; title=&quot;Makefile&quot;&gt;&lt;/a&gt;Makefile&lt;/h1&gt;&lt;h3 id=&quot;1-介绍&quot;&gt;&lt;a href=&quot;#1-介绍&quot; class=&quot;headerlink&quot; </summary>
      
    
    
    
    <category term="系统编程" scheme="https://sakkana.github.io/categories/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/"/>
    
    
    <category term="C/C++" scheme="https://sakkana.github.io/tags/C-C/"/>
    
  </entry>
  
  <entry>
    <title>gcc/库的制作</title>
    <link href="https://sakkana.github.io/2022/03/24/gcc&amp;%E5%BA%93%E7%9A%84%E5%88%B6%E4%BD%9C/"/>
    <id>https://sakkana.github.io/2022/03/24/gcc&amp;%E5%BA%93%E7%9A%84%E5%88%B6%E4%BD%9C/</id>
    <published>2022-03-24T11:34:01.000Z</published>
    <updated>2022-03-28T12:43:06.812Z</updated>
    
    <content type="html"><![CDATA[<h2 id="GCC-教程"><a href="#GCC-教程" class="headerlink" title="GCC 教程"></a>GCC 教程</h2><h3 id="gcc"><a href="#gcc" class="headerlink" title="gcc ="></a>gcc =</h3><p>​            GNU C Compiler (GNU C语言编译器)</p><p>​            GNU Compiler Collection (GNU 编译器套件)</p><h3 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h3><p>gcc /g++ –version</p><p>gcc/g++ -v</p><table><thead><tr><th>参数</th><th>作用</th><th>结果</th></tr></thead><tbody><tr><td>-E</td><td>预处理(头文件展开，宏替换，删除注释…)</td><td>.i</td></tr><tr><td>-S</td><td>预处理，编译(原代码 —&gt; 汇编码)</td><td>.s</td></tr><tr><td>-c</td><td>预处理，编译，汇编(汇编码 —&gt; 机器码)</td><td>.o</td></tr><tr><td>-o</td><td>生成目标文件</td><td></td></tr></tbody></table><h3 id="gcc-or-g"><a href="#gcc-or-g" class="headerlink" title="gcc or g++?"></a>gcc or g++?</h3><ul><li><p>预处理阶段</p><p>g++会调用gcc，因此gcc/g++都可以预处理c/c++代码。</p></li><li><p>编译，汇编，链接阶段</p><p>分家吧。 但是g++兼容c。</p></li></ul><p>事实上，只是gcc无法链接c++的库，因此链接阶段要用g++或者gcc后面加上-lstdc++。</p><p>为了方便，我们还是各用各的吧。</p><h2 id="库"><a href="#库" class="headerlink" title="库"></a>库</h2><p><code>库文件</code>：</p><p>​    计算机上的一类文件，可以看作一种仓库代码，提供给使用者一些可以直接拿来用的变量、函数或类。</p><p>​    库文件有两种：</p><ul><li>静态库：在程序<code>链接阶段</code>被复制到程序中</li><li>动态库(共享库)：在<code>运行时</code>由系统动态加载到内存中供程序使用</li></ul><p><code>库</code>：</p><p>​    一种特殊的程序，编写库程序和普通程序区别不大，只是库<code>不能单独运行</code>。</p><p>库的作用：1.代码保密   2.方便部署和分发</p><h3 id="静态库的制作"><a href="#静态库的制作" class="headerlink" title="静态库的制作"></a>静态库的制作</h3><h4 id="Linux-libxxx-a"><a href="#Linux-libxxx-a" class="headerlink" title="Linux : libxxx.a"></a>Linux : libxxx.a</h4><p>​        lib : 前缀（固定）</p><p>​        xxx：库的名字，自己起</p><p>​        .a：后缀（固定）</p><ul><li><p>gcc 获得 .o文件</p><pre class="line-numbers language-gcc" data-language="gcc"><code class="language-gcc">gcc -c a.c b.c ...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>将 .o 文件打包，利用 ar 工具 （archive）</p><pre class="line-numbers language-gcc" data-language="gcc"><code class="language-gcc">ar rcs libxxx.a a.o b.o ...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><blockquote><p>r - 将文件插入备存文件中</p><p>c - 建立备存文件</p><p>s - 索引</p></blockquote><h4 id="静态库制作流程"><a href="#静态库制作流程" class="headerlink" title="静态库制作流程"></a>静态库制作流程</h4><h5 id="1-写好库中的代码并生成静态库"><a href="#1-写好库中的代码并生成静态库" class="headerlink" title="1. 写好库中的代码并生成静态库"></a>1. 写好库中的代码并生成静态库</h5><p>该库只包含四个简单的函数：add, sub, multi,div</p><p>此外，还有个head.h包含这四个函数的声明</p><p>还有个main.c用于测试</p><p><img src="https://img-blog.csdnimg.cn/b78289ecdca6450f8eebe8ba982c284c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="所需文件"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这部分代码如下</p><p><img src="https://img-blog.csdnimg.cn/b83e724ebcc2464a9e6cb3c04a624bef.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="所需文件代码"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>生成静态库需要用到四个库函数的.o文件(.o文件经过链接之后就生成了可执行文件)</p><p><img src="https://img-blog.csdnimg.cn/09bdbb84715943c7a30b2f5e7e8bf5bb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="生成.o文件"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>再执行ar rcs命令，借助archive工具将.o文件打包成静态库，得到libcalc.a文件</p><p><img src="https://img-blog.csdnimg.cn/87772b41cacf45309e2439595f12ce4c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="libcalc.a"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="2-创建使用这个库的目录"><a href="#2-创建使用这个库的目录" class="headerlink" title="2.创建使用这个库的目录"></a>2.创建使用这个库的目录</h5><p>这个库的目录层次如下：</p><p><img src="https://img-blog.csdnimg.cn/0620b295ac01404e86706043d83777ea.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_10,color_FFFFFF,t_70,g_se,x_16" alt="目录层次"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这时万事俱备，只需要编译该main.c就可以运行了</p><p>然后，事情总不会这么顺利</p><p><img src="https://img-blog.csdnimg.cn/8289779ec6924d68bdea48520abd37ba.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="直接gcc编译"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>gcc会报错找不到head.h文件</p><p>原因是main.c位于.目录，即当前目录, 而head.h在include目录下，</p><p>在main.c中#include “head.h”导入的是相对路径，因此gcc找不到这个头文件</p><p>解决办法有二：</p><ul><li>将head.h与main.c置于同一个目录下</li><li>利用-I（大写i） dir<br>　　在你是用#include”file”的时候,gcc/g++会先在当前目录查找你所制定的头文件,如果没有找到,他回到缺省的头文件目录找,如果使用-I制定了目录,他会先在你所制定的目录查找,然后再按常规的顺序去找.<br>  　　对于#include<file>,gcc/g++会到-I制定的目录查找,查找不到,然后将到系统的缺省的头文件目录查找 </file></li></ul><p>这里采用第二种</p><p>然而，这样子还会报错，因为gcc找不到calc这个库</p><ul><li>-l（小写L） library （库的名字，不是库文件的名字）<br>　　制定编译的时候使用的库<br>  　　例子用法 ： gcc -l curses hello.c  —&gt; 使用ncurses库编译程序 </li></ul><ul><li><p>-L dir<br>　　制定编译的时候，搜索库的路径。</p><p>​        比如你自己的库，可以用它制定目录，不然编译器将只在标准库的目录找。这个dir就是目录的名称。 </p></li></ul><p><img src="https://img-blog.csdnimg.cn/6857841f045f4a698c315cdfb01729c5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="链接静态库编译"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="动态库的制作"><a href="#动态库的制作" class="headerlink" title="动态库的制作"></a>动态库的制作</h3><h4 id="Linux-libxxx-so"><a href="#Linux-libxxx-so" class="headerlink" title="Linux : libxxx.so"></a>Linux : libxxx.so</h4><blockquote><p>windows: libxxx.dll</p></blockquote><ul><li><p>gcc 得到 .o 文件，得到和<code>位置无关</code>的代码</p><p>静态库链接时代码的位置已经固定，加载到内存中，但是动态库并不知道什么时候加载，加载到内存哪里</p><pre class="line-numbers language-gcc" data-language="gcc"><code class="language-gcc">  gcc -c fpic/fPIC a.c b.c* gcc 得到动态库  ```gcc  gcc -shared a.o b.o -o libxxx.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>前面的制作过程和静态库大同小异，唯一的区别就是命令不同</p><p>然而当我们做好动态库之后，却运行不了可执行文件，说找不到libcalc.so这个动态库</p><p><img src="https://img-blog.csdnimg.cn/e5fa1282b5334250a21a1282ff285a4e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="ERROR"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>使用 ldd 命令检查<code>动态库依赖关系</code></p><p>可以看到 libcalc.so 这个动态库对应的结果是 not found</p><p><img src="https://img-blog.csdnimg.cn/a4a2b72896dc4e05862fa178f40028da.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="ldd"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这就涉及到动态库的实现原理了</p><p>链接时，只有信息信息会被放入可执行程序，但是具体的代码却不会放入可执行程序</p><p>只有在调用库中某个api的时候才会去获取动态库的绝对路径</p><p><img src="https://img-blog.csdnimg.cn/3bca6981a23747998e5cf4fc645fc7ad.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="动态库工作原理"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><p>终端实际上也是一个应用程序</p><p>输入指令 ls 之后，<code>shell解析器</code> 解析该指令</p><p>shell解析器根据环境变量找到这条指令的路径</p><p>使用 <code>env</code> 指令可以查看所有的环境变量</p><p>里面都是一些键值对</p><p>key - value</p><p>key - value1 : value2 : value3 ….</p><p>每一个value都是一条路径</p><p>value1找不到该命令，就去value2找，再找不到再去value3找…</p><p>因此，要想运行动态库，要先配置环境变量</p><p>使用env命令可以查看所有环境变量</p><p><img src="https://img-blog.csdnimg.cn/f1c8c1a07b764a269b1de3ff0e6fbcd3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="查看环境变量"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>找到动态库的绝对路径，并将其配置到LD_LIBRARY_PATH下</p><p><img src="https://img-blog.csdnimg.cn/9ef519cf65bb4c0b8044e186b7fc5327.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="配置环境变量"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>此时使用 <code>ldd</code> 便可以看到该可执行程序已经可以找到动态库的绝对路径了</p><p>直接运行，成功</p><p><img src="https://img-blog.csdnimg.cn/cba73810503d4a968c9966713f4a3c7f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="配置完成"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="然而，这样只是暂时的，关掉终端重启就失效了"><a href="#然而，这样只是暂时的，关掉终端重启就失效了" class="headerlink" title="然而，这样只是暂时的，关掉终端重启就失效了"></a>然而，这样只是暂时的，关掉终端重启就失效了</h3><h5 id="永久配置-用户级别"><a href="#永久配置-用户级别" class="headerlink" title="永久配置 - 用户级别"></a>永久配置 - 用户级别</h5><p>进入home/.bashrc, 添加配置信息</p><p><img src="https://img-blog.csdnimg.cn/21834d370b92419cbcebe13c7bafe869.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="添加配置信息"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>并用 <code>source .bash</code> 或 <code>. .bashrc</code>来激活配置文件</p><h5 id="永久配置-系统级别"><a href="#永久配置-系统级别" class="headerlink" title="永久配置 - 系统级别"></a>永久配置 - 系统级别</h5><p>进入 /etc/profile, 添加配置信息</p><p>并用 source /etc/profile激活配置文件</p><h4 id="修改-etc-ld-so-cache"><a href="#修改-etc-ld-so-cache" class="headerlink" title="修改/etc/ld.so.cache"></a>修改/etc/ld.so.cache</h4><p>进入 <code>/etc/ld.so.conf</code> ，直接将路径粘贴进去</p><p><img src="https://img-blog.csdnimg.cn/c0e0d36c39824b968ec4bdc63f01d132.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="ld.so.conf"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="最粗暴-直接将库文件放到-lib或-usr-lib目录下"><a href="#最粗暴-直接将库文件放到-lib或-usr-lib目录下" class="headerlink" title="最粗暴 - 直接将库文件放到/lib或/usr/lib目录下"></a>最粗暴 - 直接将库文件放到<code>/lib</code>或<code>/usr/lib</code>目录下</h4><p>不推荐，因为这两个目录下面原先就放了很多系统的库文件，如果把自己的放进去万一名称冲突会出带问题</p><p><img src="https://img-blog.csdnimg.cn/474f2d2865a94f5697a1ae181ad1b927.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="完整流程"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>静态库</p><p>​    链接阶段直接把<code>静态库代码</code>打包到可执行文件中</p><p>​    优点：</p><ul><li>静态库被打包到应用程序中，加载速度快</li><li>发布程序无需提供静态库，移植方便 </li></ul><p>​    缺点：</p><ul><li><p>消耗系统资源，浪费内存</p></li><li><p>更新、部署、发布麻烦</p><p><img src="https://img-blog.csdnimg.cn/2565bc00369144db93093263bc8c05bf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="占用内存"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p></li></ul><p>动态库</p><p>​    链接阶段把<code>动态库信息</code>(如动态库名称)打包到可执行文件中，可执行程序运行时找到动态库文件，并加载到内存中，使用其代码</p><p>​    优点：</p><ul><li>可以实现进程间资源共享（共享库），如果有个程序使用了动态库，该库已经加载到内存当中了，其他进程可以直接使用</li><li>更新、部署、发布简单</li><li>可以控制何时加载动态库，没有使用到不会加载</li></ul><p>​    缺点：</p><ul><li>加载速度比静态库慢</li><li>发布程序时需要提供依赖的动态库</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;GCC-教程&quot;&gt;&lt;a href=&quot;#GCC-教程&quot; class=&quot;headerlink&quot; title=&quot;GCC 教程&quot;&gt;&lt;/a&gt;GCC 教程&lt;/h2&gt;&lt;h3 id=&quot;gcc&quot;&gt;&lt;a href=&quot;#gcc&quot; class=&quot;headerlink&quot; title=&quot;gcc</summary>
      
    
    
    
    <category term="系统编程" scheme="https://sakkana.github.io/categories/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/"/>
    
    
    <category term="C/C++" scheme="https://sakkana.github.io/tags/C-C/"/>
    
  </entry>
  
  <entry>
    <title>MySql - 9 事务，并发问题</title>
    <link href="https://sakkana.github.io/2022/03/14/Mysql9%20%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98/"/>
    <id>https://sakkana.github.io/2022/03/14/Mysql9%20%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98/</id>
    <published>2022-03-14T15:51:01.000Z</published>
    <updated>2022-03-15T16:46:10.208Z</updated>
    
    <content type="html"><![CDATA[<h1 id="事务，并发问题"><a href="#事务，并发问题" class="headerlink" title="事务，并发问题"></a>事务，并发问题</h1><h3 id="事务操作"><a href="#事务操作" class="headerlink" title="事务操作"></a>事务操作</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span><span class="token comment">-- 开启事务</span><span class="token keyword">COMMIT</span><span class="token punctuation">;</span> <span class="token operator">/</span> <span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span><span class="token comment">-- 提交、回滚事务</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="事务四大特性"><a href="#事务四大特性" class="headerlink" title="事务四大特性"></a>事务四大特性</h3><ul><li><p>原子性 - 事务中的一系列操作同生共死</p></li><li><p>一致性 - 能量守恒</p></li><li><p>隔离性 - 互不干扰</p></li><li><p>持久性 - 永久写入磁盘</p></li></ul><h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p><img src="https://img-blog.csdnimg.cn/f48e1a3807ad4955adc2baf97aa1ecd0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="隔离级别"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="查看事务隔离级别"><a href="#查看事务隔离级别" class="headerlink" title="查看事务隔离级别"></a>查看事务隔离级别</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> @<span class="token variable">@TRANSACTION</span> IOSLATION<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="设置事务隔离级别"><a href="#设置事务隔离级别" class="headerlink" title="设置事务隔离级别"></a>设置事务隔离级别</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> <span class="token punctuation">[</span><span class="token keyword">SESSION</span><span class="token operator">|</span><span class="token keyword">GLOBAL</span><span class="token punctuation">]</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token punctuation">[</span>隔离级别<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;事务，并发问题&quot;&gt;&lt;a href=&quot;#事务，并发问题&quot; class=&quot;headerlink&quot; title=&quot;事务，并发问题&quot;&gt;&lt;/a&gt;事务，并发问题&lt;/h1&gt;&lt;h3 id=&quot;事务操作&quot;&gt;&lt;a href=&quot;#事务操作&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    <category term="数据库" scheme="https://sakkana.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="数据库" scheme="https://sakkana.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>Linux - 4 ssh</title>
    <link href="https://sakkana.github.io/2022/03/11/Linux4%20ssh/"/>
    <id>https://sakkana.github.io/2022/03/11/Linux4%20ssh/</id>
    <published>2022-03-11T05:54:01.000Z</published>
    <updated>2022-03-11T10:00:00.586Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;SSH&quot;&gt;&lt;a href=&quot;#SSH&quot; class=&quot;headerlink&quot; title=&quot;SSH&quot;&gt;&lt;/a&gt;SSH&lt;/h1&gt;</summary>
      
    
    
    
    <category term="Linux" scheme="https://sakkana.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://sakkana.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>MySql - 8 多表查询</title>
    <link href="https://sakkana.github.io/2022/03/10/Mysql8%20%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2/"/>
    <id>https://sakkana.github.io/2022/03/10/Mysql8%20%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2/</id>
    <published>2022-03-10T11:19:01.000Z</published>
    <updated>2022-03-10T13:53:26.692Z</updated>
    
    <content type="html"><![CDATA[<h1 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h1><h2 id="1-多表关系"><a href="#1-多表关系" class="headerlink" title="1.多表关系"></a>1.多表关系</h2><ul><li><p>一对多</p><p>案例：部门 - 员工</p><p>关系：一个员工只能归属一个部门，但一个部门可以对应多个员工</p><p>实现：在多的一方建立<code>外键</code>，指向一的一方的<code>主键</code></p></li><li><p>多对多</p><p>案例：学生 - 课程</p><p>关系：一个学生可以选修多门课程，一门课程可以供多个学生选择</p><p>实现：建立第三张<code>中间表</code>，中间表至少包含<code>两个外键</code>，分别关联两方的主键</p><h5 id="学生表"><a href="#学生表" class="headerlink" title="学生表"></a>学生表</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> student<span class="token punctuation">(</span>    id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">,</span>    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">no</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'学生表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="课程表"><a href="#课程表" class="headerlink" title="课程表"></a>课程表</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> course<span class="token punctuation">(</span>    id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'课程表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="中间表"><a href="#中间表" class="headerlink" title="中间表"></a>中间表</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> stuent_course<span class="token punctuation">(</span>  id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>  studentid <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'学生id'</span><span class="token punctuation">,</span>  courseid <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'课程id'</span><span class="token punctuation">,</span>  <span class="token keyword">constraint</span> fk_courseid <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>courseid<span class="token punctuation">)</span> <span class="token keyword">references</span> course <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">,</span>  <span class="token keyword">constraint</span> fk_studentid <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>studentid<span class="token punctuation">)</span> <span class="token keyword">references</span> student <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'学生课程中间表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/4bc81f972452447aad104167e8e44414.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="三表关系"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p></li><li><p>一对一</p><p>案例：用户 - 用户详情</p><p>关系：一对一关系，多用于<code>单表拆分</code>，将一张表的基础字段放在一张表中，其他详情字段放在另一张表中，以提升操作效率</p><p>实现：在任意一方加入<code>外键</code>，关联另外一方的<code>主键</code>，并且设置外键为唯一的(<code>UNIQUE</code>)</p><p>用户基本信息表</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> user_basic<span class="token punctuation">(</span>   id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">comment</span> <span class="token string">'主键id'</span><span class="token punctuation">,</span>   name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   age <span class="token keyword">tinyint</span> <span class="token keyword">unsigned</span><span class="token punctuation">,</span>   gender <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   phone <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'用户基本信息表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用户受教育信息</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> user_edu<span class="token punctuation">(</span>    id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span>  <span class="token keyword">comment</span> <span class="token string">'主键id'</span><span class="token punctuation">,</span>    degree <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'学历'</span><span class="token punctuation">,</span>    major <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'专业'</span><span class="token punctuation">,</span>    primary_school <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    middle_school <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    college <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    userid <span class="token keyword">int</span> <span class="token keyword">unique</span> <span class="token keyword">comment</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span> <span class="token comment">-- 唯一约束</span>    <span class="token keyword">constraint</span> fk_userid <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>userid<span class="token punctuation">)</span> <span class="token keyword">references</span> user_basic<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'用户受教育信息'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-多表查询概述"><a href="#2-多表查询概述" class="headerlink" title="2. 多表查询概述"></a>2. 多表查询概述</h2><ul><li><p>概述：从多张表中查询数据</p></li><li><p>笛卡尔积：笛卡尔积是指在数学中，两个集合-集合A和集合B<code>所有的组合情况</code>。(在多表查询是，需要消除无效的笛卡尔积)</p><p>假如直接SELECT</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp<span class="token punctuation">,</span> dept<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><p><img src="https://img-blog.csdnimg.cn/9642105a097241219dfeaab3974e276f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="笛卡尔积"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p></li></ul><h3 id="问题来了，如何消除无效的笛卡尔积？"><a href="#问题来了，如何消除无效的笛卡尔积？" class="headerlink" title="问题来了，如何消除无效的笛卡尔积？"></a>问题来了，如何消除无效的笛卡尔积？</h3><p>两个表通过dept_id来建立联系</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp<span class="token punctuation">,</span> dept <span class="token keyword">where</span> emp<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> dept<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a8d40012c6be43b385392abda1947863.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="指定关联字段"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><ul><li><p>多表查询分类</p><p>连接查询</p><p>​    <code>内连接</code>：查询 A ∩ B部分</p><p>​    <code>外连接</code>：</p><p>​            左外连接：查询 A + (A ∩ B)</p><p>​            右外连接：查询 B + (A ∩ B)</p><p>​    <code>自连接</code>：当前表与自身的连接连接，自查询必须使用表别名</p><p>子查询</p><p><img src="https://img-blog.csdnimg.cn/f560c997a6db4c04aec03c7a6dbd65dc.png" alt="示意图"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p></li></ul><h1 id="3-连接查询"><a href="#3-连接查询" class="headerlink" title="3.连接查询"></a>3.连接查询</h1><h4 id="3-1-内连接"><a href="#3-1-内连接" class="headerlink" title="3.1 内连接"></a>3.1 内连接</h4><p>内连接查询两张表的交集部分，即<code>A ∩ B</code></p><ul><li>隐式内连接  (上一节消除无效笛卡尔积的案例就是隐式内连接)</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表<span class="token number">1</span><span class="token punctuation">,</span> 表<span class="token number">2</span> <span class="token keyword">WHERE</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>显式内连接</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表<span class="token number">1</span> <span class="token punctuation">[</span><span class="token keyword">INNER</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> 表<span class="token number">2</span> <span class="token keyword">ON</span> 连接条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>案例：查询每个员工的姓名与其对应的部门</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 隐式内连接</span><span class="token keyword">select</span> e<span class="token punctuation">.</span>name<span class="token punctuation">,</span> d<span class="token punctuation">.</span>id <span class="token keyword">from</span> emp e<span class="token punctuation">,</span> dept d <span class="token keyword">where</span> e<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>一旦给表起定别名，真实的名字就无法使用了</p></blockquote><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 显示内连接</span><span class="token keyword">select</span> e<span class="token punctuation">.</span>name<span class="token punctuation">,</span> d<span class="token punctuation">.</span>id <span class="token keyword">from</span> emp e <span class="token keyword">inner</span> <span class="token keyword">join</span> dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>注意，我么查到了6个人，如下图所示</p><p><img src="https://img-blog.csdnimg.cn/65a0b53685fe4027af4706e8dab1ae44.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="res"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>但实际上数据库中有7个人，还有一个人没有显示的原因是他是实习生，还没有关联部门的外键，因此不属于两张表的<code>交集</code>。</p><p><img src="https://img-blog.csdnimg.cn/684b5a53278242bab88cf5ca67ba77ac.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="res"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="3-2-外连接"><a href="#3-2-外连接" class="headerlink" title="3.2 外连接"></a>3.2 外连接</h4><ul><li><p>左外连接</p><p>查询 <code>A + (A ∩ B)</code></p></li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表<span class="token number">1</span> <span class="token keyword">LEFT</span> <span class="token punctuation">[</span><span class="token keyword">OUTER</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> 表<span class="token number">2</span> <span class="token keyword">ON</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/7079446a9a6f4f4dbfca66db97d3d2c9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="左外连接"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>​    这次就可以将每位员工的数据查询出来了，包括没有与第二行表关联的员工</p><ul><li><p>右外连接</p><p>查询<code>B + (A ∩ B)</code></p></li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表<span class="token number">1</span> <span class="token keyword">RIGHT</span> <span class="token punctuation">[</span><span class="token keyword">OUTER</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> 表<span class="token number">2</span> <span class="token keyword">ON</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/1b2dce823d5448a89920a34a30fa5430.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="右外连接"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>通常<code>左外连接</code>用的会多一些，因为右外连接都可以通过颠倒两张表的顺序改成左外连接。</p><p>下面两条语句的效果是完全一样的，区别就在于两张表的查询顺序</p><p>但实质上都是取部门表的全部数据+部门表与员工表的交集部分</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> d<span class="token punctuation">.</span>id <span class="token punctuation">,</span> e<span class="token punctuation">.</span>name <span class="token keyword">from</span> dept d <span class="token keyword">left</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> emp e <span class="token keyword">on</span> e<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span class="token keyword">select</span> d<span class="token punctuation">.</span>id <span class="token punctuation">,</span> e<span class="token punctuation">.</span>name <span class="token keyword">from</span> emp e <span class="token keyword">left</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="3-4-自连接"><a href="#3-4-自连接" class="headerlink" title="3.4 自连接"></a>3.4 自连接</h4><pre class="line-numbers language-自连接```可以是```内连接```，也可以是```外连接```，只不过两张表都是他自己罢了。一定要起一个别名。" data-language="自连接```可以是```内连接```，也可以是```外连接```，只不过两张表都是他自己罢了。一定要起一个别名。"><code class="language-自连接```可以是```内连接```，也可以是```外连接```，只不过两张表都是他自己罢了。一定要起一个别名。">```sqlSELECT 字段们 FROM 表A 别名A JOIN 表A 别名B ON 条件;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>自连接 + 内连接</li></ul><p>虽然这是在同一张表内查询，但是需要把他们看作两张表进行内连接查询。</p><p>但是内连接是取<code>交集</code>，因此如果有员工没有领导就不会被查出来。</p><p><img src="https://img-blog.csdnimg.cn/e0b2946cccfd4f568e26d67685324513.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="自连接 + 内连接"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><ul><li>自连接 + 外连接</li><li><img src="https://img-blog.csdnimg.cn/dcabe801e1b049ca8536150b3e22808d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="自连接 + 外连接"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></li></ul><h4 id="3-5-联合查询"><a href="#3-5-联合查询" class="headerlink" title="3.5 联合查询"></a>3.5 联合查询</h4><p>把多次查询的结果<code>合并起来</code>，形成一个新的查询结果集。</p><p>查询前提：多条查询返回的字段数量与类型需要相同。</p><p><code>UNION ALL</code>不去重，<code>UNION</code>会去重。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表A<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token keyword">UNION</span> <span class="token punctuation">[</span><span class="token keyword">ALL</span><span class="token punctuation">]</span><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表B<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>案例：</p><p>查询 薪资低于11000 和 年龄大于40 的员工</p><p><img src="https://img-blog.csdnimg.cn/08c7ab851d7d435e8e6dfa83bdcf3553.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="UNION"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>如果用<code>UNION ALL</code>会出现重复的数据，如果某个人同时满足，此时用<code>UNION</code>就可以去重。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;多表查询&quot;&gt;&lt;a href=&quot;#多表查询&quot; class=&quot;headerlink&quot; title=&quot;多表查询&quot;&gt;&lt;/a&gt;多表查询&lt;/h1&gt;&lt;h2 id=&quot;1-多表关系&quot;&gt;&lt;a href=&quot;#1-多表关系&quot; class=&quot;headerlink&quot; title=&quot;1.多表关</summary>
      
    
    
    
    <category term="数据库" scheme="https://sakkana.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="数据库" scheme="https://sakkana.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>Linux - 3 Shell</title>
    <link href="https://sakkana.github.io/2022/03/09/Linux3%20shell/"/>
    <id>https://sakkana.github.io/2022/03/09/Linux3%20shell/</id>
    <published>2022-03-09T10:54:01.000Z</published>
    <updated>2022-03-10T08:02:01.015Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Shell-语法"><a href="#Shell-语法" class="headerlink" title="Shell 语法"></a>Shell 语法</h1><h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><h5 id="1-概论"><a href="#1-概论" class="headerlink" title="1.概论"></a>1.<a href="#index1">概论</a></h5><h5 id="2-注释"><a href="#2-注释" class="headerlink" title="2.注释"></a>2.<a href="#index2">注释</a></h5><h5 id="3-变量"><a href="#3-变量" class="headerlink" title="3.变量"></a>3.<a href="#index3">变量</a></h5><h5 id="4-默认变量"><a href="#4-默认变量" class="headerlink" title="4.默认变量"></a>4.<a href="#index4">默认变量</a></h5><h5 id="5-数组"><a href="#5-数组" class="headerlink" title="5.数组"></a>5.<a href="#index5">数组</a></h5><h5 id="6-expr命令"><a href="#6-expr命令" class="headerlink" title="6.expr命令"></a>6.<a href="#index6">expr命令</a></h5><h5 id="7-read命令"><a href="#7-read命令" class="headerlink" title="7.read命令"></a>7.<a href="#index7">read命令</a></h5><h5 id="8-echo命令"><a href="#8-echo命令" class="headerlink" title="8.echo命令"></a>8.<a href="#index8">echo命令</a></h5><h5 id="9-printf命令test命令与判断符号"><a href="#9-printf命令test命令与判断符号" class="headerlink" title="9.printf命令test命令与判断符号[]"></a>9.<a href="#index9">printf命令test命令与判断符号[]</a></h5><h5 id="10-判断语句"><a href="#10-判断语句" class="headerlink" title="10.判断语句"></a>10.<a href="#index10">判断语句</a></h5><h5 id="11-循环语句"><a href="#11-循环语句" class="headerlink" title="11.循环语句"></a>11.<a href="#index11">循环语句</a></h5><h5 id="12-函数"><a href="#12-函数" class="headerlink" title="12.函数"></a>12.<a href="#index12">函数</a></h5><h5 id="13-exit命令"><a href="#13-exit命令" class="headerlink" title="13.exit命令"></a>13.<a href="#index13">exit命令</a></h5><h5 id="14-文件重定向"><a href="#14-文件重定向" class="headerlink" title="14.文件重定向"></a>14.<a href="#index14">文件重定向</a></h5><h5 id="15-引入外部脚本"><a href="#15-引入外部脚本" class="headerlink" title="15.引入外部脚本"></a>15.<a href="#index15">引入外部脚本</a></h5><p>====================================================================================================================</p><h3 id="1-概论-1"><a href="#1-概论-1" class="headerlink" title="1.概论"></a><span id="index1">1.概论</span></h3><h3 id="2-注释-1"><a href="#2-注释-1" class="headerlink" title="2.注释"></a><span id="index2">2.注释</span></h3><h3 id="3-变量-1"><a href="#3-变量-1" class="headerlink" title="3.变量"></a><span id="index3">3.变量</span></h3><h5 id="3-1定义变量"><a href="#3-1定义变量" class="headerlink" title="3.1定义变量"></a>3.1定义变量</h5><p>定义变量的三种方式</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a='variable1' # 单引号定义b="variable2" # 双引号定义c=variable3   # 啥都不用加<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="3-2使用变量"><a href="#3-2使用变量" class="headerlink" title="3.2使用变量"></a>3.2使用变量</h5><p>使用变量的值需要加<code>$</code>或者<code>${}</code>,花括号主要是为了辅助解释器识别变量边界</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#! /bin/bashv1='variable1'v2="variable2"v3=variable3echo $v1echo ${v2}echo ${v3}是个大坏蛋<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>variable1<br>variable2<br>variable3是个大坏蛋</p></blockquote><h5 id="3-3-只读变量"><a href="#3-3-只读变量" class="headerlink" title="3.3 只读变量"></a>3.3 只读变量</h5><p>关键字<code>readonly</code>和<code>declare -r</code>都可以将一个变量声明为只读，相当于C/C++中的const</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a="fish"                                                        echo $areadonly a# 方式一declare -r a# 方式二a="pig"echo $a# 会报错，因为前面把它声明为readonly了<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>fish<br>./test.sh: line 9: a: readonly variable<br>fish</p></blockquote><h5 id="3-4-删除变量"><a href="#3-4-删除变量" class="headerlink" title="3.4 删除变量"></a>3.4 删除变量</h5><p>关键词<code>unset</code>删除变量</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a="fish"echo $aunset aecho ${a}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>fish</p></blockquote><h5 id="3-5-变量类型"><a href="#3-5-变量类型" class="headerlink" title="3.5 变量类型"></a>3.5 变量类型</h5><ol><li><p>自定义变量(局部变量)</p><p>子进程不可以访问</p></li><li><p>环境变量(全局变量)</p><p>子进程可以访问</p></li></ol><p>局部变量 —&gt; 全局变量</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">acs@9e0ebfcd82d7:~$ name=yxc  # 定义变量acs@9e0ebfcd82d7:~$ export name  # 第一种方法acs@9e0ebfcd82d7:~$ declare -x name  # 第二种方法<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>全局变量 —&gt; 局部变量</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">acs@9e0ebfcd82d7:~$ export name=yxc  # 定义全局变量acs@9e0ebfcd82d7:~$ declare +x name  # 改为局部变量<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="3-6-字符串"><a href="#3-6-字符串" class="headerlink" title="3.6 字符串"></a>3.6 字符串</h5><p>字符串可以用<code>单引号</code>，也可以用<code>双引号</code>,也可以<code>不用引号</code></p><p>区别：</p><ul><li>单引号中的内容会原样输出，不会执行，不会取变量的值</li><li>双引号中的内容可以执行，可以取变量的值</li></ul><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name=fish                                                                                                                                            echo '$hello, name \"hh\"'# 单引号没啥用echo "hello, $name \"hh\""# 双引号会小心翼翼地全部执行echo hello, $name \"hh\"# 不带引号也会小心翼翼地全部执行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>$hello, name \ “hh\ “<br>hello, fish “hh”<br>hello, fish “hh”</p></blockquote><h6 id="获取字符长度"><a href="#获取字符长度" class="headerlink" title="获取字符长度"></a>获取字符长度</h6><p> 格式：</p><pre class="line-numbers language-none"><code class="language-none">${#变量名}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name=fishecho ${#name}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>4</p></blockquote><h6 id="提取子串"><a href="#提取子串" class="headerlink" title="提取子串"></a>提取子串</h6><p>格式：</p><pre class="line-numbers language-none"><code class="language-none">${变量名:st:n}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以提取从下标st开始的长度为n的子串</p><p>下标从 0 开始</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name="1234567"echo ${name:2:5}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>34567</p></blockquote><h3 id="4-默认变量-1"><a href="#4-默认变量-1" class="headerlink" title="4.&nbsp; 默认变量"></a><span id="index4">4.&nbsp; 默认变量</span></h3><h5 id="4-1-文件参数变量"><a href="#4-1-文件参数变量" class="headerlink" title="4.1 文件参数变量"></a>4.1 文件参数变量</h5><p>在执行shell脚本时，可以向脚本传递参数。<code>$1</code>是第一个参数，<code>$2</code>是第二个参数，以此类推。特殊的，<code>$0</code>是文件名（包含路径）</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "filename: "$0                              echo "parameter1 : "$1echo "parameter2 : "$2echo "parameter3 : "$3echo "parameter4 : "$4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行该脚本：</p><blockquote><p>acs@08cd8080c823:~$ ./test.sh a b z x<br>filename: ./test.sh<br>parameter1 : a<br>parameter2 : b<br>parameter3 : z<br>parameter4 : x</p></blockquote><h5 id="4-2-其他参数相关变量"><a href="#4-2-其他参数相关变量" class="headerlink" title="4.2 其他参数相关变量"></a>4.2 其他参数相关变量</h5><table><thead><tr><th align="center">参数</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center"><code>$#</code></td><td align="center">代表文件传入的参数个数，如上例中值为4</td></tr><tr><td align="center"><code>$*</code></td><td align="center">由所有参数构成的用空格隔开的字符串，如上例中值为 <code>"$a $b $z $x"</code></td></tr><tr><td align="center"><code>$@</code></td><td align="center">每个参数分别用双引号括起来的字符串，如上例中值为 <code>"$1" "$2" "$3" "$4"</code></td></tr><tr><td align="center"><code>$$</code></td><td align="center">脚本当前运行的进程ID</td></tr><tr><td align="center"><code>$?</code></td><td align="center">上一条命令的退出状态（注意不是stdout，而是exit code）。0表示正常退出，其他值表示错误</td></tr><tr><td align="center"><code>$(command)</code></td><td align="center">返回<code>command</code>这条命令的stdout（可嵌套）</td></tr><tr><td align="center">‘command’</td><td align="center">返回<code>command</code>这条命令的stdout（不可嵌套）</td></tr></tbody></table><p>$(命令), ${变量名}</p><h3 id="5-数组-1"><a href="#5-数组-1" class="headerlink" title="5.&nbsp; 数组"></a><span id="index5">5.&nbsp; 数组</span></h3><p>数组中可以存放多个不同类型的值，只支持一维数组，初始化时不需要指明数组大小。<br>数组<em>下标从0开始</em>。</p><h5 id="5-1-定义数组"><a href="#5-1-定义数组" class="headerlink" title="5.1 定义数组"></a>5.1 定义数组</h5><p>数组用小括号表示，元素之间用空格隔开。</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">array=(1 abc "def" fish)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>也可以直接定义数组中的某个元素</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">array[0]=1array[1]=abcarray[2]="def"array[3]=fish<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="5-2-读取数组中的某个元素的值"><a href="#5-2-读取数组中的某个元素的值" class="headerlink" title="5.2 读取数组中的某个元素的值"></a>5.2 读取数组中的某个元素的值</h5><p>格式</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">${arr[index]} # 和读取变量一样<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例如</p><pre class="line-numbers language-she" data-language="she"><code class="language-she">array=(1 abc "def" def)echo ${array[0]}echo ${array[1]}echo ${array[2]}echo ${array[3]}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="5-3-数组长度"><a href="#5-3-数组长度" class="headerlink" title="5.3 数组长度"></a>5.3 数组长度</h5><p>格式</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">${array[*]}# 写法一${array[@]}# 写法二<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>例如</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">array=(1 abc "def" yxc)echo ${#array[@]}  # 第一种写法echo ${#array[*]}  # 第二种写法<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>数组可以跳着赋值，并且没有赋值的位置不占用空间</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">dist[0]=12                                      dist[789]=fishdist[4]="abc"echo ${dist[0]}echo ${dist[4]}echo ${dist[789]}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>12<br>abc<br>fish</p></blockquote><h3 id="6-expr-表达式"><a href="#6-expr-表达式" class="headerlink" title="6. expr 表达式"></a><span id="index6">6. expr 表达式</span></h3><p><code>expr</code>命令用于求表达式的值,格式为</p><p><code>expr 表达式</code></p><p>表达式说明：</p><ul><li><p>用<code>空格</code>隔开每一项</p></li><li><p>用<code>反斜杠</code>放在shell特定的字符前面（发现表达式运行错误时，可以试试转义）</p></li><li><p>对<code>包含空格</code>和<code>其他特殊字符</code>的字符串要用<code>引号</code>括起来</p></li><li><p>expr会在s<code>tdout</code>中输出结果。如果为逻辑关系表达式，则结果为真，stdout为1，否则为0。</p></li><li><p>expr的exit code：如果为逻辑关系表达式，则结果为<code>真</code>，<code>exit code为0</code>，否则为1。</p></li></ul><h5 id="6-1-字符串表达式"><a href="#6-1-字符串表达式" class="headerlink" title="6.1 字符串表达式"></a>6.1 字符串表达式</h5><ul><li><code>length STRING</code> </li></ul><p>​          返回<code>STRING</code>的长度</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">str="Hello World"echo `expr length "$str"` # 需要将有空格的字符串用双引号括起来<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>11</p></blockquote><ul><li><code>index STRING CHARSET</code></li></ul><p>​        <code>CHARSET</code>中任意单个字符在<code>STRING</code>中最前面的字符位置，下标从1开始。如果在<code>STRING</code>中完全不存在<code>CHARSET</code>中的字符，则返回<code>0</code>。</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">str="Hello World"echo `expr index "$str" aWd`  # 输出7，下标从1开始<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><code>substr STRING POSITION LENGTH</code></li></ul><p>​        返回<code>STRING</code>字符串中从<code>POSITION</code>开始，长度最大为<code>LENGTH</code>的子串。如果<code>POSITION</code>或<code>LENGTH</code>为负数，0或非数值，则返回空字符串。</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">str="Hello World"echo `expr substr "$str" 2 3`  # 输出 ell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="6-2-整数表达式"><a href="#6-2-整数表达式" class="headerlink" title="6.2 整数表达式"></a>6.2 整数表达式</h5><p>expr支持普通的算术操作，算术表达式优先级低于字符串表达式，高于逻辑关系表达式。</p><ul><li><code>+ -</code><br>加减运算。两端参数会转换为整数，如果转换失败则报错。</li></ul><ul><li><code>* / %</code><br>乘，除，取模运算。两端参数会转换为整数，如果转换失败则报错。</li></ul><p><code>() </code>可以该表优先级，但需要用<code>反斜杠</code>转义</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=3b=4echo `expr $a + $b`  # 输出7echo `expr $a - $b`  # 输出-1echo `expr $a \* $b`  # 输出12，*需要转义echo `expr $a / $b`  # 输出0，整除echo `expr $a % $b` # 输出3echo `expr \( $a + 1 \) \* \( $b + 1 \)`  # 输出20，值为(a + 1) * (b + 1)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="6-3-逻辑关系表达式"><a href="#6-3-逻辑关系表达式" class="headerlink" title="6.3 逻辑关系表达式"></a>6.3 逻辑关系表达式</h5><ul><li><p><code>|</code><br>如果第一个参数非空且非0，则返回第一个参数的值，否则返回第二个参数的值，但要求第二个参数的值也是非空或非0，否则返回0。如果第一个参数是非空或非0时，不会计算第二个参数。</p></li><li><p><code>&amp;</code><br>如果两个参数都非空且非0，则返回第一个参数，否则返回0。如果第一个参为0或为空，则不会计算第二个参数。</p></li><li><p><code>&lt; &lt;= = == != &gt;= &gt;</code><br>比较两端的参数，如果为true，则返回1，否则返回0。”==”是”=”的同义词。”expr”首先尝试将两端参数转换为整数，并做算术比较，如果转换失败，则按字符集排序规则做字符比较。</p></li><li><p><code>()</code> 可以该表优先级，但需要用<code>反斜杠</code>转义</p></li></ul><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=3b=4echo `expr $a \&gt; $b`  # 输出0，&gt;需要转义echo `expr $a '&lt;' $b`  # 输出1，也可以将特殊字符用引号引起来echo `expr $a '&gt;=' $b`  # 输出0echo `expr $a \&lt;\= $b`  # 输出1c=0d=5echo `expr $c \&amp; $d`  # 输出0echo `expr $a \&amp; $b`  # 输出3echo `expr $c \| $d`  # 输出5echo `expr $a \| $b`  # 输出3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7-read命令-1"><a href="#7-read命令-1" class="headerlink" title="7. read命令"></a><span id="index7">7. read命令</span></h3><p><code>read</code>命令用于从标准输入中读取单行数据。当读到文件结束符时，exit code为1，否则为0。</p><p>参数说明</p><ul><li><p><code>-p</code>: 后面可以接提示信息</p></li><li><p>```shell<br>read -p “What’s your name? “ -t 3 name<br>echo “Hello, $name”</p><pre class="line-numbers language-none"><code class="language-none">  &gt;What's your name? fish  &gt;Hello, fish* `-t`：后面跟秒数，定义输入字符的等待时间，超过等待时间后会自动忽略此命令```shellread -p "What's your name? " name                               echo "Hello, $name"# 如果你啥都不输入，就在那里傻等着<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><blockquote><p>acs@08cd8080c823:<del>$ ./test.sh<br>What’s your name? Hello,<br>acs@08cd8080c823:</del>$ </p></blockquote><h3 id="8-echo命令-1"><a href="#8-echo命令-1" class="headerlink" title="8. echo命令"></a><span id="index8">8. echo命令</span></h3><p><code>echo</code>用于输出字符串，格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo STRING<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="8-1-显示普通字符串"><a href="#8-1-显示普通字符串" class="headerlink" title="8.1 显示普通字符串"></a>8.1 显示普通字符串</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "I'm a fish"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "I'm" a fish  # 双引号可以省略,但最好带着<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>I’m a fish</p></blockquote><h5 id="8-2-显示转义字符串"><a href="#8-2-显示转义字符串" class="headerlink" title="8.2 显示转义字符串"></a>8.2 显示转义字符串</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "\"Hello AC Terminal\""  # 注意只能使用双引号，如果使用单引号，则不转义<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo \"Hello AC Terminal\"  # 也可以省略双引号<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>“Hello AC Terminal” </p></blockquote><h5 id="8-3-显示变量"><a href="#8-3-显示变量" class="headerlink" title="8.3 显示变量"></a>8.3 显示变量</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 这个方式非常多name=fishecho "My name is "$nameecho "My name is $name"echo My name is $nameecho My name is ${name}# 但是如果你尝试使用'$name',解释器会直接输出$name,原封不动，和3.6的原则一样<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name=fishecho "Hello World, I'm $name"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>Hello World, I’m fish</p></blockquote><h5 id="8-4-显示换行-不换行"><a href="#8-4-显示换行-不换行" class="headerlink" title="8.4 显示换行/不换行"></a>8.4 显示换行/不换行</h5><p><code>-e</code>开启转义</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo -e "Hi\n"# -e 开启转义echo "What's your name"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>Hi</p><p>What’s your name</p></blockquote><h5 id="8-5-显示不换行"><a href="#8-5-显示不换行" class="headerlink" title="8.5 显示不换行"></a>8.5 显示不换行</h5><p>由于shell默认每次输出都换行，因此<code>-e</code>开启转移后可以用<code>\c</code>命令强制不换行</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo -e "Hi     \c" # -e 开启转义 \c 不换行echo "What's your name"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>Hi     What’s your name</p></blockquote><h5 id="8-6-原样输出字符串，不进行任何【取变量】或者【转义】"><a href="#8-6-原样输出字符串，不进行任何【取变量】或者【转义】" class="headerlink" title="8.6 原样输出字符串，不进行任何【取变量】或者【转义】"></a>8.6 原样输出字符串，不进行任何【取变量】或者【转义】</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name=fishscho '""$fish\n"'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>“$name\n”</p></blockquote><h5 id="显示命令的执行结果"><a href="#显示命令的执行结果" class="headerlink" title="显示命令的执行结果"></a>显示命令的执行结果</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo 'date'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>Wed Mar 9 21:16:30 CST 2022</p></blockquote><h3 id="9-printf命令"><a href="#9-printf命令" class="headerlink" title="9. printf命令"></a><span id="index9">9. printf命令</span></h3><p><code>printf</code>命令用于格式化输出，类似于C/C++中的<code>printf</code>函数。</p><p>默认不会在字符串末尾添加换行符。</p><p>格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">printf format-string [arguments...]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">printf "My name is %s\n" fish# 格式化输出字符串                printf "%10d.\n" 12345# 占10位，正数左对齐printf "%-10.2f.\n" 123.45678# 占10位，负数右对齐printf "%d * %d = %d\n" 3 6 `expr 3 \* 6`# 表达式作为参数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>My name is fish<br>         12345.<br>123.46          .<br>3 * 6 = 18</p></blockquote><h3 id="10-test命令与判断符号"><a href="#10-test命令与判断符号" class="headerlink" title="10. test命令与判断符号[]"></a><span id="index10">10. test命令与判断符号[]</span></h3><h5 id="10-1-逻辑运算符-amp-amp-和"><a href="#10-1-逻辑运算符-amp-amp-和" class="headerlink" title="10.1 逻辑运算符 &amp;&amp; 和 ||"></a>10.1 逻辑运算符 &amp;&amp; 和 ||</h5><ul><li><p><code>&amp;&amp;</code> 表示与，<code>||</code> 表示或</p></li><li><p>二者具有短路原则：<br><code>expr1 &amp;&amp; expr2</code>：当expr1为假时，直接忽略expr2<br><code>expr1 || expr2</code>：当expr1为真时，直接忽略expr2</p></li><li><p>表达式的<code>exit code</code>为0，表示真；为非零，表示假。（与C/C++中的定义相反）</p></li></ul><h5 id="10-2-test命令"><a href="#10-2-test命令" class="headerlink" title="10.2 test命令"></a>10.2 test命令</h5><p>在命令行中输入·man test·，可以查看·test·命令的用法。</p><p><code>test</code>命令用于【判断文件类型】，以及【对变量做比较】。</p><p><code>test</code>命令用<code>exit code</code>返回结果，而不是使用stdout。0表示真，非0表示假。</p><p>例如，</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">test -1 -lt 99 # 为真，返回值为0echo $?# 输出上个命令的返回值，输出0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">acs@9e0ebfcd82d7:~$ ls  # 列出当前目录下的所有文件homework  output.txt  test.sh  tmpacs@9e0ebfcd82d7:~$ test -e test.sh &amp;&amp; echo "exist" || echo "Not exist"exist  # test.sh 文件存在acs@9e0ebfcd82d7:~$ test -e test2.sh &amp;&amp; echo "exist" || echo "Not exist"Not exist  # testh2.sh 文件不存在<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="10-2-文件类型判断"><a href="#10-2-文件类型判断" class="headerlink" title="10.2 文件类型判断"></a>10.2 文件类型判断</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">test -e filename # 判断文件是否存在<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th align="center">参数</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-e</td><td align="center">exist 文件是否存在</td></tr><tr><td align="center">-f</td><td align="center">file 是否为问价</td></tr><tr><td align="center">-d</td><td align="center">directory 是否为目录(文件夹)</td></tr></tbody></table><h5 id="10-3-文件权限判断"><a href="#10-3-文件权限判断" class="headerlink" title="10.3 文件权限判断"></a>10.3 文件权限判断</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">test -f filename # 判断文件是否可读<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>-f</td><td>read 文件是否可读</td></tr><tr><td>-w</td><td>write 文件是否可写</td></tr><tr><td>-x</td><td>execuate 文件是否可执行</td></tr><tr><td>-s</td><td>是否为非空文件</td></tr></tbody></table><h5 id="10-3-整数间的判断"><a href="#10-3-整数间的判断" class="headerlink" title="10.3 整数间的判断"></a>10.3 整数间的判断</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">test $a -eq $b# 判断a是否等于b，即判断 a==b<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th align="center">参数</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-eq</td><td align="center">==</td></tr><tr><td align="center">-ne</td><td align="center">!=</td></tr><tr><td align="center">-gt</td><td align="center">&gt;</td></tr><tr><td align="center">-lt</td><td align="center">&lt;</td></tr><tr><td align="center">-ge</td><td align="center">&gt;=</td></tr><tr><td align="center">-le</td><td align="center">&lt;=</td></tr></tbody></table><h5 id="10-4-字符串比较"><a href="#10-4-字符串比较" class="headerlink" title="10.4 字符串比较"></a>10.4 字符串比较</h5><table><thead><tr><th align="center">参数</th><th align="center">代表意义</th></tr></thead><tbody><tr><td align="center">test -z STR</td><td align="center">str为空，返回true</td></tr><tr><td align="center">test -n str</td><td align="center">str不为空，返回true (-n可以省略)</td></tr><tr><td align="center">test str1 == str2</td><td align="center">判断是否相等</td></tr><tr><td align="center">test str1 != str2</td><td align="center">判断是否不等</td></tr></tbody></table><h5 id="10-5-多重条件判定"><a href="#10-5-多重条件判定" class="headerlink" title="10.5 多重条件判定"></a>10.5 多重条件判定</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">test -r filename -a -x filename<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>-a</td><td>AND</td></tr><tr><td>-o</td><td>OR</td></tr><tr><td>!</td><td>NOT</td></tr></tbody></table><blockquote><p>!相当于取反，例如test ! -x filename，当filename不可执行时，返回true</p></blockquote><h5 id="10-6-判断符号"><a href="#10-6-判断符号" class="headerlink" title="10.6 判断符号[]"></a>10.6 判断符号[]</h5><p><code>[]</code>与<code>test</code>的用法几乎一模一样，更常用于<code>if语句</code>中。此外，<code>[[]]</code>是<code>[]</code>的加强版本，支持更多的特性</p><p>例如：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[ 2 -lt 3 ]  # 为真，返回值为0echo $?  # 输出上个命令的返回值，输出0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">acs@9e0ebfcd82d7:~$ ls  # 列出当前目录下的所有文件homework  output.txt  test.sh  tmpacs@9e0ebfcd82d7:~$ [ -e test.sh ] &amp;&amp; echo "exist" || echo "Not exist"exist  # test.sh 文件存在acs@9e0ebfcd82d7:~$ [ -e test2.sh ] &amp;&amp; echo "exist" || echo "Not exist"Not exist  # testh2.sh 文件不存在<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意：</p><ul><li><code>[]</code>内的每一项都要用<code>空格隔开</code></li><li>中括号内的变量，最好用<code>双引号</code>括起来</li><li>中括号内的常熟，最好用但或双引号括起来</li></ul><p>例如：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name="Hello World"[ $name == "Hello World" ]  # 错误，等价于 [ Hello World == "Hello World" ]，参数太多[ "$name" == "Hello World" ]  # 正确<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="11-判断语句"><a href="#11-判断语句" class="headerlink" title="11. 判断语句"></a><span id="index11">11. 判断语句</span></h3><h4 id="11-1-if-then形式"><a href="#11-1-if-then形式" class="headerlink" title="11.1 if - then形式"></a>11.1 if - then形式</h4><p>类似 C/C++中的<code>if - else</code>语句</p><h5 id="11-1-1-单层if"><a href="#11-1-1-单层if" class="headerlink" title="11.1.1 单层if"></a>11.1.1 单层if</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">if conditionthen    语句1    语句2    ...fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=3b=4if [ "$a" -lt "$b" ] &amp;&amp; [ "$a" -gt 2 ]then    echo ${a}在范围内fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>3在范围内</p></blockquote><h5 id="11-1-2-单层if-else"><a href="#11-1-2-单层if-else" class="headerlink" title="11.1.2 单层if - else"></a>11.1.2 单层if - else</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">if conditionthen    语句1    语句2    ...else    语句1    语句2    ...fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=3b=4if ! [ "$a" -lt "$b" ]then    echo ${a}不小于${b}else    echo ${a}小于${b}fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>3小于4</p></blockquote><h5 id="11-1-3-多层if-elif-elif-else"><a href="#11-1-3-多层if-elif-elif-else" class="headerlink" title="11.1.3 多层if - elif - elif - else"></a>11.1.3 多层if - elif - elif - else</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">if conditionthen    语句1    语句2    ...elif conditionthen    语句1    语句2    ...elif conditionthen    语句1    语句2else    语句1    语句2    ...fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=4if [ $a -eq 1 ]then    echo ${a}等于1elif [ $a -eq 2 ]then    echo ${a}等于2elif [ $a -eq 3 ]then    echo ${a}等于3else    echo 其他fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>其他</p></blockquote><h4 id="11-2-case…esca形式"><a href="#11-2-case…esca形式" class="headerlink" title="11.2 case…esca形式"></a>11.2 case…esca形式</h4><p>类似 C/C++ 中的<code>switch</code>语句</p><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">case $变量名称 in    值1)        语句1        语句2        ...        ;;  # 两个分号，类似于C/C++中的break    值2)        语句1        语句2        ...        ;;    *)  # 类似于C/C++中的default        语句1        语句2        ...        ;;esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=4case $a in    1)        echo ${a}等于1        ;;      2)        echo ${a}等于2        ;;      3)                                                        echo ${a}等于3        ;;      *)        echo 其他        ;;  esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>其他</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Shell-语法&quot;&gt;&lt;a href=&quot;#Shell-语法&quot; class=&quot;headerlink&quot; title=&quot;Shell 语法&quot;&gt;&lt;/a&gt;Shell 语法&lt;/h1&gt;&lt;h3 id=&quot;目录&quot;&gt;&lt;a href=&quot;#目录&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    <category term="Linux" scheme="https://sakkana.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://sakkana.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux - 2 tmux和vim</title>
    <link href="https://sakkana.github.io/2022/03/07/Linux2%20tmux%E5%92%8Cvim/"/>
    <id>https://sakkana.github.io/2022/03/07/Linux2%20tmux%E5%92%8Cvim/</id>
    <published>2022-03-07T13:05:01.000Z</published>
    <updated>2022-03-08T11:12:30.574Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tmux"><a href="#tmux" class="headerlink" title="tmux"></a>tmux</h1><h5 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">(1) 分屏。(2) 允许断开Terminal连接后，继续运行进程。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">一个tmux可以包含多个session，一个session可以包含多个window，一个window可以包含多个pane。  实例：      tmux:          session 0:              window 0:                  pane 0                  pane 1                  pane 2                  ...              window 1              window 2              ...          session 1          session 2          ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">(1) tmux：新建一个session，其中包含一个window，window中包含一个pane，pane里打开了一个shell对话框。(2) 按下Ctrl + b后手指松开，然后按%：将当前pane左右平分成两个pane。(3) 按下Ctrl + b后手指松开，然后按"（注意是双引号"）：将当前pane上下平分成两个pane。(4) Ctrl + d：关闭当前pane；如果当前window的所有pane均已关闭，则自动关闭window；如果当前session的所有window均已关闭，则自动关闭session。(5) 鼠标点击可以选pane。(6) 按下ctrl + b后手指松开，然后按方向键：选择相邻的pane。(7) 鼠标拖动pane之间的分割线，可以调整分割线的位置。(8) 按住ctrl + b的同时按方向键，可以调整pane之间分割线的位置。(9) 按下ctrl + b后手指松开，然后按z：将当前pane全屏/取消全屏。(10) 按下ctrl + b后手指松开，然后按d：挂起当前session。(11) tmux a：打开之前挂起的session。(12) 按下ctrl + b后手指松开，然后按s：选择其它session。     方向键 —— 上：选择上一项 session/window/pane     方向键 —— 下：选择下一项 session/window/pane     方向键 —— 右：展开当前项 session/window     方向键 —— 左：闭合当前项 session/window(13) 按下Ctrl + b后手指松开，然后按c：在当前session中创建一个新的window。(14) 按下Ctrl + b后手指松开，然后按w：选择其他window，操作方法与(12)完全相同。(15) 按下Ctrl + b后手指松开，然后按PageUp：翻阅当前pane内的内容。用ctrl+c退出阅读模式。(16) 鼠标滚轮：翻阅当前pane内的内容。(17) 在tmux中选中文本时，需要按住shift键。（仅支持Windows和Linux，不支持Mac，不过该操作并不是必须的，因此影响不大）(18) tmux中复制/粘贴文本的通用方式：    (1) 按下Ctrl + b后松开手指，然后按[    (2) 用鼠标选中文本，被选中的文本会被自动复制到tmux的剪贴板    (3) 按下Ctrl + b后松开手指，然后按]，会将剪贴板中的内容粘贴到光标处<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ctrl+s 暂停屏幕输出<br>ctrl+q 恢复屏幕输出<br>ctrl+l 清屏，等同于Clear</p><h1 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h1><p>功能</p><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">(1) 命令行模式下的文本编辑器。(2) 根据文件扩展名自动判别编程语言。支持代码缩进、代码高亮等功能。(3) 使用方式：vim filename如果已有该文件，则打开它。如果没有该文件，则打开个一个新的文件，并命名为filename<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">(1) 一般命令模式默认模式。命令输入方式：类似于打游戏放技能，按不同字符，即可进行不同操作。可以复制、粘贴、删除文本等。(2) 编辑模式在一般命令模式里按下i，会进入编辑模式。按下ESC会退出编辑模式，返回到一般命令模式。 不管当前是编辑模式还是命令模式，esc之后都到默认模式。(3) 命令行模式在一般命令模式里按下:/?三个字母中的任意一个，会进入命令行模式。命令行在最下面。可以查找、替换、保存、退出、配置编辑器等。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="操作-1"><a href="#操作-1" class="headerlink" title="操作"></a>操作</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">(1) i：进入编辑模式(2) ESC：进入一般命令模式(3) h 或 左箭头键：光标向左移动一个字符(4) j 或 向下箭头：光标向下移动一个字符(5) k 或 向上箭头：光标向上移动一个字符(6) l 或 向右箭头：光标向右移动一个字符(7) n&lt;Space&gt;：n表示数字，按下数字后再按空格，光标会向右移动这一行的n个字符(8) 0 或 功能键[Home]：光标移动到本行开头(9) $ 或 功能键[End]：光标移动到本行末尾(10) G：光标移动到最后一行(11) :n 或 nG：n为数字，光标移动到第n行(12) gg：光标移动到第一行，相当于1G(13) n&lt;Enter&gt;：n为数字，光标向下移动n行(14) /word：向光标之下寻找第一个值为word的字符串。(15) ?word：向光标之上寻找第一个值为word的字符串。(16) n：重复前一个查找操作(17) N：反向重复前一个查找操作(18) :n1,n2s/word1/word2/g：n1与n2为数字，在第n1行与n2行之间寻找word1这个字符串，并将该字符串替换为  word2(19) :1,$s/word1/word2/g：将全文的word1替换为word2(20) :1,$s/word1/word2/gc：将全文的word1替换为word2，且在替换前要求用户确认。(21) v：选中文本(22) d：删除选中的文本    d + nG ---&gt; 从删除当前行到第n行(23) dd: 删除当前行(24) y：复制选中的文本(25) yy: 复制当前行(26) p: 将复制的数据在光标的下一行/下一个位置粘贴(27) u：撤销(28) Ctrl + r：取消撤销(29) 大于号 &gt;：将选中的文本整体向右缩进一次(30) 小于号 &lt;：将选中的文本整体向左缩进一次(31) :w 保存(32) :w! 强制保存(33) :q 退出(34) :q! 强制退出(35) :wq 保存并退出(36) :set paste 设置成粘贴模式，取消代码自动缩进(37) :set nopaste 取消粘贴模式，开启代码自动缩进(38) :set nu 显示行号(39) :set nonu 隐藏行号(40) gg=G：将全文代码格式化(41) :noh 关闭查找关键词高亮(42) Ctrl + q：当vim卡死时，可以取消当前正在执行的命令<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">每次用vim编辑文件时，会自动创建一个.filename.swp的临时文件。如果打开某个文件时，该文件的swp文件已存在，则会报错。(具体是指，在tmux一个pane里面打开该文件，新开一个pane并且打开相同的文件，就会冲突)此时解决办法有两种：(1) 找到正在打开该文件的程序，并退出(2) 直接删掉该swp文件即可<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Vim内部粘贴板，需要在【Vim默认模式（一般命令模式）】下使用</p><p>​    y - 复制</p><p>​    d - 剪切</p><p>​    p - 粘贴</p><p>系统提供粘贴板，支持【Vim外部】与【Vim内部编辑模式】下使用</p><p>​    ctrl + insert - 复制</p><p>​    shift + insert - 粘贴</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;tmux&quot;&gt;&lt;a href=&quot;#tmux&quot; class=&quot;headerlink&quot; title=&quot;tmux&quot;&gt;&lt;/a&gt;tmux&lt;/h1&gt;&lt;h5 id=&quot;功能&quot;&gt;&lt;a href=&quot;#功能&quot; class=&quot;headerlink&quot; title=&quot;功能&quot;&gt;&lt;/a&gt;功能&lt;/h</summary>
      
    
    
    
    <category term="Linux" scheme="https://sakkana.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://sakkana.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux - 1 常用文件管理命令</title>
    <link href="https://sakkana.github.io/2022/03/07/Linux1%20%E5%B8%B8%E7%94%A8%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4/"/>
    <id>https://sakkana.github.io/2022/03/07/Linux1%20%E5%B8%B8%E7%94%A8%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4/</id>
    <published>2022-03-07T05:54:01.000Z</published>
    <updated>2022-03-07T09:09:11.819Z</updated>
    
    <content type="html"><![CDATA[<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h5 id="1-ctrl-c"><a href="#1-ctrl-c" class="headerlink" title="(1) ctrl c"></a>(1) ctrl c</h5><p>​    取消命令，并且换行</p><p>​    杀死某个进程</p><h5 id="2-ctrl-u"><a href="#2-ctrl-u" class="headerlink" title="(2) ctrl u"></a>(2) ctrl u</h5><p>​    清空本行命令</p><h5 id="3-tab键"><a href="#3-tab键" class="headerlink" title="(3) tab键"></a>(3) tab键</h5><p>​    可以补全命令和文件名，如果补全不了快速按两下tab键，可以显示备选选项</p><p>​    此外， ↑↓方向键可以显示上一条命令或者下一条命令</p><h5 id="4-ls"><a href="#4-ls" class="headerlink" title="(4) ls"></a>(4) ls</h5><p>​    列出当前目录下所有文件，</p><p>​    蓝色的是文件夹，</p><p>​    白色的是普通文件，</p><p>​    绿色的是可执行文件</p><h5 id="ls-l"><a href="#ls-l" class="headerlink" title="ls -l"></a>ls -l</h5><p>​        查看每一个文件的详细信息</p><h5 id="ls-lh"><a href="#ls-lh" class="headerlink" title="ls -lh"></a>ls -lh</h5><p>​        假如某个文件大小是30952Byte，这个单位不容易查看，输入参数h就会显示31K</p><h5 id="ls-a-all"><a href="#ls-a-all" class="headerlink" title="ls -a      (all)"></a>ls -a      (all)</h5><p>​    可以看到很多被隐藏的文件(如果文件名以【.】一个点开头就是隐藏文件)</p><h5 id="ls-A"><a href="#ls-A" class="headerlink" title="ls -A"></a>ls -A</h5><p>​    不显示当前目录，上层目录</p><h5 id="5-pwd"><a href="#5-pwd" class="headerlink" title="(5) pwd:"></a>(5) pwd:</h5><p>​    显示当前路径</p><h5 id="6-cd-文件名-change-directory"><a href="#6-cd-文件名-change-directory" class="headerlink" title="(6) cd 文件名     (change directory)"></a>(6) cd 文件名     (change directory)</h5><p>​    进入该文件目录下, </p><h5 id="cd"><a href="#cd" class="headerlink" title="cd .."></a>cd ..</h5><p>​    返回上层目录</p><h5 id="cd-1"><a href="#cd-1" class="headerlink" title="cd -"></a>cd -</h5><pre><code> 返回上一个呆过的目录</code></pre><h5 id="7-cp-已有文件a-新建文件b-复制-粘贴-重命名"><a href="#7-cp-已有文件a-新建文件b-复制-粘贴-重命名" class="headerlink" title="(7) cp 已有文件a 新建文件b      (复制+粘贴+重命名)"></a>(7) cp 已有文件a 新建文件b      (复制+粘贴+重命名)</h5><p>​    将文件a复制成文件b，b可以是一个路径，比如../dir_c/b.txt，表示上层目录下的dir_c文件夹下的文件b.txt</p><h5 id="8-mkdir-文件夹名a"><a href="#8-mkdir-文件夹名a" class="headerlink" title="(8) mkdir 文件夹名a"></a>(8) mkdir 文件夹名a</h5><p>​    创建目录a</p><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">创建有空格个文件夹名mkdir a\ b ---&gt; 文件名为'a b'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="mkdir-a-b-c-p"><a href="#mkdir-a-b-c-p" class="headerlink" title="mkdir a/b/c -p"></a>mkdir a/b/c -p</h5><p>​     创建嵌套的父子文件夹</p><h5 id="9-rm-文件名a"><a href="#9-rm-文件名a" class="headerlink" title="(9) rm 文件名a"></a>(9) rm 文件名a</h5><p>​    删除普通文件</p><h5 id="rm-文件夹名a-r"><a href="#rm-文件夹名a-r" class="headerlink" title="rm 文件夹名a -r:"></a>rm 文件夹名a -r:</h5><p>​    删除文件夹</p><p>​     -r 递归删除</p><p>​     rm *.txt 删除所有的txt文件</p><p>​     rm a.txt b.txt 同时删除两个</p><h5 id="10-mv-旧文件a-旧文件b-剪切-粘贴"><a href="#10-mv-旧文件a-旧文件b-剪切-粘贴" class="headerlink" title="(10) mv 旧文件a 旧文件b      (剪切+粘贴)"></a>(10) mv 旧文件a 旧文件b      (剪切+粘贴)</h5><p>​    将XXX文件移动到YYY，和cp命令一样，XXX和YYY可以是一个路径；</p><p>​    <em>重命名</em>也是用这个命令</p><h5 id="11-touch-XXX"><a href="#11-touch-XXX" class="headerlink" title="(11) touch XXX:"></a>(11) touch XXX:</h5><p>​    创建一个文件</p><h5 id="12-cat-文件a"><a href="#12-cat-文件a" class="headerlink" title="(12) cat 文件a:"></a>(12) cat 文件a:</h5><p>​    展示文件a中的内容</p><h5 id="13-复制文本"><a href="#13-复制文本" class="headerlink" title="(13) 复制文本"></a>(13) 复制文本</h5><p>​    windows/Linux下：Ctrl + insert，Mac下：command + c</p><h5 id="14-粘贴文本"><a href="#14-粘贴文本" class="headerlink" title="(14) 粘贴文本"></a>(14) 粘贴文本</h5><p>​    windows/Linux下：Shift + insert，Mac下：command + v</p><p>一套后端框架可以服务多个应用(app, web…)</p><p>当前端点击一个链接，将这个URL作为函数参数传到后端，后端返回一个HTML文件，前端渲染成精美的网页。‘</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">string f(URL){......return HTML;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根目录： /</p><p>home：所有用户的家目录</p><p>bin：存常用可执行文件命令</p><p>etc：配置文件(部署一个网页 如nginx)</p><p>var : log -文件日志</p><p>lib：安装包，头文件</p><p>proc：进程相关信息</p><h3 id="一个点代表当前目录"><a href="#一个点代表当前目录" class="headerlink" title=". 一个点代表当前目录"></a>. 一个点代表当前目录</h3><h3 id="两个点代表上一层目录"><a href="#两个点代表上一层目录" class="headerlink" title=".. 两个点代表上一层目录"></a>.. 两个点代表上一层目录</h3><h3 id="代表home里面某个用户的家目录-俗称回城"><a href="#代表home里面某个用户的家目录-俗称回城" class="headerlink" title="~/ 代表home里面某个用户的家目录 俗称回城"></a>~/ 代表home里面某个用户的家目录 俗称回城</h3>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;常用命令&quot;&gt;&lt;a href=&quot;#常用命令&quot; class=&quot;headerlink&quot; title=&quot;常用命令&quot;&gt;&lt;/a&gt;常用命令&lt;/h3&gt;&lt;h5 id=&quot;1-ctrl-c&quot;&gt;&lt;a href=&quot;#1-ctrl-c&quot; class=&quot;headerlink&quot; title=&quot;(</summary>
      
    
    
    
    <category term="Linux" scheme="https://sakkana.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://sakkana.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>MySql - 7 约束</title>
    <link href="https://sakkana.github.io/2022/03/06/Mysql7%20%E7%BA%A6%E6%9D%9F/"/>
    <id>https://sakkana.github.io/2022/03/06/Mysql7%20%E7%BA%A6%E6%9D%9F/</id>
    <published>2022-03-06T11:51:01.000Z</published>
    <updated>2022-03-06T16:01:09.587Z</updated>
    
    <content type="html"><![CDATA[<h1 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h1><h5 id="Defination：作用于表中字段上的规则，限制表结构中存储的数据"><a href="#Defination：作用于表中字段上的规则，限制表结构中存储的数据" class="headerlink" title="Defination：作用于表中字段上的规则，限制表结构中存储的数据"></a>Defination：作用于表中字段上的规则，限制表结构中存储的数据</h5><h5 id="Target：保证数据库中数据的正确、有效性和完整性"><a href="#Target：保证数据库中数据的正确、有效性和完整性" class="headerlink" title="Target：保证数据库中数据的正确、有效性和完整性"></a>Target：保证数据库中数据的正确、有效性和完整性</h5><h5 id="Classification："><a href="#Classification：" class="headerlink" title="Classification："></a>Classification：</h5><table><thead><tr><th align="center">约束</th><th align="center">描述</th><th align="center">关键字</th></tr></thead><tbody><tr><td align="center">非空约束</td><td align="center">限制该字段的数据不能为NULL</td><td align="center">NOT NULL</td></tr><tr><td align="center">唯一约束</td><td align="center">保证该字段的所有数据都是唯一、不重复的</td><td align="center">UNIQUE</td></tr><tr><td align="center">主键约束</td><td align="center">主键是一行数据的唯一标识，要求【非空】且【唯一】</td><td align="center">PRIMARY KEY</td></tr><tr><td align="center">默认约束</td><td align="center">保存数据时，如果未指定该字段的值，则采用默认值</td><td align="center">DEFAULT</td></tr><tr><td align="center">检查约束(8.0.16版本之后)</td><td align="center">保证字段值满足某一个条件</td><td align="center">CHECK</td></tr><tr><td align="center">外键约束</td><td align="center">让两张表的数据之间建立连接，保证数据的一致性和完整性</td><td align="center">FOREIGN KEY</td></tr></tbody></table><p>约束是作用于表中【字段】上的，可以在【创建表/修改表】的时候添加约束</p><p>对于一个字段可以添加【多个】约束</p><p>多个约束之间用【空格分隔】即可</p><h5 id="如果插入一条【非法数据】，会提示插入失败，然而数据库还是为他申请了主键，因此自增的主键会空缺一条。"><a href="#如果插入一条【非法数据】，会提示插入失败，然而数据库还是为他申请了主键，因此自增的主键会空缺一条。" class="headerlink" title="如果插入一条【非法数据】，会提示插入失败，然而数据库还是为他申请了主键，因此自增的主键会空缺一条。"></a>如果插入一条【非法数据】，会提示插入失败，然而数据库还是为他申请了主键，因此自增的主键会空缺一条。</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> stu<span class="token punctuation">(</span>    id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键，自动增长'</span><span class="token punctuation">,</span>    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">COMMENT</span> <span class="token string">'不为空，且唯一'</span><span class="token punctuation">,</span>    age <span class="token keyword">tinyint</span> <span class="token keyword">unsigned</span> <span class="token keyword">CHECK</span> <span class="token punctuation">(</span> age <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">AND</span> age <span class="token operator">&lt;=</span> <span class="token number">120</span> <span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'大于0，且小于等于120'</span><span class="token punctuation">,</span>    <span class="token keyword">status</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span> <span class="token keyword">COMMENT</span> <span class="token string">'状态，默认为1'</span><span class="token punctuation">,</span>    gender <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'性别'</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'学生信息表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h4><h5 id="父表：具有【外键具体内容】的表"><a href="#父表：具有【外键具体内容】的表" class="headerlink" title="父表：具有【外键具体内容】的表"></a>父表：具有【外键具体内容】的表</h5><h5 id="子表：被外键约束的表"><a href="#子表：被外键约束的表" class="headerlink" title="子表：被外键约束的表"></a>子表：被外键约束的表</h5><h5 id="添加外键"><a href="#添加外键" class="headerlink" title="添加外键"></a>添加外键</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建时添加</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>字段名 数据名    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">[</span><span class="token keyword">CONSTRAINT</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>外键名称<span class="token punctuation">]</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>外键字段名<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表（主表中字段名）<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- 创建后添加</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> 外键名称 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>子表中外键字段名<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表<span class="token punctuation">(</span>主表中字段名<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="删除外键"><a href="#删除外键" class="headerlink" title="删除外键"></a>删除外键</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">DROP</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> 外键名；<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="删除-更新行为"><a href="#删除-更新行为" class="headerlink" title="删除/更新行为"></a>删除/更新行为</h5><table><thead><tr><th>行为</th><th>说明</th></tr></thead><tbody><tr><td>NO ACTION / RESTRICT</td><td>当父表中删除/更新对应记录时，首先检查该纪录是否有对应外键，如有，则不允许删除/更新。(默认行为)</td></tr><tr><td>CASCADE</td><td>当父表中删除/更新对应记录时，首先检查该纪录是否有对应外键，如有，则也删除/更新外键在子表中的记录。</td></tr><tr><td>SET NULL</td><td>当父表中删除/更新对应记录时，首先检查该纪录是否有对应外键，如有，则设置子表中该外键值为NULL(这就要求该外键允许取NULL)。</td></tr><tr><td>SET DEFAULT</td><td>父表有变更时，子表将外键列设置成一个默认的值(lnnobd不支持)。</td></tr></tbody></table><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> 外键名称 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>外键字段<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表名<span class="token punctuation">(</span>主表字段名<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CASCADE</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> emp    <span class="token keyword">add</span> <span class="token keyword">constraint</span> fk_emp_dept_id        <span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>dept_id<span class="token punctuation">)</span> <span class="token keyword">references</span> dept<span class="token punctuation">(</span>id<span class="token punctuation">)</span>            <span class="token keyword">on</span> <span class="token keyword">update</span> <span class="token keyword">set</span> <span class="token boolean">null</span> <span class="token keyword">on</span> <span class="token keyword">delete</span> <span class="token keyword">set</span> <span class="token boolean">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;约束&quot;&gt;&lt;a href=&quot;#约束&quot; class=&quot;headerlink&quot; title=&quot;约束&quot;&gt;&lt;/a&gt;约束&lt;/h1&gt;&lt;h5 id=&quot;Defination：作用于表中字段上的规则，限制表结构中存储的数据&quot;&gt;&lt;a href=&quot;#Defination：作用于表中字段上</summary>
      
    
    
    
    <category term="数据库" scheme="https://sakkana.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="数据库" scheme="https://sakkana.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>MySql - 6 函数</title>
    <link href="https://sakkana.github.io/2022/03/06/Mysql6%20%E5%87%BD%E6%95%B0/"/>
    <id>https://sakkana.github.io/2022/03/06/Mysql6%20%E5%87%BD%E6%95%B0/</id>
    <published>2022-03-06T10:41:01.000Z</published>
    <updated>2022-03-06T11:01:45.246Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-字符串函数"><a href="#1-字符串函数" class="headerlink" title="1.字符串函数"></a>1.字符串函数</h1><table><thead><tr><th align="center">函数</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">CONCAT($S_1,S_2,…S_n$)</td><td align="center">字符串拼接</td></tr><tr><td align="center">LOWER(str)</td><td align="center">将str全部转为小写</td></tr><tr><td align="center">UPPER(str)</td><td align="center">将str全部转为大写</td></tr><tr><td align="center">LPAD(str,n,c)</td><td align="center">用字符c对str进行n个左填充</td></tr><tr><td align="center">RPAD(str,n,c)</td><td align="center">用字符c对str进行n个右填充</td></tr><tr><td align="center">TRIM(str)</td><td align="center">去掉str头部和尾部的空格</td></tr><tr><td align="center">SUBSTRING(str,statr,len)</td><td align="center">返回str中start开始的len长度的子串，下标从1开始</td></tr></tbody></table><p>1.企业员工的工号统一为5位数字，不足的在前面补0</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> info <span class="token keyword">SET</span> workid <span class="token operator">=</span> LPAD<span class="token punctuation">(</span>workid<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="2-数值函数"><a href="#2-数值函数" class="headerlink" title="2. 数值函数"></a>2. 数值函数</h1><table><thead><tr><th align="center">函数</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">CEIL(x)</td><td align="center">向上取整</td></tr><tr><td align="center">FLOOR(x)</td><td align="center">向下取整</td></tr><tr><td align="center">MOD(x, y)</td><td align="center">返回x/y的模</td></tr><tr><td align="center">RAND()</td><td align="center">返回0~1内的随机数</td></tr><tr><td align="center">ROUND(x, y)</td><td align="center">求参数x的四舍五入的值，保留y位小数</td></tr></tbody></table><p>生成6位数字的随机验证码</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">899999</span> <span class="token operator">+</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">SELECT</span> LPAD<span class="token punctuation">(</span><span class="token function">ROUND</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="3-日期函数"><a href="#3-日期函数" class="headerlink" title="3.日期函数"></a>3.日期函数</h1><table><thead><tr><th align="center">函数</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">CURDATE()</td><td align="center">返回当前日期</td></tr><tr><td align="center">CURTIME()</td><td align="center">返回当前时间</td></tr><tr><td align="center">NOW()</td><td align="center">返回当前日期和时间</td></tr><tr><td align="center">YEAR(date)</td><td align="center">获取指定的date年份</td></tr><tr><td align="center">MONTH(date)</td><td align="center">获取指定的date月份</td></tr><tr><td align="center">DAY(date)</td><td align="center">获取指定的date日期</td></tr><tr><td align="center">DATE_ADD(date, INTERVAL expr type)</td><td align="center">返回一个日期/时间加上一个时间间隔expr后的时间值</td></tr><tr><td align="center">DATEDIFF(data1, data2)</td><td align="center">返回起始时间date1和结束时间date2之前的天数(date1 - date2)</td></tr></tbody></table><p>从现在开始往后推70天。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> DATE_ADD<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">INTERVAL</span> <span class="token number">70</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>NOW() : 2022-03-06 18:25:40</p><p>SELECT DATE_ADD(NOW(),INTERVAL 70 DAY); : 2022-05-15 18:25:59</p></blockquote><p>查询员工从出生到现在活了多少天，并按照降序排序。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name<span class="token punctuation">,</span> birthday<span class="token punctuation">,</span> DATEDIFF<span class="token punctuation">(</span>CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> birthday<span class="token punctuation">)</span> diff <span class="token keyword">FROM</span> info <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> diff <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="4-流程函数"><a href="#4-流程函数" class="headerlink" title="4. 流程函数"></a>4. 流程函数</h1><table><thead><tr><th align="center">函数</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">IF(value, t, f)</td><td align="center">如果value位true返回t，否则返回f</td></tr><tr><td align="center">IFNULL(value1, value2)</td><td align="center">如果value1为空，返回value1,否则返回value2</td></tr><tr><td align="center">CASE WHEN [val1] THEN [RES1] … ELSE [default] END</td><td align="center">如果val1为true，返回res1,否则返回default默认值</td></tr><tr><td align="center">CASE [expr] WHEN [val1] THEN [res1] … ELSE [default] END</td><td align="center">如果expr = val1,返回res1，否则返回default默认值</td></tr></tbody></table><blockquote><p>空串不为空</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> IFNULL<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'我是默认值'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote></blockquote><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> IFNULL<span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'我是默认值'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>我是默认值</p></blockquote></blockquote><p>查询员工姓名与工作城市，如果是北京或深圳则显示一线城市，否则显示二线城市</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>       name<span class="token punctuation">,</span>       <span class="token punctuation">(</span><span class="token keyword">CASE</span> workplace           <span class="token keyword">WHEN</span> <span class="token string">'北京'</span> <span class="token keyword">THEN</span> <span class="token string">'一线城市'</span>           <span class="token keyword">WHEN</span> <span class="token string">'深圳'</span> <span class="token keyword">THEN</span> <span class="token string">'二线城市'</span>           <span class="token keyword">ELSE</span> <span class="token string">'二线城市'</span>        <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'工作地址'</span><span class="token keyword">FROM</span> info<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查询学生成绩并且分级</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>       customer_id<span class="token punctuation">,</span>       last_name<span class="token punctuation">,</span>       <span class="token punctuation">(</span>           <span class="token keyword">CASE</span>           <span class="token keyword">WHEN</span> points <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token keyword">THEN</span> <span class="token string">'不及格'</span>           <span class="token keyword">WHEN</span> points <span class="token operator">&lt;</span> <span class="token number">2000</span> <span class="token keyword">THEN</span> <span class="token string">'良好'</span>           <span class="token keyword">ELSE</span> <span class="token string">'优秀'</span>           <span class="token keyword">END</span>       <span class="token punctuation">)</span> <span class="token string">'学生成绩评定'</span><span class="token keyword">FROM</span> customers<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-字符串函数&quot;&gt;&lt;a href=&quot;#1-字符串函数&quot; class=&quot;headerlink&quot; title=&quot;1.字符串函数&quot;&gt;&lt;/a&gt;1.字符串函数&lt;/h1&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;函数&lt;/th&gt;
&lt;th a</summary>
      
    
    
    
    <category term="数据库" scheme="https://sakkana.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="数据库" scheme="https://sakkana.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>MySql - 5 用户管理、权限控制 DCL</title>
    <link href="https://sakkana.github.io/2022/03/06/Mysql5%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E3%80%81%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6/"/>
    <id>https://sakkana.github.io/2022/03/06/Mysql5%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E3%80%81%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6/</id>
    <published>2022-03-06T04:40:01.000Z</published>
    <updated>2022-03-06T05:19:57.396Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DCL"><a href="#DCL" class="headerlink" title="DCL"></a>DCL</h1><h2 id="Data-Control-Language"><a href="#Data-Control-Language" class="headerlink" title="Data Control Language"></a>Data Control Language</h2><h3 id="1-管理数据库用户-有哪些用户可以访问？"><a href="#1-管理数据库用户-有哪些用户可以访问？" class="headerlink" title="1. 管理数据库用户 - 有哪些用户可以访问？"></a>1. 管理数据库用户 - 有哪些用户可以访问？</h3><h4 id="1-1-查询用户"><a href="#1-1-查询用户" class="headerlink" title="1.1 查询用户"></a>1.1 查询用户</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> mysql<span class="token punctuation">;</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>创建用户在任意主机登录该数据库。</p><h4 id="1-2-创建用户"><a href="#1-2-创建用户" class="headerlink" title="1.2 创建用户"></a>1.2 创建用户</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'密码'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'miniFish'</span> @ <span class="token string">'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'123456'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="1-3-修改用户密码"><a href="#1-3-修改用户密码" class="headerlink" title="1.3 修改用户密码"></a>1.3 修改用户密码</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">USER</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span> IDENTIFIED <span class="token keyword">WITH</span> mysql_native_password <span class="token keyword">BY</span> <span class="token string">'新密码'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="1-4-删除用户"><a href="#1-4-删除用户" class="headerlink" title="1.4 删除用户"></a>1.4 删除用户</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">USER</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>1.主机名可以使用%通配。</p><p>2.这一节的SQL开发人员操作的比较少，主要是DBA使用。</p></blockquote><h3 id="2-权限控制-用户连接上之后可以访问哪几个数据库、数据表，有什么权限？"><a href="#2-权限控制-用户连接上之后可以访问哪几个数据库、数据表，有什么权限？" class="headerlink" title="2. 权限控制 - 用户连接上之后可以访问哪几个数据库、数据表，有什么权限？"></a>2. 权限控制 - 用户连接上之后可以访问哪几个数据库、数据表，有什么权限？</h3><h3 id="2-1-查询权限"><a href="#2-1-查询权限" class="headerlink" title="2.1 查询权限"></a>2.1 查询权限</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> GRANTS <span class="token keyword">FOR</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-2-授予权限"><a href="#2-2-授予权限" class="headerlink" title="2.2 授予权限"></a>2.2 授予权限</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">GRANT</span> 权限们 <span class="token keyword">ON</span> 数据库名<span class="token punctuation">.</span>表名 <span class="token keyword">TO</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-3-撤销权限"><a href="#2-3-撤销权限" class="headerlink" title="2.3 撤销权限"></a>2.3 撤销权限</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">REVOKE</span> 权限列表 <span class="token keyword">ON</span> 数据库名<span class="token punctuation">.</span>表名 <span class="token keyword">FROM</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>1.多个权限之间，使用逗号通配</p><p>2.授权时，数据库名和表名都可以使用 * 进行通配，代表所有</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;DCL&quot;&gt;&lt;a href=&quot;#DCL&quot; class=&quot;headerlink&quot; title=&quot;DCL&quot;&gt;&lt;/a&gt;DCL&lt;/h1&gt;&lt;h2 id=&quot;Data-Control-Language&quot;&gt;&lt;a href=&quot;#Data-Control-Language&quot; class</summary>
      
    
    
    
    <category term="数据库" scheme="https://sakkana.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="数据库" scheme="https://sakkana.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>mySql - 4 查询 DQL</title>
    <link href="https://sakkana.github.io/2022/03/05/Mysql4%20%E6%9F%A5%E8%AF%A2/"/>
    <id>https://sakkana.github.io/2022/03/05/Mysql4%20%E6%9F%A5%E8%AF%A2/</id>
    <published>2022-03-05T14:06:01.000Z</published>
    <updated>2022-03-05T18:04:36.849Z</updated>
    
    <content type="html"><![CDATA[<h1 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h1><h5 id="DQL-编写顺序"><a href="#DQL-编写顺序" class="headerlink" title="DQL 编写顺序"></a>DQL 编写顺序</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们<span class="token keyword">FROM</span> 表名们<span class="token keyword">WHERE</span> 条件们<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 分组字段们<span class="token keyword">HAVING</span> 分组后条件们<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 排序字段们<span class="token keyword">LIMIT</span> 分页参数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="DQL-执行顺序"><a href="#DQL-执行顺序" class="headerlink" title="DQL 执行顺序"></a>DQL 执行顺序</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">FEOM 要先知道从哪张表<span class="token keyword">WHERE</span> 知道限制条件，先剔除一部分<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 怎么分组<span class="token keyword">HAVING</span> 分组后的条件<span class="token keyword">SELECT</span> 查询哪几个字段<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 怎么排序<span class="token keyword">LIMIT</span> 查多少<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>基本查询</p><blockquote><p>SELECT<br>FROM </p></blockquote></blockquote><blockquote><p>条件查询</p><blockquote><p>WHERE</p></blockquote></blockquote><blockquote><p>分组查询 + </p><p>聚合函数 COUNT, MAX, MIN, AVE, SUM</p><blockquote><p>GROPU BY</p><p>HAVING</p></blockquote></blockquote><blockquote><p>排序查询</p><blockquote><p>ORDER BY</p></blockquote></blockquote><blockquote><p>分页查询</p><blockquote><p>LIMIT</p></blockquote></blockquote><h2 id="1-基本查询"><a href="#1-基本查询" class="headerlink" title="1.基本查询"></a>1.基本查询</h2><h3 id="1-1-查询多个字段"><a href="#1-1-查询多个字段" class="headerlink" title="1.1 查询多个字段"></a>1.1 查询多个字段</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段<span class="token number">1</span>，字段<span class="token number">2</span>，字段<span class="token number">3</span> <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-2-查询所有字段"><a href="#1-2-查询所有字段" class="headerlink" title="1.2 查询所有字段"></a>1.2 查询所有字段</h3><p>实际开发少写*</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-3-设置别名"><a href="#1-3-设置别名" class="headerlink" title="1.3 设置别名"></a>1.3 设置别名</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段<span class="token number">1</span><span class="token punctuation">[</span><span class="token keyword">AS</span> 别名<span class="token number">1</span><span class="token punctuation">]</span>， 字段<span class="token number">2</span><span class="token punctuation">[</span><span class="token keyword">AS</span> 别名<span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> 表名：<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-4-去重"><a href="#1-4-去重" class="headerlink" title="1.4 去重"></a>1.4 去重</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> 字段列表 <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="2-条件查询"><a href="#2-条件查询" class="headerlink" title="2. 条件查询"></a>2. 条件查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 条件们<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th align="center">比较运算符</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">&gt;</td><td align="center">大于</td></tr><tr><td align="center">&gt;=</td><td align="center">大于等于</td></tr><tr><td align="center">&lt;</td><td align="center">小于</td></tr><tr><td align="center">&lt;=</td><td align="center">小于等于</td></tr><tr><td align="center">=</td><td align="center">等于</td></tr><tr><td align="center">&lt;&gt;  或  !=</td><td align="center">不等于</td></tr><tr><td align="center">BETWEEN … AND ….</td><td align="center">在某个区间内(包含max和min)</td></tr><tr><td align="center">IN(…)</td><td align="center">在IN后的列表中的值，多选一</td></tr><tr><td align="center">LIKE 占位符</td><td align="center">模糊匹配(_匹配单个字符, %匹配任意字符)</td></tr><tr><td align="center">IS NULL</td><td align="center">是NULL</td></tr></tbody></table><table><thead><tr><th align="center">逻辑运算符</th><th align="center"></th></tr></thead><tbody><tr><td align="center">AND 或 &amp;&amp;</td><td align="center">并且</td></tr><tr><td align="center">OR 或 ||</td><td align="center">或</td></tr><tr><td align="center">NOT 或 !</td><td align="center">非</td></tr></tbody></table><h5 id="若要判断NULL值，需要使用IS"><a href="#若要判断NULL值，需要使用IS" class="headerlink" title="若要判断NULL值，需要使用IS"></a>若要判断NULL值，需要使用IS</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段名 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 字段名 <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span class="token keyword">SELECT</span> 字段名 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 字段名 <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="IN语句可以代替连续的多个OR"><a href="#IN语句可以代替连续的多个OR" class="headerlink" title="IN语句可以代替连续的多个OR"></a>IN语句可以代替连续的多个OR</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段名 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 条件<span class="token number">1</span> <span class="token operator">OR</span> 条件<span class="token number">2</span> <span class="token operator">OR</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token keyword">SELECT</span> 字段名 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 条件 <span class="token operator">IN</span><span class="token punctuation">(</span>条件<span class="token number">1</span>，条件<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="占位符实现模糊匹配"><a href="#占位符实现模糊匹配" class="headerlink" title="占位符实现模糊匹配"></a>占位符实现模糊匹配</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">查询first_name为<span class="token number">5</span>个字母的人<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> first_name <span class="token operator">LIKE</span> <span class="token string">'_____'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">查询last_name以y结尾的人<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> last_name <span class="token operator">LIKE</span> <span class="token string">'%y'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="3-分组查询"><a href="#3-分组查询" class="headerlink" title="3. 分组查询"></a>3. 分组查询</h2><h3 id="3-1-聚合函数"><a href="#3-1-聚合函数" class="headerlink" title="3.1 聚合函数"></a>3.1 聚合函数</h3><blockquote><p>将某一列数据作为一个整体，进行纵向计算</p></blockquote><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 聚合函数<span class="token punctuation">(</span>字段们<span class="token punctuation">)</span> <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="字段值为NULL的数据不参与COUNT计算"><a href="#字段值为NULL的数据不参与COUNT计算" class="headerlink" title="字段值为NULL的数据不参与COUNT计算"></a>字段值为NULL的数据不参与COUNT计算</h5><h3 id="3-2-分组查询"><a href="#3-2-分组查询" class="headerlink" title="3.2 分组查询"></a>3.2 分组查询</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 分组字段名 <span class="token punctuation">[</span><span class="token keyword">HAVING</span> 分组过滤后条件<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="WHERE和HAVING的区别"><a href="#WHERE和HAVING的区别" class="headerlink" title="WHERE和HAVING的区别"></a>WHERE和HAVING的区别</h5><blockquote><p>执行时机不同：WHERE是分组前过滤，不满足者不参与分组；HAVING是分组之后对结果过滤；</p><p>判断条件不同：WHERE不能对聚合函数进行判断，而HAVING可以。</p></blockquote><p> 统计不同年份出生的人的数量</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> birth_date<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> customers <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">year</span><span class="token punctuation">(</span>birth_date<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>根据性别分组，统计男性员工和女性员工的数量。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> gender<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> info <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> gender<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>根据性别分组，统计男性员工和女性员工的平均年龄。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> gender<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> <span class="token keyword">FROM</span> info <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> gender<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查询年龄小于45岁的员工，并根据工作地址分组，获取员工数量大于等于3的工作地址。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> workplace<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> age <span class="token operator">&lt;</span> <span class="token number">45</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> workplace <span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">SELECT</span> workplace<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> address_count <span class="token keyword">WHERE</span> age <span class="token operator">&lt;</span> <span class="token number">45</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> workplace <span class="token keyword">HAVING</span> ddress_count <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>执行顺序：WHERE &gt; 聚合函数 &gt; HAVING </p><p>分组之后，查询的字段一般为聚合函数和分组字段，查询其他字段没有意义。因此，通常SELECT 分组字段 + 聚合函数</p></blockquote><h2 id="4-排序查询"><a href="#4-排序查询" class="headerlink" title="4.排序查询"></a>4.排序查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表名 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 字段<span class="token number">1</span> 排序方式<span class="token number">1</span><span class="token punctuation">,</span> 字段<span class="token number">2</span> 排序方式<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="排序方式："><a href="#排序方式：" class="headerlink" title="排序方式："></a>排序方式：</h4><h5 id="ASC-升序-默认-ASC可以省略"><a href="#ASC-升序-默认-ASC可以省略" class="headerlink" title="ASC:升序 (默认) ASC可以省略"></a>ASC:升序 (默认) ASC可以省略</h5><h5 id="DESC-降序"><a href="#DESC-降序" class="headerlink" title="DESC:降序"></a>DESC:降序</h5><blockquote><p>如果是多字段排序，如果第一个字段相同，才会根据第二个字段进行排序。</p></blockquote><h2 id="5-分页查询"><a href="#5-分页查询" class="headerlink" title="5. 分页查询"></a>5. 分页查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表名 <span class="token keyword">LIMIT</span> 起始索引<span class="token punctuation">,</span>查询记录数<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>1.起始索引从0开始，且</p><blockquote><p>起始索引 = (查询页码 - 1) * 每页显示记录数</p></blockquote><p>2.分页查询是数据库方言，MySql中是LIMIT</p><p>3.如果查询第一页，起始索引可以省略，直接写成LIMIT 每页显示记录数。</p></blockquote><h5 id="EXERCISE"><a href="#EXERCISE" class="headerlink" title="EXERCISE"></a>EXERCISE</h5><p>1.查询年龄为20，21，22，23岁的员工信息。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> info <span class="token keyword">WHERE</span> gender <span class="token operator">=</span> <span class="token string">'女'</span><span class="token punctuation">,</span>age <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2.查询性别为男，并且年龄在20-40岁(含)以内的姓名为三个字的员工。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> info <span class="token keyword">WHERE</span> gender <span class="token operator">=</span> <span class="token string">'男'</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>age <span class="token operator">BETWEEN</span> <span class="token number">20</span> <span class="token operator">AND</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">AND</span> name <span class="token operator">LIKE</span> <span class="token string">'___'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>3.统计员工表中，年龄小于60岁的，男性员工和女性员工的人数。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> gender<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> info <span class="token keyword">WHERE</span> age <span class="token operator">&lt;</span> <span class="token number">60</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> gender<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>4.查询所有年龄小于等于35岁员工的姓名和年龄，并对查询结果按年龄升序排序，如果年龄相同按入职时间降序排序。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name<span class="token punctuation">,</span> age <span class="token keyword">FROM</span> info <span class="token keyword">WHERE</span> sge <span class="token operator">&lt;=</span> <span class="token number">35</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">ASC</span><span class="token punctuation">,</span>workdate <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>5.查询性别为男，且年龄在20-40岁(含)以内的前5个员工的信息，对查询的结果按年龄升序排序，年龄相同按入职时间升序排序。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> info <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>age BWETEEN <span class="token number">20</span> <span class="token operator">AND</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">AND</span> gender <span class="token operator">=</span> <span class="token string">'男'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">ASC</span><span class="token punctuation">,</span>workdate <span class="token keyword">ASC</span> <span class="token keyword">LIMIT</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>先ORDER BY，再LIMIT</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;查询&quot;&gt;&lt;a href=&quot;#查询&quot; class=&quot;headerlink&quot; title=&quot;查询&quot;&gt;&lt;/a&gt;查询&lt;/h1&gt;&lt;h5 id=&quot;DQL-编写顺序&quot;&gt;&lt;a href=&quot;#DQL-编写顺序&quot; class=&quot;headerlink&quot; title=&quot;DQL 编写顺序&quot;</summary>
      
    
    
    
    <category term="数据库" scheme="https://sakkana.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="数据库" scheme="https://sakkana.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>MySql - 3 操作数据 DML</title>
    <link href="https://sakkana.github.io/2022/03/05/Mysql3%20%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE/"/>
    <id>https://sakkana.github.io/2022/03/05/Mysql3%20%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE/</id>
    <published>2022-03-04T16:05:01.000Z</published>
    <updated>2022-03-06T11:03:34.885Z</updated>
    
    <content type="html"><![CDATA[<h1 id="操作数据"><a href="#操作数据" class="headerlink" title="操作数据"></a>操作数据</h1><h2 id="1-添加数据"><a href="#1-添加数据" class="headerlink" title="1. 添加数据"></a>1. 添加数据</h2><h3 id="1-1-给【指定字段】添加数据"><a href="#1-1-给【指定字段】添加数据" class="headerlink" title="1.1  给【指定字段】添加数据"></a>1.1  给【指定字段】添加数据</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名<span class="token punctuation">(</span>字段<span class="token number">1</span><span class="token punctuation">,</span>字段<span class="token number">2</span><span class="token punctuation">,</span>字段<span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span>值<span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-2-给【所有字段】添加数据"><a href="#1-2-给【所有字段】添加数据" class="headerlink" title="1.2  给【所有字段】添加数据"></a>1.2  给【所有字段】添加数据</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名 <span class="token keyword">VALUES</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span>值<span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-3-批量添加数据"><a href="#1-3-批量添加数据" class="headerlink" title="1.3  批量添加数据"></a>1.3  批量添加数据</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名<span class="token punctuation">(</span>字段<span class="token number">1</span><span class="token punctuation">,</span>字段<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名 <span class="token keyword">VALUES</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>1.插入数据的字段顺序必须与值的顺序一一对应。</p><p>2.字符串和日期必须被包含在引号内。</p><p>3.插入数据的大小必须在字段的规定范围内。</p></blockquote><h2 id="2-修改数据"><a href="#2-修改数据" class="headerlink" title="2. 修改数据"></a>2. 修改数据</h2><p>如果没有条件就修改整张表</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> 表名 <span class="token keyword">SET</span> 字段名<span class="token number">1</span> <span class="token operator">=</span> 值<span class="token number">1</span><span class="token punctuation">,</span> 字段名<span class="token number">2</span> <span class="token operator">=</span> 值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="3-删除数据"><a href="#3-删除数据" class="headerlink" title="3. 删除数据"></a>3. 删除数据</h2><p>如果不加WHERE会删除整张表</p><p>DELETE不能删除某个字段的值</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;操作数据&quot;&gt;&lt;a href=&quot;#操作数据&quot; class=&quot;headerlink&quot; title=&quot;操作数据&quot;&gt;&lt;/a&gt;操作数据&lt;/h1&gt;&lt;h2 id=&quot;1-添加数据&quot;&gt;&lt;a href=&quot;#1-添加数据&quot; class=&quot;headerlink&quot; title=&quot;1. 添加</summary>
      
    
    
    
    <category term="数据库" scheme="https://sakkana.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="数据库" scheme="https://sakkana.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
</feed>
