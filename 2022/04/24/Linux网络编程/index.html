<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Linux网络编程, 魚のブログ">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Linux网络编程 | 魚のブログ</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="魚のブログ" type="application/atom+xml">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">魚のブログ</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">魚のブログ</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Linux网络编程</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/C-C/">
                                <span class="chip bg-color">C/C++</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/" class="post-category">
                                系统编程
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-04-24
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    18.8k
                </div>
                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Linux-网络编程"><a href="#Linux-网络编程" class="headerlink" title="Linux 网络编程"></a>Linux 网络编程</h1><h2 id="1-网络结构模式"><a href="#1-网络结构模式" class="headerlink" title="1. 网络结构模式"></a>1. 网络结构模式</h2><h3 id="C-S-结构"><a href="#C-S-结构" class="headerlink" title="C/S 结构"></a>C/S 结构</h3><h5 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h5><p>​        客户机 - 服务器，即 Client - Server（C/S）结构。</p>
<p>​        C/S 结构通常采取两层结构。服务器负责数据的 管理，客户机负责完成与用户的交互任务。客户机是因特网上访问别人信息的机器，<code>服务器</code>则是<code>提 供信息供人访问</code>的<code>计算机</code>。 </p>
<p>​        客户机通过<code>局域网</code>与服务器相连，接受用户的请求，并通过网络向服务器提出请求，对数据库进行操作。</p>
<blockquote>
<p><code>服务器</code>接受客户机的请求，将数据提交给客户机，客户机将数据进行计算并将结果呈现给用户。</p>
<p><code>服务器</code>还要提供完善安全保护及对数据完整性的处理等操作，并允许多个客户机同时访问服务器（企业有很多的服务器，形成<code>服务器集群</code>），这就对服务器的硬件处理数据能力提出了很高的要求。 </p>
</blockquote>
<p>​        </p>
<p>在C/S结构中，应用程序分为两部分：服务器部分和客户机部分。</p>
<blockquote>
<p><code>服务器</code>部分是多个用户共享的信息与功能，执行后台服务，如控制共享数据库的操作等；</p>
<p><code>客户机</code>部分为用户所专有，负责执行前台功能，在出错提示、在线帮助等方面都有强大的功能，并且可以在子程序间自由切换。</p>
</blockquote>
<p>如QQ。</p>
<h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><ol>
<li>能充分发挥<code>客户端 PC 的处理能力</code>，很多工作可以在客户端处理后再提交给服务器，所以 C/S 结构 客户端响应速度快；</li>
<li> 操作界面漂亮、形式多样，可以充分满足客户自身的个性化要求； </li>
<li>C/S 结构的管理信息系统具有较强的事务处理能力（利用PC性能），能实现复杂的业务流程； </li>
<li>安全性较高，C/S 一般面向相对固定的用户群，程序更加注重流程，它可以对权限进行多层次校 验，提供了更安全的存取模式，对信息安全的控制能力很强，一般高度机密的信息系统采用 C/S 结 构适宜。</li>
</ol>
<p>比如玩端游一般都有个客户端，许多工作都是在客户端上完成，不定时将数据传送到服务器端。这也解释了为什么许多端游都对客户端机器有硬件及软件要求。</p>
<p>网页游戏其实也有客户端，它的客户端是浏览器，性能肯定比不上客户端软件。</p>
<h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><ol>
<li><p>客户端需要安装专用的客户端软件。</p>
<p>首先涉及到安装的工作量，其次<code>任何一台</code>电脑出问题，如病毒、硬件损坏，都需要进行安装或维护。</p>
<p>系统软件升级时，<code>每一台</code>客户机需要重新安装，其维护和升级成本非常高； </p>
</li>
<li><p>对客户端的操作系统一般也会有限制，<code>不能够跨平台</code>。</p>
</li>
</ol>
<h3 id="B-S-结构"><a href="#B-S-结构" class="headerlink" title="B/S 结构"></a>B/S 结构</h3><h5 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h5><p>B/S 结构（Browser/Server，浏览器/服务器模式），是 WEB 兴起后的一种网络结构模式，<code>WEB 浏览器</code>是客户端最主要的应用软件。这种模式<code>统一了客户端</code>，将系统功能实现的<code>核心部分</code>集中到<code>服务器</code>上，简化了系统的开发、维护和使用。客户机上只要安装一个浏览器，如 Firefox 或 Internet Explorer，服务器安装 SQL Server、Oracle、MySQL 等数据库。浏览器通过 Web Server 同数据库进行数据交互。</p>
<h5 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h5><p>B/S 架构最大的优点是总体拥有成本低、维护方便、 分布性强、开发简单，可以不用安装任何专门的软件就能实现在任何地方进行操作，<code>客户端零维护</code>，系统的扩展非常容易，只要有一台能上网的电脑就能使用。</p>
<h5 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h5><ol>
<li>通信开销大、系统和数据的安全性较难保障; </li>
<li>个性特点明显降低，无法实现具有个性化的功能要求； </li>
<li>协议一般是固定（无法操作大数据量的文件）的：http/https （C/S架构可以自己规定协议）</li>
<li>客户端服务器端的<code>交互</code>是<code>请求-响应模式</code>，通常动态刷新页面，响应速度明显降低。</li>
</ol>
<p>看看就好了，没啥有营养的东西。</p>
<h2 id="2-MAC地址、IP地址、端口"><a href="#2-MAC地址、IP地址、端口" class="headerlink" title="2. MAC地址、IP地址、端口"></a>2. MAC地址、IP地址、端口</h2><h4 id="2-1-MAC-地址"><a href="#2-1-MAC-地址" class="headerlink" title="2.1. MAC 地址"></a>2.1. MAC 地址</h4><p>​        网卡是一块被设计用来允许计算机在计算机网络上进行通讯的计算机硬件，又称为网络适配器或网 络接口卡NIC。其拥有 MAC 地址，属于 OSI 模型的第 2 层，它使得用户可以通过电缆或无线相互 连接。每一个网卡都有一个被称为 MAC 地址的独一无二的 48 位（6 bytes）串行号。</p>
<p>​        网卡的主要功能：</p>
<ul>
<li>数据的封装与解封装</li>
<li>链路管理</li>
<li>数据编码与译码</li>
</ul>
<p>​        MAC 地址（Media Access Control Address），直译为媒体存取控制位址，也称为局域网地址、 以太网地址、物理地址或硬件地址，它是一个用来确认网络设备位置的位址，由网络设备制造商生 产时烧录在网卡中。</p>
<p>​        在 OSI 模型中，<code>第三层网络层负责 IP 地址，第二层数据链路层则负责 MAC 位址</code> 。MAC 地址用于在网络中唯一标识一个网卡，一台设备若有一或多个网卡，则每个网卡都需 要并会有一个唯一的 MAC 地址。 MAC 地址的长度为 48 位（6个字节），通常表示为 12 个 16 进制数，如：00-16-EA-AE-3C-40 就 是一个MAC 地址，其中前 3 个字节，16 进制数 00-16-EA 代表网络硬件制造商的编号，它由 IEEE（电气与电子工程师协会）分配，而后 3 个字节，16进制数 AE-3C-40 代表该制造商所制造的 某个网络产品（如网卡）的系列号。只要不更改自己的 MAC 地址，MAC 地址在世界是唯一的。 形象地说，MAC 地址就如同身份证上的身份证号码，具有唯一性。</p>
<h4 id="4-2-IP-地址"><a href="#4-2-IP-地址" class="headerlink" title="4.2. IP 地址"></a>4.2. IP 地址</h4><h5 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h5><p>​        IP 协议是为计算机网络相互连接进行通信而设计的协议。在因特网中，它是能使连接到网上的所有计算机网络实现<code>相互通信</code>的一套规则，规定了计算机在因特网上进行通信时应当遵守的规则。<code>任何厂家生产的计算机系统，只要遵守 IP 协议就可以与因特网互连互通。</code>各个厂家生产的网络系统 和设备，如以太网、分组交换网等，它们相互之间不能互通，不能互通的主要原因是因为它们所传 送数据的基本单元（技术上称之为“帧”）的格式不同。（相当于两个说中文和英文的人无法交流，如果大家约定都说法文，那么就可以交流了）</p>
<p>​        IP 协议实际上是一套由软件程序组成的协议 软件，它把各种不同“帧”统一转换成“IP 数据报”格式，这种转换是因特网的一个最重要的特点，使所有各种计算机都能在因特网上实现互通，即具有“开放性”的特点。正是因为有了 IP 协议，因特 网才得以迅速发展成为世界上最大的、开放的计算机通信网络。因此，IP 协议也可以叫做“因特网 协议”。 </p>
<p>​        IP 地址（Internet Protocol Address）是指互联网协议地址，又译为网际协议地址。IP 地址是 IP 协议提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个<code>逻辑地址</code>，以 此来<code>屏蔽物理地址的差异</code>。 IP 地址是一个 <code>32 位</code>的二进制数，通常被分割为 4 个“ 8 位二进制数”（也就是 4 个字节）。IP 地址 通常用“点分十进制”表示成（a.b.c.d）的形式，其中，a,b,c,d都是 0~255 之间的十进制整数。 例：点分十进IP地址（100.4.5.6），实际上是 32 位二进制数 （01100100.00000100.00000101.00000110）。（是个被分配的逻辑地址，相当于你的学号，并不是你与生俱来的，而是为了通信给你分配的）</p>
<h5 id="IP-地址编址方式"><a href="#IP-地址编址方式" class="headerlink" title="IP 地址编址方式"></a>IP 地址编址方式</h5><p>​        最初设计互联网络时，为了便于寻址以及层次化构造网络，每个 IP 地址包括<code>两个标识码（ID）</code>，即<code>网络 ID</code> 和<code>主机 ID</code>。</p>
<p>​        <code>同一个物理网络</code>上的所有主机都使用<code>同一个网络 ID</code>，网络上的<code>一个主机</code>（包括网络上工 作站，服务器和路由器等）有一个<code>主机 ID</code> 与其对应。Internet 委员会定义了 5 种 IP 地址类型以适合不 同容量的网络，即 A 类~ E 类。 其中 <code>A、B、C</code> 3类（如下表格）由 InternetNIC 在全球范围内统一分配，<code>D、E</code> 类为特殊地址。</p>
<p>​        比如 IP <code>192.168.100.235</code>，前三个就是网络IP，这台电脑在 192.168.100 这个网段里面，最后的 235 就是主机 IP。</p>
<p><img src="https://img-blog.csdnimg.cn/fe8b606af4df4b30b4acfdbff1dc9ab6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h5 id="A类地址"><a href="#A类地址" class="headerlink" title="A类地址"></a>A类地址</h5><p>​        一个 A 类 IP 地址是指， 在 IP 地址的四段号码中，第一段号码为网络号码，剩下的三段号码为本地计算机的号码。</p>
<p>​        如果用二进制表示 IP 地址的话，A 类 IP 地址就由 1 字节的网络地址和 3 字节主机地址组 成，网络地址的最高位必须是“0”。A 类 IP 地址中网络的标识长度为 8 位，主机标识的长度为 24 位，A 类网络地址数量较少，有 126 个网络，每个网络可以容纳主机数达 1600 多万台。 A 类 IP 地址 地址范围 1.0.0.1 - 126.255.255.254（二进制表示为：00000001 00000000 00000000 00000001 - 01111111 11111111 11111111 11111110）。最后一个是广播地址。 A 类 IP 地址的子网掩码为 255.0.0.0，每个网络支持的最大主机数为 256 的 3 次方 - 2 = 16777214 台。</p>
<h5 id="B类地址"><a href="#B类地址" class="headerlink" title="B类地址"></a>B类地址</h5><h5 id="C类地址"><a href="#C类地址" class="headerlink" title="C类地址"></a>C类地址</h5><h4 id="2-3-端口"><a href="#2-3-端口" class="headerlink" title="2.3 端口"></a>2.3 端口</h4><h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><p>​        “端口” 是英文 port 的意译，可以认为是设备<code>与外界通讯交流</code>的<code>出口</code>。</p>
<p>​        端口可分为<code>虚拟端口</code>和<code>物理端口</code>。</p>
<p>​        其中<code>虚拟端口</code>指计算机内部或交换机路由器内的端口，不可见，是特指<code>TCP/IP协议中的端口</code>，是<code>逻辑意义</code>上的端口。例如计算机中的 80 端口、21 端口、23 端口等。物理端口又称为接 口，是可见端口，计算机背板的 RJ45 网口，交换机路由器集线器等 RJ45 端口。电话使用 RJ11 插 口也属于物理端口的范畴。 </p>
<p>​        如果把 IP 地址比作一间房子，端口就是出入这间房子的门。真正的房子只有几个门，但是一个 IP 地址的端口可以有 65536（即：2^16）个之多！端口是通过端口号来标记的，端口号只有整数， 范围是从 0 到65535（2^16-1）。</p>
<h5 id="端口类型"><a href="#端口类型" class="headerlink" title="端口类型"></a>端口类型</h5><ol>
<li><p>周知端口（Well Known Ports） 周知端口是众所周知的端口号，也叫知名端口、公认端口或者常用端口，范围从 0 到 1023，它们紧密 绑定于一些特定的服务。</p>
<p>例如 <code>80 端口</code>分配给 WWW 服务，<code>21 端口</code>分配给 FTP 服务，<code>23 端口</code>分配给 Telnet服务等等。我们在 IE 的地址栏里输入一个网址的时候是不必指定端口号的，因为在默认情况下 WWW 服务的端口是 “80”。网络服务是可以使用其他端口号的，如果不是默认的端口号则应该在地址栏 上指定端口号，方法是在地址后面加上冒号“:”（半角），再加上端口号。比如使用 “8080” 作为 WWW 服务的端口，则需要在地址栏里输入“网址:8080”。但是有些系统协议使用固定的端口号，它是不能被改 变的，比如 139 端口专门用于 NetBIOS 与 TCP/IP 之间的通信，不能手动改变。 </p>
</li>
<li><p>注册端口（Registered Ports） 端口号从 1024 到 49151，它们松散地绑定于一些服务，分配给<code>用户进程</code>或应用程序，这些进程主要是用户选择安装的一些应用程序，而不是已经分配好了公认端口的常用程序。这些端口在没有被服务器资 源占用的时候，可以用用户端动态选用为源端口。 、</p>
</li>
<li><p>动态端口 / 私有端口（Dynamic Ports / Private Ports） 动态端口的范围是从 49152 到 65535。之所以称为动态端口，是因为它一般不固定分配某种服务，而是 动态分配。</p>
</li>
</ol>
<h2 id="3-网络模型"><a href="#3-网络模型" class="headerlink" title="3. 网络模型"></a>3. 网络模型</h2><h2 id="4-协议"><a href="#4-协议" class="headerlink" title="4. 协议"></a>4. 协议</h2><p>协议规定两个人交流的规范。</p>
<p>在网络中体现为发送数据的格式。</p>
<p>比如，我们约定好，A先发送文件的名字，B回答OK；</p>
<p>A再发送文件的大小，B回答OK；</p>
<p>A再发送文件的具体内容，B回答OK。</p>
<p>关于发送文件名—文件大小—文件具体内容的这个约定，就是一个协议。</p>
<h4 id="4-1-简介"><a href="#4-1-简介" class="headerlink" title="4.1. 简介"></a>4.1. 简介</h4><p>​        协议，网络协议的简称，网络协议是通信计算机双方必须共同遵从的一组约定。如怎么样建立连 接、怎么样互相识别等。只有遵守这个约定，计算机之间才能相互通信交流。它的三要素是：<code>语法</code>、<code>语义</code>、<code>时序</code>。 为了使数据在网络上从源到达目的，网络通信的参与方必须<code>遵循相同的规则</code>，这套规则称为协议 （protocol），它最终体现为在网络上传输的<code>数据包</code>的格式。 协议往往分成几个层次进行定义，分层定义是为了使某一层协议的改变不影响其他层次的协议。</p>
<h4 id="4-2-常见协议"><a href="#4-2-常见协议" class="headerlink" title="4.2 常见协议"></a>4.2 常见协议</h4><p>​        应用层常见的协议有：FTP协议（File Transfer Protocol 文件传输协议）、HTTP协议（Hyper Text Transfer Protocol 超文本传输协议）、NFS（Network File System 网络文件系统）。 </p>
<p>​        传输层常见协议有：TCP协议（Transmission Control Protocol 传输控制协议）、UDP协议（User Datagram Protocol 用户数据报协议）。 </p>
<p>​        网络层常见协议有：IP 协议（Internet Protocol 因特网互联协议）、ICMP 协议（Internet Control Message Protocol 因特网控制报文协议）、IGMP 协议（Internet Group Management Protocol 因特 网组管理协议）。</p>
<pre><code>     网络接口层常见协议有：ARP协议（Address Resolution Protocol 地址解析协议）、RARP协议 （Reverse Address Resolution Protocol 反向地址解析协议）。
</code></pre>
<h4 id="4-3-UDP-协议"><a href="#4-3-UDP-协议" class="headerlink" title="4.3 UDP 协议"></a>4.3 UDP 协议</h4><p><img src="https://img-blog.csdnimg.cn/0c3fffb300c1474f9304b8ddc25deb61.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<ul>
<li><p>源端口号：发送方端口号 </p>
</li>
<li><p>目的端口号：接收方端口号 </p>
</li>
<li><p>长度：UDP用户数据报的长度，最小值是8（仅有首部） </p>
</li>
<li><p>校验和：检测UDP用户数据报在传输中是否有错，有错就丢弃</p>
</li>
</ul>
<h4 id="4-4-TCP-协议"><a href="#4-4-TCP-协议" class="headerlink" title="4.4 TCP 协议"></a>4.4 TCP 协议</h4><p><img src="https://img-blog.csdnimg.cn/831fa1039af14143a63f7979c819fe0e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<ol>
<li>源端口号：发送方端口号 </li>
<li>目的端口号：接收方端口号 </li>
<li>序列号：本报文段的数据的第一个字节的序号 </li>
<li>确认序号：期望收到对方下一个报文段的第一个数据字节的序号 </li>
<li>首部长度（数据偏移）：TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远，即首部长 度。单位：32位，即以 4 字节为计算单位 </li>
<li>保留：占 6 位，保留为今后使用，目前应置为 0 </li>
<li>紧急 URG ：此位置 1 ，表明紧急指针字段有效，它告诉系统此报文段中有紧急数据，应尽快传送 </li>
<li>确认 ACK：仅当 ACK=1 时确认号字段才有效，TCP 规定，在连接建立后所有传达的报文段都必须 把 ACK 置1 </li>
<li>推送 PSH：当两个应用进程进行交互式的通信时，有时在一端的应用进程希望在键入一个命令后立 即就能够收到对方的响应。在这种情况下，TCP 就可以使用推送（push）操作，这时，发送方 TCP 把 PSH 置 1，并立即创建一个报文段发送出去，接收方收到 PSH = 1 的报文段，就尽快地 （即“推送”向前）交付给接收应用进程，而不再等到整个缓存都填满后再向上交付 </li>
<li>复位 RST：用于复位相应的 TCP 连接 </li>
<li>同步 SYN：仅在三次握手建立 TCP 连接时有效。当 SYN = 1 而 ACK = 0 时，表明这是一个连接请 求报文段，对方若同意建立连接，则应在相应的报文段中使用 SYN = 1 和 ACK = 1。因此，SYN 置 1 就表示这是一个连接请求或连接接受报文</li>
</ol>
<h4 id="4-5-IP-协议"><a href="#4-5-IP-协议" class="headerlink" title="4.5 IP 协议"></a>4.5 IP 协议</h4><p><img src="https://img-blog.csdnimg.cn/e47f2401788942aa9eaebdc3b674b407.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<ol>
<li>版本：IP 协议的版本。通信双方使用过的 IP 协议的版本必须一致，目前最广泛使用的 IP 协议版本 号为 4（即IPv4) </li>
<li>首部长度：单位是 32 位（4 字节） </li>
<li>服务类型：一般不适用，取值为 0 </li>
<li>总长度：指首部加上数据的总长度，单位为字节 </li>
<li>标识（identification）：IP 软件在存储器中维持一个计数器，每产生一个数据报，计数器就加 1， 并将此值赋给标识字段 </li>
<li>标志（flag）：目前只有两位有意义。 标志字段中的最低位记为 MF。MF = 1 即表示后面“还有分片”的数据报。MF = 0 表示这已是若干数 据报片中的最后一个。 标志字段中间的一位记为 DF，意思是“不能分片”，只有当 DF = 0 时才允许分片 </li>
<li>片偏移：指出较长的分组在分片后，某片在源分组中的相对位置，也就是说，相对于用户数据段的 起点，该片从何处开始。片偏移以 8 字节为偏移单位。 </li>
<li>生存时间：TTL，表明是数据报在网络中的寿命，即为“跳数限制”，由发出数据报的源点设置这个 字段。路由器在转发数据之前就把 TTL 值减一，当 TTL 值减为零时，就丢弃这个数据报。 </li>
<li>协议：指出此数据报携带的数据时使用何种协议，以便使目的主机的 IP 层知道应将数据部分上交 给哪个处理过程，常用的 ICMP(1)，IGMP(2)，TCP(6)，UDP(17)，IPv6（41) </li>
<li>首部校验和：只校验数据报的首部，不包括数据部分。 11. 源地址：发送方 IP 地址 12. 目的地址：接收方 IP 地址</li>
</ol>
<h4 id="4-6-以太网帧协议"><a href="#4-6-以太网帧协议" class="headerlink" title="4.6 以太网帧协议"></a>4.6 以太网帧协议</h4><p> <img src="https://img-blog.csdnimg.cn/8fe3d301fef94f65b93827757c527b74.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p> 类型：0x800表示 IP、0x806表示 ARP、0x835表示 RARP</p>
<h4 id="4-7-ARP-协议"><a href="#4-7-ARP-协议" class="headerlink" title="4.7 ARP 协议"></a>4.7 ARP 协议</h4><p><img src="https://img-blog.csdnimg.cn/414ba40fbb9c495b8fd7298687f48e35.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<ol>
<li>硬件类型：1 表示 MAC 地址 </li>
<li>协议类型：0x800 表示 IP 地址 </li>
<li>硬件地址长度：6 （只是存了个数字）</li>
<li>协议地址长度：4 </li>
<li>操作：1 表示 ARP 请求，2 表示 ARP 应答，3 表示 RARP 请求，4 表示 RARP 应答</li>
</ol>
<p>在封装的时候并不知道目标机器的MAC地址，所以会通过IP来查找该IP对应的MAC地址。</p>
<ul>
<li><p>ARP请求包</p>
<p>不是给某个具体的网卡发送请求，而是以<code>广播</code>的形式给局域网内的所有人发，大家各自解析目的IP地址，看是不是发给自己的。一旦某台机器发现是发给自己的，它就应答并把MAC地址传给源头。</p>
<p>请求</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/3202d01ae87947dfbd068d0b3439d853.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/0fdae567c22a417db9d3b45df493cf5e.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>由于刚开始不知道目的端的MAC，就先填充0.</p>
<p>另一个机器收到这个请求后，就可以应答了。</p>
<p><img src="https://img-blog.csdnimg.cn/ee7ea24a7b4142f6b0adeb2069ec0d37.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h4 id="4-8-封装"><a href="#4-8-封装" class="headerlink" title="4.8 封装"></a>4.8 封装</h4><p>​        下层协议提供服务给上层协议。上层协议是如何使用下层协议提供的服务的呢？</p>
<p>​        其实这是通过封装（encapsulation）实现的。应用程序数据在发送到物理网络上之前，将沿着协议栈<code>从上往下</code>依次传递。每层协议都将<code>在上层数据的基础上加上自己的头部信息</code>（有时还包括<code>尾部信息</code>），以实现该层的功能，这个过程就称为封装。</p>
<p>​        应用层 → 传输层→网络层→数据链路层</p>
<p><img src="https://img-blog.csdnimg.cn/c8fcbb08460b48baa2e070cb15eb7d11.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h4 id="4-10-分用"><a href="#4-10-分用" class="headerlink" title="4.10 分用"></a>4.10 分用</h4><p>​        当帧到达<code>目的主机</code>时，将沿着协议栈<code>自底向上</code>依次传递。各层协议依次处理帧中本层负责的头部数据， 以获取所需的信息，并最终将处理后的帧交给<code>目标应用程序</code>。这个过程称为分用（demultiplexing）。 分用是依靠<code>头部信息</code>中的<code>类型字段</code>实现的。</p>
<p><img src="https://img-blog.csdnimg.cn/ce9e626032aa456fa20e31c9b29b9b19.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/e643f1d0ca9b45a9afd06c60e8adaefe.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>上一层的分装作为下一层的头后面的数据。</p>
<h2 id="5-网络通信的过程"><a href="#5-网络通信的过程" class="headerlink" title="5. 网络通信的过程"></a>5. 网络通信的过程</h2><p>这里慢慢补，东西太多了。</p>
<h2 id="6-socket-介绍"><a href="#6-socket-介绍" class="headerlink" title="6. socket 介绍"></a>6. socket 介绍</h2><p>Linux：<code>一切皆文件</code>。</p>
<p>通信本质上就是<code>发送数据</code>和<code>接收数据</code>， socket 对应一个文件描述符，往里面 write 和 read。</p>
<p>机器A把数据写到内核中的<code>读缓冲区</code>和<code>写缓冲区</code>，机器B也相应得写和读。</p>
<p>socket 底层会调用TCP/IP四层协议栈帮你封装数据，发送，解封装等等。</p>
<p>最重要的就是 IP 和端口，以及封装的关于协议的API。</p>
<p>网络编程实际上也是进程间通信，只不过是在不同的主机上进行通信。</p>
<p>同一台机器上进程间通信用管道、内存映射、共享内存、消息队列、信号等等。</p>
<p>而在UNIX网络编程中在不同机器间进程间通信，即网络通信，使用的是socket技术。</p>
<p>如果每个协议都自己去组包，封装，分用，会非常得麻烦，因此 socket 简化了这一切，抽象成两个 sockst 各自表示通信的两端。</p>
<p>​        所谓 socket（套接字），就是对网络中<code>不同主机</code>上的应用进程之间进行<code>双向通信</code>的端点的抽象。 一个套接字就是网络上进程通信的一端，提供了<code>应用层进程</code>利用网络协议交换数据的机制。从所处的地位来 讲，套接字<code>上联应用进程</code>，<code>下联网络协议栈</code>，是应用程序通过网络协议进行通信的接口， 是应用程序与网络协议根进行交互的接口。 </p>
<p>​        socket 可以看成是两个网络应用程序进行通信时，各自通信连接中的端点，这是一个逻辑上的概 念。它是网络环境中<code>进程间通信的 API</code>，也是可以被命名和寻址的通信端点，使用中的每一个套接字都有其类型和一个与之相连进程。通信时其中一个网络应用程序将要传输的一段信息写入它所在主机的 socket 中，该 socket 通过与网络接口卡（NIC）相连的传输介质将这段信息送到另外一台 主机的 socket 中，使对方能够接收到这段信息。socket 是由 <code>IP 地址和端口结合</code>（IP地址找到另一台机器，端口找到进程）的，提供向应用 层进程传送数据包的机制。 </p>
<p>​        socket 本身有“插座”的意思，在 Linux 环境下，用于表示进程间网络通信的<code>特殊文件类型</code>。本质为内核借助缓冲区形成的伪文件。既然是文件，那么理所当然的，我们可以使用<code>文件描述符</code>引用套接字。与管道类似的，Linux 系统将其封装成文件的目的是为了统一接口，使得<code>读写套接字和读写文件的操作一致</code>。区别是管道主要应用于本地进程间通信，而套接字多应用 于网络进程间数据的传递。</p>
<p><img src="https://img-blog.csdnimg.cn/d674e64c98bc4968be809c9ecc7080d4.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>本质还是写文件和读文件。</p>
<p>套接字通信分两部分，客户端和服务器端。</p>
<ul>
<li><p>客户端 （插座）- 主动向发武器发起连接</p>
</li>
<li><p>服务器端（插头） - 被动接受连接</p>
</li>
</ul>
<p>socket 是一套通信的接口，Linux和Windows下都有。</p>
<p><img src="https://img-blog.csdnimg.cn/6f936f9f4e1b42aba0a70327b7b59794.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h2 id="7-字节序"><a href="#7-字节序" class="headerlink" title="7. 字节序"></a>7. 字节序</h2><h4 id="7-1-简介"><a href="#7-1-简介" class="headerlink" title="7.1 简介"></a>7.1 简介</h4><p>​        现代 CPU 的累加器一次都能装载（至少）4 字节（这里考虑 32 位机），即一个整数。那么这 4 字节在内存中排列的顺序将影响它被累加器装载成的整数的值，这就是字节序问题。在各种计算机体系结构中，对于字节、字等的存储机制有所不同，因而引发了计算机通信领域中一个很重要的问题，即通信双方交流的信息单元（比特、字节、字、双字等等）应该以什么样的顺序进行传送。如果不达成一致的规则，通信双方将无法进行正确的编码/译码从而导致通信失败。 </p>
<p>​        <strong><font color="red">字节序，顾名思义字节的顺序，就是大于一个字节类型的数据在内存中的存放顺序(一个字节的数 据当然就无需谈顺序的问题了)。</font></strong>(单个字节里的bit还是按顺序的，但是多个字节顺序就不一样了)</p>
<p>​         字节序分为<code>大端字节序</code>（Big-Endian） 和<code>小端字节序</code>（Little-Endian）。</p>
<blockquote>
<p>大端字节序是指一个整 数的最高位字节（23 ~ 31 bit）存储在内存的低地址处，低位字节（0 ~ 7 bit）存储在内存的高地址处；</p>
<p>小端字节序则是指整数的高位字节存储在内存的高地址处，而低位字节则存储在内存的低地 址处。</p>
</blockquote>
<h4 id="7-2-字节序转换函数"><a href="#7-2-字节序转换函数" class="headerlink" title="7.2 字节序转换函数"></a>7.2 字节序转换函数</h4><p>​        当格式化的数据在两台使用不同字节序的主机之间直接传递时，接收端必然错误的解释之。</p>
<p>​        解决问题的方法是：<code>发送端</code>总是把要发送的数据转换成<code>大端字节序</code>数据后再发送，而<code>接收端</code>知道对方传送过来的数据总是采用大端字节序，所以接收端可以根据自身采用的字节序<code>决定是否对接收到的数据进行转换</code>（小端机转换，大端机不转换）。</p>
<p>​        <code>网络字节顺序</code>是<code>TCP/IP</code> 中规定好的一种数据表示格式，它与具体的 CPU 类型、操作系统等无关，从而 可以保证数据在不同主机之间传输时能够被正确解释，<code>网络字节顺序</code>采用<code>大端</code>排序方式。 </p>
<p>​        BSD Socket提供了封装好的转换接口，方便程序员使用。</p>
<p>​        包括从主机字节序到网络字节序的转换函数： htons、htonl；</p>
<p>​        从网络字节序到主机字节序的转换函数：ntohs、ntohl。</p>
<blockquote>
<p>h - host 主机，主机字节序 </p>
<p>to - 转换成什么 </p>
<p>n - network 网络字节序 </p>
<p>s - short unsigned short </p>
<p>l - long unsigned int</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token comment">// 主机字节序 -&gt; 网络字节序</span>
<span class="token class-name">uint32_t</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> hostlong<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 转IP</span>
<span class="token class-name">uint16_t</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> hostshort<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 转port</span>

<span class="token comment">// 网络字节序 -&gt; 主机字节序	</span>
<span class="token class-name">uint32_t</span> <span class="token function">ntohl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> netlong<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 转IP</span>
<span class="token class-name">uint16_t</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> netshort<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 转port</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h6 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h6><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 转换端口</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"port: machine -&gt; net\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> a_local <span class="token operator">=</span> <span class="token number">0x0102</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x\n"</span><span class="token punctuation">,</span> a_local<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> a_net <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>a_local<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x\n"</span><span class="token punctuation">,</span> a_net<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"==========================\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 转换IP</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"IP: machine -&gt; net\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ip_local<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">168</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>ip_local<span class="token punctuation">;</span> <span class="token comment">// 把ip_local强转成int*指针，指向4个字节的数据，并解引用</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>num<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d.%d.%d.%d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sum<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d.%d.%d.%d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"=========================\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 转换IP</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> buf1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">168</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> num1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf1<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sum1 <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sum1<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %d %d %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>p1<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p1<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p1<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p1<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/e5598c36f2e24077ace8e9963bc31551.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h2 id="8-socket-地址"><a href="#8-socket-地址" class="headerlink" title="8. socket 地址"></a>8. socket 地址</h2><p>​        socket地址其实是一个<code>结构体</code>，封装<code>端口号</code>和<code>IP</code>等信息。后面的socket相关的api中需要使用到这个 socket地址。 </p>
<h4 id="8-1-通用socket地址"><a href="#8-1-通用socket地址" class="headerlink" title="8.1 通用socket地址"></a>8.1 通用socket地址</h4><p>​        socket 网络编程接口中表示 socket 地址的是结构体 <code>sockaddr</code>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/socket.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sa_family<span class="token punctuation">;</span>	<span class="token comment">/* Common data: address family and length.  */</span>
    <span class="token keyword">char</span> sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">/* Address data.  */</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> <span class="token class-name">sa_family_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>sa_family 成员是<code>地址族类型</code>（sa_family_t）的变量。<code>地址族类型</code>通常与<code>协议族类型</code>对应。常见的协议族（protocol family，也称 domain）和对应的地址族入下所示：</p>
<table>
<thead>
<tr>
<th align="center">协议族</th>
<th align="center">地址族</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">PF_UNIX</td>
<td align="center">AF_UNIX</td>
<td align="center">UNIX本地域协议族</td>
</tr>
<tr>
<td align="center">PF_INET</td>
<td align="center">AF_INET</td>
<td align="center">TCP/IPv4协议族</td>
</tr>
<tr>
<td align="center">PF_INET6</td>
<td align="center">AF_INET6</td>
<td align="center">TCP/IPv6协议族</td>
</tr>
</tbody></table>
<p>PF和AF宏都定义在 <code>bits/socket.h</code> 头文件中，且后者与前者有完全相同的值，所以二者通常混用。</p>
<p>sa_data 成员用于存放 <code>socket 地址值</code>。但是，不同的协议族的地址值具有不同的含义和长度，如下所 示：</p>
<p><img src="https://img-blog.csdnimg.cn/84620d1d5d3d40eda1c482f64fdbc970.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>由上表可知，14 字节的 sa_data 根本无法容纳多数协议族的地址值。因此，Linux 定义了下面这个新的通用的 socket 地址结构体，这个结构体不仅提供了足够大的空间用于存放地址值，而且是<code>内存对齐</code>的。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/socket.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span><span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sa_family<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">int</span> __ss_align<span class="token punctuation">;</span>
    <span class="token keyword">char</span> __ss_padding<span class="token punctuation">[</span> <span class="token number">128</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__ss_align<span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> <span class="token class-name">sa_family_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="8-2-专用socket地址"><a href="#8-2-专用socket地址" class="headerlink" title="8.2 专用socket地址"></a>8.2 专用socket地址</h4><p>​        很多网络编程函数诞生早于 IPv4 协议，那时候都使用的是<code> struct sockaddr 结构体</code>（就是上面那个通用地址），为了向前兼容，现 在sockaddr 退化成了（void *）的作用，传递一个地址给函数，至于这个函数是 sockaddr_in 还是 sockaddr_in6，由地址族确定，然后函数内部再强制类型转化为所需的地址类型。</p>
<p><img src="https://img-blog.csdnimg.cn/a63c29c998d94b41b88a39a6a819af38.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>UNIX 本地域协议族使用如下专用的 socket 地址结构体：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/un.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span> <span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sin_family<span class="token punctuation">;</span>
    <span class="token keyword">char</span> sun_path<span class="token punctuation">[</span><span class="token number">108</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> <span class="token class-name">sa_family_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>TCP/IP 协议族有 sockaddr_in 和 sockaddr_in6 两个专用的 socket 地址结构体，它们分别用于 IPv4 和 IPv6：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span>
<span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sin_family<span class="token punctuation">;</span> 	<span class="token comment">/* __SOCKADDR_COMMON(sin_) */</span>
    <span class="token class-name">in_port_t</span> sin_port<span class="token punctuation">;</span> 		<span class="token comment">/* Port number. */</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span> 	<span class="token comment">/* Internet address. */</span>
    <span class="token comment">/* Pad to size of `struct sockaddr'. */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> sin_zero<span class="token punctuation">[</span>
        <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">)</span> 
        <span class="token operator">-</span> __SOCKADDR_COMMON_SIZE 
        <span class="token operator">-</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token class-name">in_port_t</span><span class="token punctuation">)</span> 
        <span class="token operator">-</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">{</span>
	<span class="token class-name">in_addr_t</span> s_addr<span class="token punctuation">;</span>	<span class="token comment">// 专门用来能保存IP地址</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sin6_family<span class="token punctuation">;</span>
    <span class="token class-name">in_port_t</span> sin6_port<span class="token punctuation">;</span> 		<span class="token comment">/* Transport layer port # */</span>
    <span class="token class-name">uint32_t</span> sin6_flowinfo<span class="token punctuation">;</span> 	<span class="token comment">/* IPv6 flow information */</span>
    <span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> sin6_addr<span class="token punctuation">;</span> 	<span class="token comment">/* IPv6 address */</span>
    <span class="token class-name">uint32_t</span> sin6_scope_id<span class="token punctuation">;</span> 	<span class="token comment">/* IPv6 scope-id */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token class-name">uint16_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token class-name">uint32_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token class-name">uint16_t</span> <span class="token class-name">in_port_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token class-name">uint32_t</span> <span class="token class-name">in_addr_t</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SOCKADDR_COMMON_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所有专用 socket 地址（以及 sockaddr_storage）类型的变量在<code>实际使用</code>时都需要<code>转化</code>为<code>通用 socket 地址类型 </code>sockaddr（强制转化即可），因为所有 socket 编程<code>接口</code>使用的地址参数类型都是 <code>sockaddr</code>。</p>
<p>不管是谁，都要强转成最古老的形式 sockaddr，那种最通用。</p>
<h2 id="9-IP-地址转换函数"><a href="#9-IP-地址转换函数" class="headerlink" title="9. IP 地址转换函数"></a>9. IP 地址转换函数</h2><p>函数可以做这两件事情。</p>
<ul>
<li>主机字节序 - 网络字节序</li>
<li>字符串点分十进制 IP - 整数 IP</li>
</ul>
<p>程序读的IP应该是4个字节的整数，但是人喜欢用点分十进制，如 <code>192.168.1.2</code>。如果我们想把它转换成整数，就可以用自带的函数转换成<code>大端序</code>的整数IP。</p>
<p>记录日志的时候我们希望往文件中写字符串，此时需要把 int 转换成点分十进制的字符串，然后写到日志中。</p>
<p>下面 3 个函数可用于用<code>点分十进制字符串</code>表示的 IPv4 地址和用<code>网络字节序整数</code>表示的 IPv4 地址之间的转换：</p>
<p>但是这三个非常旧了，<code>不推荐使用</code>。</p>
<h5 id="inet-addr（遗物）"><a href="#inet-addr（遗物）" class="headerlink" title="inet_addr（遗物）"></a>inet_addr（遗物）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token class-name">in_addr_t</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">)</span><span class="token punctuation">;</span>

	The  <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  function  converts  the Internet 【host address】 【cp】 from IPv4 numbers<span class="token operator">-</span>and<span class="token operator">-</span>dots notation into 【binary】 data in 【network byte order】<span class="token punctuation">.</span>  
	If the input is invalid<span class="token punctuation">,</span> <span class="token function">INADDR_NONE</span> <span class="token punctuation">(</span>usually <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> is returned<span class="token punctuation">.</span>  Use of this function is problematic because <span class="token operator">-</span><span class="token number">1</span>  is a valid  <span class="token function">address</span> <span class="token punctuation">(</span><span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  
	【Avoid】 its use in favor of <span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> or <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> which provide a cleaner way to indicate error <span class="token keyword">return</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="inet-aton（遗物）"><a href="#inet-aton（遗物）" class="headerlink" title="inet_aton（遗物）"></a>inet_aton（遗物）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span>inp<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// address to networrk</span>

	<span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> converts the 【Internet host address】 【cp】 from the IPv4 【numbers<span class="token operator">-</span>and<span class="token operator">-</span>dots】 notation into 【binary】 <span class="token function">form</span> <span class="token punctuation">(</span>in 【network byte order】<span class="token punctuation">)</span> and stores it in the structure that 【inp】 points to<span class="token punctuation">.</span>  
    <span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns nonzero <span class="token keyword">if</span> the address is valid<span class="token punctuation">,</span> zero <span class="token keyword">if</span> not<span class="token punctuation">.</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="inet-ntoa（遗物）"><a href="#inet-ntoa（遗物）" class="headerlink" title="inet_ntoa（遗物）"></a>inet_ntoa（遗物）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> in<span class="token punctuation">)</span><span class="token punctuation">;</span>

	The  <span class="token function">inet_ntoa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  function  converts the 【Internet host address】 in<span class="token punctuation">,</span> given in 【network byte order】<span class="token punctuation">,</span> 【to a string】 in IPv4 【dotted<span class="token operator">-</span>decimal】 notation<span class="token punctuation">.</span>  The string is returned in a statically allocated buffer<span class="token punctuation">,</span> which subsequent calls will overwrite<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<p>下面这对<code>更新</code>的函数也能完成前面 3 个函数同样的功能，并且它们<code>同时适用</code> IPv4 地址和 IPv6 地址：</p>
<h5 id="inet-pton"><a href="#inet-pton" class="headerlink" title="inet_pton"></a>inet_pton</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span><span class="token keyword">int</span> af<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>作用：convert IPv4 and IPv6 addresses 【from text to binary form】</p>
<p>参数：</p>
<ul>
<li><p>af： 地址族 AF_INET，  AF_INET6</p>
</li>
<li><p>src：需要转换的点分十进制的 IP 字符串</p>
</li>
<li><p>dst：转换后的结果保存在它指向的内存上，传出参数</p>
</li>
</ul>
<h5 id="inet-ntop"><a href="#inet-ntop" class="headerlink" title="inet_ntop"></a>inet_ntop</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span><span class="token keyword">int</span> af<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>作用：convert IPv4 and IPv6 addresses【 from binary to text form】</p>
<p>参数：</p>
<ul>
<li><p>af：地址族</p>
</li>
<li><p>src：要转换的网络字节序的整数</p>
</li>
<li><p>dst：转换后的点分十进制字符串，传出参数</p>
</li>
<li><p>size：指定 dst 可以接受的字节数</p>
</li>
</ul>
<p>返回值：inet_ntop() returns a 【non-null pointer to dst】.</p>
<h5 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 点分十进制字符串 -&gt; 网络字节序</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"192.168.100.1"</span><span class="token punctuation">;</span>   <span class="token comment">// 点分十进制字符串</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> addr_b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_b<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr_b<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"点分十进制-&gt;整数ip：%d.%d.%d.%d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 网络字节序 -&gt; 点分十进制字符串</span>
    <span class="token keyword">char</span> ip<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_b<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"整数ip=&gt;点分十进制：%s（返回值） | %s（传出参数）\n"</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ip == str ? ans: %d\n"</span><span class="token punctuation">,</span> ip <span class="token operator">==</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/237998c773d941ecb8b60b09fc74cf8b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>返回值和传出参数ip根本就是同一个东西，不光值一样，地址也一样。</p>
<h2 id="10-TCP-通信流程"><a href="#10-TCP-通信流程" class="headerlink" title="10. TCP 通信流程"></a>10. TCP 通信流程</h2><p>可不可靠：UDP 发出去的数据对方没有收到的话，就不管了；TCP 会重新发，数据在中途可能会丢失，但一些机制可以保证最最终数据会到达对方。</p>
<p>使用TCP 协议，通信两端像建立了一个水管，一端发送，一端接收，是源源不断地。单波传输：仅支持一对一传输。</p>
<p><img src="https://img-blog.csdnimg.cn/853c76ce06844770b6e8d89d681f6a39.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/b7c27d80d5244ccfa3c75c89b795cd20.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<ul>
<li>服务器端 （被动接受连接的角色）</li>
</ul>
<ol>
<li><p>创建一个用于监听的套接字（fd-专门监听）</p>
<ul>
<li>监听：监听有客户端的连接</li>
<li>套接字：这个套接字其实就是一个<code>文件描述符</code></li>
</ul>
</li>
<li><p>将这个监听文件描述符和<code>本地的IP</code>和<code>端口</code>绑定（IP和端口就是服务器的地址信息）</p>
<ul>
<li>客户端连接服务器的时候使用的就是这个IP和端口</li>
</ul>
</li>
<li><p>设置监听，监听的fd开始工作（检查读缓冲区有无数据被写入）</p>
</li>
<li><p>阻塞等待；<br>accept是个阻塞函数。</p>
<p>当有客户端发起连接，解除阻塞，接受客户端的连接，得到一个和客户端通信的套接字（fd-专门数据通信）</p>
</li>
<li><p>通信</p>
<ul>
<li>接收数据</li>
<li>发送数据</li>
</ul>
</li>
<li><p>通信结束，断开连接</p>
</li>
</ol>
<ul>
<li>客户端</li>
</ul>
<ol>
<li>创建一个用于通信的套接字（fd），不需要指定端口</li>
<li>连接服务器，需要指定连接的服务器的 IP 和端口</li>
<li>连接成功了，客户端可以直接和服务器通信<ul>
<li>接收数据</li>
<li>发送数据</li>
</ul>
</li>
<li>通信结束，断开连接</li>
</ol>
<h2 id="11-套接字函数"><a href="#11-套接字函数" class="headerlink" title="11. 套接字函数"></a>11. 套接字函数</h2><h5 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">socket <span class="token operator">-</span> create an endpoint <span class="token keyword">for</span> communication

SYNOPSIS
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          </span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

    <span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

DESCRIPTION
       <span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  creates an endpoint <span class="token keyword">for</span> communication and returns a 【file descriptor】 that refers to that endpoint<span class="token punctuation">.</span> The file descriptor returned by a successful call will be the lowest<span class="token operator">-</span>numbered file descriptor not currently open <span class="token keyword">for</span> the process<span class="token punctuation">.</span>

       The 【domain】 argument specifies a communication domain<span class="token punctuation">;</span> this selects the 【protocol family】  which  will  be  used  <span class="token keyword">for</span>  communication<span class="token punctuation">.</span>
       These families are defined in <span class="token operator">&lt;</span>sys<span class="token operator">/</span>socket<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token punctuation">.</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>作用：创建一个套接字</p>
<p>参数：</p>
<ul>
<li><p>domain：协议族</p>
<ul>
<li>AF_UNIX、AF_LOCAL：本地套接字通信（进程间通信）</li>
<li>AF_INET、AF_INET6：ipv4、ipv6，不同主机进程间通信</li>
</ul>
</li>
<li><p>type：通信过程中的协议类型</p>
<ul>
<li>SOCK_STREAM：流式<ul>
<li>Provides  sequenced, reliable, two-way, connection-based byte streams.  An out-of-band data transmission mechanism may be supported.</li>
</ul>
</li>
<li>SOCK_DGRAM：报式 <ul>
<li>Supports datagrams (connectionless, unreliable messages of a fixed maximum length).</li>
</ul>
</li>
</ul>
</li>
<li><p>protocal：具体的一个协议，一般写0。</p>
<ul>
<li>SOCK_STREAM：流式，默认使用 TCP</li>
<li>SOCK_DGRAM：报式，默认使用 UDP</li>
</ul>
</li>
</ul>
<p>返回值：</p>
<ul>
<li>成功：返回文件描述符，操作做的就是内核缓冲区。</li>
<li>失败：-1</li>
</ul>
<h5 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>作用：绑定 <code>fd</code> 和<code>本地的 IP + 端口</code> （命名一个 socket）bind a name to a socket</p>
<p>参数：</p>
<ul>
<li>sockfd：通过 socket 函数获得的文件描述符</li>
<li>*addr：需要绑定的 socket 地址，封装了 ip 和端口信息</li>
<li>addrlen：addr 结构体占的内存大小</li>
</ul>
<p>RETURN VALUE<br>       On success, zero is returned.  On error, -1 is returned, and errno is set appropriately.</p>
<h5 id="listen"><a href="#listen" class="headerlink" title="listen"></a>listen</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>作用：监听该 socket 上的连接请求 listen for connections on a socket，accept incoming<br>       connection requests using accept</p>
<p>参数：</p>
<ul>
<li>sockfd：通过 soclet 函数得到的文件描述符（代表这个套接字）</li>
<li>backlog：<code>已连接+未连接之和</code>的最大值。listen 会创建两个队列（未连接+已连接），只有当三次握手都成功了才会成功连接。backlog一般指定5就可以了。一旦连接了这个请求就推出队列了。但实际上底层还会在这个值上加一点</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/b0916484e6b74514ae96260fda5dac68.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h5 id="accept"><a href="#accept" class="headerlink" title="accept"></a>accept</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>作用：接受客户端连接 默认阻塞，等待客户端连接进来 accept a connection on a socket</p>
<p>参数：</p>
<ul>
<li>sockfd：用于监听的文件描述符，从里面读客户端的信息</li>
<li>*addr：socket 地址，传出参数，记录连接成功后客户端的<code>地址信息：ip+端口</code></li>
<li>*addrlen：指定 addr 对应的内存大小</li>
</ul>
<p>RETURN VALUE<br>       On  success,  these  system calls return a nonnegative integer that is a <code>file descriptor</code> for the accepted socket.   用于通信的文件描述符，和前面建立的用于监听的文件描述符不同，多个客户端连接会返回不同的用于通信的文件描述符</p>
<p>​       On error, -1 is returned, errno is set appropriately, and addrlen is left unchanged.</p>
<h5 id="connect（由客户端调用）"><a href="#connect（由客户端调用）" class="headerlink" title="connect（由客户端调用）"></a>connect（由客户端调用）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          <span class="token comment">/* See NOTES */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>作用：  客户端连接服务器 initiate a connection on a socket</p>
<p>参数：</p>
<ul>
<li>sockfd：用于通信的文件描述符。客户端<code>不需要监听</code>，直接调用 socket 创建文件描述符用来和服务端通信</li>
<li>*addr：客户端要连接的<code>服务器的地址信息</code></li>
<li>addrlen：addr 的内存大小，传入参数，不是传出参数</li>
</ul>
<p>返回值：</p>
<ul>
<li>成功：0</li>
<li>失败：1</li>
</ul>
<h5 id="write、read"><a href="#write、read" class="headerlink" title="write、read"></a>write、read</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h2 id="12-TCP-通信实现"><a href="#12-TCP-通信实现" class="headerlink" title="12. TCP 通信实现"></a>12. TCP 通信实现</h2><h3 id="12-1-服务器端"><a href="#12-1-服务器端" class="headerlink" title="12.1 服务器端"></a>12.1 服务器端</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token comment">// TCP 通信服务器端</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. 创建套接字（监听）</span>
    <span class="token comment">// 如果有连接，客户端会往服务器端套接字的内存缓冲区的读缓冲区写数据</span>
    <span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 流式tcp协议，0默认tcp</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>listen_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 2. 绑定</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> skaddr<span class="token punctuation">;</span>
    skaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>    <span class="token comment">// 协议族</span>
    skaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span> <span class="token comment">// 0.0.0.0 任意地址，主机有多个网卡（无线网卡，以太网卡），ip各异，哪个都可以访问，服务端才能这么写</span>
    <span class="token comment">//inet_pton(AF_INET, "172.24.190.150", &amp;skaddr.sin_addr.s_addr);   // s_addr需要一个 unsigned int</span>
    skaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 端口转换成网络字节序</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>skaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>skaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. 监听</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. 接受客户端的连接</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientaddr<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> clientlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientlen<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 没有客户端连接，一直阻塞</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>client_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. 输出客户端信息</span>
    <span class="token keyword">char</span> client_ip<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">,</span> client_ip<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> client_port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>clientaddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client ip: %s, port: %d\n"</span><span class="token punctuation">,</span> client_ip<span class="token punctuation">,</span> client_port<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 6. 通信</span>
    <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>send_buf <span class="token operator">=</span> <span class="token string">"Hello, I'm server."</span><span class="token punctuation">;</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 服务端获取客户端数据</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"receive client data: %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 给客户端发送数据</span>
        <span class="token function">write</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> send_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    
    <span class="token comment">// 7. 关闭文件描述符</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="12-2-客户端"><a href="#12-2-客户端" class="headerlink" title="12.2 客户端"></a>12.2 客户端</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>   
    <span class="token comment">// 1. 创建套接字</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 连接服务器端</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serveraddr<span class="token punctuation">;</span>
    serveraddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">"172.24.190.150"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serveraddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    serveraddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serveraddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serveraddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. 通信</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>send_buf <span class="token operator">=</span> <span class="token string">"Hello, I'm client."</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 给服务端发送数据</span>
        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> send_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//读取服务端的数据</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"receive server data: %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server closed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    

    <span class="token comment">// 4. 关闭连接</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="13-TCP-三次握手"><a href="#13-TCP-三次握手" class="headerlink" title="13. TCP 三次握手"></a>13. TCP 三次握手</h2><p>TCP 是一种<code>面向连接</code>的<code>单播协议</code>，在发送数据前，通信双方必须在彼此间建立一条连接。所谓的“连接”，其实是客户端和服务器的内存里保存的一份关于对方的信息，如 IP 地址、端口号等。 （双方的信息保存在TCP模块中）</p>
<p>TCP 可以看成是一种字节流，它会处理 IP 层或以下的层的<code>丢包</code>、<code>重复</code>以及<code>错误</code>问题。在连接的建立过程中，双方需要<code>交换一些连接的参数</code>。这些参数可以放在 <code>TCP 头部</code>。 （安全指的是数据最终对方都可以接收到，中途可能会丢失，但结果不会失望）</p>
<p>TCP 提供了一种可靠、面向连接、字节流、传输层的服务，采用<code>三次握手</code>来<code>建立</code>一个连接。采用<code>四次挥手</code>来<code>关闭</code>一个连接。（协议的行为，不是通过程序员的代码来实现）</p>
<p> <strong>三次握手的目的是保证双方互相之间建立了连接。</strong> （保证 TCP安全的一种机制，此外还有超时重传，确认机制，四次挥手等）</p>
<p>三次握手发生在客户端连接的时候，当调用connect()，底层会通过TCP协议进行三次握手。</p>
<p><img src="https://img-blog.csdnimg.cn/831fa1039af14143a63f7979c819fe0e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<ul>
<li>16 位端口号（port number）：告知主机报文段是来自哪里（源端口）以及传给哪个上层协议或 应用程序（目的端口）的。进行 TCP 通信时，客户端通常使用系统自动选择的临时端口号。 </li>
<li>32 位<code>序号</code>（sequence number）：一次 TCP 通信（从 TCP 连接建立到断开）过程中某一个传输方向上的字节流的<code>每个字节的编号</code>。假设主机 A 和主机 B 进行 TCP 通信，A 发送给 B 的第一个 TCP 报文段中，序号值被系统初始化为某个<code>随机值</code> ISN（Initial Sequence Number，初始序号值）。那么在该传输方向上（从 A 到 B），后续的 TCP 报文段中序号值将被系统设置成 ISN 加上该报文段所携带数据的第一个字节在整个字节流中的偏移。例如，某个 TCP 报文段传送的数据是字节流中的第 1025 ~ 2048 字节，那么该报文段的序号值就是 ISN + 1025。另外一个传输方向（从 B 到 A）的 TCP 报文段的序号值也具有相同的含义。 </li>
<li>32 位<code>确认号</code>（acknowledgement number）：用作对另一方发送来的 TCP 报文段的<code>响应</code>。其值是收到的 TCP 报文段的序号值 + 标志位长度（SYN，FIN） + 数据长度 。假设主机 A 和主机 B 进行 TCP 通信，那么 A 发送出的 TCP 报文段不仅携带自己的序号，而且包含对 B 发送来的 TCP 报文段的确认号。反之，B 发送出的 TCP 报文段也同样携带自己的序号和对 A 发送来的报文段的确认序号。 </li>
<li>4 位头部长度（head length）：标识该 TCP 头部有多少个 32 bit(4 字节)。因为 4 位最大能表示 15，所以 TCP 头部最长是60 字节。 </li>
<li>6 位标志位包含如下几项： URG 标志，表示紧急指针（urgent pointer）是否有效。 <ul>
<li>ACK 标志，表示<code>确认</code>号是否有效。我们称携带 ACK 标志的 TCP 报文段为确认报文段。 </li>
<li>PSH 标志，提示接收端应用程序应该立即从 TCP 接收缓冲区中读走数据，为接收后续数据腾 出空间（如果应用程序不将接收到的数据读走，它们就会一直停留在 TCP 接收缓冲区中）。 </li>
<li>RST 标志，表示要求对方<code>重新建立连接</code>。我们称携带 RST 标志的 TCP 报文段为复位报文段。 </li>
<li>SYN 标志，表示<code>请求建立一个连接</code>。我们称携带 SYN 标志的 TCP 报文段为同步报文段。 </li>
<li>FIN 标志，表示通知对方本端要<code>关闭</code>连接了。我们称携带 FIN 标志的 TCP 报文段为结束报文段。（四次挥手 ） </li>
<li>16 位窗口大小（window size）：是 TCP 流量控制的一个手段。这里说的窗口，指的是接收通告窗口（Receiver Window，RWND）。它告诉对方本端的 TCP 接收缓冲区还能容纳多少字节的数据，这样对方就可以控制发送数据的速度。 </li>
<li>16 位校验和（TCP checksum）：由发送端填充，接收端对 TCP 报文段执行 CRC 算法以校验 TCP 报文段在传输过程中是否损坏。注意，这个校验不仅包括 TCP 头部，也包括数据部分。 这也是 TCP 可靠传输的一个重要保障。</li>
<li>16 位紧急指针（urgent pointer）：是一个正的偏移量。它和序号字段的值相加表示最后一 个紧急数据的下一个字节的序号。因此，确切地说，这个字段是紧急指针相对当前序号的偏 移，不妨称之为紧急偏移。TCP 的紧急指针是发送端向接收端发送紧急数据的方法。</li>
</ul>
</li>
</ul>
<p>客户端 <code>connect()</code> 主动建立连接的时候，底层会通过TCP协议做三次握手。 </p>
<p><img src="https://img-blog.csdnimg.cn/bf5c181c873441c1886719ac0bb58537.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>具体的数据是是通过 TCP 头部发送的。</p>
<p><img src="https://img-blog.csdnimg.cn/6de04e24e5924020aceb406ebaf1848b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>客户端和服务端要想建立连接，各自都要确认一些数据，即都确认自己可以<code>发数据</code>也可以<code>收数据</code>。当每一方都确认了自己正常运作才能正式建立连接。一旦有一方其中一个功能无法实现，就无法实现通信。 </p>
<p><img src="/2022/04/24/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220428231107203.png" alt="image-20220428231107203"></p>
<ul>
<li>seq：序号</li>
<li>ack：确认序号，ACK=1时ack才有效。<ul>
<li>如何确定数据完整？</li>
<li>如何确定字节流顺序正确？server发送 1 2 3，客户端可能接收到3 1 2。</li>
</ul>
</li>
</ul>
<p>每一个字节都会被分配唯一的编号。收到SYN或FIN后的回复会把ack+1，其余都是加上数据的大小。</p>
<p>第一次握手： </p>
<ol>
<li>客户端将 <code>SYN</code> 标志位置为 1 </li>
<li>生成一个随机的32位的序号 <code>seq = J</code> ， 这个序号后边是可以携带数据（数据的大小，其实是在头部后面） </li>
</ol>
<p>第二次握手： </p>
<ol>
<li>服务器端接收客户端的连接： <code>ACK = 1</code> </li>
<li>服务器会回发一个确认序号： <code>ack = 客户端的序号 + 数据长度 + SYN/FIN(按一个字节算) </code></li>
<li>服务器端会向客户端发起连接请求： <code>SYN = 1</code> </li>
<li>服务器会生成一个随机序号：<code>seq = K </code></li>
</ol>
<p>第三次握手： </p>
<ol>
<li>客户单应答服务器的连接请求：<code>ACK = 1</code> </li>
<li>客户端回复收到了服务器端的数据：<code>ack = 服务端的序号 + 数据长度 + SYN/FIN(按一个字节算)</code></li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/8fd4c4c04fbb4ee48a2564a5fa95a819.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h2 id="14-TCP-滑动窗口"><a href="#14-TCP-滑动窗口" class="headerlink" title="14. TCP 滑动窗口"></a>14. TCP 滑动窗口</h2><p>TCP 头部存有 16位窗口大小，双方通信时不断提醒对方己方缓冲区的剩余大小。如果对方的缓冲区容量足够，就可以发送数据；如果对方缓冲区大小为0，就阻塞等待。</p>
<p>滑动窗口（Sliding window）是一种<code>流量控制技术</code>。早期的网络通信中，通信双方不会考虑网络的拥挤情况直接发送数据。由于大家不知道网络拥塞状况，同时发送数据，导致中间节点<code>阻塞掉包</code>， 谁也发不了数据，所以就有了滑动窗口机制来解决此问题。滑动窗口协议是用来改善吞吐量的一种技术，即容许发送方在接收任何应答之前传送附加的包。接收方告诉发送方在某一时刻能送多少包 （称<code>窗口尺寸</code>）。 </p>
<p>TCP 中采用滑动窗口来进行传输控制，滑动窗口的大小意味着接收方还有多大的缓冲区可以用于接收数据。<strong>发送方可以通过滑动窗口的大小来确定应该发送多少字节的数据。</strong>当滑动窗口为 0 时，发送方一般不能再发送数据报。</p>
<p>滑动窗口是 TCP 中实现诸如 ACK 确认、流量控制、拥塞控制的承载结构。</p>
<p><code>窗口</code>理解为<code>缓冲区的大小</code>，滑动窗口的大小会随着发送数据和接收数据而变化，通信的双方都有发送缓冲区和接收数据的缓冲区。</p>
<ul>
<li><p>服务器</p>
<ul>
<li>发送缓冲区（发送缓冲区的窗口） </li>
<li>接收缓冲区（接收缓冲区的窗口） </li>
</ul>
</li>
<li><p>客户端 </p>
<ul>
<li>发送缓冲区（发送缓冲区的窗口） </li>
<li>接收缓冲区（接收缓冲区的窗口）</li>
</ul>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/89a20618722945cfb50ea1fc59d87418.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p>发送方的缓冲区： </p>
<p>​        白色格子：空闲的空间 </p>
<p>​        灰色格子：数据已经被发送出去了，但是还没有被接收 </p>
<p>​        紫色格子：还没有发送出去的数据 </p>
<p>接收方的缓冲区： </p>
<p>​        白色格子：空闲的空间 </p>
<p>​        紫色格子：已经接收到的数据</p>
</blockquote>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/2237c437911b439c86f52e94aa55eba5.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<blockquote>
<p># mss: Maximum Segment Size(一条数据的最大的数据量) </p>
<p># win: 滑动窗口 </p>
<ol>
<li>客户端向服务器<code>发起连接</code>（SYN，第一次握手不能携带数据，因为还没有建立连接），客户单的滑动窗口是4096，一次发送的最大数据量是1460 </li>
<li>服务器接收连接情况，告诉客户端服务器的窗口大小是6144，一次发送的最大数据量是1024 </li>
<li>第三次握手（三次握手之后接收方才能给发送方发送数据）</li>
<li>4-9 客户端连续给服务器发送了6k的数据，每次发送1k </li>
<li>第10次，服务器告诉客户端：发送的6k数据以及接收到，存储在缓冲区中，缓冲区数据已经处理了2k,窗 口大小是2k </li>
<li>第11次，服务器告诉客户端：发送的6k数据以以及接收到，存储在缓冲区中，缓冲区数据已经处理了4k,窗 口大小是4k</li>
<li>第12次，客户端给服务器发送了1k的数据 </li>
</ol>
</blockquote>
<p>四次挥手</p>
<p>客户端主动请求与服务器断开连接</p>
<blockquote>
<ol>
<li><p>第13次，<code>第一次挥手</code>，客户端主动请求和服务器<code>断开连接</code>(<code>客户端发送FIN</code>，从现在开始主动的一方就不能再发送数据了)，并且给服务器发送了1k的数据 </p>
</li>
<li><p>第14次，<code>第二次挥手</code>，服务器回复<code>ACK</code> 8194,</p>
<p>a:同意断开连接的请求</p>
<p>b:告诉客户端已经接受到方才发的2k的数据 </p>
<p>c:滑动窗口2k </p>
</li>
<li><p>第15、16次，通知客户端滑动窗口的大小 </p>
</li>
<li><p>第17次，<code>第三次挥手</code>，<code>服务器端给客户端发送FIN</code>,<code>请求断开连接</code> </p>
</li>
<li><p>第18次，<code>第四次挥手</code>，<code>客户端同意</code>了服务器端的断开请求</p>
</li>
</ol>
</blockquote>
<h2 id="14-TCP-四次挥手"><a href="#14-TCP-四次挥手" class="headerlink" title="14. TCP 四次挥手"></a>14. TCP 四次挥手</h2><p>四次挥手发生在<code>断开连接</code>的时候，在程序中当调用了 <code>close()</code> 会使用TCP协议进行四次挥手。 客户端和服务器端<code>都可以主动发起断开连接</code>，谁先调用 close() 谁就是发起。 因为在TCP连接的时候，采用三次握手建立的的连接是双向的，在断开的时候需要<code>双向断开</code>。</p>
<p>为什么要断开，直接终止进程不可以吗？两方都把对方的信息保存在系统当中，必须释放它们。</p>
<p><img src="https://img-blog.csdnimg.cn/255f0a654dd346e083bb595f88b00df4.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>为什么四次挥手服务端发送的的 <code>ack</code> 和 <code>FIN</code> 要分两次发送？</p>
<p>因为客户端请求断开，但是服务端此时可能不想断开，可能还要发送一些数据。</p>
<p>因此先 <code>ack</code> 确认收到断开请求，这里到 <code>FIN</code> 服务端请求断开之间服务端可能还往客户端传输了很多的数据。</p>
<p>建立连接是双方的意愿，请求断开是单方的意愿。</p>
<h2 id="15-TCP-通信并发"><a href="#15-TCP-通信并发" class="headerlink" title="15. TCP 通信并发"></a>15. TCP 通信并发</h2><p>并发：一台咖啡机，两队人取咖啡</p>
<p>并行：两台咖啡机，两队同时取咖啡</p>
<p>服务端通过 <code>accept</code> 接收客户端的连接请求。</p>
<p>因此，如果要实现并发的服务器，我们需要使用<code>多个进程或者线程</code>处理多个客户端的额连接请求。</p>
<h3 id="15-1-多进程实现并发服务器"><a href="#15-1-多进程实现并发服务器" class="headerlink" title="15.1 多进程实现并发服务器"></a>15.1 <code>多进程</code>实现并发服务器</h3><p>注意点：1. 写数据末尾的 ‘\0’ 问题</p>
<pre><code>              2. 父进程被中断（产生信号后去执行回调，软中断），新的客户端无法连接进来
              3. 父进程 read 错误（进程结束但是没有 close fd）
</code></pre>
<p>运行服务器端，并连接两个客户端，大家都顺利运行。</p>
<p>我们终止一个客户端。</p>
<p><img src="https://img-blog.csdnimg.cn/a7a11e6c8fb54c4da96f969345cdddb4.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>惊奇地发现服务器端产生了一个中断并继续执行。</p>
<p>服务器端的父进程被中断退出，</p>
<p>和被终止的客户端对接的子进程退出，</p>
<p>另一个子进程正常运行。</p>
<p> <img src="https://img-blog.csdnimg.cn/c68a39bf1fb34a86995e1c69388c8860.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>由于父进程已经退出了，因此希望建立连接的新客户端就无法连接上服务端了。</p>
<p><img src="https://img-blog.csdnimg.cn/f57c1123db494d62aac2314009a5b32b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>man 手册中可以查到这个错误。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">EINTR
    The system call was interrupted by a signal that was caught before a valid connection arrived<span class="token punctuation">;</span> see <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p>因此我们只要特判一下，一旦产生这个错误就忽略。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h5 id="示例代码（server）"><a href="#示例代码（server）" class="headerlink" title="示例代码（server）"></a>示例代码（server）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">recycleChild</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 多个孩子死亡，死循环一直回收，不然可能死了3个只能回收一个</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// 所有的子进程都回收完了</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"回收了子进程 pid = %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 注册信号捕捉 父进程回收子进程资源</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>
    act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 清空临时阻塞信号集</span>
    act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> recycleChild<span class="token punctuation">;</span>
    <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1. 创建 socket</span>
    <span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>listen_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 绑定端口和ip</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. 监听</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. 循环等待客户端请求</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 接受客户端连接请求</span>
        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientAddr<span class="token punctuation">;</span>
        <span class="token keyword">int</span> clientAddrLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>client_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 排一个子进程去处理通信</span>
        <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// 子进程</span>
            <span class="token comment">// 获取客户端信息</span>
            <span class="token keyword">char</span> clientIP<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">unsigned</span> <span class="token keyword">short</span> clientPort <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>clientAddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client ip : %s, port : %d\n"</span><span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> clientPort<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 接收客户端的数据</span>
            <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server receive : %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token function">write</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 回射服务器，原封不动发送回去</span>
            <span class="token punctuation">}</span>

        
        <span class="token function">close</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 子进程退出    </span>
            
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="示例代码（client）"><a href="#示例代码（client）" class="headerlink" title="示例代码（client）"></a>示例代码（client）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>   
    <span class="token comment">// 1. 创建套接字</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 连接服务器端</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serveraddr<span class="token punctuation">;</span>
    serveraddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">"172.24.190.150"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serveraddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    serveraddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serveraddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serveraddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. 通信</span>
    <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> send_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 给服务端发送数据</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">,</span> <span class="token string">"client send: %d"</span><span class="token punctuation">,</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> send_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 把\0也写过去</span>
        

        <span class="token comment">//读取服务端的数据</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"receive server data: %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server closed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    

    <span class="token comment">// 4. 关闭连接</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="15-2-多线程实现并发服务器"><a href="#15-2-多线程实现并发服务器" class="headerlink" title="15.2 多线程实现并发服务器"></a>15.2 <code>多线程</code>实现并发服务器</h3><h5 id="示例代码（server）-1"><a href="#示例代码（server）-1" class="headerlink" title="示例代码（server）"></a>示例代码（server）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">sockInfo</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>                     <span class="token comment">// 通信的文件描述符</span>
    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>              <span class="token comment">// 线程号</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span>    <span class="token comment">// 客户端信息</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">sockInfo</span> sockinfos<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">working</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 文件描述符，客户端信息，线程号</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockInfo</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockInfo</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>

     <span class="token comment">// 获取客户端信息</span>
    <span class="token keyword">char</span> clientIP<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>addr<span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> clientPort <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client ip : %s, port : %d\n"</span><span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> clientPort<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 接收客户端的数据</span>
    <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server receive : %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">write</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 回射服务器，原封不动发送回去</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>   

    <span class="token comment">// 恢复占用标记</span>
    info<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    info<span class="token operator">-&gt;</span>tid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 初始化</span>
    <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sockinfos<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sockinfos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">// 无效文件描述符，标识avaliable</span>
        sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tid <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 1. 创建 socket</span>
    <span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>listen_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 绑定端口和ip</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. 监听</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. 循环等待客户端连接请求</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 接受客户端连接请求</span>
        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientAddr<span class="token punctuation">;</span>
        <span class="token keyword">int</span> clientAddrLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>client_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 创建子线程</span>

        <span class="token comment">// 找到可用的sockInfo</span>
        <span class="token keyword">struct</span> <span class="token class-name">sockInfo</span>  <span class="token operator">*</span>info<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                info <span class="token operator">=</span> <span class="token operator">&amp;</span>sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> max <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// 从头开始找空闲</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        info<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> client_fd<span class="token punctuation">;</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientAddr<span class="token punctuation">,</span> clientAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> working<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 释放资源，不能用 join，因为它是阻塞的</span>
        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    
    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="示例代码（client）-1"><a href="#示例代码（client）-1" class="headerlink" title="示例代码（client）"></a>示例代码（client）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>   
    <span class="token comment">// 1. 创建套接字</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 连接服务器端</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serveraddr<span class="token punctuation">;</span>
    serveraddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">"172.24.190.150"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serveraddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    serveraddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serveraddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serveraddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. 通信</span>
    <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> send_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 给服务端发送数据</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">,</span> <span class="token string">"client send: %d"</span><span class="token punctuation">,</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> send_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 把\0也写过去</span>
        

        <span class="token comment">//读取服务端的数据</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"receive server data: %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server closed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    

    <span class="token comment">// 4. 关闭连接</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="16-TCP-状态转换"><a href="#16-TCP-状态转换" class="headerlink" title="16. TCP 状态转换"></a>16. TCP 状态转换</h2><p>发生再三次握手和四次挥手的时候，中间通信的时候状态不会改变。</p>
<p>为什么要经过 <code>2MSL</code>? 因为要保证数据安全，保证第四次挥手的 <code>ack</code> 被对方接收到。让对方不断地发送 <code>FIN</code>，使得主动关闭方发送的 <code>ack</code> 被对方接收到。</p>
<p>主动请求断开的一方才会经历这个。</p>
<p>客户端第四次挥手发送 <code>ack</code> 服务器端的断开请求，可能服务端没有接收到，因此服务端会再次给客户端发送 <code>FIN</code>,直到客户端发送的 <code>ack</code> 被服务端接收到，这样通信才能正常断开连接。</p>
<p> <img src="https://img-blog.csdnimg.cn/99cd1ad203c74b16ae90794f894f49bc.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/b1499a5b285245da9a9d011239ba3e1f.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> </p>
<p><strong>2MSL（Maximum Segment Lifetime）</strong></p>
<blockquote>
<p>主动断开连接的一方, 最后进出入一个 TIME_WAIT状态, 这个状态会持续: 2msl </p>
</blockquote>
<p><strong>msl</strong>:</p>
<blockquote>
<p>官方建议: 2分钟, 实际是30s</p>
</blockquote>
<p>当 TCP 连接<code>主动关闭方</code>接收到被动关闭方发送的 FIN 和最终的 ACK 后，连接的主动关闭方必须处于TIME_WAIT 状态并持续 2MSL 时间。 这样就能够让 TCP 连接的主动关闭方在它发送的 ACK 丢失的情况下重新发送最终的 ACK。 主动关闭方重新发送的最终 ACK 并不是因为被动关闭方重传了 ACK（它们并不消耗序列号， 被动关闭方也不会重传），而是因为被动关闭方重传了它的 FIN。事实上，<strong>被动关闭方总是 重传 FIN 直到它收到一个最终的 ACK</strong>。</p>
<h2 id="17-半关闭"><a href="#17-半关闭" class="headerlink" title="17. 半关闭"></a>17. 半关闭</h2><p><strong>半关闭</strong>（被动关闭端不断发送收拾残局的数据）</p>
<p>当 TCP 链接中 A 向 B 发送 FIN 请求关闭，另一端 B 回应 ACK 之后（A 端进入 FIN_WAIT_2 状态），并没有立即发送 FIN 给 A，A 方处于半连接状态（半开关）。</p>
<p>此时 A 可以接收 B 发 送的数据，但是 A 已经不能再向 B 发送数据。</p>
<p>A-&gt;B：close()</p>
<p>B-&gt;A：ack</p>
<p>但是B不给A发送 close()，也就是说被动方暂时不想关闭不进行第三次挥手。</p>
<p>然而，我们调用 close 会直接关闭文件描述符，这样的话主动方既不能读也不能写。但是我们希望主动方可以读，不能写。</p>
<p>从程序的角度，可以使用 API 来控制实现半连接状态：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> how<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>参数：</p>
<ul>
<li><p>bsockfd：需要关闭的socket的描述符</p>
</li>
<li><p>how：允许为 shutdown 操作选择以下几种方式:</p>
<ul>
<li><p>SHUT_RD(0)：</p>
<p>关闭sockfd上的读功能，此选项将不允许sockfd进行读操作。<br>该套接字不再接收数据，任何当前在套接字接受缓冲区的数据将被无声地<code>丢弃</code>掉。</p>
</li>
<li><p>SHUT_WR(1): </p>
<p>关闭sockfd的写功能，此选项将不允许sockfd进行写操作。进程不能在对此套接字发出写操作。</p>
</li>
</ul>
</li>
<li><p>SHUT_RDWR(2):</p>
<p>关闭sockfd的读写功能。相当于调用shutdown两次：首先是以SHUT_RD,然后以 SHUT_WR。</p>
</li>
</ul>
<p>使用 close 中止一个连接，但它只是<code>减少描述符的引用计数</code>，并不直接关闭连接，只有当描述符的引用 计数为 0 时才关闭连接。子进程和父进程共享文件描述符，在子进程中关闭只会引用计数 -1。只有当引用计数=0时，文件描述符资源才会被释放。</p>
<p>shutdown 不考虑描述符的引用计数，<code>直接关闭</code>描述符。也可选择中止一个方向的连接，只中止读或只中止写。 </p>
<p>注意: </p>
<ol>
<li>如果有多个进程共享一个套接字，close 每被调用一次，计数减 1 ，直到计数为 0 时，也就是所用 进程都调用了 close，套接字将被释放。 </li>
<li>在多进程中如果一个进程调用了 shutdown(sfd, SHUT_RDWR) 后，其它的进程将无法进行通信。 但如果一个进程 close(sfd) 将不会影响到其它进程。</li>
</ol>
<h2 id="18-端口复用"><a href="#18-端口复用" class="headerlink" title="18. 端口复用"></a>18. 端口复用</h2><p>启动服务端，可以看到有个它正处于 LISTEN 状态下。</p>
<p>服务端使用我们指定的 <code>9999</code> 号端口。</p>
<p><img src="https://img-blog.csdnimg.cn/c0151ebbf7bf44c2bc7e6bee7d96870f.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>启动客户端， 可以看到客户端已经和服务端建立连接，处于 <code>ESTABLISHED</code> 状态下。</p>
<p>客户端的 ip 是 <code>127.24.190.150</code>，并使用系统随机分配的 <code>55332</code> 号端口。</p>
<p><img src="https://img-blog.csdnimg.cn/e6167947fbe343748c628442265e7074.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>在通信的过程中我们不断查看状态，会发现没有任何改变。</p>
<p>这也印证了上面所说的 TCP 状态只有在三次握手和四次挥手的时候会转变，在通信过程中不会改变。</p>
<p>然而，我们主动断开服务端后，其处于 <code>FIN_WAIT2</code> 状态。</p>
<p>当我们断开客户端后，服务端处于 <code>TIME_WAIT</code>，会根据系统设定的时长一直等待。因此它还在占用着这个端口。</p>
<p>如果有其他进程想要使用这个端口就会失败。</p>
<p>端口复用最常用的用途：</p>
<ul>
<li> 防止服务器重启时之前绑定的端口还未释放 </li>
<li>程序突然退出而系统没有释放端口</li>
</ul>
<p>设置套接字的属性（不仅仅能设置端口复用）</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> optname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>optval<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span>
optlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
参数：<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>sockfd : 要操作的文件描述符</p>
</li>
<li><p>level : 级别 - SOL_SOCKET (端口复用的级别)</p>
</li>
<li><p>optname : 选项的名称</p>
<ul>
<li>SO_REUSEADDR</li>
<li>SO_REUSEPORT</li>
</ul>
</li>
<li><p>optval : 端口复用的值（整形）, void*可以设置int也可以设置结构体</p>
<ul>
<li>1 : 可以复用</li>
<li>0 : 不可以复用</li>
</ul>
</li>
<li><p>optlen : optval参数的大小</p>
<p>端口复用，设置的时机是在服务器绑定端口之前。<br>先setsockopt() 再 bind()。</p>
</li>
</ul>
<h2 id="19-IO多路复用"><a href="#19-IO多路复用" class="headerlink" title="19. IO多路复用"></a>19. IO多路复用</h2><h3 id="19-1-IO多路复用介绍"><a href="#19-1-IO多路复用介绍" class="headerlink" title="19.1 IO多路复用介绍"></a>19.1 IO多路复用介绍</h3><p>也叫 I/O多路转接。</p>
<p>传统：</p>
<blockquote>
<p>输入：文件 -&gt; 内存，</p>
<p>输出：内存 -&gt; 文件</p>
</blockquote>
<p>在网络编程中指的是通信双方操作 socket 读写缓冲区。</p>
<p>I/0 多路复用指程序能<code>同时监听</code>多个文件描述符，提高程序的性能。程序同时监听，知道有多少个客服端发来了消息。</p>
<h5 id="BIO-模型"><a href="#BIO-模型" class="headerlink" title="BIO 模型"></a>BIO 模型</h5><p> <img src="https://img-blog.csdnimg.cn/e13ab2a6021b45109be286a1e1507276.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/9c298786ac684c5bb10b678bee0b6b0f.png" alt="img"></p>
<h5 id="NIO-模型"><a href="#NIO-模型" class="headerlink" title="NIO 模型"></a>NIO 模型</h5><p><img src="https://img-blog.csdnimg.cn/75da6c51b51f4dfcb92c4ab0f6424b94.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/5e8b08577e304fd6ba8219322f5d7b55.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>通信需要遍历所有已经连接的客户端的文件描述符。</p>
<h5 id="I-O-多路转接技术"><a href="#I-O-多路转接技术" class="headerlink" title="I/O 多路转接技术"></a>I/O 多路转接技术</h5><p>原先自己检测多路通过 read\rece 判断读每一个文件描述符的读缓冲区有无数据。</p>
<p>现在把所有的文件描述符给内核检查，只调用一次就行了。</p>
<p><img src="https://img-blog.csdnimg.cn/6519308b434842c794bc06858a34819e.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/403c641c968d4caf9c27c4ff088a4f15.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h3 id="19-2-select"><a href="#19-2-select" class="headerlink" title="19.2 select"></a>19.2 select</h3><p>不使用多进程或多线程。</p>
<p>主旨思想：</p>
<ul>
<li>构造一个关于<code>文件描述符</code>的<code>列表</code>，将要监听的文件描述符添加到列表中。</li>
<li>调用一个系统函数，监听该列表中的文件描述符，直到这些文件描述符中<code>一个或多个</code>进行IO操作时，函数返回。<ul>
<li>该函数<code>阻塞</code></li>
<li>函数会文件描述符的检测由内核完成</li>
</ul>
</li>
<li>返回时，告诉进程有<code>多少</code>文件描述符要进行IO操作。</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/9318fc1ce6ae456481ffcf5bf82b077d.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h4 id="相关函数"><a href="#相关函数" class="headerlink" title="相关函数"></a>相关函数</h4><p>头文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* According to POSIX.1-2001, POSIX.1-2008 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>

<span class="token comment">/* According to earlier standards */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="select"><a href="#select" class="headerlink" title="select"></a>select</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span>
           fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span>    tv_sec<span class="token punctuation">;</span>         <span class="token comment">/* seconds */</span>
    <span class="token keyword">long</span>    tv_usec<span class="token punctuation">;</span>        <span class="token comment">/* microseconds */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>参数：</p>
<ul>
<li><p>nfds：委托内核检测的最大文件描述符的值 + 1</p>
</li>
<li><p>readfds：要检测的文件描述符的读的集合，委托内核检测那些文件描述符的读属性</p>
<p>​                  对应对方发送过来的数据，读是被动接受数据，检测读缓冲区</p>
<p>​                  传入 + 传出参数 long int</p>
</li>
<li><p>writefds：要检测的文件描述符的写的集合，委托内核检测那些文件描述符的写属性</p>
<p>​                  检测写缓冲区是否还可以写数据，不满就可以写</p>
<p>​                  一般不去检测，数据满了就阻塞</p>
</li>
<li><p>exceptfds：检测发生异常的文件描述符的集合，一般不使用</p>
</li>
<li><p>timeout：超时时间，如果没有检测到内容会阻塞。</p>
<ul>
<li>NULL：永久阻塞，直到检测到了文件描述符有变化</li>
<li>tv_sec = 0, tv_usec  = 0 —&gt; 不阻塞</li>
<li>tv_sec &gt; 0, tv_usec &gt; 0，阻塞对应的时间</li>
</ul>
</li>
</ul>
<p>返回值：</p>
<ul>
<li>失败：-1</li>
<li>成功：检测的集合中有 n 个文件描述符发生了变化</li>
</ul>
<h5 id="FD-CLR"><a href="#FD-CLR" class="headerlink" title="FD_CLR"></a>FD_CLR</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FD_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>作用：将 fd 对应的标志位置0</p>
<h5 id="FD-ISSET"><a href="#FD-ISSET" class="headerlink" title="FD_ISSET"></a>FD_ISSET</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span>  <span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>作用：判断 fd 对应的标志位是0还是1</p>
<p>返回值：fd 对应的标志位的值（0、1）</p>
<h5 id="FD-SET"><a href="#FD-SET" class="headerlink" title="FD_SET"></a>FD_SET</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>作用：将 fd 对应的标志位设置为1</p>
<h5 id="FD-ZERO"><a href="#FD-ZERO" class="headerlink" title="FD_ZERO"></a>FD_ZERO</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FD_ZERO</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>作用：fdset的1024个比特位全部初始化为 0</p>
<h5 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. 创建 socket</span>
    <span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>

    <span class="token comment">// 2. 绑定 </span>
    <span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 监听</span>
    <span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. fd_set</span>
    fd_set rdset<span class="token punctuation">,</span> tmp<span class="token punctuation">;</span>
    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rdset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FD_SET</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rdset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> maxfd <span class="token operator">=</span> listen_fd<span class="token punctuation">;</span>  <span class="token comment">// 要监听的最大的 fd</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        tmp <span class="token operator">=</span> rdset<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>maxfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永久阻塞</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">// 这里没可能</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientAddr<span class="token punctuation">;</span>
                <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 通信文件描述符添加到集合中</span>
                <span class="token function">FD_SET</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rdset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                maxfd <span class="token operator">=</span> maxfd <span class="token operator">&gt;</span> client_fd <span class="token operator">?</span> maxfd <span class="token operator">:</span> client_fd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> listen_fd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> maxfd<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rdset<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// 说明该 fd 对应的客户端发来了数据</span>
                    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed ...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">FD_CLR</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rdset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server read:%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">write</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 回写</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://img-blog.csdnimg.cn/8c7b63fe0a194d85b5dc72d05257df6b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h3 id="19-3-poll"><a href="#19-3-poll" class="headerlink" title="19.3 poll"></a>19.3 poll</h3><p>优化版的 select，支持文件描述符数组重用，不需要额外的开销。</p>
<p>但是没多大差别</p>
<h5 id="相关函数-1"><a href="#相关函数-1" class="headerlink" title="相关函数"></a>相关函数</h5><h5 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>fds<span class="token punctuation">,</span> <span class="token class-name">nfds_t</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">pollfd</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>					<span class="token comment">// 委托内核检测的文件描述符</span>
    <span class="token keyword">short</span> <span class="token keyword">int</span> events<span class="token punctuation">;</span>		<span class="token comment">// 委托内核检测文件描述符的什么事件</span>
    <span class="token keyword">short</span> <span class="token keyword">int</span> revents<span class="token punctuation">;</span>		<span class="token comment">// 文件描述符实际发生的事件</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>参数：</p>
<ul>
<li>fds：一个 struct pollfd 类型的结构体数组，要检测的文件描述符的集合</li>
<li>nfds：第一个参数数组中的最后一个有效元素的下标</li>
<li>timeout：阻塞市时长<ul>
<li>0：不阻塞</li>
<li>-1：阻塞，当文件描述符有变化时，接触阻塞</li>
<li>&gt; 0：阻塞时长</li>
</ul>
</li>
</ul>
<p>返回值：</p>
<ul>
<li>-1：失败</li>
<li>&gt; 0 (n)：成功，检测到了n个文件描述符发生变化</li>
</ul>
<p>event 对应的宏</p>
<p><img src="https://img-blog.csdnimg.cn/fbf00fbf751b4506acfcf7c909799f85.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p>
<h5 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a>示例代码</h5><p>呃呃，我的代码有bug，还没有调好。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. 创建 socket</span>
    <span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>

    <span class="token comment">// 2. 绑定 </span>
    <span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 监听</span>
    <span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 要维护的监听到有改变的文件描述符集合</span>
    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> fds<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>     <span class="token comment">// hope 检测读的事件</span>
    <span class="token punctuation">}</span>

    fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> listen_fd<span class="token punctuation">;</span>

    <span class="token keyword">int</span> nfds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">// 最大的有新数据的文件描述符</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 调用poll系统函数，让内核帮检测哪些文件描述符有数据</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>fds<span class="token punctuation">,</span> nfds <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"poll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">// 这里没可能</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">// 监听到了有文件描述符发生变化</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token comment">// 判断 revents，即实际发生的事件</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// 说明有客户端向监听端口发消息了，他想要连接进来</span>
                <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientAddr<span class="token punctuation">;</span>
                <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 把新连接进来的客户端加入集合添加到集合中</span>
                <span class="token comment">// 从头遍历找空闲文件描述符</span>

                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> client_fd<span class="token punctuation">;</span>
                        fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>

                        <span class="token comment">// 更新目前最大的文件描述符</span>
                        nfds <span class="token operator">=</span> nfds <span class="token operator">&gt;</span> i <span class="token operator">?</span> nfds <span class="token operator">:</span> i<span class="token punctuation">;</span>

                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    
            <span class="token punctuation">}</span>

            <span class="token comment">// 响应客户端</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> nfds<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// 说明该 fd 对应的客户端发来了数据</span>
                    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed ...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">close</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// i 是索引，真正的文件描述符要去取</span>
                        fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server read:%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">write</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 回写</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="19-4-epoll"><a href="#19-4-epoll" class="headerlink" title="19.4 epoll"></a>19.4 epoll</h3><p>​    通过 <code>epoll_create</code> 在内核中创建一个 epoll 实例 (struct，包含一个rbtree和一个就绪的链表)，返回一个 int，是个文件描述符。但并不是通过 read，write 直接操作，而是通过 epoll 相关的 api。</p>
<p>​    希望内核检测的文件描述符存储在 <code>rbr</code> 中，实际发生改变的文件描述符就存储在 <code>rdlist</code> 里面。</p>
<p>​    通过 <code>epoll_ctl</code>  一些参数，通过 <code>epoll_wait</code> 等待内核检测并通过传出参数返回改变了的文件描述符，会拷贝一次。</p>
<p><img src="https://img-blog.csdnimg.cn/7d03e5b89da345bfb5c1c91a8ed9e6ea.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h5 id="相关函数-2"><a href="#相关函数-2" class="headerlink" title="相关函数"></a>相关函数</h5><h5 id="epoll-create"><a href="#epoll-create" class="headerlink" title="epoll_create"></a>epoll_create</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

DESCRIPTION
       <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> creates a new epoll instance<span class="token punctuation">.</span>  Since Linux <span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span> the size argument is ignored<span class="token punctuation">,</span> but must be 【greater than zero】<span class="token punctuation">;</span> see NOTES below<span class="token punctuation">.</span>

       <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  returns  a  【file  descriptor】 referring to the new epoll instance<span class="token punctuation">.</span>  This file descriptor is used <span class="token keyword">for</span> all the subsequent calls to the epoll interface<span class="token punctuation">.</span>  When no longer required<span class="token punctuation">,</span> the file descriptor returned by <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> should be closed by using 【close】<span class="token punctuation">.</span>  When  all  file  descriptors referring to an epoll instance have been closed<span class="token punctuation">,</span> the kernel destroys the instance and releases the associated resources <span class="token keyword">for</span> reuse<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>size：目前没有意义了，随便写一个非零的数。以前使用哈希去实现的，现在被改进了。</li>
</ul>
<p>返回值：</p>
<ul>
<li>失败： -1</li>
<li>成功：&gt; 0，一个文件描述符，用于操作 epoll 实例，通过这个返回的文件描述符就可以找到内核中的这块数据</li>
</ul>
<h5 id="epoll-ctl"><a href="#epoll-ctl" class="headerlink" title="epoll_ctl"></a>epoll_ctl</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

DESCRIPTION
       This  system  call is used to add<span class="token punctuation">,</span> modify<span class="token punctuation">,</span> or remove entries in the interest list of the <span class="token function">epoll</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> instance referred to by the file descriptor epfd<span class="token punctuation">.</span>
       It requests that the operation op be performed <span class="token keyword">for</span> the target file descriptor<span class="token punctuation">,</span> fd<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>作用：control interface for an epoll file descriptor</p>
<p>参数：</p>
<ul>
<li><p><code>epfd</code> 指定了在内核中实例化的 <code>epoll实例</code>，本质上就是一块数据，通过 epfd 来引用。</p>
</li>
<li><p><code>op</code> 是我们想要对 <code>fd</code> 这个文件描述符做的事情包括：</p>
<ul>
<li>EPOLL_CTL_<strong>ADD</strong> 增加</li>
</ul>
<p>​    Add fd to the interest list and associate the settings specified in event with the internal file linked to fd. 往红黑树中新添加一个结点。</p>
<ul>
<li>EPOLL_CTL_<strong>MOD</strong> 修改</li>
</ul>
<p>​    Change the settings associated with fd in the interest list to the new settings specified in event.</p>
<ul>
<li>EPOLL_CTL_**DEL **删除</li>
</ul>
<p>​    Remove (deregister) the target file descriptor fd from the interest list.  The event argument is ignored and can be NULL (but see  BUGS  below).</p>
</li>
<li><p><code>fd</code>：被操作的文件描述符,这个系统调用的主角</p>
</li>
<li><p>event：要检测的事件，如果检测到了就让内核去做 <code>op</code> 这个事件（EPOLLIN, EPOLLOUT, EPOLLERR等）</p>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">union</span> epoll_data <span class="token punctuation">{</span>	<span class="token comment">// 一些用户的数据信息，一般来说使用 fd 就成</span>
    <span class="token keyword">void</span>        <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    <span class="token keyword">int</span>          fd<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span>     u32<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span>     u64<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">epoll_data_t</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span>     events<span class="token punctuation">;</span>      <span class="token comment">/* Epoll events */</span>
    <span class="token class-name">epoll_data_t</span> data<span class="token punctuation">;</span>        <span class="token comment">/* User data variable */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="epoll-wait"><a href="#epoll-wait" class="headerlink" title="epoll_wait"></a>epoll_wait</h5><p>检测函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">,</span>
               <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

The  <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  system  call  waits  <span class="token keyword">for</span> events on the epoll instance referred to by the file descriptor 【epfd】<span class="token punctuation">.</span>  The memory area pointed to by 【events】 will contain the events that will be available <span class="token keyword">for</span> the caller<span class="token punctuation">.</span>  Up to 【maxevents】 are returned by <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  The maxevents  argument  must be greater than zero<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>作用：wait for an I/O event on an epoll file descriptor</p>
<p>参数：</p>
<ul>
<li>epfd</li>
<li>epoll_event：传出参数，发生改变的那几个文件描述符信息</li>
<li>maxevents：第二个参数 epoll_event 的大小</li>
<li>timeout：阻塞时间<ul>
<li>0：不阻塞</li>
<li>-1：阻塞，知道检测到信息解除阻塞</li>
<li>&gt; 0：要阻塞的时长</li>
</ul>
</li>
</ul>
<p>返回值：</p>
<ul>
<li>成功：<ul>
<li>&gt; 0：发生改变的文件描述符数量</li>
<li>= 0：没有任何变化</li>
</ul>
</li>
<li>失败：-1</li>
</ul>
<h5 id="示例代码-3"><a href="#示例代码-3" class="headerlink" title="示例代码"></a>示例代码</h5><h2 id="20-UDP"><a href="#20-UDP" class="headerlink" title="20. UDP"></a>20. UDP</h2><h3 id="20-1-UDP-通信"><a href="#20-1-UDP-通信" class="headerlink" title="20.1 UDP 通信"></a>20.1 UDP 通信</h3><h3 id="20-2-广播"><a href="#20-2-广播" class="headerlink" title="20.2 广播"></a>20.2 广播</h3><h3 id="20-3-组播"><a href="#20-3-组播" class="headerlink" title="20.3 组播"></a>20.3 组播</h3><h3 id="20-4-本地套接字通信"><a href="#20-4-本地套接字通信" class="headerlink" title="20.4 本地套接字通信"></a>20.4 本地套接字通信</h3>
                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Ludovico</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://sakkana.github.io/2022/04/24/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">https://sakkana.github.io/2022/04/24/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Ludovico</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/C-C/">
                                    <span class="chip bg-color">C/C++</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/04/27/HTML/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="学一点前端-HTML">
                        
                        <span class="card-title">学一点前端-HTML</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-04-27
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Web/" class="post-category">
                                    Web
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/HTML/">
                        <span class="chip bg-color">HTML</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/04/23/Linux%E5%A4%9A%E7%BA%BF%E7%A8%8B/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="Linux多线程">
                        
                        <span class="card-title">Linux多线程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-04-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/" class="post-category">
                                    系统编程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C-C/">
                        <span class="chip bg-color">C/C++</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 魚のブログ<br />'
            + '文章作者: Ludovico<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2022</span>
            
            <span id="year">2022</span>
            <a href="/about" target="_blank">Ludovico</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">115.3k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = 2022;
                    var startMonth = 1;
                    var startDate = 29;
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Sakkana" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:642835027@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=642835027" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 642835027" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
