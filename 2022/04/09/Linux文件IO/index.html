<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Linux文件IO, 魚のブログ">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Linux文件IO | 魚のブログ</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="魚のブログ" type="application/atom+xml">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">魚のブログ</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">魚のブログ</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Linux文件IO</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/C-C/">
                                <span class="chip bg-color">C/C++</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/" class="post-category">
                                系统编程
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-04-09
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    10.6k
                </div>
                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="文件IO"><a href="#文件IO" class="headerlink" title="文件IO"></a>文件IO</h1><h3 id="输入输出是相对的"><a href="#输入输出是相对的" class="headerlink" title="输入输出是相对的"></a>输入输出是相对的</h3><p>对于文件, input为内存-&gt;文件</p>
<p>​                output为文件-&gt;内存</p>
<p>对于内存，input为文件-&gt;内存</p>
<p>​                    output为内存-&gt;文件</p>
<p>我们站在<code>内存的角度</code>看，因为我们系的程序会被加载到内存中，因此output是从内存到文件，input是从内存到文件</p>
<p>这一章节会频繁查看Linux的man手册</p>
<p>1   Executable programs or shell commands （标准命令）</p>
<p>2   System calls (functions provided by the kernel)    （系统调用）</p>
<p>3   Library calls (functions within program libraries)（库函数）</p>
<p>man 1 mkdir 是shell命令 mkdir</p>
<p>man 2 mkdir 是Linux系统调用 mkdir</p>
<p>man 3 printf 是库函数 printf</p>
<h2 id="1-Linux系统IO-amp-标准C库IO"><a href="#1-Linux系统IO-amp-标准C库IO" class="headerlink" title="1. Linux系统IO &amp; 标准C库IO"></a>1. Linux系统IO &amp; 标准C库IO</h2><p><img src="https://img-blog.csdnimg.cn/eb9e955eccd44b7eb4a3457db10c4d9c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="IO函数"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p>Java跨平台：为不同的操作系统做一个<code>JVM</code></p>
<p>标准C库函数跨平台（操作系统）：C库是第三方库跑在不同的操作系统上底层会调用不同操作系统的API。</p>
<p><code>标准C库的IO函数</code>更高级，更高效（带有缓冲区）。</p>
<p><code>Linux的IO函数</code>更底层，有特定使用场景，如网络通信（要求通信效率，如果数据还在缓冲区中，对方收不到急死了，直接用Linux系统I/O函数，实时发送）。</p>
<h5 id="FILE-是一个结构体"><a href="#FILE-是一个结构体" class="headerlink" title="FILE* 是一个结构体"></a>FILE* 是一个结构体</h5><ul>
<li><p>文件描述符（整型值），指向打开的文件。（Windows操作系统中称为文件句柄）</p>
</li>
<li><p>文件读写指针，维护了两个指针，用于操作数据，读数据或写数据。</p>
</li>
<li><p>I/O缓冲区，所有的标准C库函数都带有I/O缓冲区</p>
<p>调用 <code>fopen</code> 之后，该函数会返回一个<code>FILE*类型</code>的<code>文件指针</code>，通过它我们可以操控这个指针指向的磁盘上的文件，<code>fwrite</code>，<code>fread</code>等IO函数都要求传入这个文件指针。</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/34f892ad27ca487f939ce7a943756b40.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="fwrite"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p>每次调用 <code>fwrite</code>，并不是一下子把数据写到磁盘，而是先写到缓冲区（实质上是<code>内存</code>），一旦缓冲区满了，就调用Linux系统调用，统一写道磁盘中。以此来提高程序执行效率。</p>
<p>无缓冲区，写一次数据存一次到磁盘，用系统调用直接跟硬件打交道，效率低。</p>
<p>有缓冲区，统一写到缓冲区中，等满了之后统一打包，调用一次系统调用写道磁盘，效率高。</p>
<p>因此，有无缓冲区的本质区别是，数据写到<code>内存</code>还是写到<code>磁盘</code>。</p>
<h5 id="缓冲区什么时候往磁盘写数据？"><a href="#缓冲区什么时候往磁盘写数据？" class="headerlink" title="缓冲区什么时候往磁盘写数据？"></a>缓冲区什么时候往磁盘写数据？</h5><ul>
<li><p>1.强制刷新缓冲区 <code>fflush</code></p>
</li>
<li><p>2.缓冲区已满</p>
</li>
<li><p>3.正常关闭文件</p>
<ul>
<li><code>fclose</code></li>
<li><code>return</code> (main 函数)</li>
<li><code>exit</code> (main 函数)</li>
</ul>
</li>
</ul>
<p>缓冲区默认 <code>8192byte</code> ≈ <code>9KB</code>，可以人为调节但是不建议，因为这是理想大小。</p>
<h5 id="标准C库IO-amp-Linux系统IO的关系"><a href="#标准C库IO-amp-Linux系统IO的关系" class="headerlink" title="标准C库IO &amp; Linux系统IO的关系"></a>标准C库IO &amp; Linux系统IO的关系</h5><p><img src="https://img-blog.csdnimg.cn/e693a93b51fa425d82fe3bf34757d407.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="关系"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p>缓冲区使命：减少程序与磁盘交换次数</p>
<h2 id="2-虚拟地址空间"><a href="#2-虚拟地址空间" class="headerlink" title="2. 虚拟地址空间"></a>2. 虚拟地址空间</h2><p><img src="https://img-blog.csdnimg.cn/a3832d28aec144819f687c8c14676ab9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="32位机器的虚拟地址空间"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p>虚拟地址空间是对进程的内存的一种抽象，实际不存在。</p>
<p>直接分配物理内存存在的问题：物理内存不够或断掉……</p>
<p>在可执行程序运行期间，就会创建这么一个虚拟地址空间，进程结束就不复存在。</p>
<p>进程是资源分配的最小单位。</p>
<p><code>程序</code>是磁盘上的代码。</p>
<p><code>进程</code>是运行中的程序，会被加载到内存中。</p>
<p>理解应用程序运行时的一些机制，不深究虚拟地址空间的实现方法。</p>
<p>虚拟地址空间大小由CPU决定， 32位机器有 2<sup>32</sup>byte ≈ 4GB 这么大， 64位机器有 2<sup>48</sup> 这么大。</p>
<p>虚拟地址空间中的数据会被CPU当中的<code>MMU（内存管理单元）</code>映射到物理内存中。</p>
<p>即： 虚拟地址 —&gt; MMU —&gt; 物理地址</p>
<p>虚拟内存占用了4G，但实际上在物理内存中占了不到4G.</p>
<h5 id="0G-3G-是用户区，普通用户可以操作其中某些空间。"><a href="#0G-3G-是用户区，普通用户可以操作其中某些空间。" class="headerlink" title="0G~ 3G 是用户区，普通用户可以操作其中某些空间。"></a>0G~ 3G 是用户区，普通用户可以操作其中某些空间。</h5><ul>
<li>受保护的地址 : NULL, nullptr</li>
<li>.txt : 代码段</li>
<li>.data：已初始化的 global variable</li>
<li>.bss：未初始化的global variable</li>
<li>堆空间(大)：malloc，低地址往高地址生长</li>
<li>共享库：前几节课学习的动态库</li>
<li>栈空间(小)：local variable 高地址往低地址生长</li>
<li>命令行参数：int argc, char *argv[]</li>
<li>环境变量：每个Linux用户都有环境变量<ul>
<li><img src="https://img-blog.csdnimg.cn/1526d205cd6b47c4924584b26dc20eed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="Linux下执行env命令查看用户环境变量"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></li>
</ul>
</li>
</ul>
<h5 id="3G-4G-是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read-write函数）"><a href="#3G-4G-是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read-write函数）" class="headerlink" title="3G ~4G 是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read, write函数）"></a>3G ~4G 是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read, write函数）</h5><ul>
<li>内存管理</li>
<li>进程管理</li>
<li>设备驱动管理</li>
<li>VFS虚拟文件系统</li>
</ul>
<h2 id="3-文件描述符"><a href="#3-文件描述符" class="headerlink" title="3. 文件描述符"></a>3. 文件描述符</h2><p><img src="https://img-blog.csdnimg.cn/9cfeca140f424a2c9d433423c6830a34.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="懒得写了"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="进程-VS-程序"><a href="#进程-VS-程序" class="headerlink" title="进程 VS 程序"></a>进程 VS 程序</h5><p><img src="https://img-blog.csdnimg.cn/3b7da6b7f6854c24ada790d0ef16cd75.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p>这里的 test.c源代码文件 和 app可执行文件 都是存储在磁盘上的文件，不占用内存空间。</p>
<p>当 ./app 之后，程序被加载到内存当中，操作系统创建一个进程，为这个程序的运行分配资源。</p>
<h5 id="那么，为什么程序当中调用-fopen-以后，调用-fread-和-fwrite-就可以找到磁盘上的文件？"><a href="#那么，为什么程序当中调用-fopen-以后，调用-fread-和-fwrite-就可以找到磁盘上的文件？" class="headerlink" title="那么，为什么程序当中调用 fopen 以后，调用 fread 和 fwrite 就可以找到磁盘上的文件？"></a>那么，为什么程序当中调用 <code>fopen</code> 以后，调用 <code>fread</code> 和 <code>fwrite</code> 就可以找到磁盘上的文件？</h5><p>因为调用fopen以后会返回一个<code>FILE*文件指针</code>，里面封装了一个<code>文件描述符</code>，文件描述符存储在内核区中。</p>
<p>内核就是一个程序，光有内核还不行，还不能称为OS。OS需要在后台管理所有的资源，并且还有一系列工具，如gcc，gdb等。这一切杂揉起来才成了OS。</p>
<p>内核区中的<code>PCB(进程控制块)</code>管理文件描述符。PCB是一个结构体，保存管理进程所需要的数据。</p>
<p>PCB 中有一个<code>数组</code>（因为一个进程可以打开多个文件），里面有一个 <code>文件描述符表</code>，里面存了很多文件描述符，每个描述符定位一个文件。</p>
<p>其大小默认为<code>1024</code>，最多能同时打开1024个文件。</p>
<p>文件描述符表中<code>0, 1, 2 (STDIN_FILENO, STDOUT_FILENO, STDERR_FILENO)</code> 默认被占用，默认被打开。他们都对应了同一个设备文件（由此可见，不同的文件描述符可以对应同一个文件），指向<code>当前使用的终端（/dev/tty)</code>。</p>
<p>一个文件可以被打开多次，但是文件描述符是不一样的，可以打开读，可以打开写。</p>
<p>当某个文件描述符被占用，内核会找到<code>最小的未被占用的</code>文件描述符，如0,1,2被占用，内核会分配4.</p>
<p>fclose（C库函数），close（Linux系统IO）可以释放文件描述符，可以被重用了，如0,1,2,3,4,5被占用，释放3之后，下一次分配就会分配3。</p>
<p><code>一切皆文件</code>，在Linux中所有的硬件设备都会被虚拟成一个文件，通过这个文件管理这些设备。 </p>
<h5 id="如何得到一个文件描述符？"><a href="#如何得到一个文件描述符？" class="headerlink" title="如何得到一个文件描述符？"></a>如何得到一个文件描述符？</h5><p><code>open</code>：Linux系统API，可以得到一个文件描述符，从而操作该文件描述符指向的文件。下次用 <code>read</code> 或 <code>write</code> 时，就不是传递标准C库的API—— FILE* 了，而是Linux的系统API——文件描述符。</p>
<h2 id="4-Linux系统IO函数"><a href="#4-Linux系统IO函数" class="headerlink" title="4. Linux系统IO函数"></a>4. Linux系统IO函数</h2><p><img src="https://img-blog.csdnimg.cn/684da67d1cda47e38e26be8e6cc7e062.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h3 id="4-1-open"><a href="#4-1-open" class="headerlink" title="4.1 open"></a>4.1 open</h3><h4 id="I-open-打开旧文件"><a href="#I-open-打开旧文件" class="headerlink" title="(I) open 打开旧文件"></a>(I) open 打开旧文件</h4><p>关于open函数的介绍</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
NAME
       open, openat, creat - open and possibly create a file

SYNOPSIS
       #include &lt;sys/types.h&gt;	放宏
       #include &lt;sys/stat.h&gt;	放宏
       #include &lt;fcntl.h&gt;		这里放函数的声明

		// 打开一个已存在的文件
       int open(const char *pathname, int flags);	
		
       // 创建一个新的文件
		int open(const char *pathname, int flags, mode_t mode);
		
CRIPTION
       The  open()  system call opens the file specified by pathname.  If the specified file does not
       exist, it may optionally (if O_CREAT is specified in flags) be created by open().

       The return value of open() is a file descriptor, a small, nonnegative integer that is used  in
       subsequent  system  calls  (read(2),  write(2), lseek(2), fcntl(2), etc.) to refer to the open
       file.  The file descriptor returned by a successful call will be the lowest-numbered file  de‐
       scriptor not currently open for the process.

       By  default,  the  new  file  descriptor  is set to remain open across an execve(2) (i.e., the
       FD_CLOEXEC file descriptor flag described in fcntl(2) is initially  disabled);  the  O_CLOEXEC
       flag,  described below, can be used to change this default.  The file offset is set to the be‐
       ginning of the file (see lseek(2)).

       A call to open() creates a new open file description, an entry in  the  system-wide  table  of
       open  files.  The open file description records the file offset and the file status flags (see
       below).  A file descriptor is a reference to an open file description; this reference is unaf‐
       fected if pathname is subsequently removed or modified to refer to a different file.  For fur‐
       ther details on open file descriptions, see NOTES.

       In  addition,  zero  or  more file creation flags and file status flags can be bitwise-or'd in
       flags.  The file creation flags are O_CLOEXEC, O_CREAT, O_DIRECTORY, O_EXCL,  O_NOCTTY,  O_NO‐
       FOLLOW,  O_TMPFILE,  and O_TRUNC.  The file status flags are all of the remaining flags listed
       below.  The distinction between these two groups of flags is that the file creation flags  af‐
       fect the semantics of the open operation itself, while the file status flags affect the seman‐
       tics of subsequent I/O operations.  The file status flags can be retrieved and (in some cases)
       modified; see fcntl(2) for details.

*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="不带mode的open函数"><a href="#不带mode的open函数" class="headerlink" title="不带mode的open函数"></a>不带mode的open函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// flag是一些宏，代表文件操作权限，必选且互斥 （只读，只写，可读可写...）</span>
<span class="token comment">/*
参数：
pathname:文件路径

flags:文件操作权限 &amp; 其他设置 
The argument flags [ must ] include [ one of ] the following access  modes: O_RDONLY,  O_WRONLY,  or O_RDWR. These request opening the file read-only, write-only, or read/writie, respectively.

返回值:
open(),  openat(),  and creat() return the [ new file descriptor ], or [ -1 if an error occurred ] (in which case, [ errno ] is set appropriately).
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="perror详细介绍"><a href="#perror详细介绍" class="headerlink" title="perror详细介绍"></a>perror详细介绍</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
errno 属于Linux系统函数库里的一个全局变量，记录的是最近错误号
NAME
       perror - print a system error message
SYNOPSIS
       #include &lt;stdio.h&gt;
       void perror(const char *s);
The perror() function produces a message on standard error describing the last error encountered during a call to a system or library function.
    
First (if s is not NULL and *s is not a null byte ('\0')), the argument string s is printed, followed by a colon and a blank.  Then an error message corresponding to the current value of errno and a new-line.
    
To be of most use, the argument string should include the name of the function that incurred the error.
    
The global error list sys_errlist[], which can be indexed by errno, can be used to obtain the error message without the newline.  The largest message number provided in the  table  is  sys_nerr-1.
    
Be careful when directly accessing this list, because new error values may not have been added to sys_errlist[].  The use of sys_errlist[] is nowadays deprecated; use strerror(3) instead.
    
When  a  system call fails, it usually returns -1 and sets the variable errno to a value describing what went wrong.  (These values can be found in &lt;errno.h&gt;.)  Many library functions do likewise.
    
The function perror() serves to translate this error code into human-readable form.  Note that errno is undefined after a successful system call or library function call: this call may well change this  variable, even though it succeeds, for example because it internally used some other library function that failed.  Thus, if a failing call is not immediately followed by a call to perror(), the value of errno should be saved.
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="close-函数介绍"><a href="#close-函数介绍" class="headerlink" title="close 函数介绍"></a>close 函数介绍</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
NAME
       close - close a file descriptor

SYNOPSIS
       #include &lt;unistd.h&gt;

       int close(int fd);

DESCRIPTION
       close()  closes  a  file  descriptor,  so that it no longer
       refers to any file and may be  reused.   Any  record  locks
       (see fcntl(2)) held on the file it was associated with, and
       owned by the process, are removed (regardless of  the  file
       descriptor that was used to obtain the lock).

       If fd is the last file descriptor referring to the underly‐
       ing open file description (see open(2)), the resources  as‐
       sociated  with  the open file description are freed; if the
       file descriptor was the last reference to a file which  has
       been removed using unlink(2), the file is deleted.

RETURN VALUE
       close() returns zero on success.  On error, -1 is returned,
       and errno is set appropriately.
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>	<span class="token comment">// 包含宏</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span>	<span class="token comment">// 包含宏</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span>		<span class="token comment">// 包含 open 函数</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>		<span class="token comment">// 包含 perror 函数</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span>		<span class="token comment">// 包含 close 函数</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open failed: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// output: open failed: : No such file or directory</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>由于我们当前目录下没有 <code>a.txt</code> 这个文件，因此使用 <code>open</code> 打开必然会出错，perror会捕捉最近的出错标记 errno, 并将错误打印出来。</p>
</blockquote>
<h4 id="II-open-创建新文件"><a href="#II-open-创建新文件" class="headerlink" title="(II) open 创建新文件"></a>(II) open 创建新文件</h4><p>一些可选项的man</p>
<h5 id="O-APPEND"><a href="#O-APPEND" class="headerlink" title="O_APPEND"></a>O_APPEND</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*

O_APPEND
    The file is opened in append mode.  Before each write(2), the file offset is positioned at the end of the file, as if with lseek(2).  The modification of the file  offset  and the write operation are performed as a single atomic step.

    O_APPEND  may  lead  to corrupted files on NFS filesystems if more than one process appends data to a file at once.  This is because NFS does  not  support  appending  to  a
 file,  so the client kernel has to simulate it, which can't be done without a race condition.
 
 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="O-CREAT"><a href="#O-CREAT" class="headerlink" title="O_CREAT"></a>O_CREAT</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">O_CREAT
    If pathname does not exist<span class="token punctuation">,</span> create it as a regular file<span class="token punctuation">.</span>

    The <span class="token function">owner</span> <span class="token punctuation">(</span>user ID<span class="token punctuation">)</span> of the new file is set to the effective user ID of the process<span class="token punctuation">.</span>

    The group <span class="token function">ownership</span> <span class="token punctuation">(</span>group ID<span class="token punctuation">)</span> of the new file is set either to the effective group  ID of the <span class="token function">process</span> <span class="token punctuation">(</span>System V semantics<span class="token punctuation">)</span> or to the group ID of the parent <span class="token function">directory</span> <span class="token punctuation">(</span>BSD semantics<span class="token punctuation">)</span><span class="token punctuation">.</span>  
    On Linux<span class="token punctuation">,</span> the behavior depends on whether the set<span class="token operator">-</span>group<span class="token operator">-</span>ID mode bit  is  set on  the parent directory<span class="token operator">:</span> <span class="token keyword">if</span> that bit is set<span class="token punctuation">,</span> then BSD semantics apply<span class="token punctuation">;</span> otherwise<span class="token punctuation">,</span> System V semantics apply<span class="token punctuation">.</span>  For some filesystems<span class="token punctuation">,</span> the behavior also  depends  on  the  bsd<span class="token operator">-</span>groups and sysvgroups mount options described in <span class="token function">mount</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    
    The mode argument specifies the file mode bits be applied when a new file is  created<span class="token punctuation">.</span>   This  argument must  be  supplied when O_CREAT or O_TMPFILE is specified in flags<span class="token punctuation">;</span> <span class="token keyword">if</span> neither O_CREAT nor O_TMPFILE is specified<span class="token punctuation">,</span> then mode is ignored<span class="token punctuation">.</span>  The effective mode is modified by the process's umask  in  the  usual way<span class="token operator">:</span>  in the absence of a <span class="token keyword">default</span> ACL<span class="token punctuation">,</span> the mode of the created file <span class="token function">is</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token operator">~</span>umask<span class="token punctuation">)</span><span class="token punctuation">.</span>  Note that this mode applies only to future accesses of the newly created file<span class="token punctuation">;</span> the <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> call that  creates  a  read<span class="token operator">-</span>only file may well <span class="token keyword">return</span> a read<span class="token operator">/</span>write file descriptor<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="带mode的open函数"><a href="#带mode的open函数" class="headerlink" title="带mode的open函数"></a>带mode的open函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 创建一个新的文件</span>
<span class="token comment">/*
mode是一个八进制数，表示用户创建出的新的文件的操作权限
如0775，0代表八进制

7 -&gt; 111 ---&gt; rwx
777 -&lt; 111111111 -&gt;rwxrwxrwx
5 -&gt; 101 -&gt; r-x -&gt; 没有写的权限

umask用于抹去某些权限, umask可以自己设计(只在当前终端有用)
root用户 umask = 0022
普通用户 umask = 0002

假如一个普通用户的权限是 mode = 0777
umask = 0002
~umask = 0777 - 0002 = 0775
mode &amp; ~umask = 0777 &amp; 0775 = 111111111 &amp; 111111101 = 111111101

The  mode  argument specifies the file mode bits be applied when a new file is created.
This argument must be supplied when 【 O_CREAT or O_TMPFILE 】 is specified in flags; 
if neither  O_CREAT  nor O_TMPFILE is specified, then mode is ignored.  
The effective mode is modified by the process's 【 umask(掩码) 】 in the usual way: in the absence of a default ACL, the mode of the created file is 【 (mode &amp; ~umask) 】(最终得到的权限). 
Note that this mode applies only to 【 future accesses 】 of the newly created file; 
the open() call that creates a read-only file may well return a read/write file descriptor.


-rw-rw-r--
可以分割成四个部分
-		文件类型
rw-		当前用户对文件的权限权限
rw-		当前用户所在的组对文件的权限
r--		其他组对文件的权限


*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/3b914ee95ede4ac9850fba2e076d7aa5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// close</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>  <span class="token comment">// perror</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"create.txt"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"OPEN ERROR:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>  

<span class="token comment">// 终端无任何异常</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>Linux会为这个程序创建一个新的文件 create.txt（颜色是绿色的，因为我们给他的权限是0777, &amp;上~umask后得到0775， 即 <code>-rwxrwxr-x</code> ）</p>
</blockquote>
<h5 id="为什么用-按位或-？"><a href="#为什么用-按位或-？" class="headerlink" title="为什么用 按位或 ？"></a>为什么用 <code>按位或</code> ？</h5><pre class="line-numbers language-none"><code class="language-none">O_RDWR | O_CREAT<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们可以看到 <code>flag</code> 是个 int 类型， 即32位</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这32位每一位都是个标记位，按位或了之后可以把不同的权限组合到一起</p>
<h3 id="4-2-read-amp-write"><a href="#4-2-read-amp-write" class="headerlink" title="4.2 read &amp; write"></a>4.2 read &amp; write</h3><h5 id="关于write的man"><a href="#关于write的man" class="headerlink" title="关于write的man"></a>关于write的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
NAME
       read - read from a file descriptor

SYNOPSIS
       #include &lt;unistd.h&gt;

       ssize_t read(int fd, void *buf, size_t count);

DESCRIPTION
       read() attempts to read up to count bytes from file descriptor fd into the buffer starting at buf.

       On  files  that support seeking, the read operation commences at the file offset, and the file offset is incremented by the number of bytes read.  If the file offset is at or past the end of file,
       no bytes are read, and read() returns zero.

       If count is zero, read() may detect the errors described below.  In the absence of any errors, or if read() does not check for errors, a read() with a count of 0 returns zero and has no other  ef‐
       fects.

       According to POSIX.1, if count is greater than SSIZE_MAX, the result is implementation-defined; see NOTES for the upper limit on Linux.

RETURN VALUE
       On  success,  【 the  number of bytes read 】 is returned (【 zero 】 indicates end of file), and the file position is advanced by this number.  It is not an error if this number is smaller than the number of bytes requested; this may happen for example because fewer bytes are actually available right now (maybe because we were close to end-of-file, or because we are reading from a pipe, or from a terminal), or because read() was interrupted by a signal.  See also NOTES.
       On error, 【 -1 】 is returned, and errno is set appropriately.  In this case, it is left unspecified whether the file position (if any) changes.
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="关于write的man-1"><a href="#关于write的man-1" class="headerlink" title="关于write的man"></a>关于write的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
NAME
       write - write to a file descriptor

SYNOPSIS
       #include &lt;unistd.h&gt;

       ssize_t write(int fd, const void *buf, size_t count);	// fd 通过open得到

DESCRIPTION
       write() writes up to count bytes from the buffer starting at buf to the file referred to by the file descriptor fd.

       The  number  of  bytes  written  may be less than count if, for example, there is insufficient space on the underlying physical medium, or the RLIMIT_FSIZE resource limit is encountered (see setrlimit(2)), or the call was interrupted by a signal handler after having written less than count bytes.  (See also pipe(7).)

       For a seekable file (i.e., one to which lseek(2) may be applied, for example, a regular file) writing takes place at the file offset, and the file offset is incremented by the number of bytes  actually  written.   If  the file was open(2)ed with O_APPEND, the file offset is first set to the end of the file before writing.  The adjustment of the file offset and the write operation are performed as an atomic step.

       POSIX requires that a read(2) that can be proved to occur after a write() has returned will return the new data.  Note that not all filesystems are POSIX conforming.

       According to POSIX.1, if count is greater than SSIZE_MAX, the result is implementation-defined; see NOTES for the upper limit on Linux.

RETURN VALUE
       On success, 【 the number of bytes written 】 is returned.  On error, 【 -1 】 is returned, and errno is set to indicate the cause of the error.

       Note that a successful write() may transfer fewer than count bytes.  Such partial writes can occur for various reasons; for example, because there was insufficient space  on  the  disk  device  to write all of the requested bytes, or because a blocked write() to a socket, pipe, or similar was interrupted by a signal handler after it had transferred some, but before it had transferred all of the requested bytes.  In the event of a partial write, the caller can make another write() call to transfer the remaining bytes.  The subsequent call will either transfer further bytes or may  result in an error (e.g., if the disk is now full).

       If  count is zero and fd refers to a regular file, then write() may return a failure status if one of the errors below is detected.  If no errors are detected, or error detection is not performed, 0 will be returned without causing any other effect.  If count is zero and fd refers to a file other than a regular file, the results are not specified.
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="测试代码-（文件拷贝）"><a href="#测试代码-（文件拷贝）" class="headerlink" title="测试代码 （文件拷贝）"></a>测试代码 （文件拷贝）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token number">1</span>	#include <span class="token operator">&lt;</span>unistd<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
 <span class="token number">2</span> #include <span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
 <span class="token number">3</span> #include <span class="token operator">&lt;</span>sys<span class="token operator">/</span>types<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
 <span class="token number">4</span> #include <span class="token operator">&lt;</span>sys<span class="token operator">/</span>stat<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
 <span class="token number">5</span> #include <span class="token operator">&lt;</span>fcntl<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
 <span class="token number">6</span>
 <span class="token number">7</span>
 <span class="token number">8</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token number">9</span> <span class="token punctuation">{</span>
<span class="token number">10</span>
<span class="token number">11</span>     <span class="token comment">// 1. open ---&gt; 打开源文件</span>
<span class="token number">12</span>     <span class="token keyword">int</span> srcfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"english.txt"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span>
<span class="token number">14</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>srcfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">15</span>     <span class="token punctuation">{</span>
<span class="token number">16</span>         <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">17</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">18</span>     <span class="token punctuation">}</span>
<span class="token number">19</span>
<span class="token number">20</span>
<span class="token number">21</span>     <span class="token comment">// 2. 创建一个新的目标文件</span>
<span class="token number">22</span>     <span class="token keyword">int</span> destfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"newEnglish.txt"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">23</span>
<span class="token number">24</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>destfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">25</span>     <span class="token punctuation">{</span>
<span class="token number">26</span>         <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">27</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">28</span>     <span class="token punctuation">}</span>
<span class="token number">29</span>
<span class="token number">30</span>
<span class="token number">31</span>     <span class="token comment">// 3. 频繁的读写操作</span>
<span class="token number">32</span>     <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">33</span>
<span class="token number">34</span>     <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">35</span>     <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>srcfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">36</span>         <span class="token function">write</span><span class="token punctuation">(</span>destfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">37</span>
<span class="token number">38</span>
<span class="token number">39</span>     <span class="token comment">// 4. 关闭文件</span>
<span class="token number">40</span>     <span class="token function">close</span><span class="token punctuation">(</span>srcfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">41</span>     <span class="token function">close</span><span class="token punctuation">(</span>destfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">42</span>
<span class="token number">43</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">44</span>
<span class="token number">45</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4-3-lseek"><a href="#4-3-lseek" class="headerlink" title="4.3 lseek"></a>4.3 lseek</h3><h5 id="关于C库-fseek-和Linux系统下-lseek-的man"><a href="#关于C库-fseek-和Linux系统下-lseek-的man" class="headerlink" title="关于C库 fseek 和Linux系统下 lseek 的man"></a>关于C库 <code>fseek</code> 和Linux系统下 <code>lseek</code> 的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*

// fseek
NAME
       fgetpos, fseek, fsetpos, ftell, rewind - reposition a stream

SYNOPSIS
       #include &lt;stdio.h&gt;

       int fseek(FILE *stream, long offset, int whence);

       long ftell(FILE *stream);

       void rewind(FILE *stream);

       int fgetpos(FILE *stream, fpos_t *pos);

       int fsetpos(FILE *stream, const fpos_t *pos);

DESCRIPTION
       The  fseek() function sets the file position indicator for the stream pointed to by stream.  The new position, measured in bytes, is obtained by 【 adding offset bytes to the position specified by whence 】.  If whence is set to SEEK_SET, SEEK_CUR, or SEEK_END,  the  offset is relative to the start of the file, the current position indicator, or end-of-file, respectively.
       A successful call to the fseek() function clears the end-of-file indicator for the stream and undoes any  effects  of  the ungetc(3) function on the same stream.

       The ftell() function obtains the current value of the file position indicator for the stream pointed to by stream.

       The  rewind()  function sets the file position indicator for the stream pointed to by stream to the beginning of the file. It is equivalent to:

              (void) fseek(stream, 0L, SEEK_SET)
              
 except that the error indicator for the stream is also cleared (see clearerr(3)).

       The fgetpos() and fsetpos() functions are alternate interfaces equivalent to ftell()  and  fseek()  (with  whence  set  to SEEK_SET),  setting  and  storing the current value of the file offset into or from the object referenced by pos.  On some non-UNIX systems, an fpos_t object may be a complex object and these routines may be the only way to portably reposition a text stream.

RETURN VALUE
       The  rewind()  function returns no value.  Upon successful completion, fgetpos(), fseek(), fsetpos() return 0, and ftell() returns the current offset.  Otherwise, -1 is returned and errno is set to indicate the error.
       
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*

// lseek
NAME
       lseek - reposition read/write file offset

SYNOPSIS
       #include &lt;sys/types.h&gt;
       #include &lt;unistd.h&gt;

       off_t lseek(int fd, off_t offset, int whence);
       
       参数：
       fd: 文件描述符，通过open()得到
       offset: 偏移量
       whence: 
       		SEEK_SET: 设置文件指针的偏移量
       		SEEK_CUR: 设置偏移量， 当前位置 + offset
       		SEEK_END: 设置偏移量， 文件大小 + offset
       

DESCRIPTION
       lseek()  【 repositions  the  file offset of the open file description 】 associated with the file descriptor fd to the argument offset according to the directive whence as follows:

       SEEK_SET
              The file offset is set to 【 （begin） + offset bytes 】.

       SEEK_CUR
              The file offset is set to its 【 current location 】 plus 【 offset bytes 】.

       SEEK_END
              The file offset is set to 【 the size of the file 】 plus 【 offset bytes 】.

       lseek() allows the file offset to be set beyond the end of the file (but this does not change the size of the  file).   If data  is  later  written  at this point, subsequent reads of the data in the gap (a "hole") return null bytes ('\0') until data is actually written into the gap.
       
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5><ul>
<li><ol>
<li><p>移动文件指针到【头文件】位置，不然要关闭文件再打开，重新运行了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
</li>
<li><ol start="2">
<li><p>获取当前文件的位置</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_CUR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
</li>
<li><ol start="3">
<li><p>获取文件大小</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
</li>
<li><ol start="4">
<li><p>拓展文件长度</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 如果当前文件10b, 扩展后为110b</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h5 id="测试代码-获取当前指针位置"><a href="#测试代码-获取当前指针位置" class="headerlink" title="测试代码 (获取当前指针位置)"></a>测试代码 (获取当前指针位置)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 扩展文件长度</span>
    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_CUR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"lseek : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> res2 <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_CUR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                                           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件指针刚开始在 %d byte 处， 目前在 %d byte 处\n"</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> res2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// output: 文件指针刚开始在 0 byte 处， 目前在 32 byte 处</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="测试代码-拓展文件长度"><a href="#测试代码-拓展文件长度" class="headerlink" title="测试代码 (拓展文件长度)"></a>测试代码 (拓展文件长度)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>	<span class="token comment">// 宏</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span>	<span class="token comment">// 宏</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span>		<span class="token comment">// open</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span>		<span class="token comment">// lseek</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>		<span class="token comment">// perror / close</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 扩展文件长度</span>
    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"lseek : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写入空串</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>假如原先的 <code>a.txt</code> 里面有6个byte, 这么一扩展，文件变成了6 + 1 + 100个byte</p>
</blockquote>
</li>
</ul>
<h5 id="为什么要扩展文件大小？"><a href="#为什么要扩展文件大小？" class="headerlink" title="为什么要扩展文件大小？"></a>为什么要扩展文件大小？</h5><p>例如，在下载文件时，这个文件有5G大，慢慢下载的过程中发现空间不够了就出大问题了。因而，在下载之前就先占用5G的空间，下载的过程中慢慢往里面写数据，可以保证磁盘空间一定够用。</p>
<h3 id="4-4-stat-amp-lstat"><a href="#4-4-stat-amp-lstat" class="headerlink" title="4.4 stat &amp; lstat"></a>4.4 stat &amp; lstat</h3><h5 id="stat的man"><a href="#stat的man" class="headerlink" title="stat的man"></a>stat的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/*
NAME
       stat, fstat, lstat, fstatat - get file status

SYNOPSIS
       #include &lt;sys/types.h&gt;
       #include &lt;sys/stat.h&gt;
       #include &lt;unistd.h&gt;

       int stat(const char *pathname, struct stat *statbuf);
       参数：
       		pathname 文件路径
       		statbuf 是一个传出参数，用于保存或得到的文件信息
       RETURN VALUE
           On success, zero is returned.  
           On error, -1 is returned, and errno is set appropriately.

DESCRIPTION
       These functions 【 return information about a file 】, in the buffer pointed to by statbuf.  No permissions are required  on  the  file  itself,  but in  the  case  of  stat(),  fstatat(),  and lstat()—execute  (search)  permission  is  required on all of the directories in pathname that lead to the file.

       stat() and fstatat() retrieve information about the file pointed to by pathname;  the  differences for fstatat() are described below.
       
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="lstat的man"><a href="#lstat的man" class="headerlink" title="lstat的man"></a>lstat的man</h5><p>lstat 单纯用来获取 <code>软链接类型</code> 文件本身的信息</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*

int lstat(const char *pathname, struct stat *statbuf);

lstat()  is  identical  to stat(), except that if pathname is a 【 symbolic link 】, then it returns information about 【 the link itself, not the file that it refers to 】.

*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="struct-stat-这个传出参数里是什么？"><a href="#struct-stat-这个传出参数里是什么？" class="headerlink" title="struct stat 这个传出参数里是什么？"></a><code>struct stat</code> 这个传出参数里是什么？</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// The stat structure</span>
       <span class="token comment">// All of these system calls return a stat structure, which contains the following fields:</span>

           <span class="token keyword">struct</span> <span class="token class-name">stat</span> <span class="token punctuation">{</span>
               <span class="token class-name">dev_t</span>     st_dev<span class="token punctuation">;</span>         <span class="token comment">/* ID of device containing file */</span>
               <span class="token class-name">ino_t</span>     st_ino<span class="token punctuation">;</span>         <span class="token comment">/* Inode number */</span>
               <span class="token class-name">mode_t</span>    st_mode<span class="token punctuation">;</span>        <span class="token comment">/* File type and mode */</span>
               <span class="token class-name">nlink_t</span>   st_nlink<span class="token punctuation">;</span>       <span class="token comment">/* Number of hard links */</span>
               <span class="token class-name">uid_t</span>     st_uid<span class="token punctuation">;</span>         <span class="token comment">/* User ID of owner */</span>
               <span class="token class-name">gid_t</span>     st_gid<span class="token punctuation">;</span>         <span class="token comment">/* Group ID of owner */</span>
               <span class="token class-name">dev_t</span>     st_rdev<span class="token punctuation">;</span>        <span class="token comment">/* Device ID (if special file) */</span>
               <span class="token class-name">off_t</span>     st_size<span class="token punctuation">;</span>        <span class="token comment">/* Total size, in bytes */</span>
               <span class="token class-name">blksize_t</span> st_blksize<span class="token punctuation">;</span>     <span class="token comment">/* Block size for filesystem I/O */</span>
               <span class="token class-name">blkcnt_t</span>  st_blocks<span class="token punctuation">;</span>      <span class="token comment">/* Number of 512B blocks allocated */</span>

               <span class="token comment">/* Since Linux 2.6, the kernel supports nanosecond
                  precision for the following timestamp fields.
                  For the details before Linux 2.6, see NOTES. */</span>

               <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_atim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last access */</span>
               <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_mtim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last modification */</span>
               <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_ctim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last status change */</span>

           <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">st_atime</span> <span class="token expression">st_atim<span class="token punctuation">.</span>tv_sec      </span><span class="token comment">/* Backward compatibility */</span></span>
           <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">st_mtime</span> <span class="token expression">st_mtim<span class="token punctuation">.</span>tv_sec</span></span>
           <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">st_ctime</span> <span class="token expression">st_ctim<span class="token punctuation">.</span>tv_sec</span></span>
           <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="shell-中的-stat命令"><a href="#shell-中的-stat命令" class="headerlink" title="shell 中的 stat命令"></a>shell 中的 <code>stat命令</code></h5><p>在shell中使用 <code>stat filename</code> 可以查看一个文件的信息。</p>
<p>内容为 HELLO, WORLD!</p>
<p><img src="https://img-blog.csdnimg.cn/50605a172fa245479555011d1cb0c183.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p><img src="https://img-blog.csdnimg.cn/fc4732e0a51f4d54b69f6c868539080d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>判断一个文件对于三种用户是否可读可写可执行 —&gt; st_mode &amp; 对应的宏值</p>
<p>判断是什么类型 —&gt; (st_mode &amp; S_IMFT) == 对应的宏   （其中， S_IMFT == 0170000）</p>
<p>普通文件 <code>0664</code>，最高权限 <code>0777</code>(但是会被 <code>umask</code> 抹去一些权限)</p>
<h5 id="stat-测试代码-获取文件大小"><a href="#stat-测试代码-获取文件大小" class="headerlink" title="stat 测试代码 (获取文件大小)"></a>stat 测试代码 (获取文件大小)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">stat</span> statbuf<span class="token punctuation">;</span>

    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"stat : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size : %ld\n"</span><span class="token punctuation">,</span> statbuf<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="测试代码-判断一个文件对于usr的权限"><a href="#测试代码-判断一个文件对于usr的权限" class="headerlink" title="测试代码 (判断一个文件对于usr的权限)"></a>测试代码 (判断一个文件对于usr的权限)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">stat</span> statbuf<span class="token punctuation">;</span>

    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"stat : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"该文件对于当前用户是否可写可读可执行？: %o\n"</span><span class="token punctuation">,</span> statbuf<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IRWXU<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/92af7771d9d6469190dc816df40a68fa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="关于软链接的man"><a href="#关于软链接的man" class="headerlink" title="关于软链接的man"></a>关于软链接的man</h5><p><img src="https://img-blog.csdnimg.cn/9c01c663280747bca86bd5c9aeeaab66.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p>使用 <code>ln -s filename1 filename2</code> 可以创建一个软链接， filename2 -&gt; filename1</p>
<p>两个文件打开是同样的内容。</p>
<p>因此如果用 stat 来获取软链接的信息，则会获取其主人的信息；</p>
<p>若用 lstat 则会获取软链接的信息。</p>
<p><img src="https://img-blog.csdnimg.cn/c71afa0eb57143f7968a590f315f72e7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p><img src="https://img-blog.csdnimg.cn/f215916ec47949888754a1dfef966236.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p><img src="https://img-blog.csdnimg.cn/987061f877f44b60a123a5b24b394c3b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="lstat-测试代码"><a href="#lstat-测试代码" class="headerlink" title="lstat 测试代码"></a>lstat 测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">stat</span> statbuf<span class="token punctuation">;</span>

    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">lstat</span><span class="token punctuation">(</span><span class="token string">"b.txt"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 只是函数名从普通的 stat 变成了获取软链接文件信息的 lstat</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"stat : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size : %ld\n"</span><span class="token punctuation">,</span> statbuf<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4-5-模拟实现-ls-l-命令"><a href="#4-5-模拟实现-ls-l-命令" class="headerlink" title="4.5 模拟实现 ls -l 命令"></a>4.5 模拟实现 <code>ls -l</code> 命令</h3><h5 id="关于-getpwuid-函数"><a href="#关于-getpwuid-函数" class="headerlink" title="关于 getpwuid() 函数"></a>关于 <code>getpwuid()</code> 函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*

NAME
       getpwuid

SYNOPSIS
       #include &lt;sys/types.h&gt;
       #include &lt;pwd.h&gt;

       struct passwd *getpwuid(uid_t uid);

   Feature Test Macro Requirements for glibc (see feature_test_macros(7)):

DESCRIPTION

       The  getpwuid() function returns a pointer to a structure containing the broken-out fields of
       【 the record in the password database 】 that matches the user ID uid.

       The passwd structure is defined in &lt;pwd.h&gt; as follows:

           struct passwd {
               char   *pw_name;       /* username */</span>
               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_passwd<span class="token punctuation">;</span>     <span class="token comment">/* user password */</span>
               <span class="token class-name">uid_t</span>   pw_uid<span class="token punctuation">;</span>        <span class="token comment">/* user ID */</span>
               <span class="token class-name">gid_t</span>   pw_gid<span class="token punctuation">;</span>        <span class="token comment">/* group ID */</span>
               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_gecos<span class="token punctuation">;</span>      <span class="token comment">/* user information */</span>
               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_dir<span class="token punctuation">;</span>        <span class="token comment">/* home directory */</span>
               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_shell<span class="token punctuation">;</span>      <span class="token comment">/* shell program */</span>
           <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">*</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="关于-getgrgid-函数"><a href="#关于-getgrgid-函数" class="headerlink" title="关于 getgrgid() 函数"></a>关于 <code>getgrgid() </code>函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*

NAME
       getgrgid

SYNOPSIS
       #include &lt;sys/types.h&gt;
       #include &lt;grp.h&gt;

       struct group *getgrgid(gid_t gid);

DESCRIPTION

       The  getgrgid() function returns a pointer to a structure containing the broken-out fields of
       【 the record in the group database 】 that matches the group ID gid.

       The group structure is defined in &lt;grp.h&gt; as follows:

           struct group {
               char   *gr_name;        /* group name */</span>
               <span class="token keyword">char</span>   <span class="token operator">*</span>gr_passwd<span class="token punctuation">;</span>      <span class="token comment">/* group password */</span>
               <span class="token class-name">gid_t</span>   gr_gid<span class="token punctuation">;</span>         <span class="token comment">/* group ID */</span>
               <span class="token keyword">char</span>  <span class="token operator">*</span><span class="token operator">*</span>gr_mem<span class="token punctuation">;</span>         <span class="token comment">/* NULL-terminated array of pointers
                                          to names of group members */</span>
           <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">*</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4-6-文件属性操作函数"><a href="#4-6-文件属性操作函数" class="headerlink" title="4.6 文件属性操作函数"></a>4.6 文件属性操作函数</h3><p><img src="https://img-blog.csdnimg.cn/c85e57c0c22f4063a7e93c9097127b97.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="access"><a href="#access" class="headerlink" title="access"></a>access</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
NAME
       access, faccessat - check user's permissions for a file

SYNOPSIS
       #include &lt;unistd.h&gt;

       int access(const char *pathname, int mode);

DESCRIPTION
       access() 【 checks whether the calling process can access the file pathname 】.  If pathname is a symbolic link, it is dereferenced.

       The  mode specifies 【 the accessibility check(s) to be performed 】, and is either the value F_OK, or a mask consisting of the bitwise OR of one or more of R_OK, W_OK, and X_OK.  【 F_OK 】 tests for the existence of the file. 【 R_OK 】, 【 W_OK 】, and 【 X_OK 】 test whether the file exists and grants read, write, and execute permissions, respectively.

       The check is done using the calling process's real UID and GID, rather than the effective IDs as is done when actually attempting an operation (e.g., open(2)) on the file.  Similarly, for the root user, the check uses the set of permitted capabilities rather than the set of effective capabilities; and for non-root users, the check uses an empty set of capabilities.

       This  allows  set-user-ID  programs  and capability-endowed programs to easily determine the invoking user's authority.  In other words, access() does not answer the "can I read/write/execute this file?" question.  It answers a slightly different question: "(assuming I'm a setuid binary) can the user who invoked me read/write/execute this file?", which gives set-user-ID programs the  possibility to prevent malicious users from causing them to read files which users shouldn't be able to read.

       If the calling process is privileged (i.e., its real UID is zero), then an X_OK check is successful for a regular file if execute permission is enabled for any of the file owner, group, or other.
       
RETURN VALUE
       On success (all requested permissions granted, or mode is F_OK and the file exists), 【 zero 】 is returned.  On error (at least one bit in mode asked for a permission that is denied, or  mode  is  F_OK and the file does not exist, or some other error occurred), 【 -1 】 is returned, and errno is set appropriately.
       
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"access"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"file exists!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//（第三人称单数）</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a>chmod</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*

NAME
       chmod, fchmod, fchmodat - change permissions of a file

SYNOPSIS
       #include &lt;sys/stat.h&gt;

       int chmod(const char *pathname, mode_t mode);
       
DESCRIPTION
       The  chmod() and fchmod() system calls 【change a files mode bits】.  (The file mode consists of the file permission bits plus the set-user-ID, set-group-ID, and sticky bits.)  These system calls differ only in how the file is specified:

       * chmod() changes the mode of the file specified whose pathname is given in pathname, which is dereferenced if it is a symbolic link.

*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="测试代码-3"><a href="#测试代码-3" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token number">0775</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"chmod"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"change mode successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://img-blog.csdnimg.cn/cbf926df87d24d35987825480fb47ff6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="chown"><a href="#chown" class="headerlink" title="chown"></a>chown</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
NAME
       chown, fchown, lchown, fchownat - change ownership of a file

SYNOPSIS
       #include &lt;unistd.h&gt;

       int chown(const char *pathname, uid_t owner, gid_t group);

DESCRIPTION
       These  system calls 【change the owner and group】 of a file.  The chown(), fchown(), and lchown() system calls differ only in how the file is specified:

       * chown() changes the ownership of the file specified by pathname, which is dereferenced if it is a symbolic link.

       Only a privileged process (Linux: one with the CAP_CHOWN capability) may change the owner of a file.  The owner of a  file
       may  change  the  group  of  the  file  to  any  group of which that owner is a member.  A privileged process (Linux: with
       CAP_CHOWN) may change the group arbitrarily.

       If the owner or group is specified as -1, then that ID is not changed.

       When the owner or group of an executable file is changed by an unprivileged user, the S_ISUID and S_ISGID  mode  bits  are cleared.  POSIX does not specify whether this also should happen when root does the chown(); the Linux behavior depends on the kernel version, and since Linux 2.2.13, root is treated like other users.  In  case  of  a  non-group-executable  file (i.e.,  one  for  which  the  S_IXGRP bit is not set) the S_ISGID bit indicates mandatory locking, and is not cleared by a chown().

       When the owner or group of an executable file is changed (by any user), all capability sets for the file are cleared.
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>通过  <code>vim /etc/passwd</code> 可以查看该机器上的所有用户， <code>vim /etc/group</code> 可以查看所有的组。</p>
<p>通过 <code>useradd userName</code> 可以创建一个名为 userName 的新用户，可以用 <code>id userName</code> 查看该用户的uid,gid和group。</p>
<p><img src="https://img-blog.csdnimg.cn/2a258fe3cc904603b11160136e184799.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p><img src="https://img-blog.csdnimg.cn/2128a7806a3844e788ea4b4b314b6b31.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="测试代码-4"><a href="#测试代码-4" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">chown</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">1002</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 更改文件 a.txt 的uid &amp; gid</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"chown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"change uid and group successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://img-blog.csdnimg.cn/56666fd41a984da78b6abc3db806e087.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="truncate"><a href="#truncate" class="headerlink" title="truncate"></a>truncate</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME
       truncate<span class="token punctuation">,</span> ftruncate <span class="token operator">-</span> truncate a file to a specified length

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token class-name">off_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">int</span> <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

   Feature Test Macro Requirements <span class="token keyword">for</span> <span class="token function">glibc</span> <span class="token punctuation">(</span>see <span class="token function">feature_test_macros</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span>

       <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
           _XOPEN_SOURCE <span class="token operator">&gt;=</span> <span class="token number">500</span>
               <span class="token operator">||</span> <span class="token comment">/* Since glibc 2.12: */</span> _POSIX_C_SOURCE <span class="token operator">&gt;=</span> <span class="token number">200809L</span>
               <span class="token operator">||</span> <span class="token comment">/* Glibc versions &lt;= 2.19: */</span> _BSD_SOURCE

       <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
           _XOPEN_SOURCE <span class="token operator">&gt;=</span> <span class="token number">500</span>
               <span class="token operator">||</span> <span class="token comment">/* Since glibc 2.3.5: */</span> _POSIX_C_SOURCE <span class="token operator">&gt;=</span> <span class="token number">200112L</span>
               <span class="token operator">||</span> <span class="token comment">/* Glibc versions &lt;= 2.19: */</span> _BSD_SOURCE

DESCRIPTION
       The  <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  and  <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  functions cause the regular file named by path or referenced by fd to 【be truncated to a size of precisely length bytes】<span class="token punctuation">.</span>

       If the file previously was larger than this size<span class="token punctuation">,</span> the extra data is lost<span class="token punctuation">.</span> 
               <span class="token comment">// 大变小 ---&gt; 截断</span>
               
	   If the file previously was shorter<span class="token punctuation">,</span> it is  extended<span class="token punctuation">,</span> and the extended part reads as null <span class="token function">bytes</span> <span class="token punctuation">(</span><span class="token char">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
               <span class="token comment">// 小变大 ---&gt; '\0'填充</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="测试代码-5"><a href="#测试代码-5" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>		<span class="token comment">// perror</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span>		<span class="token comment">// atoi()</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">truncate</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"truncate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"truncate the file %s to %s bytes successfully!\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://img-blog.csdnimg.cn/00f304b3d35e4eb182a3f1a47efe8471.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h3 id="4-7-目录操作函数"><a href="#4-7-目录操作函数" class="headerlink" title="4.7 目录操作函数"></a>4.7 目录操作函数</h3><p><img src="https://img-blog.csdnimg.cn/7f04549c167645a78739282ec94bc75c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME
       mkdir<span class="token punctuation">,</span> mkdirat <span class="token operator">-</span> create a directory

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
       
DESCRIPTION
       <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> attempts to 【create a directory】 named pathname<span class="token punctuation">.</span>

       The  argument  mode  specifies the mode <span class="token keyword">for</span> the new directory<span class="token punctuation">.</span>  It is modified by the process's umask in the usual way<span class="token operator">:</span> in the absence of a <span class="token keyword">default</span> ACL<span class="token punctuation">,</span> the mode of the created directory <span class="token function">is</span> <span class="token punctuation">(</span>【mode <span class="token operator">&amp;</span> <span class="token operator">~</span>umask <span class="token operator">&amp;</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">.</span>   
       Whether  other  mode bits are honored <span class="token keyword">for</span> the created directory depends on the operating system<span class="token punctuation">.</span>

       The newly created directory will be owned by the effective user ID of the process<span class="token punctuation">.</span>  If the directory  containing  the file has the set<span class="token operator">-</span>group<span class="token operator">-</span>ID bit set<span class="token punctuation">,</span> or <span class="token keyword">if</span> the filesystem is mounted with BSD group <span class="token function">semantics</span> <span class="token punctuation">(</span>mount <span class="token operator">-</span>o grpid<span class="token punctuation">)</span><span class="token punctuation">,</span> the new directory will inherit the group ownership from  its  parent<span class="token punctuation">;</span> otherwise it will be owned by the effective group ID of the process<span class="token punctuation">.</span>

       If the parent directory has the set<span class="token operator">-</span>group<span class="token operator">-</span>ID bit set<span class="token punctuation">,</span> then so will the newly created directory<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="测试代码-6"><a href="#测试代码-6" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">mkdir</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// argv[1]是文件名，0664是文件的权限</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkdir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"make a directory '%s' successfully!\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://img-blog.csdnimg.cn/0ab1c3a42d9246d5bd2e77eac4c93dcb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="rename"><a href="#rename" class="headerlink" title="rename"></a>rename</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME
       rename<span class="token punctuation">,</span> renameat<span class="token punctuation">,</span> renameat2 <span class="token operator">-</span> change the name or location of a file

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>oldpath<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>newpath<span class="token punctuation">)</span><span class="token punctuation">;</span>

DESCRIPTION
       <span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  renames  a  file<span class="token punctuation">,</span> moving it between directories <span class="token keyword">if</span> required<span class="token punctuation">.</span>  Any other  【hard links】 to the file  are 【unaffected】<span class="token punctuation">.</span>  【Open file descriptors <span class="token keyword">for</span> oldpath】 are also 【unaffected】<span class="token punctuation">.</span>

       Various restrictions determine whether or not the rename operation succeeds<span class="token operator">:</span> see ERRORS below<span class="token punctuation">.</span>

       If newpath already exists<span class="token punctuation">,</span> it will be atomically replaced<span class="token punctuation">,</span> so that there is no point at which another  process  attempting to  access newpath will find it missing<span class="token punctuation">.</span>  However<span class="token punctuation">,</span> there will probably be a window in which both oldpath and newpath refer to the file being renamed<span class="token punctuation">.</span>

       If oldpath and newpath are existing hard links referring to the same file<span class="token punctuation">,</span> then <span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span> does nothing<span class="token punctuation">,</span> and returns a  success status<span class="token punctuation">.</span>

       If newpath exists but the operation fails <span class="token keyword">for</span> some reason<span class="token punctuation">,</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span> guarantees to leave an instance of newpath in place<span class="token punctuation">.</span>

       oldpath can specify a directory<span class="token punctuation">.</span>  In this <span class="token keyword">case</span><span class="token punctuation">,</span> newpath must either not exist<span class="token punctuation">,</span> or it must specify an empty directory<span class="token punctuation">.</span>

       If  oldpath  refers  to a symbolic link<span class="token punctuation">,</span> the link is renamed<span class="token punctuation">;</span> <span class="token keyword">if</span> newpath refers to a symbolic link<span class="token punctuation">,</span> the link will be overwritten<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="测试代码-7"><a href="#测试代码-7" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">"987"</span><span class="token punctuation">,</span> <span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"rename"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/9224a038315a424086f9188ed2608221.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="rmdir"><a href="#rmdir" class="headerlink" title="rmdir"></a>rmdir</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME
       rmdir <span class="token operator">-</span> delete a directory

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>

DESCRIPTION
       <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> deletes a directory<span class="token punctuation">,</span> which 【must be empty】<span class="token punctuation">.</span>

RETURN VALUE
       On success<span class="token punctuation">,</span> zero is returned<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="测试代码-8"><a href="#测试代码-8" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.hz&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"rmdir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://img-blog.csdnimg.cn/37687eff84034a51aa78cd6a00b9f5e5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h5 id="getcwd"><a href="#getcwd" class="headerlink" title="getcwd"></a>getcwd</h5><p>获取当前工作目录。</p>
<ul>
<li><p>buf：传出参数，指向一个数组，存工作路径</p>
</li>
<li><p>size：数组大小</p>
</li>
<li><p>return value：指针，指向一块内存，存的是工作路径，内容和buf一样</p>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME
       getcwd<span class="token punctuation">,</span> getwd<span class="token punctuation">,</span> get_current_dir_name <span class="token operator">-</span> get current working directory

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

       <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getwd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">get_current_dir_name</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


DESCRIPTION
       These  functions  <span class="token keyword">return</span> a null<span class="token operator">-</span>terminated string containing 【an absolute pathname】 that is the current working directory of the calling process<span class="token punctuation">.</span>  The pathname is returned as the function 【result】 and via the argument 【buf】<span class="token punctuation">,</span> <span class="token keyword">if</span> present<span class="token punctuation">.</span>

       The <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function copies an absolute pathname of the current working directory to the array pointed to by  buf<span class="token punctuation">,</span>  which is of length size<span class="token punctuation">.</span>

       If the length of the absolute pathname of the current working directory<span class="token punctuation">,</span> including the terminating null byte<span class="token punctuation">,</span> exceeds size bytes<span class="token punctuation">,</span> <span class="token constant">NULL</span> is returned<span class="token punctuation">,</span> and errno is set to ERANGE<span class="token punctuation">;</span> an application should check <span class="token keyword">for</span> this error<span class="token punctuation">,</span>  and  allocate  a  larger buffer <span class="token keyword">if</span> necessary<span class="token punctuation">.</span>

       As  an extension to the POSIX<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">2001</span> standard<span class="token punctuation">,</span> glibc's <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> allocates the buffer dynamically using <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">if</span> buf is <span class="token constant">NULL</span><span class="token punctuation">.</span>  In this <span class="token keyword">case</span><span class="token punctuation">,</span> the allocated buffer has the length size unless size is zero<span class="token punctuation">,</span> when buf is allocated as big as  necessary<span class="token punctuation">.</span>  The caller should <span class="token function">free</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> the returned buffer<span class="token punctuation">.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="测试代码-9"><a href="#测试代码-9" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ret <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"getcwd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current working directory is : \n%s\n or \n%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://img-blog.csdnimg.cn/2c2e5de7e03a4a4d884b51d687373521.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h5 id="chdir"><a href="#chdir" class="headerlink" title="chdir"></a>chdir</h5><p>修改进程的工作目录，在哪个目录启动进程，该进程就默认工作在该目录下。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME
       chdir<span class="token punctuation">,</span> fchdir <span class="token operator">-</span> change working directory

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">int</span> <span class="token function">fchdir</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

DESCRIPTION
       <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 【changes the current working directory】 of 【the calling process】 to the directory specified in path<span class="token punctuation">.</span>

       <span class="token function">fchdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is identical to <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> the only difference is that the directory is given as an open file descriptor<span class="token punctuation">.</span>

RETURN VALUE
       On success<span class="token punctuation">,</span> zero is returned<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="测试代码-10"><a href="#测试代码-10" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 获取该进程默认工作路径</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>path <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>path <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"getcwd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current working directory is : \n%s\n or \n%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更改工作目录</span>
    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">"/home/Sakana/Mydoc/serverlearn/IO/文件操作函数/ajacentDir/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"chdir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 获取新工作目录</span>
    <span class="token keyword">char</span> newbuf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>newPath <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>newbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>newbuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n*** change woring dir successfully! ***\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current working directory is : \n%s\n or \n%s\n"</span><span class="token punctuation">,</span> newbuf<span class="token punctuation">,</span> newPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 在新工作目录里写点东西</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"testFile.txt"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> pbuf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                                                                         <span class="token function">sprintf</span><span class="token punctuation">(</span>pbuf<span class="token punctuation">,</span> <span class="token string">"Hello, world! I'm form %s \n Here is %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> newPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> pbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pbuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://img-blog.csdnimg.cn/4ab1c16fa3b8469a947de470ddb74d12.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p><img src="https://img-blog.csdnimg.cn/3e736f67598743509ee62f230f0a9499.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p><img src="https://img-blog.csdnimg.cn/ca2f9844797f488dabc82e4dea0c0835.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h3 id="4-8-目录遍历函数"><a href="#4-8-目录遍历函数" class="headerlink" title="4.8 目录遍历函数"></a>4.8 目录遍历函数</h3><p><img src="https://img-blog.csdnimg.cn/49c68acc32d34de8a79a88b12615b490.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="opendir"><a href="#opendir" class="headerlink" title="opendir"></a>opendir</h5><ul>
<li>name：需要打开的目录名称</li>
<li>return value: <ul>
<li>正确：<code>DIR*</code>  类型的结构体，可以理解为目录流</li>
<li>错误：NULL</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME
       opendir<span class="token punctuation">,</span> fdopendir <span class="token operator">-</span> open a directory

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>

       DIR <span class="token operator">*</span><span class="token function">opendir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
       DIR <span class="token operator">*</span><span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

DESCRIPTION
       The  <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  function 【opens a directory stream】 corresponding to the directory name<span class="token punctuation">,</span> and 【returns a pointer】 to the directory stream<span class="token punctuation">.</span>  The stream is positioned at the first entry in the directory<span class="token punctuation">.</span>

       The <span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function is like <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> but returns a directory stream <span class="token keyword">for</span> the directory referred to by the 【open file descriptor fd】<span class="token punctuation">.</span>  After a successful call to <span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fd is used internally by the implementation<span class="token punctuation">,</span> and should not otherwise be used by the application<span class="token punctuation">.</span>

RETURN VALUE
       The <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> and <span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> functions <span class="token keyword">return</span> a pointer to the directory stream<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token constant">NULL</span> is returned<span class="token punctuation">,</span>  and  errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="DIR-结构体"><a href="#DIR-结构体" class="headerlink" title="DIR 结构体"></a>DIR 结构体</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">__dirstream</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>__fd<span class="token punctuation">;</span> <span class="token comment">/* `struct hurd_fd' pointer for descriptor.   */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>__data<span class="token punctuation">;</span> <span class="token comment">/* Directory block.   */</span>
    <span class="token keyword">int</span> __entry_data<span class="token punctuation">;</span> <span class="token comment">/* Entry number `__data' corresponds to.   */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>__ptr<span class="token punctuation">;</span> <span class="token comment">/* Current pointer into the block.   */</span>
    <span class="token keyword">int</span> __entry_ptr<span class="token punctuation">;</span> <span class="token comment">/* Entry number `__ptr' corresponds to.   */</span>
    <span class="token class-name">size_t</span> __allocation<span class="token punctuation">;</span> <span class="token comment">/* Space allocated for the block.   */</span>
    <span class="token class-name">size_t</span> __size<span class="token punctuation">;</span> <span class="token comment">/* Total valid data in the block.   */</span>
    <span class="token function">__libc_lock_define</span> <span class="token punctuation">(</span><span class="token punctuation">,</span> __lock<span class="token punctuation">)</span> <span class="token comment">/* Mutex lock for this structure.   */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">__dirstream</span> DIR<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="readdir"><a href="#readdir" class="headerlink" title="readdir"></a>readdir</h5><p>读取目录中的数据，调用一次，就指向流中的下一个实体</p>
<ul>
<li>dirp:  <code>opendir函数</code> 返回的 <code>DIR*</code> 类型的结构体</li>
<li>return value: <ul>
<li>正确：<ul>
<li>未到末尾：<code>struct dirent</code>类型的结构体，存储读到的文件信息</li>
<li>末尾：NULL</li>
</ul>
</li>
<li>错误：NULL</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME
       readdir <span class="token operator">-</span> read a directory

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>

       <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span><span class="token function">readdir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>

DESCRIPTION
       The  <span class="token function">readdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  function  returns a pointer to a dirent structure representing the next directory entry in the directory stream pointed to by dirp<span class="token punctuation">.</span>  It returns <span class="token constant">NULL</span> on reaching the end of the directory stream or <span class="token keyword">if</span> an error occurred<span class="token punctuation">.</span>

       In the glibc implementation<span class="token punctuation">,</span> the dirent structure is defined as follows<span class="token operator">:</span>

           <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token punctuation">{</span>
               <span class="token class-name">ino_t</span>          d_ino<span class="token punctuation">;</span>       <span class="token comment">/* Inode number */</span>
               <span class="token class-name">off_t</span>          d_off<span class="token punctuation">;</span>       <span class="token comment">/* Not an offset; see below */</span>
               <span class="token keyword">unsigned</span> <span class="token keyword">short</span> d_reclen<span class="token punctuation">;</span>    <span class="token comment">/* Length of this record */</span>
               <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  d_type<span class="token punctuation">;</span>      <span class="token comment">/* Type of file; not supported
                                              by all filesystem types */</span>
               <span class="token keyword">char</span>           d_name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Null-terminated filename */</span>
           <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://img-blog.csdnimg.cn/1e6528686aa04ffb8ad7d40e58475dbd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<h5 id="closedir"><a href="#closedir" class="headerlink" title="closedir"></a>closedir</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME
       closedir <span class="token operator">-</span> close a directory

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">closedir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>

DESCRIPTION
       The <span class="token function">closedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function closes the directory stream associated with dirp<span class="token punctuation">.</span>  A successful call to <span class="token function">closedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> also closes the underlying file descriptor associated with dirp<span class="token punctuation">.</span>  The directory stream descriptor dirp is not available after this call<span class="token punctuation">.</span>

RETURN VALUE
       The <span class="token function">closedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function returns <span class="token number">0</span> on success<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="测试代码-计算某个目录下文件的个数"><a href="#测试代码-计算某个目录下文件的个数" class="headerlink" title="测试代码 (计算某个目录下文件的个数)"></a>测试代码 (计算某个目录下文件的个数)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>


<span class="token keyword">int</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s pathname\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The total num of files is: %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1. 打开目录</span>
    DIR <span class="token operator">*</span>dir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dir <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"opendir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2.记录普通文件个数</span>
    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ptr <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 判断是否为. 或 ..</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果是目录，需要递归计算</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_type <span class="token operator">==</span> DT_DIR<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">char</span> newpath<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>newpath<span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cnt <span class="token operator">+=</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span>newpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果是普通文件，计算</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_type <span class="token operator">==</span> DT_REG<span class="token punctuation">)</span> <span class="token operator">++</span> cnt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3.关闭文件</span>
    <span class="token function">closedir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4-9-dup-amp-dup2-system-call"><a href="#4-9-dup-amp-dup2-system-call" class="headerlink" title="4.9 dup &amp; dup2 system call"></a>4.9 dup &amp; dup2 system call</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME
       dup<span class="token punctuation">,</span> dup2<span class="token punctuation">,</span> dup3 <span class="token operator">-</span> duplicate a file descriptor

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">int</span> <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span>             <span class="token comment">/* See feature_test_macros(7) */</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span>              <span class="token comment">/* Obtain O_* constant definitions */</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">dup3</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

DESCRIPTION
       The  <span class="token function">dup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  system call 【creates a copy of the file descriptor oldfd】<span class="token punctuation">,</span> using the 【lowest<span class="token operator">-</span>numbered】 unused file de‐
       scriptor <span class="token keyword">for</span> the new descriptor<span class="token punctuation">.</span>

       After a successful <span class="token keyword">return</span><span class="token punctuation">,</span> the old and new file descriptors may be used interchangeably<span class="token punctuation">.</span>  They  refer  to  the same open file description and thus share file offset and file status flags<span class="token punctuation">;</span> <span class="token keyword">for</span> example<span class="token punctuation">,</span> <span class="token keyword">if</span> the  file offset is modified by using <span class="token function">lseek</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> on one of the file descriptors<span class="token punctuation">,</span> the offset is also changed  <span class="token keyword">for</span>  the other<span class="token punctuation">.</span>

       The  two file descriptors <span class="token keyword">do</span> not share file descriptor <span class="token function">flags</span> <span class="token punctuation">(</span>the close<span class="token operator">-</span>on<span class="token operator">-</span>exec flag<span class="token punctuation">)</span><span class="token punctuation">.</span>  The close<span class="token operator">-</span>on<span class="token operator">-</span>exec <span class="token function">flag</span> <span class="token punctuation">(</span>FD_CLOEXEC<span class="token punctuation">;</span> see <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> the duplicate descriptor is off<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="dup"><a href="#dup" class="headerlink" title="dup"></a>dup</h5><p>复制文件描述符</p>
<p>从空闲的文件描述符中找一个新的作为新的文件描述符</p>
<p>和旧的一起指向同一个文件</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="测试代码-11"><a href="#测试代码-11" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 创建一个文件描述符</span>
    <span class="token keyword">int</span> oldFd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>oldFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 拷贝文件描述符 oldFd -&gt; newFd</span>
    <span class="token keyword">int</span> newFd <span class="token operator">=</span> <span class="token function">dup</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"oldFd: %d, newFd: %d\n"</span><span class="token punctuation">,</span> oldFd<span class="token punctuation">,</span> newFd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭旧的文件描述符</span>
    <span class="token function">close</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 新的仍然可以操作这个文件</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, World!\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>newFd<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>newFd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/e9f6ca0932a64e6eb25fb1aaf35b5d73.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==">可以发现两个不同的文件描述符 3，4 指向的是同一个文件。</p>
<h5 id="dup2"><a href="#dup2" class="headerlink" title="dup2"></a>dup2</h5><p>重定向文件描述符</p>
<p>oldfd 指向 a.txt, newfd 指向 b.txt</p>
<p>调用dup2之后，相当于(close, newfd, b.txt), newfd指向a.txt</p>
<p>oldfd == newfd，相当于什么都没做</p>
<p>对于返回值没必要close, newfd 和 return value相同，如果成功。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="测试代码-12"><a href="#测试代码-12" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                                                                           <span class="token punctuation">{</span>
    <span class="token keyword">int</span> oldFd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>oldFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> newFd <span class="token operator">=</span> <span class="token function">dup2</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"oldFd: %d, newFd: %d\n"</span><span class="token punctuation">,</span> oldFd<span class="token punctuation">,</span> newFd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, World!\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4-10-fcntl"><a href="#4-10-fcntl" class="headerlink" title="4.10 fcntl"></a>4.10 fcntl</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME
       fcntl <span class="token operator">-</span> manipulate file descriptor

SYNOPSIS
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

       <span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

DESCRIPTION
       <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  performs  one of the operations described below on the open file descriptor fd<span class="token punctuation">.</span>  The operation is determined by cmd<span class="token punctuation">.</span>

       <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> can take an optional third argument<span class="token punctuation">.</span>  Whether or not this argument is required is determined  by  cmd<span class="token punctuation">.</span> The  required  argument type is indicated in parentheses after each cmd <span class="token function">name</span> <span class="token punctuation">(</span>in most cases<span class="token punctuation">,</span> the required type is <span class="token keyword">int</span><span class="token punctuation">,</span> and we identify the argument using the name arg<span class="token punctuation">)</span><span class="token punctuation">,</span> or <span class="token keyword">void</span> is specified <span class="token keyword">if</span>  the  argument  is  not  required<span class="token punctuation">.</span>

       Certain  of  the  operations  below are supported only since a particular Linux kernel version<span class="token punctuation">.</span>  The preferred method of checking whether the host kernel supports a particular operation is to invoke <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> with  the  desired  cmd value and then test whether the call failed with EINVAL<span class="token punctuation">,</span> indicating that the kernel does not recognize this value<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>fd：文件描述符</li>
<li>cmd：命令（宏）<ul>
<li>F_DUPFD (int)<ul>
<li><p>复制文件描述符，复制第一个参数fd并通过return value返回新的文件描述符</p>
</li>
<li><p>用法：newfd = fcntl (fd, F_DUPFD);</p>
</li>
</ul>
</li>
<li>F_GETFL (void)<ul>
<li>获取文件状态 flag （和open函数传递的flag是同一个东西）</li>
<li>用法：</li>
</ul>
</li>
<li>F_SETFL (int)<ul>
<li><p>设置文件状态 flag</p>
</li>
<li><p>access mode 不可修改 O_RDONLY,  O_WRONLY, O_RDWR ， creation flags 也不可修改</p>
</li>
<li><p>可选项：O_APPEND（追加数据）, O_NONBLOCK（设置成非阻塞）</p>
</li>
</ul>
</li>
</ul>
</li>
<li>可变参数</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Duplicating a file descriptor
    
       <span class="token function">F_DUPFD</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>
    
       Duplicate the file descriptor fd using the lowest<span class="token operator">-</span>numbered available file descriptor greater than or equal to  arg<span class="token punctuation">.</span>
       This is different from <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> which uses exactly the file descriptor specified<span class="token punctuation">.</span>

       On success<span class="token punctuation">,</span> the new file descriptor is returned<span class="token punctuation">.</span>

       As  <span class="token keyword">for</span>  F_DUPFD<span class="token punctuation">,</span>  but  additionally set the close<span class="token operator">-</span>on<span class="token operator">-</span>exec flag <span class="token keyword">for</span> the duplicate file descriptor<span class="token punctuation">.</span>  Specifying this flag permits a program to avoid an additional <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> F_SETFD operation to set the FD_CLOEXEC flag<span class="token punctuation">.</span>  For an  explanation of why this flag is useful<span class="token punctuation">,</span> see the description of O_CLOEXEC in <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
           
File status flags
    
       Each  open  file description has certain associated status flags<span class="token punctuation">,</span> initialized by <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> and possibly modified by <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> Duplicated file <span class="token function">descriptors</span> <span class="token punctuation">(</span>made with <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>F_DUPFD<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> etc<span class="token punctuation">.</span><span class="token punctuation">)</span> refer to the same open file description<span class="token punctuation">,</span> and thus share the same file status flags<span class="token punctuation">.</span>

       The file status flags and their semantics are described in <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

       <span class="token function">F_GETFL</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
    
       <span class="token function">Return</span> <span class="token punctuation">(</span>as the function result<span class="token punctuation">)</span> the file access mode and the file status flags<span class="token punctuation">;</span> arg is ignored<span class="token punctuation">.</span>

       <span class="token function">F_SETFL</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>
    
       Set  the  file  status flags to the value specified by arg<span class="token punctuation">.</span>  File access <span class="token function">mode</span> <span class="token punctuation">(</span>O_RDONLY<span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span> and file creation <span class="token function">flags</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> O_CREAT<span class="token punctuation">,</span> O_EXCL<span class="token punctuation">,</span> O_NOCTTY<span class="token punctuation">,</span> O_TRUNC<span class="token punctuation">)</span> in arg are ignored<span class="token punctuation">.</span>  
       On Linux<span class="token punctuation">,</span> this  command  can  change only  the  【O_APPEND<span class="token punctuation">,</span>  O_ASYNC<span class="token punctuation">,</span> O_DIRECT<span class="token punctuation">,</span> O_NOATIME<span class="token punctuation">,</span> and O_NONBLOCK flags】<span class="token punctuation">.</span>  
       It is not possible to change the O_DSYNC and O_SYNC flags<span class="token punctuation">;</span> see BUGS<span class="token punctuation">,</span> below<span class="token punctuation">.</span>
           
       On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span>
           <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h5 id="阻塞-amp-非阻塞"><a href="#阻塞-amp-非阻塞" class="headerlink" title="阻塞 &amp; 非阻塞"></a>阻塞 &amp; 非阻塞</h5><p>描述的是函数的行为。</p>
<p><code>阻塞</code>，在调用结果返回前，当前线程会被挂起，并在得到结果之后返回。 </p>
<p>​            终端等待我们输入的时候就是阻塞的。</p>
<p><code>非阻塞</code>，如果不能立刻得到结果，则该调用者不会阻塞当前线程。</p>
<p>​            在终端，我们输入好命令后进程执行期间是不阻塞的。</p>
<h5 id="测试代码-13"><a href="#测试代码-13" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 打开文件</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取文件状态 flag</span>
    <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fcntl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
     <span class="token comment">// 设置文件状态 flag</span>
    flag <span class="token operator">|=</span> O_APPEND<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fcntl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写数据</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, fcntl\n"</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://img-blog.csdnimg.cn/70a468d4bdde45c48ac474745884e6ca.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="flag |= O_APPEND, 会在文件末尾追加"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p><img src="https://img-blog.csdnimg.cn/9cd9c3d4d9fc4acd9306b8356e9f652b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="flag 不和 O_APPEND做按位与，直接覆盖重写"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Ludovico</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://sakkana.github.io/2022/04/09/Linux%E6%96%87%E4%BB%B6IO/">https://sakkana.github.io/2022/04/09/Linux%E6%96%87%E4%BB%B6IO/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Ludovico</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/C-C/">
                                    <span class="chip bg-color">C/C++</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/04/12/Linux%E5%A4%9A%E8%BF%9B%E7%A8%8B/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="Linux多进程">
                        
                        <span class="card-title">Linux多进程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-04-12
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/" class="post-category">
                                    系统编程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C-C/">
                        <span class="chip bg-color">C/C++</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/04/03/openGL%20-%20Hello%20Triangle/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="openGL - Hello Triangle">
                        
                        <span class="card-title">openGL - Hello Triangle</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-04-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6/" class="post-category">
                                    图形学
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/openGL/">
                        <span class="chip bg-color">openGL</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 魚のブログ<br />'
            + '文章作者: Ludovico<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2022</span>
            
            <span id="year">2022</span>
            <a href="/about" target="_blank">Ludovico</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">122.7k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = 2022;
                    var startMonth = 1;
                    var startDate = 29;
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Sakkana" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:642835027@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=642835027" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 642835027" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
