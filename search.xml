<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>mit 6.s081</title>
      <link href="/2022/07/11/6.s081/"/>
      <url>/2022/07/11/6.s081/</url>
      
        <content type="html"><![CDATA[<h1 id="mit-6-s081"><a href="#mit-6-s081" class="headerlink" title="mit 6.s081"></a>mit 6.s081</h1><h2 id="LEC-1"><a href="#LEC-1" class="headerlink" title="LEC 1"></a>LEC 1</h2><blockquote><p>阅读：xv6 book Chapter 1<br>lab: Unix Utilties</p></blockquote><h3 id="操作系统接口"><a href="#操作系统接口" class="headerlink" title="操作系统接口"></a>操作系统接口</h3><table><thead><tr><th>系统调用</th><th>描述</th></tr></thead><tbody><tr><td>fork()</td><td>创建进程</td></tr><tr><td>exit()</td><td>结束当前进程</td></tr><tr><td>wait()</td><td>等待子进程结束</td></tr><tr><td>kill(pid)</td><td>结束 pid 所指进程</td></tr><tr><td>getpid()</td><td>获得当前进程 pid</td></tr><tr><td>sleep(n)</td><td>睡眠 n 秒</td></tr><tr><td>exec(filename, *argv)</td><td>加载并执行一个文件</td></tr><tr><td>sbrk(n)</td><td>为进程内存空间增加 n 字节</td></tr><tr><td>open(filename, flags)</td><td>打开文件，flags 指定读/写模式</td></tr><tr><td>read(fd, buf, n)</td><td>从文件中读 n 个字节到 buf</td></tr><tr><td>write(fd, buf, n)</td><td>从 buf 中写 n 个字节到文件</td></tr><tr><td>close(fd)</td><td>关闭打开的 fd</td></tr><tr><td>dup(fd)</td><td>复制 fd</td></tr><tr><td>pipe(p)</td><td>创建管道， 并把读和写的 fd 返回到p</td></tr><tr><td>chdir(dirname)</td><td>改变当前目录</td></tr><tr><td>mkdir(dirname)</td><td>创建新的目录</td></tr><tr><td>mknod(name, major, minor)</td><td>创建设备文件</td></tr><tr><td>fstat(fd)</td><td>返回文件信息</td></tr><tr><td>link(f1, f2)</td><td>给 f1 创建一个新名字(f2)</td></tr><tr><td>unlink(filename)</td><td>删除文件</td></tr></tbody></table><hr><h2 id="LEC-3-OS-organization-and-system-calls"><a href="#LEC-3-OS-organization-and-system-calls" class="headerlink" title="LEC 3 - OS organization and system calls"></a>LEC 3 - OS organization and system calls</h2><p>这一节主要围绕操作系统如何为用户提供服务以及提供抽象展开。</p><p>操作系统的一大目的：<strong>同时</strong>支持<strong>多个</strong>计算活动<br>因此，操作系统需要提供：<br>① time-share the resources of the computer among these processes<br>② arrange for isolation between the processes<br>③ if one process has a bug and malfunctions, it shouldn’t affect processes that don’t depend on the buggy process<br>总结下来就是三点：多路复用、隔离性、防御性</p><h3 id="3-1-抽象物理资源"><a href="#3-1-抽象物理资源" class="headerlink" title="3.1 抽象物理资源"></a>3.1 抽象物理资源</h3><pre><code>为什么要做抽象？如果程序直接运行在硬件上面会怎么样？</code></pre><p>如果你充分信任每一个程序，那么这几个程序应当是“善良温顺的”。<br>我们为什么要在动物园的玻璃窗和铁栏外观看野生动物？因为他们并不总是“善良温顺”。<br>正是因为程序并不总是完美无瑕，互相信任，没有任何 bug，所以我们要实现强隔离性以保证程序们的有序运行。<br>因此，要实现隔离，就要防止程序直接地 (directly) 访问硬件资源。</p><p><strong>文件系统是对磁盘的抽象</strong><br>在 UNIX 操作系统中，程序访问存储系统的途径是通过文件系统提供的接口 <em>open, read, write, close</em> 等系统调用，而不是直接读写主板上的硬盘。而唯一有权利直接管理磁盘的是操作系统，程序申请读写文件，操作系统审批所有程序的读写请求并交给他们权利。</p><p><strong>进程是对 CPU 的抽象</strong><br>UNIX 在 CPU 上频繁切换进程（对于单处理器），并通过保存、恢复寄存器使得进程认为自己在独享一个 CPU。这样，操作系统可以有效管理多个进程的同时运行，哪怕某一个进程在疯狂地跑一个死循环也不会饿死其他的进程（恶意的死循环就是上面提到的“非善良温顺”的程序）。</p><p><strong>exec 系统调用在某种程度上是对内存的抽象</strong><br>程序并不直接访问物理内存，而是通过 exec 告诉操作系统，我要在该进程内执行名字为 XXX 的文件，请你帮我加载到内存中。</p><h3 id="3-2-用户模式，内核模式、系统调用"><a href="#3-2-用户模式，内核模式、系统调用" class="headerlink" title="3.2 用户模式，内核模式、系统调用"></a>3.2 用户模式，内核模式、系统调用</h3><p>上面提到的强隔离性要求我们操作系统和用户程序之间有严格的界限。<br>如果某个用户的程序出错了，我们不希望波及<strong>操作系统</strong>或<strong>其他程序</strong>。<br>因此，用户的程序不应当也不可以修改属于操作系统或其他其他程序的数据。</p><p>支撑 xv6 运行的 qemu 模拟器模拟了 RISC-V。<br>RISC-V 为隔离性提供了硬件支持：指令可以执行在三种模式下：machine mode, supervisor mode 和 user mode。</p><p><img src="https://cdn.acwing.com/media/article/image/2022/07/17/104388_9451a05c05-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"> </p><p><strong>machine mode</strong><br>CPU 工作之初的模式，用于装配、初始化该计算机的一些数据，随后便马上切换成了 supervisor mode。</p><p><strong>Supervisor mode （内核模式）</strong><br>能够执行特权指令，如开启/关闭中断、读写寄存器等。<br>一旦有普通的用户程序企图执行特权指令，操作系统会马上切换到内核模式并杀死这个进程，因为他不老师。</p><p><strong>User mode</strong><br>只能执行普通的指令如将两个寄存器相加的指令ADD、将两个寄存器相减的指令SUB、跳转指令JRC、BRANCH指令等。<br>如果一个程序希望调用内核的功能如 <code>read 系统调用</code>，CPU 会切换到内核并调用（RISC-V 提供一条指令叫 <code>ecall</code> 用于切换）。并且，内核也会检查该系统调用传递的地址是否为用户内存中的地址，做出严格的检查。</p><h3 id="3-3-内核的组织结构"><a href="#3-3-内核的组织结构" class="headerlink" title="3.3 内核的组织结构"></a>3.3 内核的组织结构</h3><p><strong>monolithic kernel (宏内核)</strong></p><blockquote><p>Unix，Linux</p></blockquote><p>在该组织结构下，整个操作系统都工作在内核中，因此所有系统调用都在执行特权指令。整个操作系统都用有硬件的最高权限。这样子，操作系统的各个部分可以更便捷地合作，浑然一体。但缺点也是致命的，由于整个操作系统都运行在特权模式下，一旦出错，这个计算机都会导致中止。</p><p><strong>micro kernel (微内核)</strong></p><blockquote><p>Minix, L4, and QNX</p></blockquote><p>这种组织的操作系统内核减少了运行在内核模式下的操作系统的代码，使得大量的代码运行在用户模式下。<br>如下图，文件系统就是一个用户级别的进程。<br>如果用户要访问文件系统，就是进程间通信的事儿了。<br><img src="https://cdn.acwing.com/media/article/image/2022/07/17/104388_ff5ecc1405-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"> </p><p>相较于对比宏内核与微内核各自的优缺点，我们更关注他们的共同点：<br>执行系统调用、使用页表、处理中断、支持进程、上锁应对并发控制、实施文件系统等。</p><h3 id="3-4-xv6-所有的内核文件"><a href="#3-4-xv6-所有的内核文件" class="headerlink" title="3.4 xv6 所有的内核文件"></a>3.4 xv6 所有的内核文件</h3><p><img src="https://cdn.acwing.com/media/article/image/2022/07/17/104388_87f2574805-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"> </p><h3 id="3-5-进程"><a href="#3-5-进程" class="headerlink" title="3.5 进程"></a>3.5 进程</h3><p>操作系统为每个进程提供这么一个地址空间<br>其中 <code>MAXVA = 0x3fffffffff</code><br><img src="https://cdn.acwing.com/media/article/image/2022/07/17/104388_3944ff1305-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"> </p><p>每个进程都拥有一个名为 proc 的结构体。<br>后面使用 p 代表指向该结构体的指针。</p><p><img src="https://cdn.acwing.com/media/article/image/2022/07/17/104388_47e9a07e05-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"> </p><p>一个进程拥有一个 user stack 和一个 kernel stack。<br>当进程使用系统调用，ecall 指令将硬件的权限提升到特权等级并且将程序计数器指向内核中定义的入口点。入口点的代码将使用 kernel stack 并且执行特权指令。当调用结束，程序又从内核切换回 user stack 并使用 sret 指令降低硬件权限，回到用户空间继续执行其他的用户指令。</p><p><code>p-&gt;state</code> 是该进程目前的状态：<br>是否被分配空间、就绪态、运行态、阻塞态（等待I/O结束）、终止态。</p><p><code>p-&gt;pagetable</code> 保存了进程的页表。在用户空间，分页硬件会使用该页表。</p><p>总而言之，一个进程将两个理念捆绑在了一起：<br>地址空间：营造了每个进程都独享内存的假象<br>线程：每个进程都独享该 CPU</p><h3 id="3-6-启动-xv6"><a href="#3-6-启动-xv6" class="headerlink" title="3.6 启动 xv6"></a>3.6 启动 xv6</h3><ol><li>RISC-V 自我初始化，运行启动加载器(存储在 ROM 中)</li><li>启动加载器将 xv6 kernel 加载到内存中</li><li>在 machine mode 下，CPU 执行 xv6 的第一行代码：_entry (分⻚硬件在此时还没有开始⼯作；所以这时的虚拟地址直接映射到物理地址上)，将 xv6 装在到物理地址 <code>0x80000000</code> 处。</li><li>(in file start.c) _entry 处的指令设置了一个栈使得 xv6 可以运行 C 代码。xv6 为最初的栈声明了一片空间：stack0。此外，这里的代码还将栈指针 <code>sp</code> 指向 <code>stack0 + 4096</code>（栈起点）。随后调用函数 start()。</li><li>start() 函数在 machine mode 下装配一些参数，在时钟芯片上开启时钟中断，并立马切换到 supervisor mode（通过 RISC-V 提供的 mret指令来到 main.c）。<br><img src="https://cdn.acwing.com/media/article/image/2022/07/18/104388_ae27ec1e06-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"> </li><li>(in file main.c) 初始化一些设备和子系统，通过 <code>userinit</code> (定义在 kernel/proc.c) 创建第一个进程。<br><img src="https://cdn.acwing.com/media/article/image/2022/07/18/104388_cdf243e606-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"><br><img src="https://cdn.acwing.com/media/article/image/2022/07/18/104388_ca0ae48c06-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"><br><img src="https://cdn.acwing.com/media/article/image/2022/07/18/104388_6348f4db06-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"><br>该进程执行一段用 RISC-V 写的汇编代码 <code>initcode.S</code>（in file user/initcode.S），加载 exec 要执行的第一个系统调用编号。将 exec 的编号 <code>SYS_EXEC</code>（定义在 kernel/syscall.h）存入 a7 寄存器，并调用 <code>ecall</code> 回到内核。<br><img src="https://cdn.acwing.com/media/article/image/2022/07/18/104388_9981e47806-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"> </li><li>内核读取 a7 寄存器中代表 exec 的宏 SYS_EXEC，将其传入 <code>sys_call</code>，真正执行系统调用。可以看到， exec 将 文件<code>/init</code>（in file user/init.c）装载到当前内存并开始执行。<br><img src="https://cdn.acwing.com/media/article/image/2022/07/18/104388_21182c5906-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"> </li><li>当内核执行完 exec ，马上切换回用户模式下的 /init 进程。该进程创建了一个控制台设备文件，打开了文件并获得文件描述符0, 1, 2。随后启动在控制台启动 shell。<br><img src="https://cdn.acwing.com/media/article/image/2022/07/18/104388_55a8294306-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"> </li><li> 操作系统启动结束，电脑开机。</li></ol><h3 id="3-7-防卫措施"><a href="#3-7-防卫措施" class="headerlink" title="3.7 防卫措施"></a>3.7 防卫措施</h3><p>那么，操作系统如何应对 bug 和恶意代码的攻击呢？<br>我们的操作系统必须秉持一个理念：任何进程的用户级别代码都在想方设法攻击内核或是其他进程。</p><blockquote><p>恶意代码可能做什么事情？<br>将指针引用至其合法地址空间外（指针偏移至非法区域）<br>尝试执行 RISC-V 特权指令<br>读取 RISC-V 的寄存区<br>直接访问设备硬件<br>向系统调用传递一些奇怪的值来击垮内核</p></blockquote><p>因此，我们要使我们的操作系统具有鲁棒性，需要不惜一切代价做好安全防卫措施。</p><blockquote><p>操作系统可以做些什么？<br>断言<br>类型检查<br>堆栈保护<br>…</p></blockquote><hr><h2 id="LEC-4-Page-tables"><a href="#LEC-4-Page-tables" class="headerlink" title="LEC 4 - Page tables"></a>LEC 4 - Page tables</h2><h3 id="调试-xv6"><a href="#调试-xv6" class="headerlink" title="调试 xv6"></a>调试 xv6</h3><p>启动 qemu-gdb 服务器端<br>再启动 gdb-multiarch 客户端<br>打上断点 <code>b kvminit</code>，执行 <code>c</code> 来到 kernel pagetbale 初始化的函数<br>进入 <code>layout split</code> 布局下<br><img src="https://cdn.acwing.com/media/article/image/2022/07/24/104388_97120ed90b-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"> </p><h5 id="kvminit"><a href="#kvminit" class="headerlink" title="kvminit"></a>kvminit</h5><p>在 kvminit() 中，调用 kvmmake() 来初始化。<br>该函数对内核地址空间做了恒等映射，使得 IO 设备与  DRAM 中的物理地址与虚拟地址对应了起来。</p><h5 id="kvminithart"><a href="#kvminithart" class="headerlink" title="kvminithart"></a>kvminithart</h5><p>之后，便进入了 kvminithart() 函数。<br>该函数用于启用页表。<br><img src="https://cdn.acwing.com/media/article/image/2022/07/24/104388_929c5eb30b-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"><br>该函数调用 <code>kernel/riscv.h</code> 中的 <code>w_satp</code>，将刚才设置的页表地址写入 <code>stap</code> 寄存器。<br><img src="https://cdn.acwing.com/media/article/image/2022/07/24/104388_1f4962bb0b-%E6%8D%95%E8%8E%B7.JPG" alt="捕获.JPG"><br>在这条指令给使用之前，使用的还是物理地址，这条指令一旦执行，便开启了虚拟地址和映射，每一个地址都会使用我们设置的页表去进行转换，整个世界都变了。</p><hr><h2 id="LEC-5-Calling-Convention"><a href="#LEC-5-Calling-Convention" class="headerlink" title="LEC 5 - Calling Convention"></a>LEC 5 - Calling Convention</h2><p>讲了些关于汇编、指令、寄存器的知识。</p><hr><h2 id="LEC-6-Isolation-amp-system-call-entry-exit"><a href="#LEC-6-Isolation-amp-system-call-entry-exit" class="headerlink" title="LEC 6 - Isolation &amp; system call entry/exit"></a>LEC 6 - Isolation &amp; system call entry/exit</h2><p>这部分要求阅读 xv6-book 的 Chapter 4 (except 4.6)<br>下面是 xv6-book 的笔记</p><h3 id="6-1-异常控制流"><a href="#6-1-异常控制流" class="headerlink" title="6.1 异常控制流"></a>6.1 异常控制流</h3><p>这部分和 csapp 的 Chapter 8 内容是一致的。<br>CPU 平时会乖乖地执行指令，岁月安好无恙。但是有三种情况 CPU 不会像往常一样正常地执行指令，这是因为发生了一些特殊的事情。</p><blockquote><ol><li>trap (陷阱)：用户代码引起了系统调用，ecall 指令使得操作系统陷入内核，在内核态执行系统调用。</li><li>fault (故障)：非法指令（除数为0）、访问非法内存等。</li><li>device interrupt (中断)：处理器外部的 I/O 设备发过来的信号，比如磁盘完成读写。</li></ol></blockquote><p>我们希望代码正常执行，且看不到异常的发生，这就要求我们内核处理异常是透明的，一切都在暗中悄无声息地解决。<br>因此，发生异常后 xv6 的处理顺序是这样的：</p><blockquote><ol><li>处理器将控制权由用户态传递给内核态。</li><li>内核保存寄存器和一些状态，以便后面恢复。</li><li>内核执行适当的处理程序（系统调用或设备驱动）。</li><li>内核恢复寄存器中的值，恢复状态，从异常中返回。</li><li>继续执行原先正在执行的用户代码。</li></ol></blockquote><p>xv6 的异常处理分为四个阶段：</p><blockquote><ol><li>RISC-V CPU 采取一些硬件操作</li><li>与内核 C 代码适配的一些汇编指令</li><li>处理异常的 C 函数</li><li>系统调用、设备驱动服务程序<br>这里原文是 device-driver service routine (a part of a computer program that does a particular operation)</li></ol></blockquote><p>此外，可以将异常分为三种来源：</p><blockquote><ol><li>来自用户</li><li>来自内核</li><li>来自处理器的时钟中断</li></ol></blockquote><h3 id="6-2-RISC-V-异常处理机制"><a href="#6-2-RISC-V-异常处理机制" class="headerlink" title="6.2 RISC-V 异常处理机制"></a>6.2 RISC-V 异常处理机制</h3><p>RISC-V 芯片由一套控制寄存器用于处理异常、通知内核异常的发生。<br>在源码 <code>riscv-h</code> 中定义了一系列寄存器：</p><blockquote><ol><li>stvec：写入异常处理程序的地址</li><li>sepc：保存程序计数器 PC，sret 指令可以在程序从异常中返回时将 sepc 中保存的值复制到用户的 PC</li><li>scause：异常发生的原因</li><li>sscartch：保存一个 value，在异常处理程序一开始时会派上用场</li><li>sstatus：SIT 位决定是否允许设备中断，SPP 位标记异常来自内核还是用户，一次来决定 sret 的返回状态。</li></ol></blockquote><p>这些寄存器用户是不可以修改的，工作在 superviosr mode 下。<br>当异常发生（除了时钟中断）时，RISC-V 硬件会做这些事：</p><blockquote><ol><li>如果是设备中断，不做下面的任何事。</li><li>将 sstatus 中的 SIE 位清空，关闭中断。</li><li>拷贝 pc -&gt; sepc (异常发生前的 pc 存的地址)。</li><li>保存当前的模式 (supervisor/user) 到 ssatus 中的 SSP 位。</li><li>设置 sscause 来反映异常发生的原因。</li><li>将模式转换成 supervisor。</li><li>拷贝 stvec (异常处理程序的地址) -&gt; pc。</li><li>执行新 pc 指向的代码。</li></ol></blockquote><p>硬件只是设置一些参数，并不切换到内核页表、内核栈，除了 pc 也不保存其他的寄存器。<br>之所以这么精简是因为这些任务都留给了软件 - 内核。<br>内核需要做这些准备工作。这是为了效率考虑，比如有些操作系统就不会切换页表来加速异常处理。</p><h3 id="6-3-来自用户空间的异常"><a href="#6-3-来自用户空间的异常" class="headerlink" title="6.3 来自用户空间的异常"></a>6.3 来自用户空间的异常</h3><p>xv6 区分异常的来源——来自用户空间亦或是内核空间，以此来决定如何处理异常。<br>上面提过，有三种情况会引起异常。</p><blockquote><ol><li>trap (陷阱)：用户代码引起了系统调用，ecall 指令使得操作系统陷入内核，在内核态执行系统调用。</li><li>fault (故障)：非法指令（除数为0）、访问非法内存等。</li><li>device interrupt (中断)：处理器外部的 I/O 设备发过来的信号，比如磁盘完成读写。</li></ol></blockquote><p>xv6 通过 <strong>uservec (汇编代码)<strong>，</strong>usertrap (C程序)<strong>，</strong>usertrapret (C程序)<strong>，</strong>userret (汇编代码)</strong> 来完成异常的处理。</p><p>设计 xv6 异常处理程序的一个限制是，RISC-V 硬件遇到异常时并不切换页表。这意味着 <code>stvec</code> 中的异常处理程序的地址在用户页表中是合法的，因为这是异常处理程序在开始执行的时候这张页表是有效的。此外，xv6 异常处理代码需要切换到内核的页表，且能够在内核中继续执行，这就要求 <code>stvec</code> 指向的异常处理程序在内核的页表中也有一个映射。</p><p>xv6 通过一个叫做 <code>trampoline (蹦床，可以理解为跳转到蹦床上会被弹到另一个代码处)</code> 的页来实现这个需求，这个页包含一段由 <code>stvec</code> 指向的异常处理代码——<code>uservec (用户向量表)</code>。这个蹦床页被映射在每一个进程页表和内核页表中的 <code>TRAMPOLINE</code> 地址处（位于虚拟地址的最高处）。由于被映射在同一个地址，因此，这里的代码可以在切换用户页表和内核页表的时候可以被连续不中断地执行，无缝衔接。</p><p><code>uservec</code> 的代码在 <code>trampoline.S</code> 文件中。当 <code>uservec</code> 开始执行的时候，所有 32 个寄存器都保存了被中断的用户代码的值。这 32 个值需要被保存在内存中的某处，因此在异常返回用户区域后可以被恢复原样。</p><h4 id="uservec-的职责-来到蹦床"><a href="#uservec-的职责-来到蹦床" class="headerlink" title="uservec  的职责 (来到蹦床)"></a>uservec  的职责 (来到蹦床)</h4><ol><li><p><code>uservec</code> 中一开始的代码就是用 <code>csrrw</code> 指令交换 <code>a0</code> 寄存器和 <code>sscratch</code> 的值。这样一来，a0 的值就保存在了 sscratch 中，内核之间存放在 ssratch 中的值就存放在了 a0 中。</p></li><li><p><code>uservec</code> 下一个工作便是保存 32 个寄存器中的值。<br>在进入用户区域之前，内核设置 <code>sscratch</code> 指向一个每个进程都有的结构体 <code>trapframe</code>，该结构体拥有存放 32 个用户寄存器的空间。由于 <code>satp (保存 root 级别页表的物理地址)</code> 仍然保存的是用户页表的地址，因此 <code>uservec</code> 需要 <code>trapframe</code> 被映射到用户地址空间。</p><blockquote><p>RISC-V 有 32 个整数寄存器，我们为什么要保存他们？<br>我们希望内核能够响应中断，之后在用户程序完全无感知的情况下再恢复用户代码的执行。所以这意味着32个用户寄存器不能被内核弄乱。但是这些寄存器又要被内核代码所使用，所以在trap之前，你必须先在某处保存这32个用户寄存器。</p></blockquote></li></ol><p>在每个进程创建之初，xv6 为进程的 <code>trapframe</code> 在 <code>TRAPFRAME</code> 地址处创建一个页，位于 <code>TRAMPOLINE</code> 的正下方。进程控制块的 <code>p-&gt;trapframe</code> 变量也指向这个 <code>trapframe</code> 的物理地址（内核页表中许多地址都是恒等映射），因此内核可以通过内核页表使用它。<br>交换好了 <code>a0</code> 和 <code>sscratch</code> 之后，<code>a0</code> 保存的便是指向当前进程 <code>trapframe</code> 的指针。这样一来，<code>uservec</code> 就可以在这里保存所有寄存器了，包括用户从 <code>sscratch</code> 读到并保存在 <code>a0</code> 中的值。</p><ol start="3"><li><code>trapframe</code> 包含：<br>当前进程内核栈的地址<br>当前 CPU 的 hartid<br>usertrap() 函数的地址<br>内核页表的地址<br><code>uservec</code> 会拿到这些值，并将内核页表的地址放入 <code>satp</code> 寄存器，调用 <code>usertrap</code> ，从蹦床上蹦出去，来到真正执行异常处理的逻辑代码部分。</li></ol><h4 id="usertrap-的职责-（离开蹦床，正式处理异常）"><a href="#usertrap-的职责-（离开蹦床，正式处理异常）" class="headerlink" title="usertrap 的职责 （离开蹦床，正式处理异常）"></a>usertrap 的职责 （离开蹦床，正式处理异常）</h4><ol><li><p>改变 <code>stvec</code> 的值，因此在内核中发生的异常会由 <code>kernelvec</code> 处理，而不是 <code>uservec</code>。其次，将程序计数器保存在 <code>sepc</code> 中，因为 <code>usertrap</code> 可能会调用 <code>yield</code> 来切换线程，导致该线程在用户空间修改程序计数器的值。</p><blockquote><p>为什么要将程序计数器保存至 sepc？<br>我们需要能够在用户程序运行中断的位置继续执行用户程序。</p></blockquote></li><li><p>如果该异常是系统调用，<code>syscall</code> 会去处理；如果该异常是设备中断，<code>devintr</code> 会去处理；如果该异常是真的出错了，那么内核会杀死这个出错的进程。</p></li><li><p>在退出时，<code>usertrap</code> 先检查该进程是否已经被杀死或放弃了 CPU (如果是个时钟中断)。</p></li></ol><h4 id="usertrapret-的职责-（回到用户空间的第一步）"><a href="#usertrapret-的职责-（回到用户空间的第一步）" class="headerlink" title="usertrapret 的职责 （回到用户空间的第一步）"></a>usertrapret 的职责 （回到用户空间的第一步）</h4><p>这个函数用来设置 RISC-V 的控制寄存器来为下一个来自用户空间的异常做准备。</p><ol><li>改变 <code>stvec</code> 的值，使其引用 <code>uservec</code>。</li><li>准备好 <code>uservec</code> 所依赖的 <code>trapframe</code>。</li><li>恢复 <code>sepc</code> 中保存的程序计数器到真正的 <code>pc</code>。</li><li>调用 <code>trampoline</code> 页中的 <code>userret</code>。 </li></ol><h4 id="userret-的职责-（回到蹦床）"><a href="#userret-的职责-（回到蹦床）" class="headerlink" title="userret 的职责 （回到蹦床）"></a>userret 的职责 （回到蹦床）</h4><p><code>usertrapret</code> 调用 <code>userret</code> 的时候传递了两个参数，其中 <code>a0</code> 是<code>trapframe</code> 的地址，<code>a1</code> 是该进程的用户页表地址。</p><ol><li><code>userret</code> 将 <code>satp</code> 中的地址转换为用户页表的地址。</li><li>将 <code>trapframe</code> 中保存的用户 <code>a0</code> 寄存器的内容拷贝到 <code>sscratch</code>，为下一个异常做准备。</li><li>恢复 <code>trapframe</code> 保存的所有用户寄存器。</li><li>交换 <code>a0</code> 和 <code>sscratch</code> 中的内容。</li></ol><h4 id="示意图如下"><a href="#示意图如下" class="headerlink" title="示意图如下"></a>示意图如下</h4><p><img src="https://cdn.acwing.com/media/article/image/2022/08/01/104388_6bef49bb11-usertrap.png" alt="usertrap.png"> </p><h3 id="6-4-Code-调用系统调用"><a href="#6-4-Code-调用系统调用" class="headerlink" title="6.4 Code: 调用系统调用"></a>6.4 Code: 调用系统调用</h3><p>了解了内核处理异常的具体细节，那么内核是如何实现一个用户申请的系统调用的呢？<br>以 xv6 启动时调用 <code>exec</code> 开始说起，<code>initcode.S</code> 将调用 <code>exec</code> 需要的参数放入 <code>a0</code> 和 <code>a1</code> 寄存器中，把代表 <code>exec</code> 的宏 <code>SYS_exec</code> 放入 <code>a7</code> 寄存器中。内核检查到该异常后走异常处理程序，发现是一个系统调用，于是走系统调用的流程，调用 <code>syscall()</code>函数。内核从<code>a7</code> 寄存器中取出代表该系统调用的宏，检查系统调用表（一个函数指针数组）中与之对应的函数，调用它。当该系统调用返回后，<code>syscall()</code> 将返回值记录在 <code>myproc()-&gt;trapframe-&gt;a0</code> 中。</p><h3 id="6-5-Code-系统调用的参数"><a href="#6-5-Code-系统调用的参数" class="headerlink" title="6.5 Code: 系统调用的参数"></a>6.5 Code: 系统调用的参数</h3><p>内核若想实现该系统调用，需要获得用户传入的参数（如果有的话）。RISC-V 将用户的参数放在寄存器中，因此内核的异常处理代码会将用户寄存器中的参数存入当前进程的 <code>trapframe</code> 中。详见 <code>sysycall.c</code> 中的 <code>argint()</code>，<code>argaddr()</code>，<code>argraw()</code>等。<br>上面提及的 <code>exec</code> 系统调用会向内核传递若干指针，这些指针指向用户空间中字符串。这就带来了两个挑战：<br>① 用户代码有可能是有 bug 或者恶意的，因此这个指针可能指向一段恶意代码访问内核的地址而不是用户地址。②内核的页表和用户进程的页表映射是不同的，因此内核无法用普通的指令来加载或者存储用户提供的地址。</p><p><strong>解决措施</strong>：<br><code>fetch()</code> 函数具有获取字符串的功能，其中调用了一个叫 <code>copyin()</code> 的函数，该函数使用 <code>walkaddr()</code> 来从用户页表中找到该地址，并将内容从用户空间拷贝到内核空间。如果找到了这个地址，说明它在用户空间是合法的，反之亦然。<br>关键还是 <code>walk()</code> 找到对应的 PTE，将物理地址返回到 <code>walkaddr()</code>，然后开始拷贝。</p><p><strong>copyinstr</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span><span class="token function">copyinstr</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> uint64 srcva<span class="token punctuation">,</span> uint64 max<span class="token punctuation">)</span><span class="token punctuation">{</span>  uint64 n<span class="token punctuation">,</span> va0<span class="token punctuation">,</span> pa0<span class="token punctuation">;</span>  <span class="token keyword">int</span> got_null <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span><span class="token punctuation">(</span>got_null <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> max <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 内存向下对齐，一页首虚拟地址</span>    va0 <span class="token operator">=</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>srcva<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获得该虚拟内存对应的物理页的首地址</span>    pa0 <span class="token operator">=</span> <span class="token function">walkaddr</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va0<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pa0 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">// 该虚拟地址并不是用户地址空间中的合法映射</span>    n <span class="token operator">=</span> PGSIZE <span class="token operator">-</span> <span class="token punctuation">(</span>srcva <span class="token operator">-</span> va0<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">&gt;</span> max<span class="token punctuation">)</span>      n <span class="token operator">=</span> max<span class="token punctuation">;</span>    <span class="token comment">// 从该地址将本页剩下的都复制过来</span>    <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>pa0 <span class="token operator">+</span> <span class="token punctuation">(</span>srcva <span class="token operator">-</span> va0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token operator">*</span>dst <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>        got_null <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token operator">*</span>dst <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token operator">--</span>n<span class="token punctuation">,</span> <span class="token operator">--</span>max<span class="token punctuation">;</span> <span class="token comment">// 本页剩余，需求剩余（如果超过一页需要申请下一页的内容）</span>      p<span class="token operator">++</span><span class="token punctuation">,</span> dst<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 拷贝源，拷贝目的地</span>    <span class="token punctuation">}</span>    srcva <span class="token operator">=</span> va0 <span class="token operator">+</span> PGSIZE<span class="token punctuation">;</span>   <span class="token comment">// 下一页的开头</span>  <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>got_null<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>walkaddr</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64<span class="token function">walkaddr</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>  uint64 pa<span class="token punctuation">;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>va <span class="token operator">&gt;=</span> MAXVA<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_U<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> pa<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-6-来自内核的异常"><a href="#6-6-来自内核的异常" class="headerlink" title="6.6 来自内核的异常"></a>6.6 来自内核的异常</h3><p>在前面也看到了，一旦进入内核， <code>stvec</code> 就被设置指向 <code>kernelvec (in kernelvec.S)</code>——用于处理来自内核的异常的处理程序。<br>这段代码会做三件事情：</p><ol><li>将寄存器保存在当前线程的栈中，因为这些寄存器的值属于当前线程，因为线程调度可能切换到另一个线程上。</li><li>跳转到一个叫 <code>kerneltrap()</code> 的函数中。<br>这个函数专门处理两种异常：①设备中断 ②错误<br>如果是设备中断，<code>devintr()</code> 会妥善处理。<br>如果是错误，内核会直接调用 <code>panic()</code> 并停止运行。<br>如果 <code>kerneltrap()</code> 是由时钟中断引起的，该函数会调用 <code>yield()</code> 放弃 CPU，转而其他的线程。</li><li>恢复信息<br>在刚进入 <code>kerneltrap()</code> 的时候保存了 <code>sepc</code>，<code>sstatus</code>和<code>scause</code>，因此在返回前将他们恢复到寄存器当中。<br>xv6 会在 CPU 一进入内核空间的时候就将 <code>stvec</code> 设置为指向<code>kernelvec</code>。然而，在这里有个窗口期：开始执行 trap 机制到设置 stvec 之间。这个期间有可能会发生设备中断。此时若发生设备终端，目前执行的用户异常处理会转而变成先处理内核异常，然而此时的 <code>stvec</code> 仍然保存的是 <code>uservec</code>，因此会出错。<br>但是 RISC-V 硬件设置好了在开始 trap 程序时关闭中断，直到 xv6 设置好 <code>stvec</code> 指向 <code>kernelvec</code> 后才会再次开启。</li></ol><h3 id="notice"><a href="#notice" class="headerlink" title="notice"></a>notice</h3><p><img src="https://img1.imgtp.com/2022/08/03/qpbPBV3C.png" alt="register vs memory"><br>a0,a1 等寄存器是存在于 CPU 中的高速读写存储单元。<br>内存是独立的一块用于存储代码、指令、数据的存储单元，读写速度比寄存器慢。<br>xv6 中内核态和用户态的转换涉及用户状态的保存，其中 a1、a0、sp等是模拟真实的<strong>寄存器</strong>。p-&gt;trapframe-&gt;a0 等是同时映射于内核和用户空间中 trapframe 页的一块内存。<br>在进入内核态之前，我们需要保存所有用户态的寄存器，具体图示如下：<br><img src="https://img1.imgtp.com/2022/08/03/jzC08U8N.png" alt="fuck"></p><hr><h2 id="LEC-7-Page-Fault"><a href="#LEC-7-Page-Fault" class="headerlink" title="LEC 7 - Page Fault"></a>LEC 7 - Page Fault</h2><p>xv6 处理错误异常时非常单调的：若来自用户空间，直接杀死；若来自内核空间，内核直接 panic。<br>但是现实中的操作系统通常有更多有趣的机制来处理错误。</p><h3 id="7-1-copy-on-write"><a href="#7-1-copy-on-write" class="headerlink" title="7.1 copy on write"></a>7.1 copy on write</h3><p>许多内核使用 <code>page fault</code> 来实现 <code>copy-on-write (写时拷贝)</code>。原本操作系统调用 <code>fork()</code> 后将父进程的内存给子进原封不动复制一份，xv6 使用 <code>uvmcopy()</code> 来给子进程分配内存并拷贝父进程的内存到其中。我们有个大胆的想法：如果父子进程可以共享同一份内存空间，这会极大地提高效率。但是粗犷地这么实现是行不通的，因为父子进程共享同一个堆栈，会互相扰乱对方代码的执行。</p><p>但是，父子进程可以通过合适的方式利用页表的权限和 page fault 来实现 COW。<br>CPU 在三种情况下会引起 page fault：</p><ol><li>访问的虚拟地址在物理地址中没有映射。</li><li>虚拟内存映射到了一个 <code>PTE_V = 0</code> 的不合法地址。</li><li>存在这个映射，并且也合法，但是 <code>PET_R/W/X/U</code> 拒绝了这个访问。</li></ol><p>RISC-V 会在虚拟地址无法被翻译时区分三种 page fault：</p><ol><li>load page fault</li><li>store page fault</li><li>instruction page fault</li></ol><p><code>sscause</code> 寄存器会保存错误的类型，<code>stval</code> 寄存器会保存无法翻译的虚拟地址。</p><h3 id="7-2-lazy-allocation"><a href="#7-2-lazy-allocation" class="headerlink" title="7.2 lazy allocation"></a>7.2 lazy allocation</h3><h3 id="7-3-demand-paging"><a href="#7-3-demand-paging" class="headerlink" title="7.3 demand paging"></a>7.3 demand paging</h3><h3 id="7-4-paging-to-disk"><a href="#7-4-paging-to-disk" class="headerlink" title="7.4 paging to disk"></a>7.4 paging to disk</h3><hr><h2 id="LAB-2-System-calls"><a href="#LAB-2-System-calls" class="headerlink" title="LAB 2 - System calls"></a>LAB 2 - System calls</h2><p><a href="https://pdos.csail.mit.edu/6.828/2021/labs/syscall.html">lab 2 - System calls 地址</a></p><p>lab2 花了我挺久的说实话。<br>这个 lab 大头在于修改内核的代码的过程中，理解 xv6 的进程、内存、系统调用是如何工作的，通过自己写代码的方式为 xv6 添加新的系统调用。</p><h3 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h3><h5 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h5><blockquote><p>In this assignment you will add a system call tracing feature that may help you when debugging later labs. You’ll create a new trace system call that will control tracing. It should take one argument, an integer “mask”, whose bits specify which system calls to trace. For example, to trace the fork system call, a program calls trace(1 &lt;&lt; SYS_fork), where SYS_fork is a syscall number from kernel/syscall.h. You have to modify the xv6 kernel to print out a line when each system call is about to return, if the system call’s number is set in the mask. The line should contain the process id, the name of the system call and the return value; you don’t need to print the system call arguments. The trace system call should enable tracing for the process that calls it and any children that it subsequently forks, but should not affect other processes.</p></blockquote><h5 id="提示-做法"><a href="#提示-做法" class="headerlink" title="提示 + 做法"></a>提示 + 做法</h5><ol><li>在 Makefile 中加入 trace 文件。</li><li>此时编译 xv6 会报错，因为 trace.c 中的 trace() 没有被声明。在 <code>user/user.h</code> 中加入用户态 <code>trace</code> 函数的声明，并且在脚本 <code>user/usys.pl</code> 中加入声明。此外，在内核态的 <code>kernel/syscall.h</code> 中也要加入声明。Makefile 会调用 perl 语言编写的 <code>user.usys.pl</code> 脚本，并且生成汇编文件 <code>user/usys.S</code>。实际上系统调用是通过 RISC-V 的 <code>ec all</code> 指令进陷入内核的。</li><li>在内核态文件 <code>kernel/sysproc.c</code> 中实现系统调用 <code>sys_trace()</code>，并且在 <code>kernel/proc.h</code> 中的 <code>proc 结构体</code> 中加入该系统调用需要的新变量。这个系统调用需要获得这个用户态传过来的变量（用户的传入参数，即要追踪的系统调用 mask），且可以在 <code>kernel/syscall.c</code> 中查看获取变量的方法。此外，要在 <code>kernel/syscall.c</code> 中声明该与内核态的函数，在 <code>kernel/syscall.h</code> 中 define 鱼该系统调用对应的宏。</li><li>修改 <code>kernel/proc.c</code> 中的 <code>fork()</code> 函数，从而实现 fork 子进程后也可以追踪子进程。</li><li>修改 <code>kernel/syscall.c</code> 中的 <code>syscall()</code> 函数，使得我们调用系统调用时可以打印我们要追踪的 system calls。 同时也需要获得该系统调用的名称。</li></ol><p><strong>气死我了 trace children 评测点一直超时</strong></p><h3 id="sysinfo"><a href="#sysinfo" class="headerlink" title="sysinfo"></a>sysinfo</h3><p>有空再更</p><hr><h2 id="LAB-3-Page-Table"><a href="#LAB-3-Page-Table" class="headerlink" title="LAB 3 - Page Table"></a>LAB 3 - Page Table</h2><p><a href="https://pdos.csail.mit.edu/6.828/2021/labs/pgtbl.html">lab 3 - Page Table 地址</a></p><h3 id="Speed-up-system-calls"><a href="#Speed-up-system-calls" class="headerlink" title="Speed up system calls"></a>Speed up system calls</h3><h5 id="要求-1"><a href="#要求-1" class="headerlink" title="要求"></a>要求</h5><blockquote><p>Some operating systems (e.g., Linux) speed up certain system calls by sharing data in a read-only region between userspace and the kernel. This eliminates the need for kernel crossings when performing these system calls. To help you learn how to insert mappings into a page table, your first task is to implement this optimization for the getpid() system call in xv6.</p></blockquote><blockquote><p>When each process is created, map one read-only page at USYSCALL (a VA defined in memlayout.h). At the start of this page, store a struct usyscall (also defined in memlayout.h), and initialize it to store the PID of the current process. For this lab, ugetpid() has been provided on the userspace side and will automatically use the USYSCALL mapping. You will receive full credit for this part of the lab if the ugetpid test case passes when running pgtbltest.</p></blockquote><h5 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h5><ol><li>在 <code>kernel/proc.c</code>中的<code>proc_pagetable()</code>做地址映射，将<code>kernel/memlayout.h</code>中的<code>struct usyscall</code>结构体映射到以 <code>USYSCALL</code> 开头的页面。</li><li>设置好该页面的访问权限。</li><li>模仿 <code>mappages()</code> 进行内存映射。</li><li>在 <code>allocproc.c</code> 和 <code>freeproc.c</code> 中进行页面的分配和释放，解映射。</li></ol><p>首先，我们要映射的是一个结构体，该结构体包含一个参数 <code>pid</code>。由于我们每次调用 <code>getpid()</code> 会陷入内核，内核态和用户态的转换会消耗一定的 cpu 时间，因此如果我们把进程的 pid 保存在一个共享的只读区域，用户态可以直接去读取，因此可以加速该系统调用。<br>既然要映射一个新的页面，那就模仿 <code>trapframe' 一样在 </code>struct proc<code>中新建一个变量</code>struct usyscall *mypid<code>。 下一步，在 </code>allocproc()<code>中为该页面使用</code>kalloc()<code>分配内存，切记一定要在创建页表之前分配内存，并且</code>mypid-&gt;pid = pid<code>。之后在 </code>proc_pagetable()<code>中使用</code>mappages<code>做地址的映射，设置好恰当的 flags </code>PTE_R | PTE_U<code>。 最后，在 </code>freeproc()` 中先释放所有的内存，再解除映射，释放页表。这是因为我们要通过页表去索引每个虚拟地址的物理地址，因此这样可以释放他们的内存，最后都释放干净了就可以解除映射关系，释放页表了。</p><h3 id="Print-a-page-table"><a href="#Print-a-page-table" class="headerlink" title="Print a page table"></a>Print a page table</h3><h5 id="要求-2"><a href="#要求-2" class="headerlink" title="要求"></a>要求</h5><p>简而言之就是设计一个函数，通过给定的 page table 打印其内容。</p><blockquote><p>To help you visualize RISC-V page tables, and perhaps to aid future debugging, your second task is to write a function that prints the contents of a page table.</p></blockquote><blockquote><p>Define a function called vmprint(). It should take a <code>pagetable_t (uint64*)</code> argument, and print that pagetable in the format described below. Insert if(p-&gt;pid==1) vmprint(p-&gt;pagetable) in exec.c just before the return argc, to print the first process’s page table. You receive full credit for this part of the lab if you pass the pte printout test of make grade.</p></blockquote><p>Now when you start xv6 it should print output like this, describing the page table of the first process at the point when it has just finished exec()ing init:</p><p>page table 0x0000000087f6e000<br> ..0: pte 0x0000000021fda801 pa 0x0000000087f6a000<br> .. ..0: pte 0x0000000021fda401 pa 0x0000000087f69000<br> .. .. ..0: pte 0x0000000021fdac1f pa 0x0000000087f6b000<br> .. .. ..1: pte 0x0000000021fda00f pa 0x0000000087f68000<br> .. .. ..2: pte 0x0000000021fd9c1f pa 0x0000000087f67000<br> ..255: pte 0x0000000021fdb401 pa 0x0000000087f6d000<br> .. ..511: pte 0x0000000021fdb001 pa 0x0000000087f6c000<br> .. .. ..509: pte 0x0000000021fdd813 pa 0x0000000087f76000<br> .. .. ..510: pte 0x0000000021fddc07 pa 0x0000000087f77000<br> .. .. ..511: pte 0x0000000020001c0b pa 0x0000000080007000</p><p>The first line displays the argument to vmprint. After that there is a line for each PTE, including PTEs that refer to page-table pages deeper in the tree. Each PTE line is indented by a number of “ ..” that indicates its depth in the tree. Each PTE line shows the PTE index in its page-table page, the pte bits, and the physical address extracted from the PTE. Don’t print PTEs that are not valid. In the above example, the top-level page-table page has mappings for entries 0 and 255. The next level down for entry 0 has only index 0 mapped, and the bottom-level for that index 0 has entries 0, 1, and 2 mapped.<br>Your code might emit different physical addresses than those shown above. The number of entries and the virtual addresses should be the same.</p><h5 id="提示-1"><a href="#提示-1" class="headerlink" title="提示"></a>提示</h5><ol><li>将 <code>vmprint()</code> 写入 <code>kernel/vm.c</code>。</li><li>使用 <code>kernel/riscv.h</code>最后的宏。</li><li>使用 <code>freewalk()</code>。</li><li>再 <code>kernel/defs.h</code> 中声明 <code>vmprint()</code> 的函数原型，这样可以使用 <code>exec.c</code> 调用。</li><li>在 <code>printf()</code> 中使用 <code>%p</code> 打印 64 位的八进制 PTEs 和 地址。</li></ol><h5 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h5><p>直接递归遍历三级的页表，按照要求排版打印就行了。</p><h3 id="Detecting-which-pages-have-been-accessed"><a href="#Detecting-which-pages-have-been-accessed" class="headerlink" title="Detecting which pages have been accessed"></a>Detecting which pages have been accessed</h3><h5 id="要求-3"><a href="#要求-3" class="headerlink" title="要求"></a>要求</h5><p>简而言之就是实现一个系统调用 <code>pgaccess()</code> 用来汇报哪些页被访问过。</p><blockquote><p>Some garbage collectors (a form of automatic memory management) can benefit from information about which pages have been accessed (read or write). In this part of the lab, you will add a new feature to xv6 that detects and reports this information to userspace by inspecting the access bits in the RISC-V page table. The RISC-V hardware page walker marks these bits in the PTE whenever it resolves a TLB miss</p></blockquote><blockquote><p>Your job is to implement pgaccess(), a system call that reports which pages have been accessed. The system call takes three arguments. First, it takes the starting virtual address of the first user page to check. Second, it takes the number of pages to check. Finally, it takes a user address to a buffer to store the results into a bitmask (a datastructure that uses one bit per page and where the first page corresponds to the least significant bit). You will receive full credit for this part of the lab if the pgaccess test case passes when running pgtbltest.</p></blockquote><h5 id="提示-2"><a href="#提示-2" class="headerlink" title="提示"></a>提示</h5><ol><li>在 <code>kernel/sysproc.c</code> 中实现 sys_pgaccess()`。</li><li>用 <code>argaddr()</code> 和 <code>argint()</code> 解析参数。</li><li>对于输出的 <code>bitmask</code>，在填完之后在内核建立一个临时的缓冲区，再使用 <code>copyout()</code> 拷贝到用户区会更方便。</li><li>可以设置一个扫描的页表的上限。</li><li>使用 <code>kernel/vm.c</code> 中的 <code>walk()</code> 来寻找正确的 PTEs。</li><li>在 <code>kernel/riscv.h</code> 中定义 <code>PTE_A (access bit)</code> 。查阅 RISC-V 手册来决定它的参数。</li><li>检查完之后要清空 <code>PTE_A</code>，不然就不知道这个 PTE 是这次检测到的还是上次检测到的。</li><li>可以使用 <code>vmprint()</code> 来 debug。</li></ol><h5 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h5><p>从给定的页和要检查的数量，根据 PGSIZE 遍历这几页，通过 <code>walk</code> 寻找。</p><hr><h2 id="LAB-4-Traps"><a href="#LAB-4-Traps" class="headerlink" title="LAB 4 - Traps"></a>LAB 4 - Traps</h2>]]></content>
      
      
      <categories>
          
          <category> 操作系统 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 操作系统 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cs61a学习小记</title>
      <link href="/2022/05/16/cs61a%20%E5%AD%A6%E4%B9%A0%E5%B0%8F%E8%AE%B0/"/>
      <url>/2022/05/16/cs61a%20%E5%AD%A6%E4%B9%A0%E5%B0%8F%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="cs61a学习小记"><a href="#cs61a学习小记" class="headerlink" title="cs61a学习小记"></a>cs61a学习小记</h1><h2 id="关于-Higher-Order-Function"><a href="#关于-Higher-Order-Function" class="headerlink" title="关于 Higher Order Function"></a>关于 Higher Order Function</h2><h5 id="python中函数的泛化-generalization"><a href="#python中函数的泛化-generalization" class="headerlink" title="python中函数的泛化(generalization)"></a>python中函数的泛化(generalization)</h5><p>C / C++中允许传递指向函数的指针作为参数，赋值给指针变量抑或是作为函数参数。<br>然而，python中允许将函数名作为变量直接赋值。<br>这涉及到一种程序设计哲学，将 enviroment 中所有的东西看作一种 value，比如print是预定义的value，它指向了一个在 stdin 中输出东西的函数；def 后的函数名也是一种 value，指向用户自定义的一个函数；用户定义的普通变量则绑定了一个具体的值。<br>通过将函数名赋值给另一个变量，则该变量也绑定上了该函数，指向该函数。</p><p>例如下面这段代码，我们将函数名square和reciprocal作为传入参数传入calculate，被形参term所接收，于是term便先后绑定上了这两个函数，直接调用term()便可以完成这俩函数的功能。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">calcuate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> term<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> term<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">square</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> x <span class="token operator">*</span> x<span class="token keyword">def</span> <span class="token function">reciprocal</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">/</span> x <span class="token keyword">if</span> x <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token string">'Error'</span>res <span class="token operator">=</span> calcuate<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> square<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>res <span class="token operator">=</span> calcuate<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> reciprocal<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>res <span class="token operator">=</span> calcuate<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> reciprocal<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token triple-quoted-string string">'''output:90.3333333333333333Error'''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里刚开始学习的时候有点震惊，因为接触了 C/C++/java 等编译型语言，从来没有遇到过这么自由的用法。<br>曾经最多使用过函数指针或者是类似 x = f() 这种将函数返回值赋值给变量的用法，然而 python 却可以将<br>函数名看成普通变量一般赋值，并且被赋值的变量也可以当作一个函数名来使用。</p><h5 id="lambda"><a href="#lambda" class="headerlink" title="lambda"></a>lambda</h5><p>此外，我们也可以不事先定义该函数，可以使用 lambda 匿名函数作为函数参数<br>即</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">res <span class="token operator">=</span> calcuate<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> x<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>函数是一种 <code>first-class-value</code>，可以将它赋值给变量，可以将他们作为函数参数传参，也可以作为函数返回值。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> math <span class="token keyword">import</span> sin<span class="token punctuation">,</span> cos<span class="token punctuation">,</span> pi<span class="token keyword">def</span> <span class="token function">h</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> sin<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> cos<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token comment"># common</span><span class="token keyword">print</span><span class="token punctuation">(</span>sin<span class="token punctuation">(</span>pi <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> cos<span class="token punctuation">(</span>pi <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># higher order function</span><span class="token keyword">print</span><span class="token punctuation">(</span>h<span class="token punctuation">(</span>pi <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>还有更多这种诡异的用法</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">adder</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> f<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> g<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    <span class="token keyword">return</span> adder<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> x <span class="token operator">/</span> <span class="token number">2</span>cal <span class="token operator">=</span> add<span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span> <span class="token comment"># 会将 f() 和 g() 计算后的返回值相加并返回</span><span class="token keyword">print</span><span class="token punctuation">(</span>cal<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:30.0"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面这个和上面算 $\sqrt{2}$ 是一样的</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> operator <span class="token keyword">import</span> add<span class="token keyword">from</span> math <span class="token keyword">import</span> pi<span class="token punctuation">,</span> sin<span class="token punctuation">,</span> cos<span class="token keyword">def</span> <span class="token function">combine_func</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">combined</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">def</span> <span class="token function">val</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> op<span class="token punctuation">(</span>f<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> g<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> val    <span class="token keyword">return</span> combinedadd_func <span class="token operator">=</span> combine_func<span class="token punctuation">(</span>add<span class="token punctuation">)</span> <span class="token comment"># 内部执行 add(f, g)</span><span class="token comment"># 这里本质上只是一个内置库里的加法函数，因此写成这样也是可以的</span><span class="token comment"># lambda x, y: x + y</span>h <span class="token operator">=</span> add_func<span class="token punctuation">(</span>sin<span class="token punctuation">,</span> cos<span class="token punctuation">)</span> <span class="token comment"># 得到一个h(x) = add(sin(x), cos(x))</span><span class="token keyword">print</span><span class="token punctuation">(</span>h<span class="token punctuation">(</span>pi <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>能否写出一个函数 <code>if_func(1 / x, x &gt; 0, 0)</code>， whcih 看起来像 1 / x if x &gt; 0 else 0 ？<br>IMPOSSIABLE! 因为表达式总会求值，一旦求值进到函数里的就不是我们看到的样子了，而是一个实实在在的值。<br>但是我们可以用下面这种方式</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># defination:</span><span class="token keyword">def</span> <span class="token function">if_func</span><span class="token punctuation">(</span>then_expr<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> else_expr<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">return</span> then_expr<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> condition <span class="token keyword">else</span> else_expr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># call:</span>if_func<span class="token punctuation">(</span><span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> x<span class="token punctuation">,</span> x <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例子：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">if_func</span><span class="token punctuation">(</span>then_expr<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> else_expr<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> then_expr<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> condition <span class="token keyword">else</span> else_expr<span class="token punctuation">(</span><span class="token punctuation">)</span>x <span class="token operator">=</span> <span class="token number">2</span>res <span class="token operator">=</span> if_func<span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'is fucking 2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'is not 2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:is fucking 2None"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>lambda后面直接是冒号 <code>:</code> 说明该匿名函数不接受任何参数，即 f(void)</p><p>lambda 函数体内的 local frame 也可以访问它 parent 的变量</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># Pay attention to the scope of variables</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> z <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> e <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token keyword">lambda</span> y<span class="token punctuation">:</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> x <span class="token operator">+</span> y <span class="token operator">+</span> z<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> e<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>? <span class="token number">4</span><span class="token operator">-</span><span class="token operator">-</span> OK! <span class="token operator">-</span><span class="token operator">-</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python">Lambda the Free <span class="token operator">&gt;</span> Suite <span class="token number">2</span> <span class="token operator">&gt;</span> Case <span class="token number">4</span><span class="token punctuation">(</span>cases remaining<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span>What would Python display? If you get stuck<span class="token punctuation">,</span> <span class="token keyword">try</span> it out <span class="token keyword">in</span> the Pythoninterpreter!这道题不是太会欸<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># Try drawing an environment diagram if you get stuck!</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> print_lambda <span class="token operator">=</span> <span class="token keyword">lambda</span> z<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> print_lambdaFunction<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> one_thousand <span class="token operator">=</span> print_lambda<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token number">1000</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> one_thousand?  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这道关于判断两个复合函数是否相等的题目也很有意思<br>高中数学中依稀记得见过这种函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">composite_identity</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Return a function with one parameter x that returns True if f(g(x)) is    equal to g(f(x)). You can assume the result of g(x) is a valid input for f    and vice versa.    &gt;&gt;&gt; add_one = lambda x: x + 1        # adds one to x    &gt;&gt;&gt; square = lambda x: x**2    &gt;&gt;&gt; b1 = composite_identity(square, add_one)    &gt;&gt;&gt; b1(0)                            # (0 + 1)^2 == 0^2 + 1    True    &gt;&gt;&gt; b1(4)                            # (4 + 1)^2 != 4^2 + 1    False    """</span>    <span class="token string">"*** YOUR CODE HERE ***"</span>    <span class="token keyword">return</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> f<span class="token punctuation">(</span>g<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> g<span class="token punctuation">(</span>f<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="关于-Enviroment"><a href="#关于-Enviroment" class="headerlink" title="关于 Enviroment"></a>关于 Enviroment</h2><p>先来看个小例子</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">'outer'</span><span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'inner'</span>    g<span class="token punctuation">(</span><span class="token punctuation">)</span>h<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:outer"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里有三层frame，第一层是 <code>global frame</code>, 包含 f(), g() 和 h() 三个函数<br>调用 h() 之后便<code>创建了一个新的 frame</code>，由 h() 主宰，并且它的 parent 是 global frame<br>h() 内部 def 了一个属于 h() 的 f()，并且调用 g(),<br>于是<code>又创建了一个新的 frame</code>，由 h() 内部的 g() 主宰<br>g() 会去调用 f()，那么，这个 f() 是 h()内部的还是 global frame 中的呢？<br>由于我们现在在 g() 主宰的 frame 中，而 g() 是被定义在 global frame 中，<br>解释器在 g() 主宰的 frame 中没有找到 f(), 因此再往上一层到它的 parent frame ，即global frame中寻找<br>于是找到了 return ‘outer’ 的f()，打印 ‘outer’。</p><p>在 redefination 这方面，python和c/c++是类似的，都具有各自的environment和覆盖替换规则</p><p>执行流程：</p><ol><li>add f to global frame</li><li>add g to global frame, pointing to f(which return 0)</li><li>redefination f, f pointing to which returnn 1</li><li>execuate g, and return 0<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token number">0</span>g <span class="token operator">=</span> f<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token keyword">print</span><span class="token punctuation">(</span>g<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:0"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>执行流程：</p><ol><li>f(return 0) -&gt; global frame</li><li>g -&gt; global frame</li><li>rewrite f, now f return 1, cover the f which return 0</li><li>execuate g(), and call f(), which now return 1<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token number">1</span>g<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token string">""</span>"output<span class="token punctuation">:</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>执行流程：</p><ol><li>f -&gt; global frame<br> function f receive a function as variable, whose formal name is f,same as the function name<br> and inside the function f we call formal parameter f with parameter 1</li><li>g -&gt; global frame</li><li>call f, and pass function g<br> then we got f(g), where f = g, and call f(1), aka g(1), and print 1<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>f<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:1"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>关键是在调用g()的时候，内部执行return 0的f还是return 1的f?<br>由于p = k = g，g的 parent 是 global frame，因此调用 f 时会去 global frame中寻找 f<br>因此执行的是 global frame 中 return 0 的 f</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">def</span> <span class="token function">h</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">1</span>    p <span class="token operator">=</span> k    <span class="token keyword">return</span> p<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>h<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:0"""</span>f1 frame<span class="token punctuation">:</span>p <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">0</span>k <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">True</span> <span class="token operator">-</span><span class="token operator">&gt;</span> f<span class="token punctuation">(</span>g<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>f2 frame<span class="token punctuation">:</span>p <span class="token operator">=</span> g<span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">1</span>k <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">False</span> <span class="token operator">-</span><span class="token operator">&gt;</span> p<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> g<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">print</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>k <span class="token operator">=</span> <span class="token number">0</span>? <span class="token number">1</span>?我们在 f2 frame 中调用 g，这个 g 是上一层 f1 frame 传进来的，因此这个 g 属于 f1 frame，因此在 f1 frmae 中寻找 k<span class="token punctuation">,</span> 发现 k<span class="token operator">=</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>def f(p, k):<br>    def g():<br>        print(k)<br>    if k == 0:<br>        f(g, 1)<br>    else:<br>        p()</p><p>f(None, 0)</p><p>“””<br>output:<br>0<br>“””</p><p>C语言中 pass by value 并不会修改原来的值，而是修改一模一样的拷贝，除了函数各自安好。<br>python中也一样。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">x <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'before call: x = '</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    x <span class="token operator">+=</span> <span class="token number">1</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'bin the function: x = '</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>f<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'after call: x = '</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:before call: x =  1bin the function: x =  2after call: x =  1"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="关于柯里化-Currying"><a href="#关于柯里化-Currying" class="headerlink" title="关于柯里化(Currying)"></a>关于柯里化(Currying)</h2><p>老师的课件上是这么定义的：<br>The term currying refers to converting a multi-argument function into one<br>that takes one argument and returns a fcuntion that takes the next argument, and so on.</p><p>配套 textbook 是这么写的<br>We can use higher-order functions to convert a function that takes multiple arguments into a chain of functions that each take a single argument. More specifically, given a function f(x, y), we can define a function g such that g(x)(y) is equivalent to f(x, y). Here, g is a higher-order function that takes in a single argument x and returns another function that takes in a single argument y. This transformation is called currying.</p><p>该函数接受一个参数，并且内部又定义了两个匿名函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">curry2</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">lambda</span> y <span class="token punctuation">:</span> f<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token keyword">from</span> operator <span class="token keyword">import</span> addres <span class="token operator">=</span> curry2<span class="token punctuation">(</span>add<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>ans <span class="token operator">=</span> curry2<span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>ans<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:1115"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实也可以转写成这样：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">curry2</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> \                <span class="token keyword">lambda</span> y<span class="token punctuation">:</span> \                    f<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>或者这样</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">curry2</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">def</span> <span class="token function">h</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> f<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>        <span class="token keyword">return</span> h    <span class="token keyword">return</span> g<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="关于-Linear-Recursion"><a href="#关于-Linear-Recursion" class="headerlink" title="关于 Linear Recursion"></a>关于 Linear Recursion</h2><p>下面这种也是很常见的递归，实时计算<br>迭代版本每次计算完当轮结果都会立刻更新答案，递归版本则是产生一条 frame chain，<br>在每个状态的 frame 中存储变量的值，原封不动递归到下一层，直到递归到底部再自下而上一条链<br>回收所有计算过的答案。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">sum_square</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> N <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> sum_square<span class="token punctuation">(</span>N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> N <span class="token operator">**</span> <span class="token number">2</span>x <span class="token operator">=</span> sum_square<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:385"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="尾递归"><a href="#尾递归" class="headerlink" title="尾递归"></a>尾递归</h5><p>下面是两个版本的求平方和函数，通过 python Tutor 可以观察执行状态。<br>这种尾递归的方式层层深入计算，最后一次递归致命一击，计算出一锤定音的结果并一路沿着 frame chain<br>直接返回到最开始。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 迭代</span><span class="token keyword">def</span> <span class="token function">sum_squares_iter</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""The sum of k**2"""</span>    accum <span class="token operator">=</span> <span class="token number">0</span>    k <span class="token operator">=</span> <span class="token number">1</span>    <span class="token keyword">while</span> k <span class="token operator">&lt;=</span> N<span class="token punctuation">:</span>        accum <span class="token operator">+=</span> k <span class="token operator">**</span> <span class="token number">2</span>        k <span class="token operator">+=</span> <span class="token number">1</span>    <span class="token keyword">return</span> accum<span class="token comment"># 递归</span><span class="token keyword">def</span> <span class="token function">sum_squares_recur</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">part_sum</span><span class="token punctuation">(</span>accum<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> k <span class="token operator">&lt;=</span> N<span class="token punctuation">:</span>            <span class="token keyword">return</span> part_sum<span class="token punctuation">(</span>accum <span class="token operator">+</span> k <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">,</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> accum    <span class="token keyword">return</span> part_sum<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>x <span class="token operator">=</span> sum_squares_iter<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>y <span class="token operator">=</span> sum_squares_recur<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token triple-quoted-string string">"""385 385"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="刁钻点的二分"><a href="#刁钻点的二分" class="headerlink" title="刁钻点的二分"></a>刁钻点的二分</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">is_a_zero</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span> high<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">:</span>    mid <span class="token operator">=</span> <span class="token punctuation">(</span>low <span class="token operator">+</span> high<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>    <span class="token keyword">return</span> low <span class="token operator">&lt;=</span> high \        <span class="token keyword">and</span><span class="token punctuation">(</span>func<span class="token punctuation">(</span>mid<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> \            <span class="token keyword">or</span> <span class="token punctuation">(</span>func<span class="token punctuation">(</span>mid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">and</span> is_a_zero<span class="token punctuation">(</span>mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">or</span> <span class="token punctuation">(</span>func<span class="token punctuation">(</span>mid<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> is_a_zero<span class="token punctuation">(</span>low<span class="token punctuation">,</span> high <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="关于-Tree-Recursion"><a href="#关于-Tree-Recursion" class="headerlink" title="关于 Tree Recursion"></a>关于 Tree Recursion</h2><p>这是一个树递归，因为有可能同时执行不同的递归路径</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">is_a_zero</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span> high<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">:</span>    mid <span class="token operator">=</span> <span class="token punctuation">(</span>low <span class="token operator">+</span> high<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>    <span class="token keyword">return</span> low <span class="token operator">&lt;=</span> high \        <span class="token keyword">and</span><span class="token punctuation">(</span>func<span class="token punctuation">(</span>mid<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> \            <span class="token keyword">or</span> <span class="token punctuation">(</span>func<span class="token punctuation">(</span>mid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">and</span> is_a_zero<span class="token punctuation">(</span>mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">or</span> is_a_zero<span class="token punctuation">(</span>low<span class="token punctuation">,</span> high <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里有个小插曲，在中文的公式或定理我们常用 <code>有且只有</code> 这种表达强调条件的充分性，<br>在英文中可以使用 <code>iff</code> 来代表 <code>if and only if</code> 来表达假设， 类似 <code>只有且只有</code>。</p><h5 id="统计迷宫解法"><a href="#统计迷宫解法" class="headerlink" title="统计迷宫解法"></a>统计迷宫解法</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">num_paths</span><span class="token punctuation">(</span>blocked<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> y0<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> blocked<span class="token punctuation">(</span>x0<span class="token punctuation">,</span> y0<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0</span>     <span class="token keyword">elif</span> y0 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">1</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> num_paths<span class="token punctuation">(</span>blocked<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> y0 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> \            <span class="token operator">+</span> num_paths<span class="token punctuation">(</span>blocked<span class="token punctuation">,</span> x0 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y0 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> \            <span class="token operator">+</span> num_paths<span class="token punctuation">(</span>blocked<span class="token punctuation">,</span> x0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y0 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="数字分割"><a href="#数字分割" class="headerlink" title="数字分割"></a>数字分割</h5><p>num_partition(6, 3)<br>3 + 3<br>3 + 2 + 1<br>3 + 1 + 1 + 1<br>2 + 2 + 2<br>2 + 2 + 1 + 1<br>2 + 1 + 1 + 1 + 1 + 1<br>1 + 1 + … + 1</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">num_partition</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""factors &lt;= k"""</span>    res <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token number">1</span>        <span class="token keyword">elif</span> n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token number">0</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            res <span class="token operator">+=</span> num_partition<span class="token punctuation">(</span>n <span class="token operator">-</span> i<span class="token punctuation">,</span> i<span class="token punctuation">)</span>     <span class="token keyword">return</span> resres <span class="token operator">=</span> num_partition<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是老师的代码<br>老师分治的思想是：<br>我选择一条路走：<br>    减掉当前k -&gt; n-k, k<br>    不减掉当 前k -&gt; n, k-1<br>把两条路的但按数量相加并返回</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">num_partitions</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Number of distinct ways to express N as a sum of positive    integers each of which is &lt;= K, where K &gt; 0. (The empty sum is 0.)"""</span>    <span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0</span>    <span class="token keyword">elif</span> k <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">1</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> num_partitions<span class="token punctuation">(</span>n <span class="token operator">-</span> k<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+</span> num_partitions<span class="token punctuation">(</span>n<span class="token punctuation">,</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2022 Spring的新版课程中又给了这么一段代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">count_partitionss</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    &gt;&gt;&gt; count_partitions(6, 4)    9    """</span>    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">1</span>    <span class="token keyword">elif</span> n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0</span>    <span class="token keyword">elif</span> m <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        with_m <span class="token operator">=</span> count_partitionss<span class="token punctuation">(</span>n<span class="token operator">-</span>m<span class="token punctuation">,</span> m<span class="token punctuation">)</span>        without_m <span class="token operator">=</span> count_partitionss<span class="token punctuation">(</span>n<span class="token punctuation">,</span> m<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> with_m <span class="token operator">+</span> without_m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="又见汉诺塔"><a href="#又见汉诺塔" class="headerlink" title="又见汉诺塔"></a>又见汉诺塔</h5><p>今天配合着老师的交互程序重新认识了汉诺塔<br>曾今自己也是一知半解，并且将近一年都没有深入理解为什么这么可以，这么不可以<br>短短几行代码也是背过了事<br>但是今天，我似乎终于开窍了</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> shutil <span class="token keyword">import</span> move<span class="token keyword">from</span> tracemalloc <span class="token keyword">import</span> start<span class="token keyword">def</span> <span class="token function">move_tower</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> start_peg<span class="token punctuation">,</span> end_peg<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>        move_disk<span class="token punctuation">(</span>start_peg<span class="token punctuation">,</span> end_peg<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        spare_peg <span class="token operator">=</span> <span class="token number">6</span> <span class="token operator">-</span> start_peg <span class="token operator">-</span> end_peg        move_tower<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> start_peg<span class="token punctuation">,</span> spare_peg<span class="token punctuation">)</span>        move_disk<span class="token punctuation">(</span>start_peg<span class="token punctuation">,</span> end_peg<span class="token punctuation">)</span>        move_tower<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> spare_peg<span class="token punctuation">,</span> end_peg<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">move_disk</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"---&gt;"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>move_tower<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:1 ---&gt; 31 ---&gt; 23 ---&gt; 21 ---&gt; 32 ---&gt; 12 ---&gt; 31 ---&gt; 3"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里对于 start，spare和end的理解至关重要</p><p>start:起始的地方<br>end:目的地<br>spare:除了start和end之外的那个</p><p>经典思路分为四步：<br>n 为盘子的个数</p><ol><li>若 n == 1,直接 start -&gt; end</li><li>若n &gt; 1，将除了最底下的上面 n-1 盘子挪到空闲地点，即 start -&gt; spare</li><li>将最后一个，即第 n 个盘子挪到终点，即 start -&gt; end</li><li>将空闲地点中的所有盘子移动到目的地</li></ol><p>第一步很好懂，第三步可以直接操作，然而 2 和 4 对于程序初心者却听起来匪夷所思。<br>说得轻巧，直接把上面 n-1 个挪到空闲地点，可是我们一次只能移动一次，该怎么做？<br><strong>这里就开始递归了。</strong><br>我们的目标很明确，程序一次只能只能执行一条语句。<br>此时我们的目标是将 n-1 个盘子挪到空闲盘子，因此递归调用函数，传入 n-1, start_ped, spare_ped。<br>理解如何传参非常重要。<br>我们的 start, spare, end 并不是绝对的。<br>可以将汉诺塔的执行看作一个巨大的状态机，<br>每一步状态都有自己的 start, spare和end。<br>对于初始状态来说，即n个盘子都堆叠在原始位置，此时的 start 和 end 就是图中的 1 和 3。<br>然而将 n-1 个盘子放到空闲地点时，状态转换，进入一层递归，来到一个新的状态机，此时的 start 和 end 分别是 1, 2。<br>我们需要把每一个状态都是平等的。<br>每一个状态的个人目的不同(盘子i的st-&gt;盘子i的ed)，但最终目的是相同的(n个盘子整体的st-&gt;n个盘子整体的ed)。<br>在状态转换中，盘子可能会从形形色色的 start 被转到形形色色的 end，但是最终目的都是为了达成初始状态的目的： 1 -&gt; 3。<br>在将 n-1 个盘子挪到空闲地点时，他也是很纯粹的，他不知道自己的命运是什么，他和初始状态一样，只是为了达成 start -&gt; end。<br>每个人只知道自己的 start 和 end 是什么，不知道别人的是什么。<br>因此程序就在一次一次的递归中履行自己的使命。<br>中间的细节一次次地被分解，一次次地递归，直到最后是个原子操作：将一个盘子从属于他的 start 挪到只属于他的 end。<br>于是乎，故事开始了。<br>他执行了自己的任务，他的一生结束了。他不知道自己的结束会产生什么影响，因为正如前面所说，每个状态机都是平等的。<br>然而，程序设计者，以及我们的机器，却有个很大的阴谋。<br><strong>从每一个原子操作的结束开始，回溯便开始了。</strong><br>由于只能挪动一个盘子，每一次原子操作的执行都会影响比他多一个盘子的那个状态机的执行。<br>无数细小的操作只是为了完成一个相对看起来很大的操作，而这个大操作在更大的任务下又显得微不足道。</p><p>理解递归程序是个难点，但非常重要。<br>要充分理解这个程序的整体目标，同时要兼顾子状态的局部目标即兼顾全局性和局部性，也可以看作个人的长远目标和短期目标。而认识到这一点非常重要的是，理解 start 和 end 也具有相对性，对于每一步操作来说他们不一定是相同的标号（即1、2或是3）。但是这个标号对于他们来说便是一生的经历。每个人都一样。</p><h2 id="关于异常"><a href="#关于异常" class="headerlink" title="关于异常"></a>关于异常</h2><p>只是简单介绍了一下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>    <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'myfile'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">except</span> FileNotFoundError<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'oops'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="反转数字"><a href="#反转数字" class="headerlink" title="反转数字"></a>反转数字</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">reverse_digits</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Assuming N &gt;= 0 is an integer.  Return the number whose    base-10 representation is the reverse of that of N.    &gt;&gt;&gt; reverse_digits(0)    0    &gt;&gt;&gt; reverse_digits(1)    1    &gt;&gt;&gt; reverse_digits(123)    321    &gt;&gt;&gt; reverse_digits(10)    1    &gt;&gt;&gt; reverse_digits(12321)    12321    &gt;&gt;&gt; reverse_digits(2222222)    2222222    &gt;&gt;&gt; reverse_digits(102)    201    """</span>    <span class="token keyword">assert</span> <span class="token builtin">type</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token builtin">int</span> <span class="token keyword">and</span> n <span class="token operator">&gt;=</span> <span class="token number">0</span>    <span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> n    <span class="token keyword">return</span> reverse_digits<span class="token punctuation">(</span>n <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>n <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">**</span> <span class="token punctuation">(</span>num_digits<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">num_digits</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Return the number of decimal digits in the positive integer X."""</span>    x_count <span class="token operator">=</span> <span class="token number">1</span>    <span class="token keyword">while</span> x <span class="token operator">&gt;=</span> <span class="token number">10</span><span class="token punctuation">:</span>        x_count <span class="token operator">+=</span> <span class="token number">1</span>        x <span class="token operator">//=</span> <span class="token number">10</span>    <span class="token keyword">return</span> x_count<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="反转数字（字符串版本）"><a href="#反转数字（字符串版本）" class="headerlink" title="反转数字（字符串版本）"></a>反转数字（字符串版本）</h5><p>python的黑魔法</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">reverse_digits</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="整数移除数字"><a href="#整数移除数字" class="headerlink" title="整数移除数字"></a>整数移除数字</h5><p>我是这么写的<br>考虑从低位开始算<br>但是从高位会更方便</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">remove_digit</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">:</span>    res <span class="token operator">=</span> <span class="token number">0</span>    i <span class="token operator">=</span> <span class="token number">1</span>    <span class="token keyword">while</span> x <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>        tmp <span class="token operator">=</span> x <span class="token operator">%</span> <span class="token number">10</span>        x <span class="token operator">//=</span> <span class="token number">10</span>        <span class="token keyword">if</span> tmp <span class="token operator">!=</span> <span class="token number">5</span><span class="token punctuation">:</span>            res <span class="token operator">=</span> res <span class="token operator">+</span> tmp <span class="token operator">*</span> i            i <span class="token operator">*=</span> <span class="token number">10</span>       <span class="token keyword">return</span> resx <span class="token operator">=</span> remove_digit<span class="token punctuation">(</span><span class="token number">3141592653589793</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">3141926389793</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output3141926389793True"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>老师的代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">remove_digit</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> digit<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Assuming N&gt;=0, 0 &lt;= DIGIT &lt;= 9, return a number whose    base-10 representation is the same as N, but with all instances of    DIGIT removed.  If all digits removed, return 0.    &gt;&gt;&gt; remove_digit(123, 3)    12    &gt;&gt;&gt; remove_digit(1234, 5)    1234    &gt;&gt;&gt; remove_digit(1234, 1)    234    &gt;&gt;&gt; remove_digit(111111, 1)    0    """</span>    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0</span>    <span class="token keyword">if</span> n <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> digit<span class="token punctuation">:</span>        <span class="token keyword">return</span> remove_digit<span class="token punctuation">(</span>n <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">,</span> digit<span class="token punctuation">)</span>    <span class="token keyword">return</span> n <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">+</span> remove_digit<span class="token punctuation">(</span>n <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">,</span> digit<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span>    <span class="token string">""</span>"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是我考虑用递归的方式做的<br>我们都考虑当前低位，如果是要移除的数字，<br>我选择直接将这个数字去掉，然后进入下一层递归<br>老师选择直接进入下一层递归，传递 % 10 之后的数字<br>其实殊途同归<br>将递归返回的高位数字们*10再加上当前的数字<br>老师直接不加要移除的数字进入递归，我是直接在自己身上移除然后进入递归罢了</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">remove_digit</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> digit<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""remove all the digit in n"""</span>    <span class="token triple-quoted-string string">"""solving by recursion"""</span>    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0</span>    <span class="token keyword">if</span> n <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> digit<span class="token punctuation">:</span>        n <span class="token operator">//=</span> <span class="token number">10</span>    <span class="token keyword">return</span> remove_digit<span class="token punctuation">(</span>n <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">,</span> digit<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> n <span class="token operator">%</span> <span class="token number">10</span>    x <span class="token operator">=</span> remove_digit<span class="token punctuation">(</span><span class="token number">3141592653589793</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">3141926389793</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:3141926389793True"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>总结：其实这个递归层层抽离下去，最后一层叶子节点实际上是最高位，因此返回最高位到倒数第二层后我们要<em>10，层层把位权进上去，因此在递归部分要</em>10，然后考虑当前位是否可以被删掉，如果可以就不用管，如果不可以就要加上最低位</p><p>例如我们要实现 <code>reomve_digit(12353, 3)</code><br>执行流程：</p><hr><p>layer1<br>12353<br>可以移除低位 n //= digit = 1235<br>递归 remove_digit(1235, 3)</p><hr><p>layer2<br>1235<br>不可以移除低位<br>递归 remove_digit(123, 3) * 10 + (1235) % 10</p><hr><p>layer3<br>123<br>可以移除低位<br>递归 remove_digit(12, 3)</p><hr><p>layer4<br>12<br>不可以移除低位<br>递归 remove_digit(1, 3) * 10 + (12) % 10</p><hr><p>layer5<br>1<br>不可以移除低位<br>递归 remove_digit(0, 3) + (1) % 10</p><hr><p>layer6<br>0<br>直接返回0</p><hr><p>layer5<br>return 1</p><hr><p>layer4<br>return 10 + 2 = 12</p><hr><p>layer3<br>return 12</p><hr><p>layer2<br>return 120 + 5 = 125</p><hr><p>layer1<br>return 125</p><hr><p>函数返回 return 125</p><h5 id="循环接力"><a href="#循环接力" class="headerlink" title="循环接力"></a>循环接力</h5><p>又是Python的黑魔法</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">cycle</span><span class="token punctuation">(</span>f1<span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f3<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Returns a function that is itself a higher-order function.    &gt;&gt;&gt; def add1(x):    ...     return x + 1    &gt;&gt;&gt; def times2(x):    ...     return x * 2    &gt;&gt;&gt; def add3(x):    ...     return x + 3    &gt;&gt;&gt; my_cycle = cycle(add1, times2, add3)    &gt;&gt;&gt; identity = my_cycle(0)    &gt;&gt;&gt; identity(5)    5    &gt;&gt;&gt; add_one_then_double = my_cycle(2)    &gt;&gt;&gt; add_one_then_double(1)    4    &gt;&gt;&gt; do_all_functions = my_cycle(3)    &gt;&gt;&gt; do_all_functions(2)    9    &gt;&gt;&gt; do_more_than_a_cycle = my_cycle(4)    &gt;&gt;&gt; do_more_than_a_cycle(2)    10    &gt;&gt;&gt; do_two_cycles = my_cycle(6)    &gt;&gt;&gt; do_two_cycles(1)    19    """</span>    <span class="token string">"*** YOUR CODE HERE ***"</span>    <span class="token keyword">def</span> <span class="token function">set_term</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">def</span> <span class="token function">get_function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>                    x <span class="token operator">=</span> f1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>                <span class="token keyword">elif</span> i <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>                    x <span class="token operator">=</span> f2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>                <span class="token keyword">else</span><span class="token punctuation">:</span>                    x <span class="token operator">=</span> f3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>            <span class="token keyword">return</span> x        <span class="token keyword">return</span> get_function    <span class="token keyword">return</span> set_term<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="关于-修饰符"><a href="#关于-修饰符" class="headerlink" title="关于@修饰符"></a>关于@修饰符</h2><p>这是 python 的一个语法糖<br>@紧跟的函数是被修饰函数，将被修饰函数作为函数参数传入本体，<br>当解释器读取到@修饰符时候，就会调用本体<br>还没搞太懂<br>目前可以推测，在使用修饰符时，被修饰函数的参数可以被接收到</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">Parent</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">inner</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'I am Parent'</span><span class="token punctuation">)</span>        f<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> inner<span class="token decorator annotation punctuation">@Parent</span><span class="token keyword">def</span> <span class="token function">being_decorated</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"I am decorated by Parent adn my argument is "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>being_decorated<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="关于数据集合"><a href="#关于数据集合" class="headerlink" title="关于数据集合"></a>关于数据集合</h2><p>所谓集合其实就是各种存放单个数据类型的容器（container）<br>例如tuple,list,set,map,range等</p><p>List的骚操作</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">[</span> <span class="token operator">&lt;</span>expr<span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token operator">&lt;</span>var<span class="token operator">&gt;</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>sequence expr<span class="token operator">&gt;</span> <span class="token keyword">if</span> <span class="token operator">&lt;</span>bollean expr<span class="token operator">&gt;</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python">x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>x <span class="token operator">=</span> <span class="token punctuation">[</span>_ <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>                         <span class="token keyword">if</span> _ <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">and</span> _ <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment"># [2, 3, 4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="数字匹配"><a href="#数字匹配" class="headerlink" title="数字匹配"></a>数字匹配</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">matches</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Return the number of values k such that A[k] == B[k].    &gt;&gt;&gt; matches([1, 2, 3, 4, 5], [3, 2, 3, 0, 5])    3    &gt;&gt;&gt; matches("abdomens", "indolence")    4    &gt;&gt;&gt; matches("abcd", "dcba")    0    &gt;&gt;&gt; matches("abcde", "edcba")    1    &gt;&gt;&gt; matches("abcdefg", "edcba")    1    """</span>    <span class="token comment"># sum(1 for _ in range(min(len(a), len(b))) if a[_] == b[_])</span>    <span class="token comment"># return sum(a[_] == b[_] for _ in range(min(len(a), len(b))))</span>    <span class="token keyword">return</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">==</span> y<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">zip</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> x <span class="token operator">=</span> matches<span class="token punctuation">(</span><span class="token string">"abcdefg"</span><span class="token punctuation">,</span> <span class="token string">"edcba"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>x <span class="token comment">#1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="阶梯输出"><a href="#阶梯输出" class="headerlink" title="阶梯输出"></a>阶梯输出</h5><p>虽然py很方便，但是写这种代码我自己都想抽我自己</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> __ <span class="token operator">+</span> <span class="token number">1</span> <span class="token keyword">for</span> __ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这样更直观</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> ed <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> ed <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="关于可变对象和不可变对象"><a href="#关于可变对象和不可变对象" class="headerlink" title="关于可变对象和不可变对象"></a>关于可变对象和不可变对象</h2><p>可变对象：list, dictionary, set<br>不可变对象：tuple, string, int, float, bool</p><p>所谓可不可变，指的是这个数据类型本身能否原地改变<br>如果可以原地改变（id不变），说明是<strong>可变的</strong><br>如果不可以原地改变，而是需要另辟蹊径，在新的地址上重建，则是<strong>不可变的</strong></p><h5 id="不可变类型"><a href="#不可变类型" class="headerlink" title="不可变类型"></a>不可变类型</h5><p><strong>int</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">a_int <span class="token operator">=</span> <span class="token number">99</span><span class="token keyword">print</span><span class="token punctuation">(</span>a_int<span class="token punctuation">,</span> <span class="token string">'id: '</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>a_int<span class="token punctuation">)</span><span class="token punctuation">)</span>a_int <span class="token operator">=</span> <span class="token number">100</span><span class="token keyword">print</span><span class="token punctuation">(</span>a_int<span class="token punctuation">,</span> <span class="token string">'id: '</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>a_int<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:99 id:  2110767697200100 id:  2110767697232"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作为函数参数传入的 int 也是将自己传了进去</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'=====into the function====='</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'=====out of the function====='</span><span class="token punctuation">)</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>f<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:1 2391123362032=====into the function=====1 2391123362032=====out of the function=====1 2391123362032"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>string</strong><br>对 string 的 += 操作实际上开辟了一块新的内存<br>将原内存的值加上新的值赋给新内存</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"fuck u man"</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token string">'id: '</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token builtin">str</span> <span class="token operator">+=</span> <span class="token string">"!!!"</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token string">'id: '</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:fuck u man id:  1765836130864fuck u man!!! id:  1765836193968"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>tuple</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'=====into the function====='</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'=====out of the function====='</span><span class="token punctuation">)</span>t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>f<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:(1, 2, 3) 1596294046080=====into the function=====(1, 2, 3) 1596294046080=====out of the function=====(1, 2, 3) 1596294046080"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="可变对象"><a href="#可变对象" class="headerlink" title="可变对象"></a>可变对象</h5><p><strong>list</strong><br>此外还可以发现，将可变类型赋值给另一个变量后，<br>实际上两个指向同一个地址<br>修改其中一个列表的值会连坐</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token string">'id: '</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>l<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">99999</span><span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token string">'id: '</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>l_2 <span class="token operator">=</span> l<span class="token keyword">print</span><span class="token punctuation">(</span>l_2<span class="token punctuation">,</span> <span class="token string">'id: '</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l_2<span class="token punctuation">)</span><span class="token punctuation">)</span>l_2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">12345</span><span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> l_2<span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:[1, 2, 3] id:  2019422582592[99999, 2, 3] id:  2019422582592[99999, 2, 3] id:  2019422582592[12345, 2, 3] [12345, 2, 3]"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>还可以观察到，传进函数的List和global下的List<br>实际上是同一个list</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'=====into the function====='</span><span class="token punctuation">)</span>    x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'=====out of the function====='</span><span class="token punctuation">)</span>l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>f<span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:[1, 2, 3, 4, 5] 1286340556608=====into the function=====[100, 2, 3, 4, 5] 1286340556608=====out of the function=====[100, 2, 3, 4, 5] 1286340556608"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>且函数内可以访问父框架中的变量</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    l<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:[1, 2, 3, 4, 5] 2507531499328[100, 2, 3, 4, 5] 2507531499328[100, 2, 3, 4, 5] 2507531499328"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>不管传入的是什么，在python中，<br>不存在<code>虚实结合</code>这一概念，传入函数的都是对象本身的地址，因此对于可变类型，在函数内修改会确确实实影响到该变量。</p><p>如果我们在函数中给整个变量赋新值会怎么样？</p><p>如果作为函数参数传入，局部框架中的 x 会不再指向我们传入的list，而是指向一个新的生存期在局部的list</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>f<span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:[9, 9, 9] 2455699404608[1, 2, 3] 2455699327552[9, 9, 9] 2455699404608"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果我们不传入参数<br>也没啥影响，因为我们重新赋值了<br>这样子可变对象就重新在一块新内存赋值了一个List<br>这个新的变量作用局部框架<br>全局的并没有被改变</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:[9, 9, 9] 2202816231232[1, 2, 3] 2202816154176[9, 9, 9] 2202816231232"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>有了这些前置的小实验，我么也可以很好地理解<br>为什么可以修改 tuple 中的内嵌 list了</p><p>我们不可以修改 tuple，指的是不能原地修改 tuple 中存储的值<br>我们存储了这个 list 的地址，我们并不是直接修改 tuple<br>tuple还是原来的，没有动过<br>只不过它 idx = 2 上寸的那个地址指向的 List 被修改了<br>tuple 中寸的地址没人去动</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'fucku'</span><span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:(1, 2, [1, 2, 3, 4])(1, 2, ['fucku', 2, 3, 4])"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果使用 pytutor 观察<br>你会有种强烈的预感：python，一切皆指针<br>观察py代码，编写py代码，句句不提指针，句句不离指针</p><h2 id="关于copy一个List"><a href="#关于copy一个List" class="headerlink" title="关于copy一个List"></a>关于copy一个List</h2><p>其中，listA,listB 指向同一个list<br>listC, listD 分别指向一个新的list</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">listA <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>listB <span class="token operator">=</span> listAlistC <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>listA<span class="token punctuation">)</span>listD <span class="token operator">=</span> listB<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>list()可以将任何 iterable 的对象转换成一个List</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">listA <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span><span class="token string">'banana'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>listA<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>listA<span class="token punctuation">)</span><span class="token punctuation">)</span>listB <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>listA<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>listB<span class="token punctuation">,</span> Type<span class="token punctuation">(</span>listB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:(1, 2, {'a': 'apple', 'b': 'banana'}) &lt;class 'tuple'&gt;[1, 2, {'a': 'apple', 'b': 'banana'}] &lt;class 'list'&gt;"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="关于-class"><a href="#关于-class" class="headerlink" title="关于 class"></a>关于 class</h2><p>__init__ 可以看作构造函数<br>成员函数的第一个参数都是当前对象，名字可以自己制定</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Product</span><span class="token punctuation">:</span>    _sales_tax <span class="token operator">=</span> <span class="token number">0.07</span>   <span class="token comment"># 成员变量</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> price<span class="token punctuation">,</span> nutrition_info<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>_name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>_price <span class="token operator">=</span> price        self<span class="token punctuation">.</span>_nutrition_info <span class="token operator">=</span> nutrition_info        self<span class="token punctuation">.</span>_inventory <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">increase_inventory</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>         self<span class="token punctuation">.</span>_inventory <span class="token operator">+=</span> amount    <span class="token keyword">def</span> <span class="token function">decrease_inventory</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>_inventory <span class="token operator">-=</span> amount        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_inventory <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Oh No!"</span><span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">get_nutrition_label</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"|"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_nutrition_info<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">get_inventory_report</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"We have </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>_inventory<span class="token punctuation">}</span></span><span class="token string"> bars"</span></span>    pizza <span class="token operator">=</span> Product<span class="token punctuation">(</span><span class="token string">"fruit pizza"</span><span class="token punctuation">,</span> <span class="token number">7.00</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"24 g sugar"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>成员函数只是个普通的函数<br>而对象的成员函数是绑定到这个类的一个绑定函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>Product<span class="token punctuation">.</span>increase_inventory<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>pizza<span class="token punctuation">.</span>increase_inventory<span class="token punctuation">)</span><span class="token triple-quoted-string string">"""output:&lt;function Product.increase_inventory at 0x000001B8E40AE950&gt;&lt;bound method Product.increase_inventory of &lt;__main__.Product object at 0x000001B8E408BFD0&gt;&gt;"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因此，这两种调用方式是完全等效的</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">pizza<span class="token punctuation">.</span>increase_inventory<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>Product<span class="token punctuation">.</span>increase_inventory<span class="token punctuation">(</span>pizza<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>上面的 f”…{variableName}…”是字符串格式化的一种方式<br>相当于 “…” + variableName + “…” 但是这样子可读性不强</p><p>如果某个对象引用一个成员变量。会现在这个对象里找，没找到就会去类里面找<br>因为实际上某个对象被创建出来，它的内存空间里不存放成员变量，只有.出来后才会创建</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">pizza <span class="token operator">=</span> Product<span class="token punctuation">(</span><span class="token string">"fruit pizza"</span><span class="token punctuation">,</span> <span class="token number">7.00</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"24 g sugar"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>dog <span class="token operator">=</span> Product<span class="token punctuation">(</span><span class="token string">"fruit pizza"</span><span class="token punctuation">,</span> <span class="token number">7.00</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"24 g sugar"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>pizza<span class="token punctuation">.</span>_sales_tax<span class="token punctuation">)</span> <span class="token comment"># 0.07</span><span class="token keyword">print</span><span class="token punctuation">(</span>dog<span class="token punctuation">.</span>_sales_tax<span class="token punctuation">)</span>   <span class="token comment"># 0.07</span>pizza<span class="token punctuation">.</span>_sales_tax <span class="token operator">=</span> <span class="token number">99</span><span class="token keyword">print</span><span class="token punctuation">(</span>pizza<span class="token punctuation">.</span>_sales_tax<span class="token punctuation">)</span> <span class="token comment"># 99</span><span class="token keyword">print</span><span class="token punctuation">(</span>dog<span class="token punctuation">.</span>_sales_tax<span class="token punctuation">)</span>   <span class="token comment"># 0.07</span>Product<span class="token punctuation">.</span>_sales_tax <span class="token operator">=</span> <span class="token number">1000000</span><span class="token keyword">print</span><span class="token punctuation">(</span>pizza<span class="token punctuation">.</span>_sales_tax<span class="token punctuation">)</span> <span class="token comment"># 99</span><span class="token keyword">print</span><span class="token punctuation">(</span>dog<span class="token punctuation">.</span>_sales_tax<span class="token punctuation">)</span>   <span class="token comment">#1000000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>python的对象访问非常随意，不存在private</p><p>因此会有一些命名规范<br>__ 双下划线：private<br>_单下划线：半private<br>没有下划线：public</p>]]></content>
      
      
      <categories>
          
          <category> SICP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基本计算和自动微分</title>
      <link href="/2022/05/05/%E5%9F%BA%E6%9C%AC%E8%AE%A1%E7%AE%97%E5%92%8C%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86/"/>
      <url>/2022/05/05/%E5%9F%BA%E6%9C%AC%E8%AE%A1%E7%AE%97%E5%92%8C%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86/</url>
      
        <content type="html"><![CDATA[<h1 id="矩阵计算"><a href="#矩阵计算" class="headerlink" title="矩阵计算"></a>矩阵计算</h1><p>终于下决心把这块儿搞搞明白了……</p><h3 id="1-标量导数"><a href="#1-标量导数" class="headerlink" title="1. 标量导数"></a>1. 标量导数</h3><p><img src="https://img-blog.csdnimg.cn/b5c10c3eac2140aabe7dad3b5af13d91.png" alt="img" style="zoom: 80%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/2c97a3ef701d4f9e91983f2e69618a41.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="2-亚导数"><a href="#2-亚导数" class="headerlink" title="2. 亚导数"></a>2. 亚导数</h3><p><img src="https://img-blog.csdnimg.cn/ceefe04e060f4d0e8f85ccc60a22932e.png" alt="img" style="zoom: 50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/96dd7e65930d47329e5f3493a51dd17e.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="3-梯度"><a href="#3-梯度" class="headerlink" title="3. 梯度"></a>3. 梯度</h3><p><img src="https://img-blog.csdnimg.cn/1030439e199442218e0cbcf7ed703ce3.png" alt="img" style="zoom:67%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="标量-列向量"><a href="#标量-列向量" class="headerlink" title="标量 / 列向量"></a>标量 / 列向量</h5><p><code>标量</code>关于<code>列向量</code>的导数是个<code>行向量</code></p><p>梯度指向值变化最快的方向</p><p><img src="https://img-blog.csdnimg.cn/e273fc9960e641b28dd2c8e8ff072a73.png" alt="img" style="zoom: 50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/c1e403540f6248ad9bdbf08d78ebdeab.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="列向量-标量"><a href="#列向量-标量" class="headerlink" title="列向量 / 标量"></a>列向量 / 标量</h5><p><code>列向量</code>关于<code>标量</code>的导数还是<code>列向量</code></p><p><img src="https://img-blog.csdnimg.cn/d49b34cd88b44fcbbb8f2bf83b80e728.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="列向量-列向量"><a href="#列向量-列向量" class="headerlink" title="列向量 / 列向量"></a>列向量 / 列向量</h5><p>列向量对列向量求导是个矩阵。</p><p>可以看作列向量 <strong>y</strong> 的每个元素（是个标量）对列向量<strong>x</strong>求导，得到一个行向量，由此n个元素得到n个行向量，形成矩阵。 </p><p><img src="https://img-blog.csdnimg.cn/cf4d67b6754c4752a71fd9d40f1571ec.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/bc2f49128355462386142040540ace32.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/f8d05f20189b41409058462f9ca39ee7.png" alt="img" style="zoom:67%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/ee2dd030d8a64a8d95543eabc43ed8d5.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h1 id="自动求导"><a href="#自动求导" class="headerlink" title="自动求导"></a>自动求导</h1><h3 id="1-向量链式法则"><a href="#1-向量链式法则" class="headerlink" title="1. 向量链式法则"></a>1. 向量链式法则</h3><p><img src="https://img-blog.csdnimg.cn/f90e78545c8b49ffb6436c2ab9365f56.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>例1</p><p><img src="https://img-blog.csdnimg.cn/922a873f98014d2c89a057338b337c17.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>例2</p><p><img src="https://img-blog.csdnimg.cn/35c3598ccebc428bb418e7f1a6586210.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="2-自动求导"><a href="#2-自动求导" class="headerlink" title="2. 自动求导"></a>2. 自动求导</h3><p><img src="https://img-blog.csdnimg.cn/ae1aab2e281e49489b08a8defffee4f4.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="计算图"><a href="#计算图" class="headerlink" title="计算图"></a>计算图</h5><p><img src="https://img-blog.csdnimg.cn/a6a6938e5296470e9ddb7326f1400055.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/5463af8dd35e4c959c76e1757bec4542.png" alt="img" style="zoom: 33%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/fd5cc3e203a447acacc5a06f407cdaef.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/a59982254d574427b7dbf4b30204d21b.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/80a1689e87cb4865870868616ef82d83.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/9692dc3928744cf5afcfae277a792f5a.png" alt="img" style="zoom:50%;"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
      
      
      <categories>
          
          <category> DL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 矩阵计算 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openCV 基础操作</title>
      <link href="/2022/04/30/openCV%20-%20%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/"/>
      <url>/2022/04/30/openCV%20-%20%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h1 id="openCV-基础操作"><a href="#openCV-基础操作" class="headerlink" title="openCV 基础操作"></a>openCV 基础操作</h1><p>由于后期需要用到 openCV 处理图像上的一些数据，因此五一这段时间正好学一下基础操作。具体的图像知识还需要底下多花点时间，毕竟调包小子这名字不太好听是吧。</p><h3 id="1-读取图像"><a href="#1-读取图像" class="headerlink" title="1. 读取图像"></a>1. 读取图像</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgcodecs.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgproc.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>string path <span class="token operator">=</span> <span class="token string">"Resources/img/1.png"</span><span class="token punctuation">;</span>Mat img <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Mat 是 openCV 引入的存储图像的数据类型。</p><h3 id="2-读取视频"><a href="#2-读取视频" class="headerlink" title="2. 读取视频"></a>2. 读取视频</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgcodecs.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgproc.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>string path <span class="token operator">=</span> <span class="token string">"Resources/test_video.mp4"</span><span class="token punctuation">;</span>VideoCapture <span class="token function">cap</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>Mat img<span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>cap<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读取视频中的每一帧</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>视频播放结束后会抛出一个异常。</p><h3 id="3-摄像头"><a href="#3-摄像头" class="headerlink" title="3. 摄像头"></a>3. 摄像头</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgcodecs.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgproc.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>VideoCapture <span class="token function">cap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Mat img<span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>cap<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读取视频中的每一帧</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-转换至灰度图像"><a href="#3-转换至灰度图像" class="headerlink" title="3. 转换至灰度图像"></a>3. 转换至灰度图像</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgcodecs.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgproc.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>string path <span class="token operator">=</span> <span class="token string">"Resources/test.png"</span><span class="token punctuation">;</span>Mat img <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>Mat imgGray<span class="token punctuation">;</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> imgGray<span class="token punctuation">,</span> COLOR_BGR2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Gray"</span><span class="token punctuation">,</span> imgGray<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>openCV中使用 <code>GBR</code> 而不是 <code>RGB</code>。</p><p>目前还不太了解参数，只知道 Size(7, 7),5 比 Size(3, 3), 3 更加模糊。</p><p><img src="https://img-blog.csdnimg.cn/14ed1aa7efbd4f5eb2cf3bbcb8b1003c.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="4-边缘检测"><a href="#4-边缘检测" class="headerlink" title="4. 边缘检测"></a>4. 边缘检测</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgcodecs.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgproc.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>string path <span class="token operator">=</span> <span class="token string">"Resources/test.png"</span><span class="token punctuation">;</span>Mat img <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>Mat imgGray<span class="token punctuation">;</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> imgGray<span class="token punctuation">,</span> COLOR_BGR2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>Mat imgBlur<span class="token punctuation">;</span><span class="token function">GaussianBlur</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> imgBlur<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Mat imgCanny<span class="token punctuation">,</span> imgCanny2<span class="token punctuation">;</span><span class="token function">Canny</span><span class="token punctuation">(</span>imgBlur<span class="token punctuation">,</span> imgCanny<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Canny</span><span class="token punctuation">(</span>imgBlur<span class="token punctuation">,</span> imgCanny2<span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Gray"</span><span class="token punctuation">,</span> imgGray<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Blur"</span><span class="token punctuation">,</span> imgBlur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Canny"</span><span class="token punctuation">,</span> imgCanny<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Canny2"</span><span class="token punctuation">,</span> imgCanny2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/8b751c6d13bd4d658c9cb52003be4a0a.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="5-dilate-扩大-amp-erode-侵蚀-图像"><a href="#5-dilate-扩大-amp-erode-侵蚀-图像" class="headerlink" title="5. dilate(扩大) &amp; erode(侵蚀)图像"></a>5. dilate(扩大) &amp; erode(侵蚀)图像</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgcodecs.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgproc.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>string path <span class="token operator">=</span> <span class="token string">"Resources/test.png"</span><span class="token punctuation">;</span>Mat img <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>Mat imgGray<span class="token punctuation">;</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> imgGray<span class="token punctuation">,</span> COLOR_BGR2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>Mat imgBlur<span class="token punctuation">;</span><span class="token function">GaussianBlur</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> imgBlur<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Mat imgCanny<span class="token punctuation">,</span> imgCanny2<span class="token punctuation">;</span><span class="token function">Canny</span><span class="token punctuation">(</span>imgBlur<span class="token punctuation">,</span> imgCanny<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Mat imgDil<span class="token punctuation">;</span>Mat kernel <span class="token operator">=</span> <span class="token function">getStructuringElement</span><span class="token punctuation">(</span>MORPH_RECT<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">dilate</span><span class="token punctuation">(</span>imgCanny<span class="token punctuation">,</span> imgDil<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span><span class="token punctuation">;</span>Mat imgErode<span class="token punctuation">;</span><span class="token function">erode</span><span class="token punctuation">(</span>imgDil<span class="token punctuation">,</span> imgErode<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Gray"</span><span class="token punctuation">,</span> imgGray<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Blur"</span><span class="token punctuation">,</span> imgBlur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Canny"</span><span class="token punctuation">,</span> imgCanny<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Dilation"</span><span class="token punctuation">,</span> imgDil<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Erode"</span><span class="token punctuation">,</span> imgErode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用于增加厚度，减小厚度。</p><p><img src="https://img-blog.csdnimg.cn/ca16968805a745f494a7395afc9bcd75.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/54e33e8e4b4141a1b831daae944290c9.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="6-调整大小-amp-裁剪图像"><a href="#6-调整大小-amp-裁剪图像" class="headerlink" title="6. 调整大小 &amp; 裁剪图像"></a>6. 调整大小 &amp; 裁剪图像</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgcodecs.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgproc.hpp&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>string path <span class="token operator">=</span> <span class="token string">"Resources/test.png"</span><span class="token punctuation">;</span>Mat img <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// cout &lt;&lt; img.size() &lt;&lt; endl; 776 x 559</span>Mat imgResize<span class="token punctuation">;</span><span class="token function">resize</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> imgResize<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">480</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 指定 dst 大小</span>Mat imgResize2<span class="token punctuation">;</span><span class="token function">resize</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> imgResize2<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 按比例缩放</span>Rect <span class="token function">roi</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 指定起点和长宽</span>Mat imgCrop <span class="token operator">=</span> <span class="token function">img</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Resize"</span><span class="token punctuation">,</span> imgResize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Resize2"</span><span class="token punctuation">,</span> imgResize2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Image Crop"</span><span class="token punctuation">,</span> imgCrop<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/0efc1b3f90704bdeb1283a0610b1986b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/b5bec07fee8c4570aedef75566021d70.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
      
      
      <categories>
          
          <category> 图像处理 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openCV </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openGL配置-个人用</title>
      <link href="/2022/04/29/openGL%E9%85%8D%E7%BD%AE-%E4%B8%AA%E4%BA%BA%E7%94%A8/"/>
      <url>/2022/04/29/openGL%E9%85%8D%E7%BD%AE-%E4%B8%AA%E4%BA%BA%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="openGL配置属性一劳永逸"><a href="#openGL配置属性一劳永逸" class="headerlink" title="openGL配置属性一劳永逸"></a>openGL配置属性一劳永逸</h1><p>​    刚开始写一些练习题只是在一个文件夹新建了一个工程一路写到黑，写完一个小工程就把main，着色器程序复制粘贴存下来。后来需要新建新工程了，每次配置环境都太麻烦了，因此学了下如何持久化已设定的配置。</p><h3 id="1-include-目录-amp-库目录（lib）"><a href="#1-include-目录-amp-库目录（lib）" class="headerlink" title="1. include 目录 &amp; 库目录（lib）"></a>1. include 目录 &amp; 库目录（lib）</h3><p><img src="https://img-blog.csdnimg.cn/ae1af821324d463783c4eb30f9d1af02.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="1-1-include-目录"><a href="#1-1-include-目录" class="headerlink" title="1.1 include 目录"></a>1.1 include 目录</h5><p>放需要引入的第三方库的<code>头文件</code>路径</p><p><img src="https://img-blog.csdnimg.cn/09a4687e58c14f5dbc7a4717d114a9a3.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="1-2-库目录"><a href="#1-2-库目录" class="headerlink" title="1.2 库目录"></a>1.2 库目录</h5><p>放对应的  <code>xxx.lib</code></p><p><img src="https://img-blog.csdnimg.cn/33fdf561b3844560b2087e67059a1d54.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>这里的附加include目录和上面好像没啥区别</p><p>我把这两个路径放到 <code>VC++目录</code> 下程序也能照样跑</p><p><img src="https://img-blog.csdnimg.cn/a852fc2168794e55907bd2580837e6cf.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> <img src="https://img-blog.csdnimg.cn/43838667c0d8473089016bb48b6a2794.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="2-动态链接库"><a href="#2-动态链接库" class="headerlink" title="2. 动态链接库"></a>2. 动态链接库</h3><p>目前只用到了这三个库</p><p><img src="https://img-blog.csdnimg.cn/dd139136874f4db8bbc636aefed90e4a.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="3-glad-c"><a href="#3-glad-c" class="headerlink" title="3. glad.c"></a>3. glad.c</h3><p>然后记得把 <code>glad.c</code> 和工程放到同一个目录下</p><p><img src="https://img-blog.csdnimg.cn/37bc06670a3941558455e858331d5b83.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="4-assimp-模型加载库"><a href="#4-assimp-模型加载库" class="headerlink" title="4. assimp 模型加载库"></a>4. assimp 模型加载库</h3><p>把 <code>assimp-xxx.lib</code> 放到Debug或者Release目录下，即和可执行程序同一个目录</p><p><img src="https://img-blog.csdnimg.cn/fa84b83a1fa241f7bf565d036ec5d2cf.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> </p><h3 id="5-引用配置好的属性"><a href="#5-引用配置好的属性" class="headerlink" title="5. 引用配置好的属性"></a>5. 引用配置好的属性</h3><p>在<code>属性管理器</code>右键可以新建一个项目属性表，按照上面的方式配置好保存在一个路径当中就行了。（放哪儿无所谓）</p><p>然后随便开一个新项目，在项目属性表中引用之前我们配置好的属性。</p><p> <img src="https://img-blog.csdnimg.cn/68fabc4468e34f40a86a28fee95141dd.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>成功导入。</p><p><img src="https://img-blog.csdnimg.cn/f93b2d56642c4a62b4c138ce30036f0b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>打开属性页，可以惊奇地发现一切都那么熟悉。</p><p><img src="https://img-blog.csdnimg.cn/e6612b553d3d4c9b957e5fd11b822686.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
      
      
      <categories>
          
          <category> 图形学 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openGL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学一点前端-HTML</title>
      <link href="/2022/04/27/HTML/"/>
      <url>/2022/04/27/HTML/</url>
      
        <content type="html"><![CDATA[<h1 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h1><p>HTML时解释性的文本标记语言，不区分大小写。</p><p>目前了解了这些：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>这是我的的一个蠢蠢的网页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">            <span class="token selector">div</span><span class="token punctuation">{</span>                <span class="token property">width</span><span class="token punctuation">:</span>200px<span class="token punctuation">;</span>                <span class="token property">height</span><span class="token punctuation">:</span>200px<span class="token punctuation">;</span>                <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token selector">#div1</span><span class="token punctuation">{</span>                <span class="token property">background</span><span class="token punctuation">:</span> #AF8<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token selector">#div2</span><span class="token punctuation">{</span>                <span class="token property">background</span><span class="token punctuation">:</span> #AAFF88<span class="token punctuation">;</span>                <span class="token property">left</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>                <span class="token property">top</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token selector">#div3</span><span class="token punctuation">{</span>                <span class="token property">background</span><span class="token punctuation">:</span> #FF8<span class="token punctuation">;</span>                <span class="token property">left</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>                <span class="token property">top</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>标题1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>标题2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>标题3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span>标题4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span><span class="token punctuation">&gt;</span></span>标题5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h6</span><span class="token punctuation">&gt;</span></span>标题6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h6</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!-- &lt;h7&gt;标题7&lt;/h7&gt; 解释不出来就不解释了 浏览器是容错的 --&gt;</span>        HELLO WORLD!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>你好，HTML！        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>第一个段落<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>第二个段落<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">src</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>images/p1.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">width</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">width</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>180<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>这是一张图片<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>武林高手排行榜（有序列表）        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ol</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>A<span class="token punctuation">"</span></span> <span class="token attr-name">start</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>扫地僧<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>萧远山<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>慕容博<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ol</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>武林大会人员名单（无序列表）        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>circle<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>乔峰<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>阿朱<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>马夫人<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        你<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>喜欢<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u</span><span class="token punctuation">&gt;</span></span>吃<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>甜<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>月饼还是<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>咸<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>月饼?        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        水分子的化学式：H<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sub</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sub</span><span class="token punctuation">&gt;</span></span>O<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        氧气的化学式：O<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sup</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sup</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        4 <span class="token entity named-entity" title="<">&amp;lt;</span> 10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        10 <span class="token entity named-entity" title=">">&amp;gt;</span> 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        4 <span class="token entity named-entity" title="≤">&amp;le;</span> 10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        40 <span class="token entity named-entity" title="≥">&amp;ge;</span> 10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        HTML当中的<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>实体<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        版权符号：<span class="token entity named-entity" title="®">&amp;reg;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        商标符号：<span class="token entity named-entity" title="©">&amp;copy;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>对span中的东西进行独立修饰<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>但这好像没啥效果啊<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        超链接        <span class="token comment">&lt;!-- 从http协议写起，这是个绝对路径--&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.baidu.com<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>百度一下<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        这个就是层<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>div1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>div1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>div2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>div2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>div3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>div3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        这里是表格<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">border</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>600<span class="token punctuation">"</span></span> <span class="token attr-name">cellspacing</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">cellpadding</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>姓名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>门派<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>成名绝技<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>内功值<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>乔峰<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>丐帮<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>少林长拳<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>5000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>虚竹<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>灵鹫宫<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>北冥神功<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>15000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>扫地僧<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>少林寺<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>七十二绝技<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>未知<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>600<span class="token punctuation">"</span></span> <span class="token attr-name">cellspacing</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">cellpadding</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span> <span class="token attr-name">border</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>名称<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>单间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>数量<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>小计<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>苹果<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">rowspan</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- 跨多行合并--&gt;</span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>images/delete.png<span class="token punctuation">"</span></span> <span class="token attr-name">width</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>24<span class="token punctuation">"</span></span> <span class="token attr-name">height</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>24<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>菠萝<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>15<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>images/delete.png<span class="token punctuation">"</span></span> <span class="token attr-name">width</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>24<span class="token punctuation">"</span></span> <span class="token attr-name">height</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>24<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>香蕉<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>78<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>images/delete.png<span class="token punctuation">"</span></span> <span class="token attr-name">width</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>24<span class="token punctuation">"</span></span> <span class="token attr-name">height</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>24<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>总计<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">colspan</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>    <span class="token comment">&lt;!-- 跨多列合并 --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        这里是表单 <span class="token comment">&lt;!-- 表单就是一个容器 可以承载我们要发送给服务器的数据--&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>        <span class="token comment">&lt;!-- &lt;form style="border: 1px solid red"&gt;  我们可能看不到 但它却是存在            &amp;nbsp;        &lt;/form&gt; --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dest.html<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- 发送的目的地 java的组件帮我们收集这些信息 保存到数据库 用post不用get--&gt;</span>            <span class="token comment">&lt;!-- 默认就是text， http request:login.html 如果服务器有这个文件，就应答给浏览器--&gt;</span>            <span class="token comment">&lt;!-- 如果没有name这个属性，数据是不会发送给服务器的--&gt;</span>            昵称：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>nickName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>请输入您的昵称<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>            密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>pwd<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>            <span class="token comment">&lt;!-- 不指定value 浏览器不知道发送给服务器什么value--&gt;</span>            <span class="token comment">&lt;!-- 单选是谁因为name属性决定的，不一样就可以多选 保持一直可以互斥 建议保持一直 这样服务器获取的是一个数组             -checked默认值 属性名=属性值时属性值可以省略--&gt;</span>            性别：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>radio<span class="token punctuation">"</span></span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>gender<span class="token punctuation">"</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>male<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>男                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>radio<span class="token punctuation">"</span></span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>gender<span class="token punctuation">"</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>female<span class="token punctuation">"</span></span> <span class="token attr-name">checked</span><span class="token punctuation">/&gt;</span></span>女<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>            爱好：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>hobby<span class="token punctuation">"</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>basketball<span class="token punctuation">"</span></span> <span class="token attr-name">checked</span><span class="token punctuation">&gt;</span></span>篮球                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>hobby<span class="token punctuation">"</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>football<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>足球                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>hobby<span class="token punctuation">"</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>earth<span class="token punctuation">"</span></span> <span class="token attr-name">checked</span><span class="token punctuation">&gt;</span></span>地球<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>            星座：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>白羊座<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>天秤座<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>金牛座<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span> <span class="token attr-name">selected</span><span class="token punctuation">&gt;</span></span>天蝎座<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>狮子座<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>            备注：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>remark<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>这里不要换行也不要鞋写字，因为这是textarea的value值<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span> 注 册 <span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>reset<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span> 重 置 <span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- 恢复到默认状态 不是清空--&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span> 这是一个普通按钮 <span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTML </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux网络编程</title>
      <link href="/2022/04/24/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
      <url>/2022/04/24/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-网络编程"><a href="#Linux-网络编程" class="headerlink" title="Linux 网络编程"></a>Linux 网络编程</h1><h2 id="1-网络结构模式"><a href="#1-网络结构模式" class="headerlink" title="1. 网络结构模式"></a>1. 网络结构模式</h2><h3 id="C-S-结构"><a href="#C-S-结构" class="headerlink" title="C/S 结构"></a>C/S 结构</h3><h5 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h5><p>​        客户机 - 服务器，即 Client - Server（C/S）结构。</p><p>​        C/S 结构通常采取两层结构。服务器负责数据的 管理，客户机负责完成与用户的交互任务。客户机是因特网上访问别人信息的机器，<code>服务器</code>则是<code>提 供信息供人访问</code>的<code>计算机</code>。 </p><p>​        客户机通过<code>局域网</code>与服务器相连，接受用户的请求，并通过网络向服务器提出请求，对数据库进行操作。</p><blockquote><p><code>服务器</code>接受客户机的请求，将数据提交给客户机，客户机将数据进行计算并将结果呈现给用户。</p><p><code>服务器</code>还要提供完善安全保护及对数据完整性的处理等操作，并允许多个客户机同时访问服务器（企业有很多的服务器，形成<code>服务器集群</code>），这就对服务器的硬件处理数据能力提出了很高的要求。 </p></blockquote><p>​        </p><p>在C/S结构中，应用程序分为两部分：服务器部分和客户机部分。</p><blockquote><p><code>服务器</code>部分是多个用户共享的信息与功能，执行后台服务，如控制共享数据库的操作等；</p><p><code>客户机</code>部分为用户所专有，负责执行前台功能，在出错提示、在线帮助等方面都有强大的功能，并且可以在子程序间自由切换。</p></blockquote><p>如QQ。</p><h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><ol><li>能充分发挥<code>客户端 PC 的处理能力</code>，很多工作可以在客户端处理后再提交给服务器，所以 C/S 结构 客户端响应速度快；</li><li> 操作界面漂亮、形式多样，可以充分满足客户自身的个性化要求； </li><li>C/S 结构的管理信息系统具有较强的事务处理能力（利用PC性能），能实现复杂的业务流程； </li><li>安全性较高，C/S 一般面向相对固定的用户群，程序更加注重流程，它可以对权限进行多层次校 验，提供了更安全的存取模式，对信息安全的控制能力很强，一般高度机密的信息系统采用 C/S 结 构适宜。</li></ol><p>比如玩端游一般都有个客户端，许多工作都是在客户端上完成，不定时将数据传送到服务器端。这也解释了为什么许多端游都对客户端机器有硬件及软件要求。</p><p>网页游戏其实也有客户端，它的客户端是浏览器，性能肯定比不上客户端软件。</p><h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><ol><li><p>客户端需要安装专用的客户端软件。</p><p>首先涉及到安装的工作量，其次<code>任何一台</code>电脑出问题，如病毒、硬件损坏，都需要进行安装或维护。</p><p>系统软件升级时，<code>每一台</code>客户机需要重新安装，其维护和升级成本非常高； </p></li><li><p>对客户端的操作系统一般也会有限制，<code>不能够跨平台</code>。</p></li></ol><h3 id="B-S-结构"><a href="#B-S-结构" class="headerlink" title="B/S 结构"></a>B/S 结构</h3><h5 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h5><p>B/S 结构（Browser/Server，浏览器/服务器模式），是 WEB 兴起后的一种网络结构模式，<code>WEB 浏览器</code>是客户端最主要的应用软件。这种模式<code>统一了客户端</code>，将系统功能实现的<code>核心部分</code>集中到<code>服务器</code>上，简化了系统的开发、维护和使用。客户机上只要安装一个浏览器，如 Firefox 或 Internet Explorer，服务器安装 SQL Server、Oracle、MySQL 等数据库。浏览器通过 Web Server 同数据库进行数据交互。</p><h5 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h5><p>B/S 架构最大的优点是总体拥有成本低、维护方便、 分布性强、开发简单，可以不用安装任何专门的软件就能实现在任何地方进行操作，<code>客户端零维护</code>，系统的扩展非常容易，只要有一台能上网的电脑就能使用。</p><h5 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h5><ol><li>通信开销大、系统和数据的安全性较难保障; </li><li>个性特点明显降低，无法实现具有个性化的功能要求； </li><li>协议一般是固定（无法操作大数据量的文件）的：http/https （C/S架构可以自己规定协议）</li><li>客户端服务器端的<code>交互</code>是<code>请求-响应模式</code>，通常动态刷新页面，响应速度明显降低。</li></ol><p>看看就好了，没啥有营养的东西。</p><h2 id="2-MAC地址、IP地址、端口"><a href="#2-MAC地址、IP地址、端口" class="headerlink" title="2. MAC地址、IP地址、端口"></a>2. MAC地址、IP地址、端口</h2><h4 id="2-1-MAC-地址"><a href="#2-1-MAC-地址" class="headerlink" title="2.1. MAC 地址"></a>2.1. MAC 地址</h4><p>​        网卡是一块被设计用来允许计算机在计算机网络上进行通讯的计算机硬件，又称为网络适配器或网 络接口卡NIC。其拥有 MAC 地址，属于 OSI 模型的第 2 层，它使得用户可以通过电缆或无线相互 连接。每一个网卡都有一个被称为 MAC 地址的独一无二的 48 位（6 bytes）串行号。</p><p>​        网卡的主要功能：</p><ul><li>数据的封装与解封装</li><li>链路管理</li><li>数据编码与译码</li></ul><p>​        MAC 地址（Media Access Control Address），直译为媒体存取控制位址，也称为局域网地址、 以太网地址、物理地址或硬件地址，它是一个用来确认网络设备位置的位址，由网络设备制造商生 产时烧录在网卡中。</p><p>​        在 OSI 模型中，<code>第三层网络层负责 IP 地址，第二层数据链路层则负责 MAC 位址</code> 。MAC 地址用于在网络中唯一标识一个网卡，一台设备若有一或多个网卡，则每个网卡都需 要并会有一个唯一的 MAC 地址。 MAC 地址的长度为 48 位（6个字节），通常表示为 12 个 16 进制数，如：00-16-EA-AE-3C-40 就 是一个MAC 地址，其中前 3 个字节，16 进制数 00-16-EA 代表网络硬件制造商的编号，它由 IEEE（电气与电子工程师协会）分配，而后 3 个字节，16进制数 AE-3C-40 代表该制造商所制造的 某个网络产品（如网卡）的系列号。只要不更改自己的 MAC 地址，MAC 地址在世界是唯一的。 形象地说，MAC 地址就如同身份证上的身份证号码，具有唯一性。</p><h4 id="4-2-IP-地址"><a href="#4-2-IP-地址" class="headerlink" title="4.2. IP 地址"></a>4.2. IP 地址</h4><h5 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h5><p>​        IP 协议是为计算机网络相互连接进行通信而设计的协议。在因特网中，它是能使连接到网上的所有计算机网络实现<code>相互通信</code>的一套规则，规定了计算机在因特网上进行通信时应当遵守的规则。<code>任何厂家生产的计算机系统，只要遵守 IP 协议就可以与因特网互连互通。</code>各个厂家生产的网络系统 和设备，如以太网、分组交换网等，它们相互之间不能互通，不能互通的主要原因是因为它们所传 送数据的基本单元（技术上称之为“帧”）的格式不同。（相当于两个说中文和英文的人无法交流，如果大家约定都说法文，那么就可以交流了）</p><p>​        IP 协议实际上是一套由软件程序组成的协议 软件，它把各种不同“帧”统一转换成“IP 数据报”格式，这种转换是因特网的一个最重要的特点，使所有各种计算机都能在因特网上实现互通，即具有“开放性”的特点。正是因为有了 IP 协议，因特 网才得以迅速发展成为世界上最大的、开放的计算机通信网络。因此，IP 协议也可以叫做“因特网 协议”。 </p><p>​        IP 地址（Internet Protocol Address）是指互联网协议地址，又译为网际协议地址。IP 地址是 IP 协议提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个<code>逻辑地址</code>，以 此来<code>屏蔽物理地址的差异</code>。 IP 地址是一个 <code>32 位</code>的二进制数，通常被分割为 4 个“ 8 位二进制数”（也就是 4 个字节）。IP 地址 通常用“点分十进制”表示成（a.b.c.d）的形式，其中，a,b,c,d都是 0~255 之间的十进制整数。 例：点分十进IP地址（100.4.5.6），实际上是 32 位二进制数 （01100100.00000100.00000101.00000110）。（是个被分配的逻辑地址，相当于你的学号，并不是你与生俱来的，而是为了通信给你分配的）</p><h5 id="IP-地址编址方式"><a href="#IP-地址编址方式" class="headerlink" title="IP 地址编址方式"></a>IP 地址编址方式</h5><p>​        最初设计互联网络时，为了便于寻址以及层次化构造网络，每个 IP 地址包括<code>两个标识码（ID）</code>，即<code>网络 ID</code> 和<code>主机 ID</code>。</p><p>​        <code>同一个物理网络</code>上的所有主机都使用<code>同一个网络 ID</code>，网络上的<code>一个主机</code>（包括网络上工 作站，服务器和路由器等）有一个<code>主机 ID</code> 与其对应。Internet 委员会定义了 5 种 IP 地址类型以适合不 同容量的网络，即 A 类~ E 类。 其中 <code>A、B、C</code> 3类（如下表格）由 InternetNIC 在全球范围内统一分配，<code>D、E</code> 类为特殊地址。</p><p>​        比如 IP <code>192.168.100.235</code>，前三个就是网络IP，这台电脑在 192.168.100 这个网段里面，最后的 235 就是主机 IP。</p><p><img src="https://img-blog.csdnimg.cn/fe8b606af4df4b30b4acfdbff1dc9ab6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="A类地址"><a href="#A类地址" class="headerlink" title="A类地址"></a>A类地址</h5><p>​        一个 A 类 IP 地址是指， 在 IP 地址的四段号码中，第一段号码为网络号码，剩下的三段号码为本地计算机的号码。</p><p>​        如果用二进制表示 IP 地址的话，A 类 IP 地址就由 1 字节的网络地址和 3 字节主机地址组 成，网络地址的最高位必须是“0”。A 类 IP 地址中网络的标识长度为 8 位，主机标识的长度为 24 位，A 类网络地址数量较少，有 126 个网络，每个网络可以容纳主机数达 1600 多万台。 A 类 IP 地址 地址范围 1.0.0.1 - 126.255.255.254（二进制表示为：00000001 00000000 00000000 00000001 - 01111111 11111111 11111111 11111110）。最后一个是广播地址。 A 类 IP 地址的子网掩码为 255.0.0.0，每个网络支持的最大主机数为 256 的 3 次方 - 2 = 16777214 台。</p><h5 id="B类地址"><a href="#B类地址" class="headerlink" title="B类地址"></a>B类地址</h5><h5 id="C类地址"><a href="#C类地址" class="headerlink" title="C类地址"></a>C类地址</h5><h4 id="2-3-端口"><a href="#2-3-端口" class="headerlink" title="2.3 端口"></a>2.3 端口</h4><h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><p>​        “端口” 是英文 port 的意译，可以认为是设备<code>与外界通讯交流</code>的<code>出口</code>。</p><p>​        端口可分为<code>虚拟端口</code>和<code>物理端口</code>。</p><p>​        其中<code>虚拟端口</code>指计算机内部或交换机路由器内的端口，不可见，是特指<code>TCP/IP协议中的端口</code>，是<code>逻辑意义</code>上的端口。例如计算机中的 80 端口、21 端口、23 端口等。物理端口又称为接 口，是可见端口，计算机背板的 RJ45 网口，交换机路由器集线器等 RJ45 端口。电话使用 RJ11 插 口也属于物理端口的范畴。 </p><p>​        如果把 IP 地址比作一间房子，端口就是出入这间房子的门。真正的房子只有几个门，但是一个 IP 地址的端口可以有 65536（即：2^16）个之多！端口是通过端口号来标记的，端口号只有整数， 范围是从 0 到65535（2^16-1）。</p><h5 id="端口类型"><a href="#端口类型" class="headerlink" title="端口类型"></a>端口类型</h5><ol><li><p>周知端口（Well Known Ports） 周知端口是众所周知的端口号，也叫知名端口、公认端口或者常用端口，范围从 0 到 1023，它们紧密 绑定于一些特定的服务。</p><p>例如 <code>80 端口</code>分配给 WWW 服务，<code>21 端口</code>分配给 FTP 服务，<code>23 端口</code>分配给 Telnet服务等等。我们在 IE 的地址栏里输入一个网址的时候是不必指定端口号的，因为在默认情况下 WWW 服务的端口是 “80”。网络服务是可以使用其他端口号的，如果不是默认的端口号则应该在地址栏 上指定端口号，方法是在地址后面加上冒号“:”（半角），再加上端口号。比如使用 “8080” 作为 WWW 服务的端口，则需要在地址栏里输入“网址:8080”。但是有些系统协议使用固定的端口号，它是不能被改 变的，比如 139 端口专门用于 NetBIOS 与 TCP/IP 之间的通信，不能手动改变。 </p></li><li><p>注册端口（Registered Ports） 端口号从 1024 到 49151，它们松散地绑定于一些服务，分配给<code>用户进程</code>或应用程序，这些进程主要是用户选择安装的一些应用程序，而不是已经分配好了公认端口的常用程序。这些端口在没有被服务器资 源占用的时候，可以用用户端动态选用为源端口。 、</p></li><li><p>动态端口 / 私有端口（Dynamic Ports / Private Ports） 动态端口的范围是从 49152 到 65535。之所以称为动态端口，是因为它一般不固定分配某种服务，而是 动态分配。</p></li></ol><h2 id="3-网络模型"><a href="#3-网络模型" class="headerlink" title="3. 网络模型"></a>3. 网络模型</h2><h2 id="4-协议"><a href="#4-协议" class="headerlink" title="4. 协议"></a>4. 协议</h2><p>协议规定两个人交流的规范。</p><p>在网络中体现为发送数据的格式。</p><p>比如，我们约定好，A先发送文件的名字，B回答OK；</p><p>A再发送文件的大小，B回答OK；</p><p>A再发送文件的具体内容，B回答OK。</p><p>关于发送文件名—文件大小—文件具体内容的这个约定，就是一个协议。</p><h4 id="4-1-简介"><a href="#4-1-简介" class="headerlink" title="4.1. 简介"></a>4.1. 简介</h4><p>​        协议，网络协议的简称，网络协议是通信计算机双方必须共同遵从的一组约定。如怎么样建立连 接、怎么样互相识别等。只有遵守这个约定，计算机之间才能相互通信交流。它的三要素是：<code>语法</code>、<code>语义</code>、<code>时序</code>。 为了使数据在网络上从源到达目的，网络通信的参与方必须<code>遵循相同的规则</code>，这套规则称为协议 （protocol），它最终体现为在网络上传输的<code>数据包</code>的格式。 协议往往分成几个层次进行定义，分层定义是为了使某一层协议的改变不影响其他层次的协议。</p><h4 id="4-2-常见协议"><a href="#4-2-常见协议" class="headerlink" title="4.2 常见协议"></a>4.2 常见协议</h4><p>​        应用层常见的协议有：FTP协议（File Transfer Protocol 文件传输协议）、HTTP协议（Hyper Text Transfer Protocol 超文本传输协议）、NFS（Network File System 网络文件系统）。 </p><p>​        传输层常见协议有：TCP协议（Transmission Control Protocol 传输控制协议）、UDP协议（User Datagram Protocol 用户数据报协议）。 </p><p>​        网络层常见协议有：IP 协议（Internet Protocol 因特网互联协议）、ICMP 协议（Internet Control Message Protocol 因特网控制报文协议）、IGMP 协议（Internet Group Management Protocol 因特 网组管理协议）。</p><pre><code>     网络接口层常见协议有：ARP协议（Address Resolution Protocol 地址解析协议）、RARP协议 （Reverse Address Resolution Protocol 反向地址解析协议）。</code></pre><h4 id="4-3-UDP-协议"><a href="#4-3-UDP-协议" class="headerlink" title="4.3 UDP 协议"></a>4.3 UDP 协议</h4><p><img src="https://img-blog.csdnimg.cn/0c3fffb300c1474f9304b8ddc25deb61.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ul><li><p>源端口号：发送方端口号 </p></li><li><p>目的端口号：接收方端口号 </p></li><li><p>长度：UDP用户数据报的长度，最小值是8（仅有首部） </p></li><li><p>校验和：检测UDP用户数据报在传输中是否有错，有错就丢弃</p></li></ul><h4 id="4-4-TCP-协议"><a href="#4-4-TCP-协议" class="headerlink" title="4.4 TCP 协议"></a>4.4 TCP 协议</h4><p><img src="https://img-blog.csdnimg.cn/831fa1039af14143a63f7979c819fe0e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ol><li>源端口号：发送方端口号 </li><li>目的端口号：接收方端口号 </li><li>序列号：本报文段的数据的第一个字节的序号 </li><li>确认序号：期望收到对方下一个报文段的第一个数据字节的序号 </li><li>首部长度（数据偏移）：TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远，即首部长 度。单位：32位，即以 4 字节为计算单位 </li><li>保留：占 6 位，保留为今后使用，目前应置为 0 </li><li>紧急 URG ：此位置 1 ，表明紧急指针字段有效，它告诉系统此报文段中有紧急数据，应尽快传送 </li><li>确认 ACK：仅当 ACK=1 时确认号字段才有效，TCP 规定，在连接建立后所有传达的报文段都必须 把 ACK 置1 </li><li>推送 PSH：当两个应用进程进行交互式的通信时，有时在一端的应用进程希望在键入一个命令后立 即就能够收到对方的响应。在这种情况下，TCP 就可以使用推送（push）操作，这时，发送方 TCP 把 PSH 置 1，并立即创建一个报文段发送出去，接收方收到 PSH = 1 的报文段，就尽快地 （即“推送”向前）交付给接收应用进程，而不再等到整个缓存都填满后再向上交付 </li><li>复位 RST：用于复位相应的 TCP 连接 </li><li>同步 SYN：仅在三次握手建立 TCP 连接时有效。当 SYN = 1 而 ACK = 0 时，表明这是一个连接请 求报文段，对方若同意建立连接，则应在相应的报文段中使用 SYN = 1 和 ACK = 1。因此，SYN 置 1 就表示这是一个连接请求或连接接受报文</li></ol><h4 id="4-5-IP-协议"><a href="#4-5-IP-协议" class="headerlink" title="4.5 IP 协议"></a>4.5 IP 协议</h4><p><img src="https://img-blog.csdnimg.cn/e47f2401788942aa9eaebdc3b674b407.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ol><li>版本：IP 协议的版本。通信双方使用过的 IP 协议的版本必须一致，目前最广泛使用的 IP 协议版本 号为 4（即IPv4) </li><li>首部长度：单位是 32 位（4 字节） </li><li>服务类型：一般不适用，取值为 0 </li><li>总长度：指首部加上数据的总长度，单位为字节 </li><li>标识（identification）：IP 软件在存储器中维持一个计数器，每产生一个数据报，计数器就加 1， 并将此值赋给标识字段 </li><li>标志（flag）：目前只有两位有意义。 标志字段中的最低位记为 MF。MF = 1 即表示后面“还有分片”的数据报。MF = 0 表示这已是若干数 据报片中的最后一个。 标志字段中间的一位记为 DF，意思是“不能分片”，只有当 DF = 0 时才允许分片 </li><li>片偏移：指出较长的分组在分片后，某片在源分组中的相对位置，也就是说，相对于用户数据段的 起点，该片从何处开始。片偏移以 8 字节为偏移单位。 </li><li>生存时间：TTL，表明是数据报在网络中的寿命，即为“跳数限制”，由发出数据报的源点设置这个 字段。路由器在转发数据之前就把 TTL 值减一，当 TTL 值减为零时，就丢弃这个数据报。 </li><li>协议：指出此数据报携带的数据时使用何种协议，以便使目的主机的 IP 层知道应将数据部分上交 给哪个处理过程，常用的 ICMP(1)，IGMP(2)，TCP(6)，UDP(17)，IPv6（41) </li><li>首部校验和：只校验数据报的首部，不包括数据部分。 11. 源地址：发送方 IP 地址 12. 目的地址：接收方 IP 地址</li></ol><h4 id="4-6-以太网帧协议"><a href="#4-6-以太网帧协议" class="headerlink" title="4.6 以太网帧协议"></a>4.6 以太网帧协议</h4><p> <img src="https://img-blog.csdnimg.cn/8fe3d301fef94f65b93827757c527b74.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 类型：0x800表示 IP、0x806表示 ARP、0x835表示 RARP</p><h4 id="4-7-ARP-协议"><a href="#4-7-ARP-协议" class="headerlink" title="4.7 ARP 协议"></a>4.7 ARP 协议</h4><p><img src="https://img-blog.csdnimg.cn/414ba40fbb9c495b8fd7298687f48e35.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ol><li>硬件类型：1 表示 MAC 地址 </li><li>协议类型：0x800 表示 IP 地址 </li><li>硬件地址长度：6 （只是存了个数字）</li><li>协议地址长度：4 </li><li>操作：1 表示 ARP 请求，2 表示 ARP 应答，3 表示 RARP 请求，4 表示 RARP 应答</li></ol><p>在封装的时候并不知道目标机器的MAC地址，所以会通过IP来查找该IP对应的MAC地址。</p><ul><li><p>ARP请求包</p><p>不是给某个具体的网卡发送请求，而是以<code>广播</code>的形式给局域网内的所有人发，大家各自解析目的IP地址，看是不是发给自己的。一旦某台机器发现是发给自己的，它就应答并把MAC地址传给源头。</p><p>请求</p></li></ul><p><img src="https://img-blog.csdnimg.cn/3202d01ae87947dfbd068d0b3439d853.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/0fdae567c22a417db9d3b45df493cf5e.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>由于刚开始不知道目的端的MAC，就先填充0.</p><p>另一个机器收到这个请求后，就可以应答了。</p><p><img src="https://img-blog.csdnimg.cn/ee7ea24a7b4142f6b0adeb2069ec0d37.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h4 id="4-8-封装"><a href="#4-8-封装" class="headerlink" title="4.8 封装"></a>4.8 封装</h4><p>​        下层协议提供服务给上层协议。上层协议是如何使用下层协议提供的服务的呢？</p><p>​        其实这是通过封装（encapsulation）实现的。应用程序数据在发送到物理网络上之前，将沿着协议栈<code>从上往下</code>依次传递。每层协议都将<code>在上层数据的基础上加上自己的头部信息</code>（有时还包括<code>尾部信息</code>），以实现该层的功能，这个过程就称为封装。</p><p>​        应用层 → 传输层→网络层→数据链路层</p><p><img src="https://img-blog.csdnimg.cn/c8fcbb08460b48baa2e070cb15eb7d11.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h4 id="4-10-分用"><a href="#4-10-分用" class="headerlink" title="4.10 分用"></a>4.10 分用</h4><p>​        当帧到达<code>目的主机</code>时，将沿着协议栈<code>自底向上</code>依次传递。各层协议依次处理帧中本层负责的头部数据， 以获取所需的信息，并最终将处理后的帧交给<code>目标应用程序</code>。这个过程称为分用（demultiplexing）。 分用是依靠<code>头部信息</code>中的<code>类型字段</code>实现的。</p><p><img src="https://img-blog.csdnimg.cn/ce9e626032aa456fa20e31c9b29b9b19.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/e643f1d0ca9b45a9afd06c60e8adaefe.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>上一层的分装作为下一层的头后面的数据。</p><h2 id="5-网络通信的过程"><a href="#5-网络通信的过程" class="headerlink" title="5. 网络通信的过程"></a>5. 网络通信的过程</h2><p>这里慢慢补，东西太多了。</p><h2 id="6-socket-介绍"><a href="#6-socket-介绍" class="headerlink" title="6. socket 介绍"></a>6. socket 介绍</h2><p>Linux：<code>一切皆文件</code>。</p><p>通信本质上就是<code>发送数据</code>和<code>接收数据</code>， socket 对应一个文件描述符，往里面 write 和 read。</p><p>机器A把数据写到内核中的<code>读缓冲区</code>和<code>写缓冲区</code>，机器B也相应得写和读。</p><p>socket 底层会调用TCP/IP四层协议栈帮你封装数据，发送，解封装等等。</p><p>最重要的就是 IP 和端口，以及封装的关于协议的API。</p><p>网络编程实际上也是进程间通信，只不过是在不同的主机上进行通信。</p><p>同一台机器上进程间通信用管道、内存映射、共享内存、消息队列、信号等等。</p><p>而在UNIX网络编程中在不同机器间进程间通信，即网络通信，使用的是socket技术。</p><p>如果每个协议都自己去组包，封装，分用，会非常得麻烦，因此 socket 简化了这一切，抽象成两个 sockst 各自表示通信的两端。</p><p>​        所谓 socket（套接字），就是对网络中<code>不同主机</code>上的应用进程之间进行<code>双向通信</code>的端点的抽象。 一个套接字就是网络上进程通信的一端，提供了<code>应用层进程</code>利用网络协议交换数据的机制。从所处的地位来 讲，套接字<code>上联应用进程</code>，<code>下联网络协议栈</code>，是应用程序通过网络协议进行通信的接口， 是应用程序与网络协议根进行交互的接口。 </p><p>​        socket 可以看成是两个网络应用程序进行通信时，各自通信连接中的端点，这是一个逻辑上的概 念。它是网络环境中<code>进程间通信的 API</code>，也是可以被命名和寻址的通信端点，使用中的每一个套接字都有其类型和一个与之相连进程。通信时其中一个网络应用程序将要传输的一段信息写入它所在主机的 socket 中，该 socket 通过与网络接口卡（NIC）相连的传输介质将这段信息送到另外一台 主机的 socket 中，使对方能够接收到这段信息。socket 是由 <code>IP 地址和端口结合</code>（IP地址找到另一台机器，端口找到进程）的，提供向应用 层进程传送数据包的机制。 </p><p>​        socket 本身有“插座”的意思，在 Linux 环境下，用于表示进程间网络通信的<code>特殊文件类型</code>。本质为内核借助缓冲区形成的伪文件。既然是文件，那么理所当然的，我们可以使用<code>文件描述符</code>引用套接字。与管道类似的，Linux 系统将其封装成文件的目的是为了统一接口，使得<code>读写套接字和读写文件的操作一致</code>。区别是管道主要应用于本地进程间通信，而套接字多应用 于网络进程间数据的传递。</p><p><img src="https://img-blog.csdnimg.cn/d674e64c98bc4968be809c9ecc7080d4.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>本质还是写文件和读文件。</p><p>套接字通信分两部分，客户端和服务器端。</p><ul><li><p>客户端 （插座）- 主动向发武器发起连接</p></li><li><p>服务器端（插头） - 被动接受连接</p></li></ul><p>socket 是一套通信的接口，Linux和Windows下都有。</p><p><img src="https://img-blog.csdnimg.cn/6f936f9f4e1b42aba0a70327b7b59794.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="7-字节序"><a href="#7-字节序" class="headerlink" title="7. 字节序"></a>7. 字节序</h2><h4 id="7-1-简介"><a href="#7-1-简介" class="headerlink" title="7.1 简介"></a>7.1 简介</h4><p>​        现代 CPU 的累加器一次都能装载（至少）4 字节（这里考虑 32 位机），即一个整数。那么这 4 字节在内存中排列的顺序将影响它被累加器装载成的整数的值，这就是字节序问题。在各种计算机体系结构中，对于字节、字等的存储机制有所不同，因而引发了计算机通信领域中一个很重要的问题，即通信双方交流的信息单元（比特、字节、字、双字等等）应该以什么样的顺序进行传送。如果不达成一致的规则，通信双方将无法进行正确的编码/译码从而导致通信失败。 </p><p>​        <strong><font color="red">字节序，顾名思义字节的顺序，就是大于一个字节类型的数据在内存中的存放顺序(一个字节的数 据当然就无需谈顺序的问题了)。</font></strong>(单个字节里的bit还是按顺序的，但是多个字节顺序就不一样了)</p><p>​         字节序分为<code>大端字节序</code>（Big-Endian） 和<code>小端字节序</code>（Little-Endian）。</p><blockquote><p>大端字节序是指一个整 数的最高位字节（23 ~ 31 bit）存储在内存的低地址处，低位字节（0 ~ 7 bit）存储在内存的高地址处；</p><p>小端字节序则是指整数的高位字节存储在内存的高地址处，而低位字节则存储在内存的低地 址处。</p></blockquote><h4 id="7-2-字节序转换函数"><a href="#7-2-字节序转换函数" class="headerlink" title="7.2 字节序转换函数"></a>7.2 字节序转换函数</h4><p>​        当格式化的数据在两台使用不同字节序的主机之间直接传递时，接收端必然错误的解释之。</p><p>​        解决问题的方法是：<code>发送端</code>总是把要发送的数据转换成<code>大端字节序</code>数据后再发送，而<code>接收端</code>知道对方传送过来的数据总是采用大端字节序，所以接收端可以根据自身采用的字节序<code>决定是否对接收到的数据进行转换</code>（小端机转换，大端机不转换）。</p><p>​        <code>网络字节顺序</code>是<code>TCP/IP</code> 中规定好的一种数据表示格式，它与具体的 CPU 类型、操作系统等无关，从而 可以保证数据在不同主机之间传输时能够被正确解释，<code>网络字节顺序</code>采用<code>大端</code>排序方式。 </p><p>​        BSD Socket提供了封装好的转换接口，方便程序员使用。</p><p>​        包括从主机字节序到网络字节序的转换函数： htons、htonl；</p><p>​        从网络字节序到主机字节序的转换函数：ntohs、ntohl。</p><blockquote><p>h - host 主机，主机字节序 </p><p>to - 转换成什么 </p><p>n - network 网络字节序 </p><p>s - short unsigned short </p><p>l - long unsigned int</p></blockquote><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token comment">// 主机字节序 -&gt; 网络字节序</span><span class="token class-name">uint32_t</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> hostlong<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 转IP</span><span class="token class-name">uint16_t</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> hostshort<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 转port</span><span class="token comment">// 网络字节序 -&gt; 主机字节序</span><span class="token class-name">uint32_t</span> <span class="token function">ntohl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> netlong<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 转IP</span><span class="token class-name">uint16_t</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> netshort<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 转port</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h6 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h6><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 转换端口</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"port: machine -&gt; net\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">uint16_t</span> a_local <span class="token operator">=</span> <span class="token number">0x0102</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x\n"</span><span class="token punctuation">,</span> a_local<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">uint16_t</span> a_net <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>a_local<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x\n"</span><span class="token punctuation">,</span> a_net<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"==========================\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换IP</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"IP: machine -&gt; net\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ip_local<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">168</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>ip_local<span class="token punctuation">;</span> <span class="token comment">// 把ip_local强转成int*指针，指向4个字节的数据，并解引用</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>num<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d.%d.%d.%d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>    ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sum<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d.%d.%d.%d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"=========================\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换IP</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> buf1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">168</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> num1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf1<span class="token punctuation">;</span>    <span class="token keyword">int</span> sum1 <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sum1<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %d %d %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>p1<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p1<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p1<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p1<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/e5598c36f2e24077ace8e9963bc31551.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="8-socket-地址"><a href="#8-socket-地址" class="headerlink" title="8. socket 地址"></a>8. socket 地址</h2><p>​        socket地址其实是一个<code>结构体</code>，封装<code>端口号</code>和<code>IP</code>等信息。后面的socket相关的api中需要使用到这个 socket地址。 </p><h4 id="8-1-通用socket地址"><a href="#8-1-通用socket地址" class="headerlink" title="8.1 通用socket地址"></a>8.1 通用socket地址</h4><p>​        socket 网络编程接口中表示 socket 地址的是结构体 <code>sockaddr</code>。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/socket.h&gt;</span></span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">{</span>    <span class="token class-name">sa_family_t</span> sa_family<span class="token punctuation">;</span><span class="token comment">/* Common data: address family and length.  */</span>    <span class="token keyword">char</span> sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">/* Address data.  */</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> <span class="token class-name">sa_family_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>sa_family 成员是<code>地址族类型</code>（sa_family_t）的变量。<code>地址族类型</code>通常与<code>协议族类型</code>对应。常见的协议族（protocol family，也称 domain）和对应的地址族入下所示：</p><table><thead><tr><th align="center">协议族</th><th align="center">地址族</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">PF_UNIX</td><td align="center">AF_UNIX</td><td align="center">UNIX本地域协议族</td></tr><tr><td align="center">PF_INET</td><td align="center">AF_INET</td><td align="center">TCP/IPv4协议族</td></tr><tr><td align="center">PF_INET6</td><td align="center">AF_INET6</td><td align="center">TCP/IPv6协议族</td></tr></tbody></table><p>PF和AF宏都定义在 <code>bits/socket.h</code> 头文件中，且后者与前者有完全相同的值，所以二者通常混用。</p><p>sa_data 成员用于存放 <code>socket 地址值</code>。但是，不同的协议族的地址值具有不同的含义和长度，如下所 示：</p><p><img src="https://img-blog.csdnimg.cn/84620d1d5d3d40eda1c482f64fdbc970.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>由上表可知，14 字节的 sa_data 根本无法容纳多数协议族的地址值。因此，Linux 定义了下面这个新的通用的 socket 地址结构体，这个结构体不仅提供了足够大的空间用于存放地址值，而且是<code>内存对齐</code>的。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/socket.h&gt;</span></span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span><span class="token punctuation">{</span>    <span class="token class-name">sa_family_t</span> sa_family<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">int</span> __ss_align<span class="token punctuation">;</span>    <span class="token keyword">char</span> __ss_padding<span class="token punctuation">[</span> <span class="token number">128</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__ss_align<span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> <span class="token class-name">sa_family_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="8-2-专用socket地址"><a href="#8-2-专用socket地址" class="headerlink" title="8.2 专用socket地址"></a>8.2 专用socket地址</h4><p>​        很多网络编程函数诞生早于 IPv4 协议，那时候都使用的是<code> struct sockaddr 结构体</code>（就是上面那个通用地址），为了向前兼容，现 在sockaddr 退化成了（void *）的作用，传递一个地址给函数，至于这个函数是 sockaddr_in 还是 sockaddr_in6，由地址族确定，然后函数内部再强制类型转化为所需的地址类型。</p><p><img src="https://img-blog.csdnimg.cn/a63c29c998d94b41b88a39a6a819af38.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>UNIX 本地域协议族使用如下专用的 socket 地址结构体：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/un.h&gt;</span></span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span> <span class="token punctuation">{</span>    <span class="token class-name">sa_family_t</span> sin_family<span class="token punctuation">;</span>    <span class="token keyword">char</span> sun_path<span class="token punctuation">[</span><span class="token number">108</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> <span class="token class-name">sa_family_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>TCP/IP 协议族有 sockaddr_in 和 sockaddr_in6 两个专用的 socket 地址结构体，它们分别用于 IPv4 和 IPv6：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">{</span>    <span class="token class-name">sa_family_t</span> sin_family<span class="token punctuation">;</span> <span class="token comment">/* __SOCKADDR_COMMON(sin_) */</span>    <span class="token class-name">in_port_t</span> sin_port<span class="token punctuation">;</span> <span class="token comment">/* Port number. */</span>    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span> <span class="token comment">/* Internet address. */</span>    <span class="token comment">/* Pad to size of `struct sockaddr'. */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> sin_zero<span class="token punctuation">[</span>        <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">)</span>         <span class="token operator">-</span> __SOCKADDR_COMMON_SIZE         <span class="token operator">-</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token class-name">in_port_t</span><span class="token punctuation">)</span>         <span class="token operator">-</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">{</span><span class="token class-name">in_addr_t</span> s_addr<span class="token punctuation">;</span><span class="token comment">// 专门用来能保存IP地址</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token punctuation">{</span>    <span class="token class-name">sa_family_t</span> sin6_family<span class="token punctuation">;</span>    <span class="token class-name">in_port_t</span> sin6_port<span class="token punctuation">;</span> <span class="token comment">/* Transport layer port # */</span>    <span class="token class-name">uint32_t</span> sin6_flowinfo<span class="token punctuation">;</span> <span class="token comment">/* IPv6 flow information */</span>    <span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> sin6_addr<span class="token punctuation">;</span> <span class="token comment">/* IPv6 address */</span>    <span class="token class-name">uint32_t</span> sin6_scope_id<span class="token punctuation">;</span> <span class="token comment">/* IPv6 scope-id */</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token class-name">uint16_t</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token class-name">uint32_t</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token class-name">uint16_t</span> <span class="token class-name">in_port_t</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token class-name">uint32_t</span> <span class="token class-name">in_addr_t</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SOCKADDR_COMMON_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所有专用 socket 地址（以及 sockaddr_storage）类型的变量在<code>实际使用</code>时都需要<code>转化</code>为<code>通用 socket 地址类型 </code>sockaddr（强制转化即可），因为所有 socket 编程<code>接口</code>使用的地址参数类型都是 <code>sockaddr</code>。</p><p>不管是谁，都要强转成最古老的形式 sockaddr，那种最通用。</p><h2 id="9-IP-地址转换函数"><a href="#9-IP-地址转换函数" class="headerlink" title="9. IP 地址转换函数"></a>9. IP 地址转换函数</h2><p>函数可以做这两件事情。</p><ul><li>主机字节序 - 网络字节序</li><li>字符串点分十进制 IP - 整数 IP</li></ul><p>程序读的IP应该是4个字节的整数，但是人喜欢用点分十进制，如 <code>192.168.1.2</code>。如果我们想把它转换成整数，就可以用自带的函数转换成<code>大端序</code>的整数IP。</p><p>记录日志的时候我们希望往文件中写字符串，此时需要把 int 转换成点分十进制的字符串，然后写到日志中。</p><p>下面 3 个函数可用于用<code>点分十进制字符串</code>表示的 IPv4 地址和用<code>网络字节序整数</code>表示的 IPv4 地址之间的转换：</p><p>但是这三个非常旧了，<code>不推荐使用</code>。</p><h5 id="inet-addr（遗物）"><a href="#inet-addr（遗物）" class="headerlink" title="inet_addr（遗物）"></a>inet_addr（遗物）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token class-name">in_addr_t</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">)</span><span class="token punctuation">;</span>The  <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  function  converts  the Internet 【host address】 【cp】 from IPv4 numbers<span class="token operator">-</span>and<span class="token operator">-</span>dots notation into 【binary】 data in 【network byte order】<span class="token punctuation">.</span>  If the input is invalid<span class="token punctuation">,</span> <span class="token function">INADDR_NONE</span> <span class="token punctuation">(</span>usually <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> is returned<span class="token punctuation">.</span>  Use of this function is problematic because <span class="token operator">-</span><span class="token number">1</span>  is a valid  <span class="token function">address</span> <span class="token punctuation">(</span><span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.255</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  【Avoid】 its use in favor of <span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> or <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> which provide a cleaner way to indicate error <span class="token keyword">return</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="inet-aton（遗物）"><a href="#inet-aton（遗物）" class="headerlink" title="inet_aton（遗物）"></a>inet_aton（遗物）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span>inp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// address to networrk</span><span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> converts the 【Internet host address】 【cp】 from the IPv4 【numbers<span class="token operator">-</span>and<span class="token operator">-</span>dots】 notation into 【binary】 <span class="token function">form</span> <span class="token punctuation">(</span>in 【network byte order】<span class="token punctuation">)</span> and stores it in the structure that 【inp】 points to<span class="token punctuation">.</span>      <span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns nonzero <span class="token keyword">if</span> the address is valid<span class="token punctuation">,</span> zero <span class="token keyword">if</span> not<span class="token punctuation">.</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="inet-ntoa（遗物）"><a href="#inet-ntoa（遗物）" class="headerlink" title="inet_ntoa（遗物）"></a>inet_ntoa（遗物）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> in<span class="token punctuation">)</span><span class="token punctuation">;</span>The  <span class="token function">inet_ntoa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  function  converts the 【Internet host address】 in<span class="token punctuation">,</span> given in 【network byte order】<span class="token punctuation">,</span> 【to a string】 in IPv4 【dotted<span class="token operator">-</span>decimal】 notation<span class="token punctuation">.</span>  The string is returned in a statically allocated buffer<span class="token punctuation">,</span> which subsequent calls will overwrite<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>下面这对<code>更新</code>的函数也能完成前面 3 个函数同样的功能，并且它们<code>同时适用</code> IPv4 地址和 IPv6 地址：</p><h5 id="inet-pton"><a href="#inet-pton" class="headerlink" title="inet_pton"></a>inet_pton</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span><span class="token keyword">int</span> af<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>作用：convert IPv4 and IPv6 addresses 【from text to binary form】</p><p>参数：</p><ul><li><p>af： 地址族 AF_INET，  AF_INET6</p></li><li><p>src：需要转换的点分十进制的 IP 字符串</p></li><li><p>dst：转换后的结果保存在它指向的内存上，传出参数</p></li></ul><h5 id="inet-ntop"><a href="#inet-ntop" class="headerlink" title="inet_ntop"></a>inet_ntop</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span><span class="token keyword">int</span> af<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>作用：convert IPv4 and IPv6 addresses【 from binary to text form】</p><p>参数：</p><ul><li><p>af：地址族</p></li><li><p>src：要转换的网络字节序的整数</p></li><li><p>dst：转换后的点分十进制字符串，传出参数</p></li><li><p>size：指定 dst 可以接受的字节数</p></li></ul><p>返回值：inet_ntop() returns a 【non-null pointer to dst】.</p><h5 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 点分十进制字符串 -&gt; 网络字节序</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"192.168.100.1"</span><span class="token punctuation">;</span>   <span class="token comment">// 点分十进制字符串</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> addr_b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr_b<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"点分十进制-&gt;整数ip：%d.%d.%d.%d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 网络字节序 -&gt; 点分十进制字符串</span>    <span class="token keyword">char</span> ip<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_b<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"整数ip=&gt;点分十进制：%s（返回值） | %s（传出参数）\n"</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ip == str ? ans: %d\n"</span><span class="token punctuation">,</span> ip <span class="token operator">==</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/237998c773d941ecb8b60b09fc74cf8b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>返回值和传出参数ip根本就是同一个东西，不光值一样，地址也一样。</p><h2 id="10-TCP-通信流程"><a href="#10-TCP-通信流程" class="headerlink" title="10. TCP 通信流程"></a>10. TCP 通信流程</h2><p>可不可靠：UDP 发出去的数据对方没有收到的话，就不管了；TCP 会重新发，数据在中途可能会丢失，但一些机制可以保证最最终数据会到达对方。</p><p>使用TCP 协议，通信两端像建立了一个水管，一端发送，一端接收，是源源不断地。单波传输：仅支持一对一传输。</p><p><img src="https://img-blog.csdnimg.cn/853c76ce06844770b6e8d89d681f6a39.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/b7c27d80d5244ccfa3c75c89b795cd20.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ul><li>服务器端 （被动接受连接的角色）</li></ul><ol><li><p>创建一个用于监听的套接字（fd-专门监听）</p><ul><li>监听：监听有客户端的连接</li><li>套接字：这个套接字其实就是一个<code>文件描述符</code></li></ul></li><li><p>将这个监听文件描述符和<code>本地的IP</code>和<code>端口</code>绑定（IP和端口就是服务器的地址信息）</p><ul><li>客户端连接服务器的时候使用的就是这个IP和端口</li></ul></li><li><p>设置监听，监听的fd开始工作（检查读缓冲区有无数据被写入）</p></li><li><p>阻塞等待；<br>accept是个阻塞函数。</p><p>当有客户端发起连接，解除阻塞，接受客户端的连接，得到一个和客户端通信的套接字（fd-专门数据通信）</p></li><li><p>通信</p><ul><li>接收数据</li><li>发送数据</li></ul></li><li><p>通信结束，断开连接</p></li></ol><ul><li>客户端</li></ul><ol><li>创建一个用于通信的套接字（fd），不需要指定端口</li><li>连接服务器，需要指定连接的服务器的 IP 和端口</li><li>连接成功了，客户端可以直接和服务器通信<ul><li>接收数据</li><li>发送数据</li></ul></li><li>通信结束，断开连接</li></ol><h2 id="11-套接字函数"><a href="#11-套接字函数" class="headerlink" title="11. 套接字函数"></a>11. 套接字函数</h2><h5 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">socket <span class="token operator">-</span> create an endpoint <span class="token keyword">for</span> communicationSYNOPSIS    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          </span>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>    <span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  creates an endpoint <span class="token keyword">for</span> communication and returns a 【file descriptor】 that refers to that endpoint<span class="token punctuation">.</span> The file descriptor returned by a successful call will be the lowest<span class="token operator">-</span>numbered file descriptor not currently open <span class="token keyword">for</span> the process<span class="token punctuation">.</span>       The 【domain】 argument specifies a communication domain<span class="token punctuation">;</span> this selects the 【protocol family】  which  will  be  used  <span class="token keyword">for</span>  communication<span class="token punctuation">.</span>       These families are defined in <span class="token operator">&lt;</span>sys<span class="token operator">/</span>socket<span class="token punctuation">.</span>h<span class="token operator">&gt;</span><span class="token punctuation">.</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：创建一个套接字</p><p>参数：</p><ul><li><p>domain：协议族</p><ul><li>AF_UNIX、AF_LOCAL：本地套接字通信（进程间通信）</li><li>AF_INET、AF_INET6：ipv4、ipv6，不同主机进程间通信</li></ul></li><li><p>type：通信过程中的协议类型</p><ul><li>SOCK_STREAM：流式<ul><li>Provides  sequenced, reliable, two-way, connection-based byte streams.  An out-of-band data transmission mechanism may be supported.</li></ul></li><li>SOCK_DGRAM：报式 <ul><li>Supports datagrams (connectionless, unreliable messages of a fixed maximum length).</li></ul></li></ul></li><li><p>protocal：具体的一个协议，一般写0。</p><ul><li>SOCK_STREAM：流式，默认使用 TCP</li><li>SOCK_DGRAM：报式，默认使用 UDP</li></ul></li></ul><p>返回值：</p><ul><li>成功：返回文件描述符，操作做的就是内核缓冲区。</li><li>失败：-1</li></ul><h5 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          <span class="token comment">/* See NOTES */</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>作用：绑定 <code>fd</code> 和<code>本地的 IP + 端口</code> （命名一个 socket）bind a name to a socket</p><p>参数：</p><ul><li>sockfd：通过 socket 函数获得的文件描述符</li><li>*addr：需要绑定的 socket 地址，封装了 ip 和端口信息</li><li>addrlen：addr 结构体占的内存大小</li></ul><p>RETURN VALUE<br>       On success, zero is returned.  On error, -1 is returned, and errno is set appropriately.</p><h5 id="listen"><a href="#listen" class="headerlink" title="listen"></a>listen</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          <span class="token comment">/* See NOTES */</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>作用：监听该 socket 上的连接请求 listen for connections on a socket，accept incoming<br>       connection requests using accept</p><p>参数：</p><ul><li>sockfd：通过 soclet 函数得到的文件描述符（代表这个套接字）</li><li>backlog：<code>已连接+未连接之和</code>的最大值。listen 会创建两个队列（未连接+已连接），只有当三次握手都成功了才会成功连接。backlog一般指定5就可以了。一旦连接了这个请求就推出队列了。但实际上底层还会在这个值上加一点</li></ul><p><img src="https://img-blog.csdnimg.cn/b0916484e6b74514ae96260fda5dac68.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="accept"><a href="#accept" class="headerlink" title="accept"></a>accept</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          <span class="token comment">/* See NOTES */</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>作用：接受客户端连接 默认阻塞，等待客户端连接进来 accept a connection on a socket</p><p>参数：</p><ul><li>sockfd：用于监听的文件描述符，从里面读客户端的信息</li><li>*addr：socket 地址，传出参数，记录连接成功后客户端的<code>地址信息：ip+端口</code></li><li>*addrlen：指定 addr 对应的内存大小</li></ul><p>RETURN VALUE<br>       On  success,  these  system calls return a nonnegative integer that is a <code>file descriptor</code> for the accepted socket.   用于通信的文件描述符，和前面建立的用于监听的文件描述符不同，多个客户端连接会返回不同的用于通信的文件描述符</p><p>​       On error, -1 is returned, errno is set appropriately, and addrlen is left unchanged.</p><h5 id="connect（由客户端调用）"><a href="#connect（由客户端调用）" class="headerlink" title="connect（由客户端调用）"></a>connect（由客户端调用）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          <span class="token comment">/* See NOTES */</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>作用：  客户端连接服务器 initiate a connection on a socket</p><p>参数：</p><ul><li>sockfd：用于通信的文件描述符。客户端<code>不需要监听</code>，直接调用 socket 创建文件描述符用来和服务端通信</li><li>*addr：客户端要连接的<code>服务器的地址信息</code></li><li>addrlen：addr 的内存大小，传入参数，不是传出参数</li></ul><p>返回值：</p><ul><li>成功：0</li><li>失败：1</li></ul><h5 id="write、read"><a href="#write、read" class="headerlink" title="write、read"></a>write、read</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ssize_t</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="12-TCP-通信实现"><a href="#12-TCP-通信实现" class="headerlink" title="12. TCP 通信实现"></a>12. TCP 通信实现</h2><h3 id="12-1-服务器端"><a href="#12-1-服务器端" class="headerlink" title="12.1 服务器端"></a>12.1 服务器端</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token comment">// TCP 通信服务器端</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建套接字（监听）</span>    <span class="token comment">// 如果有连接，客户端会往服务器端套接字的内存缓冲区的读缓冲区写数据</span>    <span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 流式tcp协议，0默认tcp</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>listen_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">// 2. 绑定</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> skaddr<span class="token punctuation">;</span>    skaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>    <span class="token comment">// 协议族</span>    skaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span> <span class="token comment">// 0.0.0.0 任意地址，主机有多个网卡（无线网卡，以太网卡），ip各异，哪个都可以访问，服务端才能这么写</span>    <span class="token comment">//inet_pton(AF_INET, "172.24.190.150", &amp;skaddr.sin_addr.s_addr);   // s_addr需要一个 unsigned int</span>    skaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 端口转换成网络字节序</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>skaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>skaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3. 监听</span>    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 4. 接受客户端的连接</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientaddr<span class="token punctuation">;</span>    <span class="token class-name">socklen_t</span> clientlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientlen<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 没有客户端连接，一直阻塞</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>client_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 输出客户端信息</span>    <span class="token keyword">char</span> client_ip<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">,</span> client_ip<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> client_port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>clientaddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client ip: %s, port: %d\n"</span><span class="token punctuation">,</span> client_ip<span class="token punctuation">,</span> client_port<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 6. 通信</span>    <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>send_buf <span class="token operator">=</span> <span class="token string">"Hello, I'm server."</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 服务端获取客户端数据</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"receive client data: %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 给客户端发送数据</span>        <span class="token function">write</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> send_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">// 7. 关闭文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="12-2-客户端"><a href="#12-2-客户端" class="headerlink" title="12.2 客户端"></a>12.2 客户端</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       <span class="token comment">// 1. 创建套接字</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 连接服务器端</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serveraddr<span class="token punctuation">;</span>    serveraddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">"172.24.190.150"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serveraddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>    serveraddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serveraddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serveraddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3. 通信</span>    <span class="token keyword">char</span> <span class="token operator">*</span>send_buf <span class="token operator">=</span> <span class="token string">"Hello, I'm client."</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 给服务端发送数据</span>        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> send_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//读取服务端的数据</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"receive server data: %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server closed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">// 4. 关闭连接</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="13-TCP-三次握手"><a href="#13-TCP-三次握手" class="headerlink" title="13. TCP 三次握手"></a>13. TCP 三次握手</h2><p>TCP 是一种<code>面向连接</code>的<code>单播协议</code>，在发送数据前，通信双方必须在彼此间建立一条连接。所谓的“连接”，其实是客户端和服务器的内存里保存的一份关于对方的信息，如 IP 地址、端口号等。 （双方的信息保存在TCP模块中）</p><p>TCP 可以看成是一种字节流，它会处理 IP 层或以下的层的<code>丢包</code>、<code>重复</code>以及<code>错误</code>问题。在连接的建立过程中，双方需要<code>交换一些连接的参数</code>。这些参数可以放在 <code>TCP 头部</code>。 （安全指的是数据最终对方都可以接收到，中途可能会丢失，但结果不会失望）</p><p>TCP 提供了一种可靠、面向连接、字节流、传输层的服务，采用<code>三次握手</code>来<code>建立</code>一个连接。采用<code>四次挥手</code>来<code>关闭</code>一个连接。（协议的行为，不是通过程序员的代码来实现）</p><p> <strong>三次握手的目的是保证双方互相之间建立了连接。</strong> （保证 TCP安全的一种机制，此外还有超时重传，确认机制，四次挥手等）</p><p>三次握手发生在客户端连接的时候，当调用connect()，底层会通过TCP协议进行三次握手。</p><p><img src="https://img-blog.csdnimg.cn/831fa1039af14143a63f7979c819fe0e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ul><li>16 位端口号（port number）：告知主机报文段是来自哪里（源端口）以及传给哪个上层协议或 应用程序（目的端口）的。进行 TCP 通信时，客户端通常使用系统自动选择的临时端口号。 </li><li>32 位<code>序号</code>（sequence number）：一次 TCP 通信（从 TCP 连接建立到断开）过程中某一个传输方向上的字节流的<code>每个字节的编号</code>。假设主机 A 和主机 B 进行 TCP 通信，A 发送给 B 的第一个 TCP 报文段中，序号值被系统初始化为某个<code>随机值</code> ISN（Initial Sequence Number，初始序号值）。那么在该传输方向上（从 A 到 B），后续的 TCP 报文段中序号值将被系统设置成 ISN 加上该报文段所携带数据的第一个字节在整个字节流中的偏移。例如，某个 TCP 报文段传送的数据是字节流中的第 1025 ~ 2048 字节，那么该报文段的序号值就是 ISN + 1025。另外一个传输方向（从 B 到 A）的 TCP 报文段的序号值也具有相同的含义。 </li><li>32 位<code>确认号</code>（acknowledgement number）：用作对另一方发送来的 TCP 报文段的<code>响应</code>。其值是收到的 TCP 报文段的序号值 + 标志位长度（SYN，FIN） + 数据长度 。假设主机 A 和主机 B 进行 TCP 通信，那么 A 发送出的 TCP 报文段不仅携带自己的序号，而且包含对 B 发送来的 TCP 报文段的确认号。反之，B 发送出的 TCP 报文段也同样携带自己的序号和对 A 发送来的报文段的确认序号。 </li><li>4 位头部长度（head length）：标识该 TCP 头部有多少个 32 bit(4 字节)。因为 4 位最大能表示 15，所以 TCP 头部最长是60 字节。 </li><li>6 位标志位包含如下几项： URG 标志，表示紧急指针（urgent pointer）是否有效。 <ul><li>ACK 标志，表示<code>确认</code>号是否有效。我们称携带 ACK 标志的 TCP 报文段为确认报文段。 </li><li>PSH 标志，提示接收端应用程序应该立即从 TCP 接收缓冲区中读走数据，为接收后续数据腾 出空间（如果应用程序不将接收到的数据读走，它们就会一直停留在 TCP 接收缓冲区中）。 </li><li>RST 标志，表示要求对方<code>重新建立连接</code>。我们称携带 RST 标志的 TCP 报文段为复位报文段。 </li><li>SYN 标志，表示<code>请求建立一个连接</code>。我们称携带 SYN 标志的 TCP 报文段为同步报文段。 </li><li>FIN 标志，表示通知对方本端要<code>关闭</code>连接了。我们称携带 FIN 标志的 TCP 报文段为结束报文段。（四次挥手 ） </li><li>16 位窗口大小（window size）：是 TCP 流量控制的一个手段。这里说的窗口，指的是接收通告窗口（Receiver Window，RWND）。它告诉对方本端的 TCP 接收缓冲区还能容纳多少字节的数据，这样对方就可以控制发送数据的速度。 </li><li>16 位校验和（TCP checksum）：由发送端填充，接收端对 TCP 报文段执行 CRC 算法以校验 TCP 报文段在传输过程中是否损坏。注意，这个校验不仅包括 TCP 头部，也包括数据部分。 这也是 TCP 可靠传输的一个重要保障。</li><li>16 位紧急指针（urgent pointer）：是一个正的偏移量。它和序号字段的值相加表示最后一 个紧急数据的下一个字节的序号。因此，确切地说，这个字段是紧急指针相对当前序号的偏 移，不妨称之为紧急偏移。TCP 的紧急指针是发送端向接收端发送紧急数据的方法。</li></ul></li></ul><p>客户端 <code>connect()</code> 主动建立连接的时候，底层会通过TCP协议做三次握手。 </p><p><img src="https://img-blog.csdnimg.cn/bf5c181c873441c1886719ac0bb58537.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>具体的数据是是通过 TCP 头部发送的。</p><p><img src="https://img-blog.csdnimg.cn/6de04e24e5924020aceb406ebaf1848b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>客户端和服务端要想建立连接，各自都要确认一些数据，即都确认自己可以<code>发数据</code>也可以<code>收数据</code>。当每一方都确认了自己正常运作才能正式建立连接。一旦有一方其中一个功能无法实现，就无法实现通信。 </p><p><img src="/2022/04/24/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220428231107203.png" alt="image-20220428231107203"></p><ul><li>seq：序号</li><li>ack：确认序号，ACK=1时ack才有效。<ul><li>如何确定数据完整？</li><li>如何确定字节流顺序正确？server发送 1 2 3，客户端可能接收到3 1 2。</li></ul></li></ul><p>每一个字节都会被分配唯一的编号。收到SYN或FIN后的回复会把ack+1，其余都是加上数据的大小。</p><p>第一次握手： </p><ol><li>客户端将 <code>SYN</code> 标志位置为 1 </li><li>生成一个随机的32位的序号 <code>seq = J</code> ， 这个序号后边是可以携带数据（数据的大小，其实是在头部后面） </li></ol><p>第二次握手： </p><ol><li>服务器端接收客户端的连接： <code>ACK = 1</code> </li><li>服务器会回发一个确认序号： <code>ack = 客户端的序号 + 数据长度 + SYN/FIN(按一个字节算) </code></li><li>服务器端会向客户端发起连接请求： <code>SYN = 1</code> </li><li>服务器会生成一个随机序号：<code>seq = K </code></li></ol><p>第三次握手： </p><ol><li>客户单应答服务器的连接请求：<code>ACK = 1</code> </li><li>客户端回复收到了服务器端的数据：<code>ack = 服务端的序号 + 数据长度 + SYN/FIN(按一个字节算)</code></li></ol><p><img src="https://img-blog.csdnimg.cn/8fd4c4c04fbb4ee48a2564a5fa95a819.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="14-TCP-滑动窗口"><a href="#14-TCP-滑动窗口" class="headerlink" title="14. TCP 滑动窗口"></a>14. TCP 滑动窗口</h2><p>TCP 头部存有 16位窗口大小，双方通信时不断提醒对方己方缓冲区的剩余大小。如果对方的缓冲区容量足够，就可以发送数据；如果对方缓冲区大小为0，就阻塞等待。</p><p>滑动窗口（Sliding window）是一种<code>流量控制技术</code>。早期的网络通信中，通信双方不会考虑网络的拥挤情况直接发送数据。由于大家不知道网络拥塞状况，同时发送数据，导致中间节点<code>阻塞掉包</code>， 谁也发不了数据，所以就有了滑动窗口机制来解决此问题。滑动窗口协议是用来改善吞吐量的一种技术，即容许发送方在接收任何应答之前传送附加的包。接收方告诉发送方在某一时刻能送多少包 （称<code>窗口尺寸</code>）。 </p><p>TCP 中采用滑动窗口来进行传输控制，滑动窗口的大小意味着接收方还有多大的缓冲区可以用于接收数据。<strong>发送方可以通过滑动窗口的大小来确定应该发送多少字节的数据。</strong>当滑动窗口为 0 时，发送方一般不能再发送数据报。</p><p>滑动窗口是 TCP 中实现诸如 ACK 确认、流量控制、拥塞控制的承载结构。</p><p><code>窗口</code>理解为<code>缓冲区的大小</code>，滑动窗口的大小会随着发送数据和接收数据而变化，通信的双方都有发送缓冲区和接收数据的缓冲区。</p><ul><li><p>服务器</p><ul><li>发送缓冲区（发送缓冲区的窗口） </li><li>接收缓冲区（接收缓冲区的窗口） </li></ul></li><li><p>客户端 </p><ul><li>发送缓冲区（发送缓冲区的窗口） </li><li>接收缓冲区（接收缓冲区的窗口）</li></ul></li></ul><p><img src="https://img-blog.csdnimg.cn/89a20618722945cfb50ea1fc59d87418.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><blockquote><p>发送方的缓冲区： </p><p>​        白色格子：空闲的空间 </p><p>​        灰色格子：数据已经被发送出去了，但是还没有被接收 </p><p>​        紫色格子：还没有发送出去的数据 </p><p>接收方的缓冲区： </p><p>​        白色格子：空闲的空间 </p><p>​        紫色格子：已经接收到的数据</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/2237c437911b439c86f52e94aa55eba5.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><blockquote><p># mss: Maximum Segment Size(一条数据的最大的数据量) </p><p># win: 滑动窗口 </p><ol><li>客户端向服务器<code>发起连接</code>（SYN，第一次握手不能携带数据，因为还没有建立连接），客户单的滑动窗口是4096，一次发送的最大数据量是1460 </li><li>服务器接收连接情况，告诉客户端服务器的窗口大小是6144，一次发送的最大数据量是1024 </li><li>第三次握手（三次握手之后接收方才能给发送方发送数据）</li><li>4-9 客户端连续给服务器发送了6k的数据，每次发送1k </li><li>第10次，服务器告诉客户端：发送的6k数据以及接收到，存储在缓冲区中，缓冲区数据已经处理了2k,窗 口大小是2k </li><li>第11次，服务器告诉客户端：发送的6k数据以以及接收到，存储在缓冲区中，缓冲区数据已经处理了4k,窗 口大小是4k</li><li>第12次，客户端给服务器发送了1k的数据 </li></ol></blockquote><p>四次挥手</p><p>客户端主动请求与服务器断开连接</p><blockquote><ol><li><p>第13次，<code>第一次挥手</code>，客户端主动请求和服务器<code>断开连接</code>(<code>客户端发送FIN</code>，从现在开始主动的一方就不能再发送数据了)，并且给服务器发送了1k的数据 </p></li><li><p>第14次，<code>第二次挥手</code>，服务器回复<code>ACK</code> 8194,</p><p>a:同意断开连接的请求</p><p>b:告诉客户端已经接受到方才发的2k的数据 </p><p>c:滑动窗口2k </p></li><li><p>第15、16次，通知客户端滑动窗口的大小 </p></li><li><p>第17次，<code>第三次挥手</code>，<code>服务器端给客户端发送FIN</code>,<code>请求断开连接</code> </p></li><li><p>第18次，<code>第四次挥手</code>，<code>客户端同意</code>了服务器端的断开请求</p></li></ol></blockquote><h2 id="14-TCP-四次挥手"><a href="#14-TCP-四次挥手" class="headerlink" title="14. TCP 四次挥手"></a>14. TCP 四次挥手</h2><p>四次挥手发生在<code>断开连接</code>的时候，在程序中当调用了 <code>close()</code> 会使用TCP协议进行四次挥手。 客户端和服务器端<code>都可以主动发起断开连接</code>，谁先调用 close() 谁就是发起。 因为在TCP连接的时候，采用三次握手建立的的连接是双向的，在断开的时候需要<code>双向断开</code>。</p><p>为什么要断开，直接终止进程不可以吗？两方都把对方的信息保存在系统当中，必须释放它们。</p><p><img src="https://img-blog.csdnimg.cn/255f0a654dd346e083bb595f88b00df4.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>为什么四次挥手服务端发送的的 <code>ack</code> 和 <code>FIN</code> 要分两次发送？</p><p>因为客户端请求断开，但是服务端此时可能不想断开，可能还要发送一些数据。</p><p>因此先 <code>ack</code> 确认收到断开请求，这里到 <code>FIN</code> 服务端请求断开之间服务端可能还往客户端传输了很多的数据。</p><p>建立连接是双方的意愿，请求断开是单方的意愿。</p><h2 id="15-TCP-通信并发"><a href="#15-TCP-通信并发" class="headerlink" title="15. TCP 通信并发"></a>15. TCP 通信并发</h2><p>并发：一台咖啡机，两队人取咖啡</p><p>并行：两台咖啡机，两队同时取咖啡</p><p>服务端通过 <code>accept</code> 接收客户端的连接请求。</p><p>因此，如果要实现并发的服务器，我们需要使用<code>多个进程或者线程</code>处理多个客户端的额连接请求。</p><h3 id="15-1-多进程实现并发服务器"><a href="#15-1-多进程实现并发服务器" class="headerlink" title="15.1 多进程实现并发服务器"></a>15.1 <code>多进程</code>实现并发服务器</h3><p>注意点：1. 写数据末尾的 ‘\0’ 问题</p><pre><code>              2. 父进程被中断（产生信号后去执行回调，软中断），新的客户端无法连接进来              3. 父进程 read 错误（进程结束但是没有 close fd）</code></pre><p>运行服务器端，并连接两个客户端，大家都顺利运行。</p><p>我们终止一个客户端。</p><p><img src="https://img-blog.csdnimg.cn/a7a11e6c8fb54c4da96f969345cdddb4.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>惊奇地发现服务器端产生了一个中断并继续执行。</p><p>服务器端的父进程被中断退出，</p><p>和被终止的客户端对接的子进程退出，</p><p>另一个子进程正常运行。</p><p> <img src="https://img-blog.csdnimg.cn/c68a39bf1fb34a86995e1c69388c8860.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>由于父进程已经退出了，因此希望建立连接的新客户端就无法连接上服务端了。</p><p><img src="https://img-blog.csdnimg.cn/f57c1123db494d62aac2314009a5b32b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>man 手册中可以查到这个错误。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">EINTR    The system call was interrupted by a signal that was caught before a valid connection arrived<span class="token punctuation">;</span> see <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>因此我们只要特判一下，一旦产生这个错误就忽略。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">continue</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="示例代码（server）"><a href="#示例代码（server）" class="headerlink" title="示例代码（server）"></a>示例代码（server）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span><span class="token keyword">void</span> <span class="token function">recycleChild</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 多个孩子死亡，死循环一直回收，不然可能死了3个只能回收一个</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// 所有的子进程都回收完了</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"回收了子进程 pid = %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 注册信号捕捉 父进程回收子进程资源</span>    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>    act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 清空临时阻塞信号集</span>    act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> recycleChild<span class="token punctuation">;</span>    <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 创建 socket</span>    <span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>listen_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 绑定端口和ip</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3. 监听</span>    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 4. 循环等待客户端请求</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 接受客户端连接请求</span>        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientAddr<span class="token punctuation">;</span>        <span class="token keyword">int</span> clientAddrLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>client_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 排一个子进程去处理通信</span>        <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 子进程</span>            <span class="token comment">// 获取客户端信息</span>            <span class="token keyword">char</span> clientIP<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">unsigned</span> <span class="token keyword">short</span> clientPort <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>clientAddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client ip : %s, port : %d\n"</span><span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> clientPort<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 接收客户端的数据</span>            <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server receive : %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token function">write</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 回射服务器，原封不动发送回去</span>            <span class="token punctuation">}</span>                <span class="token function">close</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 子进程退出    </span>                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="示例代码（client）"><a href="#示例代码（client）" class="headerlink" title="示例代码（client）"></a>示例代码（client）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       <span class="token comment">// 1. 创建套接字</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 连接服务器端</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serveraddr<span class="token punctuation">;</span>    serveraddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">"172.24.190.150"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serveraddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>    serveraddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serveraddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serveraddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3. 通信</span>    <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> send_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 给服务端发送数据</span>        <span class="token function">sprintf</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">,</span> <span class="token string">"client send: %d"</span><span class="token punctuation">,</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> send_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 把\0也写过去</span>                <span class="token comment">//读取服务端的数据</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"receive server data: %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server closed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">// 4. 关闭连接</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="15-2-多线程实现并发服务器"><a href="#15-2-多线程实现并发服务器" class="headerlink" title="15.2 多线程实现并发服务器"></a>15.2 <code>多线程</code>实现并发服务器</h3><h5 id="示例代码（server）-1"><a href="#示例代码（server）-1" class="headerlink" title="示例代码（server）"></a>示例代码（server）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">struct</span> <span class="token class-name">sockInfo</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>                     <span class="token comment">// 通信的文件描述符</span>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>              <span class="token comment">// 线程号</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span>    <span class="token comment">// 客户端信息</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">sockInfo</span> sockinfos<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">working</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 文件描述符，客户端信息，线程号</span>    <span class="token keyword">struct</span> <span class="token class-name">sockInfo</span> <span class="token operator">*</span>info <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockInfo</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>     <span class="token comment">// 获取客户端信息</span>    <span class="token keyword">char</span> clientIP<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>addr<span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> clientPort <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client ip : %s, port : %d\n"</span><span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> clientPort<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 接收客户端的数据</span>    <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server receive : %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">write</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 回射服务器，原封不动发送回去</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 恢复占用标记</span>    info<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    info<span class="token operator">-&gt;</span>tid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 初始化</span>    <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sockinfos<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sockinfos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">// 无效文件描述符，标识avaliable</span>        sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tid <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 1. 创建 socket</span>    <span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>listen_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 绑定端口和ip</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3. 监听</span>    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 4. 循环等待客户端连接请求</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 接受客户端连接请求</span>        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientAddr<span class="token punctuation">;</span>        <span class="token keyword">int</span> clientAddrLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>client_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 创建子线程</span>        <span class="token comment">// 找到可用的sockInfo</span>        <span class="token keyword">struct</span> <span class="token class-name">sockInfo</span>  <span class="token operator">*</span>info<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                info <span class="token operator">=</span> <span class="token operator">&amp;</span>sockinfos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> max <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// 从头开始找空闲</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        info<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> client_fd<span class="token punctuation">;</span>        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clientAddr<span class="token punctuation">,</span> clientAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token operator">-&gt;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> working<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 释放资源，不能用 join，因为它是阻塞的</span>        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="示例代码（client）-1"><a href="#示例代码（client）-1" class="headerlink" title="示例代码（client）"></a>示例代码（client）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       <span class="token comment">// 1. 创建套接字</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 连接服务器端</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serveraddr<span class="token punctuation">;</span>    serveraddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">"172.24.190.150"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serveraddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>    serveraddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serveraddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serveraddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3. 通信</span>    <span class="token keyword">char</span> receive_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> send_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 给服务端发送数据</span>        <span class="token function">sprintf</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">,</span> <span class="token string">"client send: %d"</span><span class="token punctuation">,</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> send_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 把\0也写过去</span>                <span class="token comment">//读取服务端的数据</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> receive_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>receive_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"receive server data: %s\n"</span><span class="token punctuation">,</span> receive_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server closed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">// 4. 关闭连接</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="16-TCP-状态转换"><a href="#16-TCP-状态转换" class="headerlink" title="16. TCP 状态转换"></a>16. TCP 状态转换</h2><p>发生再三次握手和四次挥手的时候，中间通信的时候状态不会改变。</p><p>为什么要经过 <code>2MSL</code>? 因为要保证数据安全，保证第四次挥手的 <code>ack</code> 被对方接收到。让对方不断地发送 <code>FIN</code>，使得主动关闭方发送的 <code>ack</code> 被对方接收到。</p><p>主动请求断开的一方才会经历这个。</p><p>客户端第四次挥手发送 <code>ack</code> 服务器端的断开请求，可能服务端没有接收到，因此服务端会再次给客户端发送 <code>FIN</code>,直到客户端发送的 <code>ack</code> 被服务端接收到，这样通信才能正常断开连接。</p><p> <img src="https://img-blog.csdnimg.cn/99cd1ad203c74b16ae90794f894f49bc.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/b1499a5b285245da9a9d011239ba3e1f.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> </p><p><strong>2MSL（Maximum Segment Lifetime）</strong></p><blockquote><p>主动断开连接的一方, 最后进出入一个 TIME_WAIT状态, 这个状态会持续: 2msl </p></blockquote><p><strong>msl</strong>:</p><blockquote><p>官方建议: 2分钟, 实际是30s</p></blockquote><p>当 TCP 连接<code>主动关闭方</code>接收到被动关闭方发送的 FIN 和最终的 ACK 后，连接的主动关闭方必须处于TIME_WAIT 状态并持续 2MSL 时间。 这样就能够让 TCP 连接的主动关闭方在它发送的 ACK 丢失的情况下重新发送最终的 ACK。 主动关闭方重新发送的最终 ACK 并不是因为被动关闭方重传了 ACK（它们并不消耗序列号， 被动关闭方也不会重传），而是因为被动关闭方重传了它的 FIN。事实上，<strong>被动关闭方总是 重传 FIN 直到它收到一个最终的 ACK</strong>。</p><h2 id="17-半关闭"><a href="#17-半关闭" class="headerlink" title="17. 半关闭"></a>17. 半关闭</h2><p><strong>半关闭</strong>（被动关闭端不断发送收拾残局的数据）</p><p>当 TCP 链接中 A 向 B 发送 FIN 请求关闭，另一端 B 回应 ACK 之后（A 端进入 FIN_WAIT_2 状态），并没有立即发送 FIN 给 A，A 方处于半连接状态（半开关）。</p><p>此时 A 可以接收 B 发 送的数据，但是 A 已经不能再向 B 发送数据。</p><p>A-&gt;B：close()</p><p>B-&gt;A：ack</p><p>但是B不给A发送 close()，也就是说被动方暂时不想关闭不进行第三次挥手。</p><p>然而，我们调用 close 会直接关闭文件描述符，这样的话主动方既不能读也不能写。但是我们希望主动方可以读，不能写。</p><p>从程序的角度，可以使用 API 来控制实现半连接状态：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> how<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>参数：</p><ul><li><p>bsockfd：需要关闭的socket的描述符</p></li><li><p>how：允许为 shutdown 操作选择以下几种方式:</p><ul><li><p>SHUT_RD(0)：</p><p>关闭sockfd上的读功能，此选项将不允许sockfd进行读操作。<br>该套接字不再接收数据，任何当前在套接字接受缓冲区的数据将被无声地<code>丢弃</code>掉。</p></li><li><p>SHUT_WR(1): </p><p>关闭sockfd的写功能，此选项将不允许sockfd进行写操作。进程不能在对此套接字发出写操作。</p></li></ul></li><li><p>SHUT_RDWR(2):</p><p>关闭sockfd的读写功能。相当于调用shutdown两次：首先是以SHUT_RD,然后以 SHUT_WR。</p></li></ul><p>使用 close 中止一个连接，但它只是<code>减少描述符的引用计数</code>，并不直接关闭连接，只有当描述符的引用 计数为 0 时才关闭连接。子进程和父进程共享文件描述符，在子进程中关闭只会引用计数 -1。只有当引用计数=0时，文件描述符资源才会被释放。</p><p>shutdown 不考虑描述符的引用计数，<code>直接关闭</code>描述符。也可选择中止一个方向的连接，只中止读或只中止写。 </p><p>注意: </p><ol><li>如果有多个进程共享一个套接字，close 每被调用一次，计数减 1 ，直到计数为 0 时，也就是所用 进程都调用了 close，套接字将被释放。 </li><li>在多进程中如果一个进程调用了 shutdown(sfd, SHUT_RDWR) 后，其它的进程将无法进行通信。 但如果一个进程 close(sfd) 将不会影响到其它进程。</li></ol><h2 id="18-端口复用"><a href="#18-端口复用" class="headerlink" title="18. 端口复用"></a>18. 端口复用</h2><p>启动服务端，可以看到有个它正处于 LISTEN 状态下。</p><p>服务端使用我们指定的 <code>9999</code> 号端口。</p><p><img src="https://img-blog.csdnimg.cn/c0151ebbf7bf44c2bc7e6bee7d96870f.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>启动客户端， 可以看到客户端已经和服务端建立连接，处于 <code>ESTABLISHED</code> 状态下。</p><p>客户端的 ip 是 <code>127.24.190.150</code>，并使用系统随机分配的 <code>55332</code> 号端口。</p><p><img src="https://img-blog.csdnimg.cn/e6167947fbe343748c628442265e7074.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>在通信的过程中我们不断查看状态，会发现没有任何改变。</p><p>这也印证了上面所说的 TCP 状态只有在三次握手和四次挥手的时候会转变，在通信过程中不会改变。</p><p>然而，我们主动断开服务端后，其处于 <code>FIN_WAIT2</code> 状态。</p><p>当我们断开客户端后，服务端处于 <code>TIME_WAIT</code>，会根据系统设定的时长一直等待。因此它还在占用着这个端口。</p><p>如果有其他进程想要使用这个端口就会失败。</p><p>端口复用最常用的用途：</p><ul><li> 防止服务器重启时之前绑定的端口还未释放 </li><li>程序突然退出而系统没有释放端口</li></ul><p>设置套接字的属性（不仅仅能设置端口复用）</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> optname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>optval<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span>optlen<span class="token punctuation">)</span><span class="token punctuation">;</span>参数：<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>sockfd : 要操作的文件描述符</p></li><li><p>level : 级别 - SOL_SOCKET (端口复用的级别)</p></li><li><p>optname : 选项的名称</p><ul><li>SO_REUSEADDR</li><li>SO_REUSEPORT</li></ul></li><li><p>optval : 端口复用的值（整形）, void*可以设置int也可以设置结构体</p><ul><li>1 : 可以复用</li><li>0 : 不可以复用</li></ul></li><li><p>optlen : optval参数的大小</p><p>端口复用，设置的时机是在服务器绑定端口之前。<br>先setsockopt() 再 bind()。</p></li></ul><h2 id="19-IO多路复用"><a href="#19-IO多路复用" class="headerlink" title="19. IO多路复用"></a>19. IO多路复用</h2><h3 id="19-1-IO多路复用介绍"><a href="#19-1-IO多路复用介绍" class="headerlink" title="19.1 IO多路复用介绍"></a>19.1 IO多路复用介绍</h3><p>也叫 I/O多路转接。</p><p>传统：</p><blockquote><p>输入：文件 -&gt; 内存，</p><p>输出：内存 -&gt; 文件</p></blockquote><p>在网络编程中指的是通信双方操作 socket 读写缓冲区。</p><p>I/0 多路复用指程序能<code>同时监听</code>多个文件描述符，提高程序的性能。程序同时监听，知道有多少个客服端发来了消息。</p><h5 id="BIO-模型"><a href="#BIO-模型" class="headerlink" title="BIO 模型"></a>BIO 模型</h5><p> <img src="https://img-blog.csdnimg.cn/e13ab2a6021b45109be286a1e1507276.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/9c298786ac684c5bb10b678bee0b6b0f.png" alt="img"></p><h5 id="NIO-模型"><a href="#NIO-模型" class="headerlink" title="NIO 模型"></a>NIO 模型</h5><p><img src="https://img-blog.csdnimg.cn/75da6c51b51f4dfcb92c4ab0f6424b94.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/5e8b08577e304fd6ba8219322f5d7b55.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>通信需要遍历所有已经连接的客户端的文件描述符。</p><h5 id="I-O-多路转接技术"><a href="#I-O-多路转接技术" class="headerlink" title="I/O 多路转接技术"></a>I/O 多路转接技术</h5><p>原先自己检测多路通过 read\rece 判断读每一个文件描述符的读缓冲区有无数据。</p><p>现在把所有的文件描述符给内核检查，只调用一次就行了。</p><p><img src="https://img-blog.csdnimg.cn/6519308b434842c794bc06858a34819e.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/403c641c968d4caf9c27c4ff088a4f15.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="19-2-select"><a href="#19-2-select" class="headerlink" title="19.2 select"></a>19.2 select</h3><p>不使用多进程或多线程。</p><p>主旨思想：</p><ul><li>构造一个关于<code>文件描述符</code>的<code>列表</code>，将要监听的文件描述符添加到列表中。</li><li>调用一个系统函数，监听该列表中的文件描述符，直到这些文件描述符中<code>一个或多个</code>进行IO操作时，函数返回。<ul><li>该函数<code>阻塞</code></li><li>函数会文件描述符的检测由内核完成</li></ul></li><li>返回时，告诉进程有<code>多少</code>文件描述符要进行IO操作。</li></ul><p><img src="https://img-blog.csdnimg.cn/9318fc1ce6ae456481ffcf5bf82b077d.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h4 id="相关函数"><a href="#相关函数" class="headerlink" title="相关函数"></a>相关函数</h4><p>头文件</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* According to POSIX.1-2001, POSIX.1-2008 */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span><span class="token comment">/* According to earlier standards */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="select"><a href="#select" class="headerlink" title="select"></a>select</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span>           fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">{</span>    <span class="token keyword">long</span>    tv_sec<span class="token punctuation">;</span>         <span class="token comment">/* seconds */</span>    <span class="token keyword">long</span>    tv_usec<span class="token punctuation">;</span>        <span class="token comment">/* microseconds */</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数：</p><ul><li><p>nfds：委托内核检测的最大文件描述符的值 + 1</p></li><li><p>readfds：要检测的文件描述符的读的集合，委托内核检测那些文件描述符的读属性</p><p>​                  对应对方发送过来的数据，读是被动接受数据，检测读缓冲区</p><p>​                  传入 + 传出参数 long int</p></li><li><p>writefds：要检测的文件描述符的写的集合，委托内核检测那些文件描述符的写属性</p><p>​                  检测写缓冲区是否还可以写数据，不满就可以写</p><p>​                  一般不去检测，数据满了就阻塞</p></li><li><p>exceptfds：检测发生异常的文件描述符的集合，一般不使用</p></li><li><p>timeout：超时时间，如果没有检测到内容会阻塞。</p><ul><li>NULL：永久阻塞，直到检测到了文件描述符有变化</li><li>tv_sec = 0, tv_usec  = 0 —&gt; 不阻塞</li><li>tv_sec &gt; 0, tv_usec &gt; 0，阻塞对应的时间</li></ul></li></ul><p>返回值：</p><ul><li>失败：-1</li><li>成功：检测的集合中有 n 个文件描述符发生了变化</li></ul><h5 id="FD-CLR"><a href="#FD-CLR" class="headerlink" title="FD_CLR"></a>FD_CLR</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FD_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>作用：将 fd 对应的标志位置0</p><h5 id="FD-ISSET"><a href="#FD-ISSET" class="headerlink" title="FD_ISSET"></a>FD_ISSET</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span>  <span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>作用：判断 fd 对应的标志位是0还是1</p><p>返回值：fd 对应的标志位的值（0、1）</p><h5 id="FD-SET"><a href="#FD-SET" class="headerlink" title="FD_SET"></a>FD_SET</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>作用：将 fd 对应的标志位设置为1</p><h5 id="FD-ZERO"><a href="#FD-ZERO" class="headerlink" title="FD_ZERO"></a>FD_ZERO</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FD_ZERO</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>作用：fdset的1024个比特位全部初始化为 0</p><h5 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建 socket</span>    <span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>    <span class="token comment">// 2. 绑定 </span>    <span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 监听</span>    <span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. fd_set</span>    fd_set rdset<span class="token punctuation">,</span> tmp<span class="token punctuation">;</span>    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rdset<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">FD_SET</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rdset<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> maxfd <span class="token operator">=</span> listen_fd<span class="token punctuation">;</span>  <span class="token comment">// 要监听的最大的 fd</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        tmp <span class="token operator">=</span> rdset<span class="token punctuation">;</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>maxfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永久阻塞</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">// 这里没可能</span>        <span class="token punctuation">{</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientAddr<span class="token punctuation">;</span>                <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 通信文件描述符添加到集合中</span>                <span class="token function">FD_SET</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rdset<span class="token punctuation">)</span><span class="token punctuation">;</span>                maxfd <span class="token operator">=</span> maxfd <span class="token operator">&gt;</span> client_fd <span class="token operator">?</span> maxfd <span class="token operator">:</span> client_fd<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> listen_fd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> maxfd<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rdset<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    <span class="token comment">// 说明该 fd 对应的客户端发来了数据</span>                    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>                    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed ...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">FD_CLR</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rdset<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server read:%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">write</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 回写</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/8c7b63fe0a194d85b5dc72d05257df6b.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="19-3-poll"><a href="#19-3-poll" class="headerlink" title="19.3 poll"></a>19.3 poll</h3><p>优化版的 select，支持文件描述符数组重用，不需要额外的开销。</p><p>但是没多大差别</p><h5 id="相关函数-1"><a href="#相关函数-1" class="headerlink" title="相关函数"></a>相关函数</h5><h5 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>fds<span class="token punctuation">,</span> <span class="token class-name">nfds_t</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span><span class="token comment">// 委托内核检测的文件描述符</span>    <span class="token keyword">short</span> <span class="token keyword">int</span> events<span class="token punctuation">;</span><span class="token comment">// 委托内核检测文件描述符的什么事件</span>    <span class="token keyword">short</span> <span class="token keyword">int</span> revents<span class="token punctuation">;</span><span class="token comment">// 文件描述符实际发生的事件</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数：</p><ul><li>fds：一个 struct pollfd 类型的结构体数组，要检测的文件描述符的集合</li><li>nfds：第一个参数数组中的最后一个有效元素的下标</li><li>timeout：阻塞市时长<ul><li>0：不阻塞</li><li>-1：阻塞，当文件描述符有变化时，接触阻塞</li><li>&gt; 0：阻塞时长</li></ul></li></ul><p>返回值：</p><ul><li>-1：失败</li><li>&gt; 0 (n)：成功，检测到了n个文件描述符发生变化</li></ul><p>event 对应的宏</p><p><img src="https://img-blog.csdnimg.cn/fbf00fbf751b4506acfcf7c909799f85.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><h5 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a>示例代码</h5><p>呃呃，我的代码有bug，还没有调好。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建 socket</span>    <span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>    serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>    <span class="token comment">// 2. 绑定 </span>    <span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 监听</span>    <span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 要维护的监听到有改变的文件描述符集合</span>    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> fds<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>     <span class="token comment">// hope 检测读的事件</span>    <span class="token punctuation">}</span>    fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> listen_fd<span class="token punctuation">;</span>    <span class="token keyword">int</span> nfds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">// 最大的有新数据的文件描述符</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 调用poll系统函数，让内核帮检测哪些文件描述符有数据</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>fds<span class="token punctuation">,</span> nfds <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"poll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">// 这里没可能</span>        <span class="token punctuation">{</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">// 监听到了有文件描述符发生变化</span>        <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token comment">// 判断 revents，即实际发生的事件</span>            <span class="token punctuation">{</span>                <span class="token comment">// 说明有客户端向监听端口发消息了，他想要连接进来</span>                <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientAddr<span class="token punctuation">;</span>                <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 把新连接进来的客户端加入集合添加到集合中</span>                <span class="token comment">// 从头遍历找空闲文件描述符</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> client_fd<span class="token punctuation">;</span>                        fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>                        <span class="token comment">// 更新目前最大的文件描述符</span>                        nfds <span class="token operator">=</span> nfds <span class="token operator">&gt;</span> i <span class="token operator">?</span> nfds <span class="token operator">:</span> i<span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                                <span class="token punctuation">}</span>            <span class="token comment">// 响应客户端</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> nfds<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    <span class="token comment">// 说明该 fd 对应的客户端发来了数据</span>                    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>                    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed ...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">close</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// i 是索引，真正的文件描述符要去取</span>                        fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"server read:%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">write</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 回写</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="19-4-epoll"><a href="#19-4-epoll" class="headerlink" title="19.4 epoll"></a>19.4 epoll</h3><p>​    通过 <code>epoll_create</code> 在内核中创建一个 epoll 实例 (struct，包含一个rbtree和一个就绪的链表)，返回一个 int，是个文件描述符。但并不是通过 read，write 直接操作，而是通过 epoll 相关的 api。</p><p>​    希望内核检测的文件描述符存储在 <code>rbr</code> 中，实际发生改变的文件描述符就存储在 <code>rdlist</code> 里面。</p><p>​    通过 <code>epoll_ctl</code>  一些参数，通过 <code>epoll_wait</code> 等待内核检测并通过传出参数返回改变了的文件描述符，会拷贝一次。</p><p><img src="https://img-blog.csdnimg.cn/7d03e5b89da345bfb5c1c91a8ed9e6ea.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="相关函数-2"><a href="#相关函数-2" class="headerlink" title="相关函数"></a>相关函数</h5><h5 id="epoll-create"><a href="#epoll-create" class="headerlink" title="epoll_create"></a>epoll_create</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> creates a new epoll instance<span class="token punctuation">.</span>  Since Linux <span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span> the size argument is ignored<span class="token punctuation">,</span> but must be 【greater than zero】<span class="token punctuation">;</span> see NOTES below<span class="token punctuation">.</span>       <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  returns  a  【file  descriptor】 referring to the new epoll instance<span class="token punctuation">.</span>  This file descriptor is used <span class="token keyword">for</span> all the subsequent calls to the epoll interface<span class="token punctuation">.</span>  When no longer required<span class="token punctuation">,</span> the file descriptor returned by <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> should be closed by using 【close】<span class="token punctuation">.</span>  When  all  file  descriptors referring to an epoll instance have been closed<span class="token punctuation">,</span> the kernel destroys the instance and releases the associated resources <span class="token keyword">for</span> reuse<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>size：目前没有意义了，随便写一个非零的数。以前使用哈希去实现的，现在被改进了。</li></ul><p>返回值：</p><ul><li>失败： -1</li><li>成功：&gt; 0，一个文件描述符，用于操作 epoll 实例，通过这个返回的文件描述符就可以找到内核中的这块数据</li></ul><h5 id="epoll-ctl"><a href="#epoll-ctl" class="headerlink" title="epoll_ctl"></a>epoll_ctl</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       This  system  call is used to add<span class="token punctuation">,</span> modify<span class="token punctuation">,</span> or remove entries in the interest list of the <span class="token function">epoll</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> instance referred to by the file descriptor epfd<span class="token punctuation">.</span>       It requests that the operation op be performed <span class="token keyword">for</span> the target file descriptor<span class="token punctuation">,</span> fd<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：control interface for an epoll file descriptor</p><p>参数：</p><ul><li><p><code>epfd</code> 指定了在内核中实例化的 <code>epoll实例</code>，本质上就是一块数据，通过 epfd 来引用。</p></li><li><p><code>op</code> 是我们想要对 <code>fd</code> 这个文件描述符做的事情包括：</p><ul><li>EPOLL_CTL_<strong>ADD</strong> 增加</li></ul><p>​    Add fd to the interest list and associate the settings specified in event with the internal file linked to fd. 往红黑树中新添加一个结点。</p><ul><li>EPOLL_CTL_<strong>MOD</strong> 修改</li></ul><p>​    Change the settings associated with fd in the interest list to the new settings specified in event.</p><ul><li>EPOLL_CTL_**DEL **删除</li></ul><p>​    Remove (deregister) the target file descriptor fd from the interest list.  The event argument is ignored and can be NULL (but see  BUGS  below).</p></li><li><p><code>fd</code>：被操作的文件描述符,这个系统调用的主角</p></li><li><p>event：要检测的事件，如果检测到了就让内核去做 <code>op</code> 这个事件（EPOLLIN, EPOLLOUT, EPOLLERR等）</p></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">union</span> epoll_data <span class="token punctuation">{</span><span class="token comment">// 一些用户的数据信息，一般来说使用 fd 就成</span>    <span class="token keyword">void</span>        <span class="token operator">*</span>ptr<span class="token punctuation">;</span>    <span class="token keyword">int</span>          fd<span class="token punctuation">;</span>    <span class="token class-name">uint32_t</span>     u32<span class="token punctuation">;</span>    <span class="token class-name">uint64_t</span>     u64<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token class-name">epoll_data_t</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token punctuation">{</span>    <span class="token class-name">uint32_t</span>     events<span class="token punctuation">;</span>      <span class="token comment">/* Epoll events */</span>    <span class="token class-name">epoll_data_t</span> data<span class="token punctuation">;</span>        <span class="token comment">/* User data variable */</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="epoll-wait"><a href="#epoll-wait" class="headerlink" title="epoll_wait"></a>epoll_wait</h5><p>检测函数</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">,</span>               <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>The  <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  system  call  waits  <span class="token keyword">for</span> events on the epoll instance referred to by the file descriptor 【epfd】<span class="token punctuation">.</span>  The memory area pointed to by 【events】 will contain the events that will be available <span class="token keyword">for</span> the caller<span class="token punctuation">.</span>  Up to 【maxevents】 are returned by <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  The maxevents  argument  must be greater than zero<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：wait for an I/O event on an epoll file descriptor</p><p>参数：</p><ul><li>epfd</li><li>epoll_event：传出参数，发生改变的那几个文件描述符信息</li><li>maxevents：第二个参数 epoll_event 的大小</li><li>timeout：阻塞时间<ul><li>0：不阻塞</li><li>-1：阻塞，知道检测到信息解除阻塞</li><li>&gt; 0：要阻塞的时长</li></ul></li></ul><p>返回值：</p><ul><li>成功：<ul><li>&gt; 0：发生改变的文件描述符数量</li><li>= 0：没有任何变化</li></ul></li><li>失败：-1</li></ul><h5 id="示例代码-3"><a href="#示例代码-3" class="headerlink" title="示例代码"></a>示例代码</h5><h2 id="20-UDP"><a href="#20-UDP" class="headerlink" title="20. UDP"></a>20. UDP</h2><h3 id="20-1-UDP-通信"><a href="#20-1-UDP-通信" class="headerlink" title="20.1 UDP 通信"></a>20.1 UDP 通信</h3><h3 id="20-2-广播"><a href="#20-2-广播" class="headerlink" title="20.2 广播"></a>20.2 广播</h3><h3 id="20-3-组播"><a href="#20-3-组播" class="headerlink" title="20.3 组播"></a>20.3 组播</h3><h3 id="20-4-本地套接字通信"><a href="#20-4-本地套接字通信" class="headerlink" title="20.4 本地套接字通信"></a>20.4 本地套接字通信</h3>]]></content>
      
      
      <categories>
          
          <category> 系统编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux多线程</title>
      <link href="/2022/04/23/Linux%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
      <url>/2022/04/23/Linux%E5%A4%9A%E7%BA%BF%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-多线程"><a href="#Linux-多线程" class="headerlink" title="Linux 多线程"></a>Linux 多线程</h1><h2 id="1-什么是线程"><a href="#1-什么是线程" class="headerlink" title="1. 什么是线程"></a>1. 什么是线程</h2><h3 id="1-1-线程概述"><a href="#1-1-线程概述" class="headerlink" title="1.1 线程概述"></a>1.1 线程概述</h3><p><img src="https://img-blog.csdnimg.cn/63d34bdae18642b498d13c1932dcf8cd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这里的 “多个任务”，可以是相同的也可以是不同的。</p><p><code>并发</code>，宏观上多个任务同时执行，微观上CPU在不同的程序之间来回快速切换。</p><p><code>并行</code>，他们真的在同时执行。（多核处理器）</p><p><code>进程</code>是CPU分配资源的最小单位</p><p><code>线程</code>是操作系统调度执行的最小单位</p><p>进程重量级，线程轻量级，内核把线程当作进程来看待。</p><p>利用 <code>ps aux</code> 可以查看当前运行的进程</p><p>ps a 显示现行终端机下的所有程序，包括其他用户的程序。</p><p>ps u 　 以用户为主的格式来显示程序状况。</p><p>ps x 　 显示所有程序，不以终端机来区分。</p><p><img src="https://img-blog.csdnimg.cn/bdf48b89966744978044ce821a9fd437.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>可以看到，火狐的new-window进程的 <code>PID</code> = 105266</p><p>执行 <code>ps -Lf 105266</code> , 可以看到同一个进程 105266 下有许多的线程 (<code>LWP</code>, 即轻量级进程)</p><p>他们的进程号 PID 是相同的，但是线程号 LWP 天各一方</p><p>可见，许多应用程序使是用多线程去实现的</p><p><img src="https://img-blog.csdnimg.cn/eb3a709fcdb34b7cb848cbad50ba0faa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="1-2-线程-amp-进程-の-difference"><a href="#1-2-线程-amp-进程-の-difference" class="headerlink" title="1.2 线程 &amp; 进程 の difference"></a>1.2 线程 &amp; 进程 の difference</h3><p><img src="https://img-blog.csdnimg.cn/8850622c21224232afc38711be33129c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>Linux 刚开始在开发的时候没有线程的概念，只有进程，后来通过第三方库加进去。</p><p><code>fork()</code>可以创建一个子进程，他会复制（代价非常高，要复制内存页表，文件描述符表等）父进程的虚拟地址空间。进程间通信困难，因为父子进程并没有共享内存。子进程的虚拟地址空间也会被映射到物理内存上。</p><h5 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h5><p><img src="https://img-blog.csdnimg.cn/02d1c96532fc442f87ec5e706647fb45.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="子进程完全复制父进程的地址空间"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h5><p><code>栈</code>和<code>.text(代码段)</code>会被分配给每一个线程。</p><p>main是主线程，其他的都是子线程。</p><p>其他的地址都是共享的（内核区）。</p><p><img src="https://img-blog.csdnimg.cn/83a47c07a3bb49b79807388df3f7bd79.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_11,color_FFFFFF,t_70,g_se,x_16" alt="线程间共享地址空间，只有少数几个区域私有"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="1-3-线程间的资源共享"><a href="#1-3-线程间的资源共享" class="headerlink" title="1.3 线程间的资源共享"></a>1.3 线程间的资源共享</h3><p>内核中有些数据也是不共享的，这些基本都是线程特有的数据。</p><p><img src="https://img-blog.csdnimg.cn/77b0d89b970a4233aa89b6c61f483940.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="1-4-NPTL"><a href="#1-4-NPTL" class="headerlink" title="1.4 NPTL"></a>1.4 NPTL</h3><p>NPTL = Native POSIX Thread Library</p><p>现在用的了线程库是 Red Hat 开发的。</p><p><img src="https://img-blog.csdnimg.cn/07a6f679204b42729f5034cdf7a0666c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"></p><p>在终端输入 <code>getconf GNU_LIBPTHREAD_VERSION</code> 指令。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/4f528923b05243aab1bd4d862725fdb6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h2 id="2-创建线程"><a href="#2-创建线程" class="headerlink" title="2. 创建线程"></a>2. 创建线程</h2><p>一般情况下，main函数所在的线程称之为 <code>主线程</code>，其余线程称之为 <code>子线程</code>。</p><p>程序中默认只有一个进程，<code>fork</code>后会有两个进程。</p><p>程序中默认只有一个线程,<code>pthread_create</code>后会有两个线程。</p><h5 id="pthread-create"><a href="#pthread-create" class="headerlink" title="pthread_create"></a>pthread_create</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>                    <span class="token keyword">const</span> <span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span>                   <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>start_routine<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 线程属性结构体 pthread_attr_t</span><span class="token keyword">union</span> <span class="token class-name">pthread_attr_t</span><span class="token punctuation">{</span><span class="token comment">// #  define __SIZEOF_PTHREAD_ATTR_T 56</span><span class="token keyword">char</span> __size<span class="token punctuation">[</span>__SIZEOF_PTHREAD_ATTR_T<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">long</span> <span class="token keyword">int</span> __align<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>Compile and link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>    The <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function starts a new thread in the calling process<span class="token punctuation">.</span>  The new thread starts execution by invoking 【<span class="token function">start_routine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>】<span class="token punctuation">;</span> 【arg】 is passed as the sole argument of <span class="token function">start_routine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>The new thread terminates in one of the following ways<span class="token operator">:</span>       <span class="token operator">*</span> It calls <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> specifying an exit status value that is available to another thread in the same process that calls <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token operator">*</span> It returns from <span class="token function">start_routine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  This is equivalent to calling <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> with the value supplied in the <span class="token keyword">return</span> statement<span class="token punctuation">.</span>       <span class="token operator">*</span> It is <span class="token function">canceled</span> <span class="token punctuation">(</span>see <span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token operator">*</span> Any of the threads in the process calls <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> or the main thread performs a <span class="token keyword">return</span> from <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  This causes the termination of all threads in the process<span class="token punctuation">.</span>        Before returning<span class="token punctuation">,</span> a successful call to <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> stores 【the ID of the new thread】 in the buffer pointed to by 【thread】<span class="token punctuation">;</span> this identifier is used to refer to the thread in subsequent calls to other pthreads functions<span class="token punctuation">.</span>    The 【attr】 argument points to a 【<span class="token class-name">pthread_attr_t</span> structure】 whose contents are used at thread creation time to determine attributes <span class="token keyword">for</span> the new thread<span class="token punctuation">;</span> this structure is initialized using <span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> and related functions<span class="token punctuation">.</span> If attr is <span class="token constant">NULL</span><span class="token punctuation">,</span> then the thread is created with <span class="token keyword">default</span> attributes<span class="token punctuation">.</span>The new thread inherits a copy of the creating thread's signal <span class="token function">mask</span> <span class="token punctuation">(</span><span class="token function">pthread_sigmask</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  The set of pending signals <span class="token keyword">for</span> the new thread is <span class="token function">empty</span> <span class="token punctuation">(</span><span class="token function">sigpending</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  The new thread does not inherit the creating thread's alternate signal <span class="token function">stack</span> <span class="token punctuation">(</span><span class="token function">sigaltstack</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>The new thread inherits the calling thread's floating<span class="token operator">-</span>point <span class="token function">environment</span> <span class="token punctuation">(</span><span class="token function">fenv</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>The initial value of the new thread's CPU<span class="token operator">-</span>time clock is <span class="token number">0</span> <span class="token punctuation">(</span>see <span class="token function">pthread_getcpuclockid</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数：</p><ul><li><p>thread：是个unsigned long int类型的指针，传出参数，在该子线程返回之前，将子线程的ID存储在thread指向的buffer中。</p><ul><li><code>typedef unsigned long int pthread_t;</code></li></ul></li><li><p>attr：设置<code>线程属性</code>（详见7.），使用NULL就行。想自己设置的话就定义一个结构把地址传进去。</p></li><li><p>*start_routine：是个函数指针，子线程要处理的逻辑代码。他的返回值是 <code>void *</code>，传入的参数也是 <code>void *</code>。</p></li><li><p>arg：给函数使用，是个传入参数</p></li></ul><p>返回值：On success, pthread_create() returns <code>0</code>; </p><p>​                on error, it returns <code>an error number</code>,</p><p>​                            这个error和之前的实现方式一样，但不是一个体系的，不能通过perror将它输出</p><p>​                            获取错误信息： <code>char *strerror(int errnum);</code>，定义在 <code>string.h</code> 里。</p><p>​                and the contents of <code>*thread（第一个传出参数）</code> are undefined.</p><h5 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">callBack</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child thread...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建一个子线程</span>        <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> callBack<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然而，编译后发现报错了</p><p><img src="https://img-blog.csdnimg.cn/06a274eb06224b2a92ff336a183ca84b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>因为我们的线程库是第三方库，因此要指定库的名称。</p><p><code>gcc pthread_create.c -o app -pthread</code></p><p>它的全称是 <code>libpthread.so</code></p><p>然而加上库之后似乎子线程没有执行。</p><p><img src="https://img-blog.csdnimg.cn/c4bd1d95770d4289acff17611d69b1d9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_14,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>要么子线程还没创建就return 0了，要么子线程创建完还没跑主线程就结束了，虚拟地址空间之间全部销毁。</p><p>我们让主线程睡一秒，使得子线程抢到    CPU的执行权。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">callBack</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child thread...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建一个子线程</span>        <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> callBack<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/9709855909074bc193aaa00c3220de89.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_13,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>这样我们就可以看到子线程执行的代码了。</p><h5 id="测试代码（子线程获取参数）"><a href="#测试代码（子线程获取参数）" class="headerlink" title="测试代码（子线程获取参数）"></a>测试代码（子线程获取参数）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">callBack</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child thread...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"arg para: %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建一个子线程</span>    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> callBack<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/b243d22354524647a3797a137fe0e31c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_12,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="3-终止线程"><a href="#3-终止线程" class="headerlink" title="3. 终止线程"></a>3. 终止线程</h2><h5 id="pthread-exit"><a href="#pthread-exit" class="headerlink" title="pthread_exit"></a>pthread_exit</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">void</span> <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>Compile and link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>    DESCRIPTION       The <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function 【terminates the calling thread】 and 【returns a value】 via retval <span class="token function">that</span> <span class="token punctuation">(</span><span class="token keyword">if</span> the thread is joinable<span class="token punctuation">)</span> is available to another thread in the same process that calls 【pthread_join】<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       Any  clean<span class="token operator">-</span>up  handlers established by <span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> that have not yet been popped<span class="token punctuation">,</span> are <span class="token function">popped</span> <span class="token punctuation">(</span>in the reverse of the order in which they were pushed<span class="token punctuation">)</span> and executed<span class="token punctuation">.</span>  If the thread has any thread<span class="token operator">-</span>specific data<span class="token punctuation">,</span> then<span class="token punctuation">,</span>after the clean<span class="token operator">-</span>up handlers have been executed<span class="token punctuation">,</span> the corresponding destructor functions are called<span class="token punctuation">,</span> in an unspecified order<span class="token punctuation">.</span>       When a thread terminates<span class="token punctuation">,</span> process<span class="token operator">-</span>shared <span class="token function">resources</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span><span class="token punctuation">,</span> mutexes<span class="token punctuation">,</span> condition variables<span class="token punctuation">,</span> semaphores<span class="token punctuation">,</span> and file descriptors<span class="token punctuation">)</span> are not released<span class="token punctuation">,</span> and functions registered using <span class="token function">atexit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> are not called<span class="token punctuation">.</span>       After the last thread in a process terminates<span class="token punctuation">,</span> the process terminates as by calling <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> with an exit status of zero<span class="token punctuation">;</span> thus<span class="token punctuation">,</span> process<span class="token operator">-</span>shared resources are released and functions registered using <span class="token function">atexit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> are called<span class="token punctuation">.</span>RETURN VALUE       This function does 【not <span class="token keyword">return</span>】 to the caller<span class="token punctuation">.</span>ERRORS       This function always succeeds<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：终止一个线程，在哪个线程中调用就终止哪个线程</p><p>参数：</p><ul><li>retval：传递一个指针，传出参数，勾出来一个返回值，可以用在 <code>pthread_join()</code> 中</li></ul><h5 id="pthread-self"><a href="#pthread-self" class="headerlink" title="pthread_self"></a>pthread_self</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token class-name">pthread_t</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Compile and link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>DESCRIPTION       The <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function 【returns the ID of the calling thread】<span class="token punctuation">.</span>  This is the same value that is returned in <span class="token operator">*</span>thread in the <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> call that created this thread<span class="token punctuation">.</span>RETURN VALUE       This function always succeeds<span class="token punctuation">,</span> returning the calling thread's ID<span class="token punctuation">.</span>ERRORS       This function always succeeds<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：获取调用该函数的线程的线程ID</p><h5 id="pthread-equal"><a href="#pthread-equal" class="headerlink" title="pthread_equal"></a>pthread_equal</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">pthread_equal</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> t1<span class="token punctuation">,</span> <span class="token class-name">pthread_t</span> t2<span class="token punctuation">)</span><span class="token punctuation">;</span>Compile and link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>DESCRIPTION       The <span class="token function">pthread_equal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function 【compares two thread identifiers】<span class="token punctuation">.</span>RETURN VALUE       If the two thread IDs are equal<span class="token punctuation">,</span> <span class="token function">pthread_equal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns 【a nonzero value】<span class="token punctuation">;</span>    otherwise<span class="token punctuation">,</span> it returns 【<span class="token number">0</span>】<span class="token punctuation">.</span>ERRORS       This function always succeeds<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：比较两个线程ID是否相等。不同操作系统<code>pthread_t类型</code>实现不同，有的是<code>unsigned long int</code>，有的使用结构体。使用该函数可以更好地跨平台。</p><h5 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">callBack</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">//for(int i = 0; i &lt; 100; ++ i)</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child thread tid = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建一个子线程</span>    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> callBack<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread tid = %ld, child thread tid = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 主线程退出，不影响其他线程的正常运行</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"man thread exit!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，最后的 man thread exit! 并没有被打印出来，说明该进程还没有结束。</p><p>主线程终止不影响其他线程的继续执行。</p><p><img src="https://img-blog.csdnimg.cn/9dbcb4dfe34645ed853e9d73b7f5d9b9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="4-连接已终止的线程"><a href="#4-连接已终止的线程" class="headerlink" title="4. 连接已终止的线程"></a>4. 连接已终止的线程</h2><h5 id="pthread-join"><a href="#pthread-join" class="headerlink" title="pthread_join"></a>pthread_join</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>Compile and link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>DESCRIPTION       The <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function 【waits <span class="token keyword">for</span> the thread】 specified by thread 【to terminate】<span class="token punctuation">.</span>  If that thread has already terminated<span class="token punctuation">,</span> then <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns immediately<span class="token punctuation">.</span>  The thread specified by thread must be joinable<span class="token punctuation">.</span>       If  【retval】  is  not  <span class="token constant">NULL</span><span class="token punctuation">,</span> then <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> copies the exit status of the target <span class="token function">thread</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> the value that the target thread supplied to <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> into the location pointed to by retval<span class="token punctuation">.</span>  If the target thread was canceled<span class="token punctuation">,</span> then PTHREAD_CANCELED is placed in the location pointed to by retval<span class="token punctuation">.</span>       If multiple threads simultaneously try to join with the same thread<span class="token punctuation">,</span> the results are undefined<span class="token punctuation">.</span>  If the thread calling <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is canceled<span class="token punctuation">,</span> then the target thread will remain <span class="token function">joinable</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> it will not be detached<span class="token punctuation">)</span><span class="token punctuation">.</span>RETURN VALUE       On success<span class="token punctuation">,</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns 【<span class="token number">0</span>】<span class="token punctuation">;</span> on error<span class="token punctuation">,</span> it returns an 【error number】<span class="token punctuation">.</span>ERRORS    EDEADLK    A deadlock was <span class="token function">detected</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span><span class="token punctuation">,</span> two threads tried to join with each other<span class="token punctuation">)</span><span class="token punctuation">;</span> or thread specifies the calling thread<span class="token punctuation">.</span>    EINVAL     thread is not a joinable thread<span class="token punctuation">.</span>    EINVAL     Another thread is already waiting to join with this thread<span class="token punctuation">.</span>    ESRCH      No thread with the ID thread could be found<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用： join with a terminated thread 和一个已经终止的线程进行连接，去释放它的资源。说白了就是回收资源。</p><p>​            是个<code>阻塞函数</code>，直到有个子线程结束了才会继续往下执行。</p><p>​            调用一次只能回收一个子线程。</p><p>​            一般在主线成中使用。</p><p>​            父进程有责任回收子进程PCB的资源。 </p><p>​            和子进程一样，子线程运行结束也需要回收资源。一种是wait,waitpid来手动回收，一种是父线程先死亡后由1号进程领养。</p><p>​            但是子线程不一定需要通过主线程回收，任何线程都可以回收已经终止的线程。</p><p>​            多个线程运行结束不回收会产生<code>僵尸线程</code>。</p><p>参数：</p><ul><li>thread：需要回收的子线程的线程ID</li><li>revtal：就子线程退出时的返回值</li></ul><h5 id="示例代码（阻塞）"><a href="#示例代码（阻塞）" class="headerlink" title="示例代码（阻塞）"></a>示例代码（阻塞）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">callBack</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child thread tid = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 使得 pthread_join 阻塞</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token comment">// 相当于执行 pthread_exit(NULL);</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建一个子线程</span>    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> callBack<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread tid = %ld, child thread tid = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 主线程调用 pthread_join 回收子线程资源</span>    <span class="token comment">// 只要子线程还在 sleep， 就不会调用成功</span>    ret <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"回收子线程资源成功\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 主线程退出，不影响其他线程的正常运行</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行可以发现程序阻塞了3秒才打印消息。</p><h5 id="示例代码（不要返回局部变量的地址）"><a href="#示例代码（不要返回局部变量的地址）" class="headerlink" title="示例代码（不要返回局部变量的地址）"></a>示例代码（不要返回局部变量的地址）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">callBack</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">//for(int i = 0; i &lt; 100; ++ i)</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child thread tid = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 子线程退出时的返回值</span>    <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 相当于 return (void*)&amp;value;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建一个子线程</span>    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> callBack<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread tid = %ld, child thread tid = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 主线程调用 pthread_join 回收子线程资源</span>    <span class="token comment">// 只要子线程还在 sleep， 就不会调用成功</span>    <span class="token keyword">int</span> <span class="token operator">*</span>thread_retval<span class="token punctuation">;</span>    ret <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>thread_retval<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"子线程 exit value: %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>thread_retval<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"回收子线程资源成功\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 主线程退出，不影响其他线程的正常运行</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>返回值我们明明指定的是10，然而却打印了很奇怪的东西出来。</p><p>这是因为我们定义了一个局部变量，并返回了它的地址。</p><p>然而函数返回后子线程的栈就被销毁了，因此这个值是未定义的。</p><p><img src="https://img-blog.csdnimg.cn/d0a02e3c856e4b75a563135f23e5bae8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>如果我们把这个 value 变成全局变量，就不会有这个问题。</p><p><img src="https://img-blog.csdnimg.cn/6df788a45d814f70ae7cfc820e146753.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="为什么要传二级指针？"><a href="#为什么要传二级指针？" class="headerlink" title="为什么要传二级指针？"></a>为什么要传二级指针？</h5><p>因为 <code>pthread_exit</code> 返回一个指针，在 <code>pthread_join</code> 内部我们要改变传入参数 <code>retval</code>， 也就是说，我们要把一个地址赋值给另一个指针变量。</p><p>假如我们要改变一个 int 类型的变量的值，就需要在函数中传入这个变量的地址，也就是个一级指针。</p><p>因此，如果我们要改变一个 int* 类型的变量的值，也就是改变一个地址的值，我们需要在函数中传入这个地址的地址，也就是 int**。</p><h2 id="5-线程的分离"><a href="#5-线程的分离" class="headerlink" title="5. 线程的分离"></a>5. 线程的分离</h2><h5 id="pthread-detach"><a href="#pthread-detach" class="headerlink" title="pthread_detach"></a>pthread_detach</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>       Compile and link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>DESCRIPTION       The <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function marks the thread identified by 【thread】 as detached<span class="token punctuation">.</span>  When a detached thread terminates<span class="token punctuation">,</span> its 【resources】 are 【automatically released】 back to the system without the need <span class="token keyword">for</span> another thread to join with the terminated thread<span class="token punctuation">.</span>       Attempting to detach an already detached thread results in 【unspecified behavior】<span class="token punctuation">.</span>RETURN VALUE       On success<span class="token punctuation">,</span> <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns 【<span class="token number">0</span>】<span class="token punctuation">;</span> on error<span class="token punctuation">,</span> it returns an 【error number】<span class="token punctuation">.</span>ERRORS       EINVAL thread is not a joinable thread<span class="token punctuation">.</span>       ESRCH  No thread with the ID thread could be found<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：分离一个线程。被分离的线程终止后，会自动释放资源返回给系统。（无需其他线程手动 ptyhread_join）</p><p>​            不可以多次分离，该行为未定义。</p><p>​            不可以去连接一个已经分离的线程（自动释放），会报错。</p><p>参数：</p><ul><li>thread：需要分离的线程的线程ID</li></ul><h5 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">callBack</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child thread ID: %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       <span class="token comment">// 1. 创建一个子线程 可以for创建多个，有个东西叫【线程池】，里面有很多的子线程</span>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> callBack<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error create: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread tid = %ld, child thread tid = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 分离子线程 - 子线程分离后，其资源不需要主线程释放</span>    ret <span class="token operator">=</span> <span class="token function">pthread_detach</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"err detach: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 错误操作</span>    ret <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"err join: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3. 主线程退出</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果我们在 detach 后再join，会发现错误。</p><p><img src="https://img-blog.csdnimg.cn/2b800fa060234dafb8e0f3ede846dad7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="6-线程取消"><a href="#6-线程取消" class="headerlink" title="6. 线程取消"></a>6. 线程取消</h2><h5 id="pthread-cancel"><a href="#pthread-cancel" class="headerlink" title="pthread_cancel"></a>pthread_cancel</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>Compile and link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>DESCRIPTION       The  <span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function 【sends a cancellation request to the thread】 【thread】<span class="token punctuation">(</span>参数<span class="token punctuation">)</span><span class="token punctuation">.</span>  Whether and when the target thread reacts to the cancellation request depends on two attributes that are under the control of that thread<span class="token operator">:</span> its 【cancelability state】 and 【type】<span class="token punctuation">.</span>       A thread<span class="token char">''</span>s 【cancelability state】<span class="token punctuation">,</span> determined by <span class="token function">pthread_setcancelstate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> can be <span class="token function">enabled</span> <span class="token punctuation">(</span>the <span class="token keyword">default</span> <span class="token keyword">for</span> new threads<span class="token punctuation">)</span> or disabled<span class="token punctuation">.</span>  If a thread has 【disabled】 cancellation<span class="token punctuation">,</span> then a cancellation request 【remains queued】 【until the thread enables cancellation】<span class="token punctuation">.</span>    If a thread has 【enabled】 cancellation<span class="token punctuation">,</span> then its 【cancelability type】 determines when cancellation occurs<span class="token punctuation">.</span>A thread<span class="token char">''</span>s 【cancellation type】<span class="token punctuation">,</span> determined by 【pthread_setcanceltype】<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> may be either <span class="token function">asynchronous</span><span class="token punctuation">(</span>异步<span class="token punctuation">)</span> or <span class="token function">deferred</span> <span class="token punctuation">(</span>the <span class="token keyword">default</span> <span class="token keyword">for</span> new threads<span class="token punctuation">)</span><span class="token punctuation">.</span>  Asynchronous cancelability means that the thread can be canceled 【at any time】 <span class="token punctuation">(</span>usually 【immediately】<span class="token punctuation">,</span> but the system does not guarantee this<span class="token punctuation">)</span><span class="token punctuation">.</span>  Deferred cancelability means that cancellation will be 【delayed】 until the thread next calls a function that is a 【cancellation point】<span class="token punctuation">.</span>  A list of functions that are or may be cancellation points is provided in <span class="token function">pthreads</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       When a cancellation requested is acted on<span class="token punctuation">,</span> the following steps occur <span class="token keyword">for</span> <span class="token function">thread</span> <span class="token punctuation">(</span>in this order<span class="token punctuation">)</span><span class="token operator">:</span>       <span class="token number">1.</span> Cancellation clean<span class="token operator">-</span>up handlers are <span class="token function">popped</span> <span class="token punctuation">(</span>in the reverse of the order in which they were pushed<span class="token punctuation">)</span> and called<span class="token punctuation">.</span>  <span class="token punctuation">(</span>See <span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">)</span>       <span class="token number">2.</span> Thread<span class="token operator">-</span>specific data destructors are called<span class="token punctuation">,</span> in an unspecified order<span class="token punctuation">.</span>  <span class="token punctuation">(</span>See <span class="token function">pthread_key_create</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">)</span>       <span class="token number">3.</span> The thread is terminated<span class="token punctuation">.</span>  <span class="token punctuation">(</span>See <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                  The above steps happen asynchronously with respect to the <span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> call<span class="token punctuation">;</span> the <span class="token keyword">return</span> status of <span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> merely informs the caller whether the cancellation request was successfully queued<span class="token punctuation">.</span>       After a canceled thread has terminated<span class="token punctuation">,</span> a join with that thread using <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> obtains PTHREAD_CANCELED as the thread's exit status<span class="token punctuation">.</span>  <span class="token punctuation">(</span>Joining with a thread is the only way to know that cancellation has completed<span class="token punctuation">.</span><span class="token punctuation">)</span>RETURN VALUE       On success<span class="token punctuation">,</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns 【<span class="token number">0</span>】<span class="token punctuation">;</span>    on error<span class="token punctuation">,</span> it returns a 【nonzero error number】<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：取消线程（让线程终止）。比如杀毒软件清理垃圾，需要开启一个新的线程去清理垃圾。当你不想清理了，可以点取消 cancel 这个线程。 线程对于 cancel请求的反应取决于state和type。</p><p>​            取消某个线程可以终止某个线程的运行，<code>Asynchronous cancelability</code>可以立即取消这个线程；<code>deferred cancelability</code> 并不会马上取消这个线程，而是等待线程执行到某个 <code>cancellation point (取消点)</code> 才会取消该线程。</p><p>什么是 cancellation point（取消点）？可以粗略地认为是一些定义好的系统调用，即用户区到内核区的切换点。</p><p>​        POSIX.1  specifies  that  certain  functions must, and certain other functions may, be cancellation points.  If a thread is cancelable, its cancelability type is deferred, and a cancellation request is pending for the thread.then the thread is canceled when it calls a function that is a cancellation point.</p><h5 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">callBack</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child thread ID: %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 这里的 printf 就是一个 cancellation point</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       <span class="token comment">// 1. 创建一个子线程 可以for创建多个，有个东西叫【线程池】，里面有很多的子线程</span>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> callBack<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error create: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 取消线程</span>    <span class="token function">pthread_cancel</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread tid = %ld, child thread tid = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 主线程退出</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，我们只执行了第一个printf线程就被取消了。</p><p>据说 <code>printf</code> 就是一个取消点，它底层调用了 write 函数往 STDOUT 里面写数据。</p><p><img src="https://img-blog.csdnimg.cn/146bdc47d04848cb9c4191196c642717.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/b570798186744c20b72f0f4bf6ae9bb6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/67eda3a0c3ea4e81b10ff2d93d208891.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_13,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>为了测试，我们看看是不是只要一碰到printf就取消。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">callBack</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 这里的 printf 就是一个 cancellation point</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看样子是的了，子线程进入循环后执行了一次 printf 就取消了。</p><p><img src="https://img-blog.csdnimg.cn/20601e44fe8a404c99728ada688a2c04.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>我想试验一下异步的方式马上取消</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">pthread_setcanceltype</span><span class="token punctuation">(</span>PTHREAD_CANCEL_ASYNCHRONOUS<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但是似乎没什么用，可能就是文档里说的 <code>The thread can be canceled at any time.  (Typically, it will be canceled immediately upon receiving a cancellation request, but the system doesn't guarantee this.)</code></p><h2 id="7-线程属性"><a href="#7-线程属性" class="headerlink" title="7. 线程属性"></a>7. 线程属性</h2><h5 id="相关函数"><a href="#相关函数" class="headerlink" title="相关函数"></a>相关函数</h5><p><img src="https://img-blog.csdnimg.cn/23fbea880af64d12a41f9de3e028c2f2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>属性变量可以设置很多东西，可以设置分离状态、栈、栈地址、栈大小等等。但是很少会用到。</p><p>有时会用到 setstacksize，因为线城市平均分配栈的大小，如果你觉得小了可以手动设置。</p><p><img src="https://img-blog.csdnimg.cn/46fd3b0de3bb4b3395471f75e9733579.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>属性变量是个 <code>pthread__attr_t</code> 类型的结构体，占用内存。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 线程属性结构体 pthread_attr_t</span><span class="token keyword">union</span> <span class="token class-name">pthread_attr_t</span><span class="token punctuation">{</span><span class="token comment">// #  define __SIZEOF_PTHREAD_ATTR_T 56</span><span class="token keyword">char</span> __size<span class="token punctuation">[</span>__SIZEOF_PTHREAD_ATTR_T<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">long</span> <span class="token keyword">int</span> __align<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="pthread-attr-init-amp-pthread-attr-destroy"><a href="#pthread-attr-init-amp-pthread-attr-destroy" class="headerlink" title="pthread_attr_init &amp; pthread_attr_destroy"></a>pthread_attr_init &amp; pthread_attr_destroy</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">pthread_attr_destroy</span><span class="token punctuation">(</span><span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>Compile and link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>    DESCRIPTION       The  <span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  function  【initializes the thread attributes object】 pointed to by 【attr】 with <span class="token keyword">default</span> attribute values<span class="token punctuation">.</span>  After this call<span class="token punctuation">,</span> individual attributes of the object can be  set  using  various  related <span class="token function">functions</span>  <span class="token punctuation">(</span>listed under SEE ALSO<span class="token punctuation">)</span><span class="token punctuation">,</span> and then the object 【can be used in one or more <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> calls】 that create threads<span class="token punctuation">.</span>       Calling <span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> on a thread attributes object that has 【already been initialized】 results in 【undefined behavior】<span class="token punctuation">.</span>       When  a  thread  attributes  object is no longer required<span class="token punctuation">,</span> it should be destroyed using the <span class="token function">pthread_attr_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function<span class="token punctuation">.</span>  Destroying a thread attributes object 【has no effect on threads】 that  were  created  using that object<span class="token punctuation">.</span>       Once  a thread attributes object has been destroyed<span class="token punctuation">,</span> it can be reinitialized using <span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  Any other 【use of a destroyed thread attributes object】 has 【undefined results】<span class="token punctuation">.</span>RETURN VALUE       On success<span class="token punctuation">,</span> these functions <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> on error<span class="token punctuation">,</span> they <span class="token keyword">return</span> a nonzero error number<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="示例代码-3"><a href="#示例代码-3" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">callBack</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child thread ID: %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       <span class="token comment">// 1. 创建一个线程属性变量</span>    <span class="token class-name">pthread_attr_t</span> attr<span class="token punctuation">;</span>    <span class="token comment">// 2. 初始化属性变量</span>    <span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 设置属性（分离状态）</span>    <span class="token comment">// 不需要任何人去回收，他自己会释放资源</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_attr_setdetachstate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> PTHREAD_CREATE_DETACHED<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error setdetachstate: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"set detach attribute successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 4. 创建一个子线程</span>    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>    ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> callBack<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 把属性变量传到第二个参数里</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>err <span class="token operator">=</span> <span class="token function">strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error create: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread tid = %ld, child thread tid = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5. 释放属性资源</span>    <span class="token function">pthread_attr_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 6. 主线程退出</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="pthread-attr-setdetachstate-amp-pthread-attr-getdetachstate"><a href="#pthread-attr-setdetachstate-amp-pthread-attr-getdetachstate" class="headerlink" title="pthread_attr_setdetachstate &amp; pthread_attr_getdetachstate"></a>pthread_attr_setdetachstate &amp; pthread_attr_getdetachstate</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">pthread_attr_setdetachstate</span><span class="token punctuation">(</span><span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">int</span> detachstate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">pthread_attr_getdetachstate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>detachstate<span class="token punctuation">)</span><span class="token punctuation">;</span>Compile and link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>DESCRIPTION       The <span class="token function">pthread_attr_setdetachstate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function sets the detach state attribute of the thread attributes object referred to by 【attr】to the value specified in 【detachstate】<span class="token punctuation">.</span>  The detach state attribute determines whether a thread created using the thread attributes object attr will be created in a joinable or a detached state<span class="token punctuation">.</span>The following values may be specified in 【detachstate】<span class="token operator">:</span>PTHREAD_CREATE_DETACHEDThreads that are created using attr will be created in a detached state<span class="token punctuation">.</span>PTHREAD_CREATE_JOINABLEThreads that are created using attr will be created in a joinable state<span class="token punctuation">.</span>       The <span class="token keyword">default</span> setting of the detach state attribute in a newly initialized thread attributes object is PTHREAD_CREATE_JOINABLE<span class="token punctuation">.</span>       The <span class="token function">pthread_attr_getdetachstate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns the detach state attribute of the thread attributes object attr in the buffer pointed to by detachstate<span class="token punctuation">.</span>RETURN VALUE       On success<span class="token punctuation">,</span> these functions <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> on error<span class="token punctuation">,</span> they <span class="token keyword">return</span> a nonzero error number<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-线程同步"><a href="#8-线程同步" class="headerlink" title="8. 线程同步"></a>8. 线程同步</h2><p>先来看个案例</p><h5 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">int</span> tickets <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">work</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 临界区↓</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%ld 正在卖第 %d 张门票\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">--</span> tickets<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 临界区↑</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建三个子线程同时买票</span>    <span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">,</span> tid3<span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> work<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> work<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid3<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> work<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 回收</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid3<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 退出主线程</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们一共才100张票，为什么会卖第0张，第-1张呢？</p><p><img src="https://img-blog.csdnimg.cn/f6b2fa68b53c4210bf46b0def587a2de.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>由于多个线程是在争抢CPU的资源，因此会发生多个线程同时进入该函数修改我们的值。</p><p>我们需要A操作的时候，B、C不可以去操作，B、C依然。</p><p>我们需要保持原子性。</p><p>不可以边读边修改。</p><p><img src="https://img-blog.csdnimg.cn/e3692e917a544962a64a6a2bbd1ad613.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>和数据库中 <code>事务</code> 的概念一样，我们需要保证临界区代码执行的原子性，即要么都执行，要么都不执行，没有执行到一半别人来执行这么一个道理。</p><p>虽然线程同步会带来一定的效率问题，因为必须等别的线程执行完了另一个线程才能进来。</p><p>但同步是必须的。</p><h2 id="9-互斥锁"><a href="#9-互斥锁" class="headerlink" title="9. 互斥锁"></a>9. 互斥锁</h2><h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><p><img src="https://img-blog.csdnimg.cn/d2bdd89d834146b08c4227780165aee9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/9bb04052ca33459daaa46e133faf0ca7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="相关函数-1"><a href="#相关函数-1" class="headerlink" title="相关函数"></a>相关函数</h5><p><img src="https://img-blog.csdnimg.cn/0e9d42c391b14380b9634f45d68bfa9e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="pthread-mutex-init"><a href="#pthread-mutex-init" class="headerlink" title="pthread_mutex_init"></a>pthread_mutex_init</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">,</span>                        <span class="token keyword">const</span> <span class="token class-name">pthread_mutexattr_t</span> <span class="token operator">*</span>mutexattr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>参数：</p><ul><li><p>mutex：需要初始化的<code>互斥量</code>变量</p></li><li><p>*mutexattr：互斥量相关属性</p></li></ul><h5 id="pthread-mutex-destroy"><a href="#pthread-mutex-destroy" class="headerlink" title="pthread_mutex_destroy"></a>pthread_mutex_destroy</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>作用：释放互斥量的资源</p><h5 id="pthread-mutex-lock"><a href="#pthread-mutex-lock" class="headerlink" title="pthread_mutex_lock"></a>pthread_mutex_lock</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>作用：加锁，是阻塞的，如果有个线程加锁了，其他线程只能等待</p><h5 id="pthread-mutex-trylock"><a href="#pthread-mutex-trylock" class="headerlink" title="pthread_mutex_trylock"></a>pthread_mutex_trylock</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pthread_mutex_trylock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>作用：尝试加锁，不阻塞，加不了锁就返回</p><h5 id="pthread-mutex-unlock"><a href="#pthread-mutex-unlock" class="headerlink" title="pthread_mutex_unlock"></a>pthread_mutex_unlock</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>作用：解锁</p><h5 id="测试代码（霸道线程）"><a href="#测试代码（霸道线程）" class="headerlink" title="测试代码（霸道线程）"></a>测试代码（霸道线程）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">int</span> tickets <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token comment">// 创建一个锁</span><span class="token class-name">pthread_mutex_t</span> mutex<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">work</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 加锁</span>    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 临界区 start</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%ld 正在卖第 %d 张门票\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">--</span> tickets<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 临界区 end</span>    <span class="token comment">// 解锁</span>    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 初始化锁</span>    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 创建三个子线程同时买票</span>    <span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">,</span> tid3<span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> work<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> work<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid3<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> work<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 回收</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid3<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 退出主线程</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 销毁锁</span>    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这么些有点问题。</p><p>我们可以发现，由于临界区代码是个 while 循环，抢到cpu资源的线程会独占这段代码。</p><p>虽然结果正确了，但是这都是由一个线程完成的，其他的线程被饿死了。</p><p><img src="https://img-blog.csdnimg.cn/1ae1e81bcb8a4362a45fabd1886b19e8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">int</span> tickets <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">// 创建一个锁</span><span class="token class-name">pthread_mutex_t</span> mutex<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">work</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 加锁</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 临界区 start</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%ld 正在卖第 %d 张门票\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">--</span> tickets<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span>        <span class="token punctuation">{</span>             <span class="token comment">// 解锁</span>            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 临界区 end</span>        <span class="token comment">// 解锁</span>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>       <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 初始化锁</span>    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 创建三个子线程同时买票</span>    <span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">,</span> tid3<span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> work<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> work<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid3<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> work<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 回收</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid3<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 退出主线程</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 销毁锁</span>    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样子就正确了。</p><p><img src="https://img-blog.csdnimg.cn/241f94094854407d825a6a5a2047072f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> <img src="https://img-blog.csdnimg.cn/e8cb9cb484f24c76b63d0546237c6e13.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> <img src="https://img-blog.csdnimg.cn/878352039fa4470aba38303d5393867e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>下面这个代码是错误的，因为大家分别抢锁，然后进入死循环，一旦三个线程都解锁了后，和没有加锁没啥区别了。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">work</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 加锁</span>    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>                <span class="token comment">// 临界区 start</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%ld 正在卖第 %d 张门票\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">--</span> tickets<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span>        <span class="token punctuation">{</span>             <span class="token comment">// 解锁</span>            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 临界区 end</span>        <span class="token comment">// 解锁</span>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>       <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="10-死锁"><a href="#10-死锁" class="headerlink" title="10. 死锁"></a>10. 死锁</h2><p>多个临界代码，多个🔒。</p><p>如果两段临界代码挨得比较近，加一把锁锁起来是现实的。</p><p>但是如果两段距离比较远，从头到尾锁起来就降低了程序执行的效率。</p><p><img src="https://img-blog.csdnimg.cn/c5bb1f1159e74b6e8fdbf9595aee96b7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="忘记解锁"><a href="#忘记解锁" class="headerlink" title="忘记解锁"></a>忘记解锁</h5><p>假如线程A上了锁，跑完忘记解锁了，其他线程就再也无法获取锁了。就算线程A再一次访问，检测到该临界代码已经被锁上了，即使是线程A之前锁的，A也无法访问了。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">work</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 加锁</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 临界区 start</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%ld 正在卖第 %d 张门票\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">--</span> tickets<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span>        <span class="token punctuation">{</span>             <span class="token comment">// 解锁</span>            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 临界区 end</span>        <span class="token comment">// 忘记解锁</span>        <span class="token comment">//pthread_mutex_unlock(&amp;mutex);</span>    <span class="token punctuation">}</span>       <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们可以发现程序阻塞住了。</p><p><img src="https://img-blog.csdnimg.cn/e6b129bb58b34b60a7cb22d1cd47e5ea.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="重复上锁"><a href="#重复上锁" class="headerlink" title="重复上锁"></a>重复上锁</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 第一次上锁</span>    <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 第二次上锁</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">work</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 加锁</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"上了第一把锁\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"上了第二把锁\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 临界区 start</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%ld 正在卖第 %d 张门票\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">--</span> tickets<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span>        <span class="token punctuation">{</span>             <span class="token comment">// 解锁</span>            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 临界区 end</span>        <span class="token comment">// 解锁</span>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>       <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>又阻塞了……</p><p><img src="https://img-blog.csdnimg.cn/57c6822718bd4786aa02ebbf13b84cfd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="多线程多锁，抢占锁资源"><a href="#多线程多锁，抢占锁资源" class="headerlink" title="多线程多锁，抢占锁资源"></a>多线程多锁，抢占锁资源</h5><p>A先锁了资源1，打算访问资源2；B线索了资源2，打算访问资源1.但是连个人都访问不到第二段临界代码，因为锁在对方身上。互相等待，僵持。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token keyword">int</span> tickets <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">// 创建一个锁</span><span class="token class-name">pthread_mutex_t</span> mutex1<span class="token punctuation">,</span> mutex2<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">workA</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"work A\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">workB</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"work B\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 初始化锁</span>    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 创建三个子线程同时买票</span>    <span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> workA<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> workB<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 回收</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 退出主线程</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 销毁锁</span>    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>又卡住了……</p><p><img src="https://img-blog.csdnimg.cn/7c02d56adb404cc2aaae4f31f81d94e5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="11-读写锁"><a href="#11-读写锁" class="headerlink" title="11. 读写锁"></a>11. 读写锁</h2><h5 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h5><p><img src="https://img-blog.csdnimg.cn/adcac950e0844982abef5e874f63dd0f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>读的时候线程不会阻塞，如果要写可能会阻塞（如果有人先来一步）。</p><h5 id="相关函数-2"><a href="#相关函数-2" class="headerlink" title="相关函数"></a>相关函数</h5><p><img src="https://img-blog.csdnimg.cn/4f227062335e44debd47547842a08ce5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>读写锁是一把锁，知识可以锁定读操作或者写操作。</p><h5 id="测试代码-3"><a href="#测试代码-3" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token comment">// 共享数据</span><span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 读写锁</span><span class="token class-name">pthread_rwlock_t</span> rwlock<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">writeNum</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 上写锁</span>        <span class="token function">pthread_rwlock_wrlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">++</span> num<span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"++ write num, %ld, num = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 解锁</span>        <span class="token function">pthread_rwlock_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">readNum</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>         <span class="token comment">// 上读锁</span>        <span class="token function">pthread_rwlock_rdlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"== read  num, %ld, num = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 解锁</span>        <span class="token function">pthread_rwlock_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">pthread_rwlock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建三个写线程，5个读线程</span>    <span class="token class-name">pthread_t</span> wtids<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rtids<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wtids<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> writeNum<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rtids<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> readNum<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置线程分离</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">pthread_detach</span><span class="token punctuation">(</span>wtids<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">pthread_detach</span><span class="token punctuation">(</span>rtids<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_rwlock_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/aeab96a346344bfab47a58a87c3230a7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="12-生产者消费者模型"><a href="#12-生产者消费者模型" class="headerlink" title="12. 生产者消费者模型"></a>12. 生产者消费者模型</h2><p><code>生产者</code>专门生产数据，可以生产多个，生产完了放到<code>容器</code>里面。</p><p><code>消费者</code>专门消费，即从<code>容器</code>中取用数据。</p><p>考虑只有一个生产者，一个消费者。（两个线程）</p><p>容器有容量大小，当容器里面放不下了，生产者就生产不了了，就算生产了也浪费了。于是<code>生产者阻塞</code>，通知消费者消费。</p><p>如果消费者把容器里的东西都消费完了，容器空了，消费者就消费不了了。于是<code>消费者阻塞</code>，通知生产者生产。</p><p>我们要保证容器（共享资源）的数据安全问题，及做到线程同步。</p><h5 id="测试代码（错误代码）"><a href="#测试代码（错误代码）" class="headerlink" title="测试代码（错误代码）"></a>测试代码（错误代码）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token comment">// 容器：链表</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> num<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// 头节点</span><span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">producer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 不断生产并放入容器 ---&gt; 创建新节点头插</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>newNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        newNode<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>        head <span class="token operator">=</span> newNode<span class="token punctuation">;</span>        newNode<span class="token operator">-&gt;</span>num <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"new node-&gt;nu, = %d; tid = %ld\n"</span><span class="token punctuation">,</span> newNode<span class="token operator">-&gt;</span>num<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">customer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 消费者每次都先消费头结点</span>        <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>        head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"delete node-&gt;num = %d; tid = %ld\n"</span><span class="token punctuation">,</span> tmp<span class="token operator">-&gt;</span>num<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 创建5个生产者线程，消费者线程</span>    <span class="token class-name">pthread_t</span> ptid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ctid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> producer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> customer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 线程分离</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>ptid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>ctid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，我们出现了经典的段错误。</p><p>究其原因，我们并没有对生产者和消费者的生产与消费动作加以任何限制。</p><p>因此多个线程的执行我们无法预料，很有可能生产者没有生产任何东西我们就去消费了。</p><p><img src="https://img-blog.csdnimg.cn/49fe1994f7dd4fca85711760466a11f5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>我们也可以具体查看这个错误</p><p>通过 <code>ulimit -a</code> 查看到 <code>core file size</code> 为0，因此没有为什么生成core文件。</p><p><img src="https://img-blog.csdnimg.cn/c353d289ddec40e996811776941536d5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_14,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>使用 <code>ulimit -c unlimited</code></p><p><img src="https://img-blog.csdnimg.cn/b87c3b9db3ba482e968520611fbe69c6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>重新编译（使用 -g ）</p><p>进入gdb调试</p><p>使用 <code>core-file core文件名字</code></p><p><img src="https://img-blog.csdnimg.cn/4f29955224794b77958b698d30437968.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>这里有个bug，我是编译了producust.c出错获得的core，但是core文件里显示是另一个文件，就很迷。</p><p>但是我们可以确定的是，事实上是访问head-&gt;next出了错。</p><p>那么我们应该怎么改程序呢？</p><p>如果head==NULL，说明没有数据，我们要让生产者去生产。</p><p>于是我们尝试去加锁。</p><p>由于两段临界区访问的都是同一个共享资源：链表，因此加一把锁就可以了。</p><h5 id="测试代码（错误代码）-1"><a href="#测试代码（错误代码）-1" class="headerlink" title="测试代码（错误代码）"></a>测试代码（错误代码）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token comment">// 创建互斥锁</span><span class="token class-name">pthread_mutex_t</span> mutex<span class="token punctuation">;</span><span class="token comment">// 容器：链表</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> num<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// 头节点</span><span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">producer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 不断生产并放入容器 ---&gt; 创建新节点头插</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 对临界区加锁</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>newNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        newNode<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>        head <span class="token operator">=</span> newNode<span class="token punctuation">;</span>        newNode<span class="token operator">-&gt;</span>num <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"new node-&gt;num = %d; tid = %ld\n"</span><span class="token punctuation">,</span> newNode<span class="token operator">-&gt;</span>num<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">customer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 对共享资源加锁</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 消费者每次都先消费头结点</span>        <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>        <span class="token comment">// 有数据了才能操作但是这里有死锁问题</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>head <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"delete node-&gt;num = %d; tid = %ld\n"</span><span class="token punctuation">,</span> tmp<span class="token operator">-&gt;</span>num<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建5个生产者线程，消费者线程</span>    <span class="token class-name">pthread_t</span> ptid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ctid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> producer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> customer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 线程分离</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>ptid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>ctid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 由于detach不阻塞，主线程会直接detach结束后销毁锁，退出；如果用join会阻塞等待</span>    <span class="token punctuation">}</span>    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里看样子没有问题了，但是运行一会儿阻塞住了。</p><p>蚌埠住了。</p><p>我们发生了死锁。</p><p>当消费者线程抢到CPU执行权去删除数据时，发现没有数据，因此不断循环去等。</p><p>然而第一次进来的时候拿了锁，第二次进来却进不来了，因为锁在他自己身上，更别说别的线程了。</p><p><img src="https://img-blog.csdnimg.cn/cf120b295eb44456ab197af4009d3e41.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_16,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>那应该怎么做呢？</p><h5 id="测试代码（正确但是浪费资源）"><a href="#测试代码（正确但是浪费资源）" class="headerlink" title="测试代码（正确但是浪费资源）"></a>测试代码（正确但是浪费资源）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token comment">// 创建互斥锁</span><span class="token class-name">pthread_mutex_t</span> mutex<span class="token punctuation">;</span><span class="token comment">// 容器：链表</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> num<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// 头节点</span><span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">producer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 不断生产并放入容器 ---&gt; 创建新节点头插</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 对临界区加锁</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>newNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        newNode<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>        head <span class="token operator">=</span> newNode<span class="token punctuation">;</span>        newNode<span class="token operator">-&gt;</span>num <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"new node-&gt;num = %d; tid = %ld\n"</span><span class="token punctuation">,</span> newNode<span class="token operator">-&gt;</span>num<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">customer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 对共享资源加锁</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 消费者每次都先消费头结点</span>        <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>        <span class="token comment">// 有数据了才能操作</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>head <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"delete node-&gt;num = %d; tid = %ld\n"</span><span class="token punctuation">,</span> tmp<span class="token operator">-&gt;</span>num<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span>        <span class="token punctuation">{</span>            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建5个生产者线程，消费者线程</span>    <span class="token class-name">pthread_t</span> ptid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ctid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> producer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> customer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 线程分离</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>ptid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>ctid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 由于detach不阻塞，主线程会直接detach结束后销毁锁，退出；如果用join会阻塞等待</span>    <span class="token punctuation">}</span>    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一旦碰到没有数据的情况，我们就先解锁再进入循环。</p><p><img src="https://img-blog.csdnimg.cn/3a6c730ef5354a6aab15624006907124.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_15,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>看样子是成功了，但是这样有个效率问题。</p><p>消费者发现没有数据时，会一直死循环等待直到有数据它进行消费。造成了CPU时间的浪费。</p><p>我们需要再消费者没有数据的时候通知生产者去生产，我在这里阻塞等着，你生产好了我再去消费。</p><p>于是乎，我们要使用条件变量。</p><h2 id="13-条件变量（解决生产者消费者问题）"><a href="#13-条件变量（解决生产者消费者问题）" class="headerlink" title="13. 条件变量（解决生产者消费者问题）"></a>13. 条件变量（解决生产者消费者问题）</h2><h5 id="相关函数-3"><a href="#相关函数-3" class="headerlink" title="相关函数"></a>相关函数</h5><p><img src="https://img-blog.csdnimg.cn/72f270a6385e45c78822ec5e02a9a3f1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>某个条件满足了，你去操作。</p><p>不满足，就停止操作。</p><p>条件变量不是锁，不能解决数据混乱的问题，但是可以引起<code>线程阻塞</code>。</p><p><code>wait</code>：线程会阻塞</p><p>阻塞的时候会先解锁，被唤醒后会重新加锁。不然的话它拿着锁阻塞别人都用不了了。</p><p><code>timedwait</code>：等待一段时间，线程会阻塞，直到指定时间用完</p><p><code>signal</code>：唤醒一个或多个等待的线程</p><p>If several threads are waiting on cond, exactly one is restarted, but  it  is not specified which.</p><p><code>broadcast</code>：唤醒所有的等待的线程</p><h5 id="示例代码-4"><a href="#示例代码-4" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token comment">// 创建互斥锁</span><span class="token class-name">pthread_mutex_t</span> mutex<span class="token punctuation">;</span><span class="token comment">// 创建条件变量</span><span class="token class-name">pthread_cond_t</span> cond<span class="token punctuation">;</span><span class="token comment">// 容器：链表</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> num<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// 头节点</span><span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">producer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 不断生产并放入容器 ---&gt; 创建新节点头插</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 对临界区加锁</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 开始生产</span>        <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>newNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        newNode<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>        head <span class="token operator">=</span> newNode<span class="token punctuation">;</span>        newNode<span class="token operator">-&gt;</span>num <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"new node-&gt;num = %d; tid = %ld\n"</span><span class="token punctuation">,</span> newNode<span class="token operator">-&gt;</span>num<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 只要生产了一个就可以通知消费者消费</span>        <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">customer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 对共享资源加锁</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 消费者每次都先消费头结点</span>        <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>        <span class="token comment">// 有数据了才能操作</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>head <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 开始消费</span>            head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"del node-&gt;num = %d; tid = %ld\n"</span><span class="token punctuation">,</span> tmp<span class="token operator">-&gt;</span>num<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span>        <span class="token punctuation">{</span>            <span class="token comment">// 没有数据，原地阻塞等待, 直到生产者执行signal，该线程就被唤醒了</span>            <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 会先解锁，让别人去用，醒过来后重新加锁</span>            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建5个生产者线程，消费者线程</span>    <span class="token class-name">pthread_t</span> ptid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ctid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> producer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> customer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 线程分离</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>ptid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>ctid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 由于detach不阻塞，主线程会直接detach结束后销毁锁，退出；如果用join会阻塞等待</span>    <span class="token punctuation">}</span>    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="14-信号量"><a href="#14-信号量" class="headerlink" title="14. 信号量"></a>14. 信号量</h2><p>阻塞线程，但是不能保证线程安全。</p><p><img src="https://img-blog.csdnimg.cn/f7187f5b66754ccabd816c11bc19adc9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="/2022/04/23/Linux%E5%A4%9A%E7%BA%BF%E7%A8%8B/Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220425215852396.png" alt="image-20220425215852396"></p><p>消费者消费一个，灭一个灯。</p><p>生产者生产一个，亮一个灯。</p><p>全灭了，表示容器满了，谁想访问会阻塞。</p><h5 id="init"><a href="#init" class="headerlink" title="init"></a>init</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">,</span> <span class="token keyword">int</span> pshared<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>Link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>DESCRIPTION       <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> initializes the unnamed semaphore at the address pointed to by 【sem】<span class="token punctuation">.</span>         The 【value】 argument specifies the initial value <span class="token keyword">for</span> the semaphore<span class="token punctuation">.</span>       The 【pshared】 argument indicates 【whether this semaphore is to be shared】 between the threads of a process<span class="token punctuation">,</span> or between processes<span class="token punctuation">.</span>       If pshared has the value 【<span class="token number">0</span>】<span class="token punctuation">,</span> then the semaphore is shared 【between the threads】 of a process<span class="token punctuation">,</span> and should be located at some address that is visible to all <span class="token function">threads</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span><span class="token punctuation">,</span> a global variable<span class="token punctuation">,</span> or a variable allocated dynamically on the heap<span class="token punctuation">)</span><span class="token punctuation">.</span>       If  pshared  is 【nonzero】<span class="token punctuation">,</span> then the semaphore is shared 【between processes】<span class="token punctuation">,</span> and should be located in a region of shared <span class="token function">memory</span> <span class="token punctuation">(</span>see <span class="token function">shm_open</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> and <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  <span class="token punctuation">(</span>Since a child created by <span class="token function">fork</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> inherits its parent’s memory mappings<span class="token punctuation">,</span> it canalso access the semaphore<span class="token punctuation">.</span><span class="token punctuation">)</span>  Any process that can access the shared memory region can operate on the semaphore using <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> and so on<span class="token punctuation">.</span>       Initializing a semaphore that has already been initialized results in undefined behavior<span class="token punctuation">.</span>RETURN VALUE       <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns <span class="token number">0</span> on success<span class="token punctuation">;</span> on error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set to indicate the error<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>wait</code>：-1，对信号量加锁，占用一个坑位</p><p><code>post</code>：+1  对信号量解锁，释放一个坑位</p><h5 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// -1操作，遇0阻塞</span><span class="token keyword">int</span> <span class="token function">sem_trywait</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">sem_timedwait</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token operator">*</span>abs_timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>Link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>         <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 【<span class="token function">decrements</span> <span class="token punctuation">(</span>locks<span class="token punctuation">)</span> the semaphor】e pointed to by 【sem】<span class="token punctuation">.</span>       If the semaphore<span class="token char">''</span>s value is greater than zero<span class="token punctuation">,</span> then the decrement proceeds<span class="token punctuation">,</span> and the function returns<span class="token punctuation">,</span> immediately<span class="token punctuation">.</span>       If the semaphore currently has the value zero<span class="token punctuation">,</span> then the call blocks until either it becomes possible to perform the <span class="token function">decrement</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> the semaphore value rises above zero<span class="token punctuation">)</span><span class="token punctuation">,</span> or a signal handler interrupts the call<span class="token punctuation">.</span>       <span class="token function">sem_trywait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is the same as <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> except that <span class="token keyword">if</span> the decrement cannot be immediately performed<span class="token punctuation">,</span> then call 【returns an erro】<span class="token function">r</span> <span class="token punctuation">(</span>errno set to EAGAIN<span class="token punctuation">)</span> instead of blocking<span class="token punctuation">.</span>       <span class="token function">sem_timedwait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is the same as <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> except that 【abs_timeout】 specifies a limit on the amount of time that the call should block <span class="token keyword">if</span> the decrement cannot be immediately performed<span class="token punctuation">.</span>         The abs_timeout argument points to a structure that  specifies an absolute timeout in 【seconds and nanoseconds】 since the Epoch<span class="token punctuation">,</span> <span class="token number">1970</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token operator">+</span><span class="token number">0000</span> <span class="token punctuation">(</span>UTC<span class="token punctuation">)</span><span class="token punctuation">.</span>  This structure is defined as follows<span class="token operator">:</span><span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token punctuation">{</span>    <span class="token class-name">time_t</span> tv_sec<span class="token punctuation">;</span>      <span class="token comment">/* Seconds */</span>    <span class="token keyword">long</span>   tv_nsec<span class="token punctuation">;</span>     <span class="token comment">/* Nanoseconds [0 .. 999999999] */</span><span class="token punctuation">}</span><span class="token punctuation">;</span>       If the timeout has already expired by the time of the call<span class="token punctuation">,</span> and the semaphore could not be locked immediately<span class="token punctuation">,</span> then <span class="token function">sem_timedwait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> fails with a timeout <span class="token function">error</span> <span class="token punctuation">(</span>errno set to ETIMEDOUT<span class="token punctuation">)</span><span class="token punctuation">.</span>       If the operation can be performed immediately<span class="token punctuation">,</span> then <span class="token function">sem_timedwait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> never fails with a timeout error<span class="token punctuation">,</span> regardless of the value of abs_timeout<span class="token punctuation">.</span>  Furthermore<span class="token punctuation">,</span> the validity of abs_timeout is not checked in this <span class="token keyword">case</span><span class="token punctuation">.</span>RETURN VALUE       All of these functions <span class="token keyword">return</span> <span class="token number">0</span> on success<span class="token punctuation">;</span>    on error<span class="token punctuation">,</span> the value of the semaphore is left unchanged<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set to indicate the error<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="post"><a href="#post" class="headerlink" title="post"></a>post</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// +1操作，唤醒被wait阻塞的线程</span>Link with <span class="token operator">-</span>pthread<span class="token punctuation">.</span>DESCRIPTION       <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 【<span class="token function">increments</span> <span class="token punctuation">(</span>unlocks<span class="token punctuation">)</span> the semaphore】 pointed to by 【sem】<span class="token punctuation">.</span>         If the semaphore<span class="token char">''</span>s value consequently becomes 【greater than zero】<span class="token punctuation">,</span> then another process or thread 【blocked in a <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> call】 will be 【woken up】 and proceed to lock the semaphore<span class="token punctuation">.</span>RETURN VALUE       <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns <span class="token number">0</span> on success<span class="token punctuation">;</span>    on error<span class="token punctuation">,</span> the value of the semaphore is left unchanged<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set to indicate the error<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="示例代码-5"><a href="#示例代码-5" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span><span class="token comment">// 创建互斥锁</span><span class="token class-name">pthread_mutex_t</span> mutex<span class="token punctuation">;</span><span class="token comment">// 创建2个信号量</span><span class="token class-name">sem_t</span> psem<span class="token punctuation">,</span> csem<span class="token punctuation">;</span><span class="token comment">// 容器：链表</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> num<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// 头节点</span><span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">producer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 不断生产并放入容器 ---&gt; 创建新节点头插</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 生产者生产一个 -1</span>        <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>psem<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 对临界区加锁</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 开始生产</span>        <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>newNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        newNode<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>        head <span class="token operator">=</span> newNode<span class="token punctuation">;</span>        newNode<span class="token operator">-&gt;</span>num <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"new node-&gt;num = %d; tid = %ld\n"</span><span class="token punctuation">,</span> newNode<span class="token operator">-&gt;</span>num<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 解锁</span>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 通知消费者 +1</span>        <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>csem<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">customer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 看看能不能消费，这里就不需要判断head==NULL了，因为如果csem ！= 0，说明生产者已经生产好了一，直接消费就成了</span>        <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>csem<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 对共享资源加锁</span>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 开始消费</span>        <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>        head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"del node-&gt;num = %d; tid = %ld\n"</span><span class="token punctuation">,</span> tmp<span class="token operator">-&gt;</span>num<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 解锁</span>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 通知生产者，我消费了一个</span>        <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>psem<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>psem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 0-&gt;between thread</span>    <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>csem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建5个生产者线程，消费者线程</span>    <span class="token class-name">pthread_t</span> ptid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ctid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> producer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> customer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 线程分离</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>ptid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>ctid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 由于detach不阻塞，主线程会直接detach结束后销毁锁，退出；如果用join会阻塞等待</span>    <span class="token punctuation">}</span>    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们看到一切正常。</p><p>生产者生产时是采用头插法，因此消费者消费时也是从头结点开始删除。</p><p><img src="https://img-blog.csdnimg.cn/8ae09d89c4db4190a4e7cb168736e54c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_14,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>第一次编译时有个bug，因此segmentation fault了，后来发现是定义消费者的信号量时，将value设置成了8。</p><p>这样的话消费者一开始就可以消费，有人有可能消费到空的容器，访问NULL的后继结点，因此段错误了。</p><h3 id="I-N-D-E-X"><a href="#I-N-D-E-X" class="headerlink" title="I N D E X"></a>I N D E X</h3><p><img src="https://img-blog.csdnimg.cn/e742a794620e437c9942c716d5e3ba78.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><blockquote><p>使用 <code>sudo apt-get install glibc-doc</code> 下载线程库函数的man手册</p><p>使用 <code>man -k pthread</code> 查看</p><p>这样我们可以看到一共下载了97条数据</p><p><img src="https://img-blog.csdnimg.cn/e6f09274b50c44fb8aa523354c0bdb55.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_18,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>使用 <code>sudo apt-get install manpages-posix manpages-posix-dev</code> 下载完整的</p><p><img src="https://img-blog.csdnimg.cn/cc1bdfd75b6046678a5a76f5866fabd9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_18,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 系统编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++</title>
      <link href="/2022/04/20/C++/"/>
      <url>/2022/04/20/C++/</url>
      
        <content type="html"><![CDATA[<h1 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h1><p>最近开始读《C++ Primer》了，记录一些以前C++98中没有遇到过的但是比较优秀的用法以及陌生的知识点。</p><p>由于这本书真的太厚了，里面些许知识点是自己已经掌握的，有些新特性与陌生用法是值得自己学习的。然而也不可能每次遇到问题书都在身边，于是将自己觉得有价值的部分记录下来。</p><p>因此本文并不是全篇关注C++11，而是新标准与陌生知识相融合的一篇学习记录。</p><h3 id="顶层const-amp-底层const"><a href="#顶层const-amp-底层const" class="headerlink" title="顶层const &amp; 底层const"></a>顶层const &amp; 底层const</h3><p>在这本书里看到了一个新概念：底层const与底层const</p><p><code>顶层const</code> ： 任意对象是常量，指针本身是个常量。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token operator">*</span><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span> <span class="token comment">// 指针本身是常量，不可以再指向别人，长相厮守</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">1e5</span><span class="token punctuation">;</span> <span class="token comment">// 变量N是个const，只读</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>底层const</code>：指针所指的对象是个const</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>p2 <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span><span class="token comment">// 不能通过指针修改其指向的对象</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>ref <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span><span class="token comment">// 声明引用的const的都是底层const</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>我们还可以见到这种杂合子</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token keyword">const</span> p3 <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span><span class="token comment">// 第一个是底层const，我们无法通过指针修改这个对象</span><span class="token comment">// 第二个是顶层const，长相厮守</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>执行拷贝操作的时候，底层const会做一些坏事。</p><p>拷入和拷出的时候两个数据对象必须具有相同的底层const资格。</p><ul><li>case 1</li></ul><p>这是错误的。</p><p>因为p1拥有底层const，我们无法通过指针修改a的值。</p><p>而p2却没有底层const，意味着我们可以通过p2修改p2指向的值，即p1指向的值，即a的值。</p><p>这与我们的初衷相违背（p1不被允许修改a的值）。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">*</span>p2 <span class="token operator">=</span> p1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a32de98309f14546810b3d1718b841e0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>同理，这样也是不允许的。因为p有可能改变a的值。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/7bf0cf88ca3343bead078d81ad333516.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 2</p><p>这样子是合法的，因为p1和p2都拥有相同的底层const，即p1和p2指向的对象都不能被修改。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>p2 <span class="token operator">=</span> p1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>case 3</p><p>这样也是合法的，编译器可以将 <code>int*</code> 转成 <code>const int*</code></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>i<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>case 4</p><p>这样子是非法的，因为ref有修改i的可能性。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>ref <span class="token operator">=</span> i<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/cb58dd30605549eca3326f0bf5fc2df6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 5</p><p>这样自然就合法了，因为ref也是只读的。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span>ref <span class="token operator">=</span> i<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>上面这等价于：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ref <span class="token operator">=</span> i<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>总而言之，在拷贝的时候，只要关注新定义的变量有没有可能修改<code>拥有底层const的变量</code>就可以了。</p><h3 id="constexpr"><a href="#constexpr" class="headerlink" title="constexpr"></a>constexpr</h3><p>这是个c++11新增的类型，中文名叫 <code>常量表达式</code>。</p><p>constexpr 变量的特点：</p><ul><li>值不会改变（这点和const一样）</li><li>编译过程就能得到计算结果</li></ul><p>什么是常量表达式？</p><p><img src="https://img-blog.csdnimg.cn/403266030fdc44f1899e1740138f0d08.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>等功力深厚了再来写。</p><h3 id="using（取别名）"><a href="#using（取别名）" class="headerlink" title="using（取别名）"></a>using（取别名）</h3><p>这里介绍的using是普通场合的using，起作用等价于<code>typedef</code>。</p><h3 id="auto"><a href="#auto" class="headerlink" title="auto"></a>auto</h3><p>让编译器自己推断变量的类型。</p><p>case 1</p><p>碰到引用，会顺藤摸瓜推断出<strong>最原始的值的类型</strong>。</p><p>相当于 <code>int b = a</code>。</p><p><img src="https://img-blog.csdnimg.cn/ee2f2ac15d1e46e7a34bfacc5954176c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_10,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 2 </p><p><strong>忽略顶层const</strong>（任意对象是常量，指针本身是常量）</p><p>如这里的变量a是个常量，但是会被auto忽略掉。</p><p>auto出来的b是个普通变量，可以任意读写。</p><p>相当于 <code>int b = 1</code>。</p><p><img src="https://img-blog.csdnimg.cn/2621e443582443e485aa1918878e2b6d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_14,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 3</p><p><strong>同时碰到引用和顶层const</strong>，依然遵循上面的规则。</p><p>ri是个引用，引用了int类型的i，然而i是个const，但是顶层const会被忽略，因此b是个可读可写的int。</p><p>相当于 <code>int b = i</code>。</p><p><img src="https://img-blog.csdnimg.cn/1c84b425fd884e91b469a7880cf69fb6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 4</p><p><strong>保留底层const</strong> （指针指向的内容是const）</p><p>变量a是个常量， &amp;a取地址，因此ptr是个指针类型的变量。</p><p>由于auto保留底层const，因此ptr无法修改其指向的值。</p><p>相当于 <code>const int *ptr = &amp;a</code>。</p><p><img src="https://img-blog.csdnimg.cn/4beb3b69da5c4948a586931767b06301.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 5</p><p>如果想要auto推断出来的值是个const，可以显式地告诉编译器。</p><p><img src="https://img-blog.csdnimg.cn/c568370dbaaa408587de99b3f1d5f98c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 6</p><p>声明一个auto的引用时，顶层const会被保留。是否为引用对于auto有重要影响。</p><p>由于我们想声明一个变量d作为c的引用，意味着我们可能使用d来修改c的值，然而c是个常量，具有顶层const属性，因此d也必须是一个常量。</p><p>因此，我们无法修改d的值，会报错。</p><p><img src="https://img-blog.csdnimg.cn/a77057214a16400a8d8ec3653214b4c0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_18,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 7</p><p>一句auto中的变量需要是同一类型。</p><ul><li>1 </li></ul><p><img src="https://img-blog.csdnimg.cn/73d983fa116545eca7bdd600bcc4d4fe.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ul><li>2</li></ul><p><img src="https://img-blog.csdnimg.cn/8e98128b413942e6a7b800b65a91d43f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_12,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ul><li>3</li><li><img src="https://img-blog.csdnimg.cn/c3b7fbbe114c44e19be2f076b56a98e2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></li></ul><p><img src="https://img-blog.csdnimg.cn/375f98ace8564f2a97239262f1c7b2dc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>总结</p><ul><li>auto 最关注的是变量的类型，我们只希望获得类型，因此会忽略顶层const， 引用等等。他不希望我们沾染const，引用这种外壳。</li><li>但是有些原则是不能触碰的，如果我们auto出来的变量可以修改只读的变量，这是大忌。因此auto不会忽略底层const。</li><li>如果我们真的希望auto出来的变量确实是个const或者引用，那么我们就明确地告诉编译器。和普通变量命名规则一样，大家要么都是const要么都可读可写，一根绳上的蚂蚱。</li></ul><p>上面三条记牢，在用auto的时候就会少犯一些错你。</p><h3 id="decltype"><a href="#decltype" class="headerlink" title="decltype"></a>decltype</h3><p>这个也是c++11除了auto之外引入的第二个新的类型说明符。</p><p>他会根据括号内的操作数推断类型并返回。</p><p>在此过程中，编译器推断表达式的类型但是不会计算它的值。</p><p><img src="https://img-blog.csdnimg.cn/c5840dba69aa404f89b264286f2dedb2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_15,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>然,decltype处理<code>顶层const</code>和<code>引用</code>和auto有些许不同。</p><p>case 1</p><p>如果要推断一个变量，这个变量是啥就是啥，因为我们希望得到的结果和里面的变量一模一样。</p><p>顶层const和引用它都会考虑进去。看起来比auto更加聪明也更危险。</p><p>这个例子中，i拥有顶层const属性，因此decltype返回的也是个 const int，因而 a 不可以被修改。</p><p><img src="https://img-blog.csdnimg.cn/96942ae413b34e59850d3d3ef0df50da.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>这里的 j 是个引用类型，与 i 绑定，因此修改 j 就是在修改 i。</p><p>我们使用 decltype(j)，它会返回和 j 一样的数据类型，即int &amp;。 </p><p>因此这条语句相当于 <code>int &amp;rj = j</code>。</p><p>从而我们又将 rj 与 j 绑定。</p><p>从这里开始， i, j, rj 都是同一根绳子上的蚂蚱，牵一发而动全身。 </p><p><img src="https://img-blog.csdnimg.cn/59874bcbcb084e33a548598106214fbc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>编译器怕我们太笨了也会告诉我们，这个 rj 是个引用变量，因此需要马上初始化。</p><p>如果不绑定一个变量他就会报错。</p><p><img src="https://img-blog.csdnimg.cn/3f5d1dcbb35f41cd86b8db96cac54f82.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_14,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 2</p><p>如果decltypr使用的表达式不是一个变量，那么它会返回<code>表达式结果相对应的类型</code>。</p><p>然而引用的代价太大了，有时候我们单纯只是像获得类型，就行auto那样。</p><p>下面这个表达式 j + 0 会返回一个 int 类型的值，因此decltyp返回的就是一个普通的 int。</p><p><img src="https://img-blog.csdnimg.cn/32502b5e0141448d8303035ade7492f7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_18,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 3</p><p>奇怪的是，对地址的解引用操作也会返回引用类型。</p><p>如下面的 decltype(*ptr) 就会返回 int &amp;，因此我们修改 ref 就是在修改 a。</p><p><img src="https://img-blog.csdnimg.cn/3f8415e89e334a4d9c4e007ed398c510.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>case 3</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">decltype</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> 和 <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> 是不一样的<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>不加括号就和上面的规则一样。</p><p>相当于 <code>int b = a;</code>。</p><p><img src="https://img-blog.csdnimg.cn/b3c73c8bff834a538ca89a7954a17c2c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>如果加上了一层括号，编译器会返回引用类型。</p><p>相当于 <code>int &amp;b = a;</code></p><p><img src="https://img-blog.csdnimg.cn/0d4f0dd931c246908c3b00af227791e2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><blockquote><p>哎，写到这里已经感受到C++的恶心了。</p></blockquote><h3 id="内置数组初始化vector"><a href="#内置数组初始化vector" class="headerlink" title="内置数组初始化vector"></a>内置数组初始化vector</h3><p>曾经的C标准和C++标准不允许使用内置数组的元素直接初始化别的数组，也不允许使用vector初始化内置数组。</p><p>新标准允许使用<code>内置数组</code>初始化<code>vector</code>了。</p><h3 id="内置数组使用迭代器"><a href="#内置数组使用迭代器" class="headerlink" title="内置数组使用迭代器"></a>内置数组使用迭代器</h3><p>后面会细说。</p><p>这里要介绍的是新标准中，允许内置数组使用迭代器了。</p><p>其中,<code>begin</code> 返回第一个元素的指针，<code>end</code>返回最后一个尾后指针。</p><p><img src="https://img-blog.csdnimg.cn/eba93297b58d4750a5039a4f13b4168c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/07e4e88c6b784d67b6ba0832d4250c32.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>更一般地，使用<code>vector&lt;T&gt; v(&amp;arr[i], &amp;arr[j])</code>便可以用下标区间在[i, j)之间的元素初始化vector了。</p><h3 id="多维数组遍历"><a href="#多维数组遍历" class="headerlink" title="多维数组遍历"></a>多维数组遍历</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iterator&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ia<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">:</span> ia<span class="token punctuation">)</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>j <span class="token operator">:</span> i<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            j <span class="token operator">=</span> <span class="token operator">++</span> cnt<span class="token punctuation">;</span>            cout <span class="token operator">&lt;&lt;</span> j <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ia<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ia<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ia<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ia<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span> j<span class="token punctuation">)</span>            cout <span class="token operator">&lt;&lt;</span> ia<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> ia<span class="token punctuation">;</span> i <span class="token operator">!=</span> ia <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>j <span class="token operator">=</span> <span class="token operator">*</span>i<span class="token punctuation">;</span> j <span class="token operator">!=</span> <span class="token operator">*</span>i <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token operator">++</span> j<span class="token punctuation">)</span>            cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>j <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="坑：类型转换"><a href="#坑：类型转换" class="headerlink" title="坑：类型转换"></a>坑：类型转换</h3><p>其实也说不上坑，只是我们在写程序时要注意，但又经常被忽略，一旦写不好会造成Bug的一个东西。</p><p><strong>隐式转换</strong></p><p>隐式的东西很危险，不要让编译器给你做。 —— 杜博士dubious</p><p>当可以相互转换的不同数据类型做运，而你又没有干预的时候，隐式类型转换就发生了。</p><p>具体可以去看看 csapp 第二章，讲的非常详细。</p><p>高精度 -&gt; 低精度：精度损失</p><p>低精度-&gt;高精度：精度提升</p><p>（无符号数 op 有符号数 ）&amp;&amp; precision(无符号数 &gt;= 有符号数) —&gt; cast <strong>有符号数</strong> to <strong>无符号数</strong> </p><p>这里可能会存在副作用，如 int(-1) —&gt; unsigned int(INT_MAX)</p><p>（无符号数 op 有符号数 ）&amp;&amp; precision(无符号数 &lt; 有符号数) —&gt; 依赖于机器</p><p>如果无符号数可以表示的数据∈有符号数可以表示的范围 —&gt; cast <strong>无符号数</strong> to <strong>有符号数</strong></p><p>如果不能 cast <strong>有符号数</strong> to <strong>无符号数</strong></p><p>凡是两个运算对象数据类型不同时，我们都要留心类型转换。</p><p>可以做一些实验大量验证，动手比空想要好一点。</p><p><strong>显式转换</strong></p><p>程序员可以做的事情：强制类型转换。</p><p>相比C语言，C++引入了新的转换形式。</p><p><code>static_cast&lt;T&gt;(expression)</code> ：只要不包含<code>底层const</code>就可以转换。</p><p>告诉编译器：我不在乎精度丢失，别给我warning。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span><span class="token comment">// void *是万能指针</span><span class="token keyword">double</span> <span class="token operator">*</span>dp <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">*</span><span class="token operator">&gt;</span>pre<span class="token punctuation">;</span><span class="token comment">// cast void* to double*</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>dynamic_cast&lt;T&gt;(expression)</code> </p><p><code>const_cast&lt;T&gt;(expression)</code> </p><p><code>reinterprete_cast&lt;T&gt;(expression)</code> </p><h3 id="pass-by-reference-还是-by-value？"><a href="#pass-by-reference-还是-by-value？" class="headerlink" title="pass by reference 还是 by value？"></a>pass by reference 还是 by value？</h3><p>对于占用内存非常大的对象我们常常传它的引用作为函数参数。</p><p>函数只能 return 一个参数，我们可以通过传引用把其他的返回值通过引用的作为函数参数传入。其实这个在C中也经常用到，比如 <code>pthread_create</code>中传入的第一个参数就是个传出参数，像个钩子可以带出来子线程的tid。</p><p>侯捷老师：传引用很快，形式也很漂亮。C语言中擅长传递指针，也很轻量级。所有传参都传引用。如果不想要改 value ，就 pass by reference to const。</p><h3 id="return-by-reference-还是-by-value？"><a href="#return-by-reference-还是-by-value？" class="headerlink" title="return by reference 还是 by value？"></a>return by reference 还是 by value？</h3><p>返回尽量by reference。有些情况下不可以。</p><p>千万不要返回局部变量的reference。</p><h3 id="函数参数要不要-const？"><a href="#函数参数要不要-const？" class="headerlink" title="函数参数要不要 const？"></a>函数参数要不要 const？</h3><p>避免修改</p><p>避免 string &amp;s，传入字符串常量报错，修改成 —&gt; const string &amp;s</p><h3 id="this指针"><a href="#this指针" class="headerlink" title="this指针"></a>this指针</h3><p>每个对象内部都有一个隐式参数—<code>this指针</code>。</p><p>这个指针的地址指向<code>自己</code>，也就是说，他保存的是自己的首地址。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>using namespace std<span class="token punctuation">;</span>class Elephant<span class="token punctuation">{</span>public<span class="token operator">:</span>    <span class="token keyword">int</span> longNose <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> fatLeg <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> greatTail <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">double</span> twoEyes <span class="token operator">=</span> <span class="token number">4.4</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> this<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    Elephant a<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"&amp;a: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>a <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"this: "</span> <span class="token operator">&lt;&lt;</span> a<span class="token punctuation">.</span><span class="token function">get_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>a<span class="token punctuation">.</span>longNose <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>a<span class="token punctuation">.</span>fatLeg <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>a<span class="token punctuation">.</span>greatTail <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token operator">&amp;</span>a<span class="token punctuation">.</span>twoEyes <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>&amp;a: 0x61fef8<br>this: 0x61fef8<br>0x61fef8<br>0x61fefc<br>0x61ff00<br>0x61ff08</p></blockquote><p>可以看到 <code>this</code>的值 = 对象a的首地址。</p><h3 id="成员函数形参参数列表后面的const"><a href="#成员函数形参参数列表后面的const" class="headerlink" title="成员函数形参参数列表后面的const"></a>成员函数形参参数列表后面的const</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">std<span class="token operator">::</span>string <span class="token function">isbn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> bookNo<span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>紧跟在参数列表后的 const 是用来指定 this 指向一个常量，即我们不可以在函数中修改变量的值。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>using namespace std<span class="token punctuation">;</span>class Elephant<span class="token punctuation">{</span>public<span class="token operator">:</span>    <span class="token keyword">int</span> longNose <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> fatLeg <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> greatTail <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">double</span> twoEyes <span class="token operator">=</span> <span class="token number">4.4</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">get_address</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>    <span class="token punctuation">{</span>        longNose <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你尝试这么做，编译器会报错。</p><p>因为你在参数列表后指定了const，表面不可以该改变this指针指向的对象。</p><p>this指向一个常量。</p><p><img src="https://img-blog.csdnimg.cn/ab1f60204b9843c090b5798dfc562852.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>如果我定义了一个 const 的对象，并且调用某个成员函数，该成员函数内部修改了成员变量的值，就会报错。</p><p><img src="https://img-blog.csdnimg.cn/7f98e8119ea542c381a4a2e5347a1f7f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/9364a2b6811b42638405bcbc6ec8b1a6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="同一个-class-实例化的-objects-互为-friends"><a href="#同一个-class-实例化的-objects-互为-friends" class="headerlink" title="同一个 class 实例化的 objects 互为 friends"></a>同一个 class 实例化的 objects 互为 friends</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">class</span> <span class="token class-name">complex</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">complex</span><span class="token punctuation">(</span><span class="token keyword">double</span> _r<span class="token punctuation">,</span> <span class="token keyword">double</span> _i<span class="token punctuation">)</span>        <span class="token operator">:</span> <span class="token function">re</span><span class="token punctuation">(</span>_r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">im</span><span class="token punctuation">(</span>_i<span class="token punctuation">)</span>    <span class="token punctuation">{</span> <span class="token punctuation">}</span>    <span class="token keyword">double</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">const</span> complex<span class="token operator">&amp;</span> param<span class="token punctuation">)</span><span class="token comment">// 这是完全合法的</span>    <span class="token punctuation">{</span> <span class="token keyword">return</span> param<span class="token punctuation">.</span>re <span class="token operator">+</span> param<span class="token punctuation">.</span>im<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">double</span> re<span class="token punctuation">,</span> im<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    complex <span class="token function">c1</span><span class="token punctuation">(</span><span class="token number">19.2</span><span class="token punctuation">,</span> <span class="token number">10.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">c2</span><span class="token punctuation">(</span><span class="token number">90.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> c1<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>c2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="auto-decltype-与-尾置返回类型"><a href="#auto-decltype-与-尾置返回类型" class="headerlink" title="auto, decltype 与 尾置返回类型"></a>auto, decltype 与 尾置返回类型</h3><p> 在使用模板的时候，有时我们需要编译器自己推导返回类型。<br> 但是像下面的情况，编译就会报错，这是因为返回类型声明位 <code>decltype(l + r)</code>，意为需要返回和 <code>l + r</code> 相同类型的返回值。但是编译器是由左往右扫描的，在扫描到 <code>TL l, TR r</code> 之前并没有找到关于 l 和 r 的声明，因此直接报错了。<br> </p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">TL</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">TR</span><span class="token operator">&gt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span> <span class="token function">f</span><span class="token punctuation">(</span>TL l<span class="token punctuation">,</span> TR r<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> l <span class="token operator">+</span> r<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">auto</span> it <span class="token operator">=</span> <span class="token generic-function"><span class="token function">f</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> it <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p></p><blockquote><p>Main.cpp:5:10: error: ‘l’ was not declared in this scope<br>    5 | decltype(l + r) f(TL l, TR r) {<br>      |          ^<br>Main.cpp:5:10: error: ‘l’ was not declared in this scope<br>Main.cpp:5:14: error: ‘r’ was not declared in this scope<br>    5 | decltype(l + r) f(TL l, TR r) {<br>      |              ^</p></blockquote><p>解决办法之一便是使用位置返回类型，在函数头尾部显式指定返回的类型。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">TL</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">TR</span><span class="token operator">&gt;</span><span class="token keyword">auto</span> <span class="token function">f</span><span class="token punctuation">(</span>TL l<span class="token punctuation">,</span> TR r<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> l <span class="token operator">+</span> r<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>然后，直接用 auto 也是可以过的。</p><h3 id="转换函数与non-explict-one-argument-ctor"><a href="#转换函数与non-explict-one-argument-ctor" class="headerlink" title="转换函数与non-explict-one-argument ctor"></a>转换函数与non-explict-one-argument ctor</h3><h5 id="转换函数：转出去"><a href="#转换函数：转出去" class="headerlink" title="转换函数：转出去"></a>转换函数：转出去</h5><p>我是一个 Fraction 类。<br>当我与一个 double (要求返回 double，int -&gt; double) 类型做加法的时候，编译器会去寻找我有没有一个重载函数重载加号，使得 Fraction 和 double 得以相加。很可惜没有。<br>由于返回值是 double 类型，编译器再去寻找有没有可能将 Fraction 类型的变量转换成 double。很幸运它找到了。<br>因此 f1 -&gt; double， double = double + double，一切都顺理成章。<br>加法运算中 <code>4 + f1</code> 和 <code>f1 + 4</code> 都是可以的，因为最后都会将 Fraction 类型转换为 double。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Fraction</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">Fraction</span><span class="token punctuation">(</span><span class="token keyword">int</span> _num<span class="token punctuation">,</span> <span class="token keyword">int</span> _den <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">m_numerator</span><span class="token punctuation">(</span>_num<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_denominator</span><span class="token punctuation">(</span>_den<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">operator</span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>m_numerator <span class="token operator">/</span> m_denominator<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">int</span> m_numerator<span class="token punctuation">;</span>       <span class="token comment">// 分子</span>    <span class="token keyword">int</span> m_denominator<span class="token punctuation">;</span>     <span class="token comment">// 分母</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Fraction <span class="token function">f1</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">+</span> f1<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> result <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="non-explict-one-argument-ctor：转进来"><a href="#non-explict-one-argument-ctor：转进来" class="headerlink" title="non-explict-one argument ctor：转进来"></a>non-explict-one argument ctor：转进来</h5><p>编译器还是去寻找能不能将一个 Fraction 和一个非 Fraction 类型相加的重载函数。<br>很幸运它找到了。<br>我们重载了加号，使得两个 Fraction 可以相加。可是，我们给定的是一个数值型变量呀。<br>玄机在于构造函数，我们的构造函数是一个 non-explict-one-argement 的构造函数，支持传入一个 int 并转换为一个 Fraction 类型的对象。<br>这在数学上也成立，因为一个数值 x 代表 x / 1，也是一个分数，因此分母的默认值便是 1。<br>这里只能 <code>4 + f1</code>，因为重载的加号只提供一个用户的输入参数：Fraction 类型。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">gcd</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> b <span class="token operator">?</span> <span class="token function">gcd</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a <span class="token operator">%</span> b<span class="token punctuation">)</span> <span class="token operator">:</span> a<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Fraction</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">Fraction</span><span class="token punctuation">(</span><span class="token keyword">int</span> _num<span class="token punctuation">,</span> <span class="token keyword">int</span> _den <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">m_numerator</span><span class="token punctuation">(</span>_num<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_denominator</span><span class="token punctuation">(</span>_den<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    Fraction <span class="token keyword">operator</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Fraction <span class="token operator">&amp;</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> res_numerator<span class="token punctuation">,</span> res_denominator<span class="token punctuation">;</span>        <span class="token comment">// 通分</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>m_denominator <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            res_numerator <span class="token operator">=</span> m_numerator <span class="token operator">+</span> f<span class="token punctuation">.</span>m_numerator <span class="token operator">*</span> m_denominator<span class="token punctuation">;</span>            res_denominator <span class="token operator">=</span> m_denominator<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            res_numerator <span class="token operator">=</span> m_numerator <span class="token operator">*</span> f<span class="token punctuation">.</span>m_denominator <span class="token operator">+</span> m_denominator <span class="token operator">*</span> f<span class="token punctuation">.</span>m_numerator<span class="token punctuation">;</span>            res_denominator <span class="token operator">=</span> m_denominator <span class="token operator">*</span> f<span class="token punctuation">.</span>m_denominator<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 约分</span>        <span class="token keyword">int</span> g <span class="token operator">=</span> <span class="token function">gcd</span><span class="token punctuation">(</span>res_numerator<span class="token punctuation">,</span> res_denominator<span class="token punctuation">)</span><span class="token punctuation">;</span>        res_numerator <span class="token operator">/=</span> g<span class="token punctuation">,</span> res_denominator <span class="token operator">/=</span> g<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">Fraction</span><span class="token punctuation">(</span>res_numerator<span class="token punctuation">,</span> res_denominator<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">friend</span> ostream <span class="token operator">&amp;</span><span class="token keyword">operator</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>ostream <span class="token operator">&amp;</span>os<span class="token punctuation">,</span> Fraction <span class="token operator">&amp;</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>        os <span class="token operator">&lt;&lt;</span> f<span class="token punctuation">.</span>m_numerator <span class="token operator">&lt;&lt;</span> <span class="token string">"/"</span> <span class="token operator">&lt;&lt;</span> f<span class="token punctuation">.</span>m_denominator<span class="token punctuation">;</span>        <span class="token keyword">return</span> os<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">int</span> m_numerator<span class="token punctuation">;</span>       <span class="token comment">// 分子</span>    <span class="token keyword">int</span> m_denominator<span class="token punctuation">;</span>     <span class="token comment">// 分母</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Fraction <span class="token function">f1</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Fraction result <span class="token operator">=</span> f1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> result <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="explict-one-argument-ctor"><a href="#explict-one-argument-ctor" class="headerlink" title="explict-one-argument ctor"></a>explict-one-argument ctor</h5><p>如果我们把转换函数和重载加号放在一起会怎么样呢？<br>f1 + 4 会直接报错，4 + f1 却可以顺利编译。<br>这是为什么呢？<br>这是因为，前者我们给编译器提供了两个选项：<br>①使用重载加号将 Fraction 与 数值相加，返回 Fraction 直接赋值。<br>②使用转换函数将 Fraction 转换为 double，与数值相加，再转为 Fraction。<br>但是后者只有一条路：<br>直接使用转换函数将 Fraction 转换为 double，与 double 相加，再转成 Fraction。<br>任何提供二义性的操作编译器都不会给过。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">gcd</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> b <span class="token operator">?</span> <span class="token function">gcd</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a <span class="token operator">%</span> b<span class="token punctuation">)</span> <span class="token operator">:</span> a<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Fraction</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">Fraction</span><span class="token punctuation">(</span><span class="token keyword">int</span> _num<span class="token punctuation">,</span> <span class="token keyword">int</span> _den <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">m_numerator</span><span class="token punctuation">(</span>_num<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_denominator</span><span class="token punctuation">(</span>_den<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">operator</span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>m_numerator <span class="token operator">/</span> m_denominator<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    Fraction <span class="token keyword">operator</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Fraction <span class="token operator">&amp;</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> res_numerator<span class="token punctuation">,</span> res_denominator<span class="token punctuation">;</span>        <span class="token comment">// 通分</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>m_denominator <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            res_numerator <span class="token operator">=</span> m_numerator <span class="token operator">+</span> f<span class="token punctuation">.</span>m_numerator <span class="token operator">*</span> m_denominator<span class="token punctuation">;</span>            res_denominator <span class="token operator">=</span> m_denominator<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            res_numerator <span class="token operator">=</span> m_numerator <span class="token operator">*</span> f<span class="token punctuation">.</span>m_denominator <span class="token operator">+</span> m_denominator <span class="token operator">*</span> f<span class="token punctuation">.</span>m_numerator<span class="token punctuation">;</span>            res_denominator <span class="token operator">=</span> m_denominator <span class="token operator">*</span> f<span class="token punctuation">.</span>m_denominator<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 约分</span>        <span class="token keyword">int</span> g <span class="token operator">=</span> <span class="token function">gcd</span><span class="token punctuation">(</span>res_numerator<span class="token punctuation">,</span> res_denominator<span class="token punctuation">)</span><span class="token punctuation">;</span>        res_numerator <span class="token operator">/=</span> g<span class="token punctuation">,</span> res_denominator <span class="token operator">/=</span> g<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">Fraction</span><span class="token punctuation">(</span>res_numerator<span class="token punctuation">,</span> res_denominator<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">friend</span> ostream <span class="token operator">&amp;</span><span class="token keyword">operator</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>ostream <span class="token operator">&amp;</span>os<span class="token punctuation">,</span> Fraction <span class="token operator">&amp;</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>        os <span class="token operator">&lt;&lt;</span> f<span class="token punctuation">.</span>m_numerator <span class="token operator">&lt;&lt;</span> <span class="token string">"/"</span> <span class="token operator">&lt;&lt;</span> f<span class="token punctuation">.</span>m_denominator<span class="token punctuation">;</span>        <span class="token keyword">return</span> os<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">int</span> m_numerator<span class="token punctuation">;</span>       <span class="token comment">// 分子</span>    <span class="token keyword">int</span> m_denominator<span class="token punctuation">;</span>     <span class="token comment">// 分母</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Fraction <span class="token function">f1</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Fraction result <span class="token operator">=</span> f1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>   <span class="token comment">// 4 + f1 成立</span>    cout <span class="token operator">&lt;&lt;</span> result <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然而，解决方案也是有的，使用 <code>explict</code> 命令编译器，构造函数只能起构造函数的作用，不要做任何额外的构造，只有做构造的时候才去调用。不可以再把数值变成一个 Fraction。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">explict <span class="token function">Fraction</span><span class="token punctuation">(</span><span class="token keyword">int</span> _num<span class="token punctuation">,</span> <span class="token keyword">int</span> _den <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">m_numerator</span><span class="token punctuation">(</span>_num<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_denominator</span><span class="token punctuation">(</span>_den<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这样一些，就没有二义性的问题了，编译器会直接报错。</p><h5 id="转换函数在标准库中的应用"><a href="#转换函数在标准库中的应用" class="headerlink" title="转换函数在标准库中的应用"></a>转换函数在标准库中的应用</h5><p>模板的偏特化<br>根据 [] 索引取出来的应该是 bool 类型的变量，然而重载后的 [] 传出来的是 reference 类型，用 reference 代表 bool。因此，在 reference 类中有个转换函数将 reference 转换为 bool，转出去。<br><img src="https://i.bmp.ovh/imgs/2022/08/04/ba202f468a14e6f6.png"></p><h3 id="智能指针（Pointer-like-classes）"><a href="#智能指针（Pointer-like-classes）" class="headerlink" title="智能指针（Pointer-like classes）"></a>智能指针（Pointer-like classes）</h3><p>一个 C++ Class 实例化出<br>来的对象像一个指针。<br>指针能做的事，他都能做。<br>最首先，他需要实现 <code>.</code> 和 <code>-&gt;</code>。</p><h5 id="shared-ptr"><a href="#shared-ptr" class="headerlink" title="shared_ptr"></a>shared_ptr</h5><p><img src="https://i.bmp.ovh/imgs/2022/08/04/6e889657002edef0.png"></p><pre class="line-numbers language-none"><code class="language-none">#include &lt;iostream&gt;using namespace std;struct Foo {    void print() {        cout &lt;&lt; "hello world!" &lt;&lt; endl;    }    int a;};template&lt;class T&gt;class myshared_ptr{public:    myshared_ptr(T* p): px(p) {}    T&amp; operator*() const {        return *px;    }    T* operator-&gt;() const {        return px;    }private:    T*       px;    long*    pn;};int main() {    myshared_ptr&lt;Foo&gt; sp(new Foo);    sp-&gt;print();    return 0;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="iterator"><a href="#iterator" class="headerlink" title="iterator"></a>iterator</h5><p><img src="https://i.bmp.ovh/imgs/2022/08/04/18b06e460750f384.png"><br><img src="https://i.bmp.ovh/imgs/2022/08/04/ecff0775a3cb2630.png"><br>不旦要重载普通指针需要的 <code>.</code> 和 <code>-&gt;</code> 操作符，还要重载 ++，– 等。<br>具体还会开专题写</p><h3 id="仿函数（Function-like-classes）"><a href="#仿函数（Function-like-classes）" class="headerlink" title="仿函数（Function-like classes）"></a>仿函数（Function-like classes）</h3><p>长得像函数，用起来也像函数的 class。<br>函数需要一个 <code>() （function call operator）</code> 来操作。<br>这个 class 实例化出来的对象可以接受 <code>()</code> 操作符。<br>其中灰色的地方是继承了一串很长的东西。<br><img src="https://i.bmp.ovh/imgs/2022/08/04/5c4852e547b7b1ae.png"><br><img src="https://i.bmp.ovh/imgs/2022/08/04/b76b5d80e237244c.png"><br><img src="https://pic.imgdb.cn/item/62eb8adf16f2c2beb188048e.jpg"><br><img src="https://pic.imgdb.cn/item/62eb885316f2c2beb184b0f5.jpg"><br>灰色的部分就是继承了这个奇怪的类。<br>这个类的大小理论上是 0。<br><img src="https://pic.imgdb.cn/item/62eb886b16f2c2beb184d0fa.jpg"></p><h3 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h3><p><img src="https://pic.imgdb.cn/item/62eb8f8916f2c2beb18d72b3.jpg"><br>不同人开发了同一个名字的变量或函数，使用他自己的 namespace 把他的数据包裹起来，起到防止命名冲突的作用。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span> </span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">namespace</span> dog<span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"namespace : dog"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">namespace</span> cat <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"namespace : cat"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     dog<span class="token double-colon punctuation">::</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cat<span class="token double-colon punctuation">::</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h3><h5 id="定义基类"><a href="#定义基类" class="headerlink" title="定义基类"></a>定义基类</h5><pre class="line-numbers language-none"><code class="language-none">class Quoto {// 派生类和外部都可以访问public:    // ************* 构造函数 ************    // 默认构造    Quoto() = default;    // 有参构造    Quoto(const string _bookNo, int _price):         bookNo(_bookNo), price(_price) {}    // 拷贝构造    Quoto(const Quoto &amp;o) = default;        // ************* 成员函数 *************    string isbn() const { return bookNo; }    // 计算总价，派生类覆盖，分别计算不同的折扣    virtual double total_price(int n) const {        return n * price;    }    // 继承关系中根节点通常用虚析构函数    virtual ~Quoto() = default;// 派生类和外部都不可以访问private:    string bookNo;          // 书籍编号// 派生类可以访问，外部不可以访问protected:    double price = 0.0;     // 价格};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>基类通过在成员函数前加上 <code>virtual</code> 使得该函数执行<code>动态绑定</code>。<br><code>virtual</code> 只能出现在类内部的声明前，不能出现在类外部的函数定义。<br>基类的虚函数在派生类中隐式地也是虚函数。<br>非虚函数的解析过程发生在编译时，而不是运行时。</p><h5 id="定义派生类"><a href="#定义派生类" class="headerlink" title="定义派生类"></a>定义派生类</h5><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Bulk_quoto</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Quoto</span></span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token comment">// ************* 构造函数 ************</span>    <span class="token comment">// 默认构造</span>    <span class="token function">Bulk_quoto</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>    <span class="token comment">// 有参数构造</span>    <span class="token comment">// 父类2参数 + 子类2参数</span>    <span class="token function">Bulk_quoto</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> _bookNo<span class="token punctuation">,</span> <span class="token keyword">double</span> _price<span class="token punctuation">,</span> <span class="token keyword">int</span> _mq<span class="token punctuation">,</span> <span class="token keyword">double</span> _dst<span class="token punctuation">)</span><span class="token operator">:</span>            <span class="token function">Quoto</span><span class="token punctuation">(</span>_bookNo<span class="token punctuation">,</span> _price<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">min_quantity</span><span class="token punctuation">(</span>_mq<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">discount</span><span class="token punctuation">(</span>_dst<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment">// 拷贝构造</span>    <span class="token function">Bulk_quoto</span><span class="token punctuation">(</span><span class="token keyword">const</span> Bulk_quoto <span class="token operator">&amp;</span>o<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>    <span class="token comment">// ************* 成员函数 *************</span>    <span class="token comment">// 重写父类的折扣计算方法</span>    <span class="token comment">// 如果不重写，则直接执行父类的版本</span>    <span class="token comment">// override 显式注明它重写了某个成员函数的虚函数</span>    <span class="token keyword">double</span> <span class="token function">total_price</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> n <span class="token operator">&gt;=</span> min_quantity<span class="token operator">?</span> n <span class="token operator">*</span> price <span class="token operator">*</span> discount <span class="token operator">:</span> n <span class="token operator">*</span> price<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">int</span> min_quantity<span class="token punctuation">;</span>   <span class="token comment">// 满足折扣价格的最低购买量</span>    <span class="token keyword">double</span> discount<span class="token punctuation">;</span>    <span class="token comment">// 折扣率</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>派生类需要重新声明从父类中继承过来，并且需要重覆盖重写的成员函数。<br>如果派生类没有重写某个虚函数，那么该虚函数和其他普通成员函数的行为一样，调用时使用的是基类的版本。<br>在重写的虚函数后面显式地加上 <code>override</code> 可以注明该函数重写了基类的虚函数。</p><h5 id="派生类对象与基类对象的转换"><a href="#派生类对象与基类对象的转换" class="headerlink" title="派生类对象与基类对象的转换"></a>派生类对象与基类对象的转换</h5><p>一个派生类可以看作是多个子对象的集合：本类的数据，父类们的数据。<br>因此，在派生类的对象内存中存在基类的数据，因此可以将派生类当作基类来用。</p><p><img src="https://pic.imgdb.cn/item/62ebb1218c61dc3b8e606a11.jpg"></p><p>总结来说就是：</p><ol><li>基类指针可以指向子类对象 （中的基类部分）</li><li>基类引用绑定到子类对象 （中的基类部分）</li></ol><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Quoto item<span class="token punctuation">;</span>Bulk_quoto bulk<span class="token punctuation">;</span>Quoto <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>item<span class="token punctuation">;</span>   <span class="token comment">// 基类指针指向基类对象</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>bulk<span class="token punctuation">;</span>          <span class="token comment">// 基类指针指向子类对象</span>Quoto <span class="token operator">&amp;</span>r <span class="token operator">=</span> bulk<span class="token punctuation">;</span>    <span class="token comment">// 基类引用绑定到子类对象身上</span>cout <span class="token operator">&lt;&lt;</span> r<span class="token punctuation">.</span><span class="token function">total_price</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 合法</span>cout <span class="token operator">&lt;&lt;</span> p<span class="token operator">-&gt;</span><span class="token function">total_price</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 合法</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="派生类构造函数"><a href="#派生类构造函数" class="headerlink" title="派生类构造函数"></a>派生类构造函数</h5><p>派生类无法直接初始化基类中继承过来的成员，只能和创建基类对象一样，使用基类的构造函数初始化。<br>核心：每个类需要自己来控制其自身的初始化。<br>因此，在构造函数参数列表中需要传入：基类1构造参数，基类2构造参数…，派生类自己的构造参数。<br>在初始化列表中，需要提供：基类1(基类1构造参数)，基类2(基类2构造参数)…，派生类一一赋值。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">Bulk_quoto</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> _bookNo<span class="token punctuation">,</span> <span class="token keyword">double</span> _price<span class="token punctuation">,</span> <span class="token keyword">int</span> _mq<span class="token punctuation">,</span> <span class="token keyword">double</span> _dst<span class="token punctuation">)</span><span class="token operator">:</span>            <span class="token function">Quoto</span><span class="token punctuation">(</span>_bookNo<span class="token punctuation">,</span> _price<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">min_quantity</span><span class="token punctuation">(</span>_mq<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">discount</span><span class="token punctuation">(</span>_dst<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="派生类访问基类成员"><a href="#派生类访问基类成员" class="headerlink" title="派生类访问基类成员"></a>派生类访问基类成员</h5><p>如上所述，派生类可以访问基类的 public 和 protected 的成员。<br>派生类的作用域嵌套在基类的作用域当中。</p><blockquote><p>遵循基类接口<br>每个类负责自己的接口。<br>即使我们可以在派生类中直接给基类的 public 和 protected 成员变量赋值，但是最好不要这么做。使用基类的构造函数来初始化这些派生类从基类继承过来的成员。</p></blockquote><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">double</span> <span class="token function">total_price</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> n <span class="token operator">&gt;=</span> min_quantity<span class="token operator">?</span> n <span class="token operator">*</span> price <span class="token operator">*</span> discount <span class="token operator">:</span> n <span class="token operator">*</span> price<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="类与-static-成员"><a href="#类与-static-成员" class="headerlink" title="类与 static 成员"></a>类与 static 成员</h5><p>static 成员是一种与类绑定，与类直接相关的变量或函数。<br>任何对象都不存储该静态成员，并且 static 成员函数也无法使用 this 指针。<br>该静态成员有多种调用方式，一种是通过对象的 <code>.</code> 运算符调用，一种是通过作用域 <code>::</code>运算符。<br>static 关键字只能在类内部出现。<br>由于 static 数据不属于任何一个类的对象，因此无法使用构造函数初始化。<br>因此我们需要在<strong>类的外部定义和初始化</strong> static 数据。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span><span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">initRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span><span class="token keyword">static</span> <span class="token keyword">double</span> interestRate<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">double</span> Demo<span class="token double-colon punctuation">::</span>interestRate <span class="token operator">=</span> <span class="token function">initRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">double</span> <span class="token class-name">Demo</span><span class="token double-colon punctuation">::</span><span class="token function">initRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token number">0.01</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>Demo d<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> Demo<span class="token double-colon punctuation">::</span>initRate <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是 C++ 允许常量的静态成员类内初始化。<br>该静态成员必须是 constexpr 的整型常量表达式。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span><span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span> arr<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>并且即使在类内初始化了，类外也最好定义一下。<br>因此最好的办法是类内什么都不做。<br>遵循 <strong>类内声明，类外初始化</strong>。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span><span class="token keyword">constexpr</span> <span class="token keyword">static</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token comment">// 不推荐</span>    <span class="token keyword">int</span> arr<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>                     <span class="token comment">// 但是这里会用到，只能这么写    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>cout <span class="token operator">&lt;&lt;</span> Demo<span class="token double-colon punctuation">::</span>N<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="继承与-static-成员"><a href="#继承与-static-成员" class="headerlink" title="继承与 static 成员"></a>继承与 static 成员</h5><p>若基类定义了一个 static 成员，那么该成员在继承体系中只有唯一的定义，占一份内存。<br>如果该 static 对象是 public 的，那么大家都可以调用它；<br>如果是 private 的，则派生类无法调用。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span><span class="token function">Father</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"helloworld"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Son</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Father</span></span> <span class="token punctuation">{</span><span class="token keyword">void</span> <span class="token function">cnuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>Father f<span class="token punctuation">;</span>Son s<span class="token punctuation">;</span><span class="token class-name">Father</span><span class="token double-colon punctuation">::</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Son</span><span class="token double-colon punctuation">::</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>f<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>s<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="防止继承-final"><a href="#防止继承-final" class="headerlink" title="防止继承 final"></a>防止继承 final</h5><p>有些类我们不希望它被继承，继承体系到此为止。<br>使用 <code>final</code> 关键字后，该类无法被继承。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">NoDerived</span> <span class="token keyword">final</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Last</span> <span class="token keyword">final</span><span class="token operator">:</span> <span class="token keyword">public</span> Base<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// class Error : public NoDerived {};  错误</span><span class="token comment">// class Error : public Last {};       错误</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="C-对象动态内存分配"><a href="#C-对象动态内存分配" class="headerlink" title="C++ 对象动态内存分配"></a>C++ 对象动态内存分配</h3><h5 id="类中无指针"><a href="#类中无指针" class="headerlink" title="类中无指针"></a>类中无指针</h5><p>复数类</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">complex</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">complex</span> <span class="token punctuation">(</span><span class="token keyword">double</span> r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">double</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token operator">:</span> <span class="token function">re</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">im</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>    complex<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> complex<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">double</span> <span class="token function">real</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> re<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">double</span> <span class="token function">imag</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> im<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">double</span> re<span class="token punctuation">,</span> im<span class="token punctuation">;</span>    <span class="token keyword">friend</span> complex<span class="token operator">&amp;</span> <span class="token function">__doapl</span> <span class="token punctuation">(</span>complex<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> complex<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>动态分配内存单个对象<br><img src="https://pic.imgdb.cn/item/62ed12c08c61dc3b8e53d918.jpg"></p><p>动态分配内存需要用到 C++ 的关键字 <code>new</code>。<br>new 出来的对象是个匿名对象，其被程序员分配在堆上，程序员有责任管理该对象的创建和死亡。<br>由于是匿名的，需要一根指针指向该对象在堆上的地址。<br>创建时，首先编译器创建一个 <code>void*</code> 的指针，并以该对象的大小创建一块未被使用的从内存，并用该指针指向它。<br>随后，将该指针强制转换为该对象类型的指针，意味该指针指向一块大小为 <code>sizeof(double) * 2</code> 的内存。<br>随后，调用构造函数进行一系列初始化活动。</p><p><img src="https://pic.imgdb.cn/item/62ed13858c61dc3b8e573a6e.jpg"><br>当释放该对象时候，使用 <code>delete</code> 关键字进行释放。<br>首先调用该对象的析构函数，进行骚扫尾工作（由于该类内部无动态分配的数据，因此析构函数不用做什么特别的事情）。<br>其次，调用一个底层名为 <code>operator delete</code> 的函数释放该对象在堆中的内存，也就是管理该对象的指针指向的内存，也就是该对象唯一的两个 double 大小的内存块。</p><h5 id="类中含指针"><a href="#类中含指针" class="headerlink" title="类中含指针"></a>类中含指针</h5><p>String 类</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">String</span><span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> cstr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token keyword">const</span> String<span class="token operator">&amp;</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span> String<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> String<span class="token operator">&amp;</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">~</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">get_c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_data<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">private</span><span class="token operator">:</span><span class="token keyword">char</span><span class="token operator">*</span> m_data<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// 构造函数</span><span class="token keyword">inline</span><span class="token class-name">String</span><span class="token double-colon punctuation">::</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token keyword">const</span> String<span class="token operator">&amp;</span> str<span class="token punctuation">)</span><span class="token punctuation">{</span>m_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>m_data<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>m_data<span class="token punctuation">,</span> str<span class="token punctuation">.</span>m_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// 重载赋值运算符</span><span class="token keyword">inline</span>String<span class="token operator">&amp;</span> String<span class="token double-colon punctuation">::</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> String<span class="token operator">&amp;</span> str<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> m_data<span class="token punctuation">;</span>m_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>m_data<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>m_data<span class="token punctuation">,</span> str<span class="token punctuation">.</span>m_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// 重载输 &lt;&lt; 运算符</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream.h&gt;</span></span>ostream<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>ostream<span class="token operator">&amp;</span> os<span class="token punctuation">,</span> <span class="token keyword">const</span> String<span class="token operator">&amp;</span> str<span class="token punctuation">)</span><span class="token punctuation">{</span>os <span class="token operator">&lt;&lt;</span> str<span class="token punctuation">.</span><span class="token function">get_c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> os<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>动态内存分配单个对象<br><img src="https://pic.imgdb.cn/item/62ed15128c61dc3b8e5e38fe.jpg"><br>该操作符和成员变量不带指针的对象是类似的。<br>唯一的不同是，在调用构造函数的时候，会在堆中除了本对象的数据外，还会额外分配一块内存用于存储字符串，用一个成员变量（指针类型）指向它。</p><p><img src="https://pic.imgdb.cn/item/62ed15a08c61dc3b8e609135.jpg"><br>在释放对象的时候，就和无指针对象不太一样了。<br>该对象的析构函数会起到至关重要的作用，因为该对象内的指针维护了堆上的一块内存，因此在 delete 该对象的时候，析构函数也需要 delete 掉该对象内指针管理的数据。<br>因此，先将堆中 m_data 指针管理的内存释放干净，再调用 <code>operator delete</code> 释放本对象在堆中的数据（其实就是一个指针的大小）。</p><h5 id="单个对象在堆中的分布"><a href="#单个对象在堆中的分布" class="headerlink" title="单个对象在堆中的分布"></a>单个对象在堆中的分布</h5><p><img src="https://pic.imgdb.cn/item/62ed167d8c61dc3b8e6429ee.jpg"><br>计算机中一切东西都是有迹可循的。<br>当我们动态分配了一个对象后，堆中除了分配该对象需要的内存，还额外分配了两块 cookie，用于记录该对象占用的大小（否则只提供一个指针编译器不知道要回收多少字节），此外，在 debug 模式下还有一系列额外的字节和填充字节。填充字节用于该内存块向 16 byte 对齐，因为这样对齐后，cookie 存储的值低 4 位都是 0，可以用 1 代表该内存是申请，0 代表该内存已回收。</p><h5 id="对象数组在内存中的分布"><a href="#对象数组在内存中的分布" class="headerlink" title="对象数组在内存中的分布"></a>对象数组在内存中的分布</h5><p><img src="https://pic.imgdb.cn/item/62ed18688c61dc3b8e6c747d.jpg"><br>和单个对象是类似的，不过是一系列单个对象罢了。</p><p>但是对象数组的 delete 就很讲究了。<br>带指针的对象对象数组 delete 时需要使用 <code>delete[]</code>。<br><img src="https://pic.imgdb.cn/item/62ed18c98c61dc3b8e6e2d2a.jpg"><br>如果少了 [] 会造成内存泄漏，不过这个泄露并不是没有完全删除这个对象成员变量的内存，相反，这块内存会被完全删除，因为 cookie 记录了这块内存的大小。<br>会造成泄漏的是指针指向的内存。<br>使用了 delete [] 会调用三次析构函数，对象数组中的不同对象会分别析构他们的对象，将其指向的队中内存删除。<br>只用了 delete 只会调用一次析构，只删除了一个对象内指针指向的内存.<br>如果该对象不带指针，其实不加 [] 也没有关系，因此他们在堆中没有额外内存，整个对象会被释放，但这不是一个好的习惯。</p>]]></content>
      
      
      <categories>
          
          <category> C/C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySql - 视图</title>
      <link href="/2022/04/16/Mysql%20%E8%A7%86%E5%9B%BE/"/>
      <url>/2022/04/16/Mysql%20%E8%A7%86%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h1><h3 id="1-什么是视图"><a href="#1-什么是视图" class="headerlink" title="1. 什么是视图"></a>1. 什么是视图</h3><p>《数据库系统概念》中是这么描述视图的。</p><p>让用户看到数据库中关系的<code>完整集合</code>并非总是合适的。</p><p>处于安全性的考虑，我们可能需要向用户仅隐藏一个关系中的特定数据，</p><p>因此，我们可能希望创建一个<code>虚拟</code>的个性化集合。</p><p>该虚拟关系并<code>不预先</code>计算和存储，而是在<code>使用</code>虚拟关系的时候才能通过<code>执行查询</code>计算出来。</p><h3 id="2-语法"><a href="#2-语法" class="headerlink" title="2. 语法"></a>2. 语法</h3><h5 id="2-1-创建视图"><a href="#2-1-创建视图" class="headerlink" title="2.1 创建视图"></a>2.1 创建视图</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token operator">OR</span> <span class="token keyword">REPLACE</span><span class="token punctuation">]</span> <span class="token keyword">VIEW</span> 视图名称 <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>语句 <span class="token punctuation">[</span><span class="token keyword">WITH</span> <span class="token punctuation">[</span><span class="token keyword">CASCADED</span> <span class="token operator">|</span> <span class="token keyword">LOCAL</span><span class="token punctuation">]</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/70f029de3a9f475dbff19639c9f6332d.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>执行语句，可以看到多了这么一个东西</p><p><img src="https://img-blog.csdnimg.cn/f815cb289ff04f7090f7f2f62ffc9ce1.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="2-2-查询视图"><a href="#2-2-查询视图" class="headerlink" title="2.2 查询视图"></a>2.2 查询视图</h5><ul><li>查看视图创建</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> 视图名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a873aa2e20d54f3d848f03f78ef2193d.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/805791851416430a99fb8168262980ff.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>显然，<code>Create View</code>和我们创建时候的语句有些与不同，那是因为系统把缺省值也写进去了</p><ul><li>查看视图数据（表怎么查询，视图就怎么查询）</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 视图名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/1ffe2e7d0c5a4ddca7baca53a6c3e0b4.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/3c431fc314ae4de4a0d1d92941495033.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="2-3-修改视图"><a href="#2-3-修改视图" class="headerlink" title="2.3 修改视图"></a>2.3 修改视图</h5><p>方法一（其实和创建一个新视图是一回事）</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> 视图名称 <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>语句 <span class="token punctuation">[</span><span class="token keyword">WITH</span> <span class="token punctuation">[</span><span class="token keyword">CASCADED</span> <span class="token operator">|</span> <span class="token keyword">LOCAL</span><span class="token punctuation">]</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>方法二</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">VIEW</span> 视图名称<span class="token punctuation">[</span><span class="token punctuation">(</span>列名列表<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>语句 <span class="token punctuation">[</span><span class="token keyword">WITH</span> <span class="token punctuation">[</span><span class="token keyword">CASCADED</span> <span class="token operator">|</span> <span class="token keyword">LOCAL</span><span class="token punctuation">]</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="2-4-删除视图"><a href="#2-4-删除视图" class="headerlink" title="2.4 删除视图"></a>2.4 删除视图</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> 视图名称 <span class="token punctuation">[</span><span class="token punctuation">,</span>视图名称<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-检查选项"><a href="#3-检查选项" class="headerlink" title="3. 检查选项"></a>3. 检查选项</h3><p>我们可以对视图进行增删查改操作，这些操作会同步到物理存储的表当中。</p><p>由于我们在创建视图时设置了一些条件，如果没有设置检查选项，对视图插入不符合条件的记录也能成功插入到物理表当中。</p><p><img src="https://img-blog.csdnimg.cn/95694b85032e4b04bf4b575b3ca68fe8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>此时没有设置检查选项，能够插入不符合条件的数据。</p><p><img src="https://img-blog.csdnimg.cn/6f8afcf813b04424bae6bc9035252338.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>若我们加入检查选项，则这条记录的插入就会失败</p><p><img src="https://img-blog.csdnimg.cn/f9f2ec1142cb4bafac805982610d9f75.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="CASCADED-级联"><a href="#CASCADED-级联" class="headerlink" title="CASCADED (级联)"></a>CASCADED (级联)</h5><p>physical table -&gt; view A -&gt; view B</p><p>如果在 viewB 上增加检查选项 CASCADED 并执行插入时，MySQL会同时去检查view B和 view A中的条件。</p><p><img src="/2022/04/16/Mysql%20%E8%A7%86%E5%9B%BE/Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220419165514030.png" alt="image-20220419165514030"></p><p>刚开始我们创建一个视图 info_view ，不指定检查选项，发现 99 &gt; 5，仍然可以插入成功。</p><p>基于 info_view 我们再创建一个视图 info_view2。</p><p>当我们插入 id = 101 和 id = 4 时失败了，这是因为他们都不满足我们的检查条件。</p><p>一层一层往上检查，类似于诛九族。</p><p><img src="https://img-blog.csdnimg.cn/8ed58ba2556f424e856ef1cb7c18fbf9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>如果下面再创建一个视图 info_view3, 这个视图基于 info_view2。</p><p>该视图没有设置检查选项。</p><p>然而，前两个都插入成功，第三个插入失败了。</p><p>前两个插入成功的原因是他们符合 info_view1 和 info_view2 的检查选项（5 &lt; x &lt;= 100），而第三条不符合。</p><p><img src="https://img-blog.csdnimg.cn/486c6b7eddcb4b9bbd6d4c552ea12d1f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/6be68acfd5bb4cd2aa9b11ec3e8c19fc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/c501f3ed09284a6bad656e497a19b92e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>总而言之，如果使用 CASCADED 检查选项，其作用为：</p><ul><li>若当球视图<code>有检查选项</code>，则插入数据要满足<code>当前视图 + 当前视图所依赖的所有视图</code> 的检查选项。</li><li>若当前视图<code>没有检查选项</code>，则插入数据要满足<code>当前视图所依赖的有检查选项的视图 + 该有检查选项的视图所依赖的视图</code>的检查选项。</li></ul><p>自己及祖先只要有检查条件就就直接递归到根。</p><h5 id="local"><a href="#local" class="headerlink" title="local"></a>local</h5><p>第一层虽然 4 &lt; 5，但由于没设置检查选项，可以插入。</p><p><img src="https://img-blog.csdnimg.cn/bfd5f8686bf9490492200062d8e805c6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>第二层设置了检查选项，因此 101 肯定无法插入。</p><p><img src="https://img-blog.csdnimg.cn/6c9cc39f2e21439e81a47ab1977c8191.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>但是 4 却可以插入，因为MySQL也递归去检查，但是当前视图所依赖的视图没有检查选项，因此不再检查。</p><p><img src="https://img-blog.csdnimg.cn/e3584ca7cd5a4213b64bb856e4114f82.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>第三层，这个 1000 虽然不满足当前条件，但是却没有添加检查选项，因此递归网上检查，发现不复合第二层的条件，因此插入失败。</p><p><img src="https://img-blog.csdnimg.cn/69642d88fae24f6baff1215b10a6e3ac.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>如果我们给第一层也添加一个检查条件，会发现MySQL真的会递归检查。</p><p>19 同时不符合条件，插入失败。</p><p><img src="https://img-blog.csdnimg.cn/6aa1282ee5544522af08e9745cc02dc0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>21却可以。</p><p><img src="https://img-blog.csdnimg.cn/512be49c27dd4055be624ec41d14bfb4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>总结：</p><ul><li>若当球视图<code>有检查选项</code>，则插入数据要满足<code>当前视图 + 当前视图所依赖的有检查选项的视图</code> 的检查选项。</li><li>若当前视图<code>没有检查选项</code>，则插入数据要满足<code>当前视图所依赖的有检查选项的视图</code>的检查选项。</li></ul><p>简而言之，CASCADED 从自己开始往上找，只要碰到一个检查选项，从这一层开始及上面的所有选项都检查一遍，相当于只要发现一个上面全部连坐。LOCAL则是只有有检查选项才会检查。，相当于检查选项是local的，不会波及无辜。</p><h3 id="4-更新-amp-作用"><a href="#4-更新-amp-作用" class="headerlink" title="4. 更新 &amp; 作用"></a>4. 更新 &amp; 作用</h3><h5 id="视图的更新条件"><a href="#视图的更新条件" class="headerlink" title="视图的更新条件"></a>视图的更新条件</h5><p><img src="https://img-blog.csdnimg.cn/2e40a7a8e47442f6ba5778b6f94f8c90.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/7bd4258cfd1141dcabe969eedb183b7f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/e2e7c38e72ec4a1fb9e85667d9723fa3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/02b30d7f7a5d4daf8207a405cc4ca970.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux多进程</title>
      <link href="/2022/04/12/Linux%E5%A4%9A%E8%BF%9B%E7%A8%8B/"/>
      <url>/2022/04/12/Linux%E5%A4%9A%E8%BF%9B%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-多进程"><a href="#Linux-多进程" class="headerlink" title="Linux 多进程"></a>Linux 多进程</h1><h2 id="1-什么是进程"><a href="#1-什么是进程" class="headerlink" title="1. 什么是进程"></a>1. 什么是进程</h2><h3 id="1-1-程序-amp-进程"><a href="#1-1-程序-amp-进程" class="headerlink" title="1.1 程序 &amp; 进程"></a>1.1 程序 &amp; 进程</h3><p><img src="https://img-blog.csdnimg.cn/cab475b899a042b29a222a7dc593d2e6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>元信息：文件大小，创建、修改信息等</p><p><img src="https://img-blog.csdnimg.cn/2345357c403f4891a9e1f9c1b2087ba4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>程序只占用磁盘资源，是死的；进程占用内存资源、CPU资源，是活的。</p><h3 id="1-2-单道-amp-多道程序设计"><a href="#1-2-单道-amp-多道程序设计" class="headerlink" title="1.2 单道 &amp; 多道程序设计"></a>1.2 单道 &amp; 多道程序设计</h3><p><img src="https://img-blog.csdnimg.cn/a74e803c5857482c8f30d096fb8b90ca.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>早期计算机，一个计算机只能运行一个程序，如果要运行别的程序，当前程序必须停止，效率低下。</p><p>在单任务CPU中， 多道程序就是在管理程序的控制下穿插执行，而不是同时执行。目的：<code>提高CPU利用率</code>。</p><h3 id="1-3-时间片"><a href="#1-3-时间片" class="headerlink" title="1.3 时间片"></a>1.3 时间片</h3><p>把时间切成一片一片。</p><p><img src="https://img-blog.csdnimg.cn/94398aec116b414d9dd4e0ff0312dc80.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>进程调度的程序</code>来切换进程，保存（放到PCB中，见1.5）原先进程的状态，再加载另一个进程的状态。</p><p>时间片太短，会导致切换在整个程序运行中占了很大的百分比；如果时间片太长，会导致人能感觉出来，宏观上无法同时执行。</p><h3 id="1-4-并行-amp-并发"><a href="#1-4-并行-amp-并发" class="headerlink" title="1.4 并行 &amp; 并发"></a>1.4 并行 &amp; 并发</h3><p><img src="https://img-blog.csdnimg.cn/bb63ccf831404b799e82b00bf7806d36.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/9d1d033ebafa44fd91dd74ba66af656d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>并发问题：双11时，许多人会同时访问服务器，如何保证服务器在同一时刻大量的同时访问不崩溃掉？</p><h3 id="1-5-进程控制块-PCB"><a href="#1-5-进程控制块-PCB" class="headerlink" title="1.5 进程控制块 (PCB)"></a>1.5 进程控制块 (PCB)</h3><p><img src="https://img-blog.csdnimg.cn/adc8c12b631440539718c23ddabf29c1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="> </p><p><img src="https://img-blog.csdnimg.cn/057f6230b2784e04a294db6f0d65ae1d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>（当前工作目录）虚拟地址空间中有个环境变量</p><p>利用 <code>ulimit -a</code> 可以查看使用资源上线(可修改，但一般不这么做)</p><p><img src="https://img-blog.csdnimg.cn/0b311c88192d4fd689dc5f19ff8aa268.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h2 id="2-进程状态转换"><a href="#2-进程状态转换" class="headerlink" title="2. 进程状态转换"></a>2. 进程状态转换</h2><h3 id="2-1-进程的状态"><a href="#2-1-进程的状态" class="headerlink" title="2.1 进程的状态"></a>2.1 进程的状态</h3><p><img src="https://img-blog.csdnimg.cn/f1fad07422ec4f1ea751bd17e1d2a7d2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>就绪态时，OS已经为进程分配了内存资源，但是没有CPU资源。</p><p>简而言之，万事俱备，等待调度，只剩被CPU执行。</p><p>阻塞态无法直接变成运行态，而是需要先进入就绪态。</p><p><img src="https://img-blog.csdnimg.cn/819c0259067b4ae780dcbabd29defce2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="2-2-进程相关命令"><a href="#2-2-进程相关命令" class="headerlink" title="2.2 进程相关命令"></a>2.2 进程相关命令</h3><h5 id="ps-aux-amp-ps-ajx"><a href="#ps-aux-amp-ps-ajx" class="headerlink" title="ps aux &amp; ps ajx"></a><code>ps aux</code> &amp; <code>ps ajx</code></h5><p>查看进程快照snapshot（静态数据）</p><p><img src="https://img-blog.csdnimg.cn/fe7918f133e748bfa382b9d0085ae671.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="ps aux"></p><p><img src="https://img-blog.csdnimg.cn/0fee9a9becdb490b95d07601f18d276f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>tty</code> 可以查看当前在哪个终端。</p><p><img src="https://img-blog.csdnimg.cn/dd59a723d08b4f94a1ac53344b35311b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/7a21481cf4374ccda3ac9e0d5debf37c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="ps ajx"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>PPID</code>：parent process ID -&gt; 父进程ID</p><p><code>PGID</code>：process group ID -&gt; 进程组ID</p><blockquote><p>一个进程组里面可以有很多个进程</p></blockquote><p><code>SID</code>：session ID -&gt; 会话ID</p><h5 id="top"><a href="#top" class="headerlink" title="top"></a><code>top</code></h5><p>实时更新</p><p><img src="https://img-blog.csdnimg.cn/20ebbd3aa48b4ee7b781d9c7930de092.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/57e21e24a89346e59697b32c80a9cd74.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="top"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="kill"><a href="#kill" class="headerlink" title="kill"></a><code>kill</code></h5><p><img src="https://img-blog.csdnimg.cn/49d19bb98fa647118fed8b3abb94ec8d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="kill"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>kill -9 self‘s PID</code> 可以杀死自己， 光 <code>kill self's PID</code>杀不死自己。</p><p><img src="https://img-blog.csdnimg.cn/71fa8ccf1a924710bb71957729c35a40.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>-9 是 <code>9号信号</code>，是个<code>宏</code>值</p><p><code>kill -SIGKILL self's PID</code>也有同样的效果</p><p><img src="https://img-blog.csdnimg.cn/d19abc8d90184d979956348a0e986472.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>使用 <code>./filename &amp;</code> 可以使得程序在后台运行，同时可以输入一些指令。</p><p>如果在前台运行，当前的shell是阻塞的，不能输入任何内容，等待程序结束。</p><h3 id="2-3-进程号"><a href="#2-3-进程号" class="headerlink" title="2.3. 进程号"></a>2.3. 进程号</h3><p><img src="https://img-blog.csdnimg.cn/411cb725b0d746b4b147f575c6847caf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>init进程</code>是操作系统内核最初始，最大的进程，任何进程都是由 init 进程派生出来的。</p><p>我们执行的程序的父进程是当前的 <code>shell</code>。</p><p><code>getpgid(pid_t pid)</code>,如果参数传NULL, 就是获取当前进程的PGID, 如果传一个进程的PID, 就是获取这个指定的进程号的PGID。</p><h2 id="3-进程创建"><a href="#3-进程创建" class="headerlink" title="3. 进程创建"></a>3. 进程创建</h2><p><img src="https://img-blog.csdnimg.cn/c463c49b14bb491994a537faa7732164.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       fork <span class="token operator">-</span> create a child processSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token class-name">pid_t</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// pid_t 是个 int</span>DESCRIPTION       <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  【creates  a  new  process】 by 【duplicating the calling process】<span class="token punctuation">.</span>  The new process is referred to as the child process<span class="token punctuation">.</span>       The calling process is referred to as the parent process<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child process, return value=%d, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                pid<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent process, return value=%d, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                pid<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//sleep(1);</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="我们无法揣测子进程和父进程谁先执行"><a href="#我们无法揣测子进程和父进程谁先执行" class="headerlink" title="我们无法揣测子进程和父进程谁先执行"></a>我们无法揣测子进程和父进程谁先执行</h5><p>所有的代码在父子进程的地址空间中都有，只不过在子进程中，</p><p>调用fork()之前的代码不会被执行。</p><p>这一段非常明显，因为我们发现 父进程pid=153207，子进程pid=153208</p><p>父进程首先运行，打印到684之后中断发生，</p><p>子进程开始运行，打印一行消息，</p><p>之后再次切换到父进程打印685，</p><p>之后又切换到子进程，打印1，2</p><p>如此循环往复，不断切换…</p><p>具体谁执行却决于操作系统调度哪个进程</p><p><img src="https://img-blog.csdnimg.cn/5e4adb73849e4761b885ad838f7bc23c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h2 id="3-父子进程"><a href="#3-父子进程" class="headerlink" title="3. 父子进程"></a>3. 父子进程</h2><h3 id="3-1-父子进程の虚拟地址空间情况"><a href="#3-1-父子进程の虚拟地址空间情况" class="headerlink" title="3.1 父子进程の虚拟地址空间情况"></a>3.1 父子进程の虚拟地址空间情况</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">The child process and the parent process run in 【separate memory spaces】<span class="token punctuation">.</span>  At the time of <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> both memory spaces have the 【same content】<span class="token punctuation">.</span>  Memory writes<span class="token punctuation">,</span> file <span class="token function">mappings</span> <span class="token punctuation">(</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> and <span class="token function">unmappings</span> <span class="token punctuation">(</span><span class="token function">munmap</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> performed by one of the processes <span class="token keyword">do</span> not affect the other<span class="token punctuation">.</span>       The child process is an exact duplicate of the parent process except <span class="token keyword">for</span> the following points<span class="token operator">:</span><span class="token operator">*</span>  The child has its 【own unique process ID】<span class="token punctuation">,</span> and this PID does not match the ID of any existing  process  <span class="token function">group</span> <span class="token punctuation">(</span><span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> or session<span class="token punctuation">.</span>       <span class="token operator">*</span>  The child's parent process ID is the same as the parent's process ID<span class="token punctuation">.</span>       <span class="token operator">*</span>  The child does 【not inherit】 its parent's 【memory locks】 <span class="token punctuation">(</span><span class="token function">mlock</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mlockall</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token operator">*</span>  Process  resource  <span class="token function">utilizations</span>  <span class="token punctuation">(</span><span class="token function">getrusage</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  and  CPU time <span class="token function">counters</span> <span class="token punctuation">(</span><span class="token function">times</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> are reset to zero in the child<span class="token punctuation">.</span>       <span class="token operator">*</span>  The child's set of pending signals is initially <span class="token function">empty</span> <span class="token punctuation">(</span><span class="token function">sigpending</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token operator">*</span>  The child does not inherit semaphore adjustments from its <span class="token function">parent</span> <span class="token punctuation">(</span><span class="token function">semop</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token operator">*</span>  The child does not inherit process<span class="token operator">-</span>associated record locks from its <span class="token function">parent</span> <span class="token punctuation">(</span><span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  <span class="token punctuation">(</span>On the other hand<span class="token punctuation">,</span> it does inherit <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> open file description locks and <span class="token function">flock</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> locks from its parent<span class="token punctuation">.</span><span class="token punctuation">)</span>       <span class="token operator">*</span>  The child does not inherit timers from its <span class="token function">parent</span> <span class="token punctuation">(</span><span class="token function">setitimer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">timer_create</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token operator">*</span>  The  child  does  not  inherit  outstanding  asynchronous  I<span class="token operator">/</span>O  operations  from  its  <span class="token function">parent</span> <span class="token punctuation">(</span><span class="token function">aio_read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">aio_write</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nor does it inherit any asynchronous I<span class="token operator">/</span>O contexts from its <span class="token function">parent</span> <span class="token punctuation">(</span>see <span class="token function">io_setup</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>父进程和子进程的虚拟地址空间完全一样，包括用户区和内核区。（除了两者的pid不同，以及fork的返回值不同（父进程中返回值=子进程pid，子进程中返回值=0））。</p><p>因此修改同名变量并不会影响对方，因为两者分明就在不同的内存中，只不过数据都是赋值过来的罢了。</p><p><img src="https://img-blog.csdnimg.cn/6f7426aed23a4363ba679f838649f7cc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> global_a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 测试全局变量（子进程复制）</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> local_a <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span><span class="token comment">// 测试局部变量（子进程复制）</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> after_fork_a <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span><span class="token comment">// 测试fork之后各自产生的局部变量</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Before: global_a=%d, local_a=%d, after_fork_a=%d\n"</span><span class="token punctuation">,</span>\            global_a<span class="token punctuation">,</span> local_a<span class="token punctuation">,</span> after_fork_a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child process, return value=%d, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                pid<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token operator">++</span> global_a<span class="token punctuation">,</span> <span class="token operator">++</span> local_a<span class="token punctuation">,</span> <span class="token operator">++</span> after_fork_a<span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"global_a=%d, local_a=%d, after_fork_a=%d\n"</span><span class="token punctuation">,</span>                global_a<span class="token punctuation">,</span> local_a<span class="token punctuation">,</span> after_fork_a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>         <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent process, return value=%d, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                pid<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token operator">--</span> global_a<span class="token punctuation">,</span> <span class="token operator">--</span> local_a<span class="token punctuation">,</span> <span class="token operator">--</span> after_fork_a<span class="token punctuation">;</span>                     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"global_a=%d, local_a=%d, after_fork_a=%d\n"</span><span class="token punctuation">,</span>                global_a<span class="token punctuation">,</span> local_a<span class="token punctuation">,</span> after_fork_a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/bca2c668179149b38209c1109653af15.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="写时复制"><a href="#写时复制" class="headerlink" title="写时复制"></a>写时复制</h5><p>实际上，Linux的fork()使用的是写时拷贝（copy-on-write）技术。</p><p>写时拷贝是一种可以<code>推迟</code>甚至<code>避免</code>拷贝数据的技术。</p><p>内核此时并不复制整个进程的地址空间，而是让父子进程<code>共享</code>同一个地址空间。</p><p>只有在需要写如的时候才会复制地址空间，从而使各个进程拥有各自的不同的地址空间。</p><p>换而言之，资源的复制是在需要写入的时候才会进行，</p><p>在此之前通过<code>只读（read-only）</code>方式共享数据。</p><p>因为如果你没有写操作，拷贝会拉跨性能，</p><p>更别说你fork完了就直接exec。</p><p>fork()之后父子进程<code>共享文件</code>，</p><p>fork()产生的子进程与父进程有<code>相同的文件描述符</code>，指向相同的文件，</p><p>引用计数增加，共享文件偏移指针。</p><p><strong>读的时候共享，一旦有写操作就马上复制，互不干扰</strong></p><p><img src="https://img-blog.csdnimg.cn/798b2e69b46d43f2a151f0c5c8bbe125.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="3-2-父子进程の关系-と-GDB多进程调试"><a href="#3-2-父子进程の关系-と-GDB多进程调试" class="headerlink" title="3.2 父子进程の关系 と GDB多进程调试"></a>3.2 父子进程の关系 と GDB多进程调试</h3><h5 id="父子进程关系"><a href="#父子进程关系" class="headerlink" title="父子进程关系"></a>父子进程关系</h5><p>区别：1.fork()函数的返回值不同</p><p>​                    父进程：&gt; 0 返回子进程的PID</p><p>​                    子进程：= 0 </p><p>​            2.PCB（Process Control Block）中的一些数据</p><p>​                    当前进程的ID -&gt; PID</p><p>​                    当前进程的父进程ID -&gt; PPID</p><p>​                    信号集</p><p>共同点：</p><ol><li><p>某些状态下，子进程刚被创建出来，还没有执行任何写数据的操作时，</p><p>​    用户区数据相同</p><p>​    文件描述符表相同</p></li></ol><ol start="2"><li><strong>父子进程<code>读时共享</code>变量，写时候<code>拷贝</code>变量（因此不能用变量进行进程间通信)</strong></li></ol><h5 id="gdb调试"><a href="#gdb调试" class="headerlink" title="gdb调试"></a>gdb调试</h5><p><img src="https://img-blog.csdnimg.cn/a0b18e6e02034cad949fb02bf9aa591e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"></p><p><code>set follow-fork-mode [parent | child]</code>：切换默认调试的进程</p><p><code>set detach-on-fork [on | off]</code>：off会使得其他进程阻塞在fork这一句，不自动运行下去</p><p><code>detach inferiors id</code>：使得编号为id的进程脱离调试，直接运行下去，这里还可以换成remove/kill等命令</p><h2 id="4-exec-函数族"><a href="#4-exec-函数族" class="headerlink" title="4. exec 函数族"></a>4. exec 函数族</h2><p><code>函数族</code>：一系列功能相近的函数，类似C++中的函数重载</p><p><img src="https://img-blog.csdnimg.cn/3af4935f260546fd942a5a21fc6a99e5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>由于直接调用exec会覆盖当前进程的数据，而主进程往往也要做一些事情，因此我们先fork出来一个子进程，在子进程中执行exec。</p><p>exec执行成功后不返回，因为本身进程中的内容被替换了（除了PID等表面信息），执行exec的进程中的代码全都变了，变成了新程序的代码，因此返回没有任何意义。所以只有调用失败时才会返回，告知调用失败，原来的代码不会被替换，从exec的调用点接着往下执行。</p><p><img src="https://img-blog.csdnimg.cn/3f7e70af891049e8b7708fe712c254d3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/0cf2bd28947d4a4baaf0a37b2d42f91c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p> 只有 <code>execve</code> 才是UINX/LINUX的系统函数，其余6个都是在这个基础上的封装，其中 <code>execl</code>和<code>execlp</code>比较常用。</p><h5 id="execl"><a href="#execl" class="headerlink" title="execl"></a>execl</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">execl</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//(可变参数，一个或多个)</span>                      <span class="token comment">/* (char  *) NULL */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>参数：</p><ul><li>文件路径（文件路径及建议使用绝对路径）</li><li>传入参数列表<ul><li><code>argv[0]</code>时程序的名称，后面都是参数列表，最后以NULL结束（哨兵，是程序知道解析完成）</li></ul></li></ul><p>返回值：</p><ul><li>只有在调用失败时才会返回 <code>-1</code>，并设置 <code>errorno</code></li><li>调用成功没有返回值</li></ul><h5 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Parent process, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">execl</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This might not be printed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这句话是不应该被输出的</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i = %d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中，可执行程序hello的源代码为</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">1</span> #include <span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>                                                                                                                 <span class="token number">2</span><span class="token number">3</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">4</span> <span class="token punctuation">{</span><span class="token number">5</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">6</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token number">7</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行成功，可以看到execl后面的那句<code>printf("This might not be printed.\n");</code>和后面的循环并没有被执行，可见新的可执行程序将原来的子进程代码替换掉了。</p><p>然而，这里的Hello似乎没有和其他的输出在同一个块中，这是因为<code>孤儿进程</code>的缘故。</p><p><img src="https://img-blog.csdnimg.cn/74df804c2ffd4478b46bb997a8d28c22.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>只要在原来的代码父进程中加一句<code>sleep</code>，就可以解决这个问题。</p><p><img src="https://img-blog.csdnimg.cn/cded13399730469fadcdb8667b1af8b7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>此外，我们也可以执行系统的可执行程序</p><h5 id="测试代码（执行-ps-aux）"><a href="#测试代码（执行-ps-aux）" class="headerlink" title="测试代码（执行 ps aux）"></a>测试代码（执行 <code>ps aux</code>）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Parent process, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">execl</span><span class="token punctuation">(</span><span class="token string">"/bin/ps"</span><span class="token punctuation">,</span> <span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 第一个参数写./ps也可以</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This might not be printed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i = %d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/23b8d48b726c4693a0f1190679a30903.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="execl执行SHELL命令"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="execlp"><a href="#execlp" class="headerlink" title="execlp"></a>execlp</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                       <span class="token comment">/* (char  *) NULL */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>参数：</p><ul><li>文件名（会到环境变量中查找指定的可执行文件，如果找到了就执行，找不到就执行不成功）</li><li>参数列表</li></ul><p>如果直接在<code>execl</code>中直接写文件名，他会找不到该文件</p><p><img src="https://img-blog.csdnimg.cn/9a71ca7dc94a4e5e8460bca3fd355667.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>但是<code>execlp</code>却能做到不写绝对路径（或者该可执行文件不在当前目录下），直接写文件名</p><h5 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Parent process, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This might not be printed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i = %d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/524a843223cb482c868cb3eaa37afe77.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这是因为ps的信息已经在环境变量中了，程序会自己去环境变量中寻找这个可执行文件。</p><p>输入 <code>env</code> 可以查看环境变量。</p><p><img src="https://img-blog.csdnimg.cn/ccda21d478324e36b3bf4f4e68fd474c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="execv"><a href="#execv" class="headerlink" title="execv"></a>execv</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">execv</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参数：</p><ul><li>字符串数组，把需要的参数都写到数组里传进去</li></ul><h5 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Parent process, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// 参数列表</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">execv</span><span class="token punctuation">(</span><span class="token string">"/bin/ps"</span><span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This might not be printed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i = %d, pid = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-进程退出-と-孤儿进程-と-僵尸进程"><a href="#5-进程退出-と-孤儿进程-と-僵尸进程" class="headerlink" title="5. 进程退出 と 孤儿进程 と 僵尸进程"></a>5. 进程退出 と 孤儿进程 と 僵尸进程</h2><p><img src="https://img-blog.csdnimg.cn/063388892c8a4c61b6af605b05b6827b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>子进程退出后，父进程可以获得子进程的退出状态，因为什么原因退出。</p><p>子进程的<code>用户区数据</code>会自动释放，父进程有义务回收<code>内核区的数据（PCB）</code>。</p><h5 id="exit-标准C库函数"><a href="#exit-标准C库函数" class="headerlink" title="exit (标准C库函数)"></a>exit (标准C库函数)</h5><p>标准C库的<code>exit()</code>会做更多的事情（相比<code>_exit()</code>）,包括刷新缓冲区（将缓冲区中的数据写入相应的文件）等，最后调用底层的<code>_exit()</code>。</p><h5 id="测试代码-3"><a href="#测试代码-3" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/fc424710c34b4f6a98ec12f20ab6ad7f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>\n</code>会刷新缓冲区，因此在打印了Hello之后缓冲区就空了，之后再打印world，这个实际上也先被写入了缓冲区，调用exit()退出时，系统也先刷新缓冲区，world被写在了屏幕上。</p><h5 id="exit-Linux系统函数"><a href="#exit-Linux系统函数" class="headerlink" title="_exit (Linux系统函数)"></a>_exit (Linux系统函数)</h5><h5 id="测试代码-4"><a href="#测试代码-4" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2022/04/12/Linux%E5%A4%9A%E8%BF%9B%E7%A8%8B/Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220414000215298.png" alt="image-20220414000215298"></p><p>神奇的是，world并没有被输出，这是因为前面<code>\n</code>刷新了缓冲区，这句printf执行完之后缓冲区被刷新了，之后的world被写入了缓冲区，但是_exit()系统函数并不会刷新缓冲区，因此只输出了Hello。</p><h5 id="孤儿进程"><a href="#孤儿进程" class="headerlink" title="孤儿进程"></a>孤儿进程</h5><p><img src="https://img-blog.csdnimg.cn/8d98f06394c9456c8bffd3d943e660a0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="测试代码-5"><a href="#测试代码-5" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 子进程睡1s，父进程早就运行完死了</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child process, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent process, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> j<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/4efd6c5bdfd74739a1ddaf9f98744be2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>可见，父进程运行结束后，shell马上给出了提示符，但是子进程运行完没有给。</p><p>这是因为，当我们./app开始运行，shell会自动切换到后台运行，有输出了再切换到前台输出。我们的shell是这个pid=157394的父进程，他知道这个进程结束了，因此shell切换回了前台，显示提示符。但是他不知道我们运行的这个进程还有个子进程。</p><p>由于子进程和父进程共享文件描述符，因此子进程也会输出到终端。</p><p>最终子进程被1号进程init领养，回收。</p><p>孤儿进程没有任何危害。</p><h5 id="僵尸进程"><a href="#僵尸进程" class="headerlink" title="僵尸进程"></a>僵尸进程</h5><p><img src="https://img-blog.csdnimg.cn/66d2bac3e1674ad99af6963af12f0bc7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>孤儿进程是父亲先死亡，孩子变成了孤儿，被init释放。</p><p>僵尸进程是孩子死亡，但是父亲没有去回收子进程的资源。为什么会这样呢？</p><h5 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child process, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent process, pid=%d, ppid=%d\n"</span><span class="token punctuation">,</span>\                <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/513822d9f54c4d7c91e169ef93b15734.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>子进程结束后，父进程仍被困在死循环里没有去回收子进程，因此子进程变成了一个僵尸进程。</p><p>且无法用 kill -9 杀死。</p><p>如果产生了大量的僵尸进程，会导致大量的进程号被占用。</p><p><img src="https://img-blog.csdnimg.cn/2e0ad670ff574d20b6c8be2e2a7f86bb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h2 id="6-wait-函数-と-waitpid-函数"><a href="#6-wait-函数-と-waitpid-函数" class="headerlink" title="6. wait 函数 と waitpid 函数"></a>6. wait 函数 と waitpid 函数</h2><h5 id="进程回收"><a href="#进程回收" class="headerlink" title="进程回收"></a>进程回收</h5><p>父进程通过调用<code>wait</code> 或 <code>waitpid</code> 得到子进程的退出状态，并彻底清除这个进程。</p><p><code>wait</code>是阻塞地等待，如果子进程一直没结束，父进程就一直阻塞，直到子进程结束。</p><p>子进程死亡后父进程中的wait不阻塞，往下执行。</p><p>waitpid 可以设置为不阻塞，还可以指定等待哪个子进程结束。</p><p>应该在循环中多次调用 wait，清理多个子进程。</p><h4 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h4><p>执行成功返回被回收的子进程PID，没有子进程了或失败返回 -1。</p><h5 id="示例代码（僵尸进程的产生）"><a href="#示例代码（僵尸进程的产生）" class="headerlink" title="示例代码（僵尸进程的产生）"></a>示例代码（僵尸进程的产生）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"son pid=%s died\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，执行程序之后，，5个子进程打印了各自的进程号之后直接死亡，父进程继续执行。</p><p><img src="https://img-blog.csdnimg.cn/d51dab915f5b4815bb0cfaa5ec37b82e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>由于父进程一直在死循环中执行，没有去回收子进程，导致已经死亡却没有被回收的子进程成为了5个僵尸进程，使用 <code>ps aux</code> 可以看到他们的状态是Z。</p><p><img src="https://img-blog.csdnimg.cn/fcbbce837e2245d89616d627fdd520c2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>当我们用 <code>kill -9</code> 去杀死僵尸进程，惊奇地发现他们无法被杀死。</p><p><img src="https://img-blog.csdnimg.cn/6f084087cafa4a3aa217f4d5bc0dd44e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_13,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>kill 之后这个进程仍然存在。我们只能通过 <code>ctrl + c</code> 来中止当前的父进程。</p><p><img src="https://img-blog.csdnimg.cn/39e7cc4cb603443bad33bd7c2af020f2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="示例代码（父进程通过wait释放子进程资源）"><a href="#示例代码（父进程通过wait释放子进程资源）" class="headerlink" title="示例代码（父进程通过wait释放子进程资源）"></a>示例代码（父进程通过wait释放子进程资源）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 父进程会在这里阻塞</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child pid=%d died!\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，父进程就打印了一行就再也没有出现过了，因为wait是阻塞等待，父进程阻塞在wait那里等待子进程的死亡。</p><p><img src="https://img-blog.csdnimg.cn/ce1b1bad64a8402d80e7183361baf971.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>此时父进程和他的5个子进程都是正常运行的进程。</p><p><img src="https://img-blog.csdnimg.cn/625bd096b0914dabba05638fa833ae86.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>接下来，我们将5个子进程挨个杀掉。</p><p><img src="https://img-blog.csdnimg.cn/8acb6db782fd4d62a1d90a420db909ea.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>可以看到输出变化了，这是因为父进程通过wait阻塞等待，终于等到一个子进程死亡，他马上为子进程办理后事，轻装上阵，因此打印出了 I’m parent…</p><p>然而这里好像有点bug，wait若执行成功会返回子进程的PID给ret并打印，然而这里打印的都是父进程的PID，啥时候我再研究一下。</p><p><img src="https://img-blog.csdnimg.cn/6aa68294b5c844c7b94152375803d043.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_13,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="查看子进程退出状态"><a href="#查看子进程退出状态" class="headerlink" title="查看子进程退出状态"></a>查看子进程退出状态</h5><h5 id="示例代码（子进程自然死亡）"><a href="#示例代码（子进程自然死亡）" class="headerlink" title="示例代码（子进程自然死亡）"></a>示例代码（子进程自然死亡）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d died\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> st<span class="token punctuation">;</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child died peacefully, status:%d\n"</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 正常中止</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child was killed by signal %d\n"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 被信号中止</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>父进程执行了一句话之后就阻塞，等待子进程的退出。</p><p>5个子进程都正常退出，父进程接收到的退出状态也因此是0.</p><p><img src="https://img-blog.csdnimg.cn/9d8fe6d7f59b4a5eaf5e1a927c9e7f36.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="示例代码（利用9号信号杀死子进程）"><a href="#示例代码（利用9号信号杀死子进程）" class="headerlink" title="示例代码（利用9号信号杀死子进程）"></a>示例代码（利用9号信号杀死子进程）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d died\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> st<span class="token punctuation">;</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child died peacefully, status:%d\n"</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 正常中止</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child was killed by signal %d\n"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 被信号中止</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>刚开始和前面一样，父进程执行一句之后就阻塞。</p><p><img src="https://img-blog.csdnimg.cn/1d9b125f965e477b809d81dd8721ee7a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>现在，我们利用9号信号杀死子进程，动作利索点5个全干掉。</p><p><img src="https://img-blog.csdnimg.cn/55092bf5f4d147bbb88f51c6f1af1bff.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>可以看到，子进程的退出状态为9。</p><p><img src="https://img-blog.csdnimg.cn/828073056b7c4231804145ca3676b4d2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_15,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="关于wait的函数参数-int-wstatus"><a href="#关于wait的函数参数-int-wstatus" class="headerlink" title="关于wait的函数参数 int *wstatus"></a>关于wait的函数参数 <code>int *wstatus</code></h5><p>这是个传出参数，因此要传入指针，获取子进程的退出状态。</p><p><img src="https://img-blog.csdnimg.cn/d14117afeaa047829f655c2419304461.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="waitpid"><a href="#waitpid" class="headerlink" title="waitpid"></a>waitpid</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">pid_t</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>wstatus<span class="token punctuation">,</span> <span class="token keyword">int</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参数：</p><ul><li>指定的PID<ul><li>PID &gt; 0：指定谁就回收谁</li><li>PID = 0：回收在该进程组中的所有子进程</li><li>PID = -1：回收所以子进程（包括其他组），相当于wait（最常用）</li><li>PID &lt; -1：回收某个进程组的子进程，GID = ABS(PID)</li></ul></li><li>子进程退出状态</li><li>设置阻塞/非阻塞<ul><li>0：阻塞等待</li><li>WNOHANG：非阻塞，没有子进程退出就立马返回，不等待</li></ul></li></ul><p>返回值：</p><ul><li>&gt; 0：返回子进程PID</li><li>= 0：当options = WNOHANG，表示还有子进程活着</li><li>= -1：没有子进程了，或执行错误</li></ul><h5 id="示例代码（阻塞状态）"><a href="#示例代码（阻塞状态）" class="headerlink" title="示例代码（阻塞状态）"></a>示例代码（阻塞状态）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d died\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> st<span class="token punctuation">;</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token comment">//if(ret == 0) continue;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child died peacefully, status:%d\n"</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 正常中止</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child was killed by signal %d\n"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 被信号中止</span>                    <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>子进程一直在跑，父进程一直在阻塞等待，只输出了一句话。</p><p><img src="https://img-blog.csdnimg.cn/e42b7295de2745bca69de46776b03067.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="示例代码（非阻塞）"><a href="#示例代码（非阻塞）" class="headerlink" title="示例代码（非阻塞）"></a>示例代码（非阻塞）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm son, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d died\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent, pid=%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> st<span class="token punctuation">;</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">// 没有子进程死亡，父进程继续跑</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child died peacefully, status:%d\n"</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 正常中止</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child was killed by signal %d\n"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 被信号中止</span>                    <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，在非阻塞状态下，父进程和子进程同时在运行。</p><p><img src="https://img-blog.csdnimg.cn/36759eb639bb40a9b8d30fc81ec4b8cc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_16,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>我们也可以利用信号去杀掉子进程。</p><p><img src="https://img-blog.csdnimg.cn/c7a5b59cb3df4bf5a12fd11845d50a3b.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/c05a042367fd4eb98bd59eca870ea5e0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h2 id="7-进程间通信"><a href="#7-进程间通信" class="headerlink" title="7. 进程间通信"></a>7. 进程间通信</h2><p><code>IPC (Inter-Process Communication)</code></p><p><img src="https://img-blog.csdnimg.cn/d9c4ccf811784e2faf5ae9b06b949f2b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>进程间关系</code>：</p><ul><li>父与子</li><li>两个互不相干</li></ul><p>通信：互相<code>发送</code>数据，<code>接受</code>数据</p><p>按道理来说，两个互不相干的进程不能互相访问对方的资源。</p><p><strong>进程间<code>独立</code>，但<code>不孤立</code>。</strong></p><p>对于父子进程，读时共享，写时复制，实际上两个进程间的数据是没有关系的，只是某些部分一样罢了。</p><p>像我们使用通讯软件（如QQ，微信），两个人的进程运行在不同的主机上，两个人发送消息，实质上就是进程间通信。</p><p>再比如迅雷下载视频，可以边下载边播放，至少有两个进程（后面会讲到线程）。</p><p>我们下载了多少才能看多少，因此<code>下载进程</code>需要告诉<code>播放进程</code>现在可以看多少，互相告知现在的状态。</p><p>同步：协同合作，很安全，挨个有序进行。</p><p>异步：不安全，不等待，大家一起来，很散漫。</p><p>GDB希望完全控制另一个进程，并且可以共享其数据（如被调试进程有输出）。</p><h5 id="通信方式"><a href="#通信方式" class="headerlink" title="通信方式"></a>通信方式</h5><p><img src="https://img-blog.csdnimg.cn/e59b6ea57e96487da92ba5df74efdd4a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>加一个：消息队列，共享内存，信号量，<code>内存映射</code></p><h2 id="8-通信方式一：匿名管道"><a href="#8-通信方式一：匿名管道" class="headerlink" title="8. 通信方式一：匿名管道"></a>8. 通信方式一：匿名管道</h2><p>管道默认为匿名管道。</p><p>匿名管道是Unix最古老的进程间通信形式</p><p><img src="https://img-blog.csdnimg.cn/ae7b14ada5f14fe1a1a4f8a217433bf8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>|</code> 是管道符，其左右两边是两个进程，数据通过管道共享。</p><p>ls 原本会输出到 <code>stdout（默认是终端）</code>，</p><p>然而用了管道之后，ls将数据写到<code>管道写入端</code>（重定向stdout）。</p><p>wc原本会从<code>stdin（默认是终端）</code>读取数据，</p><p>然而用了管道之后，wc从<code>管道读取端</code>读取数据（重定向stdin）。</p><h4 id="8-1-管道的特点-（包括匿名和有名）"><a href="#8-1-管道的特点-（包括匿名和有名）" class="headerlink" title="8.1 管道的特点 （包括匿名和有名）"></a>8.1 管道的特点 （包括匿名和有名）</h4><p><img src="https://img-blog.csdnimg.cn/b91924fda7ca4dfb97531381e4f73f2f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>匿名管道用在有关系的进程间：父子进程</p><p>有名管道用在没有关系的进程间</p><p>消息：在网络通信中有许多协议，规定好了，发送一次数据会有个协议头，协议头大小固定，后面放传输的数据。另一个进程拿到消息后，可以按照格式解析内容。</p><p>但是管道没有消息的概念，里面都是字节流。可以从管道里想读多少读多少。</p><p><img src="https://img-blog.csdnimg.cn/ceaf516a11e44f9f9bf375f159b902ec.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="`抽象`"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>单工：遥控器发送数据给电视机，但是电视机不能发送消息给遥控器。</p><p>双工：打电话双方都可以互相发送消息。</p><p>半双工：同一时间数据只能向一方流动（对讲机，一个人说的时候另一个人只能听）。同一时间，只能一个进程给另一个进程发送数据。因此，管道中数据的流动是单向的，但是可以双向传输。</p><h4 id="8-2-为什么管道只能用于有关系的进程呢？"><a href="#8-2-为什么管道只能用于有关系的进程呢？" class="headerlink" title="8.2 为什么管道只能用于有关系的进程呢？"></a>8.2 为什么管道只能用于<code>有关系的进程</code>呢？</h4><p>本质上是因为父子进程<code>共享文件描述符</code>。</p><p><img src="https://img-blog.csdnimg.cn/7741df407f6d4af9ac43dc41cb09639f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="管道的数据结构"><a href="#管道的数据结构" class="headerlink" title="管道的数据结构"></a>管道的数据结构</h5><p><img src="https://img-blog.csdnimg.cn/706dc2a0eb7f4506b5dbfbcb86110ce9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>逻辑手段将线性队列设计成了环形队列，充分利用资源，避免浪费。</p><p>数据只能读取一次，并且之后会被覆盖。</p><h4 id="8-3-匿名管道的使用"><a href="#8-3-匿名管道的使用" class="headerlink" title="8.3 匿名管道的使用"></a>8.3 匿名管道的使用</h4><p><img src="https://img-blog.csdnimg.cn/c28b7716206d42aa81729dbf4d7c4adf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       pipe <span class="token operator">-</span> create pipeSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token comment">/* On Alpha, IA-64, MIPS, SuperH, and SPARC/SPARC64; see NOTES */</span>       <span class="token keyword">struct</span> <span class="token class-name">fd_pair</span> <span class="token punctuation">{</span>           <span class="token keyword">long</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span><span class="token punctuation">;</span>       <span class="token keyword">struct</span> <span class="token class-name">fd_pair</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">/* On all other architectures */</span>       <span class="token keyword">int</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> creates a pipe<span class="token punctuation">,</span> a unidirectional data channel that can be used <span class="token keyword">for</span> 【interprocess communication】<span class="token punctuation">.</span>         The array pipefd is used to 【<span class="token keyword">return</span> two file descriptors】 referring to the ends of the pipe<span class="token punctuation">.</span>         pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> refers to the 【read end】 of the pipe<span class="token punctuation">.</span>         pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> refers to the 【write end】 of the pipe<span class="token punctuation">.</span>          <span class="token function">Data</span> <span class="token punctuation">(</span>written to the write end of the pipe<span class="token punctuation">)</span> is buffered by the <span class="token function">kernel</span> <span class="token punctuation">(</span>until it is read from the read end of the pipe<span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token comment">// 这里是在说，写到管道的【写入端】的数据会被加载到缓冲区（管道实质上就是一个缓冲），直到它被一个进程从【读取端】读取。</span>    ETURN VALUE       On success<span class="token punctuation">,</span> 【zero】 is returned<span class="token punctuation">.</span>         On error<span class="token punctuation">,</span> 【<span class="token operator">-</span><span class="token number">1</span>】 is returned<span class="token punctuation">,</span> errno is set appropriately<span class="token punctuation">,</span> and pipefd is left unchanged<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="8-4-pipe"><a href="#8-4-pipe" class="headerlink" title="8.4 pipe()"></a>8.4 pipe()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参数：</p><ul><li>pipefd 是一个传出参数，我们把这个数组传进去，他会把管道两端的文件描述符传出来<ul><li>pipefd[0] -&gt; 读端</li><li>pipefd[1] -&gt; 写端</li></ul></li></ul><p>返回值：</p><ul><li>成功：返回0</li><li>失败： 返回 -1， 并设置 errorno</li></ul><p>这里又一次体现了Linux的设计哲学 — 万物皆文件。</p><h5 id="示例代码-3"><a href="#示例代码-3" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token comment">// 子进程给父进程发送数据</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 父进程从管道的【读取端】读取数据</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 爸爸从 pipefd[0] 读取数据</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: \n%s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 父亲回收子进程</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"wait"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 子进程从管道的【写入端】写数据</span>        <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, papa.\n"</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a862a2cac79847549b7e57aa3490a968.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="示例代码（read阻塞）"><a href="#示例代码（read阻塞）" class="headerlink" title="示例代码（read阻塞）"></a>示例代码（read阻塞）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token comment">// 子进程给父进程发送数据</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 父进程从管道的【读取端】读取数据</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 爸爸从 pipefd[0] 读取数据</span>        <span class="token comment">// read是阻塞的，只有等到有数据可读，read才会去读，不然一直呆在那儿</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: \n%s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 父亲回收子进程</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"wait"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 子进程先睡10秒钟</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 子进程从管道的【写入端】写数据</span>        <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, papa.\n"</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a8edc8ca3c224c4db13da3d899c326fc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>管道默认是阻塞的：</p><ul><li>如果管道中没有数据，read阻塞</li><li>如果管道中数据慢了，write阻塞</li></ul><h5 id="示例代码（不断收发数据）"><a href="#示例代码（不断收发数据）" class="headerlink" title="示例代码（不断收发数据）"></a>示例代码（不断收发数据）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token comment">// 子进程给父进程发送数据</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 父进程不断读取数据</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 爸爸从 pipefd[0] 读取数据</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 子进程不断发送数据</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, papa."</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>            <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/bdc56ce6d8874a03960b3023495af475.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="示例代码（父子互相收发消息）"><a href="#示例代码（父子互相收发消息）" class="headerlink" title="示例代码（父子互相收发消息）"></a>示例代码（父子互相收发消息）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 父进程不断读取数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 父进程不断发送数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, child."</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 子进程不断发送数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, papa."</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 子进程不断读取数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child receive: %s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/09f6fd6b7a02442cb7a504eae8fa3574.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>可以看到父子进程在互相发送，接收消息，你一条我一条，由于多线程的程序，管道没有关闭，某个线程可能会读到自己写入的数据，因此会出现child向child问好，parent向parent问好。</p><p>如果把sleep注释到，这个错误会尤为明显。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 父进程不断读取数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 父进程不断发送数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, I'm papa."</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token comment">//sleep(1);</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 子进程不断发送数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, I'm child."</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token comment">//sleep(1);</span>            <span class="token comment">// 子进程不断读取数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child receive: %s, pid=%d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/d5f596d547b84745a6a1175f8068d7b9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>可以看到我们显示的是papa..</p><p>有两个句号</p><p>或者我们再清晰一点</p><p>我们把消息后面改成parent，child，不加英文中的句号</p><p>可以看到变成了childt</p><p><img src="https://img-blog.csdnimg.cn/3cd7f1d6b76b406b91b7eee1499fb11c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这个t是哪里来的呢？答案是我们没有刷新缓冲区，上一次写入的数据被覆盖，但是由于child比较短，后面还残留了老消息。</p><p>读完之后加一句这个就行了人，清除数据。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">bzero</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/db698d53067d4f18ade900f7830c8635.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="示例代码-关闭一端"><a href="#示例代码-关闭一端" class="headerlink" title="示例代码(关闭一端)"></a>示例代码(关闭一端)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 父进程关闭写端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 父进程专心读数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %sn"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 子进程关闭读端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 子进程专心写数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, I'm child\n"</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="8-5-匿名管道通信案例"><a href="#8-5-匿名管道通信案例" class="headerlink" title="8.5 匿名管道通信案例"></a>8.5 匿名管道通信案例</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ps aux | grep # 过滤出来和root有关的进程<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ls | wc -l  # 统计文件个数<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="示例代码（通过重定向文件描述符将ps-aux进程数据写入管道）"><a href="#示例代码（通过重定向文件描述符将ps-aux进程数据写入管道）" class="headerlink" title="示例代码（通过重定向文件描述符将ps aux进程数据写入管道）"></a>示例代码（通过重定向文件描述符将ps aux进程数据写入管道）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token comment">/*    实现 ps aux | grpe    子进程： ps aux，子进程结束后，将数据发送给父进程    父进程：获取数据，打印    pipe(), execlp()    但是子进程默认把数据默认把数据发送到子进程对应的终端，即 std_fileno    因此需要dup2复制文件描述符，将数据重定向到管道的写端*/</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 创建一个匿名管道</span>    <span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 关闭写端</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从管道中读取数据</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 回收子进程资源</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 关闭读端</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 文件描述符重定向 stdout_fileno -&gt; fd[1]，使得ps aux写入管道的写端</span>        <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 执行 ps aux</span>        <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execlp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/1cf0e31c4f3149eea003046cf8a4681e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>可见，我们实现了 ps aux 的功能。</p><p><img src="https://img-blog.csdnimg.cn/07e59462871b405da8a73de004d413cd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>之所以我们写的管道比系统多一个进程，是因为我们的程序正在运行（./app + ps aux），因此比直接执行ps aux多一个进程。</p><h5 id="示例代码（通过重定向文件描述符将ps-aux数据写到普通文件中）"><a href="#示例代码（通过重定向文件描述符将ps-aux数据写到普通文件中）" class="headerlink" title="示例代码（通过重定向文件描述符将ps aux数据写到普通文件中）"></a>示例代码（通过重定向文件描述符将ps aux数据写到普通文件中）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token comment">/*    实现 ps aux | grpe    子进程： ps aux，子进程结束后，将数据发送给父进程    父进程：获取数据，打印    pipe(), execlp()    但是子进程默认把数据默认把数据发送到子进程对应的终端，即 std_fileno    因此需要dup2复制文件描述符，将数据重定向到管道的写端*/</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 创建一个匿名管道</span>    <span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 关闭写端</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从管道中读取数据</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 回收子进程资源</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 关闭读端</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 文件描述符重定向 stdout_fileno -&gt; file</span>        <span class="token keyword">int</span> file <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"psaux.txt"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">dup2</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"if you saw this it might succeed.\n"</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 执行 ps aux</span>        <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"ps"</span><span class="token punctuation">,</span> <span class="token string">"aux"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execlp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/5c41caa5f1504461afa2bb569d1cce49.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/92d60b432eda463da79f1363c6fb4e56.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="8-6-查看管道的缓冲大小"><a href="#8-6-查看管道的缓冲大小" class="headerlink" title="8.6 查看管道的缓冲大小"></a>8.6 查看管道的缓冲大小</h4><p>使用 <code>ulimit -a</code> 可以查看一些系统参数</p><p>其中 <code>pipe size</code> = 8 * 512byte = 4K</p><p>有八个块，每个块512字节</p><p>使用<code>-p</code>可以修改管道的大小</p><p><img src="https://img-blog.csdnimg.cn/9911da304b0e4731900921af96b741cf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_13,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="查看管道大小的函数"><a href="#查看管道大小的函数" class="headerlink" title="查看管道大小的函数"></a>查看管道大小的函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       fpathconf <span class="token operator">-</span> get configuration values <span class="token keyword">for</span> filesSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">long</span> <span class="token function">fpathconf</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">fpathconf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gets a value <span class="token keyword">for</span> the configuration option name <span class="token keyword">for</span> the open file descriptor fd<span class="token punctuation">.</span>    _PC_PIPE_BUF       The  maximum  number of bytes that can be written atomically to a pipe of FIFO<span class="token punctuation">.</span>  For <span class="token function">fpathconf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fd should refer to a pipe or FIFO<span class="token punctuation">.</span>  For <span class="token function">fpathconf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path should refer to a FIFO or a directory<span class="token punctuation">;</span> in the latter <span class="token keyword">case</span><span class="token punctuation">,</span> the returned value corresponds to FIFOs created in that directory<span class="token punctuation">.</span>  The corresponding macro is _POSIX_PIPE_BUF<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获取管道大小</span>    <span class="token keyword">long</span> size <span class="token operator">=</span> <span class="token function">fpathconf</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> _PC_PIPE_BUF<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"the size of pipe buffer: %ld\n"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，我们的管道缓冲区大小为 4096byte，即4K。</p><p><img src="https://img-blog.csdnimg.cn/9942724823064924ace25dcd1717321e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="8-7-管道读写特点-と-管道设置为非阻塞"><a href="#8-7-管道读写特点-と-管道设置为非阻塞" class="headerlink" title="8.7 管道读写特点 と 管道设置为非阻塞"></a>8.7 管道读写特点 と 管道设置为非阻塞</h4><h5 id="管道读写特点"><a href="#管道读写特点" class="headerlink" title="管道读写特点"></a>管道读写特点</h5><ol><li><p>所有指向<code>管道写端</code>的文件描述符都<code>关闭</code>（管道写端引用计数=0），若管道中数据若已被读完，</p><p>有进程从<code>管道读端</code>读数据时，某个进程read会<code>返回0</code>，就像读到文件末尾一样。</p></li><li><p>所有指向<code>管道写端</code>的文件描述符没有关闭（管道写端引用计数&gt;0）,而持有管道写端的进程没有往管道中写数据，若管道中数据若已被读完，某个进程read后会<code>阻塞</code>，直到管道中有数据可以读了才读取数据并返回。</p></li><li><p>所有指向<code>管道读端</code>的文件描述符都<code>关闭</code>（管道读端引用计数=0），若有进程向管道中写数据，</p><p>那么该进程会受到一个<code>信号SIGPIPE</code>，通常导致进程<code>异常终止</code>。</p></li></ol><p>4.所有指向<code>管道读端</code>的文件描述符没有关闭（管道读端引用计数&gt;0）,而持有管道读端的进程没有从管道中读数据，而持有<code>管道写端</code>的进程往管道中写数据，那么在管道写满后再次write会<code>阻塞</code>，直到数据被读出。</p><p>总结：</p><ul><li>read<ul><li>管道中有数据，read返回实际读到的字节数。</li><li>管道中无数据<ul><li>写端被全部关闭，read返回0（相当于读到文件末尾）.</li><li>写端没有全部关闭，但是没人写数据，read<code>阻塞等待</code></li></ul></li></ul></li><li>write<ul><li>读端全部关闭，进程收到信号<code>SIGPIPE</code>，异常终止</li><li>读端没有全部关闭<ul><li>管道已满，write<code>阻塞</code></li><li>管道没满，write写入数据，返回实际写入字节数</li></ul></li></ul></li></ul><h5 id="设置管道非阻塞"><a href="#设置管道非阻塞" class="headerlink" title="设置管道非阻塞"></a>设置管道非阻塞</h5><p>原本<code>子进程</code>写完数据后父进程马上打印，然后<code>子进程</code>sleep五秒后继续写。</p><p>这样的话<code>父进程</code>也要阻塞5秒才能读到下一跳数据并打印。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 父进程关闭写端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 父进程专心读数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 子进程关闭读端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 子进程专心写数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, I'm child\n"</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/bc7f5a6ab8994e04986ae647965c9407.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>但是我们可以利用<code>fcntl</code>函数设置</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> File status flags       Each  open file description has certain associated 【status flags】<span class="token punctuation">,</span> 【initialized by <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>】 and possibly 【modified by <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>】<span class="token punctuation">.</span>  Duplicated file <span class="token function">descriptors</span> <span class="token punctuation">(</span>made with <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>F_DUPFD<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> etc<span class="token punctuation">.</span><span class="token punctuation">)</span> refer to the same open file description<span class="token punctuation">,</span> and thus share the same file status flags<span class="token punctuation">.</span>       The file status flags and their semantics are described in <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token function">F_GETFL</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>              <span class="token function">Return</span> <span class="token punctuation">(</span>as the function result<span class="token punctuation">)</span> the file access mode and the file status flags<span class="token punctuation">;</span> arg is ignored<span class="token punctuation">.</span>       <span class="token function">F_SETFL</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>              Set  the file status flags to the value specified by arg<span class="token punctuation">.</span>  File access <span class="token function">mode</span> <span class="token punctuation">(</span>O_RDONLY<span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span> and file creation <span class="token function">flags</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> O_CREAT<span class="token punctuation">,</span> O_EXCL<span class="token punctuation">,</span> O_NOCTTY<span class="token punctuation">,</span> O_TRUNC<span class="token punctuation">)</span> in arg are ignored<span class="token punctuation">.</span>  On Linux<span class="token punctuation">,</span> this command can change only the O_APPEND<span class="token punctuation">,</span> O_ASYNC<span class="token punctuation">,</span> O_DIRECT<span class="token punctuation">,</span> O_NOATIME<span class="token punctuation">,</span> and 【O_NONBLOCK flags】<span class="token punctuation">.</span>  It is not possible to change the O_DSYNC and O_SYNC flags<span class="token punctuation">;</span> see BUGS<span class="token punctuation">,</span> below<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="设置flag"><a href="#设置flag" class="headerlink" title="设置flag"></a>设置flag</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>flags <span class="token operator">|=</span> O_NONBLOCK<span class="token punctuation">;</span><span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="示例代码-4"><a href="#示例代码-4" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 需要在 fork 之前创建管道，这样两个进程才会共享文件描述符</span>    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 传出参数</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm parent pid=%d. I'm going to read sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 父进程关闭写端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>        flags <span class="token operator">|=</span> O_NONBLOCK<span class="token punctuation">;</span>        <span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 父进程专心读数据</span>            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"len = %d\n"</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent receive: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I'm child pid=%d. I'm going to send sth to my papa through a pipe.\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 子进程关闭读端</span>        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 子进程专心写数据</span>            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, I'm child"</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 儿子把数据写道pipefd[1]</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在父进程中设置为非阻塞后就可以看到打印如一泓海水杯中泄。</p><p><img src="https://img-blog.csdnimg.cn/90c6ad09efcb48a58dbb9bb3e34b0c24.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>可以看到，在阻塞等待时，父进程读到了17个字节，因此打印17</p><p>然后非阻塞等待时，绝大多时间都没读到数据，因此打印-1</p><ul><li>读到数据</li></ul><p><img src="https://img-blog.csdnimg.cn/31c0a7ab78de464dba5412ccc6b19333.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><ul><li>没读到数据</li><li><img src="https://img-blog.csdnimg.cn/615d0d7881884133bc0d95f1549f1bbd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></li></ul><p>让父进程睡一会儿可以看出来区别</p><p><img src="https://img-blog.csdnimg.cn/f826ec18c1a14c3696be50972a55913c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_16,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h2 id="9-通信方式二：有名管道"><a href="#9-通信方式二：有名管道" class="headerlink" title="9. 通信方式二：有名管道"></a>9. 通信方式二：有名管道</h2><p><img src="https://img-blog.csdnimg.cn/dd0cbb48df5e4d83b0f9050b63eff524.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/3440915b43034384b23c15127246bcab.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>FIFO有文件实体，但是里面没有内容，内容存放在内核中的缓冲区。</p><p>匿名管道没有实体，没有名字，只能用于有关系的进程间通信。</p><p><img src="https://img-blog.csdnimg.cn/2fdccd68910f4d0da347cdaf05338b7c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="9-1-创建fifo"><a href="#9-1-创建fifo" class="headerlink" title="9.1 创建fifo"></a>9.1 创建fifo</h4><h5 id="方式一：-shell命令"><a href="#方式一：-shell命令" class="headerlink" title="方式一： shell命令"></a>方式一： shell命令</h5><p><img src="https://img-blog.csdnimg.cn/322109072c6d4417a15d3499ff6fb7d9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>在终端输入 <code>mkfifo 文件名</code></p><p><img src="https://img-blog.csdnimg.cn/80fa4d69337d4a2a9e4caaef614277d1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>当我们想往里面写点东西，会发现阻塞了。</p><p><img src="https://img-blog.csdnimg.cn/7be3b259863a4df192666a4578f32cbd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==">这个文件里是空的，因为都保存在内核中的缓冲区中。</p><p>进程一旦结束，数据全部清空。</p><h5 id="方式二：-函数"><a href="#方式二：-函数" class="headerlink" title="方式二： 函数"></a>方式二： 函数</h5><p><img src="https://img-blog.csdnimg.cn/ad04db3e653d414c8e45dc63c980fe01.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">DESCRIPTION       <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  makes  a FIFO special file with name pathname<span class="token punctuation">.</span>  mode specifies the FIFO's permissions<span class="token punctuation">.</span>  It is modified by the process's umask in the usual way<span class="token operator">:</span> the permissions of the created file <span class="token function">are</span> <span class="token punctuation">(</span>【mode <span class="token operator">&amp;</span> <span class="token operator">~</span>umask】<span class="token punctuation">)</span><span class="token punctuation">.</span>       A FIFO special file is similar to a pipe<span class="token punctuation">,</span> except that it is created in a different way<span class="token punctuation">.</span>  Instead of being an anonymous communications channel<span class="token punctuation">,</span> a FIFO special file is entered into the filesystem by calling <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       Once  you have created a FIFO special file in this way<span class="token punctuation">,</span> any process can open it <span class="token keyword">for</span> reading or writing<span class="token punctuation">,</span> in the same way as an ordinary file<span class="token punctuation">.</span>  However<span class="token punctuation">,</span> it has to be open at both ends simultaneously before you can proceed to <span class="token keyword">do</span> any input or output  operationson it<span class="token punctuation">.</span>  Opening a FIFO <span class="token keyword">for</span> reading normally blocks until some other process opens the same FIFO <span class="token keyword">for</span> writing<span class="token punctuation">,</span> and vice versa<span class="token punctuation">.</span>  See <span class="token function">fifo</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">for</span> nonblocking handling of FIFO special files<span class="token punctuation">.</span>           RETURN VALUE       On  success  <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  and  <span class="token function">mkfifoat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token number">0.</span>  In the <span class="token keyword">case</span> of an error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is <span class="token function">returned</span> <span class="token punctuation">(</span>in which <span class="token keyword">case</span><span class="token punctuation">,</span> errno is set appropriately<span class="token punctuation">)</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数：</p><ul><li>pathname：文件路径</li><li>mode：文件权限，和open中的一样，会和掩码做按位与</li></ul><h5 id="示例代码-5"><a href="#示例代码-5" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span><span class="token comment">// access</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 先判断管道文件是否存在，若不存在，创建</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道不存在，正在为您创建...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道已存在\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="9-2-通信案例"><a href="#9-2-通信案例" class="headerlink" title="9.2 通信案例"></a>9.2 通信案例</h4><h5 id="写端代码"><a href="#写端代码" class="headerlink" title="写端代码"></a>写端代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 先判断管道文件是否存在，若不存在，创建</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"管道不存在，正在为您创建...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 2. 创建管道</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3.打开管道, 以 write-only 的权限打开</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 4.写数据</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"hello, %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write data: %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="读端代码"><a href="#读端代码" class="headerlink" title="读端代码"></a>读端代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1.直接打开管道</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>       <span class="token punctuation">{</span>           <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>       <span class="token comment">// 2.读数据</span>       <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>       <span class="token punctuation">{</span>           <span class="token comment">// read返回读到的字节数</span>           <span class="token comment">// read失败返回 -1</span>           <span class="token comment">// 写端关闭，管道中数据读完，返回0</span>           <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写端断开连接\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"receive buf: %d\n"</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>只运行write 或者 read，他们都会阻塞，因为另一端没有打开。</p><p>两端都打开，进程间开始通信。</p><p><img src="https://img-blog.csdnimg.cn/49b8002fe9734282bdb298d4b324c3aa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>提前结束写端</code>，读端会读取到0个字节，我们的 if 判断了读到 0byte 就 exit。</p><p><img src="https://img-blog.csdnimg.cn/2a888cc3963c4ded84fcc855cbaf02b1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>而<code>提前结束读端</code>，会导致读端进程收到一个异常信号<code>SIGPIPE</code>,直接终止进程，否则有可能导致管道破裂。</p><p><img src="https://img-blog.csdnimg.cn/5d9f244162504da7b211d9e659a9f776.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="9-3-有名管道注意事项"><a href="#9-3-有名管道注意事项" class="headerlink" title="9.3 有名管道注意事项"></a>9.3 有名管道注意事项</h4><ol><li>只有一个进程通过 <code>read-only</code> 打开管道会<code>阻塞</code>，直到另一个进程以 write-only或read&amp;rwite 打开管道</li><li>只有一个进程通过 <code>write-only</code> 打开管道会<code>阻塞</code>，直到灵魂一个进程以 <code>read-only</code> 打开管道</li></ol><h4 id="9-4-简易版聊天功能"><a href="#9-4-简易版聊天功能" class="headerlink" title="9.4 简易版聊天功能"></a>9.4 简易版聊天功能</h4><p>阻塞行为，只能发一条收一条。</p><p><strong>A</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1.创建管道</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2.以 write-only 的权限打开管道pipeAtoB</span>    <span class="token keyword">int</span> fdw <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB is opened, right: write-only,pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.以 read-only 的权限打开管道pipeBtoA</span>    <span class="token keyword">int</span> fdr <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA is opened, right: read-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.开始通信</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 写数据</span>        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fdw<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 读数据</span>        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fdr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">// 读取失败/对面关闭管道/数据读完/读取失败</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 关闭文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdw<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>B</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1.创建管道</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2.以 read-only 的权限打开管道pipeAtoB</span>    <span class="token keyword">int</span> fdr <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB is opened, right: read-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.以 write-only 的权限打开管道pipeBtoA</span>    <span class="token keyword">int</span> fdw <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA is opened, right: write-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.开始通信</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 读数据</span>        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fdr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">// 读取失败/对面关闭管道/数据读完/读取失败</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 写数据</span>        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fdw<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 关闭文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdw<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/00861d7306bd486b93971bf43f2897b2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>非阻塞行为，利用父子进程实现并发。</p><h5 id="A"><a href="#A" class="headerlink" title="A"></a><strong>A</strong></h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1.创建管道</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2.以 write-only 的权限打开管道pipeAtoB</span>    <span class="token keyword">int</span> fdw <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB is opened, right: write-only,pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.以 read-only 的权限打开管道pipeBtoA</span>    <span class="token keyword">int</span> fdr <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA is opened, right: read-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.开始通信</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 写数据</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fdw<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 读数据</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fdr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">// 读取失败/对面关闭管道/数据读完/读取失败</span>            <span class="token punctuation">{</span>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"对方来信：%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 关闭文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdw<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>B</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1.创建管道</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA not exist, making...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkpipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2.以 read-only 的权限打开管道pipeAtoB</span>    <span class="token keyword">int</span> fdr <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeAtoB is opened, right: read-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.以 write-only 的权限打开管道pipeBtoA</span>    <span class="token keyword">int</span> fdw <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdw <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pipeBtoA is opened, right: write-only, pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.开始通信</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>             <span class="token comment">// 读数据</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fdr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment">// 读取失败/对面关闭管道/数据读完/读取失败</span>            <span class="token punctuation">{</span>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"对方来信：%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment">// 写数据</span>            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fdw<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">// 5. 关闭文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdw<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/0aca5f32506d4e8d99759a8aee8e04af.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>大体可以运行，但是在键入文字的时候，若删除一些会有BUG，如删除不全和多删除一些文字等。</p><h2 id="10-通信方式三：内存映射"><a href="#10-通信方式三：内存映射" class="headerlink" title="10. 通信方式三：内存映射"></a>10. 通信方式三：内存映射</h2><p><img src="https://img-blog.csdnimg.cn/644f97952a264097958cfb831c67d28a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>效率较高，直接操作内存。</p><p>会将磁盘上的文件内容映射到<code>动态库加载的区域</code>。</p><p>内存里保存着磁盘上文件里的数据，可以设置映射哪一部分。</p><p>一旦修改了内存中的数据，修改内容会自动同步到文件中。</p><p>两个进程访问同一块内存，这块内存指向磁盘中的一片空间，这两个进程都可以访问这个文件中的数据。</p><p>可以实现父子进程间的通信，也可以实现无关系的进程间的通信。</p><h4 id="10-1-内存映射相关system-call"><a href="#10-1-内存映射相关system-call" class="headerlink" title="10.1 内存映射相关system call"></a>10.1 内存映射相关system call</h4><p><img src="https://img-blog.csdnimg.cn/42e85c5c0519448c9fad416c26f7a2f9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="10-2-mmap"><a href="#10-2-mmap" class="headerlink" title="10.2 mmap"></a>10.2 mmap</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>mmap</code>将统一个文件或设备的数据映射到当前正在运行的进程中。</p><p>参数：</p><ul><li><code>addr</code>指定新映射的<code>起始地址</code>，指定<code>NULL</code>则由内核来分配起始地址。</li><li><code>length</code>指定新映射的数据的长度（must &gt; 0）。建议使用文件的长度，但是最少会分配页的整数倍。<ul><li>获取文件长度： stat，lseek</li></ul></li><li><code>prot</code>：申请的内存映射区的操作权限（不能和打开的文件的权限冲突）。</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">PROT_EXEC  Pages may be executed<span class="token punctuation">.</span>    PROT_READ  Pages may be read<span class="token punctuation">.</span>    PROT_WRITE Pages may be written<span class="token punctuation">.</span>    PROT_NONE  Pages may not be accessed<span class="token punctuation">.</span>一般使用读权限 PROT_READ 或读写权限 PROT_READ <span class="token operator">|</span> PROT_WRITE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>flags</code>：一个进程更新该映射内存后，何时被其他进程（同样访问这块映射）可见。</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">MAP_SHARED    映射区的数据会自动和磁盘文件同步。进程间通信时必须设置这个选项。MAP_PRIVATE不同步，内存映射区的数据改变了，不会影响磁盘文件，会重新创建一个新的文件，修改新的文件。和fork写时复制很像。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>fd</code>：要映射的文件的文件描述符，通过open的得到，文件大小必须大于0。open指定的权限不能和prot参数冲突。prot的权限 &lt;= open的权限<ul><li>prot: PROT_READ        open: read-only / read&amp;write</li><li>prot: PROT_READ | PROT_WRITE        open: read&amp;write</li></ul></li><li><code>offset</code>：偏移量，必须是4K的整数倍。0表示不偏移，即从文件的开头。</li></ul><p>返回值：</p><ul><li>新内存的起始地址<ul><li>调用成功，返回指向映射区域的指针</li><li>调用失败，返回一个宏<code>MAP_FAILED</code>，即<code>(VOID *)-1</code></li></ul></li></ul><h4 id="munmap"><a href="#munmap" class="headerlink" title="munmap"></a>munmap</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>释放内存映射</p><p>参数：</p><ul><li><code>addr</code>：要释放的内存首地址</li><li><code>length</code>：要释放的内存大小，要和<code>mmap</code>中的<code>length</code>参数保持一致</li></ul><h5 id="如何使用内存映射进行进程间通信？"><a href="#如何使用内存映射进行进程间通信？" class="headerlink" title="如何使用内存映射进行进程间通信？"></a>如何使用内存映射进行进程间通信？</h5><ul><li>有关系的进程<ul><li>准备一个大小不为0的内存映射区</li><li>唯一的最大父进程通过磁盘文件创建内存映射区</li><li>有了内存映射区后，fork子进程</li><li>父子进程共享内存映射区</li></ul></li><li>没有关系的进程<ul><li>准备一个大小不为0的磁盘文件</li><li>进程1通过磁盘文件创建内存映射区，得到一个指针</li><li>进程2通过磁盘文件创建内存映射区，得到一个指针</li><li>使用内存映射区通信</li></ul></li></ul><p>内存映射区是默认<code>非阻塞</code>的！</p><p>记得做映射的磁盘文件一定不能为空!!!</p><h5 id="示例代码-6"><a href="#示例代码-6" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 打开一个磁盘文件</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"share.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 获取文件大小</span>    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// fd, offset, where</span>    <span class="token comment">// 3. 创建内存映射区</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 4. 创建子进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 读取内存</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 操作内存</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">,</span> <span class="token string">"hello, papa!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 关闭内存映射区</span>    <span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是我在一个字符数组中写数据，把这个字符数组传给strcpy，好像又出现问题了，不知道为什么</p><h4 id="10-4-内存映射的注意事项"><a href="#10-4-内存映射的注意事项" class="headerlink" title="10.4 内存映射的注意事项"></a>10.4 内存映射的注意事项</h4><p><img src="https://img-blog.csdnimg.cn/9e38468c9f10413c9f8ef8ee3db5c025.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><ol><li><p>如果对映射到的这块内存做 ptr ++ 操作，可以是可以，但是释放的时候要传入内存的长度，可能导致问题。要么保存最原始的地址，释放这块内存。</p></li><li><p>如果文件只是 read-only，我们在内存映射的时候确实 read + write，访问会被拒绝。因此，PROT权限 &lt;= open权限</p></li></ol><p><img src="https://img-blog.csdnimg.cn/54839c3878294d1c93966e7aa8f6581a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><ol start="3"><li><p>偏移量必须是<code>4K</code>的整数倍?<img src="https://img-blog.csdnimg.cn/896f46e3e02d4be9bcbb2023d53f950d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p></li><li><p>我们映射的内存大小为0，也会失败。</p><p><img src="https://img-blog.csdnimg.cn/878c8dcec8b64fc5b4d3f8957c4b9310.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p></li><li><p>可以通过O_CREAT来新建一个文件，但是大小不能为0</p><p>这样子直接创建大小其实是0</p><p><img src="https://img-blog.csdnimg.cn/902725a9e4f84f5e835ad18ef3adcccc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p></li></ol><p><img src="https://img-blog.csdnimg.cn/b8ee0b0c600c47fc8b4471e525ab8979.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>我们可以用<code>lseek</code>或者<code>truncate</code>函数来拓展文件长度。</p><p><img src="https://img-blog.csdnimg.cn/6f1b392675ab4e0982c15d2ffb2a55db.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_15,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/90e9d42d616747e9837cc5cf670bbab4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>但是这样还是失败了，我们需要执行一次写操作才能真正拓展长度。</p><p><img src="https://img-blog.csdnimg.cn/e76ee680ff1e4e13976f5c3c75cdfe49.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/98542b65f4e640648400ffbc4ec32718.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>999 = 998 + 1</p><ol start="6"><li><p>我们映射完就关闭文件描述符，并不会产生任何影响。</p><p>因为这块内存映射区仍然存在，munmap后才会消失。</p></li></ol><p><img src="https://img-blog.csdnimg.cn/352dedfe16aa4cf4bb679c124a2799df.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><ol start="7"><li>void *ptr = mmap(NULL, 4k整数倍….)，如果越界访问ptr, 会操作野内存，造成段错误。</li></ol><h5 id="10-5-内存映射实现文件拷贝"><a href="#10-5-内存映射实现文件拷贝" class="headerlink" title="10.5 内存映射实现文件拷贝"></a>10.5 内存映射实现文件拷贝</h5><h5 id="示例代码-7"><a href="#示例代码-7" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 打开源文件</span>    <span class="token keyword">int</span> fdSrc <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"src.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdSrc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open_src"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 获取源文件大小</span>    <span class="token keyword">int</span> srcSize <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fdSrc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>srcSize <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"lseek"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 创建新文件</span>    <span class="token keyword">int</span> fdDest <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"dest.txt"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fdDest <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open_dest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3. 扩展新文件</span>    <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token string">"dest.txt"</span><span class="token punctuation">,</span> srcSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>fdDest<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 分别做内存映射</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptrSrc <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> srcSize <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fdSrc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ptrSrc <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap_src"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptrDest <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> srcSize <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fdDest<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ptrDest <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap_dest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">// 5. 内存拷贝</span>    <span class="token comment">/*    这个不是内存拷贝，这个是文件IO里学的文件拷贝    char buf[1024] = {0};    int len = 0;    while(len = (read(fdSrc, buf, sizeof(buf))) &gt; 0)        write(fdDest, buf, len);    */</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>ptrDest<span class="token punctuation">,</span> ptrSrc<span class="token punctuation">,</span> srcSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 6. 释放资源</span>    <span class="token function">munmap</span><span class="token punctuation">(</span>ptrSrc<span class="token punctuation">,</span> srcSize <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">munmap</span><span class="token punctuation">(</span>ptrDest<span class="token punctuation">,</span> srcSize <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdDest<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fdSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 由于依赖关系也要注意先后释放顺序，虽然我没听懂</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>虽然内存映射可以用来做文件拷贝，但一般不这么干。</p><p>假如文件有1个G，内存根本就放不下啊。</p><p><img src="https://img-blog.csdnimg.cn/254ec5483efd450782fa0e20ee09c1cf.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/2b2bb991c07643f481a0aab82c08d0f2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/9779c2c3262d438881652ce29636f76f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="10-6-匿名映射"><a href="#10-6-匿名映射" class="headerlink" title="10.6 匿名映射"></a>10.6 匿名映射</h5><p>只能用于有关系的父子间通信。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">MAP_ANONYMOUSThe  mapping is not backed by any file<span class="token punctuation">;</span> its contents are initialized to zero<span class="token punctuation">.</span>  The 【fd argument is ignored】<span class="token punctuation">;</span> however<span class="token punctuation">,</span> some implementations require fd to be 【<span class="token operator">-</span><span class="token number">1</span>】 <span class="token keyword">if</span> <span class="token function">MAP_ANONYMOUS</span> <span class="token punctuation">(</span>or MAP_ANON<span class="token punctuation">)</span> is specified<span class="token punctuation">,</span> and portable applications should ensure this<span class="token punctuation">.</span>  The 【offset】 argument should be 【zero】<span class="token punctuation">.</span>  The use of MAP_ANONYMOUS in 【conjunction with MAP_SHARED】 is supported on Linux only since kernel <span class="token number">2.4</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="示例代码-8"><a href="#示例代码-8" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建匿名内存映射区</span>    <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> PROT_WRITE <span class="token operator">|</span> PROT_READ<span class="token punctuation">,</span> MAP_SHARED <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// fd:-1, offset:0</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 父子间碱性通信</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">,</span> <span class="token string">"hello, son!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 内存映射是非阻塞的，因此子进程要在父进程结束后执行</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"son received: %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"munmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a8dcf10c4c7c4fc5b22641b80ff84163.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>呃，父进程给子进程发消息的话，直接共享变量不就好了么？</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建匿名内存映射区</span>    <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> PROT_WRITE <span class="token operator">|</span> PROT_READ<span class="token punctuation">,</span> MAP_SHARED <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// fd:-1, offset:0</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 父子间间通信</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">,</span> <span class="token string">"hello, son!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 内存映射是非阻塞的，因此子进程要在父进程结束后执行</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"son received: %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"munmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/d5386600f52046c29a89539530c6fd6c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h2 id="9-信号"><a href="#9-信号" class="headerlink" title="9. 信号"></a>9. 信号</h2><h4 id="9-0-信号概述"><a href="#9-0-信号概述" class="headerlink" title="9.0 信号概述"></a>9.0 信号概述</h4><p>Linux操作系统刚诞生的时候就有信号这个机制了。</p><p>主要作用：通知进程发生了某些事情。</p><p>中断</p><ul><li><p>硬件中断</p></li><li><p>软件中断</p></li></ul><p>在家里打游戏的时候，外卖来了会给你打个电话，这就是个信号。</p><p>于是你暂停游戏，去拿外卖。</p><p>同步：一个患者一个一个进去看医生（隐私可以得到保障）</p><p>异步：好几个人同时进去找医生（杜博士windows课里面讲的游戏循环SEEKMESSAGE也是实现了异步，并不是傻傻地等着消息过来，而是不管有没有消息都立即返回，去做一些别的事情，使得游戏效果相较于GETMESSAGE看起来不卡）</p><p>发往进程的内核由内核产生。</p><p>前台进程：占用终端，我们无法再输入命令。我们的 ctrl + c 就是发送了一个中断信号。</p><p>后台进程：再后台运行，再命令行中仍然可以输入命令，执行命令。</p><p>发送信号的几种方式：</p><ul><li>前台键盘事件，如 CTRL + C</li><li>硬件异常，如执行异常指令（除以0， 访问非法内存）</li><li>系统状态变化（定时器到期，CPU执行超限，子进程结束发送SIGCHILD）</li><li>用户执行系统调用</li></ul><p>信号虽然使用简单，但是内部实现非常负责，得去看Linux源代码。</p><p><img src="https://img-blog.csdnimg.cn/9480e135fd9b4af68740cae85dedcfff.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/9e98f0b325ac4f98bb7331e94d2ec5c6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/3391d17f47ab4bd1b5c40dcc34e231e5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="信号一览"><a href="#信号一览" class="headerlink" title="信号一览"></a>信号一览</h5><p>执行 <code>kill -l</code> 可以查看所有的信号。</p><p>共62个信号。</p><p>1-31是常规信号，每个操作系统都有的，MAC操作系统也有；</p><p>32.33没有这俩信号。</p><p>34-64是预定义号的信号，目前没有使用，将来可能使用（用不到）。</p><p><img src="https://img-blog.csdnimg.cn/102998f2e0aa4f0686103e45d008857d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/107ee6a6e6a9490fa0b5d820a8cc783f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/62d840a8bb0741f69a6af53e59ac76b7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="/2022/04/12/Linux%E5%A4%9A%E8%BF%9B%E7%A8%8B/Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220419214722081.png" alt="image-20220419214722081"></p><p><img src="https://img-blog.csdnimg.cn/80107cebde70426bb328f8a8c21a9c37.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>不同的架构信号的定义还不一样。</p><p><img src="https://img-blog.csdnimg.cn/1e7e381c239c4110ad155732bd3c0482.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="信号默认行为"><a href="#信号默认行为" class="headerlink" title="信号默认行为"></a>信号默认行为</h5><p><img src="https://img-blog.csdnimg.cn/5c151174aba44802a4236617f550d6d6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><code>父进程</code>接收到<code>SIGCHILD</code>（子进程结束，暂停等），父进程<code>默认忽略</code>IGN。</p><p>Core文件是为了去<code>调试程序</code>。</p><p>The signals <code>SIGKILL</code> and <code>SIGSTOP</code> cannot be caught, blocked, or ignored.</p><h5 id="进程状态"><a href="#进程状态" class="headerlink" title="进程状态"></a>进程状态</h5><ul><li>产生</li><li>未决：信号没有到达进程，还没有处理</li><li>递达：送达进程</li></ul><h4 id="9-1-kill-とraise-と-abort函数"><a href="#9-1-kill-とraise-と-abort函数" class="headerlink" title="9.1. kill とraise と abort函数"></a>9.1. kill とraise と abort函数</h4><h5 id="kill-1"><a href="#kill-1" class="headerlink" title="kill"></a>kill</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">kill</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>作用：send any signal to any process group or process</p><p>​            给任何进程，任何进程组发送任何信号</p><p>参数：</p><ul><li>pid <ul><li>pid &gt; 0：把信号发送给进程号为pid的进程</li><li>pid = 0：把信号发送给该 calling process 的进程组中的所有进程</li><li>pid = -1：把信号发给所有该进程有权限发送信号的进程，process 1 ( init ) 除外</li><li>pid &lt; -1：发送给进程组 gid = -pid 的所有进程</li></ul></li><li>sig：0表示不发送任何信号。可以是数值也可以是宏值。</li></ul><p>杀死父亲： <code>kill (getppid(), 9);</code></p><p>杀死自己： <code>kill (geipid(), 9);</code></p><h5 id="raise"><a href="#raise" class="headerlink" title="raise"></a>raise</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">raise</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>作用：给自己发送一个信号</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">The <span class="token function">raise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function sends a signal to the 【calling process or thread】<span class="token punctuation">.</span>      In a 【single<span class="token operator">-</span>threaded program】 it is equivalent to<span class="token function">kill</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>In a 【multithreaded program】 it is equivalent to<span class="token function">pthread_kill</span><span class="token punctuation">(</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>If the signal causes a handler to be called<span class="token punctuation">,</span> <span class="token function">raise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> will <span class="token keyword">return</span> only after the signal handler has returned<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="abort"><a href="#abort" class="headerlink" title="abort"></a>abort</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">void</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>作用：发送<code>SIGABORT</code>给当前进程，杀死自己。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">The <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function first unblocks the SIGABRT signal<span class="token punctuation">,</span> and then raises that signal <span class="token keyword">for</span> the calling <span class="token function">process</span> <span class="token punctuation">(</span>as though <span class="token function">raise</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> was called<span class="token punctuation">)</span><span class="token punctuation">.</span>  This results in the abnormal termination of the process unless the SIGABRT signal is caught and the signal handler does not <span class="token keyword">return</span> <span class="token punctuation">(</span>see <span class="token function">longjmp</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>If the SIGABRT signal is ignored<span class="token punctuation">,</span> or caught by a handler that returns<span class="token punctuation">,</span> the <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function will still terminate the process<span class="token punctuation">.</span>  It does this by restoring the <span class="token keyword">default</span> disposition <span class="token keyword">for</span> SIGABRT and then raising the signal <span class="token keyword">for</span> a second time<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>相当于 <code>kill (getpid(), SIGABRT)</code>。 </p><h5 id="示例代码-9"><a href="#示例代码-9" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">```#### <span class="token number">9.2</span> alarm 函数系统状态变化时，如`alarm定时器到期`会因此`SIGALARM`信号。该函数`不阻塞`。```c<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c">DESCRIPTION<span class="token function">alarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> arranges <span class="token keyword">for</span> a SIGALRM signal to be delivered to the calling process in seconds seconds<span class="token punctuation">.</span>If seconds is zero<span class="token punctuation">,</span> any pending alarm is canceled<span class="token punctuation">.</span>In any event any 【previously】 set <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is 【canceled】<span class="token punctuation">.</span>        # 前面设置的alarm都会失效    RETURN VALUE       <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  returns  the  number of seconds remaining until any previously scheduled alarm was due to be delivered<span class="token punctuation">,</span>    or 【zero】 <span class="token keyword">if</span> there was no previously scheduled alarm<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：set an alarm clock for delivery of a signal</p><p>​            设置定时器（闹钟，定时炸弹）。调用后开始倒计时，当倒计时为0时，函数给当前进程发送一个信号SIGALARM。</p><p>参数：</p><ul><li>seconds：倒计时的时长，单位：秒。<ul><li>seconds = 0：定时器无效，不进行倒计时。或者取消一个定时器，通过<code>alarm(0)</code>。</li></ul></li></ul><p>返回值：</p><ul><li>前面有定时器，返回之前的定时器剩余的倒计时时间</li><li>前面没有定时器，返回 0</li></ul><p><code>SIGALARM</code>：默认终止当前进程，每个进程都<code>有且只有</code>唯一的一个定时器。</p><p>alarm(10)；</p><p>after 1 second</p><p>alarm(5);    上面那个10秒的定时器会失效</p><h5 id="示例代码-10"><a href="#示例代码-10" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> seconds <span class="token operator">=</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"seconds = %d\n"</span><span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 2</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    seconds <span class="token operator">=</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不阻塞</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"seconds = %d\n"</span><span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>刚开始打印0，因为是第一次设置时钟。</p><p>第二次马上打印3，由于我们第一次设置了5s，睡了2s，因此第二次设置闹钟返回5-2=3。这是阻塞的。</p><p>这个死循环也不会一直循环，因为倒计时结束后<code>alarm</code>定时结束后会发送<code>SIGALRM</code>信号，于是就结束了这个进程。</p><p><img src="https://img-blog.csdnimg.cn/1bd63075398043ac8aa236c2fa5124d1.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="1秒中之内服务器能执行多少次"><a href="#1秒中之内服务器能执行多少次" class="headerlink" title="1秒中之内服务器能执行多少次"></a>1秒中之内服务器能执行多少次</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> cnt <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们终端也有缓冲区，往终端输出也需要时间，因此看起来打印了不止1s。因为涉及IO操作。</p><p><img src="https://img-blog.csdnimg.cn/89b1c244d75f409e9fe4c741046a40db.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>我们可以把它的输出重定向到一个文件里面。</p><p>可见，计算了 <code>10^8</code> 次左右。</p><p><img src="https://img-blog.csdnimg.cn/a71f03c8071a4072ae8a8b79312d73cd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/2e8753ea5ad74807b5bf3ce4faac6905.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_16,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>程序实际运行时间 = 内核时间（系统调用） + 用户时间（CPU代码执行时间） + 消耗的时间（如IO）</p><p>内核时间，用户时间操作很快，因为都是在内存当前做事情。</p><p>IO会打开文件，写东西，关闭文件，和硬件打交道，非常浪费时间。</p><p>这里还涉及内核态和用户区态切换。</p><p><code>alarm</code>是系统调用，执行的时候切换到内核态，后面的代码执行又切换到用户态。</p><p>定时器和进程的状态（就绪，运行，挂起，暂停，僵尸，终止）无关——自然定时法。无论进程处于什么状态，定时器都会计时。</p><h4 id="9-3-setimier-定时器函数"><a href="#9-3-setimier-定时器函数" class="headerlink" title="9.3 setimier 定时器函数"></a>9.3 setimier 定时器函数</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>      <span class="token keyword">int</span> <span class="token function">setitimer</span><span class="token punctuation">(</span><span class="token keyword">int</span> which<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> <span class="token operator">*</span>new_value<span class="token punctuation">,</span>                      <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> <span class="token operator">*</span>old_value<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>作用：设置定时器，可以替代alarm。</p><p>​            单位：微秒us。</p><p>​            可以实现周期性定时。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">ITIMER_REAL    This timer counts down in <span class="token function">real</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> wall clock<span class="token punctuation">)</span> time<span class="token punctuation">.</span>  At each expiration<span class="token punctuation">,</span> a 【SIGALRM】 signal is generated<span class="token punctuation">.</span>ITIMER_VIRTUAL This timer counts down against the 【user<span class="token operator">-</span>mode CPU time】 consumed by the process<span class="token punctuation">.</span>  <span class="token punctuation">(</span>The measurement includes CPU time consumed by all threads in the process<span class="token punctuation">.</span><span class="token punctuation">)</span>  At each expiration<span class="token punctuation">,</span> a 【SIGVTALRM】 signal is generated<span class="token punctuation">.</span>ITIMER_PROF    This timer counts down against the <span class="token function">total</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> both 【user and system<span class="token punctuation">)</span> CPU time】 consumed by the process<span class="token punctuation">.</span>  <span class="token punctuation">(</span>The measurement includes CPU time consumed by all threads in the process<span class="token punctuation">.</span><span class="token punctuation">)</span>  At each expiration<span class="token punctuation">,</span> a 【SIGPROF】 signal is  generated<span class="token punctuation">.</span>    In  conjunction  with  ITIMER_VIRTUAL<span class="token punctuation">,</span>  this timer can be used to profile user and system CPU time consumed by the process<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 定时器的结构体</span><span class="token keyword">struct</span> <span class="token class-name">itimerval</span> <span class="token punctuation">{</span><span class="token keyword">struct</span> <span class="token class-name">timeval</span> it_interval<span class="token punctuation">;</span> <span class="token comment">// 每个阶段的时间，间隔时间</span><span class="token keyword">struct</span> <span class="token class-name">timeval</span> it_value<span class="token punctuation">;</span>    <span class="token comment">// 延迟多久时间执行定时器</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// from now on, wait 10s expire the clock, the interval is 2s</span><span class="token comment">// it_interval -&gt; 2s (反复执行)</span><span class="token comment">// it_value -&gt; 10s (delay)</span><span class="token comment">// 时间的结构体</span><span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">{</span><span class="token class-name">time_t</span>      tv_sec<span class="token punctuation">;</span>         <span class="token comment">// 秒数</span><span class="token class-name">suseconds_t</span> tv_usec<span class="token punctuation">;</span>        <span class="token comment">// 微秒</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数：</p><ul><li><p>which：定时器以什么时间计时</p><ul><li>ITIMER_REAF：真实世界的时间，发送SIGALRM（常用）</li><li>ITIMER_VIRTUAL：用户时间，发送SIGVTALRM</li><li>ITIMER_PROF：用户态 + 内核态消耗的时间，发送SIGPROOF</li></ul></li><li><p>new_value：设置这个定时器的属性</p></li><li><p>old_value：记录上一次定时的参数，用不到就传入NULL</p></li></ul><p>RETURN VALUE<br>       * On success, 【zero】 is returned.  </p><ul><li>On error, 【-1】 is returned, and errno is set appropriately.</li></ul><h5 id="示例代码-11"><a href="#示例代码-11" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">/*    struct itimerval new_value = {        {2, 0}, // 间隔的时间（周期）        {3, 0}  // 延迟的时间（过多久第一次执行）    };    */</span>   <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token comment">// 周期为2s</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>          <span class="token comment">// 延迟3s后执行</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setitimer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start timing...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 阻塞一下，不然还没计时3s钟就碰到return了</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，程序一跑起来 <code>start timing...</code> 就被打印了，说明 <code>setitimer</code> 和 <code>alarm</code> 一样也是非阻塞的。</p><p>然后过了3s程序就收到 <code>SIGALRM</code> 信号被终止了。</p><p>那说好的周期性定时效果呢？</p><p>因为我们没有捕捉信号，因此第一次发送 <code>SIGALRM</code> 的时候进程就被杀死了。</p><p><img src="https://img-blog.csdnimg.cn/0e5a14e6266b4fdcb7aa029bceca990a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>old_value 是个<code>传出参数</code>，系统会自动帮你设置它的值为上一次时钟的参数。</p><h5 id="示例代码-12"><a href="#示例代码-12" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">/*    struct itimerval new_value = {        {2, 0}, // 间隔的时间（周期）        {3, 0}  // 延迟的时间（过多久第一次执行）    };    */</span>   <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>        <span class="token comment">// 周期为2s</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>          <span class="token comment">// 延迟3s后执行</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> old_value<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"init : %ld, %ld\n"</span><span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec<span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>old_value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"after 1 : %ld, %ld\n"</span><span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec<span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setitimer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start timing...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>old_value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"after 2 : %ld, %ld\n"</span><span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec<span class="token punctuation">,</span> old_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/fdff376012ed4c64bd1238b95f5d5057.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="9-4-signal-と-sigaction-信号捕捉函数"><a href="#9-4-signal-と-sigaction-信号捕捉函数" class="headerlink" title="9.4 signal と sigaction 信号捕捉函数"></a>9.4 signal と sigaction 信号捕捉函数</h4><p>时钟结束后会发送一个 <code>SIGALRM</code> 信号，默认把当前进程终止，并没有周期性地执行。</p><p>因此我们要捕捉信号，不让他默认终止进程，而是我们程序员自己来做一些处理。</p><h5 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">sighandler_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">sighandler_t</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">,</span> <span class="token class-name">sighandler_t</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>signal handler</code> 是信号处理器，一个函数指针。既然我们要执行某些事情，不要进程被默认杀掉，就需要把代码写到函数当中，执行这个函数去完成某些事情，因此这是个函数指针，是个函数的地址。</p><p>参数：</p><ul><li>signum：要捕捉的信号，一般使用宏值，可以屏蔽架构的差异。</li><li>handler：<ul><li>SIG_IGN：忽略这个信号，不执行任何事情。</li><li>SIG_DFL：默认行为，和没有捕捉没啥区别</li><li>回调函数：内核去调用，程序员只负责写。函数定义了捕捉到信号后如何去处理。<ul><li>函数名实际就是函数的地址。</li></ul></li><li>The signals <strong>SIGKILL</strong> and <strong>SIGSTOP</strong> cannot be caught or ignored.</li></ul></li></ul><p>返回值：</p><ul><li>成功：返回上一次注册的信号处理函数的地址。第一次调用返回NULL。</li><li>失败：返回SIG_ERR，设置错误号</li></ul><h5 id="研究一下这个函数指针"><a href="#研究一下这个函数指针" class="headerlink" title="研究一下这个函数指针"></a>研究一下这个函数指针</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">sighandler_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果把括号去掉，长这个样子：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token class-name">sighandler_t</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这是这标准的函数声明写法，</p><p>返回一个void类型的指针，函数名叫sighandler_t，传入一个int类型的参数。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">sighandler_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>而加上括号她就成了一个函数指针，这个指针的名字叫sighandler_t。</p><p>这个函数的返回值是void，传入一个int类型的参数。</p><p>函数名 = 这个函数代码所存放的内存的首地址。和数组差不多。</p><p>关于函数指针，相面这段代码摘自<code>C语言中文网</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">Func</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/*声明一个函数*/</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/*定义一个函数指针*/</span>p <span class="token operator">=</span> Func<span class="token punctuation">;</span>          <span class="token comment">/*将Func函数的首地址赋给指针变量p*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="示例代码-13"><a href="#示例代码-13" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">void</span> <span class="token function">myAlarm</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"捕捉到 %d 号信号\n"</span><span class="token punctuation">,</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"---------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 在最前面就要注册好信号捕捉</span>    <span class="token comment">// 要捕猎也是一开始就要做好陷阱</span>    <span class="token comment">// signal(SIGALRM, SIG_DFL);    默认行为，该干嘛干嘛，相当于啥都没捕捉，进程正常结束</span>    <span class="token comment">// signal(SIGALRM, SIG_IGN);    忽略这个信号，进程永远无法结束</span>    __sighandler_t sig_ret <span class="token operator">=</span> <span class="token function">signal</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> myAlarm<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>sig_ret <span class="token operator">==</span> SIG_ERR<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"signal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token comment">// 周期为2s</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>          <span class="token comment">// 延迟3s后执行</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setitimer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start timing...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 阻塞一下，不然还没计时3s钟就碰到return了</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/0003d8f3577c4fe8aa9c4be6b54b2470.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>进程捕捉到这个信号之后，就一直去执行这个函数。</p><p>如果我们传SIGKILL，去执行一个回调函数或直接SIG_IGN，可能会出大事情，就像病毒一样永远无法被杀死。</p><h4 id="9-5-信号集-と-相关函数"><a href="#9-5-信号集-と-相关函数" class="headerlink" title="9.5 信号集 と 相关函数"></a>9.5 信号集 と 相关函数</h4><p><img src="https://img-blog.csdnimg.cn/219ce3d36c8743c881a19d01b7649aed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>信号集：很多信号组成的集合。</p><p>班级可以方便对多个学生进行同一个管理，信号集可以对对多个信号进行统一的管理。</p><p><strong>阻塞信号集</strong>：阻塞信号递达，不要被处理，而不是阻塞信号创建。</p><p><strong>未决信号集</strong>：只要信号创建了但没递达，都是未决状态。</p><blockquote><p>复习-信号三种状态：创建，未决，递达</p></blockquote><p><strong>位图机制</strong>：类似我们使用 <code>open</code> 函数时传递的那个 <code>flag</code>。这是为了传递多个值进去。</p><p>例如我们有个阻塞信号集</p><p>|1|</p><p>|0|</p><p>|1|</p><p>|0|</p><p>|0|</p><p>这说明1号信号和3号信号需要被阻塞。</p><p>类似一个接口，我们不能直接访问信号集，但是我们可以自己定义一个并通过系统调用传进去。</p><p><img src="https://img-blog.csdnimg.cn/fa4a4b426b764160a3ddd38bd4e1012f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="信号集工作原理"><a href="#信号集工作原理" class="headerlink" title="信号集工作原理"></a>信号集工作原理</h5><ol><li><p>我们敲击键盘上的 <code>CTRL + C</code>，产生信号 <code>SIGINT</code>。（信号创建）</p></li><li><p>信号创建但是还没有被处理。（信号未决）</p><ul><li>内核将所有未决的信号存储在<code>未决信号</code>集当中</li><li><code>SIGINT</code> 被存储在第二个存储位上<ul><li>1 表示该信号处于未决状态</li><li>0 表示该信号不处于未决状态</li></ul></li></ul></li><li><p>该未决状态的信号需要被处理，但不是直接被处理，而是与<code>阻塞信号集</code>进行比较。</p><p>阻塞信号集默认不阻塞，但是用户可以通过系统调用API设置阻塞某些信号。由于某些信号会对我们的程序产生某些影响，因此我们需要暂时阻塞该信号。</p><ul><li>查询阻塞信号集中的标志位。<ul><li>1 表示需要阻塞，该信号暂时不发送给进程处理，仍然处于未决状态，直到阻塞解除</li><li>0 表示无需阻塞，该信号马上被发送给进程处理</li></ul></li></ul></li></ol><h5 id="与信号集有关的函数"><a href="#与信号集有关的函数" class="headerlink" title="与信号集有关的函数"></a>与信号集有关的函数</h5><p>以下函数都可以对自己<code>自定义</code>的信号集进行操作，并不能对内核中的信号集进行操作。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token comment">// 清空信号集中所有的数据，把标志位全部置0</span><span class="token keyword">int</span> <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token class-name">sigset_t</span> <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 填充信号集中所有的数据，把标志位全部置1</span><span class="token keyword">int</span> <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token class-name">sigset_t</span> <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置某位为1</span><span class="token keyword">int</span> <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token class-name">sigset_t</span> <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置某位为0</span><span class="token keyword">int</span> <span class="token function">sigdelset</span><span class="token punctuation">(</span><span class="token class-name">sigset_t</span> <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 判断某个信号是否阻塞</span><span class="token keyword">int</span> <span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">sigset_t</span> <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 返回值</span><span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> and <span class="token function">sigdelset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span> on success and <span class="token operator">-</span><span class="token number">1</span> on error<span class="token punctuation">.</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token punctuation">)</span> returns <span class="token number">1</span> <span class="token keyword">if</span> signum is a member of set<span class="token punctuation">,</span>   <span class="token number">0</span> <span class="token keyword">if</span> signum is not a member<span class="token punctuation">,</span> and <span class="token operator">-</span><span class="token number">1</span> on error<span class="token punctuation">.</span>On error<span class="token punctuation">,</span> these functions set errno to indicate the cause of the error<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>set</code>，就是我们的信号集。他是一个传出参数（sigismember()中除外），因此我们一开始要初始化这个信号集。</p><p><code>sigset_t类型</code> 是这么个东西。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_SIGSET_NWORDS</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">int</span> __val<span class="token punctuation">[</span>_SIGSET_NWORDS<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span> __sigset_t<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/7379052a35b14a538df2f97b6fde8566.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==">可见 <code>unsigned long int</code>是8byte = 64位。</p><p>而 宏<code>_SIGSET_NWORDS</code> = 16。</p><p>因此, <code>sigset_t</code>定义了一个结构体，这个结构体中有一个有为数组，该数组有16个元素，每个元素是8byte = 64位，整个sigset_t占16 * 8 = 128byte。</p><h5 id="示例代码-14"><a href="#示例代码-14" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建一个信号集</span>    <span class="token class-name">sigset_t</span> myset<span class="token punctuation">,</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>myset<span class="token punctuation">;</span>    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myset<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 看看SIGINT阻不阻塞</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGINT阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGINT不阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 把SIGINT放到信号集中</span>    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"已将SIGINT放入信号集\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 看看SIGINT阻不阻塞</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGINT阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGINT不阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5. 从信号集中删除SIGINT</span>    <span class="token function">sigdelset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"已将SIGINT移除信号集\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5. 看看SIGINT阻不阻塞</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGINT阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SIGINT不阻塞\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/d71a8e5c34f440d2b2c4efce444e3188.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>刚开始一定要初始化信号集</p><p>可见不初始化对我们的程序伤害是非常大的</p><p><img src="https://img-blog.csdnimg.cn/4b5aea3a194949c4a7d5cd3d9b106d48.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="9-6-sigprocmask-と-sigpending-函数"><a href="#9-6-sigprocmask-と-sigpending-函数" class="headerlink" title="9.6 sigprocmask と sigpending 函数"></a>9.6 sigprocmask と sigpending 函数</h4><p><img src="https://img-blog.csdnimg.cn/b8e4c7d4f51f4fcfb5a096de3ef38302.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="sigprocmask"><a href="#sigprocmask" class="headerlink" title="sigprocmask"></a>sigprocmask</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">sigprocmask</span><span class="token punctuation">(</span><span class="token keyword">int</span> how<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">sigset_t</span> <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token class-name">sigset_t</span> <span class="token operator">*</span>oldset<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>作用：对内核中的信号机进行操作。</p><p>参数：</p><ul><li><p>how：如何对内核阻塞信号集</p><ul><li><p>SIG_BLOCK</p><pre><code>          The set of blocked signals is the union of【 the current set】 and 【the set argument】. 将用户设置的信号集添加到内核中</code></pre><p>​            （<code>kernel | user</code>）。</p></li><li><p>SIG_UNBLOCK</p><pre><code>          【The signals in set】 are 【removed from the current set】of blocked signals.  It is permissible to attempt to unblock a signal which is not blocked. 根据用户设置的信号集，对内核中的信号集仅从接触阻塞。</code></pre><p>​                (<code>kernel &amp;= ~usr</code>)</p></li><li><p>SIG_SETMASK</p><pre><code>          The set of blocked signals is set to the argument set.</code></pre></li></ul></li><li><p>set：传入参数，用户自定义的信号集。</p></li><li><p>oldset：用户设置之前，内核中阻塞信号集的状态，可以是NULL。</p></li></ul><p>返回值：</p><ul><li>成功，返回0.</li><li>失败： 返回 -1。</li></ul><p>ERROR：</p><ul><li><p>EFAULT The set or oldset argument points outside the process’s allocated address space.</p></li><li><p>EINVAL Either the value specified in how was invalid or the kernel does not support the size passed in sigsetsize.</p></li></ul><h5 id="sigpending"><a href="#sigpending" class="headerlink" title="sigpending"></a>sigpending</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">sigpending</span><span class="token punctuation">(</span><span class="token class-name">sigset_t</span> <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>作用：returns the set of signals that are pending for delivery to the calling thread (i.e., the signals which have been raised while blocked).  The mask of pending signals is returned in <code>set</code>.</p><p>返回值： sigpending() returns 0 on success and -1 on error.  In the event of an error, errno is set to indicate the cause.</p><h5 id="示例代码-15"><a href="#示例代码-15" class="headerlink" title="示例代码"></a>示例代码</h5><p>将所有常规信号（1~31）的未决状态打印到屏幕。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 设置2(ctrl + c), 3号(ctrl + \)信号阻塞</span>    <span class="token class-name">sigset_t</span> myset<span class="token punctuation">;</span>    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myset<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 初始化信号集</span>    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 修改内核中的信号集</span>    <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 查看</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token operator">++</span> num<span class="token punctuation">;</span>        <span class="token class-name">sigset_t</span> curset<span class="token punctuation">;</span>        <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>curset<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 初始化信号集</span>        <span class="token function">sigpending</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>curset<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获取未决信号集</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">31</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>curset<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>curset<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>            <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigismmber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/156037b824104f15bb13144db96e8203.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_17,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>可以看到，刚开始我们前31个信号在阻塞信号集中都是0，说明都不阻塞。</p><p>然而我们按下 <code>ctrl + c</code> 之后系统捕捉到了2号信号 <code>SIGINT</code>，然后将它放入了阻塞信号集，因此这个信号暂时不被处理。</p><p>循环十次后，我们将这个信号设置为非阻塞，因而 之前发送的<code>SIGINT</code> 被处理了，我们的程序也就终止了。</p><h4 id="9-7-sigaction-信号捕捉函数"><a href="#9-7-sigaction-信号捕捉函数" class="headerlink" title="9.7 sigaction 信号捕捉函数"></a>9.7 sigaction 信号捕捉函数</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">sigaction</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token operator">*</span>act<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token operator">*</span>oldact<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>作用： examine and change a signal action 检查并改变一个信号的动作，说白了就是信号捕捉。</p><p>参数：</p><ul><li><p>signum：我们要捕捉的信号，推荐使用宏值，SIGKILL and SIGSTOP除外。</p></li><li><p>act：the new action for signal <code>signum</code> 捕捉到信号后的处理动作</p></li><li><p>oldact：如果 non-NULL，作为传出参数存储上一次调用sigaction时传入的act，一般不使用。</p></li></ul><p>返回值： sigaction() returns 0 on success; on error, -1 is returned, and errno is set to indicate the error.</p><p>关于结构体的详细信息</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 我们的回调函数被封装在一个类型为 struct sigaction 的结构体中</span>The sigaction structure is defined as something like<span class="token operator">:</span><span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token punctuation">{</span>    <span class="token comment">// 函数指针，捕捉到信号之后去处理该指针指向的函数</span>    <span class="token keyword">void</span>     <span class="token punctuation">(</span><span class="token operator">*</span>sa_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 也是回调函数，不常用</span>    <span class="token keyword">void</span>     <span class="token punctuation">(</span><span class="token operator">*</span>sa_sigaction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token class-name">siginfo_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 临时设置的阻塞信号集，捕捉到某些信号后，在回调函数执行过程中临时阻塞它们</span>    <span class="token comment">// 回调函数执行完就不阻塞了</span>    <span class="token class-name">sigset_t</span>   sa_mask<span class="token punctuation">;</span>        <span class="token comment">// 使用sa_handler，传递0</span>    <span class="token comment">// 使用sa_sigaction，传递 SA_SIGINFO</span>    <span class="token keyword">int</span>        sa_flags<span class="token punctuation">;</span>        <span class="token comment">// NULL, 已经被废弃</span>    <span class="token keyword">void</span>     <span class="token punctuation">(</span><span class="token operator">*</span>sa_restorer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="示例代码-16"><a href="#示例代码-16" class="headerlink" title="示例代码"></a>示例代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">void</span> <span class="token function">myAlarm</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"捕捉到 %d 号信号\n"</span><span class="token punctuation">,</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"---------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 在最前面就要注册好信号捕捉</span>    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>    act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                   <span class="token comment">// 使用handler</span>    act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> myAlarm<span class="token punctuation">;</span>  <span class="token comment">// 回调函数</span>    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 清空信号集</span>    <span class="token keyword">int</span> sig_ret <span class="token operator">=</span> <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>sig_ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"sigaction"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token comment">// 周期为2s</span>    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>          <span class="token comment">// 延迟3s后执行</span>    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setitimer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start timing...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// getchar();  // 阻塞一下，不然还没计时3s钟就碰到return了</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/fe690571104e4f7b8565486f5a4a5e69.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_5,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>为什么建议使用 <code>sigaction</code> 而不是 <code>signal</code> ？</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">The behavior of <span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> varies across UNIX versions<span class="token punctuation">,</span> and has also varied historically across different versions of Linux<span class="token punctuation">.</span>Avoid its use<span class="token operator">:</span> use <span class="token function">sigaction</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> instead<span class="token punctuation">.</span>  See Portability below<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="内核实现信号捕捉的过程"><a href="#内核实现信号捕捉的过程" class="headerlink" title="内核实现信号捕捉的过程"></a>内核实现信号捕捉的过程</h5><p><img src="https://img-blog.csdnimg.cn/c3204fe03dab47d2919192b24185b636.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>在执行某一信号引起的回调函数期间，该信号再一次被收到会阻塞，不会直接去执行回调函数。</p><p>规常规信号在阻塞的时候不支持排队。</p><p>未决信号集一位只能记录0或1，不饿能记录收到了多少次同一信号。</p><p>重复发送且未决的多余信号直接丢弃。</p><h4 id="9-8-SIGCHILD-信号"><a href="#9-8-SIGCHILD-信号" class="headerlink" title="9.8 SIGCHILD 信号"></a>9.8 SIGCHILD 信号</h4><p><img src="https://img-blog.csdnimg.cn/4c890160cffb4ac4a79c1c17c9e77012.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>使用 <code>SIGCHLD</code> 信号可以解决<code>僵尸进程</code>问题。</p><p>我们先创建一些僵尸进程</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建20个子进程</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 让子进程先死掉，父进程不回收，产生僵尸</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child pid = %d died!\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们让子进程先死亡，但是父进程陷入了死循环，没有回收子进程。</p><p>正中我们下怀，我们有20个僵尸进程了。</p><p><img src="https://img-blog.csdnimg.cn/71e8f68cdd4c464e870d6513c7a84bc5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>我们可以让 父进程 <code>wait</code> 一下子进程，不过这个时阻塞的，父进程只能在那里傻等着。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"回收成功 %d 个子进程！\n"</span><span class="token punctuation">,</span> cnt <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child pid = %d died!\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果实时观察 <code>top</code>，可以发现子进程越来越少，资源都被回收了。</p><p><img src="https://img-blog.csdnimg.cn/f909222fefcb497aa222ed9e0211c36e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>再复习一下 <code>waitpid</code></p><p>waitpid 可以被设置为非阻塞</p><p>父进程仍然需要不断在循环里面调用wait或者waitpid</p><p>如果我们让父进程去做自己的事情，然后捕捉到子进程死亡消息的时候再去回收资源比较合理</p><p><img src="https://img-blog.csdnimg.cn/625d3b527bfb4fe1b981db1ea5c95822.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/a5eca989cc5042a1a18c5c860285c67e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="父进程中捕捉-CIGCHLD-，父进程回收资源"><a href="#父进程中捕捉-CIGCHLD-，父进程回收资源" class="headerlink" title="父进程中捕捉 CIGCHLD ，父进程回收资源"></a>父进程中捕捉 <code>CIGCHLD</code> ，父进程回收资源</h5><p>例如这样</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">myFunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"捕捉到 %d 号信号\n"</span><span class="token punctuation">,</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建20个子进程</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 让子进程先死掉，父进程不回收，产生僵尸</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>                <span class="token comment">// 捕捉SIGCHLD信号</span>        <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>        act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> myFunc<span class="token punctuation">;</span>        <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child pid = %d died!\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是我们会发现，无论如何，多久时间过去啊，都有几个僵尸子进程还存在。</p><p><img src="https://img-blog.csdnimg.cn/bf1bbeea5c34439ab17e63bb8ae57e47.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>这是为什么呢？</p><p>这就跟前面提到的信号集有关。</p><p>由于我们有多个子进程死亡，当某个子进程发送的信号被接受并处理的同时，</p><p>又有一条死亡信号传来，</p><p>然而我们的信号集每个常规信号只能记录一个位，不支持排队，</p><p>因此在执行回调函数的时候同一信号被屏蔽了，因此有些僵尸进程无法被回收。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> cnt2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">myFunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"捕捉到 %d 号信号 %d\n"</span><span class="token punctuation">,</span> signum<span class="token punctuation">,</span> cnt2 <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// while(1) { wait(NULL); }</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child die %d\n"</span><span class="token punctuation">,</span> cnt <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token comment">// 假如有100行代码，我们走到了第20行收到了信号，于是系统去执行回调函数，进程被暂停，有了break就可以回来继续执行</span>        <span class="token keyword">else</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建20个子进程</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 让子进程先死掉，父进程不回收，产生僵尸</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>                <span class="token comment">// 捕捉SIGCHLD信号</span>        <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>        act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> myFunc<span class="token punctuation">;</span>        <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>就可以看到，第一次捕捉到信号回收了好多的子进程</p><p><img src="https://img-blog.csdnimg.cn/7f5ca6c3acc74753867eb0de47d2dc8c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/d37b7c081a0c4da5a3feb2810067f5e8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_16,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>然鹅，有没有一种可能，有的子进程死的比注册回调函数还快？</p><p>我们需要设置一个<code>阻塞信号集</code>，即使有子进程死亡，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> cnt2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">myFunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"捕捉到 %d 号信号 %d\n"</span><span class="token punctuation">,</span> signum<span class="token punctuation">,</span> cnt2 <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// while(1) { wait(NULL); }</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child die %d\n"</span><span class="token punctuation">,</span> cnt <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token comment">// 假如有100行代码，我们走到了第20行收到了信号，于是系统去执行回调函数，进程被暂停，有了break就可以回来继续执行</span>        <span class="token keyword">else</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 0. 提前设置好阻塞信号集，阻塞SIGCHLD信号</span>    <span class="token class-name">sigset_t</span> myset<span class="token punctuation">;</span>    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myset<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> SIGCHLD<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 创建20个子进程</span>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 让子进程先死掉，父进程不回收，产生僵尸</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>                <span class="token comment">// 捕捉SIGCHLD信号</span>        <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>        act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> myFunc<span class="token punctuation">;</span>        <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 注册完回调函数之后，就接触对SIGCHLD的阻塞</span>        <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>myset<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"parent pid = %d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="17-共享内存"><a href="#17-共享内存" class="headerlink" title="17. 共享内存"></a>17. 共享内存</h2><p>效率最高的一种进程间通信方式。</p><p>内存映射需要一个物理磁盘上的文件作为媒介，而共享内存不需要。</p><p>但同时也会带来问题，比如进程同步问题。</p><h3 id="17-1-共享内存的概念"><a href="#17-1-共享内存的概念" class="headerlink" title="17.1 共享内存的概念"></a>17.1 共享内存的概念</h3><p><img src="https://img-blog.csdnimg.cn/fd57ef7f14d548e1a8c591d639833c57.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="17-2-共享内存的使用步骤"><a href="#17-2-共享内存的使用步骤" class="headerlink" title="17.2 共享内存的使用步骤"></a>17.2 共享内存的使用步骤</h3><p><img src="https://img-blog.csdnimg.cn/71603f399c28467f91538f1419191430.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ul><li><p><code>shmget</code>：获得共享内存标识符（自己创建新的 or 获取既有的）。由于我们可以创建多个共享内存，因此不同的内存需要标识符。</p></li><li><p><code>shmat</code>：将当前进程与这块共享内存关联了，获得一个首地址来操作这块内存。它存在于共享库，内存映射存在的共享空间中。</p></li><li><p><code>shmdt</code>：当前进程和共享内存撇清关系，再不联系。进程终止会自动执行。</p></li><li><p><code>shmctl</code>：删除共享内存段。所有attach了的进程都与其分离后，这块内存才会被销毁。记录关联数量，等于0时删除</p></li></ul><h3 id="17-4-相关函数"><a href="#17-4-相关函数" class="headerlink" title="17.4 相关函数"></a>17.4 相关函数</h3><p><img src="https://img-blog.csdnimg.cn/7307192d463347a4800e3cb3f934db14.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="shmget"><a href="#shmget" class="headerlink" title="shmget"></a>shmget</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>shmflg：IPC_CREAT    Create a new segment<span class="token punctuation">.</span>  If this flag is not used<span class="token punctuation">,</span> then <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> will find the segment associated with key and check to see <span class="token keyword">if</span> the user has permission to  access the segment<span class="token punctuation">.</span>IPC_EXCL    This flag is used with IPC_CREAT to ensure that this call creates the segment<span class="token punctuation">.</span>  If the segment already exists<span class="token punctuation">,</span> the call fails<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：allocates a System V shared memory segment. 创建一个新的共享内存段并返回标识 or 获取既有的内存段标识。新创建的内存段中的数据都会被初始化为0.</p><p>参数：</p><ul><li><p>key：一个int，通过这个找到或创建一个共享内存。底层会转换成16进制。</p></li><li><p>size：共享内存的大小，不能为0。以分页的标准去创建。</p></li><li><p>shmflg：共享内存的属性：</p><ul><li>访问权限</li><li>附加属性：创建、判断共享内存是否存在<ul><li>IPC_CREAT：创建</li><li>IPC_EXCL：判断共享内存是否存在，与IPC_CREAT一起使用，如 IPC_CREAT | IPC_EXCL | 0664</li></ul></li></ul></li></ul><p>返回值：  On success, a valid shared memory 【identifier】（后面操作共享内存都是通过这个值） is returned.  </p><p>​                  On error, 【-1】 is returned, and errno is set to indicate the error.</p><h5 id="shmat"><a href="#shmat" class="headerlink" title="shmat"></a>shmat</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">shmat</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>If 【shmaddr】 is <span class="token constant">NULL</span><span class="token punctuation">,</span> the system chooses a <span class="token function">suitable</span> <span class="token punctuation">(</span>unused<span class="token punctuation">)</span> page<span class="token operator">-</span>aligned address to attach the segment<span class="token punctuation">.</span>    shmflg<span class="token operator">:</span><span class="token function">SHM_EXEC</span> <span class="token punctuation">(</span>Linux<span class="token operator">-</span>specific<span class="token punctuation">;</span> since Linux <span class="token number">2.6</span><span class="token number">.9</span><span class="token punctuation">)</span>Allow the contents of the segment to 【be executed】<span class="token punctuation">.</span>  The caller 【must have execute permission】 on the segment<span class="token punctuation">.</span>SHM_RDONLYAttach the segment <span class="token keyword">for</span> read<span class="token operator">-</span>only access<span class="token punctuation">.</span>  The process 【must have read permission】 <span class="token keyword">for</span> the segment<span class="token punctuation">.</span>  If this flag is 【not specified】<span class="token punctuation">,</span> the segment is attached <span class="token keyword">for</span> 【read and write】 access<span class="token punctuation">,</span> and the process 【must have read and write permission】 <span class="token keyword">for</span> the segment<span class="token punctuation">.</span>  There is no notion of a write<span class="token operator">-</span>only shared memory segment<span class="token punctuation">.</span><span class="token function">SHM_REMAP</span> <span class="token punctuation">(</span>Linux<span class="token operator">-</span>specific<span class="token punctuation">)</span>This flag specifies that the mapping of the segment should replace any existing mapping in the range starting at shmaddr and continuing <span class="token keyword">for</span> the size of the segment<span class="token punctuation">.</span><span class="token punctuation">(</span>Normally<span class="token punctuation">,</span> an EINVAL error would result <span class="token keyword">if</span> a mapping already exists in this address range<span class="token punctuation">.</span><span class="token punctuation">)</span>  In this <span class="token keyword">case</span><span class="token punctuation">,</span> shmaddr must not be <span class="token constant">NULL</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>作用：shmat()  attaches  the  System V shared memory segment identified by <code>shmid</code> to the address space of the calling process. 将 shmid 指定的共享内存与当前进程关联</p><p>参数：</p><ul><li>shmid：供词昂内存的标识(ID)，由 <code>shmget</code>返回值获得。</li><li>shmaddr：申请的共享内存的起始地址，建议传NULL，由内核指定。</li><li>shmflg：对共享内存的操作<ul><li>SHM_RDONLY，必须要有读权限才能设置这个宏</li><li>0：不指定就默认拥有读写权限</li></ul></li></ul><p>返回值：On success, shmat() returns the 【address】 of the attached shared memory segment; </p><p>​                On error, 【(void *) -1】 is returned, and errno is set to indicate the cause of the error.</p><h5 id="shmdt"><a href="#shmdt" class="headerlink" title="shmdt"></a>shmdt</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>作用：shmdt()  detaches  the shared memory segment located at the address specified by <code>shmaddr</code> from the address space of the calling process.  The to-be-detached segment must be currently attached with shmaddr equal to the value returned by the attaching <code>shmat()</code> call. </p><p>​            解除当前进程与共享内存的关联</p><p>参数：</p><ul><li>shmadder：就是关联的时候 <code>shmat</code> 的返回值。</li></ul><p>返回值：</p><ul><li>成功： 0</li><li>失败： -1</li></ul><h5 id="shmctl"><a href="#shmctl" class="headerlink" title="shmctl"></a>shmctl</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>作用： shmctl() performs the control operation specified by <code>cmd</code> on the System V shared memory segment whose identifier is given in <code>shmid</code>.</p><p>可以指定 <code>cmd</code> 用来删除共享内存。共享内存要删除才会消失，进程的死亡不影响共享内存。</p><p>参数：</p><ul><li><p>shmid：要操作的共享内存的ID。</p></li><li><p>cmd：operation</p><ul><li><p>IPC_STAT：获取共享内存的状态</p></li><li><p>IPC_SET：设置共享内存的状态</p></li><li><p>IPC_RMID：标记共享内存将要被删除。</p><p>Mark the segment to be destroyed.  The segment will actually be destroyed 【only after the [ last ] process detaches it】 (i.e., when the shm_nattch member of the  associated structure shmid_ds is zero).  The caller must be the owner or creator of the segment, or be privileged.  The buf argument is ignored.</p></li></ul></li><li><p>buf：一个结构体指针，里面存我们要设置或获取的共享内存的属性信息。</p><ul><li>若前面指定IPC_STAT，buf是个传出参数，存储数据</li><li>若前面设置IPC_SET，buf用于初始化数据，设置到内核中</li><li>若前面设置IPC_RMID，buf没啥用，传NULL，即使有数据也会被忽略</li></ul></li></ul><p>这个 <code>shmid_ds</code>类型的结构体指针<code>buf</code> 里面放了这些东西。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">The buf argument is a pointer to a shmid_ds structure<span class="token punctuation">,</span> defined in <span class="token operator">&lt;</span>sys<span class="token operator">/</span>shm<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> as follows<span class="token operator">:</span><span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token punctuation">{</span>    <span class="token keyword">struct</span> <span class="token class-name">ipc_perm</span> shm_perm<span class="token punctuation">;</span>    <span class="token comment">/* Ownership and permissions */</span>    <span class="token class-name">size_t</span>          shm_segsz<span class="token punctuation">;</span>   <span class="token comment">/* Size of segment (bytes) */</span>    <span class="token class-name">time_t</span>          shm_atime<span class="token punctuation">;</span>   <span class="token comment">/* Last attach time */</span>    <span class="token class-name">time_t</span>          shm_dtime<span class="token punctuation">;</span>   <span class="token comment">/* Last detach time */</span>    <span class="token class-name">time_t</span>          shm_ctime<span class="token punctuation">;</span>   <span class="token comment">/* Last change time */</span>    <span class="token class-name">pid_t</span>           shm_cpid<span class="token punctuation">;</span>    <span class="token comment">/* PID of creator */</span>    <span class="token class-name">pid_t</span>           shm_lpid<span class="token punctuation">;</span>    <span class="token comment">/* PID of last shmat(2)/shmdt(2) */</span>    <span class="token class-name">shmatt_t</span>        shm_nattch<span class="token punctuation">;</span>  <span class="token comment">/* No. of current attaches */</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>里面还有个 <code>ipc_perm</code> 类型的结构体 <code>shm_perm</code>。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">The ipc_perm structure is defined as <span class="token function">follows</span> <span class="token punctuation">(</span>the highlighted fields are settable using IPC_SET<span class="token punctuation">)</span><span class="token operator">:</span><span class="token keyword">struct</span> <span class="token class-name">ipc_perm</span> <span class="token punctuation">{</span>    <span class="token class-name">key_t</span>          __key<span class="token punctuation">;</span>    <span class="token comment">/* Key supplied to shmget(2) */</span>    <span class="token class-name">uid_t</span>          uid<span class="token punctuation">;</span>      <span class="token comment">/* Effective UID of owner */</span>    <span class="token class-name">gid_t</span>          gid<span class="token punctuation">;</span>      <span class="token comment">/* Effective GID of owner */</span>    <span class="token class-name">uid_t</span>          cuid<span class="token punctuation">;</span>     <span class="token comment">/* Effective UID of creator */</span>    <span class="token class-name">gid_t</span>          cgid<span class="token punctuation">;</span>     <span class="token comment">/* Effective GID of creator */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> mode<span class="token punctuation">;</span>     <span class="token comment">/* Permissions + SHM_DEST and                                           SHM_LOCKED flags */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> __seq<span class="token punctuation">;</span>    <span class="token comment">/* Sequence number */</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="示例代码-17"><a href="#示例代码-17" class="headerlink" title="示例代码"></a>示例代码</h5><p><strong>create_shm.c</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建一个共享内存</span>    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmget"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CREATE::PROCESS::shmid: %d\n"</span><span class="token punctuation">,</span> shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 关联当前进程</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 写数据</span>    <span class="token keyword">char</span> str<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hello world!"</span><span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"请按任意键继续...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 解除关联</span>    <span class="token function">shmdt</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5. 删除共享内存</span>    <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>read_shm.c</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 获取一个共享内存</span>    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 第二个参数不能大于4096</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmget"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"READ::PROCESS::shmid: %d\n"</span><span class="token punctuation">,</span> shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 关联当前进程</span>    <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 读数据</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"请按任意键继续...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 解除关联</span>    <span class="token function">shmdt</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5. 删除共享内存</span>    <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，我们的进程实现了进程间通信。</p><p><img src="https://img-blog.csdnimg.cn/3f69f257a9884ef88d4085c0aa163be8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="ftok"><a href="#ftok" class="headerlink" title="ftok"></a>ftok</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span><span class="token class-name">key_t</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> proj_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>作用；  The  ftok()  function  uses  the  identity  of  the file named by the given pathname (which must refer to an existing, accessible file) and 【the least significant 8 bits】 of 【proj_id】 (which must be nonzero) 【to generate a key_t type System V IPC key】, suitable for use with 【msgget(2), semget(2), or shmget(2)】. 根据指定的路径名称帮我们生成一个 <code>key</code>。前面那个程序我们是自己指定的，是随便取的100。</p><p>参数：</p><ul><li>pathname：指定一个存在的路径 /home/Sakana/Mydoc/……</li><li>proj_id：int类型的值，但是该系统调用只会使用其中 1 byte = 8位。范围： 0 - 255， 指定一个字符就行， 如’a’。</li></ul><p>返回值：</p><ul><li><p>On success, the 【generated key_t value】 is returned.  </p></li><li><p>On failure 【-1】 is returned, with errno indicating the error as for the stat(2)  system call.</p></li></ul><h4 id="17-5-共享内存操作命令"><a href="#17-5-共享内存操作命令" class="headerlink" title="17.5 共享内存操作命令"></a>17.5 共享内存操作命令</h4><h5 id="操作系统如何知道共享内存被多少进程关联了？"><a href="#操作系统如何知道共享内存被多少进程关联了？" class="headerlink" title="操作系统如何知道共享内存被多少进程关联了？"></a>操作系统如何知道共享内存被多少进程关联了？</h5><p>共享内存维护了一个结构体叫做 <code>struct shmid_ds</code>，其中有个成员 <code>shmatt_t shm_nattach</code>，它记录了我们的共享内存关联的进程个数。</p><p>此外，我们也可以通过shell命令的方式去查看，</p><p><img src="https://img-blog.csdnimg.cn/f92063903d4540b68394214234797543.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><code>ipcs -a</code> 查询所有种类</p><p><img src="https://img-blog.csdnimg.cn/bd532758ad2c46faad217bc825685654.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><code>ipcs -m</code> 查询共享内存</p><p>我们把之前写的程序跑起来，可以看到，我们新绑定的共享内存ID为7。</p><p> <img src="https://img-blog.csdnimg.cn/20dd861da28c4f8f89dd50e851b5e750.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_16,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/1d7803e2dff144b68e42d9e869b4c504.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_15,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> </p><p>而查看连接数也会发现 shmid = 7 的共享内存此时连接了两个进程。</p><p><img src="https://img-blog.csdnimg.cn/200385c60c604ca6896264e1d516f7a5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>而将两个进程结束掉，我们会发现 shmid = 7 的共享内存消失了。</p><p>因为我们解除了绑定，同时也删除了这个内存。</p><p><img src="https://img-blog.csdnimg.cn/73f302790dd14089a8ef97789a528a7b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>老师说标记删除后key会变成0，但是我的好像没有变成0？这里没截图。</p><h5 id="可不可以对共享内存进行多次删除？-通过-shmctl"><a href="#可不可以对共享内存进行多次删除？-通过-shmctl" class="headerlink" title="可不可以对共享内存进行多次删除？ -通过 shmctl"></a>可不可以对共享内存进行多次删除？ -通过 shmctl</h5><p>可以的。因为 shmctl 并不是真正的删除，只是标记删除共享内存。</p><p>当和共享内存关联的进程数为0时，共享内存才被真正删除。</p><p>当共享内存的key为0时，标识该内存被标记删除了。</p><p>如果一个进程和共享内存取消关联，这个进程就不能继续操作这个共享内存了。</p><h3 id="17-6-共享内存和内存映射的区别"><a href="#17-6-共享内存和内存映射的区别" class="headerlink" title="17.6 共享内存和内存映射的区别"></a>17.6 共享内存和内存映射的区别</h3><ol><li><p>共享内存可以直接创建，内存映射依赖磁盘文件（匿名映射除外）</p></li><li><p>共享内存效率更高，内存映射需要与磁盘文件同步</p></li><li><p>内存</p><p>共享内存 - 所有的进程操作的是同一块内存； </p><p>内存映射 - 每个进程在自己的虚拟地址空间中都有一块独立的内存，和磁盘文件关联起来。</p></li><li><p>数据安全</p><p>进程突然退出：共享内存依然存在（销毁很严格，标记删除，关联数为0）；</p><p>​                            内存映射不复存在（生存于进程的虚拟地址空间）</p><p>运行进程的电脑宕机了：数据存在共享内存中，没了；</p><p>​                                            内存映射去的数据也没了，只不过它有个文件实体，可以保存数据。</p></li><li><p>生命周期</p><p>共享内存：进程退出后共享内存还在，手动删除（所有关联进程数为0也会释放掉），如果一个进程退出会自动和共享内存取消关联。</p><p>内存映射：进程退出后内存映射区校徽。</p></li></ol><h2 id="18-守护进程"><a href="#18-守护进程" class="headerlink" title="18. 守护进程"></a>18. 守护进程</h2><h3 id="18-1-控制终端"><a href="#18-1-控制终端" class="headerlink" title="18.1 控制终端"></a>18.1 控制终端</h3><p><img src="https://img-blog.csdnimg.cn/c833eaa98e734913b863b4b465d0399b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="18-2-进程组"><a href="#18-2-进程组" class="headerlink" title="18.2 进程组"></a>18.2 进程组</h3><p><img src="https://img-blog.csdnimg.cn/f405046e8d1f484493588f241e1bee40.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="18-3-会话"><a href="#18-3-会话" class="headerlink" title="18.3 会话"></a>18.3 会话</h3><p><img src="https://img-blog.csdnimg.cn/91c8c2d041bc4be0b4a11d3bcab315a7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>一开始是没有会话的。</p><p>要先创建<code>进程组</code>，创建一个<code>进程P</code>会自动生成一个新的进程组。</p><p>该进程P会成为该会话的首进程。</p><p>控制终端只有一个，且只能成为一个会话的控制终端。</p><p>一个会话里有很多进程组，进程组里又有很多进程，他们共享同一个控制终端。</p><p>控制终端只能控制前台进程，无法控制后台进程。</p><p>就像我们使用 <code>ctrl + c</code> 无法杀死后台进程，除非用 <code>kill -9</code>。</p><h3 id="18-3-进程组、会话、终端的关系"><a href="#18-3-进程组、会话、终端的关系" class="headerlink" title="18.3 进程组、会话、终端的关系"></a>18.3 进程组、会话、终端的关系</h3><p><img src="https://img-blog.csdnimg.cn/783717fbf22141e0b3541a7a057fc8e8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="18-4-进程组、会话操作函数"><a href="#18-4-进程组、会话操作函数" class="headerlink" title="18.4 进程组、会话操作函数"></a>18.4 进程组、会话操作函数</h3><p><img src="https://img-blog.csdnimg.cn/9ae39b068f02466da40a4db18c1d2e35.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="18-5-守护进程的概念"><a href="#18-5-守护进程的概念" class="headerlink" title="18.5 守护进程的概念"></a>18.5 守护进程的概念</h3><p><img src="https://img-blog.csdnimg.cn/c39e96eaef09429188a690cf92a8b182.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>守护进程不拥有终端，我们没法杀死他。</p><p>他一般用来做一些服务。</p><p>我们远程登陆服务器的 <code>ssh服务</code>也是一个守护进程。</p><h3 id="18-6-创建守护进程"><a href="#18-6-创建守护进程" class="headerlink" title="18.6 创建守护进程"></a>18.6 创建守护进程</h3><p><img src="https://img-blog.csdnimg.cn/4fe12b3096794f5e9571dd85501b7c3f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><ol><li><p>当运行某个进程后，会自动创建一个进程组。</p><p>该首进程的PID会称为进程组的GID。</p><p>我们不能让这个守护进程成为当前进程组的首进程，</p><p>因此通过首进程 frok 一个子进程，随后父进程退出。</p><p>如果父进程自然死亡，shell会给出命令提示符，会非常诡异。</p></li><li><p>为什么要开启一个新的会话？</p><p>因为我们要让该守护进程脱离<code>控制终端</code>。</p><p>前面提到控制终端只能属于一个会话，我们 <code>setsid</code> 之后使得该守护进程被分配到了别的会话，因此它脱离了原会话（即当前拥有控制终端的会话）。从而保证我们无法控制这个新会话，无法控制、杀死守护进程。</p><p>为什么 fork 出来子进程再创建新会话？</p><p>如果我们直接 <code>sigsid</code> ，会导致冲突。</p><p>因为<code>首进程的pid</code>会自动成为<code>进程组的gid</code>，<code>会话首进程的pid</code>会自动成为 <code>会话的sig</code>，产生冲突。</p><p><img src="https://img-blog.csdnimg.cn/f89172b8c2e34a4aa2fcbc8f770d6a72.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>如果我们 fork 出来一个子进程再 <code>setsid</code>， 就没有这种问题了。</p><p><img src="https://img-blog.csdnimg.cn/6c46e03c1a2f4f9a8b66d18a01209d24.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p></li><li><p>为什么要关闭从父进程那里继承过来的所有的文件描述符？</p><p>因为 0, 1, 2 是标准输入输出与错误，仍然指向当前控制终端。如果不关闭可能会向当前终端输出一些奇怪の东西♂。虽然该守护进程脱离了控制终端，但是仍然拥有它自己的终端，只不过我们不能通过当前控制终端去操作它罢了。</p></li></ol><ol start="4"><li><p>为什么改到根目录？</p><p>假如这个进程在U盘中，它的默认工作路径是在U盘的目录中。假如它占用了电脑磁盘上的文件描述符，我们可能无法卸载U盘。</p></li></ol><ol start="5"><li>往 <code>dev/null</code> 中写的数据都会被丢弃到，即使系统调用用到了0，1，2，写了也会被丢弃。如果不打开1，2，3可能会出错。</li></ol><h5 id="示例代码-18"><a href="#示例代码-18" class="headerlink" title="示例代码"></a>示例代码</h5><p>写一个守护进程，每隔两秒获取一下系统时间，并写入磁盘文件当中。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">void</span> <span class="token function">StoreTime</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">time_t</span> curTime <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// long int</span>    <span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>locTime <span class="token operator">=</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>curTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// char buf[128] = {0};</span>    <span class="token comment">// sprintf(buf, "%d-%d-%d %d-%d-%d", locTime-&gt;tm_year, locTime-&gt;tm_mon, locTime-&gt;tm_wday,</span>    <span class="token comment">//                                      locTime-&gt;tm_hour, locTime-&gt;tm_min, locTime-&gt;tm_sec);</span>    <span class="token comment">// printf("%s\n", buf);</span>    <span class="token keyword">char</span> <span class="token operator">*</span>buff <span class="token operator">=</span> <span class="token function">asctime</span><span class="token punctuation">(</span>locTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"time.txt"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_APPEND<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 创建子进程，退出父进程</span>    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 为子进程创建一个新会话</span>    <span class="token comment">// 目的是是守护进程脱离当前控制终端</span>    <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 返回新会话的 SID</span>    <span class="token comment">// 3. 设置掩码，可有可无</span>    <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">022</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 更改工作目录</span>    <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">"/home/Sakana/Mydoc/serverlearn/Process/daemon"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5. 关闭,重定向文件描述符</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"dev2/null"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> STDIN_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> STDERR_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 6. 业务逻辑 每隔两秒获取一下系统时间</span>    <span class="token comment">// 捕捉信号</span>    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>    act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> StoreTime<span class="token punctuation">;</span>    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建定时器</span>    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> val<span class="token punctuation">;</span>    val<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    val<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    val<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    val<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>val<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们可以发现，我们创建的守护进程运行在另一个会话中，该会话不拥有控制终端。</p><p><img src="https://img-blog.csdnimg.cn/38fff26a156347738ea2b5156adfc6e6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>该进程工作在我们制定的目录中，并且实时写入时间数据。</p><p><img src="https://img-blog.csdnimg.cn/cda1e813afd944fc8778f974b7af6a1b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_12,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>在 vim 中使用 <code>:e</code> 可以实时查看更新的数据。</p><p><img src="https://img-blog.csdnimg.cn/251cd081d6814cff96f0974e45dd8167.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_12,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h1 id="累死了-进程这部分终于结束了"><a href="#累死了-进程这部分终于结束了" class="headerlink" title="累死了 进程这部分终于结束了"></a>累死了 进程这部分终于结束了</h1><p>自己写写玩具代码感觉对进程这块理解好多了，之前在csapp中没有看不懂的东西总算懂一点点了。</p><p>继续加油~</p>]]></content>
      
      
      <categories>
          
          <category> 系统编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux文件IO</title>
      <link href="/2022/04/09/Linux%E6%96%87%E4%BB%B6IO/"/>
      <url>/2022/04/09/Linux%E6%96%87%E4%BB%B6IO/</url>
      
        <content type="html"><![CDATA[<h1 id="文件IO"><a href="#文件IO" class="headerlink" title="文件IO"></a>文件IO</h1><h3 id="输入输出是相对的"><a href="#输入输出是相对的" class="headerlink" title="输入输出是相对的"></a>输入输出是相对的</h3><p>对于文件, input为内存-&gt;文件</p><p>​                output为文件-&gt;内存</p><p>对于内存，input为文件-&gt;内存</p><p>​                    output为内存-&gt;文件</p><p>我们站在<code>内存的角度</code>看，因为我们系的程序会被加载到内存中，因此output是从内存到文件，input是从内存到文件</p><p>这一章节会频繁查看Linux的man手册</p><p>1   Executable programs or shell commands （标准命令）</p><p>2   System calls (functions provided by the kernel)    （系统调用）</p><p>3   Library calls (functions within program libraries)（库函数）</p><p>man 1 mkdir 是shell命令 mkdir</p><p>man 2 mkdir 是Linux系统调用 mkdir</p><p>man 3 printf 是库函数 printf</p><h2 id="1-Linux系统IO-amp-标准C库IO"><a href="#1-Linux系统IO-amp-标准C库IO" class="headerlink" title="1. Linux系统IO &amp; 标准C库IO"></a>1. Linux系统IO &amp; 标准C库IO</h2><p><img src="https://img-blog.csdnimg.cn/eb9e955eccd44b7eb4a3457db10c4d9c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="IO函数"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>Java跨平台：为不同的操作系统做一个<code>JVM</code></p><p>标准C库函数跨平台（操作系统）：C库是第三方库跑在不同的操作系统上底层会调用不同操作系统的API。</p><p><code>标准C库的IO函数</code>更高级，更高效（带有缓冲区）。</p><p><code>Linux的IO函数</code>更底层，有特定使用场景，如网络通信（要求通信效率，如果数据还在缓冲区中，对方收不到急死了，直接用Linux系统I/O函数，实时发送）。</p><h5 id="FILE-是一个结构体"><a href="#FILE-是一个结构体" class="headerlink" title="FILE* 是一个结构体"></a>FILE* 是一个结构体</h5><ul><li><p>文件描述符（整型值），指向打开的文件。（Windows操作系统中称为文件句柄）</p></li><li><p>文件读写指针，维护了两个指针，用于操作数据，读数据或写数据。</p></li><li><p>I/O缓冲区，所有的标准C库函数都带有I/O缓冲区</p><p>调用 <code>fopen</code> 之后，该函数会返回一个<code>FILE*类型</code>的<code>文件指针</code>，通过它我们可以操控这个指针指向的磁盘上的文件，<code>fwrite</code>，<code>fread</code>等IO函数都要求传入这个文件指针。</p></li></ul><p><img src="https://img-blog.csdnimg.cn/34f892ad27ca487f939ce7a943756b40.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="fwrite"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>每次调用 <code>fwrite</code>，并不是一下子把数据写到磁盘，而是先写到缓冲区（实质上是<code>内存</code>），一旦缓冲区满了，就调用Linux系统调用，统一写道磁盘中。以此来提高程序执行效率。</p><p>无缓冲区，写一次数据存一次到磁盘，用系统调用直接跟硬件打交道，效率低。</p><p>有缓冲区，统一写到缓冲区中，等满了之后统一打包，调用一次系统调用写道磁盘，效率高。</p><p>因此，有无缓冲区的本质区别是，数据写到<code>内存</code>还是写到<code>磁盘</code>。</p><h5 id="缓冲区什么时候往磁盘写数据？"><a href="#缓冲区什么时候往磁盘写数据？" class="headerlink" title="缓冲区什么时候往磁盘写数据？"></a>缓冲区什么时候往磁盘写数据？</h5><ul><li><p>1.强制刷新缓冲区 <code>fflush</code></p></li><li><p>2.缓冲区已满</p></li><li><p>3.正常关闭文件</p><ul><li><code>fclose</code></li><li><code>return</code> (main 函数)</li><li><code>exit</code> (main 函数)</li></ul></li></ul><p>缓冲区默认 <code>8192byte</code> ≈ <code>9KB</code>，可以人为调节但是不建议，因为这是理想大小。</p><h5 id="标准C库IO-amp-Linux系统IO的关系"><a href="#标准C库IO-amp-Linux系统IO的关系" class="headerlink" title="标准C库IO &amp; Linux系统IO的关系"></a>标准C库IO &amp; Linux系统IO的关系</h5><p><img src="https://img-blog.csdnimg.cn/e693a93b51fa425d82fe3bf34757d407.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="关系"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>缓冲区使命：减少程序与磁盘交换次数</p><h2 id="2-虚拟地址空间"><a href="#2-虚拟地址空间" class="headerlink" title="2. 虚拟地址空间"></a>2. 虚拟地址空间</h2><p><img src="https://img-blog.csdnimg.cn/a3832d28aec144819f687c8c14676ab9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="32位机器的虚拟地址空间"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>虚拟地址空间是对进程的内存的一种抽象，实际不存在。</p><p>直接分配物理内存存在的问题：物理内存不够或断掉……</p><p>在可执行程序运行期间，就会创建这么一个虚拟地址空间，进程结束就不复存在。</p><p>进程是资源分配的最小单位。</p><p><code>程序</code>是磁盘上的代码。</p><p><code>进程</code>是运行中的程序，会被加载到内存中。</p><p>理解应用程序运行时的一些机制，不深究虚拟地址空间的实现方法。</p><p>虚拟地址空间大小由CPU决定， 32位机器有 2<sup>32</sup>byte ≈ 4GB 这么大， 64位机器有 2<sup>48</sup> 这么大。</p><p>虚拟地址空间中的数据会被CPU当中的<code>MMU（内存管理单元）</code>映射到物理内存中。</p><p>即： 虚拟地址 —&gt; MMU —&gt; 物理地址</p><p>虚拟内存占用了4G，但实际上在物理内存中占了不到4G.</p><h5 id="0G-3G-是用户区，普通用户可以操作其中某些空间。"><a href="#0G-3G-是用户区，普通用户可以操作其中某些空间。" class="headerlink" title="0G~ 3G 是用户区，普通用户可以操作其中某些空间。"></a>0G~ 3G 是用户区，普通用户可以操作其中某些空间。</h5><ul><li>受保护的地址 : NULL, nullptr</li><li>.txt : 代码段</li><li>.data：已初始化的 global variable</li><li>.bss：未初始化的global variable</li><li>堆空间(大)：malloc，低地址往高地址生长</li><li>共享库：前几节课学习的动态库</li><li>栈空间(小)：local variable 高地址往低地址生长</li><li>命令行参数：int argc, char *argv[]</li><li>环境变量：每个Linux用户都有环境变量<ul><li><img src="https://img-blog.csdnimg.cn/1526d205cd6b47c4924584b26dc20eed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="Linux下执行env命令查看用户环境变量"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></li></ul></li></ul><h5 id="3G-4G-是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read-write函数）"><a href="#3G-4G-是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read-write函数）" class="headerlink" title="3G ~4G 是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read, write函数）"></a>3G ~4G 是内核区，普通用户无法操作，没有读和写权限。若用户想操作内核区的数据，需要进行系统调用（调用Linux系统API，如read, write函数）</h5><ul><li>内存管理</li><li>进程管理</li><li>设备驱动管理</li><li>VFS虚拟文件系统</li></ul><h2 id="3-文件描述符"><a href="#3-文件描述符" class="headerlink" title="3. 文件描述符"></a>3. 文件描述符</h2><p><img src="https://img-blog.csdnimg.cn/9cfeca140f424a2c9d433423c6830a34.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="懒得写了"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="进程-VS-程序"><a href="#进程-VS-程序" class="headerlink" title="进程 VS 程序"></a>进程 VS 程序</h5><p><img src="https://img-blog.csdnimg.cn/3b7da6b7f6854c24ada790d0ef16cd75.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这里的 test.c源代码文件 和 app可执行文件 都是存储在磁盘上的文件，不占用内存空间。</p><p>当 ./app 之后，程序被加载到内存当中，操作系统创建一个进程，为这个程序的运行分配资源。</p><h5 id="那么，为什么程序当中调用-fopen-以后，调用-fread-和-fwrite-就可以找到磁盘上的文件？"><a href="#那么，为什么程序当中调用-fopen-以后，调用-fread-和-fwrite-就可以找到磁盘上的文件？" class="headerlink" title="那么，为什么程序当中调用 fopen 以后，调用 fread 和 fwrite 就可以找到磁盘上的文件？"></a>那么，为什么程序当中调用 <code>fopen</code> 以后，调用 <code>fread</code> 和 <code>fwrite</code> 就可以找到磁盘上的文件？</h5><p>因为调用fopen以后会返回一个<code>FILE*文件指针</code>，里面封装了一个<code>文件描述符</code>，文件描述符存储在内核区中。</p><p>内核就是一个程序，光有内核还不行，还不能称为OS。OS需要在后台管理所有的资源，并且还有一系列工具，如gcc，gdb等。这一切杂揉起来才成了OS。</p><p>内核区中的<code>PCB(进程控制块)</code>管理文件描述符。PCB是一个结构体，保存管理进程所需要的数据。</p><p>PCB 中有一个<code>数组</code>（因为一个进程可以打开多个文件），里面有一个 <code>文件描述符表</code>，里面存了很多文件描述符，每个描述符定位一个文件。</p><p>其大小默认为<code>1024</code>，最多能同时打开1024个文件。</p><p>文件描述符表中<code>0, 1, 2 (STDIN_FILENO, STDOUT_FILENO, STDERR_FILENO)</code> 默认被占用，默认被打开。他们都对应了同一个设备文件（由此可见，不同的文件描述符可以对应同一个文件），指向<code>当前使用的终端（/dev/tty)</code>。</p><p>一个文件可以被打开多次，但是文件描述符是不一样的，可以打开读，可以打开写。</p><p>当某个文件描述符被占用，内核会找到<code>最小的未被占用的</code>文件描述符，如0,1,2被占用，内核会分配4.</p><p>fclose（C库函数），close（Linux系统IO）可以释放文件描述符，可以被重用了，如0,1,2,3,4,5被占用，释放3之后，下一次分配就会分配3。</p><p><code>一切皆文件</code>，在Linux中所有的硬件设备都会被虚拟成一个文件，通过这个文件管理这些设备。 </p><h5 id="如何得到一个文件描述符？"><a href="#如何得到一个文件描述符？" class="headerlink" title="如何得到一个文件描述符？"></a>如何得到一个文件描述符？</h5><p><code>open</code>：Linux系统API，可以得到一个文件描述符，从而操作该文件描述符指向的文件。下次用 <code>read</code> 或 <code>write</code> 时，就不是传递标准C库的API—— FILE* 了，而是Linux的系统API——文件描述符。</p><h2 id="4-Linux系统IO函数"><a href="#4-Linux系统IO函数" class="headerlink" title="4. Linux系统IO函数"></a>4. Linux系统IO函数</h2><p><img src="https://img-blog.csdnimg.cn/684da67d1cda47e38e26be8e6cc7e062.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="4-1-open"><a href="#4-1-open" class="headerlink" title="4.1 open"></a>4.1 open</h3><h4 id="I-open-打开旧文件"><a href="#I-open-打开旧文件" class="headerlink" title="(I) open 打开旧文件"></a>(I) open 打开旧文件</h4><p>关于open函数的介绍</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       open, openat, creat - open and possibly create a fileSYNOPSIS       #include &lt;sys/types.h&gt;放宏       #include &lt;sys/stat.h&gt;放宏       #include &lt;fcntl.h&gt;这里放函数的声明// 打开一个已存在的文件       int open(const char *pathname, int flags);       // 创建一个新的文件int open(const char *pathname, int flags, mode_t mode);CRIPTION       The  open()  system call opens the file specified by pathname.  If the specified file does not       exist, it may optionally (if O_CREAT is specified in flags) be created by open().       The return value of open() is a file descriptor, a small, nonnegative integer that is used  in       subsequent  system  calls  (read(2),  write(2), lseek(2), fcntl(2), etc.) to refer to the open       file.  The file descriptor returned by a successful call will be the lowest-numbered file  de‐       scriptor not currently open for the process.       By  default,  the  new  file  descriptor  is set to remain open across an execve(2) (i.e., the       FD_CLOEXEC file descriptor flag described in fcntl(2) is initially  disabled);  the  O_CLOEXEC       flag,  described below, can be used to change this default.  The file offset is set to the be‐       ginning of the file (see lseek(2)).       A call to open() creates a new open file description, an entry in  the  system-wide  table  of       open  files.  The open file description records the file offset and the file status flags (see       below).  A file descriptor is a reference to an open file description; this reference is unaf‐       fected if pathname is subsequently removed or modified to refer to a different file.  For fur‐       ther details on open file descriptions, see NOTES.       In  addition,  zero  or  more file creation flags and file status flags can be bitwise-or'd in       flags.  The file creation flags are O_CLOEXEC, O_CREAT, O_DIRECTORY, O_EXCL,  O_NOCTTY,  O_NO‐       FOLLOW,  O_TMPFILE,  and O_TRUNC.  The file status flags are all of the remaining flags listed       below.  The distinction between these two groups of flags is that the file creation flags  af‐       fect the semantics of the open operation itself, while the file status flags affect the seman‐       tics of subsequent I/O operations.  The file status flags can be retrieved and (in some cases)       modified; see fcntl(2) for details.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="不带mode的open函数"><a href="#不带mode的open函数" class="headerlink" title="不带mode的open函数"></a>不带mode的open函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// flag是一些宏，代表文件操作权限，必选且互斥 （只读，只写，可读可写...）</span><span class="token comment">/*参数：pathname:文件路径flags:文件操作权限 &amp; 其他设置 The argument flags [ must ] include [ one of ] the following access  modes: O_RDONLY,  O_WRONLY,  or O_RDWR. These request opening the file read-only, write-only, or read/writie, respectively.返回值:open(),  openat(),  and creat() return the [ new file descriptor ], or [ -1 if an error occurred ] (in which case, [ errno ] is set appropriately).*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="perror详细介绍"><a href="#perror详细介绍" class="headerlink" title="perror详细介绍"></a>perror详细介绍</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*errno 属于Linux系统函数库里的一个全局变量，记录的是最近错误号NAME       perror - print a system error messageSYNOPSIS       #include &lt;stdio.h&gt;       void perror(const char *s);The perror() function produces a message on standard error describing the last error encountered during a call to a system or library function.    First (if s is not NULL and *s is not a null byte ('\0')), the argument string s is printed, followed by a colon and a blank.  Then an error message corresponding to the current value of errno and a new-line.    To be of most use, the argument string should include the name of the function that incurred the error.    The global error list sys_errlist[], which can be indexed by errno, can be used to obtain the error message without the newline.  The largest message number provided in the  table  is  sys_nerr-1.    Be careful when directly accessing this list, because new error values may not have been added to sys_errlist[].  The use of sys_errlist[] is nowadays deprecated; use strerror(3) instead.    When  a  system call fails, it usually returns -1 and sets the variable errno to a value describing what went wrong.  (These values can be found in &lt;errno.h&gt;.)  Many library functions do likewise.    The function perror() serves to translate this error code into human-readable form.  Note that errno is undefined after a successful system call or library function call: this call may well change this  variable, even though it succeeds, for example because it internally used some other library function that failed.  Thus, if a failing call is not immediately followed by a call to perror(), the value of errno should be saved.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="close-函数介绍"><a href="#close-函数介绍" class="headerlink" title="close 函数介绍"></a>close 函数介绍</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       close - close a file descriptorSYNOPSIS       #include &lt;unistd.h&gt;       int close(int fd);DESCRIPTION       close()  closes  a  file  descriptor,  so that it no longer       refers to any file and may be  reused.   Any  record  locks       (see fcntl(2)) held on the file it was associated with, and       owned by the process, are removed (regardless of  the  file       descriptor that was used to obtain the lock).       If fd is the last file descriptor referring to the underly‐       ing open file description (see open(2)), the resources  as‐       sociated  with  the open file description are freed; if the       file descriptor was the last reference to a file which  has       been removed using unlink(2), the file is deleted.RETURN VALUE       close() returns zero on success.  On error, -1 is returned,       and errno is set appropriately.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span><span class="token comment">// 包含宏</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span><span class="token comment">// 包含宏</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span><span class="token comment">// 包含 open 函数</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span><span class="token comment">// 包含 perror 函数</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span><span class="token comment">// 包含 close 函数</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open failed: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// output: open failed: : No such file or directory</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>由于我们当前目录下没有 <code>a.txt</code> 这个文件，因此使用 <code>open</code> 打开必然会出错，perror会捕捉最近的出错标记 errno, 并将错误打印出来。</p></blockquote><h4 id="II-open-创建新文件"><a href="#II-open-创建新文件" class="headerlink" title="(II) open 创建新文件"></a>(II) open 创建新文件</h4><p>一些可选项的man</p><h5 id="O-APPEND"><a href="#O-APPEND" class="headerlink" title="O_APPEND"></a>O_APPEND</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*O_APPEND    The file is opened in append mode.  Before each write(2), the file offset is positioned at the end of the file, as if with lseek(2).  The modification of the file  offset  and the write operation are performed as a single atomic step.    O_APPEND  may  lead  to corrupted files on NFS filesystems if more than one process appends data to a file at once.  This is because NFS does  not  support  appending  to  a file,  so the client kernel has to simulate it, which can't be done without a race condition.  */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="O-CREAT"><a href="#O-CREAT" class="headerlink" title="O_CREAT"></a>O_CREAT</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">O_CREAT    If pathname does not exist<span class="token punctuation">,</span> create it as a regular file<span class="token punctuation">.</span>    The <span class="token function">owner</span> <span class="token punctuation">(</span>user ID<span class="token punctuation">)</span> of the new file is set to the effective user ID of the process<span class="token punctuation">.</span>    The group <span class="token function">ownership</span> <span class="token punctuation">(</span>group ID<span class="token punctuation">)</span> of the new file is set either to the effective group  ID of the <span class="token function">process</span> <span class="token punctuation">(</span>System V semantics<span class="token punctuation">)</span> or to the group ID of the parent <span class="token function">directory</span> <span class="token punctuation">(</span>BSD semantics<span class="token punctuation">)</span><span class="token punctuation">.</span>      On Linux<span class="token punctuation">,</span> the behavior depends on whether the set<span class="token operator">-</span>group<span class="token operator">-</span>ID mode bit  is  set on  the parent directory<span class="token operator">:</span> <span class="token keyword">if</span> that bit is set<span class="token punctuation">,</span> then BSD semantics apply<span class="token punctuation">;</span> otherwise<span class="token punctuation">,</span> System V semantics apply<span class="token punctuation">.</span>  For some filesystems<span class="token punctuation">,</span> the behavior also  depends  on  the  bsd<span class="token operator">-</span>groups and sysvgroups mount options described in <span class="token function">mount</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>        The mode argument specifies the file mode bits be applied when a new file is  created<span class="token punctuation">.</span>   This  argument must  be  supplied when O_CREAT or O_TMPFILE is specified in flags<span class="token punctuation">;</span> <span class="token keyword">if</span> neither O_CREAT nor O_TMPFILE is specified<span class="token punctuation">,</span> then mode is ignored<span class="token punctuation">.</span>  The effective mode is modified by the process's umask  in  the  usual way<span class="token operator">:</span>  in the absence of a <span class="token keyword">default</span> ACL<span class="token punctuation">,</span> the mode of the created file <span class="token function">is</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token operator">~</span>umask<span class="token punctuation">)</span><span class="token punctuation">.</span>  Note that this mode applies only to future accesses of the newly created file<span class="token punctuation">;</span> the <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> call that  creates  a  read<span class="token operator">-</span>only file may well <span class="token keyword">return</span> a read<span class="token operator">/</span>write file descriptor<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="带mode的open函数"><a href="#带mode的open函数" class="headerlink" title="带mode的open函数"></a>带mode的open函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建一个新的文件</span><span class="token comment">/*mode是一个八进制数，表示用户创建出的新的文件的操作权限如0775，0代表八进制7 -&gt; 111 ---&gt; rwx777 -&lt; 111111111 -&gt;rwxrwxrwx5 -&gt; 101 -&gt; r-x -&gt; 没有写的权限umask用于抹去某些权限, umask可以自己设计(只在当前终端有用)root用户 umask = 0022普通用户 umask = 0002假如一个普通用户的权限是 mode = 0777umask = 0002~umask = 0777 - 0002 = 0775mode &amp; ~umask = 0777 &amp; 0775 = 111111111 &amp; 111111101 = 111111101The  mode  argument specifies the file mode bits be applied when a new file is created.This argument must be supplied when 【 O_CREAT or O_TMPFILE 】 is specified in flags; if neither  O_CREAT  nor O_TMPFILE is specified, then mode is ignored.  The effective mode is modified by the process's 【 umask(掩码) 】 in the usual way: in the absence of a default ACL, the mode of the created file is 【 (mode &amp; ~umask) 】(最终得到的权限). Note that this mode applies only to 【 future accesses 】 of the newly created file; the open() call that creates a read-only file may well return a read/write file descriptor.-rw-rw-r--可以分割成四个部分-文件类型rw-当前用户对文件的权限权限rw-当前用户所在的组对文件的权限r--其他组对文件的权限*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/3b914ee95ede4ac9850fba2e076d7aa5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// close</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>  <span class="token comment">// perror</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"create.txt"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"OPEN ERROR:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>  <span class="token comment">// 终端无任何异常</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Linux会为这个程序创建一个新的文件 create.txt（颜色是绿色的，因为我们给他的权限是0777, &amp;上~umask后得到0775， 即 <code>-rwxrwxr-x</code> ）</p></blockquote><h5 id="为什么用-按位或-？"><a href="#为什么用-按位或-？" class="headerlink" title="为什么用 按位或 ？"></a>为什么用 <code>按位或</code> ？</h5><pre class="line-numbers language-none"><code class="language-none">O_RDWR | O_CREAT<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们可以看到 <code>flag</code> 是个 int 类型， 即32位</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这32位每一位都是个标记位，按位或了之后可以把不同的权限组合到一起</p><h3 id="4-2-read-amp-write"><a href="#4-2-read-amp-write" class="headerlink" title="4.2 read &amp; write"></a>4.2 read &amp; write</h3><h5 id="关于write的man"><a href="#关于write的man" class="headerlink" title="关于write的man"></a>关于write的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       read - read from a file descriptorSYNOPSIS       #include &lt;unistd.h&gt;       ssize_t read(int fd, void *buf, size_t count);DESCRIPTION       read() attempts to read up to count bytes from file descriptor fd into the buffer starting at buf.       On  files  that support seeking, the read operation commences at the file offset, and the file offset is incremented by the number of bytes read.  If the file offset is at or past the end of file,       no bytes are read, and read() returns zero.       If count is zero, read() may detect the errors described below.  In the absence of any errors, or if read() does not check for errors, a read() with a count of 0 returns zero and has no other  ef‐       fects.       According to POSIX.1, if count is greater than SSIZE_MAX, the result is implementation-defined; see NOTES for the upper limit on Linux.RETURN VALUE       On  success,  【 the  number of bytes read 】 is returned (【 zero 】 indicates end of file), and the file position is advanced by this number.  It is not an error if this number is smaller than the number of bytes requested; this may happen for example because fewer bytes are actually available right now (maybe because we were close to end-of-file, or because we are reading from a pipe, or from a terminal), or because read() was interrupted by a signal.  See also NOTES.       On error, 【 -1 】 is returned, and errno is set appropriately.  In this case, it is left unspecified whether the file position (if any) changes.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="关于write的man-1"><a href="#关于write的man-1" class="headerlink" title="关于write的man"></a>关于write的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       write - write to a file descriptorSYNOPSIS       #include &lt;unistd.h&gt;       ssize_t write(int fd, const void *buf, size_t count);// fd 通过open得到DESCRIPTION       write() writes up to count bytes from the buffer starting at buf to the file referred to by the file descriptor fd.       The  number  of  bytes  written  may be less than count if, for example, there is insufficient space on the underlying physical medium, or the RLIMIT_FSIZE resource limit is encountered (see setrlimit(2)), or the call was interrupted by a signal handler after having written less than count bytes.  (See also pipe(7).)       For a seekable file (i.e., one to which lseek(2) may be applied, for example, a regular file) writing takes place at the file offset, and the file offset is incremented by the number of bytes  actually  written.   If  the file was open(2)ed with O_APPEND, the file offset is first set to the end of the file before writing.  The adjustment of the file offset and the write operation are performed as an atomic step.       POSIX requires that a read(2) that can be proved to occur after a write() has returned will return the new data.  Note that not all filesystems are POSIX conforming.       According to POSIX.1, if count is greater than SSIZE_MAX, the result is implementation-defined; see NOTES for the upper limit on Linux.RETURN VALUE       On success, 【 the number of bytes written 】 is returned.  On error, 【 -1 】 is returned, and errno is set to indicate the cause of the error.       Note that a successful write() may transfer fewer than count bytes.  Such partial writes can occur for various reasons; for example, because there was insufficient space  on  the  disk  device  to write all of the requested bytes, or because a blocked write() to a socket, pipe, or similar was interrupted by a signal handler after it had transferred some, but before it had transferred all of the requested bytes.  In the event of a partial write, the caller can make another write() call to transfer the remaining bytes.  The subsequent call will either transfer further bytes or may  result in an error (e.g., if the disk is now full).       If  count is zero and fd refers to a regular file, then write() may return a failure status if one of the errors below is detected.  If no errors are detected, or error detection is not performed, 0 will be returned without causing any other effect.  If count is zero and fd refers to a file other than a regular file, the results are not specified.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-（文件拷贝）"><a href="#测试代码-（文件拷贝）" class="headerlink" title="测试代码 （文件拷贝）"></a>测试代码 （文件拷贝）</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token number">1</span>#include <span class="token operator">&lt;</span>unistd<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token number">2</span> #include <span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token number">3</span> #include <span class="token operator">&lt;</span>sys<span class="token operator">/</span>types<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token number">4</span> #include <span class="token operator">&lt;</span>sys<span class="token operator">/</span>stat<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token number">5</span> #include <span class="token operator">&lt;</span>fcntl<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token number">9</span> <span class="token punctuation">{</span><span class="token number">10</span><span class="token number">11</span>     <span class="token comment">// 1. open ---&gt; 打开源文件</span><span class="token number">12</span>     <span class="token keyword">int</span> srcfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"english.txt"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">13</span><span class="token number">14</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>srcfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">15</span>     <span class="token punctuation">{</span><span class="token number">16</span>         <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">17</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token number">18</span>     <span class="token punctuation">}</span><span class="token number">19</span><span class="token number">20</span><span class="token number">21</span>     <span class="token comment">// 2. 创建一个新的目标文件</span><span class="token number">22</span>     <span class="token keyword">int</span> destfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"newEnglish.txt"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">23</span><span class="token number">24</span>     <span class="token keyword">if</span><span class="token punctuation">(</span>destfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">25</span>     <span class="token punctuation">{</span><span class="token number">26</span>         <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">27</span>         <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token number">28</span>     <span class="token punctuation">}</span><span class="token number">29</span><span class="token number">30</span><span class="token number">31</span>     <span class="token comment">// 3. 频繁的读写操作</span><span class="token number">32</span>     <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token number">33</span><span class="token number">34</span>     <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token number">35</span>     <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>srcfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token number">36</span>         <span class="token function">write</span><span class="token punctuation">(</span>destfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">37</span><span class="token number">38</span><span class="token number">39</span>     <span class="token comment">// 4. 关闭文件</span><span class="token number">40</span>     <span class="token function">close</span><span class="token punctuation">(</span>srcfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">41</span>     <span class="token function">close</span><span class="token punctuation">(</span>destfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">42</span><span class="token number">43</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token number">44</span><span class="token number">45</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-3-lseek"><a href="#4-3-lseek" class="headerlink" title="4.3 lseek"></a>4.3 lseek</h3><h5 id="关于C库-fseek-和Linux系统下-lseek-的man"><a href="#关于C库-fseek-和Linux系统下-lseek-的man" class="headerlink" title="关于C库 fseek 和Linux系统下 lseek 的man"></a>关于C库 <code>fseek</code> 和Linux系统下 <code>lseek</code> 的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*// fseekNAME       fgetpos, fseek, fsetpos, ftell, rewind - reposition a streamSYNOPSIS       #include &lt;stdio.h&gt;       int fseek(FILE *stream, long offset, int whence);       long ftell(FILE *stream);       void rewind(FILE *stream);       int fgetpos(FILE *stream, fpos_t *pos);       int fsetpos(FILE *stream, const fpos_t *pos);DESCRIPTION       The  fseek() function sets the file position indicator for the stream pointed to by stream.  The new position, measured in bytes, is obtained by 【 adding offset bytes to the position specified by whence 】.  If whence is set to SEEK_SET, SEEK_CUR, or SEEK_END,  the  offset is relative to the start of the file, the current position indicator, or end-of-file, respectively.       A successful call to the fseek() function clears the end-of-file indicator for the stream and undoes any  effects  of  the ungetc(3) function on the same stream.       The ftell() function obtains the current value of the file position indicator for the stream pointed to by stream.       The  rewind()  function sets the file position indicator for the stream pointed to by stream to the beginning of the file. It is equivalent to:              (void) fseek(stream, 0L, SEEK_SET)               except that the error indicator for the stream is also cleared (see clearerr(3)).       The fgetpos() and fsetpos() functions are alternate interfaces equivalent to ftell()  and  fseek()  (with  whence  set  to SEEK_SET),  setting  and  storing the current value of the file offset into or from the object referenced by pos.  On some non-UNIX systems, an fpos_t object may be a complex object and these routines may be the only way to portably reposition a text stream.RETURN VALUE       The  rewind()  function returns no value.  Upon successful completion, fgetpos(), fseek(), fsetpos() return 0, and ftell() returns the current offset.  Otherwise, -1 is returned and errno is set to indicate the error.       */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*// lseekNAME       lseek - reposition read/write file offsetSYNOPSIS       #include &lt;sys/types.h&gt;       #include &lt;unistd.h&gt;       off_t lseek(int fd, off_t offset, int whence);              参数：       fd: 文件描述符，通过open()得到       offset: 偏移量       whence:        SEEK_SET: 设置文件指针的偏移量       SEEK_CUR: 设置偏移量， 当前位置 + offset       SEEK_END: 设置偏移量， 文件大小 + offset       DESCRIPTION       lseek()  【 repositions  the  file offset of the open file description 】 associated with the file descriptor fd to the argument offset according to the directive whence as follows:       SEEK_SET              The file offset is set to 【 （begin） + offset bytes 】.       SEEK_CUR              The file offset is set to its 【 current location 】 plus 【 offset bytes 】.       SEEK_END              The file offset is set to 【 the size of the file 】 plus 【 offset bytes 】.       lseek() allows the file offset to be set beyond the end of the file (but this does not change the size of the  file).   If data  is  later  written  at this point, subsequent reads of the data in the gap (a "hole") return null bytes ('\0') until data is actually written into the gap.       */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5><ul><li><ol><li><p>移动文件指针到【头文件】位置，不然要关闭文件再打开，重新运行了</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol></li><li><ol start="2"><li><p>获取当前文件的位置</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_CUR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol></li><li><ol start="3"><li><p>获取文件大小</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol></li><li><ol start="4"><li><p>拓展文件长度</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果当前文件10b, 扩展后为110b</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h5 id="测试代码-获取当前指针位置"><a href="#测试代码-获取当前指针位置" class="headerlink" title="测试代码 (获取当前指针位置)"></a>测试代码 (获取当前指针位置)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 扩展文件长度</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_CUR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"lseek : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> res2 <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_CUR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                                           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件指针刚开始在 %d byte 处， 目前在 %d byte 处\n"</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> res2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// output: 文件指针刚开始在 0 byte 处， 目前在 32 byte 处</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-拓展文件长度"><a href="#测试代码-拓展文件长度" class="headerlink" title="测试代码 (拓展文件长度)"></a>测试代码 (拓展文件长度)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span><span class="token comment">// 宏</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span><span class="token comment">// 宏</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span><span class="token comment">// open</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span><span class="token comment">// lseek</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span><span class="token comment">// perror / close</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 扩展文件长度</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"lseek : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 写入空串</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>假如原先的 <code>a.txt</code> 里面有6个byte, 这么一扩展，文件变成了6 + 1 + 100个byte</p></blockquote></li></ul><h5 id="为什么要扩展文件大小？"><a href="#为什么要扩展文件大小？" class="headerlink" title="为什么要扩展文件大小？"></a>为什么要扩展文件大小？</h5><p>例如，在下载文件时，这个文件有5G大，慢慢下载的过程中发现空间不够了就出大问题了。因而，在下载之前就先占用5G的空间，下载的过程中慢慢往里面写数据，可以保证磁盘空间一定够用。</p><h3 id="4-4-stat-amp-lstat"><a href="#4-4-stat-amp-lstat" class="headerlink" title="4.4 stat &amp; lstat"></a>4.4 stat &amp; lstat</h3><h5 id="stat的man"><a href="#stat的man" class="headerlink" title="stat的man"></a>stat的man</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/*NAME       stat, fstat, lstat, fstatat - get file statusSYNOPSIS       #include &lt;sys/types.h&gt;       #include &lt;sys/stat.h&gt;       #include &lt;unistd.h&gt;       int stat(const char *pathname, struct stat *statbuf);       参数：       pathname 文件路径       statbuf 是一个传出参数，用于保存或得到的文件信息       RETURN VALUE           On success, zero is returned.             On error, -1 is returned, and errno is set appropriately.DESCRIPTION       These functions 【 return information about a file 】, in the buffer pointed to by statbuf.  No permissions are required  on  the  file  itself,  but in  the  case  of  stat(),  fstatat(),  and lstat()—execute  (search)  permission  is  required on all of the directories in pathname that lead to the file.       stat() and fstatat() retrieve information about the file pointed to by pathname;  the  differences for fstatat() are described below.       */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="lstat的man"><a href="#lstat的man" class="headerlink" title="lstat的man"></a>lstat的man</h5><p>lstat 单纯用来获取 <code>软链接类型</code> 文件本身的信息</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*int lstat(const char *pathname, struct stat *statbuf);lstat()  is  identical  to stat(), except that if pathname is a 【 symbolic link 】, then it returns information about 【 the link itself, not the file that it refers to 】.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="struct-stat-这个传出参数里是什么？"><a href="#struct-stat-这个传出参数里是什么？" class="headerlink" title="struct stat 这个传出参数里是什么？"></a><code>struct stat</code> 这个传出参数里是什么？</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// The stat structure</span>       <span class="token comment">// All of these system calls return a stat structure, which contains the following fields:</span>           <span class="token keyword">struct</span> <span class="token class-name">stat</span> <span class="token punctuation">{</span>               <span class="token class-name">dev_t</span>     st_dev<span class="token punctuation">;</span>         <span class="token comment">/* ID of device containing file */</span>               <span class="token class-name">ino_t</span>     st_ino<span class="token punctuation">;</span>         <span class="token comment">/* Inode number */</span>               <span class="token class-name">mode_t</span>    st_mode<span class="token punctuation">;</span>        <span class="token comment">/* File type and mode */</span>               <span class="token class-name">nlink_t</span>   st_nlink<span class="token punctuation">;</span>       <span class="token comment">/* Number of hard links */</span>               <span class="token class-name">uid_t</span>     st_uid<span class="token punctuation">;</span>         <span class="token comment">/* User ID of owner */</span>               <span class="token class-name">gid_t</span>     st_gid<span class="token punctuation">;</span>         <span class="token comment">/* Group ID of owner */</span>               <span class="token class-name">dev_t</span>     st_rdev<span class="token punctuation">;</span>        <span class="token comment">/* Device ID (if special file) */</span>               <span class="token class-name">off_t</span>     st_size<span class="token punctuation">;</span>        <span class="token comment">/* Total size, in bytes */</span>               <span class="token class-name">blksize_t</span> st_blksize<span class="token punctuation">;</span>     <span class="token comment">/* Block size for filesystem I/O */</span>               <span class="token class-name">blkcnt_t</span>  st_blocks<span class="token punctuation">;</span>      <span class="token comment">/* Number of 512B blocks allocated */</span>               <span class="token comment">/* Since Linux 2.6, the kernel supports nanosecond                  precision for the following timestamp fields.                  For the details before Linux 2.6, see NOTES. */</span>               <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_atim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last access */</span>               <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_mtim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last modification */</span>               <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_ctim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last status change */</span>           <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">st_atime</span> <span class="token expression">st_atim<span class="token punctuation">.</span>tv_sec      </span><span class="token comment">/* Backward compatibility */</span></span>           <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">st_mtime</span> <span class="token expression">st_mtim<span class="token punctuation">.</span>tv_sec</span></span>           <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">st_ctime</span> <span class="token expression">st_ctim<span class="token punctuation">.</span>tv_sec</span></span>           <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="shell-中的-stat命令"><a href="#shell-中的-stat命令" class="headerlink" title="shell 中的 stat命令"></a>shell 中的 <code>stat命令</code></h5><p>在shell中使用 <code>stat filename</code> 可以查看一个文件的信息。</p><p>内容为 HELLO, WORLD!</p><p><img src="https://img-blog.csdnimg.cn/50605a172fa245479555011d1cb0c183.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/fc4732e0a51f4d54b69f6c868539080d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>判断一个文件对于三种用户是否可读可写可执行 —&gt; st_mode &amp; 对应的宏值</p><p>判断是什么类型 —&gt; (st_mode &amp; S_IMFT) == 对应的宏   （其中， S_IMFT == 0170000）</p><p>普通文件 <code>0664</code>，最高权限 <code>0777</code>(但是会被 <code>umask</code> 抹去一些权限)</p><h5 id="stat-测试代码-获取文件大小"><a href="#stat-测试代码-获取文件大小" class="headerlink" title="stat 测试代码 (获取文件大小)"></a>stat 测试代码 (获取文件大小)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">struct</span> <span class="token class-name">stat</span> statbuf<span class="token punctuation">;</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"stat : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size : %ld\n"</span><span class="token punctuation">,</span> statbuf<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-判断一个文件对于usr的权限"><a href="#测试代码-判断一个文件对于usr的权限" class="headerlink" title="测试代码 (判断一个文件对于usr的权限)"></a>测试代码 (判断一个文件对于usr的权限)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">struct</span> <span class="token class-name">stat</span> statbuf<span class="token punctuation">;</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"stat : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"该文件对于当前用户是否可写可读可执行？: %o\n"</span><span class="token punctuation">,</span> statbuf<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IRWXU<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/92af7771d9d6469190dc816df40a68fa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="关于软链接的man"><a href="#关于软链接的man" class="headerlink" title="关于软链接的man"></a>关于软链接的man</h5><p><img src="https://img-blog.csdnimg.cn/9c01c663280747bca86bd5c9aeeaab66.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>使用 <code>ln -s filename1 filename2</code> 可以创建一个软链接， filename2 -&gt; filename1</p><p>两个文件打开是同样的内容。</p><p>因此如果用 stat 来获取软链接的信息，则会获取其主人的信息；</p><p>若用 lstat 则会获取软链接的信息。</p><p><img src="https://img-blog.csdnimg.cn/c71afa0eb57143f7968a590f315f72e7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/f215916ec47949888754a1dfef966236.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/987061f877f44b60a123a5b24b394c3b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="lstat-测试代码"><a href="#lstat-测试代码" class="headerlink" title="lstat 测试代码"></a>lstat 测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">struct</span> <span class="token class-name">stat</span> statbuf<span class="token punctuation">;</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">lstat</span><span class="token punctuation">(</span><span class="token string">"b.txt"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 只是函数名从普通的 stat 变成了获取软链接文件信息的 lstat</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"stat : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size : %ld\n"</span><span class="token punctuation">,</span> statbuf<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-5-模拟实现-ls-l-命令"><a href="#4-5-模拟实现-ls-l-命令" class="headerlink" title="4.5 模拟实现 ls -l 命令"></a>4.5 模拟实现 <code>ls -l</code> 命令</h3><h5 id="关于-getpwuid-函数"><a href="#关于-getpwuid-函数" class="headerlink" title="关于 getpwuid() 函数"></a>关于 <code>getpwuid()</code> 函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       getpwuidSYNOPSIS       #include &lt;sys/types.h&gt;       #include &lt;pwd.h&gt;       struct passwd *getpwuid(uid_t uid);   Feature Test Macro Requirements for glibc (see feature_test_macros(7)):DESCRIPTION       The  getpwuid() function returns a pointer to a structure containing the broken-out fields of       【 the record in the password database 】 that matches the user ID uid.       The passwd structure is defined in &lt;pwd.h&gt; as follows:           struct passwd {               char   *pw_name;       /* username */</span>               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_passwd<span class="token punctuation">;</span>     <span class="token comment">/* user password */</span>               <span class="token class-name">uid_t</span>   pw_uid<span class="token punctuation">;</span>        <span class="token comment">/* user ID */</span>               <span class="token class-name">gid_t</span>   pw_gid<span class="token punctuation">;</span>        <span class="token comment">/* group ID */</span>               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_gecos<span class="token punctuation">;</span>      <span class="token comment">/* user information */</span>               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_dir<span class="token punctuation">;</span>        <span class="token comment">/* home directory */</span>               <span class="token keyword">char</span>   <span class="token operator">*</span>pw_shell<span class="token punctuation">;</span>      <span class="token comment">/* shell program */</span>           <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="关于-getgrgid-函数"><a href="#关于-getgrgid-函数" class="headerlink" title="关于 getgrgid() 函数"></a>关于 <code>getgrgid() </code>函数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       getgrgidSYNOPSIS       #include &lt;sys/types.h&gt;       #include &lt;grp.h&gt;       struct group *getgrgid(gid_t gid);DESCRIPTION       The  getgrgid() function returns a pointer to a structure containing the broken-out fields of       【 the record in the group database 】 that matches the group ID gid.       The group structure is defined in &lt;grp.h&gt; as follows:           struct group {               char   *gr_name;        /* group name */</span>               <span class="token keyword">char</span>   <span class="token operator">*</span>gr_passwd<span class="token punctuation">;</span>      <span class="token comment">/* group password */</span>               <span class="token class-name">gid_t</span>   gr_gid<span class="token punctuation">;</span>         <span class="token comment">/* group ID */</span>               <span class="token keyword">char</span>  <span class="token operator">*</span><span class="token operator">*</span>gr_mem<span class="token punctuation">;</span>         <span class="token comment">/* NULL-terminated array of pointers                                          to names of group members */</span>           <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-6-文件属性操作函数"><a href="#4-6-文件属性操作函数" class="headerlink" title="4.6 文件属性操作函数"></a>4.6 文件属性操作函数</h3><p><img src="https://img-blog.csdnimg.cn/c85e57c0c22f4063a7e93c9097127b97.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="access"><a href="#access" class="headerlink" title="access"></a>access</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       access, faccessat - check user's permissions for a fileSYNOPSIS       #include &lt;unistd.h&gt;       int access(const char *pathname, int mode);DESCRIPTION       access() 【 checks whether the calling process can access the file pathname 】.  If pathname is a symbolic link, it is dereferenced.       The  mode specifies 【 the accessibility check(s) to be performed 】, and is either the value F_OK, or a mask consisting of the bitwise OR of one or more of R_OK, W_OK, and X_OK.  【 F_OK 】 tests for the existence of the file. 【 R_OK 】, 【 W_OK 】, and 【 X_OK 】 test whether the file exists and grants read, write, and execute permissions, respectively.       The check is done using the calling process's real UID and GID, rather than the effective IDs as is done when actually attempting an operation (e.g., open(2)) on the file.  Similarly, for the root user, the check uses the set of permitted capabilities rather than the set of effective capabilities; and for non-root users, the check uses an empty set of capabilities.       This  allows  set-user-ID  programs  and capability-endowed programs to easily determine the invoking user's authority.  In other words, access() does not answer the "can I read/write/execute this file?" question.  It answers a slightly different question: "(assuming I'm a setuid binary) can the user who invoked me read/write/execute this file?", which gives set-user-ID programs the  possibility to prevent malicious users from causing them to read files which users shouldn't be able to read.       If the calling process is privileged (i.e., its real UID is zero), then an X_OK check is successful for a regular file if execute permission is enabled for any of the file owner, group, or other.       RETURN VALUE       On success (all requested permissions granted, or mode is F_OK and the file exists), 【 zero 】 is returned.  On error (at least one bit in mode asked for a permission that is denied, or  mode  is  F_OK and the file does not exist, or some other error occurred), 【 -1 】 is returned, and errno is set appropriately.       */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"access"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"file exists!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//（第三人称单数）</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a>chmod</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       chmod, fchmod, fchmodat - change permissions of a fileSYNOPSIS       #include &lt;sys/stat.h&gt;       int chmod(const char *pathname, mode_t mode);       DESCRIPTION       The  chmod() and fchmod() system calls 【change a files mode bits】.  (The file mode consists of the file permission bits plus the set-user-ID, set-group-ID, and sticky bits.)  These system calls differ only in how the file is specified:       * chmod() changes the mode of the file specified whose pathname is given in pathname, which is dereferenced if it is a symbolic link.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-3"><a href="#测试代码-3" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token number">0775</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"chmod"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"change mode successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/cbf926df87d24d35987825480fb47ff6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="chown"><a href="#chown" class="headerlink" title="chown"></a>chown</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*NAME       chown, fchown, lchown, fchownat - change ownership of a fileSYNOPSIS       #include &lt;unistd.h&gt;       int chown(const char *pathname, uid_t owner, gid_t group);DESCRIPTION       These  system calls 【change the owner and group】 of a file.  The chown(), fchown(), and lchown() system calls differ only in how the file is specified:       * chown() changes the ownership of the file specified by pathname, which is dereferenced if it is a symbolic link.       Only a privileged process (Linux: one with the CAP_CHOWN capability) may change the owner of a file.  The owner of a  file       may  change  the  group  of  the  file  to  any  group of which that owner is a member.  A privileged process (Linux: with       CAP_CHOWN) may change the group arbitrarily.       If the owner or group is specified as -1, then that ID is not changed.       When the owner or group of an executable file is changed by an unprivileged user, the S_ISUID and S_ISGID  mode  bits  are cleared.  POSIX does not specify whether this also should happen when root does the chown(); the Linux behavior depends on the kernel version, and since Linux 2.2.13, root is treated like other users.  In  case  of  a  non-group-executable  file (i.e.,  one  for  which  the  S_IXGRP bit is not set) the S_ISGID bit indicates mandatory locking, and is not cleared by a chown().       When the owner or group of an executable file is changed (by any user), all capability sets for the file are cleared.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过  <code>vim /etc/passwd</code> 可以查看该机器上的所有用户， <code>vim /etc/group</code> 可以查看所有的组。</p><p>通过 <code>useradd userName</code> 可以创建一个名为 userName 的新用户，可以用 <code>id userName</code> 查看该用户的uid,gid和group。</p><p><img src="https://img-blog.csdnimg.cn/2a258fe3cc904603b11160136e184799.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_19,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/2128a7806a3844e788ea4b4b314b6b31.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="测试代码-4"><a href="#测试代码-4" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">chown</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token number">1002</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 更改文件 a.txt 的uid &amp; gid</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"chown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"change uid and group successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/56666fd41a984da78b6abc3db806e087.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="truncate"><a href="#truncate" class="headerlink" title="truncate"></a>truncate</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       truncate<span class="token punctuation">,</span> ftruncate <span class="token operator">-</span> truncate a file to a specified lengthSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token class-name">off_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">int</span> <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>   Feature Test Macro Requirements <span class="token keyword">for</span> <span class="token function">glibc</span> <span class="token punctuation">(</span>see <span class="token function">feature_test_macros</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span>       <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>           _XOPEN_SOURCE <span class="token operator">&gt;=</span> <span class="token number">500</span>               <span class="token operator">||</span> <span class="token comment">/* Since glibc 2.12: */</span> _POSIX_C_SOURCE <span class="token operator">&gt;=</span> <span class="token number">200809L</span>               <span class="token operator">||</span> <span class="token comment">/* Glibc versions &lt;= 2.19: */</span> _BSD_SOURCE       <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>           _XOPEN_SOURCE <span class="token operator">&gt;=</span> <span class="token number">500</span>               <span class="token operator">||</span> <span class="token comment">/* Since glibc 2.3.5: */</span> _POSIX_C_SOURCE <span class="token operator">&gt;=</span> <span class="token number">200112L</span>               <span class="token operator">||</span> <span class="token comment">/* Glibc versions &lt;= 2.19: */</span> _BSD_SOURCEDESCRIPTION       The  <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  and  <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  functions cause the regular file named by path or referenced by fd to 【be truncated to a size of precisely length bytes】<span class="token punctuation">.</span>       If the file previously was larger than this size<span class="token punctuation">,</span> the extra data is lost<span class="token punctuation">.</span>                <span class="token comment">// 大变小 ---&gt; 截断</span>                  If the file previously was shorter<span class="token punctuation">,</span> it is  extended<span class="token punctuation">,</span> and the extended part reads as null <span class="token function">bytes</span> <span class="token punctuation">(</span><span class="token char">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>               <span class="token comment">// 小变大 ---&gt; '\0'填充</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-5"><a href="#测试代码-5" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span><span class="token comment">// perror</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span><span class="token comment">// atoi()</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">truncate</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"truncate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"truncate the file %s to %s bytes successfully!\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/00f304b3d35e4eb182a3f1a47efe8471.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="4-7-目录操作函数"><a href="#4-7-目录操作函数" class="headerlink" title="4.7 目录操作函数"></a>4.7 目录操作函数</h3><p><img src="https://img-blog.csdnimg.cn/7f04549c167645a78739282ec94bc75c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       mkdir<span class="token punctuation">,</span> mkdirat <span class="token operator">-</span> create a directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>       DESCRIPTION       <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> attempts to 【create a directory】 named pathname<span class="token punctuation">.</span>       The  argument  mode  specifies the mode <span class="token keyword">for</span> the new directory<span class="token punctuation">.</span>  It is modified by the process's umask in the usual way<span class="token operator">:</span> in the absence of a <span class="token keyword">default</span> ACL<span class="token punctuation">,</span> the mode of the created directory <span class="token function">is</span> <span class="token punctuation">(</span>【mode <span class="token operator">&amp;</span> <span class="token operator">~</span>umask <span class="token operator">&amp;</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">.</span>          Whether  other  mode bits are honored <span class="token keyword">for</span> the created directory depends on the operating system<span class="token punctuation">.</span>       The newly created directory will be owned by the effective user ID of the process<span class="token punctuation">.</span>  If the directory  containing  the file has the set<span class="token operator">-</span>group<span class="token operator">-</span>ID bit set<span class="token punctuation">,</span> or <span class="token keyword">if</span> the filesystem is mounted with BSD group <span class="token function">semantics</span> <span class="token punctuation">(</span>mount <span class="token operator">-</span>o grpid<span class="token punctuation">)</span><span class="token punctuation">,</span> the new directory will inherit the group ownership from  its  parent<span class="token punctuation">;</span> otherwise it will be owned by the effective group ID of the process<span class="token punctuation">.</span>       If the parent directory has the set<span class="token operator">-</span>group<span class="token operator">-</span>ID bit set<span class="token punctuation">,</span> then so will the newly created directory<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-6"><a href="#测试代码-6" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">mkdir</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// argv[1]是文件名，0664是文件的权限</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkdir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"make a directory '%s' successfully!\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/0ab1c3a42d9246d5bd2e77eac4c93dcb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="rename"><a href="#rename" class="headerlink" title="rename"></a>rename</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       rename<span class="token punctuation">,</span> renameat<span class="token punctuation">,</span> renameat2 <span class="token operator">-</span> change the name or location of a fileSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>oldpath<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>newpath<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  renames  a  file<span class="token punctuation">,</span> moving it between directories <span class="token keyword">if</span> required<span class="token punctuation">.</span>  Any other  【hard links】 to the file  are 【unaffected】<span class="token punctuation">.</span>  【Open file descriptors <span class="token keyword">for</span> oldpath】 are also 【unaffected】<span class="token punctuation">.</span>       Various restrictions determine whether or not the rename operation succeeds<span class="token operator">:</span> see ERRORS below<span class="token punctuation">.</span>       If newpath already exists<span class="token punctuation">,</span> it will be atomically replaced<span class="token punctuation">,</span> so that there is no point at which another  process  attempting to  access newpath will find it missing<span class="token punctuation">.</span>  However<span class="token punctuation">,</span> there will probably be a window in which both oldpath and newpath refer to the file being renamed<span class="token punctuation">.</span>       If oldpath and newpath are existing hard links referring to the same file<span class="token punctuation">,</span> then <span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span> does nothing<span class="token punctuation">,</span> and returns a  success status<span class="token punctuation">.</span>       If newpath exists but the operation fails <span class="token keyword">for</span> some reason<span class="token punctuation">,</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span> guarantees to leave an instance of newpath in place<span class="token punctuation">.</span>       oldpath can specify a directory<span class="token punctuation">.</span>  In this <span class="token keyword">case</span><span class="token punctuation">,</span> newpath must either not exist<span class="token punctuation">,</span> or it must specify an empty directory<span class="token punctuation">.</span>       If  oldpath  refers  to a symbolic link<span class="token punctuation">,</span> the link is renamed<span class="token punctuation">;</span> <span class="token keyword">if</span> newpath refers to a symbolic link<span class="token punctuation">,</span> the link will be overwritten<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-7"><a href="#测试代码-7" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">"987"</span><span class="token punctuation">,</span> <span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"rename"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/9224a038315a424086f9188ed2608221.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="rmdir"><a href="#rmdir" class="headerlink" title="rmdir"></a>rmdir</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       rmdir <span class="token operator">-</span> delete a directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> deletes a directory<span class="token punctuation">,</span> which 【must be empty】<span class="token punctuation">.</span>RETURN VALUE       On success<span class="token punctuation">,</span> zero is returned<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-8"><a href="#测试代码-8" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.hz&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"rmdir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/37687eff84034a51aa78cd6a00b9f5e5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="getcwd"><a href="#getcwd" class="headerlink" title="getcwd"></a>getcwd</h5><p>获取当前工作目录。</p><ul><li><p>buf：传出参数，指向一个数组，存工作路径</p></li><li><p>size：数组大小</p></li><li><p>return value：指针，指向一块内存，存的是工作路径，内容和buf一样</p></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       getcwd<span class="token punctuation">,</span> getwd<span class="token punctuation">,</span> get_current_dir_name <span class="token operator">-</span> get current working directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getwd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">get_current_dir_name</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       These  functions  <span class="token keyword">return</span> a null<span class="token operator">-</span>terminated string containing 【an absolute pathname】 that is the current working directory of the calling process<span class="token punctuation">.</span>  The pathname is returned as the function 【result】 and via the argument 【buf】<span class="token punctuation">,</span> <span class="token keyword">if</span> present<span class="token punctuation">.</span>       The <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function copies an absolute pathname of the current working directory to the array pointed to by  buf<span class="token punctuation">,</span>  which is of length size<span class="token punctuation">.</span>       If the length of the absolute pathname of the current working directory<span class="token punctuation">,</span> including the terminating null byte<span class="token punctuation">,</span> exceeds size bytes<span class="token punctuation">,</span> <span class="token constant">NULL</span> is returned<span class="token punctuation">,</span> and errno is set to ERANGE<span class="token punctuation">;</span> an application should check <span class="token keyword">for</span> this error<span class="token punctuation">,</span>  and  allocate  a  larger buffer <span class="token keyword">if</span> necessary<span class="token punctuation">.</span>       As  an extension to the POSIX<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">2001</span> standard<span class="token punctuation">,</span> glibc's <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> allocates the buffer dynamically using <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">if</span> buf is <span class="token constant">NULL</span><span class="token punctuation">.</span>  In this <span class="token keyword">case</span><span class="token punctuation">,</span> the allocated buffer has the length size unless size is zero<span class="token punctuation">,</span> when buf is allocated as big as  necessary<span class="token punctuation">.</span>  The caller should <span class="token function">free</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> the returned buffer<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-9"><a href="#测试代码-9" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>ret <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"getcwd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current working directory is : \n%s\n or \n%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/2c2e5de7e03a4a4d884b51d687373521.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="chdir"><a href="#chdir" class="headerlink" title="chdir"></a>chdir</h5><p>修改进程的工作目录，在哪个目录启动进程，该进程就默认工作在该目录下。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       chdir<span class="token punctuation">,</span> fchdir <span class="token operator">-</span> change working directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">int</span> <span class="token function">fchdir</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 【changes the current working directory】 of 【the calling process】 to the directory specified in path<span class="token punctuation">.</span>       <span class="token function">fchdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is identical to <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> the only difference is that the directory is given as an open file descriptor<span class="token punctuation">.</span>RETURN VALUE       On success<span class="token punctuation">,</span> zero is returned<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-10"><a href="#测试代码-10" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 获取该进程默认工作路径</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>path <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>path <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"getcwd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current working directory is : \n%s\n or \n%s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 更改工作目录</span>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">"/home/Sakana/Mydoc/serverlearn/IO/文件操作函数/ajacentDir/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"chdir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token comment">// 获取新工作目录</span>    <span class="token keyword">char</span> newbuf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>newPath <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>newbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>newbuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n*** change woring dir successfully! ***\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current working directory is : \n%s\n or \n%s\n"</span><span class="token punctuation">,</span> newbuf<span class="token punctuation">,</span> newPath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 在新工作目录里写点东西</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"testFile.txt"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> pbuf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                                                                         <span class="token function">sprintf</span><span class="token punctuation">(</span>pbuf<span class="token punctuation">,</span> <span class="token string">"Hello, world! I'm form %s \n Here is %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> newPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> pbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pbuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/4ab1c16fa3b8469a947de470ddb74d12.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/3e736f67598743509ee62f230f0a9499.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/ca2f9844797f488dabc82e4dea0c0835.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="4-8-目录遍历函数"><a href="#4-8-目录遍历函数" class="headerlink" title="4.8 目录遍历函数"></a>4.8 目录遍历函数</h3><p><img src="https://img-blog.csdnimg.cn/49c68acc32d34de8a79a88b12615b490.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="opendir"><a href="#opendir" class="headerlink" title="opendir"></a>opendir</h5><ul><li>name：需要打开的目录名称</li><li>return value: <ul><li>正确：<code>DIR*</code>  类型的结构体，可以理解为目录流</li><li>错误：NULL</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       opendir<span class="token punctuation">,</span> fdopendir <span class="token operator">-</span> open a directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>       DIR <span class="token operator">*</span><span class="token function">opendir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>       DIR <span class="token operator">*</span><span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       The  <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  function 【opens a directory stream】 corresponding to the directory name<span class="token punctuation">,</span> and 【returns a pointer】 to the directory stream<span class="token punctuation">.</span>  The stream is positioned at the first entry in the directory<span class="token punctuation">.</span>       The <span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function is like <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> but returns a directory stream <span class="token keyword">for</span> the directory referred to by the 【open file descriptor fd】<span class="token punctuation">.</span>  After a successful call to <span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fd is used internally by the implementation<span class="token punctuation">,</span> and should not otherwise be used by the application<span class="token punctuation">.</span>RETURN VALUE       The <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> and <span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> functions <span class="token keyword">return</span> a pointer to the directory stream<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token constant">NULL</span> is returned<span class="token punctuation">,</span>  and  errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="DIR-结构体"><a href="#DIR-结构体" class="headerlink" title="DIR 结构体"></a>DIR 结构体</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">__dirstream</span><span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token operator">*</span>__fd<span class="token punctuation">;</span> <span class="token comment">/* `struct hurd_fd' pointer for descriptor.   */</span>    <span class="token keyword">char</span> <span class="token operator">*</span>__data<span class="token punctuation">;</span> <span class="token comment">/* Directory block.   */</span>    <span class="token keyword">int</span> __entry_data<span class="token punctuation">;</span> <span class="token comment">/* Entry number `__data' corresponds to.   */</span>    <span class="token keyword">char</span> <span class="token operator">*</span>__ptr<span class="token punctuation">;</span> <span class="token comment">/* Current pointer into the block.   */</span>    <span class="token keyword">int</span> __entry_ptr<span class="token punctuation">;</span> <span class="token comment">/* Entry number `__ptr' corresponds to.   */</span>    <span class="token class-name">size_t</span> __allocation<span class="token punctuation">;</span> <span class="token comment">/* Space allocated for the block.   */</span>    <span class="token class-name">size_t</span> __size<span class="token punctuation">;</span> <span class="token comment">/* Total valid data in the block.   */</span>    <span class="token function">__libc_lock_define</span> <span class="token punctuation">(</span><span class="token punctuation">,</span> __lock<span class="token punctuation">)</span> <span class="token comment">/* Mutex lock for this structure.   */</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">__dirstream</span> DIR<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="readdir"><a href="#readdir" class="headerlink" title="readdir"></a>readdir</h5><p>读取目录中的数据，调用一次，就指向流中的下一个实体</p><ul><li>dirp:  <code>opendir函数</code> 返回的 <code>DIR*</code> 类型的结构体</li><li>return value: <ul><li>正确：<ul><li>未到末尾：<code>struct dirent</code>类型的结构体，存储读到的文件信息</li><li>末尾：NULL</li></ul></li><li>错误：NULL</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       readdir <span class="token operator">-</span> read a directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>       <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span><span class="token function">readdir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       The  <span class="token function">readdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  function  returns a pointer to a dirent structure representing the next directory entry in the directory stream pointed to by dirp<span class="token punctuation">.</span>  It returns <span class="token constant">NULL</span> on reaching the end of the directory stream or <span class="token keyword">if</span> an error occurred<span class="token punctuation">.</span>       In the glibc implementation<span class="token punctuation">,</span> the dirent structure is defined as follows<span class="token operator">:</span>           <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token punctuation">{</span>               <span class="token class-name">ino_t</span>          d_ino<span class="token punctuation">;</span>       <span class="token comment">/* Inode number */</span>               <span class="token class-name">off_t</span>          d_off<span class="token punctuation">;</span>       <span class="token comment">/* Not an offset; see below */</span>               <span class="token keyword">unsigned</span> <span class="token keyword">short</span> d_reclen<span class="token punctuation">;</span>    <span class="token comment">/* Length of this record */</span>               <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  d_type<span class="token punctuation">;</span>      <span class="token comment">/* Type of file; not supported                                              by all filesystem types */</span>               <span class="token keyword">char</span>           d_name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Null-terminated filename */</span>           <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/1e6528686aa04ffb8ad7d40e58475dbd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="closedir"><a href="#closedir" class="headerlink" title="closedir"></a>closedir</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       closedir <span class="token operator">-</span> close a directorySYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">closedir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       The <span class="token function">closedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function closes the directory stream associated with dirp<span class="token punctuation">.</span>  A successful call to <span class="token function">closedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> also closes the underlying file descriptor associated with dirp<span class="token punctuation">.</span>  The directory stream descriptor dirp is not available after this call<span class="token punctuation">.</span>RETURN VALUE       The <span class="token function">closedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> function returns <span class="token number">0</span> on success<span class="token punctuation">.</span>  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="测试代码-计算某个目录下文件的个数"><a href="#测试代码-计算某个目录下文件的个数" class="headerlink" title="测试代码 (计算某个目录下文件的个数)"></a>测试代码 (计算某个目录下文件的个数)</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s pathname\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The total num of files is: %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 1. 打开目录</span>    DIR <span class="token operator">*</span>dir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>dir <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"opendir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2.记录普通文件个数</span>    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ptr <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment">// 判断是否为. 或 ..</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token comment">// 如果是目录，需要递归计算</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_type <span class="token operator">==</span> DT_DIR<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">char</span> newpath<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token function">sprintf</span><span class="token punctuation">(</span>newpath<span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>            cnt <span class="token operator">+=</span> <span class="token function">getFileNum</span><span class="token punctuation">(</span>newpath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 如果是普通文件，计算</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>d_type <span class="token operator">==</span> DT_REG<span class="token punctuation">)</span> <span class="token operator">++</span> cnt<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3.关闭文件</span>    <span class="token function">closedir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> cnt<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-9-dup-amp-dup2-system-call"><a href="#4-9-dup-amp-dup2-system-call" class="headerlink" title="4.9 dup &amp; dup2 system call"></a>4.9 dup &amp; dup2 system call</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       dup<span class="token punctuation">,</span> dup2<span class="token punctuation">,</span> dup3 <span class="token operator">-</span> duplicate a file descriptorSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">int</span> <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span>             <span class="token comment">/* See feature_test_macros(7) */</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span>              <span class="token comment">/* Obtain O_* constant definitions */</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">dup3</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       The  <span class="token function">dup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  system call 【creates a copy of the file descriptor oldfd】<span class="token punctuation">,</span> using the 【lowest<span class="token operator">-</span>numbered】 unused file de‐       scriptor <span class="token keyword">for</span> the new descriptor<span class="token punctuation">.</span>       After a successful <span class="token keyword">return</span><span class="token punctuation">,</span> the old and new file descriptors may be used interchangeably<span class="token punctuation">.</span>  They  refer  to  the same open file description and thus share file offset and file status flags<span class="token punctuation">;</span> <span class="token keyword">for</span> example<span class="token punctuation">,</span> <span class="token keyword">if</span> the  file offset is modified by using <span class="token function">lseek</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> on one of the file descriptors<span class="token punctuation">,</span> the offset is also changed  <span class="token keyword">for</span>  the other<span class="token punctuation">.</span>       The  two file descriptors <span class="token keyword">do</span> not share file descriptor <span class="token function">flags</span> <span class="token punctuation">(</span>the close<span class="token operator">-</span>on<span class="token operator">-</span>exec flag<span class="token punctuation">)</span><span class="token punctuation">.</span>  The close<span class="token operator">-</span>on<span class="token operator">-</span>exec <span class="token function">flag</span> <span class="token punctuation">(</span>FD_CLOEXEC<span class="token punctuation">;</span> see <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> the duplicate descriptor is off<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="dup"><a href="#dup" class="headerlink" title="dup"></a>dup</h5><p>复制文件描述符</p><p>从空闲的文件描述符中找一个新的作为新的文件描述符</p><p>和旧的一起指向同一个文件</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="测试代码-11"><a href="#测试代码-11" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 创建一个文件描述符</span>    <span class="token keyword">int</span> oldFd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>oldFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 拷贝文件描述符 oldFd -&gt; newFd</span>    <span class="token keyword">int</span> newFd <span class="token operator">=</span> <span class="token function">dup</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"oldFd: %d, newFd: %d\n"</span><span class="token punctuation">,</span> oldFd<span class="token punctuation">,</span> newFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 关闭旧的文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 新的仍然可以操作这个文件</span>    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, World!\n"</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>newFd<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span>newFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/e9f6ca0932a64e6eb25fb1aaf35b5d73.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==">可以发现两个不同的文件描述符 3，4 指向的是同一个文件。</p><h5 id="dup2"><a href="#dup2" class="headerlink" title="dup2"></a>dup2</h5><p>重定向文件描述符</p><p>oldfd 指向 a.txt, newfd 指向 b.txt</p><p>调用dup2之后，相当于(close, newfd, b.txt), newfd指向a.txt</p><p>oldfd == newfd，相当于什么都没做</p><p>对于返回值没必要close, newfd 和 return value相同，如果成功。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="测试代码-12"><a href="#测试代码-12" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                                                                           <span class="token punctuation">{</span>    <span class="token keyword">int</span> oldFd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>oldFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> newFd <span class="token operator">=</span> <span class="token function">dup2</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"oldFd: %d, newFd: %d\n"</span><span class="token punctuation">,</span> oldFd<span class="token punctuation">,</span> newFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>oldFd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, World!\n"</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-10-fcntl"><a href="#4-10-fcntl" class="headerlink" title="4.10 fcntl"></a>4.10 fcntl</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">NAME       fcntl <span class="token operator">-</span> manipulate file descriptorSYNOPSIS       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>       <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>       <span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>DESCRIPTION       <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  performs  one of the operations described below on the open file descriptor fd<span class="token punctuation">.</span>  The operation is determined by cmd<span class="token punctuation">.</span>       <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> can take an optional third argument<span class="token punctuation">.</span>  Whether or not this argument is required is determined  by  cmd<span class="token punctuation">.</span> The  required  argument type is indicated in parentheses after each cmd <span class="token function">name</span> <span class="token punctuation">(</span>in most cases<span class="token punctuation">,</span> the required type is <span class="token keyword">int</span><span class="token punctuation">,</span> and we identify the argument using the name arg<span class="token punctuation">)</span><span class="token punctuation">,</span> or <span class="token keyword">void</span> is specified <span class="token keyword">if</span>  the  argument  is  not  required<span class="token punctuation">.</span>       Certain  of  the  operations  below are supported only since a particular Linux kernel version<span class="token punctuation">.</span>  The preferred method of checking whether the host kernel supports a particular operation is to invoke <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> with  the  desired  cmd value and then test whether the call failed with EINVAL<span class="token punctuation">,</span> indicating that the kernel does not recognize this value<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>fd：文件描述符</li><li>cmd：命令（宏）<ul><li>F_DUPFD (int)<ul><li><p>复制文件描述符，复制第一个参数fd并通过return value返回新的文件描述符</p></li><li><p>用法：newfd = fcntl (fd, F_DUPFD);</p></li></ul></li><li>F_GETFL (void)<ul><li>获取文件状态 flag （和open函数传递的flag是同一个东西）</li><li>用法：</li></ul></li><li>F_SETFL (int)<ul><li><p>设置文件状态 flag</p></li><li><p>access mode 不可修改 O_RDONLY,  O_WRONLY, O_RDWR ， creation flags 也不可修改</p></li><li><p>可选项：O_APPEND（追加数据）, O_NONBLOCK（设置成非阻塞）</p></li></ul></li></ul></li><li>可变参数</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">Duplicating a file descriptor           <span class="token function">F_DUPFD</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>           Duplicate the file descriptor fd using the lowest<span class="token operator">-</span>numbered available file descriptor greater than or equal to  arg<span class="token punctuation">.</span>       This is different from <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> which uses exactly the file descriptor specified<span class="token punctuation">.</span>       On success<span class="token punctuation">,</span> the new file descriptor is returned<span class="token punctuation">.</span>       As  <span class="token keyword">for</span>  F_DUPFD<span class="token punctuation">,</span>  but  additionally set the close<span class="token operator">-</span>on<span class="token operator">-</span>exec flag <span class="token keyword">for</span> the duplicate file descriptor<span class="token punctuation">.</span>  Specifying this flag permits a program to avoid an additional <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> F_SETFD operation to set the FD_CLOEXEC flag<span class="token punctuation">.</span>  For an  explanation of why this flag is useful<span class="token punctuation">,</span> see the description of O_CLOEXEC in <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>           File status flags           Each  open  file description has certain associated status flags<span class="token punctuation">,</span> initialized by <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> and possibly modified by <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> Duplicated file <span class="token function">descriptors</span> <span class="token punctuation">(</span>made with <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>F_DUPFD<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> etc<span class="token punctuation">.</span><span class="token punctuation">)</span> refer to the same open file description<span class="token punctuation">,</span> and thus share the same file status flags<span class="token punctuation">.</span>       The file status flags and their semantics are described in <span class="token function">open</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>       <span class="token function">F_GETFL</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>           <span class="token function">Return</span> <span class="token punctuation">(</span>as the function result<span class="token punctuation">)</span> the file access mode and the file status flags<span class="token punctuation">;</span> arg is ignored<span class="token punctuation">.</span>       <span class="token function">F_SETFL</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>           Set  the  file  status flags to the value specified by arg<span class="token punctuation">.</span>  File access <span class="token function">mode</span> <span class="token punctuation">(</span>O_RDONLY<span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span> and file creation <span class="token function">flags</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> O_CREAT<span class="token punctuation">,</span> O_EXCL<span class="token punctuation">,</span> O_NOCTTY<span class="token punctuation">,</span> O_TRUNC<span class="token punctuation">)</span> in arg are ignored<span class="token punctuation">.</span>         On Linux<span class="token punctuation">,</span> this  command  can  change only  the  【O_APPEND<span class="token punctuation">,</span>  O_ASYNC<span class="token punctuation">,</span> O_DIRECT<span class="token punctuation">,</span> O_NOATIME<span class="token punctuation">,</span> and O_NONBLOCK flags】<span class="token punctuation">.</span>         It is not possible to change the O_DSYNC and O_SYNC flags<span class="token punctuation">;</span> see BUGS<span class="token punctuation">,</span> below<span class="token punctuation">.</span>                  On error<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> is returned<span class="token punctuation">,</span> and errno is set appropriately<span class="token punctuation">.</span>           <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="阻塞-amp-非阻塞"><a href="#阻塞-amp-非阻塞" class="headerlink" title="阻塞 &amp; 非阻塞"></a>阻塞 &amp; 非阻塞</h5><p>描述的是函数的行为。</p><p><code>阻塞</code>，在调用结果返回前，当前线程会被挂起，并在得到结果之后返回。 </p><p>​            终端等待我们输入的时候就是阻塞的。</p><p><code>非阻塞</code>，如果不能立刻得到结果，则该调用者不会阻塞当前线程。</p><p>​            在终端，我们输入好命令后进程执行期间是不阻塞的。</p><h5 id="测试代码-13"><a href="#测试代码-13" class="headerlink" title="测试代码"></a>测试代码</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 打开文件</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 获取文件状态 flag</span>    <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fcntl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>         <span class="token comment">// 设置文件状态 flag</span>    flag <span class="token operator">|=</span> O_APPEND<span class="token punctuation">;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fcntl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 写数据</span>    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"Hello, fcntl\n"</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/70a468d4bdde45c48ac474745884e6ca.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="flag |= O_APPEND, 会在文件末尾追加"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://img-blog.csdnimg.cn/9cd9c3d4d9fc4acd9306b8356e9f652b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="flag 不和 O_APPEND做按位与，直接覆盖重写"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p>]]></content>
      
      
      <categories>
          
          <category> 系统编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openGL - Hello Triangle</title>
      <link href="/2022/04/03/openGL%20-%20Hello%20Triangle/"/>
      <url>/2022/04/03/openGL%20-%20Hello%20Triangle/</url>
      
        <content type="html"><![CDATA[<h3 id="打印一个三角形"><a href="#打印一个三角形" class="headerlink" title="打印一个三角形"></a>打印一个三角形</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;glad/glad.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;GLFW/glfw3.h&gt;</span></span><span class="token keyword">void</span> <span class="token function">framebuffer_size_callback</span><span class="token punctuation">(</span>GLFWwindow<span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">processInput</span><span class="token punctuation">(</span>GLFWwindow<span class="token operator">*</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 顶点着色器源码</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> vertexShaderSource <span class="token operator">=</span> <span class="token string">"#version 330 core\n"</span><span class="token string">"layout (location = 0) in vec3 aPos;\n"</span><span class="token string">"void main()\n"</span><span class="token string">"{\n"</span><span class="token string">"gl_Position = vec4(aPos.x, aPos.y, aPos.z, 1.0);\n"</span><span class="token string">"}\0"</span><span class="token punctuation">;</span><span class="token comment">// 片段着色器源码</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fragmentShaderSource <span class="token operator">=</span> <span class="token string">"#version 330 core\n"</span><span class="token string">"out vec4 FragColor;\n"</span><span class="token string">"void main()\n"</span><span class="token string">"{\n"</span><span class="token string">"FragColor = vec4(1.0f, 0.5f, 0.2f, 1.0f);\n"</span><span class="token string">"}\0"</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">glfwInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_CONTEXT_VERSION_MAJOR<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_CONTEXT_VERSION_MINOR<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_OPENGL_PROFILE<span class="token punctuation">,</span> GLFW_OPENGL_CORE_PROFILE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建窗口对象</span>GLFWwindow<span class="token operator">*</span> window <span class="token operator">=</span> <span class="token function">glfwCreateWindow</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token string">"Hello,openGL"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>window <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to create GLFW window"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span><span class="token function">glfwTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">glfwMakeContextCurrent</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 初始化GLAD(管理OpenGL的函数指针)</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">gladLoadGLLoader</span><span class="token punctuation">(</span><span class="token punctuation">(</span>GLADloadproc<span class="token punctuation">)</span>glfwGetProcAddress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to initialize GLAD"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span>    <span class="token comment">// 告诉openGL渲染窗口的尺寸大小</span><span class="token function">glViewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwSetFramebufferSizeCallback</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> framebuffer_size_callback<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//  ********************* start painting**************************</span>    <span class="token comment">// 顶点数据</span><span class="token keyword">float</span> vertices<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 顶点着色器</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> vertexShader <span class="token operator">=</span> <span class="token function">glCreateShader</span><span class="token punctuation">(</span>GL_VERTEX_SHADER<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glShaderSource</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>vertexShaderSource<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glCompileShader</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 片段着色器</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fragmentShader <span class="token operator">=</span> <span class="token function">glCreateShader</span><span class="token punctuation">(</span>GL_FRAGMENT_SHADER<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glShaderSource</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fragmentShaderSource<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glCompileShader</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 链接程序对象</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> shaderProgram <span class="token operator">=</span> <span class="token function">glCreateProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glAttachShader</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glAttachShader</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glLinkProgram</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 删除着色器</span><span class="token function">glDeleteShader</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glDeleteShader</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 管理内存</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> VBO<span class="token punctuation">;</span><span class="token function">glGenBuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>VBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> VBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> GL_STATIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> VAO<span class="token punctuation">;</span><span class="token function">glGenVertexArrays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>VAO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>VAO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 链接顶点属性</span><span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 解绑，但是没有太搞懂</span><span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//  ********************* end painting ***************************</span>    <span class="token comment">// 渲染循环</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">glfwWindowShouldClose</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">// input</span><span class="token function">processInput</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// redering commands</span><span class="token function">glClearColor</span><span class="token punctuation">(</span><span class="token number">0.2f</span><span class="token punctuation">,</span> <span class="token number">0.3f</span><span class="token punctuation">,</span> <span class="token number">0.3f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// My paints</span><span class="token function">glUseProgram</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>VAO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// [ swap the buffers ] and [ check and call events ]</span><span class="token function">glfwSwapBuffers</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwPollEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">glDeleteVertexArrays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>VAO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glDeleteVertexArrays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>VBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glDeleteProgram</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">glfwTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// 回调函数，会在每次窗口大小被调整的时候被调用</span><span class="token keyword">void</span> <span class="token function">framebuffer_size_callback</span><span class="token punctuation">(</span>GLFWwindow<span class="token operator">*</span> window<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">glViewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// 处理输入事件</span><span class="token keyword">void</span> <span class="token function">processInput</span><span class="token punctuation">(</span>GLFWwindow<span class="token operator">*</span> window<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">glfwGetKey</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> GLFW_KEY_ESCAPE<span class="token punctuation">)</span> <span class="token operator">==</span> GLFW_PRESS<span class="token punctuation">)</span><span class="token function">glfwSetWindowShouldClose</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="检测着色器是否编译成功"><a href="#检测着色器是否编译成功" class="headerlink" title="检测着色器是否编译成功"></a>检测着色器是否编译成功</h5><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span>  success<span class="token punctuation">;</span><span class="token keyword">char</span> infoLog<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">glGetShaderiv</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> GL_COMPILE_STATUS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">glGetShaderInfoLog</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> infoLog<span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ERROR::SHADER::VERTEX::COMPILATION_FAILED\n"</span> <span class="token operator">&lt;&lt;</span> infoLog <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="检测着色器程序是否链接成功"><a href="#检测着色器程序是否链接成功" class="headerlink" title="检测着色器程序是否链接成功"></a>检测着色器程序是否链接成功</h5><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span>  success<span class="token punctuation">;</span><span class="token keyword">char</span> infoLog<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">glGetProgramiv</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">,</span> GL_LINK_STATUS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">glGetProgramInfoLog</span><span class="token punctuation">(</span>shaderProgram<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> infoLog<span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ERROR::SHADER::PROGRAM::LINKING_FAILED\n"</span> <span class="token operator">&lt;&lt;</span> infoLog <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 图形学 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openGL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GDB</title>
      <link href="/2022/03/29/GDB/"/>
      <url>/2022/03/29/GDB/</url>
      
        <content type="html"><![CDATA[<h1 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h1><p><img src="https://img-blog.csdnimg.cn/2cc702f15c6148e2b87dd15223fb38dc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="gdb介绍"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/3ec36ad4d2264fdabdcda7c216f93a64.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="准备工作"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/448b8c24f61641eb8f9b3ed1289076ef.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="命令"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/a37c85543df5489aaeab1728c6234617.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="断点"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/527413ac06994139b4aa5791c6cfd3c0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="调试命令"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>程序停在那里，并没有执行，s继续执行下一步，断点才会执行</p>]]></content>
      
      
      <categories>
          
          <category> 系统编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Makefile</title>
      <link href="/2022/03/28/Makefile/"/>
      <url>/2022/03/28/Makefile/</url>
      
        <content type="html"><![CDATA[<h1 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h1><h3 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1.介绍"></a>1.介绍</h3><p><img src="https://img-blog.csdnimg.cn/bfb19f9684554c6d9074ef5abaadb604.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="介绍"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="2-Makefile文件命名和规则"><a href="#2-Makefile文件命名和规则" class="headerlink" title="2.Makefile文件命名和规则"></a>2.Makefile文件命名和规则</h3><p><img src="https://img-blog.csdnimg.cn/d3538800de0c46779ca2fbde831bf992.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="命名和规则"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="><img src="https://img-blog.csdnimg.cn/3839ec0d23114a4594122ef16da387c9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="Makefile - 1"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="3-工作原理"><a href="#3-工作原理" class="headerlink" title="3.工作原理"></a>3.工作原理</h3><p><img src="https://img-blog.csdnimg.cn/da2336430809471384800d3289a517ba.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="工作原理"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>默认执行第一个规则，如果后面的规则和第一条规则没有任何联系，则不会执行</p><p>下面这么写的好处：更新哪个编译哪个</p><p>按道理来说先有依赖再有目标</p><p>如果依赖的时间比目标晚，说明依赖更新过了，因此要重新生成目标</p><p><img src="https://img-blog.csdnimg.cn/45b9be63ec674c6497482375dd93b745.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="Makefile - 2"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="4-变量"><a href="#4-变量" class="headerlink" title="4.变量"></a>4.变量</h3><p><img src="https://img-blog.csdnimg.cn/33c2665231784d61a0ecaa398592ae40.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="变量"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="5-模式匹配"><a href="#5-模式匹配" class="headerlink" title="5.模式匹配"></a>5.模式匹配</h3><p><img src="https://img-blog.csdnimg.cn/fd03f5b312054d0ea80725ee3a068422.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="模式匹配"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/aebee0339eb44aa2b352a7f8fda2459e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="Makefile - 3"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="6-函数"><a href="#6-函数" class="headerlink" title="6.函数"></a>6.函数</h3><p><img src="https://img-blog.csdnimg.cn/51cfdddf2ed44c09ade1afebcafc2de3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="函数"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/f3818cf1ca504aaca52b02941a855a5a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="函数"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p><img src="https://img-blog.csdnimg.cn/6038ca2aa5244a0b9c65159ce47fc967.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="Makefile - 4"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>不加.PHONY的话如果外面有clean文件会冲突，因为clean永远是最新的</p><p>make clean命令可以删除所有的.o文件</p>]]></content>
      
      
      <categories>
          
          <category> 系统编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gcc/库的制作</title>
      <link href="/2022/03/24/gcc&amp;%E5%BA%93%E7%9A%84%E5%88%B6%E4%BD%9C/"/>
      <url>/2022/03/24/gcc&amp;%E5%BA%93%E7%9A%84%E5%88%B6%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="GCC-教程"><a href="#GCC-教程" class="headerlink" title="GCC 教程"></a>GCC 教程</h2><h3 id="gcc"><a href="#gcc" class="headerlink" title="gcc ="></a>gcc =</h3><p>​            GNU C Compiler (GNU C语言编译器)</p><p>​            GNU Compiler Collection (GNU 编译器套件)</p><h3 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h3><p>gcc /g++ –version</p><p>gcc/g++ -v</p><table><thead><tr><th>参数</th><th>作用</th><th>结果</th></tr></thead><tbody><tr><td>-E</td><td>预处理(头文件展开，宏替换，删除注释…)</td><td>.i</td></tr><tr><td>-S</td><td>预处理，编译(原代码 —&gt; 汇编码)</td><td>.s</td></tr><tr><td>-c</td><td>预处理，编译，汇编(汇编码 —&gt; 机器码)</td><td>.o</td></tr><tr><td>-o</td><td>生成目标文件</td><td></td></tr></tbody></table><h3 id="gcc-or-g"><a href="#gcc-or-g" class="headerlink" title="gcc or g++?"></a>gcc or g++?</h3><ul><li><p>预处理阶段</p><p>g++会调用gcc，因此gcc/g++都可以预处理c/c++代码。</p></li><li><p>编译，汇编，链接阶段</p><p>分家吧。 但是g++兼容c。</p></li></ul><p>事实上，只是gcc无法链接c++的库，因此链接阶段要用g++或者gcc后面加上-lstdc++。</p><p>为了方便，我们还是各用各的吧。</p><h2 id="库"><a href="#库" class="headerlink" title="库"></a>库</h2><p><code>库文件</code>：</p><p>​    计算机上的一类文件，可以看作一种仓库代码，提供给使用者一些可以直接拿来用的变量、函数或类。</p><p>​    库文件有两种：</p><ul><li>静态库：在程序<code>链接阶段</code>被复制到程序中</li><li>动态库(共享库)：在<code>运行时</code>由系统动态加载到内存中供程序使用</li></ul><p><code>库</code>：</p><p>​    一种特殊的程序，编写库程序和普通程序区别不大，只是库<code>不能单独运行</code>。</p><p>库的作用：1.代码保密   2.方便部署和分发</p><h3 id="静态库的制作"><a href="#静态库的制作" class="headerlink" title="静态库的制作"></a>静态库的制作</h3><h4 id="Linux-libxxx-a"><a href="#Linux-libxxx-a" class="headerlink" title="Linux : libxxx.a"></a>Linux : libxxx.a</h4><p>​        lib : 前缀（固定）</p><p>​        xxx：库的名字，自己起</p><p>​        .a：后缀（固定）</p><ul><li><p>gcc 获得 .o文件</p><pre class="line-numbers language-gcc" data-language="gcc"><code class="language-gcc">gcc -c a.c b.c ...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>将 .o 文件打包，利用 ar 工具 （archive）</p><pre class="line-numbers language-gcc" data-language="gcc"><code class="language-gcc">ar rcs libxxx.a a.o b.o ...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><blockquote><p>r - 将文件插入备存文件中</p><p>c - 建立备存文件</p><p>s - 索引</p></blockquote><h4 id="静态库制作流程"><a href="#静态库制作流程" class="headerlink" title="静态库制作流程"></a>静态库制作流程</h4><h5 id="1-写好库中的代码并生成静态库"><a href="#1-写好库中的代码并生成静态库" class="headerlink" title="1. 写好库中的代码并生成静态库"></a>1. 写好库中的代码并生成静态库</h5><p>该库只包含四个简单的函数：add, sub, multi,div</p><p>此外，还有个head.h包含这四个函数的声明</p><p>还有个main.c用于测试</p><p><img src="https://img-blog.csdnimg.cn/b78289ecdca6450f8eebe8ba982c284c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="所需文件"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这部分代码如下</p><p><img src="https://img-blog.csdnimg.cn/b83e724ebcc2464a9e6cb3c04a624bef.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="所需文件代码"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>生成静态库需要用到四个库函数的.o文件(.o文件经过链接之后就生成了可执行文件)</p><p><img src="https://img-blog.csdnimg.cn/09bdbb84715943c7a30b2f5e7e8bf5bb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="生成.o文件"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>再执行ar rcs命令，借助archive工具将.o文件打包成静态库，得到libcalc.a文件</p><p><img src="https://img-blog.csdnimg.cn/87772b41cacf45309e2439595f12ce4c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="libcalc.a"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h5 id="2-创建使用这个库的目录"><a href="#2-创建使用这个库的目录" class="headerlink" title="2.创建使用这个库的目录"></a>2.创建使用这个库的目录</h5><p>这个库的目录层次如下：</p><p><img src="https://img-blog.csdnimg.cn/0620b295ac01404e86706043d83777ea.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_10,color_FFFFFF,t_70,g_se,x_16" alt="目录层次"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这时万事俱备，只需要编译该main.c就可以运行了</p><p>然后，事情总不会这么顺利</p><p><img src="https://img-blog.csdnimg.cn/8289779ec6924d68bdea48520abd37ba.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="直接gcc编译"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>gcc会报错找不到head.h文件</p><p>原因是main.c位于.目录，即当前目录, 而head.h在include目录下，</p><p>在main.c中#include “head.h”导入的是相对路径，因此gcc找不到这个头文件</p><p>解决办法有二：</p><ul><li>将head.h与main.c置于同一个目录下</li><li>利用-I（大写i） dir<br>　　在你是用#include”file”的时候,gcc/g++会先在当前目录查找你所制定的头文件,如果没有找到,他回到缺省的头文件目录找,如果使用-I制定了目录,他会先在你所制定的目录查找,然后再按常规的顺序去找.<br>  　　对于#include<file>,gcc/g++会到-I制定的目录查找,查找不到,然后将到系统的缺省的头文件目录查找 </file></li></ul><p>这里采用第二种</p><p>然而，这样子还会报错，因为gcc找不到calc这个库</p><ul><li>-l（小写L） library （库的名字，不是库文件的名字）<br>　　制定编译的时候使用的库<br>  　　例子用法 ： gcc -l curses hello.c  —&gt; 使用ncurses库编译程序 </li></ul><ul><li><p>-L dir<br>　　制定编译的时候，搜索库的路径。</p><p>​        比如你自己的库，可以用它制定目录，不然编译器将只在标准库的目录找。这个dir就是目录的名称。 </p></li></ul><p><img src="https://img-blog.csdnimg.cn/6857841f045f4a698c315cdfb01729c5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="链接静态库编译"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="动态库的制作"><a href="#动态库的制作" class="headerlink" title="动态库的制作"></a>动态库的制作</h3><h4 id="Linux-libxxx-so"><a href="#Linux-libxxx-so" class="headerlink" title="Linux : libxxx.so"></a>Linux : libxxx.so</h4><blockquote><p>windows: libxxx.dll</p></blockquote><ul><li><p>gcc 得到 .o 文件，得到和<code>位置无关</code>的代码</p><p>静态库链接时代码的位置已经固定，加载到内存中，但是动态库并不知道什么时候加载，加载到内存哪里</p><pre class="line-numbers language-gcc" data-language="gcc"><code class="language-gcc">  gcc -c fpic/fPIC a.c b.c* gcc 得到动态库  ```gcc  gcc -shared a.o b.o -o libxxx.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>前面的制作过程和静态库大同小异，唯一的区别就是命令不同</p><p>然而当我们做好动态库之后，却运行不了可执行文件，说找不到libcalc.so这个动态库</p><p><img src="https://img-blog.csdnimg.cn/e5fa1282b5334250a21a1282ff285a4e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="ERROR"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>使用 ldd 命令检查<code>动态库依赖关系</code></p><p>可以看到 libcalc.so 这个动态库对应的结果是 not found</p><p><img src="https://img-blog.csdnimg.cn/a4a2b72896dc4e05862fa178f40028da.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="ldd"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>这就涉及到动态库的实现原理了</p><p>链接时，只有信息信息会被放入可执行程序，但是具体的代码却不会放入可执行程序</p><p>只有在调用库中某个api的时候才会去获取动态库的绝对路径</p><p><img src="https://img-blog.csdnimg.cn/3bca6981a23747998e5cf4fc645fc7ad.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="动态库工作原理"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><p>终端实际上也是一个应用程序</p><p>输入指令 ls 之后，<code>shell解析器</code> 解析该指令</p><p>shell解析器根据环境变量找到这条指令的路径</p><p>使用 <code>env</code> 指令可以查看所有的环境变量</p><p>里面都是一些键值对</p><p>key - value</p><p>key - value1 : value2 : value3 ….</p><p>每一个value都是一条路径</p><p>value1找不到该命令，就去value2找，再找不到再去value3找…</p><p>因此，要想运行动态库，要先配置环境变量</p><p>使用env命令可以查看所有环境变量</p><p><img src="https://img-blog.csdnimg.cn/f1c8c1a07b764a269b1de3ff0e6fbcd3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="查看环境变量"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>找到动态库的绝对路径，并将其配置到LD_LIBRARY_PATH下</p><p><img src="https://img-blog.csdnimg.cn/9ef519cf65bb4c0b8044e186b7fc5327.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="配置环境变量"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>此时使用 <code>ldd</code> 便可以看到该可执行程序已经可以找到动态库的绝对路径了</p><p>直接运行，成功</p><p><img src="https://img-blog.csdnimg.cn/cba73810503d4a968c9966713f4a3c7f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="配置完成"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h3 id="然而，这样只是暂时的，关掉终端重启就失效了"><a href="#然而，这样只是暂时的，关掉终端重启就失效了" class="headerlink" title="然而，这样只是暂时的，关掉终端重启就失效了"></a>然而，这样只是暂时的，关掉终端重启就失效了</h3><h5 id="永久配置-用户级别"><a href="#永久配置-用户级别" class="headerlink" title="永久配置 - 用户级别"></a>永久配置 - 用户级别</h5><p>进入home/.bashrc, 添加配置信息</p><p><img src="https://img-blog.csdnimg.cn/21834d370b92419cbcebe13c7bafe869.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="添加配置信息"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>并用 <code>source .bash</code> 或 <code>. .bashrc</code>来激活配置文件</p><h5 id="永久配置-系统级别"><a href="#永久配置-系统级别" class="headerlink" title="永久配置 - 系统级别"></a>永久配置 - 系统级别</h5><p>进入 /etc/profile, 添加配置信息</p><p>并用 source /etc/profile激活配置文件</p><h4 id="修改-etc-ld-so-cache"><a href="#修改-etc-ld-so-cache" class="headerlink" title="修改/etc/ld.so.cache"></a>修改/etc/ld.so.cache</h4><p>进入 <code>/etc/ld.so.conf</code> ，直接将路径粘贴进去</p><p><img src="https://img-blog.csdnimg.cn/c0e0d36c39824b968ec4bdc63f01d132.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="ld.so.conf"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="最粗暴-直接将库文件放到-lib或-usr-lib目录下"><a href="#最粗暴-直接将库文件放到-lib或-usr-lib目录下" class="headerlink" title="最粗暴 - 直接将库文件放到/lib或/usr/lib目录下"></a>最粗暴 - 直接将库文件放到<code>/lib</code>或<code>/usr/lib</code>目录下</h4><p>不推荐，因为这两个目录下面原先就放了很多系统的库文件，如果把自己的放进去万一名称冲突会出带问题</p><p><img src="https://img-blog.csdnimg.cn/474f2d2865a94f5697a1ae181ad1b927.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="完整流程"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>静态库</p><p>​    链接阶段直接把<code>静态库代码</code>打包到可执行文件中</p><p>​    优点：</p><ul><li>静态库被打包到应用程序中，加载速度快</li><li>发布程序无需提供静态库，移植方便 </li></ul><p>​    缺点：</p><ul><li><p>消耗系统资源，浪费内存</p></li><li><p>更新、部署、发布麻烦</p><p><img src="https://img-blog.csdnimg.cn/2565bc00369144db93093263bc8c05bf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="占用内存"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p></li></ul><p>动态库</p><p>​    链接阶段把<code>动态库信息</code>(如动态库名称)打包到可执行文件中，可执行程序运行时找到动态库文件，并加载到内存中，使用其代码</p><p>​    优点：</p><ul><li>可以实现进程间资源共享（共享库），如果有个程序使用了动态库，该库已经加载到内存当中了，其他进程可以直接使用</li><li>更新、部署、发布简单</li><li>可以控制何时加载动态库，没有使用到不会加载</li></ul><p>​    缺点：</p><ul><li>加载速度比静态库慢</li><li>发布程序时需要提供依赖的动态库</li></ul>]]></content>
      
      
      <categories>
          
          <category> 系统编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C/C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySql - 9 事务，并发问题</title>
      <link href="/2022/03/14/Mysql9%20%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98/"/>
      <url>/2022/03/14/Mysql9%20%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="事务，并发问题"><a href="#事务，并发问题" class="headerlink" title="事务，并发问题"></a>事务，并发问题</h1><h3 id="事务操作"><a href="#事务操作" class="headerlink" title="事务操作"></a>事务操作</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span><span class="token comment">-- 开启事务</span><span class="token keyword">COMMIT</span><span class="token punctuation">;</span> <span class="token operator">/</span> <span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span><span class="token comment">-- 提交、回滚事务</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="事务四大特性"><a href="#事务四大特性" class="headerlink" title="事务四大特性"></a>事务四大特性</h3><ul><li><p>原子性 - 事务中的一系列操作同生共死</p></li><li><p>一致性 - 能量守恒</p></li><li><p>隔离性 - 互不干扰</p></li><li><p>持久性 - 永久写入磁盘</p></li></ul><h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p><img src="https://img-blog.csdnimg.cn/f48e1a3807ad4955adc2baf97aa1ecd0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="隔离级别"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="查看事务隔离级别"><a href="#查看事务隔离级别" class="headerlink" title="查看事务隔离级别"></a>查看事务隔离级别</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> @<span class="token variable">@TRANSACTION</span> IOSLATION<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="设置事务隔离级别"><a href="#设置事务隔离级别" class="headerlink" title="设置事务隔离级别"></a>设置事务隔离级别</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> <span class="token punctuation">[</span><span class="token keyword">SESSION</span><span class="token operator">|</span><span class="token keyword">GLOBAL</span><span class="token punctuation">]</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token punctuation">[</span>隔离级别<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux - 4 ssh</title>
      <link href="/2022/03/11/Linux4%20ssh/"/>
      <url>/2022/03/11/Linux4%20ssh/</url>
      
        <content type="html"><![CDATA[<h1 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h1>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySql - 8 多表查询</title>
      <link href="/2022/03/10/Mysql8%20%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2/"/>
      <url>/2022/03/10/Mysql8%20%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2/</url>
      
        <content type="html"><![CDATA[<h1 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h1><h2 id="1-多表关系"><a href="#1-多表关系" class="headerlink" title="1.多表关系"></a>1.多表关系</h2><ul><li><p>一对多</p><p>案例：部门 - 员工</p><p>关系：一个员工只能归属一个部门，但一个部门可以对应多个员工</p><p>实现：在多的一方建立<code>外键</code>，指向一的一方的<code>主键</code></p></li><li><p>多对多</p><p>案例：学生 - 课程</p><p>关系：一个学生可以选修多门课程，一门课程可以供多个学生选择</p><p>实现：建立第三张<code>中间表</code>，中间表至少包含<code>两个外键</code>，分别关联两方的主键</p><h5 id="学生表"><a href="#学生表" class="headerlink" title="学生表"></a>学生表</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> student<span class="token punctuation">(</span>    id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">,</span>    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">no</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'学生表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="课程表"><a href="#课程表" class="headerlink" title="课程表"></a>课程表</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> course<span class="token punctuation">(</span>    id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'课程表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="中间表"><a href="#中间表" class="headerlink" title="中间表"></a>中间表</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> stuent_course<span class="token punctuation">(</span>  id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>  studentid <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'学生id'</span><span class="token punctuation">,</span>  courseid <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'课程id'</span><span class="token punctuation">,</span>  <span class="token keyword">constraint</span> fk_courseid <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>courseid<span class="token punctuation">)</span> <span class="token keyword">references</span> course <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">,</span>  <span class="token keyword">constraint</span> fk_studentid <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>studentid<span class="token punctuation">)</span> <span class="token keyword">references</span> student <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'学生课程中间表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/4bc81f972452447aad104167e8e44414.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="三表关系"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p></li><li><p>一对一</p><p>案例：用户 - 用户详情</p><p>关系：一对一关系，多用于<code>单表拆分</code>，将一张表的基础字段放在一张表中，其他详情字段放在另一张表中，以提升操作效率</p><p>实现：在任意一方加入<code>外键</code>，关联另外一方的<code>主键</code>，并且设置外键为唯一的(<code>UNIQUE</code>)</p><p>用户基本信息表</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> user_basic<span class="token punctuation">(</span>   id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">comment</span> <span class="token string">'主键id'</span><span class="token punctuation">,</span>   name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   age <span class="token keyword">tinyint</span> <span class="token keyword">unsigned</span><span class="token punctuation">,</span>   gender <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   phone <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'用户基本信息表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用户受教育信息</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> user_edu<span class="token punctuation">(</span>    id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span>  <span class="token keyword">comment</span> <span class="token string">'主键id'</span><span class="token punctuation">,</span>    degree <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'学历'</span><span class="token punctuation">,</span>    major <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'专业'</span><span class="token punctuation">,</span>    primary_school <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    middle_school <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    college <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    userid <span class="token keyword">int</span> <span class="token keyword">unique</span> <span class="token keyword">comment</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span> <span class="token comment">-- 唯一约束</span>    <span class="token keyword">constraint</span> fk_userid <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>userid<span class="token punctuation">)</span> <span class="token keyword">references</span> user_basic<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'用户受教育信息'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-多表查询概述"><a href="#2-多表查询概述" class="headerlink" title="2. 多表查询概述"></a>2. 多表查询概述</h2><ul><li><p>概述：从多张表中查询数据</p></li><li><p>笛卡尔积：笛卡尔积是指在数学中，两个集合-集合A和集合B<code>所有的组合情况</code>。(在多表查询是，需要消除无效的笛卡尔积)</p><p>假如直接SELECT</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp<span class="token punctuation">,</span> dept<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><p><img src="https://img-blog.csdnimg.cn/9642105a097241219dfeaab3974e276f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="笛卡尔积"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p></li></ul><h3 id="问题来了，如何消除无效的笛卡尔积？"><a href="#问题来了，如何消除无效的笛卡尔积？" class="headerlink" title="问题来了，如何消除无效的笛卡尔积？"></a>问题来了，如何消除无效的笛卡尔积？</h3><p>两个表通过dept_id来建立联系</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp<span class="token punctuation">,</span> dept <span class="token keyword">where</span> emp<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> dept<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/a8d40012c6be43b385392abda1947863.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="指定关联字段"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><ul><li><p>多表查询分类</p><p>连接查询</p><p>​    <code>内连接</code>：查询 A ∩ B部分</p><p>​    <code>外连接</code>：</p><p>​            左外连接：查询 A + (A ∩ B)</p><p>​            右外连接：查询 B + (A ∩ B)</p><p>​    <code>自连接</code>：当前表与自身的连接连接，自查询必须使用表别名</p><p>子查询</p><p><img src="https://img-blog.csdnimg.cn/f560c997a6db4c04aec03c7a6dbd65dc.png" alt="示意图"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p></li></ul><h1 id="3-连接查询"><a href="#3-连接查询" class="headerlink" title="3.连接查询"></a>3.连接查询</h1><h4 id="3-1-内连接"><a href="#3-1-内连接" class="headerlink" title="3.1 内连接"></a>3.1 内连接</h4><p>内连接查询两张表的交集部分，即<code>A ∩ B</code></p><ul><li>隐式内连接  (上一节消除无效笛卡尔积的案例就是隐式内连接)</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表<span class="token number">1</span><span class="token punctuation">,</span> 表<span class="token number">2</span> <span class="token keyword">WHERE</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>显式内连接</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表<span class="token number">1</span> <span class="token punctuation">[</span><span class="token keyword">INNER</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> 表<span class="token number">2</span> <span class="token keyword">ON</span> 连接条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>案例：查询每个员工的姓名与其对应的部门</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 隐式内连接</span><span class="token keyword">select</span> e<span class="token punctuation">.</span>name<span class="token punctuation">,</span> d<span class="token punctuation">.</span>id <span class="token keyword">from</span> emp e<span class="token punctuation">,</span> dept d <span class="token keyword">where</span> e<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>一旦给表起定别名，真实的名字就无法使用了</p></blockquote><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 显示内连接</span><span class="token keyword">select</span> e<span class="token punctuation">.</span>name<span class="token punctuation">,</span> d<span class="token punctuation">.</span>id <span class="token keyword">from</span> emp e <span class="token keyword">inner</span> <span class="token keyword">join</span> dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>注意，我么查到了6个人，如下图所示</p><p><img src="https://img-blog.csdnimg.cn/65a0b53685fe4027af4706e8dab1ae44.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="res"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>但实际上数据库中有7个人，还有一个人没有显示的原因是他是实习生，还没有关联部门的外键，因此不属于两张表的<code>交集</code>。</p><p><img src="https://img-blog.csdnimg.cn/684b5a53278242bab88cf5ca67ba77ac.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="res"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><h4 id="3-2-外连接"><a href="#3-2-外连接" class="headerlink" title="3.2 外连接"></a>3.2 外连接</h4><ul><li><p>左外连接</p><p>查询 <code>A + (A ∩ B)</code></p></li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表<span class="token number">1</span> <span class="token keyword">LEFT</span> <span class="token punctuation">[</span><span class="token keyword">OUTER</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> 表<span class="token number">2</span> <span class="token keyword">ON</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/7079446a9a6f4f4dbfca66db97d3d2c9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="左外连接"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>​    这次就可以将每位员工的数据查询出来了，包括没有与第二行表关联的员工</p><ul><li><p>右外连接</p><p>查询<code>B + (A ∩ B)</code></p></li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表<span class="token number">1</span> <span class="token keyword">RIGHT</span> <span class="token punctuation">[</span><span class="token keyword">OUTER</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> 表<span class="token number">2</span> <span class="token keyword">ON</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/1b2dce823d5448a89920a34a30fa5430.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="右外连接"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>通常<code>左外连接</code>用的会多一些，因为右外连接都可以通过颠倒两张表的顺序改成左外连接。</p><p>下面两条语句的效果是完全一样的，区别就在于两张表的查询顺序</p><p>但实质上都是取部门表的全部数据+部门表与员工表的交集部分</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> d<span class="token punctuation">.</span>id <span class="token punctuation">,</span> e<span class="token punctuation">.</span>name <span class="token keyword">from</span> dept d <span class="token keyword">left</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> emp e <span class="token keyword">on</span> e<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span class="token keyword">select</span> d<span class="token punctuation">.</span>id <span class="token punctuation">,</span> e<span class="token punctuation">.</span>name <span class="token keyword">from</span> emp e <span class="token keyword">left</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> d<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="3-4-自连接"><a href="#3-4-自连接" class="headerlink" title="3.4 自连接"></a>3.4 自连接</h4><pre class="line-numbers language-自连接```可以是```内连接```，也可以是```外连接```，只不过两张表都是他自己罢了。一定要起一个别名。" data-language="自连接```可以是```内连接```，也可以是```外连接```，只不过两张表都是他自己罢了。一定要起一个别名。"><code class="language-自连接```可以是```内连接```，也可以是```外连接```，只不过两张表都是他自己罢了。一定要起一个别名。">```sqlSELECT 字段们 FROM 表A 别名A JOIN 表A 别名B ON 条件;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>自连接 + 内连接</li></ul><p>虽然这是在同一张表内查询，但是需要把他们看作两张表进行内连接查询。</p><p>但是内连接是取<code>交集</code>，因此如果有员工没有领导就不会被查出来。</p><p><img src="https://img-blog.csdnimg.cn/e0b2946cccfd4f568e26d67685324513.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="自连接 + 内连接"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><ul><li>自连接 + 外连接</li><li><img src="https://img-blog.csdnimg.cn/dcabe801e1b049ca8536150b3e22808d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="自连接 + 外连接"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></li></ul><h4 id="3-5-联合查询"><a href="#3-5-联合查询" class="headerlink" title="3.5 联合查询"></a>3.5 联合查询</h4><p>把多次查询的结果<code>合并起来</code>，形成一个新的查询结果集。</p><p>查询前提：多条查询返回的字段数量与类型需要相同。</p><p><code>UNION ALL</code>不去重，<code>UNION</code>会去重。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表A<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token keyword">UNION</span> <span class="token punctuation">[</span><span class="token keyword">ALL</span><span class="token punctuation">]</span><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表B<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>案例：</p><p>查询 薪资低于11000 和 年龄大于40 的员工</p><p><img src="https://img-blog.csdnimg.cn/08c7ab851d7d435e8e6dfa83bdcf3553.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQW1va3Jf,size_20,color_FFFFFF,t_70,g_se,x_16" alt="UNION"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>如果用<code>UNION ALL</code>会出现重复的数据，如果某个人同时满足，此时用<code>UNION</code>就可以去重。</p>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux - 3 Shell</title>
      <link href="/2022/03/09/Linux3%20shell/"/>
      <url>/2022/03/09/Linux3%20shell/</url>
      
        <content type="html"><![CDATA[<h1 id="Shell-语法"><a href="#Shell-语法" class="headerlink" title="Shell 语法"></a>Shell 语法</h1><h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><h5 id="1-概论"><a href="#1-概论" class="headerlink" title="1.概论"></a>1.<a href="#index1">概论</a></h5><h5 id="2-注释"><a href="#2-注释" class="headerlink" title="2.注释"></a>2.<a href="#index2">注释</a></h5><h5 id="3-变量"><a href="#3-变量" class="headerlink" title="3.变量"></a>3.<a href="#index3">变量</a></h5><h5 id="4-默认变量"><a href="#4-默认变量" class="headerlink" title="4.默认变量"></a>4.<a href="#index4">默认变量</a></h5><h5 id="5-数组"><a href="#5-数组" class="headerlink" title="5.数组"></a>5.<a href="#index5">数组</a></h5><h5 id="6-expr命令"><a href="#6-expr命令" class="headerlink" title="6.expr命令"></a>6.<a href="#index6">expr命令</a></h5><h5 id="7-read命令"><a href="#7-read命令" class="headerlink" title="7.read命令"></a>7.<a href="#index7">read命令</a></h5><h5 id="8-echo命令"><a href="#8-echo命令" class="headerlink" title="8.echo命令"></a>8.<a href="#index8">echo命令</a></h5><h5 id="9-printf命令test命令与判断符号"><a href="#9-printf命令test命令与判断符号" class="headerlink" title="9.printf命令test命令与判断符号[]"></a>9.<a href="#index9">printf命令test命令与判断符号[]</a></h5><h5 id="10-判断语句"><a href="#10-判断语句" class="headerlink" title="10.判断语句"></a>10.<a href="#index10">判断语句</a></h5><h5 id="11-循环语句"><a href="#11-循环语句" class="headerlink" title="11.循环语句"></a>11.<a href="#index11">循环语句</a></h5><h5 id="12-函数"><a href="#12-函数" class="headerlink" title="12.函数"></a>12.<a href="#index12">函数</a></h5><h5 id="13-exit命令"><a href="#13-exit命令" class="headerlink" title="13.exit命令"></a>13.<a href="#index13">exit命令</a></h5><h5 id="14-文件重定向"><a href="#14-文件重定向" class="headerlink" title="14.文件重定向"></a>14.<a href="#index14">文件重定向</a></h5><h5 id="15-引入外部脚本"><a href="#15-引入外部脚本" class="headerlink" title="15.引入外部脚本"></a>15.<a href="#index15">引入外部脚本</a></h5><p>====================================================================================================================</p><h3 id="1-概论-1"><a href="#1-概论-1" class="headerlink" title="1.概论"></a><span id="index1">1.概论</span></h3><h3 id="2-注释-1"><a href="#2-注释-1" class="headerlink" title="2.注释"></a><span id="index2">2.注释</span></h3><h3 id="3-变量-1"><a href="#3-变量-1" class="headerlink" title="3.变量"></a><span id="index3">3.变量</span></h3><h5 id="3-1定义变量"><a href="#3-1定义变量" class="headerlink" title="3.1定义变量"></a>3.1定义变量</h5><p>定义变量的三种方式</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a='variable1' # 单引号定义b="variable2" # 双引号定义c=variable3   # 啥都不用加<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="3-2使用变量"><a href="#3-2使用变量" class="headerlink" title="3.2使用变量"></a>3.2使用变量</h5><p>使用变量的值需要加<code>$</code>或者<code>${}</code>,花括号主要是为了辅助解释器识别变量边界</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#! /bin/bashv1='variable1'v2="variable2"v3=variable3echo $v1echo ${v2}echo ${v3}是个大坏蛋<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>variable1<br>variable2<br>variable3是个大坏蛋</p></blockquote><h5 id="3-3-只读变量"><a href="#3-3-只读变量" class="headerlink" title="3.3 只读变量"></a>3.3 只读变量</h5><p>关键字<code>readonly</code>和<code>declare -r</code>都可以将一个变量声明为只读，相当于C/C++中的const</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a="fish"                                                        echo $areadonly a# 方式一declare -r a# 方式二a="pig"echo $a# 会报错，因为前面把它声明为readonly了<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>fish<br>./test.sh: line 9: a: readonly variable<br>fish</p></blockquote><h5 id="3-4-删除变量"><a href="#3-4-删除变量" class="headerlink" title="3.4 删除变量"></a>3.4 删除变量</h5><p>关键词<code>unset</code>删除变量</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a="fish"echo $aunset aecho ${a}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>fish</p></blockquote><h5 id="3-5-变量类型"><a href="#3-5-变量类型" class="headerlink" title="3.5 变量类型"></a>3.5 变量类型</h5><ol><li><p>自定义变量(局部变量)</p><p>子进程不可以访问</p></li><li><p>环境变量(全局变量)</p><p>子进程可以访问</p></li></ol><p>局部变量 —&gt; 全局变量</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">acs@9e0ebfcd82d7:~$ name=yxc  # 定义变量acs@9e0ebfcd82d7:~$ export name  # 第一种方法acs@9e0ebfcd82d7:~$ declare -x name  # 第二种方法<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>全局变量 —&gt; 局部变量</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">acs@9e0ebfcd82d7:~$ export name=yxc  # 定义全局变量acs@9e0ebfcd82d7:~$ declare +x name  # 改为局部变量<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="3-6-字符串"><a href="#3-6-字符串" class="headerlink" title="3.6 字符串"></a>3.6 字符串</h5><p>字符串可以用<code>单引号</code>，也可以用<code>双引号</code>,也可以<code>不用引号</code></p><p>区别：</p><ul><li>单引号中的内容会原样输出，不会执行，不会取变量的值</li><li>双引号中的内容可以执行，可以取变量的值</li></ul><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name=fish                                                                                                                                            echo '$hello, name \"hh\"'# 单引号没啥用echo "hello, $name \"hh\""# 双引号会小心翼翼地全部执行echo hello, $name \"hh\"# 不带引号也会小心翼翼地全部执行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>$hello, name \ “hh\ “<br>hello, fish “hh”<br>hello, fish “hh”</p></blockquote><h6 id="获取字符长度"><a href="#获取字符长度" class="headerlink" title="获取字符长度"></a>获取字符长度</h6><p> 格式：</p><pre class="line-numbers language-none"><code class="language-none">${#变量名}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name=fishecho ${#name}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>4</p></blockquote><h6 id="提取子串"><a href="#提取子串" class="headerlink" title="提取子串"></a>提取子串</h6><p>格式：</p><pre class="line-numbers language-none"><code class="language-none">${变量名:st:n}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以提取从下标st开始的长度为n的子串</p><p>下标从 0 开始</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name="1234567"echo ${name:2:5}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>34567</p></blockquote><h3 id="4-默认变量-1"><a href="#4-默认变量-1" class="headerlink" title="4.&nbsp; 默认变量"></a><span id="index4">4.&nbsp; 默认变量</span></h3><h5 id="4-1-文件参数变量"><a href="#4-1-文件参数变量" class="headerlink" title="4.1 文件参数变量"></a>4.1 文件参数变量</h5><p>在执行shell脚本时，可以向脚本传递参数。<code>$1</code>是第一个参数，<code>$2</code>是第二个参数，以此类推。特殊的，<code>$0</code>是文件名（包含路径）</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "filename: "$0                              echo "parameter1 : "$1echo "parameter2 : "$2echo "parameter3 : "$3echo "parameter4 : "$4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行该脚本：</p><blockquote><p>acs@08cd8080c823:~$ ./test.sh a b z x<br>filename: ./test.sh<br>parameter1 : a<br>parameter2 : b<br>parameter3 : z<br>parameter4 : x</p></blockquote><h5 id="4-2-其他参数相关变量"><a href="#4-2-其他参数相关变量" class="headerlink" title="4.2 其他参数相关变量"></a>4.2 其他参数相关变量</h5><table><thead><tr><th align="center">参数</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center"><code>$#</code></td><td align="center">代表文件传入的参数个数，如上例中值为4</td></tr><tr><td align="center"><code>$*</code></td><td align="center">由所有参数构成的用空格隔开的字符串，如上例中值为 <code>"$a $b $z $x"</code></td></tr><tr><td align="center"><code>$@</code></td><td align="center">每个参数分别用双引号括起来的字符串，如上例中值为 <code>"$1" "$2" "$3" "$4"</code></td></tr><tr><td align="center"><code>$$</code></td><td align="center">脚本当前运行的进程ID</td></tr><tr><td align="center"><code>$?</code></td><td align="center">上一条命令的退出状态（注意不是stdout，而是exit code）。0表示正常退出，其他值表示错误</td></tr><tr><td align="center"><code>$(command)</code></td><td align="center">返回<code>command</code>这条命令的stdout（可嵌套）</td></tr><tr><td align="center">‘command’</td><td align="center">返回<code>command</code>这条命令的stdout（不可嵌套）</td></tr></tbody></table><p>$(命令), ${变量名}</p><h3 id="5-数组-1"><a href="#5-数组-1" class="headerlink" title="5.&nbsp; 数组"></a><span id="index5">5.&nbsp; 数组</span></h3><p>数组中可以存放多个不同类型的值，只支持一维数组，初始化时不需要指明数组大小。<br>数组<em>下标从0开始</em>。</p><h5 id="5-1-定义数组"><a href="#5-1-定义数组" class="headerlink" title="5.1 定义数组"></a>5.1 定义数组</h5><p>数组用小括号表示，元素之间用空格隔开。</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">array=(1 abc "def" fish)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>也可以直接定义数组中的某个元素</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">array[0]=1array[1]=abcarray[2]="def"array[3]=fish<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="5-2-读取数组中的某个元素的值"><a href="#5-2-读取数组中的某个元素的值" class="headerlink" title="5.2 读取数组中的某个元素的值"></a>5.2 读取数组中的某个元素的值</h5><p>格式</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">${arr[index]} # 和读取变量一样<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>例如</p><pre class="line-numbers language-she" data-language="she"><code class="language-she">array=(1 abc "def" def)echo ${array[0]}echo ${array[1]}echo ${array[2]}echo ${array[3]}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="5-3-数组长度"><a href="#5-3-数组长度" class="headerlink" title="5.3 数组长度"></a>5.3 数组长度</h5><p>格式</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">${array[*]}# 写法一${array[@]}# 写法二<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>例如</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">array=(1 abc "def" yxc)echo ${#array[@]}  # 第一种写法echo ${#array[*]}  # 第二种写法<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>数组可以跳着赋值，并且没有赋值的位置不占用空间</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">dist[0]=12                                      dist[789]=fishdist[4]="abc"echo ${dist[0]}echo ${dist[4]}echo ${dist[789]}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>12<br>abc<br>fish</p></blockquote><h3 id="6-expr-表达式"><a href="#6-expr-表达式" class="headerlink" title="6. expr 表达式"></a><span id="index6">6. expr 表达式</span></h3><p><code>expr</code>命令用于求表达式的值,格式为</p><p><code>expr 表达式</code></p><p>表达式说明：</p><ul><li><p>用<code>空格</code>隔开每一项</p></li><li><p>用<code>反斜杠</code>放在shell特定的字符前面（发现表达式运行错误时，可以试试转义）</p></li><li><p>对<code>包含空格</code>和<code>其他特殊字符</code>的字符串要用<code>引号</code>括起来</p></li><li><p>expr会在s<code>tdout</code>中输出结果。如果为逻辑关系表达式，则结果为真，stdout为1，否则为0。</p></li><li><p>expr的exit code：如果为逻辑关系表达式，则结果为<code>真</code>，<code>exit code为0</code>，否则为1。</p></li></ul><h5 id="6-1-字符串表达式"><a href="#6-1-字符串表达式" class="headerlink" title="6.1 字符串表达式"></a>6.1 字符串表达式</h5><ul><li><code>length STRING</code> </li></ul><p>​          返回<code>STRING</code>的长度</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">str="Hello World"echo `expr length "$str"` # 需要将有空格的字符串用双引号括起来<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>11</p></blockquote><ul><li><code>index STRING CHARSET</code></li></ul><p>​        <code>CHARSET</code>中任意单个字符在<code>STRING</code>中最前面的字符位置，下标从1开始。如果在<code>STRING</code>中完全不存在<code>CHARSET</code>中的字符，则返回<code>0</code>。</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">str="Hello World"echo `expr index "$str" aWd`  # 输出7，下标从1开始<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><code>substr STRING POSITION LENGTH</code></li></ul><p>​        返回<code>STRING</code>字符串中从<code>POSITION</code>开始，长度最大为<code>LENGTH</code>的子串。如果<code>POSITION</code>或<code>LENGTH</code>为负数，0或非数值，则返回空字符串。</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">str="Hello World"echo `expr substr "$str" 2 3`  # 输出 ell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="6-2-整数表达式"><a href="#6-2-整数表达式" class="headerlink" title="6.2 整数表达式"></a>6.2 整数表达式</h5><p>expr支持普通的算术操作，算术表达式优先级低于字符串表达式，高于逻辑关系表达式。</p><ul><li><code>+ -</code><br>加减运算。两端参数会转换为整数，如果转换失败则报错。</li></ul><ul><li><code>* / %</code><br>乘，除，取模运算。两端参数会转换为整数，如果转换失败则报错。</li></ul><p><code>() </code>可以该表优先级，但需要用<code>反斜杠</code>转义</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=3b=4echo `expr $a + $b`  # 输出7echo `expr $a - $b`  # 输出-1echo `expr $a \* $b`  # 输出12，*需要转义echo `expr $a / $b`  # 输出0，整除echo `expr $a % $b` # 输出3echo `expr \( $a + 1 \) \* \( $b + 1 \)`  # 输出20，值为(a + 1) * (b + 1)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="6-3-逻辑关系表达式"><a href="#6-3-逻辑关系表达式" class="headerlink" title="6.3 逻辑关系表达式"></a>6.3 逻辑关系表达式</h5><ul><li><p><code>|</code><br>如果第一个参数非空且非0，则返回第一个参数的值，否则返回第二个参数的值，但要求第二个参数的值也是非空或非0，否则返回0。如果第一个参数是非空或非0时，不会计算第二个参数。</p></li><li><p><code>&amp;</code><br>如果两个参数都非空且非0，则返回第一个参数，否则返回0。如果第一个参为0或为空，则不会计算第二个参数。</p></li><li><p><code>&lt; &lt;= = == != &gt;= &gt;</code><br>比较两端的参数，如果为true，则返回1，否则返回0。”==”是”=”的同义词。”expr”首先尝试将两端参数转换为整数，并做算术比较，如果转换失败，则按字符集排序规则做字符比较。</p></li><li><p><code>()</code> 可以该表优先级，但需要用<code>反斜杠</code>转义</p></li></ul><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=3b=4echo `expr $a \&gt; $b`  # 输出0，&gt;需要转义echo `expr $a '&lt;' $b`  # 输出1，也可以将特殊字符用引号引起来echo `expr $a '&gt;=' $b`  # 输出0echo `expr $a \&lt;\= $b`  # 输出1c=0d=5echo `expr $c \&amp; $d`  # 输出0echo `expr $a \&amp; $b`  # 输出3echo `expr $c \| $d`  # 输出5echo `expr $a \| $b`  # 输出3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7-read命令-1"><a href="#7-read命令-1" class="headerlink" title="7. read命令"></a><span id="index7">7. read命令</span></h3><p><code>read</code>命令用于从标准输入中读取单行数据。当读到文件结束符时，exit code为1，否则为0。</p><p>参数说明</p><ul><li><p><code>-p</code>: 后面可以接提示信息</p></li><li><p>```shell<br>read -p “What’s your name? “ -t 3 name<br>echo “Hello, $name”</p><pre class="line-numbers language-none"><code class="language-none">  &gt;What's your name? fish  &gt;Hello, fish* `-t`：后面跟秒数，定义输入字符的等待时间，超过等待时间后会自动忽略此命令```shellread -p "What's your name? " name                               echo "Hello, $name"# 如果你啥都不输入，就在那里傻等着<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><blockquote><p>acs@08cd8080c823:<del>$ ./test.sh<br>What’s your name? Hello,<br>acs@08cd8080c823:</del>$ </p></blockquote><h3 id="8-echo命令-1"><a href="#8-echo命令-1" class="headerlink" title="8. echo命令"></a><span id="index8">8. echo命令</span></h3><p><code>echo</code>用于输出字符串，格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo STRING<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="8-1-显示普通字符串"><a href="#8-1-显示普通字符串" class="headerlink" title="8.1 显示普通字符串"></a>8.1 显示普通字符串</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "I'm a fish"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "I'm" a fish  # 双引号可以省略,但最好带着<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>I’m a fish</p></blockquote><h5 id="8-2-显示转义字符串"><a href="#8-2-显示转义字符串" class="headerlink" title="8.2 显示转义字符串"></a>8.2 显示转义字符串</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "\"Hello AC Terminal\""  # 注意只能使用双引号，如果使用单引号，则不转义<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo \"Hello AC Terminal\"  # 也可以省略双引号<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>“Hello AC Terminal” </p></blockquote><h5 id="8-3-显示变量"><a href="#8-3-显示变量" class="headerlink" title="8.3 显示变量"></a>8.3 显示变量</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 这个方式非常多name=fishecho "My name is "$nameecho "My name is $name"echo My name is $nameecho My name is ${name}# 但是如果你尝试使用'$name',解释器会直接输出$name,原封不动，和3.6的原则一样<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name=fishecho "Hello World, I'm $name"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>Hello World, I’m fish</p></blockquote><h5 id="8-4-显示换行-不换行"><a href="#8-4-显示换行-不换行" class="headerlink" title="8.4 显示换行/不换行"></a>8.4 显示换行/不换行</h5><p><code>-e</code>开启转义</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo -e "Hi\n"# -e 开启转义echo "What's your name"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>Hi</p><p>What’s your name</p></blockquote><h5 id="8-5-显示不换行"><a href="#8-5-显示不换行" class="headerlink" title="8.5 显示不换行"></a>8.5 显示不换行</h5><p>由于shell默认每次输出都换行，因此<code>-e</code>开启转移后可以用<code>\c</code>命令强制不换行</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo -e "Hi     \c" # -e 开启转义 \c 不换行echo "What's your name"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>Hi     What’s your name</p></blockquote><h5 id="8-6-原样输出字符串，不进行任何【取变量】或者【转义】"><a href="#8-6-原样输出字符串，不进行任何【取变量】或者【转义】" class="headerlink" title="8.6 原样输出字符串，不进行任何【取变量】或者【转义】"></a>8.6 原样输出字符串，不进行任何【取变量】或者【转义】</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name=fishscho '""$fish\n"'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>“$name\n”</p></blockquote><h5 id="显示命令的执行结果"><a href="#显示命令的执行结果" class="headerlink" title="显示命令的执行结果"></a>显示命令的执行结果</h5><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo 'date'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>Wed Mar 9 21:16:30 CST 2022</p></blockquote><h3 id="9-printf命令"><a href="#9-printf命令" class="headerlink" title="9. printf命令"></a><span id="index9">9. printf命令</span></h3><p><code>printf</code>命令用于格式化输出，类似于C/C++中的<code>printf</code>函数。</p><p>默认不会在字符串末尾添加换行符。</p><p>格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">printf format-string [arguments...]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">printf "My name is %s\n" fish# 格式化输出字符串                printf "%10d.\n" 12345# 占10位，正数左对齐printf "%-10.2f.\n" 123.45678# 占10位，负数右对齐printf "%d * %d = %d\n" 3 6 `expr 3 \* 6`# 表达式作为参数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>My name is fish<br>         12345.<br>123.46          .<br>3 * 6 = 18</p></blockquote><h3 id="10-test命令与判断符号"><a href="#10-test命令与判断符号" class="headerlink" title="10. test命令与判断符号[]"></a><span id="index10">10. test命令与判断符号[]</span></h3><h5 id="10-1-逻辑运算符-amp-amp-和"><a href="#10-1-逻辑运算符-amp-amp-和" class="headerlink" title="10.1 逻辑运算符 &amp;&amp; 和 ||"></a>10.1 逻辑运算符 &amp;&amp; 和 ||</h5><ul><li><p><code>&amp;&amp;</code> 表示与，<code>||</code> 表示或</p></li><li><p>二者具有短路原则：<br><code>expr1 &amp;&amp; expr2</code>：当expr1为假时，直接忽略expr2<br><code>expr1 || expr2</code>：当expr1为真时，直接忽略expr2</p></li><li><p>表达式的<code>exit code</code>为0，表示真；为非零，表示假。（与C/C++中的定义相反）</p></li></ul><h5 id="10-2-test命令"><a href="#10-2-test命令" class="headerlink" title="10.2 test命令"></a>10.2 test命令</h5><p>在命令行中输入·man test·，可以查看·test·命令的用法。</p><p><code>test</code>命令用于【判断文件类型】，以及【对变量做比较】。</p><p><code>test</code>命令用<code>exit code</code>返回结果，而不是使用stdout。0表示真，非0表示假。</p><p>例如，</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">test -1 -lt 99 # 为真，返回值为0echo $?# 输出上个命令的返回值，输出0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">acs@9e0ebfcd82d7:~$ ls  # 列出当前目录下的所有文件homework  output.txt  test.sh  tmpacs@9e0ebfcd82d7:~$ test -e test.sh &amp;&amp; echo "exist" || echo "Not exist"exist  # test.sh 文件存在acs@9e0ebfcd82d7:~$ test -e test2.sh &amp;&amp; echo "exist" || echo "Not exist"Not exist  # testh2.sh 文件不存在<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="10-2-文件类型判断"><a href="#10-2-文件类型判断" class="headerlink" title="10.2 文件类型判断"></a>10.2 文件类型判断</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">test -e filename # 判断文件是否存在<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th align="center">参数</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-e</td><td align="center">exist 文件是否存在</td></tr><tr><td align="center">-f</td><td align="center">file 是否为问价</td></tr><tr><td align="center">-d</td><td align="center">directory 是否为目录(文件夹)</td></tr></tbody></table><h5 id="10-3-文件权限判断"><a href="#10-3-文件权限判断" class="headerlink" title="10.3 文件权限判断"></a>10.3 文件权限判断</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">test -f filename # 判断文件是否可读<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>-f</td><td>read 文件是否可读</td></tr><tr><td>-w</td><td>write 文件是否可写</td></tr><tr><td>-x</td><td>execuate 文件是否可执行</td></tr><tr><td>-s</td><td>是否为非空文件</td></tr></tbody></table><h5 id="10-3-整数间的判断"><a href="#10-3-整数间的判断" class="headerlink" title="10.3 整数间的判断"></a>10.3 整数间的判断</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">test $a -eq $b# 判断a是否等于b，即判断 a==b<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th align="center">参数</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-eq</td><td align="center">==</td></tr><tr><td align="center">-ne</td><td align="center">!=</td></tr><tr><td align="center">-gt</td><td align="center">&gt;</td></tr><tr><td align="center">-lt</td><td align="center">&lt;</td></tr><tr><td align="center">-ge</td><td align="center">&gt;=</td></tr><tr><td align="center">-le</td><td align="center">&lt;=</td></tr></tbody></table><h5 id="10-4-字符串比较"><a href="#10-4-字符串比较" class="headerlink" title="10.4 字符串比较"></a>10.4 字符串比较</h5><table><thead><tr><th align="center">参数</th><th align="center">代表意义</th></tr></thead><tbody><tr><td align="center">test -z STR</td><td align="center">str为空，返回true</td></tr><tr><td align="center">test -n str</td><td align="center">str不为空，返回true (-n可以省略)</td></tr><tr><td align="center">test str1 == str2</td><td align="center">判断是否相等</td></tr><tr><td align="center">test str1 != str2</td><td align="center">判断是否不等</td></tr></tbody></table><h5 id="10-5-多重条件判定"><a href="#10-5-多重条件判定" class="headerlink" title="10.5 多重条件判定"></a>10.5 多重条件判定</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">test -r filename -a -x filename<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>-a</td><td>AND</td></tr><tr><td>-o</td><td>OR</td></tr><tr><td>!</td><td>NOT</td></tr></tbody></table><blockquote><p>!相当于取反，例如test ! -x filename，当filename不可执行时，返回true</p></blockquote><h5 id="10-6-判断符号"><a href="#10-6-判断符号" class="headerlink" title="10.6 判断符号[]"></a>10.6 判断符号[]</h5><p><code>[]</code>与<code>test</code>的用法几乎一模一样，更常用于<code>if语句</code>中。此外，<code>[[]]</code>是<code>[]</code>的加强版本，支持更多的特性</p><p>例如：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[ 2 -lt 3 ]  # 为真，返回值为0echo $?  # 输出上个命令的返回值，输出0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">acs@9e0ebfcd82d7:~$ ls  # 列出当前目录下的所有文件homework  output.txt  test.sh  tmpacs@9e0ebfcd82d7:~$ [ -e test.sh ] &amp;&amp; echo "exist" || echo "Not exist"exist  # test.sh 文件存在acs@9e0ebfcd82d7:~$ [ -e test2.sh ] &amp;&amp; echo "exist" || echo "Not exist"Not exist  # testh2.sh 文件不存在<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意：</p><ul><li><code>[]</code>内的每一项都要用<code>空格隔开</code></li><li>中括号内的变量，最好用<code>双引号</code>括起来</li><li>中括号内的常熟，最好用但或双引号括起来</li></ul><p>例如：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">name="Hello World"[ $name == "Hello World" ]  # 错误，等价于 [ Hello World == "Hello World" ]，参数太多[ "$name" == "Hello World" ]  # 正确<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="11-判断语句"><a href="#11-判断语句" class="headerlink" title="11. 判断语句"></a><span id="index11">11. 判断语句</span></h3><h4 id="11-1-if-then形式"><a href="#11-1-if-then形式" class="headerlink" title="11.1 if - then形式"></a>11.1 if - then形式</h4><p>类似 C/C++中的<code>if - else</code>语句</p><h5 id="11-1-1-单层if"><a href="#11-1-1-单层if" class="headerlink" title="11.1.1 单层if"></a>11.1.1 单层if</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">if conditionthen    语句1    语句2    ...fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=3b=4if [ "$a" -lt "$b" ] &amp;&amp; [ "$a" -gt 2 ]then    echo ${a}在范围内fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>3在范围内</p></blockquote><h5 id="11-1-2-单层if-else"><a href="#11-1-2-单层if-else" class="headerlink" title="11.1.2 单层if - else"></a>11.1.2 单层if - else</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">if conditionthen    语句1    语句2    ...else    语句1    语句2    ...fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=3b=4if ! [ "$a" -lt "$b" ]then    echo ${a}不小于${b}else    echo ${a}小于${b}fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>3小于4</p></blockquote><h5 id="11-1-3-多层if-elif-elif-else"><a href="#11-1-3-多层if-elif-elif-else" class="headerlink" title="11.1.3 多层if - elif - elif - else"></a>11.1.3 多层if - elif - elif - else</h5><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">if conditionthen    语句1    语句2    ...elif conditionthen    语句1    语句2    ...elif conditionthen    语句1    语句2else    语句1    语句2    ...fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=4if [ $a -eq 1 ]then    echo ${a}等于1elif [ $a -eq 2 ]then    echo ${a}等于2elif [ $a -eq 3 ]then    echo ${a}等于3else    echo 其他fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>其他</p></blockquote><h4 id="11-2-case…esca形式"><a href="#11-2-case…esca形式" class="headerlink" title="11.2 case…esca形式"></a>11.2 case…esca形式</h4><p>类似 C/C++ 中的<code>switch</code>语句</p><p>命令格式：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">case $变量名称 in    值1)        语句1        语句2        ...        ;;  # 两个分号，类似于C/C++中的break    值2)        语句1        语句2        ...        ;;    *)  # 类似于C/C++中的default        语句1        语句2        ...        ;;esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">a=4case $a in    1)        echo ${a}等于1        ;;      2)        echo ${a}等于2        ;;      3)                                                        echo ${a}等于3        ;;      *)        echo 其他        ;;  esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>其他</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux - 2 tmux和vim</title>
      <link href="/2022/03/07/Linux2%20tmux%E5%92%8Cvim/"/>
      <url>/2022/03/07/Linux2%20tmux%E5%92%8Cvim/</url>
      
        <content type="html"><![CDATA[<h1 id="tmux"><a href="#tmux" class="headerlink" title="tmux"></a>tmux</h1><h5 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">(1) 分屏。(2) 允许断开Terminal连接后，继续运行进程。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">一个tmux可以包含多个session，一个session可以包含多个window，一个window可以包含多个pane。  实例：      tmux:          session 0:              window 0:                  pane 0                  pane 1                  pane 2                  ...              window 1              window 2              ...          session 1          session 2          ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">(1) tmux：新建一个session，其中包含一个window，window中包含一个pane，pane里打开了一个shell对话框。(2) 按下Ctrl + b后手指松开，然后按%：将当前pane左右平分成两个pane。(3) 按下Ctrl + b后手指松开，然后按"（注意是双引号"）：将当前pane上下平分成两个pane。(4) Ctrl + d：关闭当前pane；如果当前window的所有pane均已关闭，则自动关闭window；如果当前session的所有window均已关闭，则自动关闭session。(5) 鼠标点击可以选pane。(6) 按下ctrl + b后手指松开，然后按方向键：选择相邻的pane。(7) 鼠标拖动pane之间的分割线，可以调整分割线的位置。(8) 按住ctrl + b的同时按方向键，可以调整pane之间分割线的位置。(9) 按下ctrl + b后手指松开，然后按z：将当前pane全屏/取消全屏。(10) 按下ctrl + b后手指松开，然后按d：挂起当前session。(11) tmux a：打开之前挂起的session。(12) 按下ctrl + b后手指松开，然后按s：选择其它session。     方向键 —— 上：选择上一项 session/window/pane     方向键 —— 下：选择下一项 session/window/pane     方向键 —— 右：展开当前项 session/window     方向键 —— 左：闭合当前项 session/window(13) 按下Ctrl + b后手指松开，然后按c：在当前session中创建一个新的window。(14) 按下Ctrl + b后手指松开，然后按w：选择其他window，操作方法与(12)完全相同。(15) 按下Ctrl + b后手指松开，然后按PageUp：翻阅当前pane内的内容。用ctrl+c退出阅读模式。(16) 鼠标滚轮：翻阅当前pane内的内容。(17) 在tmux中选中文本时，需要按住shift键。（仅支持Windows和Linux，不支持Mac，不过该操作并不是必须的，因此影响不大）(18) tmux中复制/粘贴文本的通用方式：    (1) 按下Ctrl + b后松开手指，然后按[    (2) 用鼠标选中文本，被选中的文本会被自动复制到tmux的剪贴板    (3) 按下Ctrl + b后松开手指，然后按]，会将剪贴板中的内容粘贴到光标处<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ctrl+s 暂停屏幕输出<br>ctrl+q 恢复屏幕输出<br>ctrl+l 清屏，等同于Clear</p><h1 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h1><p>功能</p><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">(1) 命令行模式下的文本编辑器。(2) 根据文件扩展名自动判别编程语言。支持代码缩进、代码高亮等功能。(3) 使用方式：vim filename如果已有该文件，则打开它。如果没有该文件，则打开个一个新的文件，并命名为filename<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">(1) 一般命令模式默认模式。命令输入方式：类似于打游戏放技能，按不同字符，即可进行不同操作。可以复制、粘贴、删除文本等。(2) 编辑模式在一般命令模式里按下i，会进入编辑模式。按下ESC会退出编辑模式，返回到一般命令模式。 不管当前是编辑模式还是命令模式，esc之后都到默认模式。(3) 命令行模式在一般命令模式里按下:/?三个字母中的任意一个，会进入命令行模式。命令行在最下面。可以查找、替换、保存、退出、配置编辑器等。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="操作-1"><a href="#操作-1" class="headerlink" title="操作"></a>操作</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">(1) i：进入编辑模式(2) ESC：进入一般命令模式(3) h 或 左箭头键：光标向左移动一个字符(4) j 或 向下箭头：光标向下移动一个字符(5) k 或 向上箭头：光标向上移动一个字符(6) l 或 向右箭头：光标向右移动一个字符(7) n&lt;Space&gt;：n表示数字，按下数字后再按空格，光标会向右移动这一行的n个字符(8) 0 或 功能键[Home]：光标移动到本行开头(9) $ 或 功能键[End]：光标移动到本行末尾(10) G：光标移动到最后一行(11) :n 或 nG：n为数字，光标移动到第n行(12) gg：光标移动到第一行，相当于1G(13) n&lt;Enter&gt;：n为数字，光标向下移动n行(14) /word：向光标之下寻找第一个值为word的字符串。(15) ?word：向光标之上寻找第一个值为word的字符串。(16) n：重复前一个查找操作(17) N：反向重复前一个查找操作(18) :n1,n2s/word1/word2/g：n1与n2为数字，在第n1行与n2行之间寻找word1这个字符串，并将该字符串替换为  word2(19) :1,$s/word1/word2/g：将全文的word1替换为word2(20) :1,$s/word1/word2/gc：将全文的word1替换为word2，且在替换前要求用户确认。(21) v：选中文本(22) d：删除选中的文本    d + nG ---&gt; 从删除当前行到第n行(23) dd: 删除当前行(24) y：复制选中的文本(25) yy: 复制当前行(26) p: 将复制的数据在光标的下一行/下一个位置粘贴(27) u：撤销(28) Ctrl + r：取消撤销(29) 大于号 &gt;：将选中的文本整体向右缩进一次(30) 小于号 &lt;：将选中的文本整体向左缩进一次(31) :w 保存(32) :w! 强制保存(33) :q 退出(34) :q! 强制退出(35) :wq 保存并退出(36) :set paste 设置成粘贴模式，取消代码自动缩进(37) :set nopaste 取消粘贴模式，开启代码自动缩进(38) :set nu 显示行号(39) :set nonu 隐藏行号(40) gg=G：将全文代码格式化(41) :noh 关闭查找关键词高亮(42) Ctrl + q：当vim卡死时，可以取消当前正在执行的命令<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h5><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">每次用vim编辑文件时，会自动创建一个.filename.swp的临时文件。如果打开某个文件时，该文件的swp文件已存在，则会报错。(具体是指，在tmux一个pane里面打开该文件，新开一个pane并且打开相同的文件，就会冲突)此时解决办法有两种：(1) 找到正在打开该文件的程序，并退出(2) 直接删掉该swp文件即可<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Vim内部粘贴板，需要在【Vim默认模式（一般命令模式）】下使用</p><p>​    y - 复制</p><p>​    d - 剪切</p><p>​    p - 粘贴</p><p>系统提供粘贴板，支持【Vim外部】与【Vim内部编辑模式】下使用</p><p>​    ctrl + insert - 复制</p><p>​    shift + insert - 粘贴</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux - 1 常用文件管理命令</title>
      <link href="/2022/03/07/Linux1%20%E5%B8%B8%E7%94%A8%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4/"/>
      <url>/2022/03/07/Linux1%20%E5%B8%B8%E7%94%A8%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h5 id="1-ctrl-c"><a href="#1-ctrl-c" class="headerlink" title="(1) ctrl c"></a>(1) ctrl c</h5><p>​    取消命令，并且换行</p><p>​    杀死某个进程</p><h5 id="2-ctrl-u"><a href="#2-ctrl-u" class="headerlink" title="(2) ctrl u"></a>(2) ctrl u</h5><p>​    清空本行命令</p><h5 id="3-tab键"><a href="#3-tab键" class="headerlink" title="(3) tab键"></a>(3) tab键</h5><p>​    可以补全命令和文件名，如果补全不了快速按两下tab键，可以显示备选选项</p><p>​    此外， ↑↓方向键可以显示上一条命令或者下一条命令</p><h5 id="4-ls"><a href="#4-ls" class="headerlink" title="(4) ls"></a>(4) ls</h5><p>​    列出当前目录下所有文件，</p><p>​    蓝色的是文件夹，</p><p>​    白色的是普通文件，</p><p>​    绿色的是可执行文件</p><h5 id="ls-l"><a href="#ls-l" class="headerlink" title="ls -l"></a>ls -l</h5><p>​        查看每一个文件的详细信息</p><h5 id="ls-lh"><a href="#ls-lh" class="headerlink" title="ls -lh"></a>ls -lh</h5><p>​        假如某个文件大小是30952Byte，这个单位不容易查看，输入参数h就会显示31K</p><h5 id="ls-a-all"><a href="#ls-a-all" class="headerlink" title="ls -a      (all)"></a>ls -a      (all)</h5><p>​    可以看到很多被隐藏的文件(如果文件名以【.】一个点开头就是隐藏文件)</p><h5 id="ls-A"><a href="#ls-A" class="headerlink" title="ls -A"></a>ls -A</h5><p>​    不显示当前目录，上层目录</p><h5 id="5-pwd"><a href="#5-pwd" class="headerlink" title="(5) pwd:"></a>(5) pwd:</h5><p>​    显示当前路径</p><h5 id="6-cd-文件名-change-directory"><a href="#6-cd-文件名-change-directory" class="headerlink" title="(6) cd 文件名     (change directory)"></a>(6) cd 文件名     (change directory)</h5><p>​    进入该文件目录下, </p><h5 id="cd"><a href="#cd" class="headerlink" title="cd .."></a>cd ..</h5><p>​    返回上层目录</p><h5 id="cd-1"><a href="#cd-1" class="headerlink" title="cd -"></a>cd -</h5><pre><code> 返回上一个呆过的目录</code></pre><h5 id="7-cp-已有文件a-新建文件b-复制-粘贴-重命名"><a href="#7-cp-已有文件a-新建文件b-复制-粘贴-重命名" class="headerlink" title="(7) cp 已有文件a 新建文件b      (复制+粘贴+重命名)"></a>(7) cp 已有文件a 新建文件b      (复制+粘贴+重命名)</h5><p>​    将文件a复制成文件b，b可以是一个路径，比如../dir_c/b.txt，表示上层目录下的dir_c文件夹下的文件b.txt</p><h5 id="8-mkdir-文件夹名a"><a href="#8-mkdir-文件夹名a" class="headerlink" title="(8) mkdir 文件夹名a"></a>(8) mkdir 文件夹名a</h5><p>​    创建目录a</p><pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">创建有空格个文件夹名mkdir a\ b ---&gt; 文件名为'a b'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="mkdir-a-b-c-p"><a href="#mkdir-a-b-c-p" class="headerlink" title="mkdir a/b/c -p"></a>mkdir a/b/c -p</h5><p>​     创建嵌套的父子文件夹</p><h5 id="9-rm-文件名a"><a href="#9-rm-文件名a" class="headerlink" title="(9) rm 文件名a"></a>(9) rm 文件名a</h5><p>​    删除普通文件</p><h5 id="rm-文件夹名a-r"><a href="#rm-文件夹名a-r" class="headerlink" title="rm 文件夹名a -r:"></a>rm 文件夹名a -r:</h5><p>​    删除文件夹</p><p>​     -r 递归删除</p><p>​     rm *.txt 删除所有的txt文件</p><p>​     rm a.txt b.txt 同时删除两个</p><h5 id="10-mv-旧文件a-旧文件b-剪切-粘贴"><a href="#10-mv-旧文件a-旧文件b-剪切-粘贴" class="headerlink" title="(10) mv 旧文件a 旧文件b      (剪切+粘贴)"></a>(10) mv 旧文件a 旧文件b      (剪切+粘贴)</h5><p>​    将XXX文件移动到YYY，和cp命令一样，XXX和YYY可以是一个路径；</p><p>​    <em>重命名</em>也是用这个命令</p><h5 id="11-touch-XXX"><a href="#11-touch-XXX" class="headerlink" title="(11) touch XXX:"></a>(11) touch XXX:</h5><p>​    创建一个文件</p><h5 id="12-cat-文件a"><a href="#12-cat-文件a" class="headerlink" title="(12) cat 文件a:"></a>(12) cat 文件a:</h5><p>​    展示文件a中的内容</p><h5 id="13-复制文本"><a href="#13-复制文本" class="headerlink" title="(13) 复制文本"></a>(13) 复制文本</h5><p>​    windows/Linux下：Ctrl + insert，Mac下：command + c</p><h5 id="14-粘贴文本"><a href="#14-粘贴文本" class="headerlink" title="(14) 粘贴文本"></a>(14) 粘贴文本</h5><p>​    windows/Linux下：Shift + insert，Mac下：command + v</p><p>一套后端框架可以服务多个应用(app, web…)</p><p>当前端点击一个链接，将这个URL作为函数参数传到后端，后端返回一个HTML文件，前端渲染成精美的网页。‘</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">string f(URL){......return HTML;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根目录： /</p><p>home：所有用户的家目录</p><p>bin：存常用可执行文件命令</p><p>etc：配置文件(部署一个网页 如nginx)</p><p>var : log -文件日志</p><p>lib：安装包，头文件</p><p>proc：进程相关信息</p><h3 id="一个点代表当前目录"><a href="#一个点代表当前目录" class="headerlink" title=". 一个点代表当前目录"></a>. 一个点代表当前目录</h3><h3 id="两个点代表上一层目录"><a href="#两个点代表上一层目录" class="headerlink" title=".. 两个点代表上一层目录"></a>.. 两个点代表上一层目录</h3><h3 id="代表home里面某个用户的家目录-俗称回城"><a href="#代表home里面某个用户的家目录-俗称回城" class="headerlink" title="~/ 代表home里面某个用户的家目录 俗称回城"></a>~/ 代表home里面某个用户的家目录 俗称回城</h3>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySql - 7 约束</title>
      <link href="/2022/03/06/Mysql7%20%E7%BA%A6%E6%9D%9F/"/>
      <url>/2022/03/06/Mysql7%20%E7%BA%A6%E6%9D%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h1><h5 id="Defination：作用于表中字段上的规则，限制表结构中存储的数据"><a href="#Defination：作用于表中字段上的规则，限制表结构中存储的数据" class="headerlink" title="Defination：作用于表中字段上的规则，限制表结构中存储的数据"></a>Defination：作用于表中字段上的规则，限制表结构中存储的数据</h5><h5 id="Target：保证数据库中数据的正确、有效性和完整性"><a href="#Target：保证数据库中数据的正确、有效性和完整性" class="headerlink" title="Target：保证数据库中数据的正确、有效性和完整性"></a>Target：保证数据库中数据的正确、有效性和完整性</h5><h5 id="Classification："><a href="#Classification：" class="headerlink" title="Classification："></a>Classification：</h5><table><thead><tr><th align="center">约束</th><th align="center">描述</th><th align="center">关键字</th></tr></thead><tbody><tr><td align="center">非空约束</td><td align="center">限制该字段的数据不能为NULL</td><td align="center">NOT NULL</td></tr><tr><td align="center">唯一约束</td><td align="center">保证该字段的所有数据都是唯一、不重复的</td><td align="center">UNIQUE</td></tr><tr><td align="center">主键约束</td><td align="center">主键是一行数据的唯一标识，要求【非空】且【唯一】</td><td align="center">PRIMARY KEY</td></tr><tr><td align="center">默认约束</td><td align="center">保存数据时，如果未指定该字段的值，则采用默认值</td><td align="center">DEFAULT</td></tr><tr><td align="center">检查约束(8.0.16版本之后)</td><td align="center">保证字段值满足某一个条件</td><td align="center">CHECK</td></tr><tr><td align="center">外键约束</td><td align="center">让两张表的数据之间建立连接，保证数据的一致性和完整性</td><td align="center">FOREIGN KEY</td></tr></tbody></table><p>约束是作用于表中【字段】上的，可以在【创建表/修改表】的时候添加约束</p><p>对于一个字段可以添加【多个】约束</p><p>多个约束之间用【空格分隔】即可</p><h5 id="如果插入一条【非法数据】，会提示插入失败，然而数据库还是为他申请了主键，因此自增的主键会空缺一条。"><a href="#如果插入一条【非法数据】，会提示插入失败，然而数据库还是为他申请了主键，因此自增的主键会空缺一条。" class="headerlink" title="如果插入一条【非法数据】，会提示插入失败，然而数据库还是为他申请了主键，因此自增的主键会空缺一条。"></a>如果插入一条【非法数据】，会提示插入失败，然而数据库还是为他申请了主键，因此自增的主键会空缺一条。</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> stu<span class="token punctuation">(</span>    id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键，自动增长'</span><span class="token punctuation">,</span>    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">COMMENT</span> <span class="token string">'不为空，且唯一'</span><span class="token punctuation">,</span>    age <span class="token keyword">tinyint</span> <span class="token keyword">unsigned</span> <span class="token keyword">CHECK</span> <span class="token punctuation">(</span> age <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">AND</span> age <span class="token operator">&lt;=</span> <span class="token number">120</span> <span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'大于0，且小于等于120'</span><span class="token punctuation">,</span>    <span class="token keyword">status</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span> <span class="token keyword">COMMENT</span> <span class="token string">'状态，默认为1'</span><span class="token punctuation">,</span>    gender <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'性别'</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'学生信息表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h4><h5 id="父表：具有【外键具体内容】的表"><a href="#父表：具有【外键具体内容】的表" class="headerlink" title="父表：具有【外键具体内容】的表"></a>父表：具有【外键具体内容】的表</h5><h5 id="子表：被外键约束的表"><a href="#子表：被外键约束的表" class="headerlink" title="子表：被外键约束的表"></a>子表：被外键约束的表</h5><h5 id="添加外键"><a href="#添加外键" class="headerlink" title="添加外键"></a>添加外键</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建时添加</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>字段名 数据名    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">[</span><span class="token keyword">CONSTRAINT</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>外键名称<span class="token punctuation">]</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>外键字段名<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表（主表中字段名）<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- 创建后添加</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> 外键名称 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>子表中外键字段名<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表<span class="token punctuation">(</span>主表中字段名<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="删除外键"><a href="#删除外键" class="headerlink" title="删除外键"></a>删除外键</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">DROP</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> 外键名；<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="删除-更新行为"><a href="#删除-更新行为" class="headerlink" title="删除/更新行为"></a>删除/更新行为</h5><table><thead><tr><th>行为</th><th>说明</th></tr></thead><tbody><tr><td>NO ACTION / RESTRICT</td><td>当父表中删除/更新对应记录时，首先检查该纪录是否有对应外键，如有，则不允许删除/更新。(默认行为)</td></tr><tr><td>CASCADE</td><td>当父表中删除/更新对应记录时，首先检查该纪录是否有对应外键，如有，则也删除/更新外键在子表中的记录。</td></tr><tr><td>SET NULL</td><td>当父表中删除/更新对应记录时，首先检查该纪录是否有对应外键，如有，则设置子表中该外键值为NULL(这就要求该外键允许取NULL)。</td></tr><tr><td>SET DEFAULT</td><td>父表有变更时，子表将外键列设置成一个默认的值(lnnobd不支持)。</td></tr></tbody></table><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> 外键名称 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>外键字段<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表名<span class="token punctuation">(</span>主表字段名<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CASCADE</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> emp    <span class="token keyword">add</span> <span class="token keyword">constraint</span> fk_emp_dept_id        <span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>dept_id<span class="token punctuation">)</span> <span class="token keyword">references</span> dept<span class="token punctuation">(</span>id<span class="token punctuation">)</span>            <span class="token keyword">on</span> <span class="token keyword">update</span> <span class="token keyword">set</span> <span class="token boolean">null</span> <span class="token keyword">on</span> <span class="token keyword">delete</span> <span class="token keyword">set</span> <span class="token boolean">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySql - 6 函数</title>
      <link href="/2022/03/06/Mysql6%20%E5%87%BD%E6%95%B0/"/>
      <url>/2022/03/06/Mysql6%20%E5%87%BD%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="1-字符串函数"><a href="#1-字符串函数" class="headerlink" title="1.字符串函数"></a>1.字符串函数</h1><table><thead><tr><th align="center">函数</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">CONCAT($S_1,S_2,…S_n$)</td><td align="center">字符串拼接</td></tr><tr><td align="center">LOWER(str)</td><td align="center">将str全部转为小写</td></tr><tr><td align="center">UPPER(str)</td><td align="center">将str全部转为大写</td></tr><tr><td align="center">LPAD(str,n,c)</td><td align="center">用字符c对str进行n个左填充</td></tr><tr><td align="center">RPAD(str,n,c)</td><td align="center">用字符c对str进行n个右填充</td></tr><tr><td align="center">TRIM(str)</td><td align="center">去掉str头部和尾部的空格</td></tr><tr><td align="center">SUBSTRING(str,statr,len)</td><td align="center">返回str中start开始的len长度的子串，下标从1开始</td></tr></tbody></table><p>1.企业员工的工号统一为5位数字，不足的在前面补0</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> info <span class="token keyword">SET</span> workid <span class="token operator">=</span> LPAD<span class="token punctuation">(</span>workid<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="2-数值函数"><a href="#2-数值函数" class="headerlink" title="2. 数值函数"></a>2. 数值函数</h1><table><thead><tr><th align="center">函数</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">CEIL(x)</td><td align="center">向上取整</td></tr><tr><td align="center">FLOOR(x)</td><td align="center">向下取整</td></tr><tr><td align="center">MOD(x, y)</td><td align="center">返回x/y的模</td></tr><tr><td align="center">RAND()</td><td align="center">返回0~1内的随机数</td></tr><tr><td align="center">ROUND(x, y)</td><td align="center">求参数x的四舍五入的值，保留y位小数</td></tr></tbody></table><p>生成6位数字的随机验证码</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">899999</span> <span class="token operator">+</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">SELECT</span> LPAD<span class="token punctuation">(</span><span class="token function">ROUND</span><span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="3-日期函数"><a href="#3-日期函数" class="headerlink" title="3.日期函数"></a>3.日期函数</h1><table><thead><tr><th align="center">函数</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">CURDATE()</td><td align="center">返回当前日期</td></tr><tr><td align="center">CURTIME()</td><td align="center">返回当前时间</td></tr><tr><td align="center">NOW()</td><td align="center">返回当前日期和时间</td></tr><tr><td align="center">YEAR(date)</td><td align="center">获取指定的date年份</td></tr><tr><td align="center">MONTH(date)</td><td align="center">获取指定的date月份</td></tr><tr><td align="center">DAY(date)</td><td align="center">获取指定的date日期</td></tr><tr><td align="center">DATE_ADD(date, INTERVAL expr type)</td><td align="center">返回一个日期/时间加上一个时间间隔expr后的时间值</td></tr><tr><td align="center">DATEDIFF(data1, data2)</td><td align="center">返回起始时间date1和结束时间date2之前的天数(date1 - date2)</td></tr></tbody></table><p>从现在开始往后推70天。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> DATE_ADD<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">INTERVAL</span> <span class="token number">70</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>NOW() : 2022-03-06 18:25:40</p><p>SELECT DATE_ADD(NOW(),INTERVAL 70 DAY); : 2022-05-15 18:25:59</p></blockquote><p>查询员工从出生到现在活了多少天，并按照降序排序。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name<span class="token punctuation">,</span> birthday<span class="token punctuation">,</span> DATEDIFF<span class="token punctuation">(</span>CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> birthday<span class="token punctuation">)</span> diff <span class="token keyword">FROM</span> info <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> diff <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="4-流程函数"><a href="#4-流程函数" class="headerlink" title="4. 流程函数"></a>4. 流程函数</h1><table><thead><tr><th align="center">函数</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">IF(value, t, f)</td><td align="center">如果value位true返回t，否则返回f</td></tr><tr><td align="center">IFNULL(value1, value2)</td><td align="center">如果value1为空，返回value1,否则返回value2</td></tr><tr><td align="center">CASE WHEN [val1] THEN [RES1] … ELSE [default] END</td><td align="center">如果val1为true，返回res1,否则返回default默认值</td></tr><tr><td align="center">CASE [expr] WHEN [val1] THEN [res1] … ELSE [default] END</td><td align="center">如果expr = val1,返回res1，否则返回default默认值</td></tr></tbody></table><blockquote><p>空串不为空</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> IFNULL<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'我是默认值'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote></blockquote><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> IFNULL<span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'我是默认值'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>我是默认值</p></blockquote></blockquote><p>查询员工姓名与工作城市，如果是北京或深圳则显示一线城市，否则显示二线城市</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>       name<span class="token punctuation">,</span>       <span class="token punctuation">(</span><span class="token keyword">CASE</span> workplace           <span class="token keyword">WHEN</span> <span class="token string">'北京'</span> <span class="token keyword">THEN</span> <span class="token string">'一线城市'</span>           <span class="token keyword">WHEN</span> <span class="token string">'深圳'</span> <span class="token keyword">THEN</span> <span class="token string">'二线城市'</span>           <span class="token keyword">ELSE</span> <span class="token string">'二线城市'</span>        <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'工作地址'</span><span class="token keyword">FROM</span> info<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查询学生成绩并且分级</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>       customer_id<span class="token punctuation">,</span>       last_name<span class="token punctuation">,</span>       <span class="token punctuation">(</span>           <span class="token keyword">CASE</span>           <span class="token keyword">WHEN</span> points <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token keyword">THEN</span> <span class="token string">'不及格'</span>           <span class="token keyword">WHEN</span> points <span class="token operator">&lt;</span> <span class="token number">2000</span> <span class="token keyword">THEN</span> <span class="token string">'良好'</span>           <span class="token keyword">ELSE</span> <span class="token string">'优秀'</span>           <span class="token keyword">END</span>       <span class="token punctuation">)</span> <span class="token string">'学生成绩评定'</span><span class="token keyword">FROM</span> customers<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySql - 5 用户管理、权限控制 DCL</title>
      <link href="/2022/03/06/Mysql5%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E3%80%81%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6/"/>
      <url>/2022/03/06/Mysql5%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E3%80%81%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="DCL"><a href="#DCL" class="headerlink" title="DCL"></a>DCL</h1><h2 id="Data-Control-Language"><a href="#Data-Control-Language" class="headerlink" title="Data Control Language"></a>Data Control Language</h2><h3 id="1-管理数据库用户-有哪些用户可以访问？"><a href="#1-管理数据库用户-有哪些用户可以访问？" class="headerlink" title="1. 管理数据库用户 - 有哪些用户可以访问？"></a>1. 管理数据库用户 - 有哪些用户可以访问？</h3><h4 id="1-1-查询用户"><a href="#1-1-查询用户" class="headerlink" title="1.1 查询用户"></a>1.1 查询用户</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> mysql<span class="token punctuation">;</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>创建用户在任意主机登录该数据库。</p><h4 id="1-2-创建用户"><a href="#1-2-创建用户" class="headerlink" title="1.2 创建用户"></a>1.2 创建用户</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'密码'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'miniFish'</span> @ <span class="token string">'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'123456'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="1-3-修改用户密码"><a href="#1-3-修改用户密码" class="headerlink" title="1.3 修改用户密码"></a>1.3 修改用户密码</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">USER</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span> IDENTIFIED <span class="token keyword">WITH</span> mysql_native_password <span class="token keyword">BY</span> <span class="token string">'新密码'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="1-4-删除用户"><a href="#1-4-删除用户" class="headerlink" title="1.4 删除用户"></a>1.4 删除用户</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">USER</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>1.主机名可以使用%通配。</p><p>2.这一节的SQL开发人员操作的比较少，主要是DBA使用。</p></blockquote><h3 id="2-权限控制-用户连接上之后可以访问哪几个数据库、数据表，有什么权限？"><a href="#2-权限控制-用户连接上之后可以访问哪几个数据库、数据表，有什么权限？" class="headerlink" title="2. 权限控制 - 用户连接上之后可以访问哪几个数据库、数据表，有什么权限？"></a>2. 权限控制 - 用户连接上之后可以访问哪几个数据库、数据表，有什么权限？</h3><h3 id="2-1-查询权限"><a href="#2-1-查询权限" class="headerlink" title="2.1 查询权限"></a>2.1 查询权限</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> GRANTS <span class="token keyword">FOR</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-2-授予权限"><a href="#2-2-授予权限" class="headerlink" title="2.2 授予权限"></a>2.2 授予权限</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">GRANT</span> 权限们 <span class="token keyword">ON</span> 数据库名<span class="token punctuation">.</span>表名 <span class="token keyword">TO</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-3-撤销权限"><a href="#2-3-撤销权限" class="headerlink" title="2.3 撤销权限"></a>2.3 撤销权限</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">REVOKE</span> 权限列表 <span class="token keyword">ON</span> 数据库名<span class="token punctuation">.</span>表名 <span class="token keyword">FROM</span> <span class="token string">'用户名'</span> @ <span class="token string">'主机名'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>1.多个权限之间，使用逗号通配</p><p>2.授权时，数据库名和表名都可以使用 * 进行通配，代表所有</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mySql - 4 查询 DQL</title>
      <link href="/2022/03/05/Mysql4%20%E6%9F%A5%E8%AF%A2/"/>
      <url>/2022/03/05/Mysql4%20%E6%9F%A5%E8%AF%A2/</url>
      
        <content type="html"><![CDATA[<h1 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h1><h5 id="DQL-编写顺序"><a href="#DQL-编写顺序" class="headerlink" title="DQL 编写顺序"></a>DQL 编写顺序</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们<span class="token keyword">FROM</span> 表名们<span class="token keyword">WHERE</span> 条件们<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 分组字段们<span class="token keyword">HAVING</span> 分组后条件们<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 排序字段们<span class="token keyword">LIMIT</span> 分页参数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="DQL-执行顺序"><a href="#DQL-执行顺序" class="headerlink" title="DQL 执行顺序"></a>DQL 执行顺序</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">FEOM 要先知道从哪张表<span class="token keyword">WHERE</span> 知道限制条件，先剔除一部分<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 怎么分组<span class="token keyword">HAVING</span> 分组后的条件<span class="token keyword">SELECT</span> 查询哪几个字段<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 怎么排序<span class="token keyword">LIMIT</span> 查多少<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>基本查询</p><blockquote><p>SELECT<br>FROM </p></blockquote></blockquote><blockquote><p>条件查询</p><blockquote><p>WHERE</p></blockquote></blockquote><blockquote><p>分组查询 + </p><p>聚合函数 COUNT, MAX, MIN, AVE, SUM</p><blockquote><p>GROPU BY</p><p>HAVING</p></blockquote></blockquote><blockquote><p>排序查询</p><blockquote><p>ORDER BY</p></blockquote></blockquote><blockquote><p>分页查询</p><blockquote><p>LIMIT</p></blockquote></blockquote><h2 id="1-基本查询"><a href="#1-基本查询" class="headerlink" title="1.基本查询"></a>1.基本查询</h2><h3 id="1-1-查询多个字段"><a href="#1-1-查询多个字段" class="headerlink" title="1.1 查询多个字段"></a>1.1 查询多个字段</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段<span class="token number">1</span>，字段<span class="token number">2</span>，字段<span class="token number">3</span> <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-2-查询所有字段"><a href="#1-2-查询所有字段" class="headerlink" title="1.2 查询所有字段"></a>1.2 查询所有字段</h3><p>实际开发少写*</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-3-设置别名"><a href="#1-3-设置别名" class="headerlink" title="1.3 设置别名"></a>1.3 设置别名</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段<span class="token number">1</span><span class="token punctuation">[</span><span class="token keyword">AS</span> 别名<span class="token number">1</span><span class="token punctuation">]</span>， 字段<span class="token number">2</span><span class="token punctuation">[</span><span class="token keyword">AS</span> 别名<span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> 表名：<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-4-去重"><a href="#1-4-去重" class="headerlink" title="1.4 去重"></a>1.4 去重</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> 字段列表 <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="2-条件查询"><a href="#2-条件查询" class="headerlink" title="2. 条件查询"></a>2. 条件查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 条件们<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th align="center">比较运算符</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">&gt;</td><td align="center">大于</td></tr><tr><td align="center">&gt;=</td><td align="center">大于等于</td></tr><tr><td align="center">&lt;</td><td align="center">小于</td></tr><tr><td align="center">&lt;=</td><td align="center">小于等于</td></tr><tr><td align="center">=</td><td align="center">等于</td></tr><tr><td align="center">&lt;&gt;  或  !=</td><td align="center">不等于</td></tr><tr><td align="center">BETWEEN … AND ….</td><td align="center">在某个区间内(包含max和min)</td></tr><tr><td align="center">IN(…)</td><td align="center">在IN后的列表中的值，多选一</td></tr><tr><td align="center">LIKE 占位符</td><td align="center">模糊匹配(_匹配单个字符, %匹配任意字符)</td></tr><tr><td align="center">IS NULL</td><td align="center">是NULL</td></tr></tbody></table><table><thead><tr><th align="center">逻辑运算符</th><th align="center"></th></tr></thead><tbody><tr><td align="center">AND 或 &amp;&amp;</td><td align="center">并且</td></tr><tr><td align="center">OR 或 ||</td><td align="center">或</td></tr><tr><td align="center">NOT 或 !</td><td align="center">非</td></tr></tbody></table><h5 id="若要判断NULL值，需要使用IS"><a href="#若要判断NULL值，需要使用IS" class="headerlink" title="若要判断NULL值，需要使用IS"></a>若要判断NULL值，需要使用IS</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段名 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 字段名 <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span class="token keyword">SELECT</span> 字段名 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 字段名 <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="IN语句可以代替连续的多个OR"><a href="#IN语句可以代替连续的多个OR" class="headerlink" title="IN语句可以代替连续的多个OR"></a>IN语句可以代替连续的多个OR</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段名 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 条件<span class="token number">1</span> <span class="token operator">OR</span> 条件<span class="token number">2</span> <span class="token operator">OR</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token keyword">SELECT</span> 字段名 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 条件 <span class="token operator">IN</span><span class="token punctuation">(</span>条件<span class="token number">1</span>，条件<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="占位符实现模糊匹配"><a href="#占位符实现模糊匹配" class="headerlink" title="占位符实现模糊匹配"></a>占位符实现模糊匹配</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">查询first_name为<span class="token number">5</span>个字母的人<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> first_name <span class="token operator">LIKE</span> <span class="token string">'_____'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">查询last_name以y结尾的人<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> last_name <span class="token operator">LIKE</span> <span class="token string">'%y'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="3-分组查询"><a href="#3-分组查询" class="headerlink" title="3. 分组查询"></a>3. 分组查询</h2><h3 id="3-1-聚合函数"><a href="#3-1-聚合函数" class="headerlink" title="3.1 聚合函数"></a>3.1 聚合函数</h3><blockquote><p>将某一列数据作为一个整体，进行纵向计算</p></blockquote><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 聚合函数<span class="token punctuation">(</span>字段们<span class="token punctuation">)</span> <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="字段值为NULL的数据不参与COUNT计算"><a href="#字段值为NULL的数据不参与COUNT计算" class="headerlink" title="字段值为NULL的数据不参与COUNT计算"></a>字段值为NULL的数据不参与COUNT计算</h5><h3 id="3-2-分组查询"><a href="#3-2-分组查询" class="headerlink" title="3.2 分组查询"></a>3.2 分组查询</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 分组字段名 <span class="token punctuation">[</span><span class="token keyword">HAVING</span> 分组过滤后条件<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="WHERE和HAVING的区别"><a href="#WHERE和HAVING的区别" class="headerlink" title="WHERE和HAVING的区别"></a>WHERE和HAVING的区别</h5><blockquote><p>执行时机不同：WHERE是分组前过滤，不满足者不参与分组；HAVING是分组之后对结果过滤；</p><p>判断条件不同：WHERE不能对聚合函数进行判断，而HAVING可以。</p></blockquote><p> 统计不同年份出生的人的数量</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> birth_date<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> customers <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">year</span><span class="token punctuation">(</span>birth_date<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>根据性别分组，统计男性员工和女性员工的数量。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> gender<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> info <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> gender<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>根据性别分组，统计男性员工和女性员工的平均年龄。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> gender<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> <span class="token keyword">FROM</span> info <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> gender<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查询年龄小于45岁的员工，并根据工作地址分组，获取员工数量大于等于3的工作地址。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> workplace<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> age <span class="token operator">&lt;</span> <span class="token number">45</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> workplace <span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">SELECT</span> workplace<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> address_count <span class="token keyword">WHERE</span> age <span class="token operator">&lt;</span> <span class="token number">45</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> workplace <span class="token keyword">HAVING</span> ddress_count <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>执行顺序：WHERE &gt; 聚合函数 &gt; HAVING </p><p>分组之后，查询的字段一般为聚合函数和分组字段，查询其他字段没有意义。因此，通常SELECT 分组字段 + 聚合函数</p></blockquote><h2 id="4-排序查询"><a href="#4-排序查询" class="headerlink" title="4.排序查询"></a>4.排序查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表名 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 字段<span class="token number">1</span> 排序方式<span class="token number">1</span><span class="token punctuation">,</span> 字段<span class="token number">2</span> 排序方式<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="排序方式："><a href="#排序方式：" class="headerlink" title="排序方式："></a>排序方式：</h4><h5 id="ASC-升序-默认-ASC可以省略"><a href="#ASC-升序-默认-ASC可以省略" class="headerlink" title="ASC:升序 (默认) ASC可以省略"></a>ASC:升序 (默认) ASC可以省略</h5><h5 id="DESC-降序"><a href="#DESC-降序" class="headerlink" title="DESC:降序"></a>DESC:降序</h5><blockquote><p>如果是多字段排序，如果第一个字段相同，才会根据第二个字段进行排序。</p></blockquote><h2 id="5-分页查询"><a href="#5-分页查询" class="headerlink" title="5. 分页查询"></a>5. 分页查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 字段们 <span class="token keyword">FROM</span> 表名 <span class="token keyword">LIMIT</span> 起始索引<span class="token punctuation">,</span>查询记录数<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>1.起始索引从0开始，且</p><blockquote><p>起始索引 = (查询页码 - 1) * 每页显示记录数</p></blockquote><p>2.分页查询是数据库方言，MySql中是LIMIT</p><p>3.如果查询第一页，起始索引可以省略，直接写成LIMIT 每页显示记录数。</p></blockquote><h5 id="EXERCISE"><a href="#EXERCISE" class="headerlink" title="EXERCISE"></a>EXERCISE</h5><p>1.查询年龄为20，21，22，23岁的员工信息。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> info <span class="token keyword">WHERE</span> gender <span class="token operator">=</span> <span class="token string">'女'</span><span class="token punctuation">,</span>age <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2.查询性别为男，并且年龄在20-40岁(含)以内的姓名为三个字的员工。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> info <span class="token keyword">WHERE</span> gender <span class="token operator">=</span> <span class="token string">'男'</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>age <span class="token operator">BETWEEN</span> <span class="token number">20</span> <span class="token operator">AND</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">AND</span> name <span class="token operator">LIKE</span> <span class="token string">'___'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>3.统计员工表中，年龄小于60岁的，男性员工和女性员工的人数。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> gender<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> info <span class="token keyword">WHERE</span> age <span class="token operator">&lt;</span> <span class="token number">60</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> gender<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>4.查询所有年龄小于等于35岁员工的姓名和年龄，并对查询结果按年龄升序排序，如果年龄相同按入职时间降序排序。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name<span class="token punctuation">,</span> age <span class="token keyword">FROM</span> info <span class="token keyword">WHERE</span> sge <span class="token operator">&lt;=</span> <span class="token number">35</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">ASC</span><span class="token punctuation">,</span>workdate <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>5.查询性别为男，且年龄在20-40岁(含)以内的前5个员工的信息，对查询的结果按年龄升序排序，年龄相同按入职时间升序排序。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> info <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>age BWETEEN <span class="token number">20</span> <span class="token operator">AND</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">AND</span> gender <span class="token operator">=</span> <span class="token string">'男'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">ASC</span><span class="token punctuation">,</span>workdate <span class="token keyword">ASC</span> <span class="token keyword">LIMIT</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>先ORDER BY，再LIMIT</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySql - 3 操作数据 DML</title>
      <link href="/2022/03/05/Mysql3%20%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE/"/>
      <url>/2022/03/05/Mysql3%20%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="操作数据"><a href="#操作数据" class="headerlink" title="操作数据"></a>操作数据</h1><h2 id="1-添加数据"><a href="#1-添加数据" class="headerlink" title="1. 添加数据"></a>1. 添加数据</h2><h3 id="1-1-给【指定字段】添加数据"><a href="#1-1-给【指定字段】添加数据" class="headerlink" title="1.1  给【指定字段】添加数据"></a>1.1  给【指定字段】添加数据</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名<span class="token punctuation">(</span>字段<span class="token number">1</span><span class="token punctuation">,</span>字段<span class="token number">2</span><span class="token punctuation">,</span>字段<span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span>值<span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-2-给【所有字段】添加数据"><a href="#1-2-给【所有字段】添加数据" class="headerlink" title="1.2  给【所有字段】添加数据"></a>1.2  给【所有字段】添加数据</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名 <span class="token keyword">VALUES</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span>值<span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-3-批量添加数据"><a href="#1-3-批量添加数据" class="headerlink" title="1.3  批量添加数据"></a>1.3  批量添加数据</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名<span class="token punctuation">(</span>字段<span class="token number">1</span><span class="token punctuation">,</span>字段<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名 <span class="token keyword">VALUES</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>1.插入数据的字段顺序必须与值的顺序一一对应。</p><p>2.字符串和日期必须被包含在引号内。</p><p>3.插入数据的大小必须在字段的规定范围内。</p></blockquote><h2 id="2-修改数据"><a href="#2-修改数据" class="headerlink" title="2. 修改数据"></a>2. 修改数据</h2><p>如果没有条件就修改整张表</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> 表名 <span class="token keyword">SET</span> 字段名<span class="token number">1</span> <span class="token operator">=</span> 值<span class="token number">1</span><span class="token punctuation">,</span> 字段名<span class="token number">2</span> <span class="token operator">=</span> 值<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="3-删除数据"><a href="#3-删除数据" class="headerlink" title="3. 删除数据"></a>3. 删除数据</h2><p>如果不加WHERE会删除整张表</p><p>DELETE不能删除某个字段的值</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySql - 2 操作数据表 DDL</title>
      <link href="/2022/03/04/Mysql2%20%E6%93%8D%E4%BD%9C%E8%A1%A8/"/>
      <url>/2022/03/04/Mysql2%20%E6%93%8D%E4%BD%9C%E8%A1%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="操作数据表"><a href="#操作数据表" class="headerlink" title="操作数据表"></a>操作数据表</h1><h2 id="1-查询"><a href="#1-查询" class="headerlink" title="1. 查询"></a>1. 查询</h2><h3 id="1-1-查询当前数据库中的【所有表】"><a href="#1-1-查询当前数据库中的【所有表】" class="headerlink" title="1.1  查询当前数据库中的【所有表】"></a>1.1  查询当前数据库中的【所有表】</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-2-查询【表结构】"><a href="#1-2-查询【表结构】" class="headerlink" title="1.2 查询【表结构】"></a>1.2 查询【表结构】</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DESC</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="1-3-查询指定表的【建表语句】"><a href="#1-3-查询指定表的【建表语句】" class="headerlink" title="1.3 查询指定表的【建表语句】"></a>1.3 查询指定表的【建表语句】</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="2-创建"><a href="#2-创建" class="headerlink" title="2. 创建"></a>2. 创建</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>字段<span class="token number">1</span> 字段<span class="token number">1</span>类型 <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> <span class="token string">'字段注释1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>字段<span class="token number">2</span> 字段<span class="token number">2</span>类型 <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> <span class="token string">'字段注释2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>字段<span class="token number">3</span> 字段<span class="token number">3</span>类型 <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> <span class="token string">'字段注释3'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>字段n 字段n类型 <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> <span class="token string">'字段注释4]'</span><span class="token comment">//这里没有逗号</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token keyword">COMMENT</span> <span class="token string">'表注释'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-数据类型"><a href="#3-数据类型" class="headerlink" title="3. 数据类型"></a>3. 数据类型</h2><h4 id="3-1-数值类型"><a href="#3-1-数值类型" class="headerlink" title="3.1 数值类型"></a>3.1 数值类型</h4><table><thead><tr><th align="center">数据类型</th><th align="center">格式</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">定长字符串</td><td align="center">CHAR (10)</td><td align="center">就算存1个字符也会占用10个字符的空间 性能高</td></tr><tr><td align="center">变长字符串</td><td align="center">VARCHAR(10)</td><td align="center">存几个占几个 超出会报错 根据内容计算</td></tr></tbody></table><h4 id="3-2-日期和时间类型"><a href="#3-2-日期和时间类型" class="headerlink" title="3.2 日期和时间类型"></a>3.2 日期和时间类型</h4><table><thead><tr><th align="center">数据类型</th><th align="center">大小</th><th align="center">范围</th></tr></thead><tbody><tr><td align="center">DATE</td><td align="center">3</td><td align="center">1000-01-01 to 9999-12-32</td></tr><tr><td align="center">TIME</td><td align="center">3</td><td align="center">-838:59:59 to 838:59:59</td></tr><tr><td align="center">YEAR 1</td><td align="center">1</td><td align="center">1901 to 2155</td></tr><tr><td align="center">DATATIME</td><td align="center">8</td><td align="center">1000-01-01 00:00:00 to 9999-12-32 23:59:59</td></tr><tr><td align="center">TIMESTAMP</td><td align="center">4</td><td align="center">1970-01-01 00:00:01 to 2038-01-19 03:14:07</td></tr></tbody></table><h2 id="4-修改表"><a href="#4-修改表" class="headerlink" title="4. 修改表"></a>4. 修改表</h2><h4 id="4-1-添加字段"><a href="#4-1-添加字段" class="headerlink" title="4.1 添加字段"></a>4.1 添加字段</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> 字段名 类型<span class="token punctuation">(</span>长度<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> 注释<span class="token punctuation">]</span> <span class="token punctuation">[</span>约束<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>concretely,</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> employee <span class="token keyword">ADD</span> nickname<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="4-2-修改字段"><a href="#4-2-修改字段" class="headerlink" title="4.2 修改字段"></a>4.2 修改字段</h4><h5 id="4-2-1-修改【数据类型】"><a href="#4-2-1-修改【数据类型】" class="headerlink" title="4.2.1 修改【数据类型】"></a>4.2.1 修改【数据类型】</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">MODIFY</span> 字段名 新数据类型<span class="token punctuation">(</span>长度<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="4-2-2-修改【字段名】和【字段类型】"><a href="#4-2-2-修改【字段名】和【字段类型】" class="headerlink" title="4.2.2 修改【字段名】和【字段类型】"></a>4.2.2 修改【字段名】和【字段类型】</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 CHANGE 旧字段名 新字段名 类型<span class="token punctuation">(</span>长度<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="4-3-删除字段"><a href="#4-3-删除字段" class="headerlink" title="4.3 删除字段"></a>4.3 删除字段</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">DROP</span> 字段名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="4-4-修改表名"><a href="#4-4-修改表名" class="headerlink" title="4.4 修改表名"></a>4.4 修改表名</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">RENAME</span> <span class="token keyword">TO</span> 新表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="5-删除表"><a href="#5-删除表" class="headerlink" title="5.删除表"></a>5.删除表</h2><h4 id="5-1-删除表"><a href="#5-1-删除表" class="headerlink" title="5.1 删除表"></a>5.1 删除表</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> 表名；<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="5-2-删除表并重新创建-格式化-表结构留下了-数据没了"><a href="#5-2-删除表并重新创建-格式化-表结构留下了-数据没了" class="headerlink" title="5.2 删除表并重新创建(格式化 表结构留下了 数据没了)"></a>5.2 删除表并重新创建(格式化 表结构留下了 数据没了)</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">TRUNCATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySql - 1 数据库操作</title>
      <link href="/2022/03/04/Mysql1%20%E6%93%8D%E4%BD%9C%E5%BA%93/"/>
      <url>/2022/03/04/Mysql1%20%E6%93%8D%E4%BD%9C%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<h1 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h1><h3 id="1-显示所有的数据库"><a href="#1-显示所有的数据库" class="headerlink" title="1. 显示所有的数据库"></a>1. 显示所有的数据库</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">DATABASES</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-创建"><a href="#2-创建" class="headerlink" title="2. 创建"></a>2. 创建</h3><p>通用语法 括号内可选</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> 数据库名 <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> 字符集<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">COLLATE</span> 排序规则<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="如果不存在会直接创建，如果存在会创建失败"><a href="#如果不存在会直接创建，如果存在会创建失败" class="headerlink" title="如果不存在会直接创建，如果存在会创建失败"></a>如果不存在会直接创建，如果存在会创建失败</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> 数据库名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="创建之前进行存在性检查，如果不存在会创建，已存在则不理会该命令。"><a href="#创建之前进行存在性检查，如果不存在会创建，已存在则不理会该命令。" class="headerlink" title="创建之前进行存在性检查，如果不存在会创建，已存在则不理会该命令。"></a>创建之前进行存在性检查，如果不存在会创建，已存在则不理会该命令。</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> 数据库名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="指定字符集"><a href="#指定字符集" class="headerlink" title="指定字符集"></a>指定字符集</h5><h6 id="utf8存储长度为3字节"><a href="#utf8存储长度为3字节" class="headerlink" title="utf8存储长度为3字节"></a>utf8存储长度为3字节</h6><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> 数据库名 <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> utf8<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h6 id="utf8mb4支持4字节"><a href="#utf8mb4支持4字节" class="headerlink" title="utf8mb4支持4字节"></a>utf8mb4支持4字节</h6><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> 数据库名 <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> utf8mb4<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-删除"><a href="#3-删除" class="headerlink" title="3.  删除"></a>3.  删除</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> 数据库名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="4-使用"><a href="#4-使用" class="headerlink" title="4. 使用"></a>4. 使用</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> 数据库名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="5-查看当前处于哪个数据库"><a href="#5-查看当前处于哪个数据库" class="headerlink" title="5. 查看当前处于哪个数据库"></a>5. 查看当前处于哪个数据库</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DATABASE</span> 数据库名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java - OOP</title>
      <link href="/2022/03/03/Java%20OOP/"/>
      <url>/2022/03/03/Java%20OOP/</url>
      
        <content type="html"><![CDATA[<h1 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h1><p>main.java</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> main <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Stu</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 实例化</span>        s1<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Stu.java</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Stu</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Students are talking."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于staic的成员函数和类的构造同时进行，因此时间非常早</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Stu</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这里会报错</span>        <span class="token comment">//Non-static method 'f2()' cannot be referenced from a static contex</span>    <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="值传递"><a href="#值传递" class="headerlink" title="值传递"></a>值传递</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> main <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">change</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>        a <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>1</p><p>1</p></blockquote><h5 id="引用传递"><a href="#引用传递" class="headerlink" title="引用传递"></a>引用传递</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> main <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Person</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">change</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token class-name">Person</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>        p<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"MyName"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token class-name">String</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>null</p><p>MyName</p></blockquote><p>一旦定义了有参构造，无参构造必须显式定义</p><h3 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h3><p>高内聚 低耦合</p><p>属性私有 get/set</p><p>‘</p><h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>在Java中，所有的类都直接或间接地继承Object类</p><p>Java类只有单继承，没有多继承</p><p>一个儿子只有一个爸爸，一个爸爸可以有多个儿子。</p><h5 id="super"><a href="#super" class="headerlink" title="super"></a>super</h5><p>super 父类</p><p>this 当前</p><p>Application函数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Student</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        s1<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Person函数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"父类无参构造"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"我是爸爸里的成员函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Student函数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 子类这里默认调用了父类的构造函数 </span>        <span class="token comment">// 隐藏了一句 super();</span>        <span class="token comment">// 如果显式写super()必须写在第一行</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"子类无参构造"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"我是儿子里的成员函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>父类无参构造<br>子类无参构造</p><p>我是儿子里的成员函数<br>我是儿子里的成员函数<br>我是爸爸里的成员函数</p></blockquote><p>super注意点</p><p>super是调用父类的构造函数，并且必须在子类的构造函数的第一行</p><p>super和this不能同时调用</p><p>this在没继承的情况下可以使用</p><p>super必须要继承</p><p>一个类如果写了有参构造，必须把无参构造加上</p><h5 id="函数重写"><a href="#函数重写" class="headerlink" title="函数重写"></a>函数重写</h5><h6 id="重写之前-static"><a href="#重写之前-static" class="headerlink" title="重写之前 static"></a>重写之前 static</h6><p>MAIN</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> MAIN <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">// 方法的调用只跟左边的类型有关</span>                <span class="token class-name">Son</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        s<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Father</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 父类引用指向子类对象</span>        f<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Father</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Father test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Son</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Son</span> <span class="token keyword">extends</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Son test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Son test</p><p>Father test</p></blockquote><h6 id="重写之后-非static"><a href="#重写之后-非static" class="headerlink" title="重写之后 非static"></a>重写之后 非static</h6><p>MAIN</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> MAIN <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Son</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        s<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Father</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        f<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Father</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Father test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Son</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Son</span> <span class="token keyword">extends</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Son test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Son test</p><p>Son test</p></blockquote><p>静态函数和非静态函数用法非常不一样</p><p>Alt + insert —&gt; override</p><p>非静态：重写 关键词只能是public</p><p>​                函数名必须相同 参数列表必须相同 不然就变成重载了</p><p>​                修饰符范围可以缩扩大，不可以缩小 private —&gt; protected —-&gt; default —&gt; public</p><p>​                抛出的异常可以缩小，不可以扩大  ClassNotFoundException &lt;— Exception </p><p>​                子类和父类函数必须相同，但是函数体一定不能相同</p><p>子类不一定需要父类某个函数 / 父类不能满足子类</p><h1 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h1><p>多态是函数的多态</p><p>多态存在条件：有继承关系，子类重写父类方法，父类引用指向子类对象</p><p>父类和子类存在同一个函数，系统该调用谁呢？</p><p>类型x定义对象x 改调用谁就调用谁</p><p>父类写了函数f， 子类没有重写时：</p><p>子类指向子类 可以调用f，因为继承了</p><p>父类指向父类，能调用f，因为理所当然</p><p>父类指向子类，也能调用f</p><p>如果父类没有函数g, 子类有， 父类不可以调用，因为这是子类独有的</p><p>如果你父类也可以调用，那继承还有什么意思呢？</p><p>子类没有重写时</p><p>子类可以调父类的函数，父类不能调子类的函数</p><p>重写后，都调子类的函数(father f1 = new son();)</p><p>MAIN</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">oop<span class="token punctuation">.</span></span><span class="token class-name">Person</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">oop<span class="token punctuation">.</span></span><span class="token class-name">Student</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> MAIN <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// Student能调用自己的，或者继承的</span>        <span class="token class-name">Student</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Person是父类，无法调用子类的</span>        <span class="token class-name">Person</span> s2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 父类引用指向子类对象，但不能调用子类独有的函数</span>        <span class="token class-name">Object</span> s3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Person</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        s1<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        s2<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 在子类Studnet没有写run的时候输出Person run 因为子类Student继承了父类的函数</span>        <span class="token comment">// 在子类Student写了run之后s1,s2都输出Son run，因为子类重写了，执行子类</span>                p<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 能执行哪些函数看左边的类型</span>        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">)</span>s2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 这样就可以调用了 高精度转低精度</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// 一个对象的实际类型是确定的</span><span class="token comment">// new Student()</span><span class="token comment">// new Person()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Person</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Person run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Student</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Student run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Student run<br>Student run<br>Person run<br>eat</p></blockquote><h5 id="不可以被重写"><a href="#不可以被重写" class="headerlink" title="不可以被重写"></a>不可以被重写</h5><p>static 属于类，不属于任何一个对象</p><p>final 常量</p><p>private</p><h1 id="Static"><a href="#Static" class="headerlink" title="Static"></a>Static</h1><h3 id="static-变量"><a href="#static-变量" class="headerlink" title="static 变量"></a>static 变量</h3><p>在内存中只有一份，被所有的对象共享，可以通过【类名.变量名】的方式调用</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> age <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span> <span class="token comment">// 静态变量，计数</span>    <span class="token keyword">private</span> <span class="token keyword">double</span> score <span class="token operator">=</span> <span class="token number">98.9</span><span class="token punctuation">;</span>   <span class="token comment">// 非静态变量</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Student</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 报错 Non-static field 'score' cannot be referenced from a static context</span>        <span class="token comment">// System.out.println(Student.score);</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="static-函数"><a href="#static-函数" class="headerlink" title="static 函数"></a>static 函数</h3><p>错误</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"go"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\        <span class="token comment">// 会报错</span>        <span class="token comment">// Student.run();</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"go"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 会报错，必须要new出来才能调用</span>        <span class="token comment">// run();</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>正确</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"go"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Student</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        s<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>run</p></blockquote><p>然而static函数就不一样了，它可以【类名.函数名】调用</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"go"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Student</span><span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>go</p></blockquote><p>甚至可以直接调用</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"go"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 可以调用</span>        <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>go</p></blockquote><h5 id="非static可以直接访问static函数"><a href="#非static可以直接访问static函数" class="headerlink" title="非static可以直接访问static函数"></a>非static可以直接访问static函数</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"go"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Student</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        s<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>go</p></blockquote><h5 id="static函数不可以调用非static函数"><a href="#static函数不可以调用非static函数" class="headerlink" title="static函数不可以调用非static函数"></a>static函数不可以调用非static函数</h5><p>因为static函数和类同时加载</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">// 直接报错，因为go和类同时加载，加载的时候都没有run这玩意儿</span>        <span class="token comment">//run();</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="static代码块"><a href="#static代码块" class="headerlink" title="static代码块"></a>static代码块</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">oop<span class="token punctuation">.</span></span><span class="token class-name">Person</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">oop<span class="token punctuation">.</span></span><span class="token class-name">Student</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> MAIN <span class="token punctuation">{</span>    <span class="token punctuation">{</span>        <span class="token comment">// 匿名代码块</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"匿名代码块"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        <span class="token comment">// 静态代码块（初始化一些东西）只执行一次，和类同时加载</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"静态代码块"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"构造函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">MAIN</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>静态代码块<br>匿名代码块<br>构造函数</p></blockquote><h6 id="static代码块只执行一次"><a href="#static代码块只执行一次" class="headerlink" title="static代码块只执行一次"></a>static代码块只执行一次</h6><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">oop<span class="token punctuation">.</span></span><span class="token class-name">Person</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">oop<span class="token punctuation">.</span></span><span class="token class-name">Student</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> MAIN <span class="token punctuation">{</span>    <span class="token punctuation">{</span>        <span class="token comment">// 匿名代码块</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"匿名代码块"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        <span class="token comment">// 静态代码块（初始化一些东西）</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"静态代码块"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"构造函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">MAIN</span> m1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"==========="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">MAIN</span> m2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>静态代码块<br>匿名代码块</p><p>构造函数</p><p>==============</p><p>匿名代码块<br>构造函数</p></blockquote><h5 id="static导入包"><a href="#static导入包" class="headerlink" title="static导入包"></a>static导入包</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">Math</span><span class="token punctuation">.</span>random<span class="token punctuation">;</span><span class="token comment">// 不导入下面就得写Math.random()</span><span class="token keyword">public</span> <span class="token keyword">class</span> MAIN <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="final修饰的类不能被继承"><a href="#final修饰的类不能被继承" class="headerlink" title="final修饰的类不能被继承"></a>final修饰的类不能被继承</h5><p>final之后断子绝孙</p><p>Person</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Person run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Student</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token comment">// 直接报错 Cannot inherit from final 'oop.Person'</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h3><p>抽象类不能实例化(new)，被abstract修饰的函数必须被子类实现（子类非abstract）</p><p>相当于一个约束</p><p>专门用来被继承，相当于种马</p><p>没有构造函数</p><p>一旦函数里有abstract函数(~virtual Type name() = 0)，这个类就是抽象类，必须用abstract修饰</p><p>但是抽象类中可以写普通函数</p><p>抽象类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> abs <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 纯虚函数</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 正常函数</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>子类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> son <span class="token keyword">extends</span> abs<span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        son s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        s<span class="token punctuation">.</span><span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>123</p></blockquote><h5 id="接口-interface（变相实现伪多继承）用的不多"><a href="#接口-interface（变相实现伪多继承）用的不多" class="headerlink" title="接口 interface（变相实现伪多继承）用的不多"></a>接口 interface（变相实现伪多继承）用的不多</h5><p>不能被实例化 因为接口中没有构造函数</p><h6 id="普通类-只有具体实现函数"><a href="#普通类-只有具体实现函数" class="headerlink" title="普通类: 只有具体实现函数"></a>普通类: 只有具体实现函数</h6><h6 id="抽象类：具体实现函数和规范（纯虚函数）都有"><a href="#抽象类：具体实现函数和规范（纯虚函数）都有" class="headerlink" title="抽象类：具体实现函数和规范（纯虚函数）都有"></a>抽象类：具体实现函数和规范（纯虚函数）都有</h6><h6 id="接口：只有规范，自己无法写函数-比抽象类还抽象，专业的约束，只能做约数这件事，约数和实现分离，面向接口编程"><a href="#接口：只有规范，自己无法写函数-比抽象类还抽象，专业的约束，只能做约数这件事，约数和实现分离，面向接口编程" class="headerlink" title="接口：只有规范，自己无法写函数 比抽象类还抽象，专业的约束，只能做约数这件事，约数和实现分离，面向接口编程"></a>接口：只有规范，自己无法写函数 比抽象类还抽象，专业的约束，只能做约数这件事，约数和实现分离，面向接口编程</h6><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">interface</span> intf <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// public abstract自动标灰</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一般这么写</p><p>intf</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">interface</span> intf <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>aaa</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">interface</span> aaaa <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span><span class="token comment">// 常量，public static final可以省略 一般不这么做</span>    <span class="token keyword">void</span> <span class="token function">times</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>intfImpl</p><p>必须重写接口中所有的函数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> intfImpl <span class="token keyword">implements</span> intf<span class="token punctuation">,</span> aaaa<span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">times</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h3><h5 id="1-成员内部类"><a href="#1-成员内部类" class="headerlink" title="1.成员内部类"></a>1.成员内部类</h5><h5 id="2-静态内部类"><a href="#2-静态内部类" class="headerlink" title="2.静态内部类"></a>2.静态内部类</h5><h6 id="1"><a href="#1" class="headerlink" title="1"></a>1</h6><p>MAIN</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> MAIN <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Outer</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 通过外部类实例化内部类</span>        <span class="token class-name">Outer<span class="token punctuation">.</span>Inner</span> i <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">Inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 获得外部类的私有变量</span>        i<span class="token punctuation">.</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Outer</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Outer</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"外部类的函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Inner</span><span class="token punctuation">{</span><span class="token comment">// 这里一旦打上static外面就拿不到get_id了，因为这个类出生与类同时</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">in</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"内部类的函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">void</span> <span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h6 id="2"><a href="#2" class="headerlink" title="2"></a>2</h6><p>MAIN</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> MAIN <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        otherInner oi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">otherInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>otherInner</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Outer</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"外部类构造函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// 一个java文件只能有一个public class,但是可以有多个class</span><span class="token keyword">class</span> otherInner<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">otherInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"另一种内部类的构造函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="3-局部内部类-函数中"><a href="#3-局部内部类-函数中" class="headerlink" title="3.局部内部类(函数中)"></a>3.局部内部类(函数中)</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Outer</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">class</span> <span class="token class-name">Inner</span><span class="token punctuation">{</span>                    <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="4-匿名内部类"><a href="#4-匿名内部类" class="headerlink" title="4.匿名内部类"></a>4.匿名内部类</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">oop</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> test <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 没有变量名初始化类</span>        <span class="token comment">// 不用将实例保存到变量中</span>        <span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 这里可以new接口</span>        <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>                <span class="token comment">// 其实是有返回值的</span>        <span class="token class-name">UserService</span> us <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Apple</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"eat apple"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">interface</span> <span class="token class-name">UserService</span><span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java - 数组</title>
      <link href="/2022/03/02/Java%E6%95%B0%E7%BB%84/"/>
      <url>/2022/03/02/Java%E6%95%B0%E7%BB%84/</url>
      
        <content type="html"><![CDATA[<h1 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h1><h5 id="定义一个数组"><a href="#定义一个数组" class="headerlink" title="定义一个数组"></a>定义一个数组</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span><span class="token comment">// Java风格</span><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// C/C++风格</span><span class="token class-name">DataType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">ArrayName</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataType</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">Sakana</span><span class="token punctuation">.</span>www<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> demo1 <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>            a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> it <span class="token operator">:</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>1<br>11<br>21<br>31<br>41<br>51<br>61<br>71<br>81<br>91</p></blockquote><h5 id="获取数组长度"><a href="#获取数组长度" class="headerlink" title="获取数组长度"></a>获取数组长度</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">Sakana</span><span class="token punctuation">.</span>www<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> demo1 <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>            a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取长度</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="Java内存"><a href="#Java内存" class="headerlink" title="Java内存"></a>Java内存</h5><p>1.堆 </p><p>​    存放new的对象和数组</p><p>​    可以被所有的线程共享</p><p>2.栈</p><p>​    存放基本变量类型（包含这个变量的具体数值）</p><p>​    引用对象的变量（包含这个引用在堆中的具体地址）</p><p>3.方法区</p><p>​    可以被所有线程共享</p><p>​    包含了所有的class和static变量</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// 此时【栈】中压入一个变量a</span>a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 此时【堆】创建10个空间放a的默认值0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="数组初始化"><a href="#数组初始化" class="headerlink" title="数组初始化"></a>数组初始化</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">Sakana</span><span class="token punctuation">.</span>www<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> demo1 <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 静态初始化: 创建 + 马上赋值</span>        <span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token comment">// Man[] mans = {new Man(), new Man()}; ? 这是啥</span>        <span class="token comment">// 动态初始化</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>                <span class="token comment">// 数组的默认初始化</span>        <span class="token comment">/*         数组是引用类型，他的元素相当于类的实例变量        因此数组一经分配空间，其中的每个元也被按照        实例变量同样的方式被隐式初始化    */</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="数组的基本特点-和C-C-不同的地方"><a href="#数组的基本特点-和C-C-不同的地方" class="headerlink" title="数组的基本特点(和C/C++不同的地方)"></a>数组的基本特点(和C/C++不同的地方)</h5><p>数组中的元素包括【基本类型】和【引用类型】</p><p>数组变量属于引用类型，数组可以看成是对象，数组中的每个元素相当于该对象的成员变量</p><p>数组本身就是对象，Java中对象是在堆中的，因此数组无论保存原始类型还是其他对象类型，数组对象本身是在堆中的</p><p>和C/C++一样，数组的长度一经确定是不可变的，除非新创建一个数组</p><h5 id="数组的使用"><a href="#数组的使用" class="headerlink" title="数组的使用"></a>数组的使用</h5><h6 id="For-Each循环"><a href="#For-Each循环" class="headerlink" title="For-Each循环"></a>For-Each循环</h6><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">Sakana</span><span class="token punctuation">.</span>www<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> demo1 <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> it <span class="token operator">:</span> a<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h6 id="数组作为函数参数"><a href="#数组作为函数参数" class="headerlink" title="数组作为函数参数"></a>数组作为函数参数</h6><h6 id="数组作为函数返回值"><a href="#数组作为函数返回值" class="headerlink" title="数组作为函数返回值"></a>数组作为函数返回值</h6><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">Sakana</span><span class="token punctuation">.</span>www<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> demo1 <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> it <span class="token operator">:</span> a<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>it <span class="token operator">+</span> <span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"================"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                a <span class="token operator">=</span> <span class="token function">reverse</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> it <span class="token operator">:</span> a<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>it <span class="token operator">+</span> <span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>a<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> a<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">,</span> <span class="token operator">--</span> j<span class="token punctuation">)</span><span class="token punctuation">{</span>            b<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>1    2    3    4    5</p><p>5    4    3    2    1    </p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaSE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java - 方法</title>
      <link href="/2022/03/02/Java%E6%96%B9%E6%B3%95/"/>
      <url>/2022/03/02/Java%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>30</p></blockquote><h3 id="方法重载"><a href="#方法重载" class="headerlink" title="方法重载"></a>方法重载</h3><p>函数名字相同</p><p>参数类型必须不相同 (个数、类型、排列顺序)</p><p>返回值可以不相同</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> main <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> sum2 <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> add <span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">double</span> add <span class="token punctuation">(</span><span class="token keyword">double</span> a<span class="token punctuation">,</span> <span class="token keyword">double</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="命令行传参"><a href="#命令行传参" class="headerlink" title="命令行传参"></a>命令行传参</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">Sakana</span><span class="token punctuation">.</span>www<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> demo1 <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>打开Cmd，在该文件目录下执行javac</p><p>退到包的最开始执行Java并在后面写上一句话</p><p>程序会把这句话打印出来，空格作为分割</p></blockquote><h3 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h3><p>jdk1.5开始，Java支持传递【同类型】的可变参数给函数。</p><p>使用方法：参数类型 …<br>一个函数只能有一个可变参数，并且必须是最后一个参数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span></span><span class="token class-name">Sakana</span><span class="token punctuation">.</span>www<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> demo1 <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        demo1 d1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">demo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        d1<span class="token punctuation">.</span><span class="token function">myFunc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2.1</span><span class="token punctuation">,</span> <span class="token number">789</span><span class="token punctuation">,</span> <span class="token number">3.2</span><span class="token punctuation">,</span> <span class="token number">4.3</span><span class="token punctuation">,</span> <span class="token number">5.5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">myFunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> multi<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> multi<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>multi<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>1<br>2.1<br>789.0    // 隐式转换<br>3.2<br>4.3<br>5.5<br>6.0        // 隐式转换</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaSE - 流程控制</title>
      <link href="/2022/03/02/Java%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/"/>
      <url>/2022/03/02/Java%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h3 id="用户交互Scanner"><a href="#用户交互Scanner" class="headerlink" title="用户交互Scanner"></a>用户交互Scanner</h3><p>java.util.Scaaner是jdk5的新特性 通过Scanner类获取用户输入</p><p>next()和nextLine()方法获取输入的字符串</p><p>再读取前一般要判断是否还有输入的数据</p><h5 id="next"><a href="#next" class="headerlink" title="next()"></a>next()</h5><blockquote><p>1.一定要读取到有效字符后才可以结束</p><p>2.对输入有效字符之前遇到的空白，next()会自动丢弃</p><p>3.只有输入有效字符后才将其后面输入的空白作为分隔符/结束符</p><p>4.next()不能获取有空格的字符串</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Scanner</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建一个扫描器对象</span>        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Please input:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 判断用户有没有输入</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">String</span> str <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 关闭io流，否则占用资源</span>        scanner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Hello world<br>Hello</p></blockquote><h5 id="nextLine"><a href="#nextLine" class="headerlink" title="nextLine()"></a>nextLine()</h5><blockquote><p>1.以enter为结束符，换而言之，nextLine()返回输入回车前的所有字符</p><p>2.可以获得空白</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Scanner</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建一个扫描器对象</span>        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Please input:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 判断用户有没有输入</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">String</span> str <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 关闭io流，否则占用资源</span>        scanner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Hello World<br>Hello World</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Scanner</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token keyword">float</span> b <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Please input int"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            a <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"cur int is:"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"It's not an int!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNextFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            b <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">nextFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"cur float is:"</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"It's not a float!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        scanner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>正确输入</p><blockquote><p>Please input int<br>100<br>cur int is:100<br>1.1<br>cur float is:1.1</p></blockquote><p>错误输入</p><blockquote><p>Please input int<br>1.2<br>It’s not an int!<br>cur float is:1.2</p></blockquote><h5 id="计算平均值"><a href="#计算平均值" class="headerlink" title="计算平均值"></a>计算平均值</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Scanner</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Please input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">double</span> x <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">++</span> cnt<span class="token punctuation">;</span>            sum <span class="token operator">+=</span> x<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"sum:"</span> <span class="token operator">+</span> sum<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"average:"</span> <span class="token operator">+</span> sum <span class="token operator">/</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>        scanner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="顺序结构"><a href="#顺序结构" class="headerlink" title="顺序结构"></a>顺序结构</h3><h5 id="if语句"><a href="#if语句" class="headerlink" title="if语句"></a>if语句</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Scanner</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"PLease input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> s <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// equals() 比较字符串是否一致 用s == "hello"会输出false</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"NO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        scanner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>hello<br>hello</p></blockquote><blockquote><p>qwe<br>NO</p></blockquote><h5 id="switch语句"><a href="#switch语句" class="headerlink" title="switch语句"></a>switch语句</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Scanner</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">char</span> c <span class="token operator">=</span> <span class="token char">'b'</span><span class="token punctuation">;</span>        <span class="token comment">// byte,int,short,char</span>        <span class="token comment">// jdk7开始支持String</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token char">'a'</span><span class="token operator">:</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"优秀"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token char">'b'</span><span class="token operator">:</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"良好"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//没写break会case穿透</span>            <span class="token keyword">case</span> <span class="token char">'c'</span><span class="token operator">:</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"及格"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Unknown score"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>                scanner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>支持String的switch结构</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Scanner</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">"鱼"</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token string">"鱼"</span><span class="token operator">:</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"优秀"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"123"</span><span class="token operator">:</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"良好"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"abc"</span><span class="token operator">:</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"及格"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"fuck"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        scanner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>优秀</p></blockquote><p>反编译代码 将String转换成了编码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//</span><span class="token comment">// Source code recreated from a .class file by IntelliJ IDEA</span><span class="token comment">// (powered by FernFlower decompiler)</span><span class="token comment">//</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Scanner</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">"鱼"</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span> var4 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> <span class="token number">40060</span><span class="token operator">:</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"鱼"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                var4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">48690</span><span class="token operator">:</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                var4 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">96354</span><span class="token operator">:</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                var4 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>var4<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"优秀"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"良好"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"及格"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"fuck"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        scanner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="循环结构"><a href="#循环结构" class="headerlink" title="循环结构"></a>循环结构</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>死循环</p><p>等待客户端链接</p><p>服务器的请求响应监听</p><p>定时检查</p><p>……</p><h5 id="while循环-累加"><a href="#while循环-累加" class="headerlink" title="while循环 累加"></a>while循环 累加</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            sum <span class="token operator">+=</span> i<span class="token punctuation">;</span>            <span class="token operator">++</span> i<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>5050</p></blockquote><h5 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> num <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 数组定义</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>九九乘法表</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> i<span class="token punctuation">;</span> <span class="token operator">++</span> j<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">" x "</span> <span class="token operator">+</span> j <span class="token operator">+</span> <span class="token string">" = "</span> <span class="token operator">+</span> i <span class="token operator">*</span> j <span class="token operator">+</span> <span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>1 x 1 = 1<br>2 x 1 = 2    2 x 2 = 4<br>3 x 1 = 3    3 x 2 = 6    3 x 3 = 9<br>4 x 1 = 4    4 x 2 = 8    4 x 3 = 12    4 x 4 = 16<br>5 x 1 = 5    5 x 2 = 10    5 x 3 = 15    5 x 4 = 20    5 x 5 = 25<br>6 x 1 = 6    6 x 2 = 12    6 x 3 = 18    6 x 4 = 24    6 x 5 = 30    6 x 6 = 36<br>7 x 1 = 7    7 x 2 = 14    7 x 3 = 21    7 x 4 = 28    7 x 5 = 35    7 x 6 = 42    7 x 7 = 49<br>8 x 1 = 8    8 x 2 = 16    8 x 3 = 24    8 x 4 = 32    8 x 5 = 40    8 x 6 = 48    8 x 7 = 56    8 x 8 = 64<br>9 x 1 = 9    9 x 2 = 18    9 x 3 = 27    9 x 4 = 36    9 x 5 = 45    9 x 6 = 54    9 x 7 = 63    9 x 8 = 72    9 x 9 = 81</p></blockquote><h5 id="增强型for循环-jdk5引入"><a href="#增强型for循环-jdk5引入" class="headerlink" title="增强型for循环 jdk5引入"></a>增强型for循环 jdk5引入</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> num <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 数组定义</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">:</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p></blockquote><p>打印三角形</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> j <span class="token operator">&gt;=</span> i<span class="token punctuation">;</span> <span class="token operator">--</span> j<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span> j<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="类似C-C-中goto语句的“标签-continue”"><a href="#类似C-C-中goto语句的“标签-continue”" class="headerlink" title="类似C/C++中goto语句的“标签 + continue”"></a>类似C/C++中goto语句的“标签 + continue”</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>        outer<span class="token operator">:</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> cnt <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token operator">--</span> cnt<span class="token punctuation">;</span>                i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span> outer<span class="token punctuation">;</span><span class="token comment">// 从outer标记处开始执行</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>1    2    3    4    5</p><p>1    2    3    4    5</p><p>1    2    3    4    5</p><p>1    2    3    4    5</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaSE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaSE - 基础知识</title>
      <link href="/2022/03/01/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
      <url>/2022/03/01/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>cmd进入console</p><p>编译：javac 文件名.java</p><p>运行: java 文件名</p><p>java兼具编译型和解释型的特性</p><p>java源程序 *.java —&gt; (java编译器) —&gt;  字节码 *.class —&gt; 类装载器 —&gt; 字节码校验器 —&gt; 解释器 —&gt; 操作系统</p><p>注释</p><p>单行注释 同C/C++</p><p>多行注释 同C/C++</p><p>文档注释</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * @author * @fuck */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><h3 id="浮点数"><a href="#浮点数" class="headerlink" title="浮点数"></a>浮点数</h3><pre class="line-numbers language-none"><code class="language-none">float a = 1.1F;/*float a = 1.1;Required type:floatProvided:double*/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="进制"><a href="#进制" class="headerlink" title="进制"></a>进制</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">011</span><span class="token punctuation">;</span><span class="token comment">//0- 八进制</span>        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">0xA0</span><span class="token punctuation">;</span><span class="token comment">//0x - 十六进制</span>        <span class="token keyword">int</span> d <span class="token operator">=</span> <span class="token number">0b11</span><span class="token punctuation">;</span><span class="token comment">//0b - 二进制</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>print result</p><p>10<br>9<br>160<br>3</p></blockquote><h3 id="避免float比较"><a href="#避免float比较" class="headerlink" title="避免float比较"></a>避免float比较</h3><p>银行业务使用BigDecimal</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">float</span> a <span class="token operator">=</span> <span class="token number">0.15F</span><span class="token punctuation">;</span><span class="token comment">// 离散 大约 接近 舍入误差 接近但不等于</span>        <span class="token keyword">double</span> b <span class="token operator">=</span> <span class="token number">0.15</span><span class="token punctuation">;</span>        <span class="token comment">// 最好完全避免使用浮点数进行比较</span>        <span class="token comment">// 最好完全避免使用浮点数进行比较</span>        <span class="token comment">// 最好完全避免使用浮点数进行比较</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">float</span> c <span class="token operator">=</span> <span class="token number">12121212121212121212F</span><span class="token punctuation">;</span>        <span class="token keyword">float</span> d <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c <span class="token operator">==</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>false<br>0.15<br>0.15</p><hr><p>true</p><p>1.2121212E19<br>1.2121212E19</p></blockquote><h3 id="强制转换-所有的字符本质都是数字"><a href="#强制转换-所有的字符本质都是数字" class="headerlink" title="强制转换 所有的字符本质都是数字"></a>强制转换 所有的字符本质都是数字</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">char</span> a <span class="token operator">=</span> <span class="token char">'c'</span><span class="token punctuation">;</span><span class="token comment">//unicode 一个char占用2字节</span>        <span class="token keyword">char</span> b <span class="token operator">=</span> <span class="token char">'中'</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>99<br>20013</p></blockquote><h3 id="转义"><a href="#转义" class="headerlink" title="转义"></a>转义</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">char</span> a <span class="token operator">=</span> <span class="token char">'\u0061'</span><span class="token punctuation">;</span><span class="token comment">// 斜杠\代表转义 标准unicode形式 u0000 - uffff</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>\t 制表符</p><p>\n 换行</p></blockquote><h3 id="内存分配-对比不等"><a href="#内存分配-对比不等" class="headerlink" title="内存分配 对比不等"></a>内存分配 对比不等</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=========="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> c <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> d <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c <span class="token operator">==</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>false</p><p>true</p></blockquote><h3 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h3><p>低 ——————————–&gt; 高</p><p>byte(1) —&gt; short(2),char(2) —&gt; int(4) —&gt; long(8) —&gt; float(4) —&gt; double(8)</p><p>小数的优先级高于整数</p><p>byte C/C++里没碰到过 其范围为-128至127 (-2^7 - 2^7 - 1)</p><h5 id="强制类型转换"><a href="#强制类型转换" class="headerlink" title="强制类型转换"></a>强制类型转换</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span> b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span>a<span class="token punctuation">;</span><span class="token comment">// 精度丢失 内存溢出</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>128</p><p>-128</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">15.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">15.9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>15</p><p>-15</p></blockquote><h5 id="自动类型转换"><a href="#自动类型转换" class="headerlink" title="自动类型转换"></a>自动类型转换</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>128</p><p>128.0</p></blockquote><p>低精度转高精度—&gt;自定转换 没有问题</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">char</span> a <span class="token operator">=</span> <span class="token char">'a'</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>98</p><p>b</p></blockquote><p>1.不能对boolean进行转换</p><p>2.不能把对象类型转换为不相干的类型</p><p>3.高精度-&gt;低精度 精度丢失</p><p>操作大数小心溢出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// jdk7新特性，大数字可以用下划线分割</span>        <span class="token keyword">int</span> money <span class="token operator">=</span> <span class="token number">10_0000_0000</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> year <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>                <span class="token comment">// int 精度低，导致溢出</span>        <span class="token keyword">int</span> total1 <span class="token operator">=</span> money <span class="token operator">*</span> year<span class="token punctuation">;</span>        <span class="token comment">// 计算过程已经出错了</span>        <span class="token keyword">long</span> total2 <span class="token operator">=</span> money <span class="token operator">*</span> year<span class="token punctuation">;</span>        <span class="token comment">// 正确</span>        <span class="token keyword">long</span> total3 <span class="token operator">=</span> money <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>year<span class="token punctuation">;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>total1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>total2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>total3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>-1474836480<br>-1474836480<br>20000000000</p></blockquote><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>类型：基本类型，引用类型</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>    <span class="token comment">// 类变量</span>    <span class="token keyword">static</span> <span class="token keyword">double</span> salary <span class="token operator">=</span> <span class="token number">2500</span><span class="token punctuation">;</span>    <span class="token comment">// 实例变量，从属于对象,若不初始化，默认值。</span>    <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token comment">// main方法</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//局部变量 出了这个方法就死了</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 应用实例变量</span>        hello myhello <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>myhello<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>myhello<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 自定义方法</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> hello<span class="token punctuation">{</span>        <span class="token comment">// 修饰符不区分顺序</span>    <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">double</span> PI <span class="token operator">=</span> <span class="token number">3.14</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> PI <span class="token operator">=</span> <span class="token number">3.14</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>PI<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一堆整数操作，有一个long结果为long，否则全为int</p><p>有一个doule，结果一定为double</p><h3 id="短路运算"><a href="#短路运算" class="headerlink" title="短路运算"></a>短路运算</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> b <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>a <span class="token operator">++</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>false<br>5</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaSE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BFS - 走迷宫</title>
      <link href="/2022/02/04/BFS%20-%20%E8%B5%B0%E8%BF%B7%E5%AE%AB/"/>
      <url>/2022/02/04/BFS%20-%20%E8%B5%B0%E8%BF%B7%E5%AE%AB/</url>
      
        <content type="html"><![CDATA[<p>给定一个 n×m 的二维整数数组，用来表示一个迷宫，数组中只包含 0 或 1，其中 0 表示可以走的路，1 表示不可通过的墙壁。</p><p>最初，有一个人位于左上角 (1,1) 处，已知该人每次可以向上、下、左、右任意一个方向移动一个位置。</p><p>请问，该人从左上角移动至右下角 (n,m) 处，至少需要移动多少次。</p><p>数据保证 (1,1) 处和 (n,m) 处的数字为 0，且一定至少存在一条通路。</p><h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>第一行包含两个整数 n 和 m。</p><p>接下来 n 行，每行包含 m 个整数（0 或 1），表示完整的二维数组迷宫。</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>输出一个整数，表示从左上角移动至右下角的最少移动次数。</p><h4 id="数据范围"><a href="#数据范围" class="headerlink" title="数据范围"></a>数据范围</h4><p>1 ≤ n, m ≤ 100</p><h4 id="输入样例："><a href="#输入样例：" class="headerlink" title="输入样例："></a>输入样例：</h4><pre class="line-numbers language-none"><code class="language-none">5 50 1 0 0 00 1 0 1 00 0 0 0 00 1 1 1 00 0 0 1 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="输出样例："><a href="#输出样例：" class="headerlink" title="输出样例："></a>输出样例：</h4><pre class="line-numbers language-none"><code class="language-none">8<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码:"></a>AC代码:</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/stdc++.h&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">typedef</span> pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> PII<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">;</span><span class="token keyword">int</span> g<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> d<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>PII q<span class="token punctuation">[</span>N <span class="token operator">*</span> N<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 模拟队列</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> m<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">bfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> hh <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> tt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">// 起点进队</span>        <span class="token function">memset</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>    d<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> dx<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> dy<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// 向量运算</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>hh <span class="token operator">&lt;=</span> tt<span class="token punctuation">)</span> <span class="token comment">//队列不空</span>    <span class="token punctuation">{</span>        <span class="token keyword">auto</span> t <span class="token operator">=</span> q<span class="token punctuation">[</span>hh <span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 队头出队</span>                <span class="token comment">// 遍历四个方向，合法坐标入队</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">int</span> x <span class="token operator">=</span> t<span class="token punctuation">.</span>first <span class="token operator">+</span> dx<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> y <span class="token operator">=</span> t<span class="token punctuation">.</span>second <span class="token operator">+</span> dy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 待扩展的点</span>                        <span class="token comment">// 待扩展的点合法 &amp;&amp; 可以走 &amp;&amp; 第一次走</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> x <span class="token operator">&lt;</span> n <span class="token operator">&amp;&amp;</span> y <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> y <span class="token operator">&lt;</span> m <span class="token operator">&amp;&amp;</span> g<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> d<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                d<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token punctuation">[</span>t<span class="token punctuation">.</span>first<span class="token punctuation">]</span><span class="token punctuation">[</span>t<span class="token punctuation">.</span>second<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 更新距离</span>                q<span class="token punctuation">[</span><span class="token operator">++</span> tt<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">,</span> y<span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">// 入队</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>        <span class="token keyword">return</span> d<span class="token punctuation">[</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//由于weight都是1，所以第几层扩展到终点答案就等于多少</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    cin <span class="token operator">&gt;&gt;</span> n <span class="token operator">&gt;&gt;</span> m<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> <span class="token operator">++</span> j<span class="token punctuation">)</span>            cin <span class="token operator">&gt;&gt;</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token function">bfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 宽度优先搜索 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DFS - 全排列</title>
      <link href="/2022/02/04/DFS%20-%20%E5%85%A8%E6%8E%92%E5%88%97/"/>
      <url>/2022/02/04/DFS%20-%20%E5%85%A8%E6%8E%92%E5%88%97/</url>
      
        <content type="html"><![CDATA[<p>给定一个整数 n，将数字 1∼n 排成一排，将会有很多种排列方法。</p><p>现在，请你按照字典序将所有的排列方法输出。</p><h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>共一行，包含一个整数 n。</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>按字典序输出所有排列方案，每个方案占一行。</p><h4 id="数据范围"><a href="#数据范围" class="headerlink" title="数据范围"></a>数据范围</h4><p>1 ≤ n ≤ 7</p><h4 id="输入样例："><a href="#输入样例：" class="headerlink" title="输入样例："></a>输入样例：</h4><pre class="line-numbers language-none"><code class="language-none">3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="输出样例："><a href="#输出样例：" class="headerlink" title="输出样例："></a>输出样例：</h4><pre class="line-numbers language-none"><code class="language-none">1 2 31 3 22 1 32 3 13 1 23 2 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码:"></a>AC代码:</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span> n<span class="token punctuation">;</span><span class="token keyword">int</span> path<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">bool</span> st<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 填了n个数字，整条路经都填完了</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>u <span class="token operator">==</span> n<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> cout <span class="token operator">&lt;&lt;</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token char">' '</span><span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 这个数字还没有用过</span>        <span class="token punctuation">{</span>            path<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>            st<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                        <span class="token function">dfs</span><span class="token punctuation">(</span>u <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 走到下一层</span>                        st<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 恢复现场</span>            <span class="token comment">//path[u] = 0; 会被不断覆盖，腹部覆盖都没有问题</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    cin <span class="token operator">&gt;&gt;</span> n<span class="token punctuation">;</span>    <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 深度优先搜索 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DFS - n皇后</title>
      <link href="/2022/02/04/DFS%20-%20n%E7%9A%87%E5%90%8E/"/>
      <url>/2022/02/04/DFS%20-%20n%E7%9A%87%E5%90%8E/</url>
      
        <content type="html"><![CDATA[<p>n−皇后问题是指将 n 个皇后放在 n×n 的国际象棋棋盘上，使得皇后不能相互攻击到，即任意两个皇后都不能处于同一行、同一列或同一斜线上。</p><p>现在给定整数 n，请你输出所有的满足条件的棋子摆法。</p><h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>共一行，包含整数 n。</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>每个解决方案占 n 行，每行输出一个长度为 n 的字符串，用来表示完整的棋盘状态。</p><p>其中 <code>.</code> 表示某一个位置的方格状态为空，<code>Q</code> 表示某一个位置的方格上摆着皇后。</p><p>每个方案输出完成后，输出一个空行。</p><p><strong>注意：行末不能有多余空格。</strong></p><p>输出方案的顺序任意，只要不重复且没有遗漏即可。</p><h4 id="数据范围"><a href="#数据范围" class="headerlink" title="数据范围"></a>数据范围</h4><p>1 ≤ n ≤ 9</p><h4 id="输入样例："><a href="#输入样例：" class="headerlink" title="输入样例："></a>输入样例：</h4><pre class="line-numbers language-none"><code class="language-none">4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="输出样例："><a href="#输出样例：" class="headerlink" title="输出样例："></a>输出样例：</h4><pre class="line-numbers language-none"><code class="language-none">.Q.....QQ.....Q...Q.Q......Q.Q..<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="AC代码1-优化版"><a href="#AC代码1-优化版" class="headerlink" title="AC代码1(优化版):"></a>AC代码1(优化版):</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">int</span> n<span class="token punctuation">;</span><span class="token keyword">bool</span> col<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> dg<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> udg<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 对角线有2n-1条</span><span class="token keyword">char</span> g<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">)</span> <span class="token comment">// 第u行</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>u <span class="token operator">==</span> n<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token comment">// 第i列</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>col<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dg<span class="token punctuation">[</span>i <span class="token operator">+</span> u<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>udg<span class="token punctuation">[</span>u <span class="token operator">-</span> i <span class="token operator">+</span> n<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            g<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'Q'</span><span class="token punctuation">;</span>            col<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> dg<span class="token punctuation">[</span>u <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> udg<span class="token punctuation">[</span>u <span class="token operator">-</span> i <span class="token operator">+</span> n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token function">dfs</span><span class="token punctuation">(</span>u <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            col<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> dg<span class="token punctuation">[</span>u <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> udg<span class="token punctuation">[</span>u <span class="token operator">-</span> i <span class="token operator">+</span> n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            g<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'.'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    cin <span class="token operator">&gt;&gt;</span> n<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> j<span class="token punctuation">)</span>            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'.'</span><span class="token punctuation">;</span>    <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="AC代码1-更暴力版"><a href="#AC代码1-更暴力版" class="headerlink" title="AC代码1(更暴力版):"></a>AC代码1(更暴力版):</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">int</span> n<span class="token punctuation">;</span><span class="token keyword">bool</span> row<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> col<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> dg<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> udg<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 对角线有2n-1条</span><span class="token keyword">char</span> g<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> cnt<span class="token punctuation">)</span> <span class="token comment">// 行标， 列标， 皇后数量</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>y <span class="token operator">==</span> n<span class="token punctuation">)</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">++</span> x<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token operator">==</span> n<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>cnt <span class="token operator">==</span> n<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 不放皇后</span>    <span class="token function">dfs</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 一个格子一个格子搜</span>    <span class="token comment">// 放皇后</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>col<span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dg<span class="token punctuation">[</span>x <span class="token operator">+</span> y<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>udg<span class="token punctuation">[</span>x <span class="token operator">-</span> y <span class="token operator">+</span> n<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        row<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> col<span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> dg<span class="token punctuation">[</span>x <span class="token operator">+</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> udg<span class="token punctuation">[</span>x <span class="token operator">-</span> y <span class="token operator">+</span> n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        g<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'Q'</span><span class="token punctuation">;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cnt <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        row<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> col<span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> dg<span class="token punctuation">[</span>x <span class="token operator">+</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> udg<span class="token punctuation">[</span>x <span class="token operator">-</span> y <span class="token operator">+</span> n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        g<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'.'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    cin <span class="token operator">&gt;&gt;</span> n<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> j<span class="token punctuation">)</span>            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'.'</span><span class="token punctuation">;</span>    <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="什么时候剪枝？"><a href="#什么时候剪枝？" class="headerlink" title="什么时候剪枝？"></a>什么时候剪枝？</h4><p>最优性：当前路径一定不如最优解<br>可行性：当前路径一定不合法</p><h4 id="关于u-i-n和i-u-n"><a href="#关于u-i-n和i-u-n" class="headerlink" title="关于u - i + n和i - u + n"></a>关于u - i + n和i - u + n</h4><p>最开始学的时候在这里迷惑了一下<br>udg的下标取u - i + n和i - u + n都可以<br>下面是n = 3时两种方式的打表</p><pre class="line-numbers language-none"><code class="language-none">u - i + n = 3   i - u + n = 3u - i + n = 4   i - u + n = 2u - i + n = 3   i - u + n = 3u - i + n = 2   i - u + n = 4u - i + n = 5   i - u + n = 1u - i + n = 4   i - u + n = 2u - i + n = 3   i - u + n = 3u - i + n = 2   i - u + n = 4u - i + n = 4   i - u + n = 2u - i + n = 3   i - u + n = 3u - i + n = 2   i - u + n = 4u - i + n = 1   i - u + n = 5u - i + n = 4   i - u + n = 2u - i + n = 5   i - u + n = 1u - i + n = 4   i - u + n = 2u - i + n = 3   i - u + n = 3u - i + n = 3   i - u + n = 3u - i + n = 2   i - u + n = 4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 深度优先搜索 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>并查集</title>
      <link href="/2022/02/02/%E5%B9%B6%E6%9F%A5%E9%9B%86/"/>
      <url>/2022/02/02/%E5%B9%B6%E6%9F%A5%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<p>一共有 n 个数，编号是  1 ~ n，最开始每个数各自在一个集合中。</p><p>现在要进行 m 个操作，操作共有两种：</p><ol><li><code>M a b</code>，将编号为 a 和 b 的两个数所在的集合合并，如果两个数已经在同一个集合中，则忽略这个操作；</li><li><code>Q a b</code>，询问编号为 a 和 b 的两个数是否在同一个集合中；</li></ol><h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>第一行输入整数 n 和 m。</p><p>接下来 m 行，每行包含一个操作指令，指令为 <code>M a b</code> 或 <code>Q a b</code> 中的一种。</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>对于每个询问指令 <code>Q a b</code>，都要输出一个结果，如果 a 和 b 在同一集合内，则输出 <code>Yes</code>，否则输出 <code>No</code>。</p><p>每个结果占一行。</p><h4 id="数据范围"><a href="#数据范围" class="headerlink" title="数据范围"></a>数据范围</h4><p>1 ≤ n, m ≤ 10<sup>5</sup></p><h4 id="输入样例："><a href="#输入样例：" class="headerlink" title="输入样例："></a>输入样例：</h4><pre class="line-numbers language-none"><code class="language-none">4 5M 1 2M 3 4Q 1 2Q 1 3Q 3 4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="输出样例："><a href="#输出样例：" class="headerlink" title="输出样例："></a>输出样例：</h4><pre class="line-numbers language-none"><code class="language-none">YesNoYes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码:"></a>AC代码:</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">1e5</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span> p<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> m<span class="token punctuation">;</span><span class="token comment">// 带路径压缩返回祖宗节点</span><span class="token keyword">int</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">!=</span> x<span class="token punctuation">)</span> p<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> p<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    cin <span class="token operator">&gt;&gt;</span> n <span class="token operator">&gt;&gt;</span> m<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token comment">// 初始化， 刚开始p[i] = i, 每个人都是一个独立的集合</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>m<span class="token operator">--</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">char</span> op<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//%s吃掉空格，回车... %c会读乱七八糟的字符</span>        <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s%d%d"</span><span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>op<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'M'</span><span class="token punctuation">)</span> p<span class="token punctuation">[</span><span class="token function">find</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>        <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">find</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">find</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Yes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> 并查集支持操作：</p><p> 1.将两个集合合并<br>  2.询问两个元素是否在同一个集合</p><p>  每一个集合都用一颗树来维护，树根的编号就是整个集合的编号</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>模拟堆</title>
      <link href="/2022/02/02/%E6%A8%A1%E6%8B%9F%E5%A0%86/"/>
      <url>/2022/02/02/%E6%A8%A1%E6%8B%9F%E5%A0%86/</url>
      
        <content type="html"><![CDATA[<p>维护一个集合，初始时集合为空，支持如下几种操作：</p><ol><li><code>I x</code>，插入一个数 x；</li><li><code>PM</code>，输出当前集合中的最小值；</li><li><code>DM</code>，删除当前集合中的最小值（数据保证此时的最小值唯一）；</li><li><code>D k</code>，删除第 k 个插入的数；</li><li><code>C k x</code>，修改第 k 个插入的数，将其变为 x；</li></ol><p>现在要进行 N 次操作，对于所有第 2 个操作，输出当前集合的最小值。</p><h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>第一行包含整数 N。</p><p>接下来 N 行，每行包含一个操作指令，操作指令为 <code>I x</code>，<code>PM</code>，<code>DM</code>，<code>D k</code> 或 <code>C k x</code> 中的一种。</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>对于每个输出指令 <code>PM</code>，输出一个结果，表示当前集合中的最小值。</p><p>每个结果占一行。</p><h4 id="数据范围"><a href="#数据范围" class="headerlink" title="数据范围"></a>数据范围</h4><p>1 ≤ N ≤ 10<sup>5</sup></p><p>−10<sup>9</sup> ≤ x ≤ 10<sup>9</sup><br>数据保证合法。</p><h4 id="输入样例："><a href="#输入样例：" class="headerlink" title="输入样例："></a>输入样例：</h4><pre class="line-numbers language-none"><code class="language-none">8I -10PMI -10D 1C 2 8I 6PMDM<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="输出样例："><a href="#输出样例：" class="headerlink" title="输出样例："></a>输出样例：</h4><pre class="line-numbers language-none"><code class="language-none">-106<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码:"></a>AC代码:</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">1e5</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span> h<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> _size<span class="token punctuation">,</span> cnt<span class="token punctuation">;</span><span class="token keyword">int</span> in_h<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> h_in<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 第k个插入的点是堆中in_h[k] = j点， 堆中的j号点是第h_in[j] = k个插入的点, 互为反映射</span><span class="token keyword">void</span> <span class="token function">heap_swap</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token comment">// a, b是堆中的两个下标</span><span class="token punctuation">{</span>    <span class="token function">swap</span><span class="token punctuation">(</span>in_h<span class="token punctuation">[</span>h_in<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> in_h<span class="token punctuation">[</span>h_in<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 插入次序 指向 下标</span>    <span class="token function">swap</span><span class="token punctuation">(</span>h_in<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">,</span> h_in<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 下标 指向 插入次序</span>    <span class="token function">swap</span><span class="token punctuation">(</span>h<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> t <span class="token operator">=</span> u<span class="token punctuation">;</span>    <span class="token comment">// 三个元素中最小值的下标</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">&lt;=</span> _size <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> h<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span> t <span class="token operator">=</span> u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> _size <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> h<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span> t <span class="token operator">=</span> u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>t <span class="token operator">!=</span> u<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">heap_swap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">down</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>u <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">[</span>u <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> h<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">heap_swap</span><span class="token punctuation">(</span>u <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">up</span><span class="token punctuation">(</span>u <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 当时这里只除以2没有递归，WA了半天</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> _<span class="token punctuation">;</span>    cin <span class="token operator">&gt;&gt;</span> _<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>_<span class="token operator">--</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> k<span class="token punctuation">,</span> x<span class="token punctuation">;</span>        <span class="token keyword">char</span> op<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> op<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// 插入： 插入最后一个位置， 再up</span>        <span class="token punctuation">{</span>            <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">++</span> cnt<span class="token punctuation">,</span> <span class="token operator">++</span> _size<span class="token punctuation">;</span>   <span class="token comment">// 第cnt个插入的元素</span>            in_h<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span> <span class="token operator">=</span> _size<span class="token punctuation">,</span> h_in<span class="token punctuation">[</span>_size<span class="token punctuation">]</span> <span class="token operator">=</span> cnt<span class="token punctuation">;</span>            h<span class="token punctuation">[</span>_size<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>            <span class="token function">up</span><span class="token punctuation">(</span>_size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token string">"PM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> h<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 输出min</span>        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token string">"DM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 删除min</span>        <span class="token punctuation">{</span>            <span class="token function">heap_swap</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> _size<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">--</span> _size<span class="token punctuation">;</span>            <span class="token function">down</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 删除第k个插入的元素</span>        <span class="token punctuation">{</span>            <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>            k <span class="token operator">=</span> in_h<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token function">heap_swap</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> _size<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">--</span> _size<span class="token punctuation">;</span>            <span class="token function">down</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">up</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span>   <span class="token comment">// 将第k个插入的元素修改成x</span>        <span class="token punctuation">{</span>            <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>k<span class="token punctuation">,</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>            k <span class="token operator">=</span> in_h<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>            h<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>            <span class="token function">down</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">up</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> 以小根堆为例</p><p> 1.O(logn) 插入一个数    heap[ ++ size] = x, up(size)<br> 2.O(1) 求最小值      heap[1]<br> 3.O(logn) 删除最小值    heap[1] = heap[size –], down(1)<br> 4.删除任意元素  heap[k] = heap[size], down(k), up(k) 只有一个会执行<br> 5.修改任意元素  heap[k] = x, down(k), up(k)</p><p> 堆是一个完全二叉树，除了最后一层节点，上面所有结点都是满的，最后一层节点从左到右排列<br> 每个节点都&lt;=左右儿子， 因此根节点是整个集合的最小值</p><p> 全新存储方式：一维数组</p> <pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">               1       2               3 4          5      6         78  9      10 11  12 13     14 15<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p> ​<br>       x<br>   2x     2x+1</p><p> 某个结点下标x的左儿子：2x，右儿子：2x+1</p><p> 核心操作： down() &amp; up() </p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>堆排序</title>
      <link href="/2022/02/02/%E5%A0%86%E6%8E%92%E5%BA%8F/"/>
      <url>/2022/02/02/%E5%A0%86%E6%8E%92%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<p>输入一个长度为 n 的整数数列，从小到大输出前 m 小的数。</p><h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>第一行包含整数 n 和 m。</p><p>第二行包含 n 个整数，表示整数数列。</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>共一行，包含 m 个整数，表示整数数列中前 m 小的数。</p><h4 id="数据范围"><a href="#数据范围" class="headerlink" title="数据范围"></a>数据范围</h4><p>1 ≤ m ≤ n ≤ 10<sup>5</sup>，<br>1 ≤ 数列中元素 ≤ 10<sup>9</sup></p><h4 id="输入样例："><a href="#输入样例：" class="headerlink" title="输入样例："></a>输入样例：</h4><pre class="line-numbers language-none"><code class="language-none">5 34 5 1 3 2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="输出样例："><a href="#输出样例：" class="headerlink" title="输出样例："></a>输出样例：</h4><pre class="line-numbers language-none"><code class="language-none">1 2 3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码:"></a>AC代码:</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">1e5</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span> h<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> _size<span class="token punctuation">;</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> m<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> t <span class="token operator">=</span> u<span class="token punctuation">;</span>    <span class="token comment">// 三个元素中最小值的下标</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">&lt;=</span> _size <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> h<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span> t <span class="token operator">=</span> u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> _size <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> h<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span> t <span class="token operator">=</span> u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>t <span class="token operator">!=</span> u<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">swap</span><span class="token punctuation">(</span>h<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">down</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    cin <span class="token operator">&gt;&gt;</span> n <span class="token operator">&gt;&gt;</span> m<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>h<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    _size <span class="token operator">=</span> n<span class="token punctuation">;</span>    <span class="token comment">// O(n)建堆</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> n <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token punctuation">;</span> <span class="token operator">--</span> i<span class="token punctuation">)</span> <span class="token function">down</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// n / 2向下取整 是最后一个非叶子节点 差比数列求和 &lt; n</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>m<span class="token operator">--</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> h<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        h<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> h<span class="token punctuation">[</span>_size <span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">down</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// down函数非递归写法</span><span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> t <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        t <span class="token operator">=</span> u<span class="token punctuation">;</span>    <span class="token comment">// 三个元素中最小值的下标</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">&lt;=</span> _size <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> h<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span> t <span class="token operator">=</span> u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> _size <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> h<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span> t <span class="token operator">=</span> u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>t <span class="token operator">==</span> u<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token function">swap</span><span class="token punctuation">(</span>h<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        u <span class="token operator">=</span> t<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>  以小根堆为例</p><p>  1.O(logn) 插入一个数    heap[ ++ size] = x, up(size)<br>  2.O(1) 求最小值      heap[1]<br>  3.O(logn) 删除最小值    heap[1] = heap[size –], down(1)<br>  4.O(logn) 删除任意元素  heap[k] = heap[size], down(k), up(k) 只有一个会执行<br>  5.O(logn) 修改任意元素  heap[k] = x, down(k), up(k)</p><p>  堆是一个完全二叉树，除了最后一层节点，上面所有结点都是满的，最后一层节点从左到右排列<br>  每个节点都&lt;=左右儿子， 因此根节点是整个集合的最小值</p><p>  全新存储方式：一维数组</p>  <pre class="line-numbers language-c" data-language="c"><code class="language-c">                <span class="token number">1</span>        <span class="token number">2</span>                <span class="token number">3</span>  <span class="token number">4</span>          <span class="token number">5</span>       <span class="token number">6</span>         <span class="token number">7</span><span class="token number">8</span>   <span class="token number">9</span>     <span class="token number">10</span>   <span class="token number">11</span>  <span class="token number">12</span>  <span class="token number">13</span>    <span class="token number">14</span>  <span class="token number">15</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre><code>    x2x     2x+1</code></pre><p>  某个结点x的左儿子：2x，右儿子：2x+1</p><p>  核心操作： down() &amp; up() </p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KMP字符串匹配</title>
      <link href="/2022/02/01/KMP/"/>
      <url>/2022/02/01/KMP/</url>
      
        <content type="html"><![CDATA[<p>给定一个模式串 S，以及一个模板串 P，所有字符串中只包含大小写英文字母以及阿拉伯数字。</p><p>模板串 P 在模式串 S 中多次作为子串出现。</p><p>求出模板串 P 在模式串 S 中所有出现的位置的起始下标。</p><h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>第一行包含整数 N，表示数列长度。</p><p>第二行包含 N 个整数，表示整数数列。</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>第一行输入整数 N，表示字符串 P 的长度。</p><p>第二行输入字符串 P。</p><p>第三行输入整数 M，表示字符串 S 的长度。</p><p>第四行输入字符串 S。</p><h4 id="数据范围"><a href="#数据范围" class="headerlink" title="数据范围"></a>数据范围</h4><p>1 ≤ N ≤ 10<sup>5</sup><br>1 ≤ M ≤ 10<sup>6</sup></p><h4 id="输入样例："><a href="#输入样例：" class="headerlink" title="输入样例："></a>输入样例：</h4><pre class="line-numbers language-none"><code class="language-none">3aba5ababa<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="输出样例："><a href="#输出样例：" class="headerlink" title="输出样例："></a>输出样例：</h4><pre class="line-numbers language-none"><code class="language-none">0 2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码:"></a>AC代码:</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token comment">// 模式串 ———&gt; 大串</span><span class="token comment">// 模板串 ---&gt; 小串</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">1e5</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> M <span class="token operator">=</span> <span class="token number">1e6</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>   <span class="token comment">//模板串， 模式串</span><span class="token keyword">char</span> s<span class="token punctuation">[</span>M<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//模式串string， 模板串pattern</span><span class="token keyword">int</span> ne<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// core-&gt;求next数组</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> m<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    cin <span class="token operator">&gt;&gt;</span> n <span class="token operator">&gt;&gt;</span> p <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;&gt;</span> m <span class="token operator">&gt;&gt;</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>         <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>j <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> p<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> j <span class="token operator">=</span> ne<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> p<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">++</span> j<span class="token punctuation">;</span>        ne<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>  <span class="token comment">//一旦到i发现匹配不上，可以回退到j，j是啥？前面两步结局：要么完犊子j=0，要么位于j的字符匹配</span>    <span class="token punctuation">}</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> m<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>j <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> p<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> j <span class="token operator">=</span> ne<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// j还有退路(若j = 0则最坏打算，东山再起) &amp;&amp; 未匹配上</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> p<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">++</span> j<span class="token punctuation">;</span> <span class="token comment">// 要么完犊子全失败，要么找到一个最大前缀下标</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>j <span class="token operator">==</span> n<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            cout <span class="token operator">&lt;&lt;</span> i <span class="token operator">-</span> n <span class="token operator">&lt;&lt;</span> <span class="token char">' '</span><span class="token punctuation">;</span>            j <span class="token operator">=</span> ne<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//继续匹配，看能不能找到最长字串重新出发</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> 理解KMP模式串匹配，需要理解匹配原理，next代表的含义，求解next方法，以及为什么预处理next数组与匹配过程的原理如出一辙。</p><p> 他们俩唯一的不同是预处理时记录next数组的值，而匹配时没有这一步，取而代之的是检查是否匹配结束。</p><p> 预处理模板串p, next[]数组之和模板串p有关，与模式串S无关。<br> 找后缀和前缀相等的子串，并且力求长度最长。<br> next[i] = j的含义：p[1, j] = p[i - j + 1, i] 一旦模板串中下标j + 1的字符与模式串中下i的字符无法匹配<br> 模板串不吊死在一棵树上，j立马回退，去找max(前缀 == 后缀)的长度<br> 假设这个长度是len, 那么最长后缀的下标为[j - len + 1, j]， 而与之相匹配的前缀下标为[1, len]<br> 因此 next[j]的作用就是回退， 原本是下标j在与模式串比较，一旦不匹配执行next[j]，来到长度len对应的下标继续匹配</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 字符串 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>单调队列 - 滑动窗口</title>
      <link href="/2022/02/01/%E5%8D%95%E8%B0%83%E9%98%9F%E5%88%97%20-%20%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/"/>
      <url>/2022/02/01/%E5%8D%95%E8%B0%83%E9%98%9F%E5%88%97%20-%20%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/</url>
      
        <content type="html"><![CDATA[<p>给定一个大小为 n ≤ 10<sup>6</sup> 的数组。</p><p>有一个大小为 k 的滑动窗口，它从数组的最左边移动到最右边。</p><p>你只能在窗口中看到 k 个数字。</p><p>每次滑动窗口向右移动一个位置。</p><p>以下是一个例子：</p><p>该数组为 <code>[1 3 -1 -3 5 3 6 7]</code>，k 为 3。</p><table><thead><tr><th align="left">窗口位置</th><th align="left">最小值</th><th align="left">最大值</th></tr></thead><tbody><tr><td align="left">[1 3 -1] -3 5 3 6 7</td><td align="left">-1</td><td align="left">3</td></tr><tr><td align="left">1 [3 -1 -3] 5 3 6 7</td><td align="left">-3</td><td align="left">3</td></tr><tr><td align="left">1 3 [-1 -3 5] 3 6 7</td><td align="left">-3</td><td align="left">5</td></tr><tr><td align="left">1 3 -1 [-3 5 3] 6 7</td><td align="left">-3</td><td align="left">5</td></tr><tr><td align="left">1 3 -1 -3 [5 3 6] 7</td><td align="left">3</td><td align="left">6</td></tr><tr><td align="left">1 3 -1 -3 5 [3 6 7]</td><td align="left">3</td><td align="left">7</td></tr></tbody></table><p>你的任务是确定滑动窗口位于每个位置时，窗口中的最大值和最小值。</p><h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>输入包含两行。</p><p>第一行包含两个整数 n 和 k，分别代表数组长度和滑动窗口的长度。</p><p>第二行有 n 个整数，代表数组的具体数值。</p><p>同行数据之间用空格隔开。</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>输出包含两个。</p><p>第一行输出，从左至右，每个位置滑动窗口中的最小值。</p><p>第二行输出，从左至右，每个位置滑动窗口中的最大值。</p><h4 id="输入样例："><a href="#输入样例：" class="headerlink" title="输入样例："></a>输入样例：</h4><pre class="line-numbers language-none"><code class="language-none">8 31 3 -1 -3 5 3 6 7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="输出样例："><a href="#输出样例：" class="headerlink" title="输出样例："></a>输出样例：</h4><pre class="line-numbers language-none"><code class="language-none">-1 -3 -3 -3 3 33 3 5 5 6 7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码:"></a>AC代码:</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">1e6</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span> a<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> queue<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> k<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    cin <span class="token operator">&gt;&gt;</span> n <span class="token operator">&gt;&gt;</span> k<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> cin <span class="token operator">&gt;&gt;</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> hh <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> tt <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>hh <span class="token operator">&lt;=</span> tt <span class="token operator">&amp;&amp;</span> i <span class="token operator">-</span> k <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> queue<span class="token punctuation">[</span>hh<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">++</span> hh<span class="token punctuation">;</span> <span class="token comment">// 判断队头是否滑出窗口</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>hh <span class="token operator">&lt;=</span> tt <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span>queue<span class="token punctuation">[</span>tt<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">--</span> tt<span class="token punctuation">;</span> <span class="token comment">// 如果队尾元素&gt;=新元素，队尾一直出队</span>        queue<span class="token punctuation">[</span><span class="token operator">++</span> tt<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> cout <span class="token operator">&lt;&lt;</span> a<span class="token punctuation">[</span>queue<span class="token punctuation">[</span>hh<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token char">' '</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        hh <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> tt <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>hh <span class="token operator">&lt;=</span> tt <span class="token operator">&amp;&amp;</span> i <span class="token operator">-</span> k <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> queue<span class="token punctuation">[</span>hh<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">++</span> hh<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>hh <span class="token operator">&lt;=</span> tt <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span>queue<span class="token punctuation">[</span>tt<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">--</span> tt<span class="token punctuation">;</span>        queue<span class="token punctuation">[</span><span class="token operator">++</span> tt<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> cout <span class="token operator">&lt;&lt;</span> a<span class="token punctuation">[</span>queue<span class="token punctuation">[</span>hh<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token char">' '</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> 队列维护窗口最小值的下标， 队头永远是窗口最小值</p><p>queue中装的不是value，而是Index，方便判断队头最小值下标 queue[hh] 是否滑出窗口临界 i - k + 1</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>单调栈</title>
      <link href="/2022/01/31/%E5%8D%95%E8%B0%83%E6%A0%88/"/>
      <url>/2022/01/31/%E5%8D%95%E8%B0%83%E6%A0%88/</url>
      
        <content type="html"><![CDATA[<p>给定一个长度为 N 的整数数列，输出每个数左边第一个比它小的数，如果不存在则输出 −1。</p><h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>第一行包含整数 N，表示数列长度。</p><p>第二行包含 N 个整数，表示整数数列。</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>共一行，包含 N 个整数，其中第 i 个数表示第 i 个数的左边第一个比它小的数，如果不存在则输出 −1。</p><h4 id="数据范围"><a href="#数据范围" class="headerlink" title="数据范围"></a>数据范围</h4><p>1 ≤ N ≤ 10<sup>5</sup><br>1 ≤ 数列中元素 ≤ 10<sup>9</sup></p><h4 id="输入样例："><a href="#输入样例：" class="headerlink" title="输入样例："></a>输入样例：</h4><pre class="line-numbers language-none"><code class="language-none">53 4 2 7 5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="输出样例："><a href="#输出样例：" class="headerlink" title="输出样例："></a>输出样例：</h4><pre class="line-numbers language-none"><code class="language-none">-1 3 -1 2 2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码:"></a>AC代码:</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">1e5</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span> stk<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> tt<span class="token punctuation">,</span> n<span class="token punctuation">,</span> x<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    cin <span class="token operator">&gt;&gt;</span> n<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">while</span><span class="token punctuation">(</span>tt <span class="token operator">&amp;&amp;</span> stk<span class="token punctuation">[</span>tt<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> x<span class="token punctuation">)</span> <span class="token operator">--</span> tt<span class="token punctuation">;</span> <span class="token comment">// stack不为空 &amp;&amp; 栈顶 &gt; 新元素</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>tt<span class="token punctuation">)</span> <span class="token comment">// 第一个元素 || 序列Min</span>            cout <span class="token operator">&lt;&lt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token char">' '</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>             cout <span class="token operator">&lt;&lt;</span> stk<span class="token punctuation">[</span>tt<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token char">' '</span><span class="token punctuation">;</span>        stk<span class="token punctuation">[</span><span class="token operator">++</span> tt<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token comment">// 新元素进栈</span>    <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>性质：数字序列中，某些元素永远不会作为答案输出。</p><p>若a<sub>3</sub> &gt; a<sub>5</sub> , 那么a<sub>3</sub>永远也不会作为答案输出。</p><p>只要维护一个栈，栈中元素都是严格单调上升，那么加入新元素时，一旦栈顶top比新元素e1大，则不会是答案，并且在也不会被用到，因为如果后续e2要找左侧第一个比他小的，并不会去找top,而是找e1, 因此一直弹出直到栈顶元素top &lt; 新元素e1。</p></blockquote><blockquote><p>每个元素最多进栈一次，出栈一次，因此每个元素最多被访问2次，n个元素最多被访问2n次，因此时间复杂度O(n)</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>区间合并</title>
      <link href="/2022/01/31/%E5%8C%BA%E9%97%B4%E5%90%88%E5%B9%B6/"/>
      <url>/2022/01/31/%E5%8C%BA%E9%97%B4%E5%90%88%E5%B9%B6/</url>
      
        <content type="html"><![CDATA[<p>给定 n 个区间 [l<sub>i</sub>, l<sub>r</sub>] ，要求合并所有有交集的区间。</p><p>注意如果在端点处相交，也算有交集。</p><p>输出合并完成后的区间个数。</p><p>例如：[1, 3] 和 [2, 6] 可以合并为一个区间 [1, 6]。</p><h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>第一行包含整数 n。</p><p>接下来 n 行，每行包含两个整数 l 和 r</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>共一行，包含一个整数，表示合并区间完成后的区间个数。</p><h4 id="数据范围"><a href="#数据范围" class="headerlink" title="数据范围"></a>数据范围</h4><p>1 ≤ n ≤ 100000,<br>−10<sup>9</sup> ≤ l<sub>i</sub> ≤ l<sub>r</sub> ≤ 10<sup>9</sup></p><h4 id="输入样例："><a href="#输入样例：" class="headerlink" title="输入样例："></a>输入样例：</h4><pre class="line-numbers language-none"><code class="language-none">51 22 45 67 87 9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="输出样例："><a href="#输出样例：" class="headerlink" title="输出样例："></a>输出样例：</h4><pre class="line-numbers language-none"><code class="language-none">3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码:"></a>AC代码:</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/stdc++.h&gt;</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">pb</span> <span class="token expression">push_back</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">x</span> <span class="token expression">first</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">y</span> <span class="token expression">second</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">typedef</span> pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> PII<span class="token punctuation">;</span><span class="token keyword">typedef</span> vector<span class="token operator">&lt;</span>PII<span class="token operator">&gt;</span> vii<span class="token punctuation">;</span><span class="token keyword">int</span> n<span class="token punctuation">;</span>vii v<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    cin <span class="token operator">&gt;&gt;</span> n<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        v<span class="token punctuation">.</span><span class="token function">pb</span><span class="token punctuation">(</span><span class="token punctuation">{</span>a<span class="token punctuation">,</span> b<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">sort</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ed <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2e9</span><span class="token punctuation">,</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">:</span> v<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> l <span class="token operator">=</span> it<span class="token punctuation">.</span>x<span class="token punctuation">,</span> r <span class="token operator">=</span> it<span class="token punctuation">.</span>y<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>l <span class="token operator">&lt;=</span> ed<span class="token punctuation">)</span> ed <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>ed<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//考虑r可能包含在前一个区间里面，对区间拓展没有贡献</span>        <span class="token keyword">else</span>        <span class="token punctuation">{</span>            <span class="token operator">++</span> res<span class="token punctuation">;</span>            ed <span class="token operator">=</span> r<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    cout <span class="token operator">&lt;&lt;</span> res<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>核心还是用贪心的思想贪最长区间是多少，何时区间被打断要更新。</p><blockquote><p>维护什么？</p><ol><li> 当前区间的左端点l &lt;= 维护的右端点ed —&gt; 当前区间包含于前一个区间或者刚好结尾相等</li><li> 当前区间的左端点l 严格&gt; 维护的右端点ed —&gt; 发现一个新的不重复区间，更新区间数量，右端点ed</li></ol></blockquote>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 贪心 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>容斥原理 - 能被整除的数</title>
      <link href="/2022/01/31/%E5%AE%B9%E6%96%A5%E5%8E%9F%E7%90%86/"/>
      <url>/2022/01/31/%E5%AE%B9%E6%96%A5%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<p>给定一个整数 n 和 m 个不同的质数 p1,p2,…,pm。</p><p>请你求出 1∼n中能被 p1,p2,…,pm中的至少一个数整除的整数有多少个。</p><h4 id="输入格式"><a href="#输入格式" class="headerlink" title="输入格式"></a>输入格式</h4><p>第一行包含整数 n 和 m。</p><p>第二行包含 m 个质数。</p><h4 id="输出格式"><a href="#输出格式" class="headerlink" title="输出格式"></a>输出格式</h4><p>输出一个整数，表示满足条件的整数的个数。</p><h4 id="数据范围"><a href="#数据范围" class="headerlink" title="数据范围"></a>数据范围</h4><p>1 ≤ m ≤ 16,<br>1 ≤ n, pi ≤ 109</p><h4 id="输入样例："><a href="#输入样例：" class="headerlink" title="输入样例："></a>输入样例：</h4><pre class="line-numbers language-none"><code class="language-none">10 22 3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="输出样例："><a href="#输出样例：" class="headerlink" title="输出样例："></a>输出样例：</h4><pre class="line-numbers language-none"><code class="language-none">7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码:"></a>AC代码:</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/stdc++.h&gt;</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>   <span class="token comment">// m个质数， 1 &lt;= m &lt;= 16</span><span class="token keyword">int</span> primes<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> m<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    cin <span class="token operator">&gt;&gt;</span> n <span class="token operator">&gt;&gt;</span> m<span class="token punctuation">;</span>  <span class="token comment">// 1-n, m个质数</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cin <span class="token operator">&gt;&gt;</span> primes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 枚举2 ^ m种情况</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> t <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;&gt;</span> j <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token operator">++</span> cnt<span class="token punctuation">;</span> <span class="token comment">// 统计1的个数， </span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>t <span class="token operator">*</span> primes<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&gt;</span> n<span class="token punctuation">)</span>    <span class="token comment">// 一旦乘积越界， 直接走人</span>            <span class="token punctuation">{</span>                t <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            t <span class="token operator">*=</span> primes<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>cnt <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> res <span class="token operator">+=</span> n <span class="token operator">/</span> t<span class="token punctuation">;</span>        <span class="token keyword">else</span> res <span class="token operator">-=</span> n <span class="token operator">/</span> t<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>   cout <span class="token operator">&lt;&lt;</span> res<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>原本暴力遍历时间复杂度： O(n * m)<br>容斥原理：<br>S2 = {2, 4, 6, 8, 10}<br>s3 = {3, 6, 9}</p><p>|S2 ∪ S3| = |S2| + |S3| - |S2 ∩ S3|   O(2 ^ m)<br>m &lt;= 16 —&gt; 65536 计算机1s —&gt; 1e7~ 1e8</p><p>问题转换为， 如何求1 - n中p的倍数?  —&gt; count = ⌊n / p⌋<br>为什么是下取整?<br>hypo1 : n是p的倍数, count =  ⌊n / p⌋ = n / p = k，(p, 2p, 3p, …, kp) 严格等于， 刚好分完<br>hypo2 : n不是p的倍数, count =  ⌊n / p⌋ = k， (p, 2p, 3p, …, kp), n, n比kp大一点点</p><p>|S1| = ⌊n / p1⌋<br>|S2| =  ⌊n / p2⌋<br>|S1 ∩ S2| = ⌊n / (p1 * p2)⌋<br>|S1 ∪ S2| =  ⌊n / p1⌋ + ⌊n / p2⌋   </p><p>求一个交集是做k次乘法 ⌊n / (p1 * p2 * p3 * … * pk)⌋， O(k);<br>一共2 ^ m个集合，O(2 ^ m)<br>===&gt; 总时间复杂度 O(2 ^ m + k)<br>这道题 k = m</p><p>容斥原理 枚举所有项 2 ^ n - 1 （除了所有集合都不选以外）<br>位运算 状态看成n位二进制数， 取1选取0不选<br>共 2 ^ n - 1 个数对应 2 ^ n - 1 种选法<br>检查有多少个1: lowbit把k位右移到最低位再 &amp; 1</p></blockquote><h3 id="样例："><a href="#样例：" class="headerlink" title="样例："></a>样例：</h3><ul><li>输入</li></ul><blockquote><p>100 3<br>2 3 5</p></blockquote><ul><li>输出</li></ul><blockquote><p>i = 1 t = 2<br>i = 2 t = 3<br>i = 3 t = 6<br>i = 4 t = 5<br>i = 5 t = 10<br>i = 6 t = 15<br>i = 7 t = 30<br>74</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数论 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>No Title</title>
      <link href="/2022/01/30/%E6%98%A5%E6%B1%9F%E8%8A%B1%E6%9C%88%E5%A4%9C/"/>
      <url>/2022/01/30/%E6%98%A5%E6%B1%9F%E8%8A%B1%E6%9C%88%E5%A4%9C/</url>
      
        <content type="html"><![CDATA[<blockquote><p>春江花月夜</p><blockquote></blockquote><p>唐 · 张若虚</p><p>春江潮水连海平，海上明月共潮生。</p><p>滟滟随波千万里，何处春江无月明！</p><p>江流宛转绕芳甸，月照花林皆似霰；</p><p>空里流霜不觉飞，汀上白沙看不见。</p><p>江天一色无纤尘，皎皎空中孤月轮。</p><p>江畔何人初见月？江月何年初照人？</p><p>人生代代无穷已，江月年年望相似。</p><p>不知江月待何人，但见长江送流水。</p><p>白云一片去悠悠，青枫浦上不胜愁。</p><p>谁家今夜扁舟子？何处相思明月楼？</p><p>可怜楼上月裴回，应照离人妆镜台。</p><p>玉户帘中卷不去，捣衣砧上拂还来。</p><p>此时相望不相闻，愿逐月华流照君。</p><p>鸿雁长飞光不度，鱼龙潜跃水成文。</p><p>昨夜闲潭梦落花，可怜春半不还家。</p><p>江水流春去欲尽，江潭落月复西斜。</p><p>斜月沉沉藏海雾，碣石潇湘无限路。</p><p>不知乘月几人归，落月摇情满江树。</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> 测试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>はじめまして！</title>
      <link href="/2022/01/30/%E9%AD%9A%E3%81%AE%E3%83%96%E3%83%AD%E3%82%B0/"/>
      <url>/2022/01/30/%E9%AD%9A%E3%81%AE%E3%83%96%E3%83%AD%E3%82%B0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>I’m a test blog.</p><p>Omit me.</p><p>Farwell.</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> 测试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL - 语法0</title>
      <link href="/2022/01/30/MySql/"/>
      <url>/2022/01/30/MySql/</url>
      
        <content type="html"><![CDATA[<h3 id="‘-xxx-’-指定查找-12345xxx54321"><a href="#‘-xxx-’-指定查找-12345xxx54321" class="headerlink" title="‘%xxx%’ 指定查找 12345xxx54321"></a>‘%xxx%’ 指定查找 12345xxx54321</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT *FROM customersWHERE last_name LIKE '%field%'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>结果</p><p><img src="C:\Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220302150010713.png" alt="image-20220302150010713"></p></blockquote><p>这句话用正则表达式可以这么写</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT *FROM customersWHERE last_name REGEXP 'field'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>输出结果是一模一样的</p><h3 id="‘-xxx’-表示开头必须为xxx"><a href="#‘-xxx’-表示开头必须为xxx" class="headerlink" title="‘^xxx’ 表示开头必须为xxx"></a>‘^xxx’ 表示开头必须为xxx</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT *FROM customersWHERE last_name REGEXP '^B'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p><img src="C:\Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220302150244625.png" alt="image-20220302150244625"></p></blockquote><h3 id="‘xxx-’-结尾必须是xxx"><a href="#‘xxx-’-结尾必须是xxx" class="headerlink" title="‘xxx$’ 结尾必须是xxx"></a>‘xxx$’ 结尾必须是xxx</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT *FROM customersWHERE last_name REGEXP 'y$'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p><img src="C:\Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220302150506128.png" alt="image-20220302150506128"></p></blockquote><h3 id="‘-’-or运算符"><a href="#‘-’-or运算符" class="headerlink" title="‘|’ or运算符"></a>‘|’ or运算符</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT *FROM customersWHERE last_name REGEXP 'field|mac'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p><img src="C:\Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220302150736979.png" alt="image-20220302150736979"></p></blockquote><h3 id="‘-abc-x’-表示中间选一个-ax-bx-cx"><a href="#‘-abc-x’-表示中间选一个-ax-bx-cx" class="headerlink" title="‘[abc]x’ []表示中间选一个 ax | bx | cx"></a>‘[abc]x’ []表示中间选一个 ax | bx | cx</h3><h3 id="‘-a-h-x’-是-abcdefgh-x的缩写"><a href="#‘-a-h-x’-是-abcdefgh-x的缩写" class="headerlink" title="‘[a-h]x’ 是[abcdefgh]x的缩写"></a>‘[a-h]x’ 是[abcdefgh]x的缩写</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT *FROM customersWHERE last_name REGEXP '[gim]e'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p><img src="C:\Users\Sakana\AppData\Roaming\Typora\typora-user-images\image-20220302151052462.png" alt="image-20220302151052462"></p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang</title>
      <link href="/2008/03/28/Golang/"/>
      <url>/2008/03/28/Golang/</url>
      
        <content type="html"><![CDATA[<p>第一门入门语言是 C，第二门是 C++。<br>这两门是写过最多的语言吧。<br>Python 有事情的时候用过点，写函数式编程的时候用过点。<br>其他时间也没怎么用过了。<br>Java 写课程设计用过点，生产实习用过点。<br>其他时间也没用过了，也没好好学。<br>Golang 应该可以算是第三们语言吧，继 C/C++ 之后。</p><h3 id="如何使用-go-mod-管理包"><a href="#如何使用-go-mod-管理包" class="headerlink" title="如何使用 go mod 管理包"></a>如何使用 go mod 管理包</h3><p>之前使用 go get 下载源码总是出问题，后来学习了一下 go 管理工具的知识才明白一点。<br>总的来说 go 经历了三代包管理工具的优化，gopath，vendor 和现在的 go mod。<br>这里使用 go mod 管理，提前要把  go env 中的 go1111nmoudle 设置为 on。<br>进入要使用某个框架的目录，执行 <code>go mod init</code>，此时会创建一个名为 <code>go.mod</code> 的文件。<br>现在使用 <code>go get</code> 拉去框架后会把依赖的信息自动添加到这个文件中。</p><p>下面的笔记部分来自于 go-tour 和开源文档《go语言圣经》（ “go pragramming language” 的民间翻译版本，质量颇高）。</p><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><h5 id="命名"><a href="#命名" class="headerlink" title="命名"></a>命名</h5><p>var 声明变量列表，类型在最后<br>经常用于包和函数级别的变量</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token builtin">int</span><span class="token keyword">var</span> d<span class="token punctuation">,</span> e <span class="token builtin">float64</span><span class="token keyword">var</span> x <span class="token builtin">string</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span>d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> x <span class="token operator">=</span> <span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">,</span> <span class="token string">"happy"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果变量的声明没有初始值，必须要显式写出类型</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">var</span> a <span class="token builtin">int</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果变量有了初始值，可以省略类型，进行自动推导</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"happy"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>海象符 <code>:=</code> 可以代替 <code>var</code>，但是只能用于函数体内部</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>x <span class="token operator">:=</span> <span class="token number">1</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token string">"123"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">12.0</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="Go-基本类型"><a href="#Go-基本类型" class="headerlink" title="Go 基本类型"></a>Go 基本类型</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token builtin">bool</span><span class="token builtin">string</span><span class="token builtin">int</span>  <span class="token builtin">int8</span>  <span class="token builtin">int16</span>  <span class="token builtin">int32</span>  <span class="token builtin">int64</span><span class="token builtin">uint</span> <span class="token builtin">uint8</span> <span class="token builtin">uint16</span> <span class="token builtin">uint32</span> <span class="token builtin">uint64</span> <span class="token builtin">uintptr</span><span class="token builtin">byte</span> <span class="token comment">// uint8 的别名</span><span class="token builtin">rune</span> <span class="token comment">// int32 的别名, 表示一个 Unicode 码点</span><span class="token builtin">float32</span> <span class="token builtin">float64</span><span class="token builtin">complex64</span> <span class="token builtin">complex128</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>强制转换规则语法和 C 差不多</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"math"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>x<span class="token punctuation">,</span> y <span class="token operator">:=</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span>z <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x <span class="token operator">+</span> y<span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>res <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>3 5 5.830951894845301 5</p></blockquote><h5 id="类型推导"><a href="#类型推导" class="headerlink" title="类型推导"></a>类型推导</h5><p>下面这个程序可以测试目标变量的类型</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>v <span class="token operator">:=</span> <span class="token number">0.12</span> <span class="token operator">+</span> <span class="token number">7i</span> <span class="token comment">// 修改这里！</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"v is of type %T\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h5><p>常量非常奇怪，不支持 <code>:=</code>，也不用写 <code>var</code></p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">const</span> N <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">12</span><span class="token keyword">const</span> name <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"Bobby"</span><span class="token keyword">const</span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token keyword">const</span> <span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token number">99</span>y <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> name<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h5><p>很惊喜，Go 也有指针。<br>逃不掉的。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token keyword">var</span> p1 <span class="token operator">*</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token operator">&amp;</span>bp3 <span class="token operator">:=</span> <span class="token operator">&amp;</span>cfmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>p1<span class="token punctuation">,</span> <span class="token operator">*</span>p2<span class="token punctuation">,</span> <span class="token operator">*</span>p3<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Vertex <span class="token keyword">struct</span> <span class="token punctuation">{</span>X <span class="token builtin">int</span>Y <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>a <span class="token operator">:=</span> Vertex<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>p <span class="token operator">:=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">.</span>X<span class="token operator">*</span>p <span class="token operator">=</span> <span class="token number">99</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Go 的结构体指针和 C++ 略有不同<br>C++ 需要用 <code>(*p).X</code> 或者 <code>p-&gt;X</code> 来访问，<br>但是 Go 简化了，只用 p.X 就可以访问了。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Vertex <span class="token keyword">struct</span> <span class="token punctuation">{</span>X <span class="token builtin">int</span>Y <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>a <span class="token operator">:=</span> Vertex<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>p <span class="token operator">:=</span> <span class="token operator">&amp;</span>afmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>X<span class="token punctuation">,</span> p<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结构体可以被显式指定哪个字段被赋值</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Vertex <span class="token keyword">struct</span> <span class="token punctuation">{</span>X <span class="token builtin">int</span>Y <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token keyword">var</span> <span class="token punctuation">(</span>v1 <span class="token operator">=</span> Vertex<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>v2 <span class="token operator">=</span> Vertex<span class="token punctuation">{</span>Y<span class="token punctuation">:</span> <span class="token number">99</span><span class="token punctuation">,</span> X<span class="token punctuation">:</span> <span class="token number">88</span><span class="token punctuation">}</span>v3 <span class="token operator">=</span> Vertex<span class="token punctuation">{</span><span class="token punctuation">}</span>p  <span class="token operator">=</span> <span class="token operator">&amp;</span>Vertex<span class="token punctuation">{</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>{1 2} {88 99} {0 0} &amp;{12 12} {12 12}</p></blockquote><h5 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h5><p>有点怪异</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">var</span> a <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">string</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello"</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"world"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>primes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>primes<span class="token punctuation">)</span><span class="token keyword">var</span> b <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>c <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>d <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>切片操作，和 python 很像。<br><code>[]T</code> 代表 T 类型的切片</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>arr <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span>sa <span class="token operator">:=</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token keyword">var</span> sb <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>sa<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>arr <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token keyword">var</span> sb <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"array arr type=%T, slice sb type=%T"</span><span class="token punctuation">,</span> arr<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>array arr type=[10]int, slice sb type=[]int</p></blockquote><p>切片并不存储任何数据，它只是描述了底层数组中的一段。<br>更改切片的元素会修改其底层数组中对应的元素。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>arr <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>s <span class="token operator">:=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">9</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>1<br>9</p></blockquote><p>切片文法类似没有长度的数组文法。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>q <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span>r <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>s <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>i <span class="token builtin">int</span>b <span class="token builtin">bool</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type=%T\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>structSlice <span class="token operator">:=</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type=%T"</span><span class="token punctuation">,</span> structSlice<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[2 3 5 7 11 13]<br>[true false true true false true]<br>type=[]struct { i int; b bool }<br>stype=struct { i int; b bool }</p></blockquote><p>切片可以忽略上下界，和 python 很像</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>s <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">}</span>s <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>s <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>s <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>s <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[2 3 5 7 11 13]<br>[2 3 5 7 11 13]<br>[2 3 5 7 11 13]<br>[2 3 5 7 11 13]</p></blockquote><p>切片的长度与容量</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>s <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">}</span><span class="token function">printSlice</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token comment">// 截取切片使其长度为 0</span>s <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token function">printSlice</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token comment">// 拓展其长度</span>s <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token function">printSlice</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token comment">// 舍弃前一个值</span>s <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token function">printSlice</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">printSlice</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"len=%d cap=%d %v\n"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>len=6 cap=6 [2 3 5 7 11 13]<br>len=0 cap=6 []<br>len=4 cap=6 [2 3 5 7]<br>len=3 cap=5 [3 5 7]</p></blockquote><p>nil 切片<br>切片的零值是 nil。<br>nil 切片的长度和容量为 0 且没有底层数组。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">var</span> s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"nil!"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用 make 创建切片</p><pre class="line-numbers language-none"><code class="language-none">package mainimport "fmt"func main() {a := make([]int, 5)fmt.Println(len(a), cap((a)))a = a[1:3]fmt.Println(len(a), cap((a)))}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>5 5<br>2 4</p></blockquote><p>切片的切片，有点二维数组的感觉</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strings"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 创建一个井字板（经典游戏）</span>board <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token comment">// 两个玩家轮流打上 X 和 O</span>board<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"X"</span>board<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"O"</span>board<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"X"</span>board<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"O"</span>board<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"X"</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>board<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>board<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>X _ X<br>O _ X<br>_ _ O</p></blockquote><p>append  可以追加元素，并且容量也会响应扩张。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">var</span> a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token function">printSlice</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token function">printSlice</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token function">printSlice</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">printSlice</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"len = %d cap = %d\n"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>len = 0 cap = 0<br>len = 1 cap = 1<br>len = 6 cap = 6</p></blockquote><p>range 可以遍历切片或映射。<br>会返回两个值，一个下标，一个元素本身的副本。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>pow <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token keyword">for</span> i<span class="token punctuation">,</span> it <span class="token operator">:=</span> <span class="token keyword">range</span> pow <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"index = %d, value = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> it<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果想要忽略其中一个维度，使用 <code>_</code> 就可以了。<br>如果要使用该元素，会报错。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>pow <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> it <span class="token operator">:=</span> <span class="token keyword">range</span> pow <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> it<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此外，忽略第二个变量可以直接取到索引。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> pow<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h5><p>一个 map 被表示成 <code>map[K]V</code>，这个概念 C++、Java、Python 啥的也都有。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 定义并初始化</span><span class="token keyword">var</span> m1 <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token number">12</span><span class="token punctuation">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">:</span> <span class="token string">"Andy"</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span><span class="token comment">// 定义但不初始化</span><span class="token keyword">var</span> m2 <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span>m2 <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token comment">// 必须要这个，不然会报错，因为给一个 nil map 赋值了</span>m2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Bob"</span>m2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Alice"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span><span class="token comment">// 用海象符定义并创建</span>m3 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>m3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"fuck"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m3<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>增删查改</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>    <span class="token comment">// 插入元素</span>    m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Alice"</span>    m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Bob"</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>    <span class="token comment">// 删除元素</span>    <span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>    <span class="token comment">// 获取</span>    elem <span class="token operator">:=</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span>    <span class="token comment">// 检测是否存在</span>    elem<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"elem = %v, ok = %v"</span><span class="token punctuation">,</span> elem<span class="token punctuation">,</span> ok<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>练习：映射<br>实现 WordCount。它应当返回一个映射，其中包含字符串 s 中每个“单词”的个数。函数 wc.Test 会对此函数执行一系列测试用例，并输出成功还是失败。<br>strings.Fields 会把字符串以空格分割，存在一个 string 数组里面。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strings"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>s <span class="token operator">:=</span> <span class="token string">"The quick brown fox jumped over the lazy lazy dog."</span>stringArr <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Fields</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type = %T\n"</span><span class="token punctuation">,</span> stringArr<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>答案</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"golang.org/x/tour/wc"</span><span class="token string">"strings"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">WordCount</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">{</span>m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>stringArr <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Fields</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> stringArr <span class="token punctuation">{</span>m<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">}</span><span class="token keyword">return</span> m<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>wc<span class="token punctuation">.</span><span class="token function">Test</span><span class="token punctuation">(</span>WordCount<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>把函数当作值一样传递。<br>之前 python 写过类似的 lambda 函数。<br>有函数式编程那味儿了。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>maxn <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><span class="token keyword">if</span> x <span class="token operator">&gt;</span> y <span class="token punctuation">{</span><span class="token keyword">return</span> x<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token keyword">return</span> y<span class="token punctuation">}</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">maxn</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>函数的闭包<br>Go 函数可以是一个闭包。闭包是一个函数值，它引用了其函数体之外的变量。该函数可以访问并赋予其引用的变量的值，换句话说，该函数被这些变量“绑定”在一起。</p><p>例如，函数 adder 返回一个闭包。每个闭包都被绑定在其各自的 sum 变量上。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>sum <span class="token operator">:=</span> <span class="token number">0</span><span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>sum <span class="token operator">+=</span> x<span class="token keyword">return</span> sum<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>pos<span class="token punctuation">,</span> neg <span class="token operator">:=</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">pos</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">neg</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>函数值不仅仅是一串代码，还记录了状态。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token comment">// 返回一个“返回int的函数”</span><span class="token keyword">func</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>x<span class="token punctuation">,</span> y <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>t <span class="token operator">:=</span> x x<span class="token punctuation">,</span> y <span class="token operator">=</span> y<span class="token punctuation">,</span> x <span class="token operator">+</span> y<span class="token keyword">return</span> t<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>f <span class="token operator">:=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>0<br>1<br>1<br>2<br>3<br>5<br>8<br>13<br>21<br>34</p></blockquote><h3 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h3><h5 id="for-循环"><a href="#for-循环" class="headerlink" title="for 循环"></a>for 循环</h5><p>for 循环是 Go 唯一一种循环结构<br>和 C++，Java 非常不同，for 后面没有小括号，但是必须要有大括号</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"prinmes:"</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>初始值和步长都是可选的</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>i <span class="token operator">:=</span> <span class="token number">1</span><span class="token keyword">for</span> <span class="token punctuation">;</span>i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token punctuation">{</span>i<span class="token operator">++</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>11</p></blockquote><p>其实这个时候它就变成了 while 语句，况且 Goland 会自动帮你去掉分号，披着 for 外皮的 while 罢了。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>sum <span class="token operator">:=</span> <span class="token number">1</span><span class="token keyword">for</span> sum <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token punctuation">{</span>sum <span class="token operator">+=</span> sum<span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>1024</p></blockquote><p>但实际上三个都不要也可以，只要你保证他可以正确退出。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>i <span class="token operator">:=</span> <span class="token number">1</span><span class="token keyword">for</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">{</span><span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">{</span><span class="token keyword">break</span><span class="token punctuation">}</span>i<span class="token operator">++</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>10</p></blockquote><h3 id="if-条件语句"><a href="#if-条件语句" class="headerlink" title="if 条件语句"></a>if 条件语句</h3><p>和 for 一样，没有小括号，但是必须有大括号。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">534</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">maxn</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">maxn</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><span class="token keyword">if</span> x <span class="token operator">&gt;</span> y <span class="token punctuation">{</span><span class="token keyword">return</span> x<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token keyword">return</span> y<span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Go 允许在 if 的条件之前执行一句简短的语句。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">534</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">maxn</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">maxn</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><span class="token keyword">if</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">&gt;</span> y <span class="token punctuation">{</span><span class="token keyword">return</span> x<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token keyword">return</span> y<span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>50<br>534</p></blockquote><p>牛顿法计算平方根</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span>    <span class="token string">"math"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">Sqrt</span><span class="token punctuation">(</span>x <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>    z <span class="token operator">:=</span> <span class="token number">1.0</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        z <span class="token operator">-=</span> <span class="token punctuation">(</span>z<span class="token operator">*</span>z <span class="token operator">-</span> x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> z<span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> z<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    stdres <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    myres <span class="token operator">:=</span> <span class="token function">Sqrt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"标准库答案：%v\n"</span><span class="token punctuation">,</span> stdres<span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"我的答案：%v\n"</span><span class="token punctuation">,</span> myres<span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"误差：%v\n"</span><span class="token punctuation">,</span> stdres<span class="token operator">-</span>myres<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h5><p>Go 的 switch 自动在每个 case 后面添加了 break，只要走完一个 case 马上退出。<br>这是和 C++、Java 不同的地方。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">import</span> <span class="token string">"runtime"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">"Go runs on "</span><span class="token punctuation">)</span>os <span class="token operator">:=</span> runtime<span class="token punctuation">.</span>GOOS<span class="token keyword">switch</span> os <span class="token punctuation">{</span><span class="token keyword">case</span> <span class="token string">"darwin"</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"OS X."</span><span class="token punctuation">)</span><span class="token keyword">case</span> <span class="token string">"linux"</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Linux."</span><span class="token punctuation">)</span><span class="token keyword">default</span><span class="token punctuation">:</span><span class="token comment">// freebsd, openbsd,</span><span class="token comment">// plan9, windows...</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s.\n"</span><span class="token punctuation">,</span> os<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>没有条件的 swaitch 等价于 <code>switch true</code></p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">switch</span> <span class="token punctuation">{</span><span class="token keyword">case</span> t<span class="token punctuation">.</span><span class="token function">Hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">12</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Good morning!"</span><span class="token punctuation">)</span><span class="token keyword">case</span> t<span class="token punctuation">.</span><span class="token function">Hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">17</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Good afternoon."</span><span class="token punctuation">)</span><span class="token keyword">default</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Good evening."</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h5><p>推迟执行，该函数返回后才会执行该语句。<br>我目前的水平还不知道这个有什么鸟用。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>hello<br>world</p></blockquote><p>defer 的调用会进入一个栈中，村寻后进先出原则。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"counting"</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">}</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"done"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>counting<br>done<br>9<br>8<br>7<br>6<br>5<br>4<br>3<br>2<br>1<br>0</p></blockquote><h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h5 id="函数的入参与返回值"><a href="#函数的入参与返回值" class="headerlink" title="函数的入参与返回值"></a>函数的入参与返回值</h5><p>传入两个参数，一个返回值的函数写法</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>result <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果有多个入参是相同的类型，可以写在一起</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>c <span class="token operator">:=</span> <span class="token string">"I'm an add function"</span>result <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">,</span> s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>返回值也可以有多个</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">99</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">echo</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">echo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x<span class="token punctuation">,</span> y<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>函数返回值可以被重命名，return 默认返回已被命名的变量</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>resa<span class="token punctuation">,</span> resb <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>resa<span class="token punctuation">,</span> resb <span class="token operator">=</span> x<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">,</span> x<span class="token operator">*</span><span class="token number">100</span><span class="token keyword">return</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果缺一个返回值会默认返回 0</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>resa<span class="token punctuation">,</span> resb <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>resa <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">10</span><span class="token keyword">return</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
